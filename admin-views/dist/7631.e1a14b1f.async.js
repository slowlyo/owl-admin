(self.webpackChunkslow_admin=self.webpackChunkslow_admin||[]).push([[7631],{67631:function(Pt){typeof window!="undefined"&&function(b,T){Pt.exports=T()}(this,function(){return function(G){var b={};function T(C){if(b[C])return b[C].exports;var A=b[C]={i:C,l:!1,exports:{}};return G[C].call(A.exports,A,A.exports,T),A.l=!0,A.exports}return T.m=G,T.c=b,T.d=function(C,A,D){T.o(C,A)||Object.defineProperty(C,A,{enumerable:!0,get:D})},T.r=function(C){typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(C,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(C,"__esModule",{value:!0})},T.t=function(C,A){if(A&1&&(C=T(C)),A&8||A&4&&typeof C=="object"&&C&&C.__esModule)return C;var D=Object.create(null);if(T.r(D),Object.defineProperty(D,"default",{enumerable:!0,value:C}),A&2&&typeof C!="string")for(var M in C)T.d(D,M,function(P){return C[P]}.bind(null,M));return D},T.n=function(C){var A=C&&C.__esModule?function(){return C.default}:function(){return C};return T.d(A,"a",A),A},T.o=function(C,A){return Object.prototype.hasOwnProperty.call(C,A)},T.p="/dist/",T(T.s="./src/hls.ts")}({"./node_modules/eventemitter3/index.js":function(G,b,T){"use strict";var C=Object.prototype.hasOwnProperty,A="~";function D(){}Object.create&&(D.prototype=Object.create(null),new D().__proto__||(A=!1));function M(g,y,S){this.fn=g,this.context=y,this.once=S||!1}function P(g,y,S,p,E){if(typeof S!="function")throw new TypeError("The listener must be a function");var m=new M(S,p||g,E),u=A?A+y:y;return g._events[u]?g._events[u].fn?g._events[u]=[g._events[u],m]:g._events[u].push(m):(g._events[u]=m,g._eventsCount++),g}function R(g,y){--g._eventsCount===0?g._events=new D:delete g._events[y]}function L(){this._events=new D,this._eventsCount=0}L.prototype.eventNames=function(){var y=[],S,p;if(this._eventsCount===0)return y;for(p in S=this._events)C.call(S,p)&&y.push(A?p.slice(1):p);return Object.getOwnPropertySymbols?y.concat(Object.getOwnPropertySymbols(S)):y},L.prototype.listeners=function(y){var S=A?A+y:y,p=this._events[S];if(!p)return[];if(p.fn)return[p.fn];for(var E=0,m=p.length,u=new Array(m);E<m;E++)u[E]=p[E].fn;return u},L.prototype.listenerCount=function(y){var S=A?A+y:y,p=this._events[S];return p?p.fn?1:p.length:0},L.prototype.emit=function(y,S,p,E,m,u){var t=A?A+y:y;if(!this._events[t])return!1;var r=this._events[t],e=arguments.length,f,s;if(r.fn){switch(r.once&&this.removeListener(y,r.fn,void 0,!0),e){case 1:return r.fn.call(r.context),!0;case 2:return r.fn.call(r.context,S),!0;case 3:return r.fn.call(r.context,S,p),!0;case 4:return r.fn.call(r.context,S,p,E),!0;case 5:return r.fn.call(r.context,S,p,E,m),!0;case 6:return r.fn.call(r.context,S,p,E,m,u),!0}for(s=1,f=new Array(e-1);s<e;s++)f[s-1]=arguments[s];r.fn.apply(r.context,f)}else{var l=r.length,h;for(s=0;s<l;s++)switch(r[s].once&&this.removeListener(y,r[s].fn,void 0,!0),e){case 1:r[s].fn.call(r[s].context);break;case 2:r[s].fn.call(r[s].context,S);break;case 3:r[s].fn.call(r[s].context,S,p);break;case 4:r[s].fn.call(r[s].context,S,p,E);break;default:if(!f)for(h=1,f=new Array(e-1);h<e;h++)f[h-1]=arguments[h];r[s].fn.apply(r[s].context,f)}}return!0},L.prototype.on=function(y,S,p){return P(this,y,S,p,!1)},L.prototype.once=function(y,S,p){return P(this,y,S,p,!0)},L.prototype.removeListener=function(y,S,p,E){var m=A?A+y:y;if(!this._events[m])return this;if(!S)return R(this,m),this;var u=this._events[m];if(u.fn)u.fn===S&&(!E||u.once)&&(!p||u.context===p)&&R(this,m);else{for(var t=0,r=[],e=u.length;t<e;t++)(u[t].fn!==S||E&&!u[t].once||p&&u[t].context!==p)&&r.push(u[t]);r.length?this._events[m]=r.length===1?r[0]:r:R(this,m)}return this},L.prototype.removeAllListeners=function(y){var S;return y?(S=A?A+y:y,this._events[S]&&R(this,S)):(this._events=new D,this._eventsCount=0),this},L.prototype.off=L.prototype.removeListener,L.prototype.addListener=L.prototype.on,L.prefixed=A,L.EventEmitter=L,G.exports=L},"./node_modules/url-toolkit/src/url-toolkit.js":function(G,b,T){(function(C){var A=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#[^]*)?$/,D=/^([^\/?#]*)([^]*)$/,M=/(?:\/|^)\.(?=\/)/g,P=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,R={buildAbsoluteURL:function(L,g,y){if(y=y||{},L=L.trim(),g=g.trim(),!g){if(!y.alwaysNormalize)return L;var S=R.parseURL(L);if(!S)throw new Error("Error trying to parse base URL.");return S.path=R.normalizePath(S.path),R.buildURLFromParts(S)}var p=R.parseURL(g);if(!p)throw new Error("Error trying to parse relative URL.");if(p.scheme)return y.alwaysNormalize?(p.path=R.normalizePath(p.path),R.buildURLFromParts(p)):g;var E=R.parseURL(L);if(!E)throw new Error("Error trying to parse base URL.");if(!E.netLoc&&E.path&&E.path[0]!=="/"){var m=D.exec(E.path);E.netLoc=m[1],E.path=m[2]}E.netLoc&&!E.path&&(E.path="/");var u={scheme:E.scheme,netLoc:p.netLoc,path:null,params:p.params,query:p.query,fragment:p.fragment};if(!p.netLoc&&(u.netLoc=E.netLoc,p.path[0]!=="/"))if(!p.path)u.path=E.path,p.params||(u.params=E.params,p.query||(u.query=E.query));else{var t=E.path,r=t.substring(0,t.lastIndexOf("/")+1)+p.path;u.path=R.normalizePath(r)}return u.path===null&&(u.path=y.alwaysNormalize?R.normalizePath(p.path):p.path),R.buildURLFromParts(u)},parseURL:function(L){var g=A.exec(L);return g?{scheme:g[1]||"",netLoc:g[2]||"",path:g[3]||"",params:g[4]||"",query:g[5]||"",fragment:g[6]||""}:null},normalizePath:function(L){for(L=L.split("").reverse().join("").replace(M,"");L.length!==(L=L.replace(P,"")).length;);return L.split("").reverse().join("")},buildURLFromParts:function(L){return L.scheme+L.netLoc+L.path+L.params+L.query+L.fragment}};G.exports=R})(this)},"./node_modules/webworkify-webpack/index.js":function(G,b,T){function C(y){var S={};function p(m){if(S[m])return S[m].exports;var u=S[m]={i:m,l:!1,exports:{}};return y[m].call(u.exports,u,u.exports,p),u.l=!0,u.exports}p.m=y,p.c=S,p.i=function(m){return m},p.d=function(m,u,t){p.o(m,u)||Object.defineProperty(m,u,{configurable:!1,enumerable:!0,get:t})},p.r=function(m){Object.defineProperty(m,"__esModule",{value:!0})},p.n=function(m){var u=m&&m.__esModule?function(){return m.default}:function(){return m};return p.d(u,"a",u),u},p.o=function(m,u){return Object.prototype.hasOwnProperty.call(m,u)},p.p="/",p.oe=function(m){throw console.error(m),m};var E=p(p.s=ENTRY_MODULE);return E.default||E}var A="[\\.|\\-|\\+|\\w|/|@]+",D="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+A+").*?\\)";function M(y){return(y+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function P(y){return!isNaN(1*y)}function R(y,S,p){var E={};E[p]=[];var m=S.toString(),u=m.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!u)return E;for(var t=u[1],r=new RegExp("(\\\\n|\\W)"+M(t)+D,"g"),e;e=r.exec(m);)e[3]!=="dll-reference"&&E[p].push(e[3]);for(r=new RegExp("\\("+M(t)+'\\("(dll-reference\\s('+A+'))"\\)\\)'+D,"g");e=r.exec(m);)y[e[2]]||(E[p].push(e[1]),y[e[2]]=T(e[1]).m),E[e[2]]=E[e[2]]||[],E[e[2]].push(e[4]);for(var f=Object.keys(E),s=0;s<f.length;s++)for(var l=0;l<E[f[s]].length;l++)P(E[f[s]][l])&&(E[f[s]][l]=1*E[f[s]][l]);return E}function L(y){var S=Object.keys(y);return S.reduce(function(p,E){return p||y[E].length>0},!1)}function g(y,S){for(var p={main:[S]},E={main:[]},m={main:{}};L(p);)for(var u=Object.keys(p),t=0;t<u.length;t++){var r=u[t],e=p[r],f=e.pop();if(m[r]=m[r]||{},!(m[r][f]||!y[r][f])){m[r][f]=!0,E[r]=E[r]||[],E[r].push(f);for(var s=R(y,y[r][f],r),l=Object.keys(s),h=0;h<l.length;h++)p[l[h]]=p[l[h]]||[],p[l[h]]=p[l[h]].concat(s[l[h]])}}return E}G.exports=function(y,S){S=S||{};var p={main:T.m},E=S.all?{main:Object.keys(p.main)}:g(p,y),m="";Object.keys(E).filter(function(f){return f!=="main"}).forEach(function(f){for(var s=0;E[f][s];)s++;E[f].push(s),p[f][s]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",m=m+"var "+f+" = ("+C.toString().replace("ENTRY_MODULE",JSON.stringify(s))+")({"+E[f].map(function(l){return""+JSON.stringify(l)+": "+p[f][l].toString()}).join(",")+`});
`}),m=m+"new (("+C.toString().replace("ENTRY_MODULE",JSON.stringify(y))+")({"+E.main.map(function(f){return""+JSON.stringify(f)+": "+p.main[f].toString()}).join(",")+"}))(self);";var u=new window.Blob([m],{type:"text/javascript"});if(S.bare)return u;var t=window.URL||window.webkitURL||window.mozURL||window.msURL,r=t.createObjectURL(u),e=new window.Worker(r);return e.objectURL=r,e}},"./src/config.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"hlsDefaultConfig",function(){return h}),T.d(b,"mergeConfig",function(){return o}),T.d(b,"enableStreamingMode",function(){return a});var C=T("./src/controller/abr-controller.ts"),A=T("./src/controller/audio-stream-controller.ts"),D=T("./src/controller/audio-track-controller.ts"),M=T("./src/controller/subtitle-stream-controller.ts"),P=T("./src/controller/subtitle-track-controller.ts"),R=T("./src/controller/buffer-controller.ts"),L=T("./src/controller/timeline-controller.ts"),g=T("./src/controller/cap-level-controller.ts"),y=T("./src/controller/fps-controller.ts"),S=T("./src/controller/eme-controller.ts"),p=T("./src/controller/cmcd-controller.ts"),E=T("./src/utils/xhr-loader.ts"),m=T("./src/utils/fetch-loader.ts"),u=T("./src/utils/cues.ts"),t=T("./src/utils/mediakeys-helper.ts"),r=T("./src/utils/logger.ts");function e(){return e=Object.assign||function(i){for(var n=1;n<arguments.length;n++){var v=arguments[n];for(var c in v)Object.prototype.hasOwnProperty.call(v,c)&&(i[c]=v[c])}return i},e.apply(this,arguments)}function f(i,n){var v=Object.keys(i);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(i);n&&(c=c.filter(function(x){return Object.getOwnPropertyDescriptor(i,x).enumerable})),v.push.apply(v,c)}return v}function s(i){for(var n=1;n<arguments.length;n++){var v=arguments[n]!=null?arguments[n]:{};n%2?f(Object(v),!0).forEach(function(c){l(i,c,v[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(v)):f(Object(v)).forEach(function(c){Object.defineProperty(i,c,Object.getOwnPropertyDescriptor(v,c))})}return i}function l(i,n,v){return n in i?Object.defineProperty(i,n,{value:v,enumerable:!0,configurable:!0,writable:!0}):i[n]=v,i}var h=s(s({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:E.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:C.default,bufferController:R.default,capLevelController:g.default,fpsController:y.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:t.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0},d()),{},{subtitleStreamController:M.SubtitleStreamController,subtitleTrackController:P.default,timelineController:L.TimelineController,audioStreamController:A.default,audioTrackController:D.default,emeController:S.default,cmcdController:p.default});function d(){return{cueHandler:u.default,enableCEA708Captions:!0,enableWebVTT:!0,enableIMSC1:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function o(i,n){if((n.liveSyncDurationCount||n.liveMaxLatencyDurationCount)&&(n.liveSyncDuration||n.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(n.liveMaxLatencyDurationCount!==void 0&&(n.liveSyncDurationCount===void 0||n.liveMaxLatencyDurationCount<=n.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(n.liveMaxLatencyDuration!==void 0&&(n.liveSyncDuration===void 0||n.liveMaxLatencyDuration<=n.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return e({},i,n)}function a(i){var n=i.loader;if(n!==m.default&&n!==E.default)r.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),i.progressive=!1;else{var v=Object(m.fetchSupported)();v&&(i.loader=m.default,i.progressive=!0,i.enableSoftwareAES=!0,r.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}},"./src/controller/abr-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/polyfills/number.ts"),A=T("./src/utils/ewma-bandwidth-estimator.ts"),D=T("./src/events.ts"),M=T("./src/utils/buffer-helper.ts"),P=T("./src/errors.ts"),R=T("./src/types/loader.ts"),L=T("./src/utils/logger.ts");function g(p,E){for(var m=0;m<E.length;m++){var u=E[m];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(p,u.key,u)}}function y(p,E,m){return E&&g(p.prototype,E),m&&g(p,m),p}var S=function(){function p(m){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=m;var u=m.config;this.bwEstimator=new A.default(u.abrEwmaSlowVoD,u.abrEwmaFastVoD,u.abrEwmaDefaultEstimate),this.registerListeners()}var E=p.prototype;return E.registerListeners=function(){var u=this.hls;u.on(D.Events.FRAG_LOADING,this.onFragLoading,this),u.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),u.on(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),u.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),u.on(D.Events.ERROR,this.onError,this)},E.unregisterListeners=function(){var u=this.hls;u.off(D.Events.FRAG_LOADING,this.onFragLoading,this),u.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),u.off(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),u.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),u.off(D.Events.ERROR,this.onError,this)},E.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},E.onFragLoading=function(u,t){var r=t.frag;if(r.type===R.PlaylistLevelType.MAIN&&!this.timer){var e;this.fragCurrent=r,this.partCurrent=(e=t.part)!=null?e:null,this.timer=self.setInterval(this.onCheck,100)}},E.onLevelLoaded=function(u,t){var r=this.hls.config;t.details.live?this.bwEstimator.update(r.abrEwmaSlowLive,r.abrEwmaFastLive):this.bwEstimator.update(r.abrEwmaSlowVoD,r.abrEwmaFastVoD)},E._abandonRulesCheck=function(){var u=this.fragCurrent,t=this.partCurrent,r=this.hls,e=r.autoLevelEnabled,f=r.config,s=r.media;if(!(!u||!s)){var l=t?t.stats:u.stats,h=t?t.duration:u.duration;if(l.aborted){L.logger.warn("frag loader destroy or aborted, disarm abandonRules"),this.clearTimer(),this._nextAutoLevel=-1;return}if(!(!e||s.paused||!s.playbackRate||!s.readyState)){var d=performance.now()-l.loading.start,o=Math.abs(s.playbackRate);if(!(d<=500*h/o)){var a=r.levels,i=r.minAutoLevel,n=a[u.level],v=l.total||Math.max(l.loaded,Math.round(h*n.maxBitrate/8)),c=Math.max(1,l.bwEstimate?l.bwEstimate/8:l.loaded*1e3/d),x=(v-l.loaded)/c,O=s.currentTime,I=(M.BufferHelper.bufferInfo(s,O,f.maxBufferHole).end-O)/o;if(!(I>=2*h/o||x<=I)){var F=Number.POSITIVE_INFINITY,B;for(B=u.level-1;B>i;B--){var U=a[B].maxBitrate;if(F=h*U/(8*.8*c),F<I)break}if(!(F>=x)){var k=this.bwEstimator.getEstimate();L.logger.warn("Fragment "+u.sn+(t?" part "+t.index:"")+" of level "+u.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+B+`
      Current BW estimate: `+(Object(C.isFiniteNumber)(k)?(k/1024).toFixed(3):"Unknown")+` Kb/s
      Estimated load time for current fragment: `+x.toFixed(3)+` s
      Estimated load time for the next fragment: `+F.toFixed(3)+` s
      Time to underbuffer: `+I.toFixed(3)+" s"),r.nextLoadLevel=B,this.bwEstimator.sample(d,l.loaded),this.clearTimer(),u.loader&&(this.fragCurrent=this.partCurrent=null,u.loader.abort()),r.trigger(D.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:u,part:t,stats:l})}}}}}},E.onFragLoaded=function(u,t){var r=t.frag,e=t.part;if(r.type===R.PlaylistLevelType.MAIN&&Object(C.isFiniteNumber)(r.sn)){var f=e?e.stats:r.stats,s=e?e.duration:r.duration;if(this.clearTimer(),this.lastLoadedFragLevel=r.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var l=this.hls.levels[r.level],h=(l.loaded?l.loaded.bytes:0)+f.loaded,d=(l.loaded?l.loaded.duration:0)+s;l.loaded={bytes:h,duration:d},l.realBitrate=Math.round(8*h/d)}if(r.bitrateTest){var o={stats:f,frag:r,part:e,id:r.type};this.onFragBuffered(D.Events.FRAG_BUFFERED,o),r.bitrateTest=!1}}},E.onFragBuffered=function(u,t){var r=t.frag,e=t.part,f=e?e.stats:r.stats;if(!f.aborted&&!(r.type!==R.PlaylistLevelType.MAIN||r.sn==="initSegment")){var s=f.parsing.end-f.loading.start;this.bwEstimator.sample(s,f.loaded),f.bwEstimate=this.bwEstimator.getEstimate(),r.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}},E.onError=function(u,t){switch(t.details){case P.ErrorDetails.FRAG_LOAD_ERROR:case P.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer();break;default:break}},E.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},E.getNextABRAutoLevel=function(){var u=this.fragCurrent,t=this.partCurrent,r=this.hls,e=r.maxAutoLevel,f=r.config,s=r.minAutoLevel,l=r.media,h=t?t.duration:u?u.duration:0,d=l?l.currentTime:0,o=l&&l.playbackRate!==0?Math.abs(l.playbackRate):1,a=this.bwEstimator?this.bwEstimator.getEstimate():f.abrEwmaDefaultEstimate,i=(M.BufferHelper.bufferInfo(l,d,f.maxBufferHole).end-d)/o,n=this.findBestLevel(a,s,e,i,f.abrBandWidthFactor,f.abrBandWidthUpFactor);if(n>=0)return n;L.logger.trace((i?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var v=h?Math.min(h,f.maxStarvationDelay):f.maxStarvationDelay,c=f.abrBandWidthFactor,x=f.abrBandWidthUpFactor;if(!i){var O=this.bitrateTestDelay;if(O){var I=h?Math.min(h,f.maxLoadingDelay):f.maxLoadingDelay;v=I-O,L.logger.trace("bitrate test took "+Math.round(1e3*O)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*v)+" ms"),c=x=1}}return n=this.findBestLevel(a,s,e,i+v,c,x),Math.max(n,0)},E.findBestLevel=function(u,t,r,e,f,s){for(var l,h=this.fragCurrent,d=this.partCurrent,o=this.lastLoadedFragLevel,a=this.hls.levels,i=a[o],n=!!(i!=null&&(l=i.details)!==null&&l!==void 0&&l.live),v=i==null?void 0:i.codecSet,c=d?d.duration:h?h.duration:0,x=r;x>=t;x--){var O=a[x];if(!(!O||v&&O.codecSet!==v)){var I=O.details,F=(d?I==null?void 0:I.partTarget:I==null?void 0:I.averagetargetduration)||c,B=void 0;x<=o?B=f*u:B=s*u;var U=a[x].maxBitrate,k=U*F/B;if(L.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+x+"/"+Math.round(B)+"/"+U+"/"+F+"/"+e+"/"+k),B>U&&(!k||n&&!this.bitrateTestDelay||k<e))return x}}return-1},y(p,[{key:"nextAutoLevel",get:function(){var u=this._nextAutoLevel,t=this.bwEstimator;if(u!==-1&&(!t||!t.canEstimate()))return u;var r=this.getNextABRAutoLevel();return u!==-1&&(r=Math.min(u,r)),r},set:function(u){this._nextAutoLevel=u}}]),p}();b.default=S},"./src/controller/audio-stream-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/polyfills/number.ts"),A=T("./src/controller/base-stream-controller.ts"),D=T("./src/events.ts"),M=T("./src/utils/buffer-helper.ts"),P=T("./src/controller/fragment-tracker.ts"),R=T("./src/types/level.ts"),L=T("./src/types/loader.ts"),g=T("./src/loader/fragment.ts"),y=T("./src/demux/chunk-cache.ts"),S=T("./src/demux/transmuxer-interface.ts"),p=T("./src/types/transmuxer.ts"),E=T("./src/controller/fragment-finders.ts"),m=T("./src/utils/discontinuities.ts"),u=T("./src/errors.ts"),t=T("./src/utils/logger.ts");function r(){return r=Object.assign||function(h){for(var d=1;d<arguments.length;d++){var o=arguments[d];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(h[a]=o[a])}return h},r.apply(this,arguments)}function e(h,d){h.prototype=Object.create(d.prototype),h.prototype.constructor=h,f(h,d)}function f(h,d){return f=Object.setPrototypeOf||function(a,i){return a.__proto__=i,a},f(h,d)}var s=100,l=function(h){e(d,h);function d(a,i){var n;return n=h.call(this,a,i,"[audio-stream-controller]")||this,n.videoBuffer=null,n.videoTrackCC=-1,n.waitingVideoCC=-1,n.audioSwitch=!1,n.trackId=-1,n.waitingData=null,n.mainDetails=null,n.bufferFlushed=!1,n._registerListeners(),n}var o=d.prototype;return o.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},o._registerListeners=function(){var i=this.hls;i.on(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),i.on(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.on(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),i.on(D.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),i.on(D.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),i.on(D.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),i.on(D.Events.ERROR,this.onError,this),i.on(D.Events.BUFFER_RESET,this.onBufferReset,this),i.on(D.Events.BUFFER_CREATED,this.onBufferCreated,this),i.on(D.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),i.on(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),i.on(D.Events.FRAG_BUFFERED,this.onFragBuffered,this)},o._unregisterListeners=function(){var i=this.hls;i.off(D.Events.MEDIA_ATTACHED,this.onMediaAttached,this),i.off(D.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.off(D.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),i.off(D.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),i.off(D.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),i.off(D.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),i.off(D.Events.ERROR,this.onError,this),i.off(D.Events.BUFFER_RESET,this.onBufferReset,this),i.off(D.Events.BUFFER_CREATED,this.onBufferCreated,this),i.off(D.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),i.off(D.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),i.off(D.Events.FRAG_BUFFERED,this.onFragBuffered,this)},o.onInitPtsFound=function(i,n){var v=n.frag,c=n.id,x=n.initPTS;if(c==="main"){var O=v.cc;this.initPTS[v.cc]=x,this.log("InitPTS for cc: "+O+" found from main: "+x),this.videoTrackCC=O,this.state===A.State.WAITING_INIT_PTS&&this.tick()}},o.startLoad=function(i){if(!this.levels){this.startPosition=i,this.state=A.State.STOPPED;return}var n=this.lastCurrentTime;this.stopLoad(),this.setInterval(s),this.fragLoadError=0,n>0&&i===-1?(this.log("Override startPosition with lastCurrentTime @"+n.toFixed(3)),this.state=A.State.IDLE):(this.loadedmetadata=!1,this.state=A.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=i,this.tick()},o.doTick=function(){switch(this.state){case A.State.IDLE:this.doTickIdle();break;case A.State.WAITING_TRACK:{var i,n=this.levels,v=this.trackId,c=n==null||(i=n[v])===null||i===void 0?void 0:i.details;if(c){if(this.waitForCdnTuneIn(c))break;this.state=A.State.WAITING_INIT_PTS}break}case A.State.FRAG_LOADING_WAITING_RETRY:{var x,O=performance.now(),I=this.retryDate;(!I||O>=I||(x=this.media)!==null&&x!==void 0&&x.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.state=A.State.IDLE);break}case A.State.WAITING_INIT_PTS:{var F=this.waitingData;if(F){var B=F.frag,U=F.part,k=F.cache,N=F.complete;if(this.initPTS[B.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=A.State.FRAG_LOADING;var K=k.flush(),W={frag:B,part:U,payload:K,networkDetails:null};this._handleFragmentLoadProgress(W),N&&h.prototype._handleFragmentLoadComplete.call(this,W)}else if(this.videoTrackCC!==this.waitingVideoCC)t.logger.log("Waiting fragment cc ("+B.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var w=this.getLoadPosition(),H=M.BufferHelper.bufferInfo(this.mediaBuffer,w,this.config.maxBufferHole),V=Object(E.fragmentWithinToleranceTest)(H.end,this.config.maxFragLookUpTolerance,B);V<0&&(t.logger.log("Waiting fragment cc ("+B.cc+") @ "+B.start+" cancelled because another fragment at "+H.end+" is needed"),this.clearWaitingFragment())}}else this.state=A.State.IDLE}}this.onTickEnd()},o.clearWaitingFragment=function(){var i=this.waitingData;i&&(this.fragmentTracker.removeFragment(i.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=A.State.IDLE)},o.onTickEnd=function(){var i=this.media;if(!(!i||!i.readyState)){var n=this.mediaBuffer?this.mediaBuffer:i,v=n.buffered;!this.loadedmetadata&&v.length&&(this.loadedmetadata=!0),this.lastCurrentTime=i.currentTime}},o.doTickIdle=function(){var i,n,v=this.hls,c=this.levels,x=this.media,O=this.trackId,I=v.config;if(!(!c||!c[O])&&!(!x&&(this.startFragRequested||!I.startFragPrefetch))){var F=c[O],B=F.details;if(!B||B.live&&this.levelLastLoaded!==O||this.waitForCdnTuneIn(B)){this.state=A.State.WAITING_TRACK;return}this.bufferFlushed&&(this.bufferFlushed=!1,this.afterBufferFlushed(this.mediaBuffer?this.mediaBuffer:this.media,g.ElementaryStreamTypes.AUDIO,L.PlaylistLevelType.AUDIO));var U=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,L.PlaylistLevelType.AUDIO);if(U!==null){var k=U.len,N=this.getMaxBufferLength(),K=this.audioSwitch;if(!(k>=N&&!K)){if(!K&&this._streamEnded(U,B)){v.trigger(D.Events.BUFFER_EOS,{type:"audio"}),this.state=A.State.ENDED;return}var W=B.fragments,w=W[0].start,H=U.end;if(K){var V=this.getLoadPosition();H=V,B.PTSKnown&&V<w&&(U.end>w||U.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),x.currentTime=w+.05)}var j=this.getNextFragment(H,B);if(!j){this.bufferFlushed=!0;return}((i=j.decryptdata)===null||i===void 0?void 0:i.keyFormat)==="identity"&&!((n=j.decryptdata)!==null&&n!==void 0&&n.key)?this.loadKey(j,B):this.loadFragment(j,B,H)}}}},o.getMaxBufferLength=function(){var i=h.prototype.getMaxBufferLength.call(this),n=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,L.PlaylistLevelType.MAIN);return n===null?i:Math.max(i,n.len)},o.onMediaDetaching=function(){this.videoBuffer=null,h.prototype.onMediaDetaching.call(this)},o.onAudioTracksUpdated=function(i,n){var v=n.audioTracks;this.resetTransmuxer(),this.levels=v.map(function(c){return new R.Level(c)})},o.onAudioTrackSwitching=function(i,n){var v=!!n.url;this.trackId=n.id;var c=this.fragCurrent;c!=null&&c.loader&&c.loader.abort(),this.fragCurrent=null,this.clearWaitingFragment(),v?this.setInterval(s):this.resetTransmuxer(),v?(this.audioSwitch=!0,this.state=A.State.IDLE):this.state=A.State.STOPPED,this.tick()},o.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},o.onLevelLoaded=function(i,n){this.mainDetails=n.details},o.onAudioTrackLoaded=function(i,n){var v,c=this.levels,x=n.details,O=n.id;if(!c){this.warn("Audio tracks were reset while loading level "+O);return}this.log("Track "+O+" loaded ["+x.startSN+","+x.endSN+"],duration:"+x.totalduration);var I=c[O],F=0;if(x.live||(v=I.details)!==null&&v!==void 0&&v.live){var B=this.mainDetails;if(x.fragments[0]||(x.deltaUpdateFailed=!0),x.deltaUpdateFailed||!B)return;!I.details&&x.hasProgramDateTime&&B.hasProgramDateTime?(Object(m.alignMediaPlaylistByPDT)(x,B),F=x.fragments[0].start):F=this.alignPlaylists(x,I.details)}I.details=x,this.levelLastLoaded=O,!this.startFragRequested&&(this.mainDetails||!x.live)&&this.setStartPosition(I.details,F),this.state===A.State.WAITING_TRACK&&!this.waitForCdnTuneIn(x)&&(this.state=A.State.IDLE),this.tick()},o._handleFragmentLoadProgress=function(i){var n,v=i.frag,c=i.part,x=i.payload,O=this.config,I=this.trackId,F=this.levels;if(!F){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+v.sn+" of level "+v.level+" will not be buffered");return}var B=F[I];console.assert(B,"Audio track is defined on fragment load progress");var U=B.details;console.assert(U,"Audio track details are defined on fragment load progress");var k=O.defaultAudioCodec||B.audioCodec||"mp4a.40.2",N=this.transmuxer;N||(N=this.transmuxer=new S.default(this.hls,L.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var K=this.initPTS[v.cc],W=(n=v.initSegment)===null||n===void 0?void 0:n.data;if(K!==void 0){var w=!1,H=c?c.index:-1,V=H!==-1,j=new p.ChunkMetadata(v.level,v.sn,v.stats.chunkCount,x.byteLength,H,V);N.push(x,W,k,"",v,c,U.totalduration,w,j,K)}else{t.logger.log("Unknown video PTS for cc "+v.cc+", waiting for video PTS before demuxing audio frag "+v.sn+" of ["+U.startSN+" ,"+U.endSN+"],track "+I);var X=this.waitingData=this.waitingData||{frag:v,part:c,cache:new y.default,complete:!1},Y=X.cache;Y.push(new Uint8Array(x)),this.waitingVideoCC=this.videoTrackCC,this.state=A.State.WAITING_INIT_PTS}},o._handleFragmentLoadComplete=function(i){if(this.waitingData){this.waitingData.complete=!0;return}h.prototype._handleFragmentLoadComplete.call(this,i)},o.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},o.onBufferCreated=function(i,n){var v=n.tracks.audio;v&&(this.mediaBuffer=v.buffer),n.tracks.video&&(this.videoBuffer=n.tracks.video.buffer)},o.onFragBuffered=function(i,n){var v=n.frag,c=n.part;if(v.type===L.PlaylistLevelType.AUDIO){if(this.fragContextChanged(v)){this.warn("Fragment "+v.sn+(c?" p: "+c.index:"")+" of level "+v.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch);return}v.sn!=="initSegment"&&(this.fragPrevious=v,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(D.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(v,c)}},o.onError=function(i,n){switch(n.details){case u.ErrorDetails.FRAG_LOAD_ERROR:case u.ErrorDetails.FRAG_LOAD_TIMEOUT:case u.ErrorDetails.KEY_LOAD_ERROR:case u.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(L.PlaylistLevelType.AUDIO,n);break;case u.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case u.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==A.State.ERROR&&this.state!==A.State.STOPPED&&(this.state=n.fatal?A.State.ERROR:A.State.IDLE,this.warn(n.details+" while loading frag, switching to "+this.state+" state"));break;case u.ErrorDetails.BUFFER_FULL_ERROR:if(n.parent==="audio"&&(this.state===A.State.PARSING||this.state===A.State.PARSED)){var v=!0,c=this.getFwdBufferInfo(this.mediaBuffer,L.PlaylistLevelType.AUDIO);c&&c.len>.5&&(v=!this.reduceMaxBufferLength(c.len)),v&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,h.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}break;default:break}},o.onBufferFlushed=function(i,n){var v=n.type;v===g.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0)},o._handleTransmuxComplete=function(i){var n,v="audio",c=this.hls,x=i.remuxResult,O=i.chunkMeta,I=this.getCurrentContext(O);if(!I){this.warn("The loading context changed while buffering fragment "+O.sn+" of level "+O.level+". This chunk will not be buffered."),this.resetLiveStartWhenNotLoaded(O.level);return}var F=I.frag,B=I.part,U=x.audio,k=x.text,N=x.id3,K=x.initSegment;if(!this.fragContextChanged(F)){if(this.state=A.State.PARSING,this.audioSwitch&&U&&this.completeAudioSwitch(),K!=null&&K.tracks&&(this._bufferInitSegment(K.tracks,F,O),c.trigger(D.Events.FRAG_PARSING_INIT_SEGMENT,{frag:F,id:v,tracks:K.tracks})),U){var W=U.startPTS,w=U.endPTS,H=U.startDTS,V=U.endDTS;B&&(B.elementaryStreams[g.ElementaryStreamTypes.AUDIO]={startPTS:W,endPTS:w,startDTS:H,endDTS:V}),F.setElementaryStreamInfo(g.ElementaryStreamTypes.AUDIO,W,w,H,V),this.bufferFragmentData(U,F,B,O)}if(N!=null&&(n=N.samples)!==null&&n!==void 0&&n.length){var j=r({frag:F,id:v},N);c.trigger(D.Events.FRAG_PARSING_METADATA,j)}if(k){var X=r({frag:F,id:v},k);c.trigger(D.Events.FRAG_PARSING_USERDATA,X)}}},o._bufferInitSegment=function(i,n,v){if(this.state===A.State.PARSING){i.video&&delete i.video;var c=i.audio;if(!!c){c.levelCodec=c.codec,c.id="audio",this.log("Init audio buffer, container:"+c.container+", codecs[parsed]=["+c.codec+"]"),this.hls.trigger(D.Events.BUFFER_CODECS,i);var x=c.initSegment;if(x!=null&&x.byteLength){var O={type:"audio",frag:n,part:null,chunkMeta:v,parent:n.type,data:x};this.hls.trigger(D.Events.BUFFER_APPENDING,O)}this.tick()}}},o.loadFragment=function(i,n,v){var c=this.fragmentTracker.getState(i);this.fragCurrent=i,(this.audioSwitch||c===P.FragmentState.NOT_LOADED||c===P.FragmentState.PARTIAL)&&(i.sn==="initSegment"?this._loadInitSegment(i):n.live&&!Object(C.isFiniteNumber)(this.initPTS[i.cc])?(this.log("Waiting for video PTS in continuity counter "+i.cc+" of live stream before loading audio fragment "+i.sn+" of level "+this.trackId),this.state=A.State.WAITING_INIT_PTS):(this.startFragRequested=!0,h.prototype.loadFragment.call(this,i,n,v)))},o.completeAudioSwitch=function(){var i=this.hls,n=this.media,v=this.trackId;n&&(this.log("Switching audio track : flushing all audio"),h.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,i.trigger(D.Events.AUDIO_TRACK_SWITCHED,{id:v})},d}(A.default);b.default=l},"./src/controller/audio-track-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/events.ts"),A=T("./src/errors.ts"),D=T("./src/controller/base-playlist-controller.ts"),M=T("./src/types/loader.ts");function P(S,p){for(var E=0;E<p.length;E++){var m=p[E];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(S,m.key,m)}}function R(S,p,E){return p&&P(S.prototype,p),E&&P(S,E),S}function L(S,p){S.prototype=Object.create(p.prototype),S.prototype.constructor=S,g(S,p)}function g(S,p){return g=Object.setPrototypeOf||function(m,u){return m.__proto__=u,m},g(S,p)}var y=function(S){L(p,S);function p(m){var u;return u=S.call(this,m,"[audio-track-controller]")||this,u.tracks=[],u.groupId=null,u.tracksInGroup=[],u.trackId=-1,u.trackName="",u.selectDefaultTrack=!0,u.registerListeners(),u}var E=p.prototype;return E.registerListeners=function(){var u=this.hls;u.on(C.Events.MANIFEST_LOADING,this.onManifestLoading,this),u.on(C.Events.MANIFEST_PARSED,this.onManifestParsed,this),u.on(C.Events.LEVEL_LOADING,this.onLevelLoading,this),u.on(C.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),u.on(C.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),u.on(C.Events.ERROR,this.onError,this)},E.unregisterListeners=function(){var u=this.hls;u.off(C.Events.MANIFEST_LOADING,this.onManifestLoading,this),u.off(C.Events.MANIFEST_PARSED,this.onManifestParsed,this),u.off(C.Events.LEVEL_LOADING,this.onLevelLoading,this),u.off(C.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),u.off(C.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),u.off(C.Events.ERROR,this.onError,this)},E.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,S.prototype.destroy.call(this)},E.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},E.onManifestParsed=function(u,t){this.tracks=t.audioTracks||[]},E.onAudioTrackLoaded=function(u,t){var r=t.id,e=t.details,f=this.tracksInGroup[r];if(!f){this.warn("Invalid audio track id "+r);return}var s=f.details;f.details=t.details,this.log("audioTrack "+r+" loaded ["+e.startSN+"-"+e.endSN+"]"),r===this.trackId&&(this.retryCount=0,this.playlistLoaded(r,t,s))},E.onLevelLoading=function(u,t){this.switchLevel(t.level)},E.onLevelSwitching=function(u,t){this.switchLevel(t.level)},E.switchLevel=function(u){var t=this.hls.levels[u];if(!!(t!=null&&t.audioGroupIds)){var r=t.audioGroupIds[t.urlId];if(this.groupId!==r){this.groupId=r;var e=this.tracks.filter(function(s){return!r||s.groupId===r});this.selectDefaultTrack&&!e.some(function(s){return s.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=e;var f={audioTracks:e};this.log("Updating audio tracks, "+e.length+' track(s) found in "'+r+'" group-id'),this.hls.trigger(C.Events.AUDIO_TRACKS_UPDATED,f),this.selectInitialTrack()}}},E.onError=function(u,t){S.prototype.onError.call(this,u,t),!(t.fatal||!t.context)&&t.context.type===M.PlaylistContextType.AUDIO_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&this.retryLoadingOrFail(t)},E.setAudioTrack=function(u){var t=this.tracksInGroup;if(u<0||u>=t.length){this.warn("Invalid id passed to audio-track controller");return}this.clearTimer();var r=t[this.trackId];this.log("Now switching to audio-track index "+u);var e=t[u],f=e.id,s=e.groupId,l=s===void 0?"":s,h=e.name,d=e.type,o=e.url;if(this.trackId=u,this.trackName=h,this.selectDefaultTrack=!1,this.hls.trigger(C.Events.AUDIO_TRACK_SWITCHING,{id:f,groupId:l,name:h,type:d,url:o}),!(e.details&&!e.details.live)){var a=this.switchParams(e.url,r==null?void 0:r.details);this.loadPlaylist(a)}},E.selectInitialTrack=function(){var u=this.tracksInGroup;console.assert(u.length,"Initial audio track should be selected when tracks are known");var t=this.trackName,r=this.findTrackId(t)||this.findTrackId();r!==-1?this.setAudioTrack(r):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},E.findTrackId=function(u){for(var t=this.tracksInGroup,r=0;r<t.length;r++){var e=t[r];if((!this.selectDefaultTrack||e.default)&&(!u||u===e.name))return e.id}return-1},E.loadPlaylist=function(u){var t=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(t)){var r=t.id,e=t.groupId,f=t.url;if(u)try{f=u.addDirectives(f)}catch(s){this.warn("Could not construct new URL with HLS Delivery Directives: "+s)}this.log("loading audio-track playlist for id: "+r),this.clearTimer(),this.hls.trigger(C.Events.AUDIO_TRACK_LOADING,{url:f,id:r,groupId:e,deliveryDirectives:u||null})}},R(p,[{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(u){this.selectDefaultTrack=!1,this.setAudioTrack(u)}}]),p}(D.default);b.default=y},"./src/controller/base-playlist-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return R});var C=T("./src/polyfills/number.ts"),A=T("./src/types/level.ts"),D=T("./src/controller/level-helper.ts"),M=T("./src/utils/logger.ts"),P=T("./src/errors.ts"),R=function(){function L(y,S){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=M.logger.log.bind(M.logger,S+":"),this.warn=M.logger.warn.bind(M.logger,S+":"),this.hls=y}var g=L.prototype;return g.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},g.onError=function(S,p){p.fatal&&p.type===P.ErrorTypes.NETWORK_ERROR&&this.clearTimer()},g.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},g.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()},g.stopLoad=function(){this.canLoad=!1,this.clearTimer()},g.switchParams=function(S,p){var E=p==null?void 0:p.renditionReports;if(E)for(var m=0;m<E.length;m++){var u=E[m],t=""+u.URI;if(t===S.substr(-t.length)){var r=parseInt(u["LAST-MSN"]),e=parseInt(u["LAST-PART"]);if(p&&this.hls.config.lowLatencyMode){var f=Math.min(p.age-p.partTarget,p.targetduration);e!==void 0&&f>p.partTarget&&(e+=1)}if(Object(C.isFiniteNumber)(r))return new A.HlsUrlParameters(r,Object(C.isFiniteNumber)(e)?e:void 0,A.HlsSkip.No)}}},g.loadPlaylist=function(S){},g.shouldLoadTrack=function(S){return this.canLoad&&S&&!!S.url&&(!S.details||S.details.live)},g.playlistLoaded=function(S,p,E){var m=this,u=p.details,t=p.stats,r=t.loading.end?Math.max(0,self.performance.now()-t.loading.end):0;if(u.advancedDateTime=Date.now()-r,u.live||E!=null&&E.live){if(u.reloaded(E),E&&this.log("live playlist "+S+" "+(u.advanced?"REFRESHED "+u.lastPartSn+"-"+u.lastPartIndex:"MISSED")),E&&u.fragments.length>0&&Object(D.mergeDetails)(E,u),!this.canLoad||!u.live)return;var e,f=void 0,s=void 0;if(u.canBlockReload&&u.endSN&&u.advanced){var l=this.hls.config.lowLatencyMode,h=u.lastPartSn,d=u.endSN,o=u.lastPartIndex,a=o!==-1,i=h===d,n=l?0:o;a?(f=i?d+1:h,s=i?n:o+1):f=d+1;var v=u.age,c=v+u.ageHeader,x=Math.min(c-u.partTarget,u.targetduration*1.5);if(x>0){if(E&&x>E.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+E.tuneInGoal+" to: "+x+" with playlist age: "+u.age),x=0;else{var O=Math.floor(x/u.targetduration);if(f+=O,s!==void 0){var I=Math.round(x%u.targetduration/u.partTarget);s+=I}this.log("CDN Tune-in age: "+u.ageHeader+"s last advanced "+v.toFixed(2)+"s goal: "+x+" skip sn "+O+" to part "+s)}u.tuneInGoal=x}if(e=this.getDeliveryDirectives(u,p.deliveryDirectives,f,s),l||!i){this.loadPlaylist(e);return}}else e=this.getDeliveryDirectives(u,p.deliveryDirectives,f,s);var F=Object(D.computeReloadInterval)(u,t);f!==void 0&&u.canBlockReload&&(F-=u.partTarget||1),this.log("reload live playlist "+S+" in "+Math.round(F)+" ms"),this.timer=self.setTimeout(function(){return m.loadPlaylist(e)},F)}else this.clearTimer()},g.getDeliveryDirectives=function(S,p,E,m){var u=Object(A.getSkipValue)(S,E);return p!=null&&p.skip&&S.deltaUpdateFailed&&(E=p.msn,m=p.part,u=A.HlsSkip.No),new A.HlsUrlParameters(E,m,u)},g.retryLoadingOrFail=function(S){var p=this,E=this.hls.config,m=this.retryCount<E.levelLoadingMaxRetry;if(m){var u;if(this.retryCount++,S.details.indexOf("LoadTimeOut")>-1&&(u=S.context)!==null&&u!==void 0&&u.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+S.details+'"'),this.loadPlaylist();else{var t=Math.min(Math.pow(2,this.retryCount)*E.levelLoadingRetryDelay,E.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return p.loadPlaylist()},t),this.warn("retry playlist loading #"+this.retryCount+" in "+t+' ms after "'+S.details+'"')}}else this.warn('cannot recover from error "'+S.details+'"'),this.clearTimer(),S.fatal=!0;return m},L}()},"./src/controller/base-stream-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"State",function(){return d}),T.d(b,"default",function(){return o});var C=T("./src/polyfills/number.ts"),A=T("./src/task-loop.ts"),D=T("./src/controller/fragment-tracker.ts"),M=T("./src/utils/buffer-helper.ts"),P=T("./src/utils/logger.ts"),R=T("./src/events.ts"),L=T("./src/errors.ts"),g=T("./src/types/transmuxer.ts"),y=T("./src/utils/mp4-tools.ts"),S=T("./src/utils/discontinuities.ts"),p=T("./src/controller/fragment-finders.ts"),E=T("./src/controller/level-helper.ts"),m=T("./src/loader/fragment-loader.ts"),u=T("./src/crypt/decrypter.ts"),t=T("./src/utils/time-ranges.ts"),r=T("./src/types/loader.ts");function e(a,i){for(var n=0;n<i.length;n++){var v=i[n];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(a,v.key,v)}}function f(a,i,n){return i&&e(a.prototype,i),n&&e(a,n),a}function s(a){if(a===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function l(a,i){a.prototype=Object.create(i.prototype),a.prototype.constructor=a,h(a,i)}function h(a,i){return h=Object.setPrototypeOf||function(v,c){return v.__proto__=c,v},h(a,i)}var d={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",BACKTRACKING:"BACKTRACKING",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},o=function(a){l(i,a);function i(v,c,x){var O;return O=a.call(this)||this,O.hls=void 0,O.fragPrevious=null,O.fragCurrent=null,O.fragmentTracker=void 0,O.transmuxer=null,O._state=d.STOPPED,O.media=void 0,O.mediaBuffer=void 0,O.config=void 0,O.bitrateTest=!1,O.lastCurrentTime=0,O.nextLoadPosition=0,O.startPosition=0,O.loadedmetadata=!1,O.fragLoadError=0,O.retryDate=0,O.levels=null,O.fragmentLoader=void 0,O.levelLastLoaded=null,O.startFragRequested=!1,O.decrypter=void 0,O.initPTS=[],O.onvseeking=null,O.onvended=null,O.logPrefix="",O.log=void 0,O.warn=void 0,O.logPrefix=x,O.log=P.logger.log.bind(P.logger,x+":"),O.warn=P.logger.warn.bind(P.logger,x+":"),O.hls=v,O.fragmentLoader=new m.default(v.config),O.fragmentTracker=c,O.config=v.config,O.decrypter=new u.default(v,v.config),v.on(R.Events.KEY_LOADED,O.onKeyLoaded,s(O)),O}var n=i.prototype;return n.doTick=function(){this.onTickEnd()},n.onTickEnd=function(){},n.startLoad=function(c){},n.stopLoad=function(){this.fragmentLoader.abort();var c=this.fragCurrent;c&&this.fragmentTracker.removeFragment(c),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=d.STOPPED},n._streamEnded=function(c,x){var O=this.fragCurrent,I=this.fragmentTracker;if(!x.live&&O&&O.sn===x.endSN&&!c.nextStart){var F=I.getState(O);return F===D.FragmentState.PARTIAL||F===D.FragmentState.OK}return!1},n.onMediaAttached=function(c,x){var O=this.media=this.mediaBuffer=x.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),O.addEventListener("seeking",this.onvseeking),O.addEventListener("ended",this.onvended);var I=this.config;this.levels&&I.autoStartLoad&&this.state===d.STOPPED&&this.startLoad(I.startPosition)},n.onMediaDetaching=function(){var c=this.media;c!=null&&c.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),c&&(c.removeEventListener("seeking",this.onvseeking),c.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},n.onMediaSeeking=function(){var c=this.config,x=this.fragCurrent,O=this.media,I=this.mediaBuffer,F=this.state,B=O?O.currentTime:0,U=M.BufferHelper.bufferInfo(I||O,B,c.maxBufferHole);if(this.log("media seeking to "+(Object(C.isFiniteNumber)(B)?B.toFixed(3):B)+", state: "+F),F===d.ENDED)this.resetLoadingState();else if(x&&!U.len){var k=c.maxFragLookUpTolerance,N=x.start-k,K=x.start+x.duration+k,W=B>K;(B<N||W)&&(W&&x.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),x.loader.abort()),this.resetLoadingState())}O&&(this.lastCurrentTime=B),!this.loadedmetadata&&!U.len&&(this.nextLoadPosition=this.startPosition=B),this.tickImmediate()},n.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},n.onKeyLoaded=function(c,x){if(!(this.state!==d.KEY_LOADING||x.frag!==this.fragCurrent||!this.levels)){this.state=d.IDLE;var O=this.levels[x.frag.level].details;O&&this.loadFragment(x.frag,O,x.frag.start)}},n.onHandlerDestroying=function(){this.stopLoad(),a.prototype.onHandlerDestroying.call(this)},n.onHandlerDestroyed=function(){this.state=d.STOPPED,this.hls.off(R.Events.KEY_LOADED,this.onKeyLoaded,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,a.prototype.onHandlerDestroyed.call(this)},n.loadKey=function(c,x){this.log("Loading key for "+c.sn+" of ["+x.startSN+"-"+x.endSN+"], "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+c.level),this.state=d.KEY_LOADING,this.fragCurrent=c,this.hls.trigger(R.Events.KEY_LOADING,{frag:c})},n.loadFragment=function(c,x,O){this._loadFragForPlayback(c,x,O)},n._loadFragForPlayback=function(c,x,O){var I=this,F=function(U){if(I.fragContextChanged(c)){I.warn("Fragment "+c.sn+(U.part?" p: "+U.part.index:"")+" of level "+c.level+" was dropped during download."),I.fragmentTracker.removeFragment(c);return}c.stats.chunkCount++,I._handleFragmentLoadProgress(U)};this._doFragLoad(c,x,O,F).then(function(B){if(!!B){I.fragLoadError=0;var U=I.state;if(I.fragContextChanged(c)){(U===d.FRAG_LOADING||U===d.BACKTRACKING||!I.fragCurrent&&U===d.PARSING)&&(I.fragmentTracker.removeFragment(c),I.state=d.IDLE);return}if("payload"in B&&(I.log("Loaded fragment "+c.sn+" of level "+c.level),I.hls.trigger(R.Events.FRAG_LOADED,B),I.state===d.BACKTRACKING)){I.fragmentTracker.backtrack(c,B),I.resetFragmentLoading(c);return}I._handleFragmentLoadComplete(B)}}).catch(function(B){I.warn(B),I.resetFragmentLoading(c)})},n.flushMainBuffer=function(c,x,O){if(O===void 0&&(O=null),!!(c-x)){var I={startOffset:c,endOffset:x,type:O};this.fragLoadError=0,this.hls.trigger(R.Events.BUFFER_FLUSHING,I)}},n._loadInitSegment=function(c){var x=this;this._doFragLoad(c).then(function(O){if(!O||x.fragContextChanged(c)||!x.levels)throw new Error("init load aborted");return O}).then(function(O){var I=x.hls,F=O.payload,B=c.decryptdata;if(F&&F.byteLength>0&&B&&B.key&&B.iv&&B.method==="AES-128"){var U=self.performance.now();return x.decrypter.webCryptoDecrypt(new Uint8Array(F),B.key.buffer,B.iv.buffer).then(function(k){var N=self.performance.now();return I.trigger(R.Events.FRAG_DECRYPTED,{frag:c,payload:k,stats:{tstart:U,tdecrypt:N}}),O.payload=k,O})}return O}).then(function(O){var I=x.fragCurrent,F=x.hls,B=x.levels;if(!B)throw new Error("init load aborted, missing levels");var U=B[c.level].details;console.assert(U,"Level details are defined when init segment is loaded");var k=c.stats;x.state=d.IDLE,x.fragLoadError=0,c.data=new Uint8Array(O.payload),k.parsing.start=k.buffering.start=self.performance.now(),k.parsing.end=k.buffering.end=self.performance.now(),O.frag===I&&F.trigger(R.Events.FRAG_BUFFERED,{stats:k,frag:I,part:null,id:c.type}),x.tick()}).catch(function(O){x.warn(O),x.resetFragmentLoading(c)})},n.fragContextChanged=function(c){var x=this.fragCurrent;return!c||!x||c.level!==x.level||c.sn!==x.sn||c.urlId!==x.urlId},n.fragBufferedComplete=function(c,x){var O=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+c.type+" sn: "+c.sn+(x?" part: "+x.index:"")+" of "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+c.level+" "+t.default.toString(M.BufferHelper.getBuffered(O))),this.state=d.IDLE,this.tick()},n._handleFragmentLoadComplete=function(c){var x=this.transmuxer;if(!!x){var O=c.frag,I=c.part,F=c.partsLoaded,B=!F||F.length===0||F.some(function(k){return!k}),U=new g.ChunkMetadata(O.level,O.sn,O.stats.chunkCount+1,0,I?I.index:-1,!B);x.flush(U)}},n._handleFragmentLoadProgress=function(c){},n._doFragLoad=function(c,x,O,I){var F=this;if(O===void 0&&(O=null),!this.levels)throw new Error("frag load aborted, missing levels");if(O=Math.max(c.start,O||0),this.config.lowLatencyMode&&x){var B=x.partList;if(B&&I){O>c.end&&x.fragmentHint&&(c=x.fragmentHint);var U=this.getNextPart(B,c,O);if(U>-1){var k=B[U];return this.log("Loading part sn: "+c.sn+" p: "+k.index+" cc: "+c.cc+" of playlist ["+x.startSN+"-"+x.endSN+"] parts [0-"+U+"-"+(B.length-1)+"] "+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+c.level+", target: "+parseFloat(O.toFixed(3))),this.nextLoadPosition=k.start+k.duration,this.state=d.FRAG_LOADING,this.hls.trigger(R.Events.FRAG_LOADING,{frag:c,part:B[U],targetBufferTime:O}),this.doFragPartsLoad(c,B,U,I).catch(function(N){return F.handleFragLoadError(N)})}else if(!c.url||this.loadedEndOfParts(B,O))return Promise.resolve(null)}}return this.log("Loading fragment "+c.sn+" cc: "+c.cc+" "+(x?"of ["+x.startSN+"-"+x.endSN+"] ":"")+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+c.level+", target: "+parseFloat(O.toFixed(3))),Object(C.isFiniteNumber)(c.sn)&&!this.bitrateTest&&(this.nextLoadPosition=c.start+c.duration),this.state=d.FRAG_LOADING,this.hls.trigger(R.Events.FRAG_LOADING,{frag:c,targetBufferTime:O}),this.fragmentLoader.load(c,I).catch(function(N){return F.handleFragLoadError(N)})},n.doFragPartsLoad=function(c,x,O,I){var F=this;return new Promise(function(B,U){var k=[],N=function K(W){var w=x[W];F.fragmentLoader.loadPart(c,w,I).then(function(H){k[w.index]=H;var V=H.part;F.hls.trigger(R.Events.FRAG_LOADED,H);var j=x[W+1];if(j&&j.fragment===c)K(W+1);else return B({frag:c,part:V,partsLoaded:k})}).catch(U)};N(O)})},n.handleFragLoadError=function(c){var x=c.data;return x&&x.details===L.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(x.frag,x.part):this.hls.trigger(R.Events.ERROR,x),null},n._handleTransmuxerFlush=function(c){var x=this.getCurrentContext(c);if(!x||this.state!==d.PARSING){this.fragCurrent||(this.state=d.IDLE);return}var O=x.frag,I=x.part,F=x.level,B=self.performance.now();O.stats.parsing.end=B,I&&(I.stats.parsing.end=B),this.updateLevelTiming(O,I,F,c.partial)},n.getCurrentContext=function(c){var x=this.levels,O=c.level,I=c.sn,F=c.part;if(!x||!x[O])return this.warn("Levels object was unset while buffering fragment "+I+" of level "+O+". The current chunk will not be buffered."),null;var B=x[O],U=F>-1?Object(E.getPartWith)(B,I,F):null,k=U?U.fragment:Object(E.getFragmentWithSN)(B,I,this.fragCurrent);return k?{frag:k,part:U,level:B}:null},n.bufferFragmentData=function(c,x,O,I){if(!(!c||this.state!==d.PARSING)){var F=c.data1,B=c.data2,U=F;if(F&&B&&(U=Object(y.appendUint8Array)(F,B)),!(!U||!U.length)){var k={type:c.type,frag:x,part:O,chunkMeta:I,parent:x.type,data:U};this.hls.trigger(R.Events.BUFFER_APPENDING,k),c.dropped&&c.independent&&!O&&this.flushBufferGap(x)}}},n.flushBufferGap=function(c){var x=this.media;if(!!x){if(!M.BufferHelper.isBuffered(x,x.currentTime)){this.flushMainBuffer(0,c.start);return}var O=x.currentTime,I=M.BufferHelper.bufferInfo(x,O,0),F=c.duration,B=Math.min(this.config.maxFragLookUpTolerance*2,F*.25),U=Math.max(Math.min(c.start-B,I.end-B),O+B);c.start-U>B&&this.flushMainBuffer(U,c.start)}},n.getFwdBufferInfo=function(c,x){var O=this.config,I=this.getLoadPosition();if(!Object(C.isFiniteNumber)(I))return null;var F=M.BufferHelper.bufferInfo(c,I,O.maxBufferHole);if(F.len===0&&F.nextStart!==void 0){var B=this.fragmentTracker.getBufferedFrag(I,x);if(B&&F.nextStart<B.end)return M.BufferHelper.bufferInfo(c,I,Math.max(F.nextStart,O.maxBufferHole))}return F},n.getMaxBufferLength=function(c){var x=this.config,O;return c?O=Math.max(8*x.maxBufferSize/c,x.maxBufferLength):O=x.maxBufferLength,Math.min(O,x.maxMaxBufferLength)},n.reduceMaxBufferLength=function(c){var x=this.config,O=c||x.maxBufferLength;return x.maxMaxBufferLength>=O?(x.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+x.maxMaxBufferLength+"s"),!0):!1},n.getNextFragment=function(c,x){var O,I,F=x.fragments,B=F.length;if(!B)return null;var U=this.config,k=F[0].start,N;if(x.live){var K=U.initialLiveManifestSize;if(B<K)return this.warn("Not enough fragments to start playback (have: "+B+", need: "+K+")"),null;!x.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(N=this.getInitialLiveFragment(x,F),this.startPosition=N?this.hls.liveSyncPosition||N.start:c)}else c<=k&&(N=F[0]);if(!N){var W=U.lowLatencyMode?x.partEnd:x.fragmentEnd;N=this.getFragmentAtPosition(c,W,x)}return(O=N)!==null&&O!==void 0&&O.initSegment&&!((I=N)!==null&&I!==void 0&&I.initSegment.data)&&!this.bitrateTest&&(N=N.initSegment),N},n.getNextPart=function(c,x,O){for(var I=-1,F=!1,B=!0,U=0,k=c.length;U<k;U++){var N=c[U];if(B=B&&!N.independent,I>-1&&O<N.start)break;var K=N.loaded;!K&&(F||N.independent||B)&&N.fragment===x&&(I=U),F=K}return I},n.loadedEndOfParts=function(c,x){var O=c[c.length-1];return O&&x>O.start&&O.loaded},n.getInitialLiveFragment=function(c,x){var O=this.fragPrevious,I=null;if(O){if(c.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+O.programDateTime),I=Object(p.findFragmentByPDT)(x,O.endProgramDateTime,this.config.maxFragLookUpTolerance)),!I){var F=O.sn+1;if(F>=c.startSN&&F<=c.endSN){var B=x[F-c.startSN];O.cc===B.cc&&(I=B,this.log("Live playlist, switching playlist, load frag with next SN: "+I.sn))}I||(I=Object(p.findFragWithCC)(x,O.cc),I&&this.log("Live playlist, switching playlist, load frag with same CC: "+I.sn))}}else{var U=this.hls.liveSyncPosition;U!==null&&(I=this.getFragmentAtPosition(U,this.bitrateTest?c.fragmentEnd:c.edge,c))}return I},n.getFragmentAtPosition=function(c,x,O){var I=this.config,F=this.fragPrevious,B=O.fragments,U=O.endSN,k=O.fragmentHint,N=I.maxFragLookUpTolerance,K=!!(I.lowLatencyMode&&O.partList&&k);K&&k&&!this.bitrateTest&&(B=B.concat(k),U=k.sn);var W;if(c<x){var w=c>x-N?0:N;W=Object(p.findFragmentByPTS)(F,B,c,w)}else W=B[B.length-1];if(W){var H=W.sn-O.startSN,V=F&&W.level===F.level,j=B[H+1],X=this.fragmentTracker.getState(W);if(X===D.FragmentState.BACKTRACKED){W=null;for(var Y=H;B[Y]&&this.fragmentTracker.getState(B[Y])===D.FragmentState.BACKTRACKED;)F?W=B[Y--]:W=B[--Y];W||(W=j)}else F&&W.sn===F.sn&&!K&&V&&(W.sn<U&&this.fragmentTracker.getState(j)!==D.FragmentState.OK?(this.log("SN "+W.sn+" just loaded, load next one: "+j.sn),W=j):W=null)}return W},n.synchronizeToLiveEdge=function(c){var x=this.config,O=this.media;if(!!O){var I=this.hls.liveSyncPosition,F=O.currentTime,B=c.fragments[0].start,U=c.edge,k=F>=B-x.maxFragLookUpTolerance&&F<=U;if(I!==null&&O.duration>I&&(F<I||!k)){var N=x.liveMaxLatencyDuration!==void 0?x.liveMaxLatencyDuration:x.liveMaxLatencyDurationCount*c.targetduration;(!k&&O.readyState<4||F<U-N)&&(this.loadedmetadata||(this.nextLoadPosition=I),O.readyState&&(this.warn("Playback: "+F.toFixed(3)+" is located too far from the end of live sliding playlist: "+U+", reset currentTime to : "+I.toFixed(3)),O.currentTime=I))}}},n.alignPlaylists=function(c,x){var O=this.levels,I=this.levelLastLoaded,F=this.fragPrevious,B=I!==null?O[I]:null,U=c.fragments.length;if(!U)return this.warn("No fragments in live playlist"),0;var k=c.fragments[0].start,N=!x,K=c.alignedSliding&&Object(C.isFiniteNumber)(k);if(N||!K&&!k){Object(S.alignStream)(F,B,c);var W=c.fragments[0].start;return this.log("Live playlist sliding: "+W.toFixed(2)+" start-sn: "+(x?x.startSN:"na")+"->"+c.startSN+" prev-sn: "+(F?F.sn:"na")+" fragments: "+U),W}return k},n.waitForCdnTuneIn=function(c){var x=3;return c.live&&c.canBlockReload&&c.tuneInGoal>Math.max(c.partHoldBack,c.partTarget*x)},n.setStartPosition=function(c,x){var O=this.startPosition;if(O<x&&(O=-1),O===-1||this.lastCurrentTime===-1){var I=c.startTimeOffset;Object(C.isFiniteNumber)(I)?(O=x+I,I<0&&(O+=c.totalduration),O=Math.min(Math.max(x,O),x+c.totalduration),this.log("Start time offset "+I+" found in playlist, adjust startPosition to "+O),this.startPosition=O):c.live?O=this.hls.liveSyncPosition||x:this.startPosition=O=0,this.lastCurrentTime=O}this.nextLoadPosition=O},n.getLoadPosition=function(){var c=this.media,x=0;return this.loadedmetadata&&c?x=c.currentTime:this.nextLoadPosition&&(x=this.nextLoadPosition),x},n.handleFragLoadAborted=function(c,x){this.transmuxer&&c.sn!=="initSegment"&&c.stats.aborted&&(this.warn("Fragment "+c.sn+(x?" part"+x.index:"")+" of level "+c.level+" was aborted"),this.resetFragmentLoading(c))},n.resetFragmentLoading=function(c){(!this.fragCurrent||!this.fragContextChanged(c))&&(this.state=d.IDLE)},n.onFragmentOrKeyLoadError=function(c,x){if(!x.fatal){var O=x.frag;if(!(!O||O.type!==c)){var I=this.fragCurrent;console.assert(I&&O.sn===I.sn&&O.level===I.level&&O.urlId===I.urlId,"Frag load error must match current frag to retry");var F=this.config;if(this.fragLoadError+1<=F.fragLoadingMaxRetry){if(this.resetLiveStartWhenNotLoaded(O.level))return;var B=Math.min(Math.pow(2,this.fragLoadError)*F.fragLoadingRetryDelay,F.fragLoadingMaxRetryTimeout);this.warn("Fragment "+O.sn+" of "+c+" "+O.level+" failed to load, retrying in "+B+"ms"),this.retryDate=self.performance.now()+B,this.fragLoadError++,this.state=d.FRAG_LOADING_WAITING_RETRY}else x.levelRetry?(c===r.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=d.IDLE):(P.logger.error(x.details+" reaches max retry, redispatch as fatal ..."),x.fatal=!0,this.hls.stopLoad(),this.state=d.ERROR)}}},n.afterBufferFlushed=function(c,x,O){if(!!c){var I=M.BufferHelper.getBuffered(c);this.fragmentTracker.detectEvictedFragments(x,I,O),this.state===d.ENDED&&this.resetLoadingState()}},n.resetLoadingState=function(){this.fragCurrent=null,this.fragPrevious=null,this.state=d.IDLE},n.resetLiveStartWhenNotLoaded=function(c){if(!this.loadedmetadata){this.startFragRequested=!1;var x=this.levels?this.levels[c].details:null;if(x!=null&&x.live)return this.startPosition=-1,this.setStartPosition(x,0),this.resetLoadingState(),!0;this.nextLoadPosition=this.startPosition}return!1},n.updateLevelTiming=function(c,x,O,I){var F=this,B=O.details;console.assert(!!B,"level.details must be defined");var U=Object.keys(c.elementaryStreams).reduce(function(k,N){var K=c.elementaryStreams[N];if(K){var W=K.endPTS-K.startPTS;if(W<=0)return F.warn("Could not parse fragment "+c.sn+" "+N+" duration reliably ("+W+") resetting transmuxer to fallback to playlist timing"),F.resetTransmuxer(),k||!1;var w=I?0:Object(E.updateFragPTSDTS)(B,c,K.startPTS,K.endPTS,K.startDTS,K.endDTS);return F.hls.trigger(R.Events.LEVEL_PTS_UPDATED,{details:B,level:O,drift:w,type:N,frag:c,start:K.startPTS,end:K.endPTS}),!0}return k},!1);U?(this.state=d.PARSED,this.hls.trigger(R.Events.FRAG_PARSED,{frag:c,part:x})):this.resetLoadingState()},n.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},f(i,[{key:"state",get:function(){return this._state},set:function(c){var x=this._state;x!==c&&(this._state=c,this.log(x+"->"+c))}}]),i}(A.default)},"./src/controller/buffer-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return p});var C=T("./src/polyfills/number.ts"),A=T("./src/events.ts"),D=T("./src/utils/logger.ts"),M=T("./src/errors.ts"),P=T("./src/utils/buffer-helper.ts"),R=T("./src/utils/mediasource-helper.ts"),L=T("./src/loader/fragment.ts"),g=T("./src/controller/buffer-operation-queue.ts"),y=Object(R.getMediaSource)(),S=/([ha]vc.)(?:\.[^.,]+)+/,p=function(){function E(u){var t=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var r=t.hls,e=t.media,f=t.mediaSource;D.logger.log("[buffer-controller]: Media source opened"),e&&(t.updateMediaElementDuration(),r.trigger(A.Events.MEDIA_ATTACHED,{media:e})),f&&f.removeEventListener("sourceopen",t._onMediaSourceOpen),t.checkPendingTracks()},this._onMediaSourceClose=function(){D.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){D.logger.log("[buffer-controller]: Media source ended")},this.hls=u,this._initSourceBuffer(),this.registerListeners()}var m=E.prototype;return m.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},m.destroy=function(){this.unregisterListeners(),this.details=null},m.registerListeners=function(){var t=this.hls;t.on(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(A.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.on(A.Events.BUFFER_RESET,this.onBufferReset,this),t.on(A.Events.BUFFER_APPENDING,this.onBufferAppending,this),t.on(A.Events.BUFFER_CODECS,this.onBufferCodecs,this),t.on(A.Events.BUFFER_EOS,this.onBufferEos,this),t.on(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(A.Events.FRAG_PARSED,this.onFragParsed,this),t.on(A.Events.FRAG_CHANGED,this.onFragChanged,this)},m.unregisterListeners=function(){var t=this.hls;t.off(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(A.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.off(A.Events.BUFFER_RESET,this.onBufferReset,this),t.off(A.Events.BUFFER_APPENDING,this.onBufferAppending,this),t.off(A.Events.BUFFER_CODECS,this.onBufferCodecs,this),t.off(A.Events.BUFFER_EOS,this.onBufferEos,this),t.off(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(A.Events.FRAG_PARSED,this.onFragParsed,this),t.off(A.Events.FRAG_CHANGED,this.onFragChanged,this)},m._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new g.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}},m.onManifestParsed=function(t,r){var e=2;(r.audio&&!r.video||!r.altAudio)&&(e=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=e,this.details=null,D.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},m.onMediaAttaching=function(t,r){var e=this.media=r.media;if(e&&y){var f=this.mediaSource=new y;f.addEventListener("sourceopen",this._onMediaSourceOpen),f.addEventListener("sourceended",this._onMediaSourceEnded),f.addEventListener("sourceclose",this._onMediaSourceClose),e.src=self.URL.createObjectURL(f),this._objectUrl=e.src}},m.onMediaDetaching=function(){var t=this.media,r=this.mediaSource,e=this._objectUrl;if(r){if(D.logger.log("[buffer-controller]: media source detaching"),r.readyState==="open")try{r.endOfStream()}catch(f){D.logger.warn("[buffer-controller]: onMediaDetaching: "+f.message+" while calling endOfStream")}this.onBufferReset(),r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),t&&(e&&self.URL.revokeObjectURL(e),t.src===e?(t.removeAttribute("src"),t.load()):D.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(A.Events.MEDIA_DETACHED,void 0)},m.onBufferReset=function(){var t=this;this.getSourceBufferTypes().forEach(function(r){var e=t.sourceBuffer[r];try{e&&(t.removeBufferListeners(r),t.mediaSource&&t.mediaSource.removeSourceBuffer(e),t.sourceBuffer[r]=void 0)}catch(f){D.logger.warn("[buffer-controller]: Failed to reset the "+r+" buffer",f)}}),this._initSourceBuffer()},m.onBufferCodecs=function(t,r){var e=this,f=this.getSourceBufferTypes().length;Object.keys(r).forEach(function(s){if(f){var l=e.tracks[s];if(l&&typeof l.buffer.changeType=="function"){var h=r[s],d=h.codec,o=h.levelCodec,a=h.container,i=(l.levelCodec||l.codec).replace(S,"$1"),n=(o||d).replace(S,"$1");if(i!==n){var v=a+";codecs="+(o||d);e.appendChangeType(s,v)}}}else e.pendingTracks[s]=r[s]}),!f&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())},m.appendChangeType=function(t,r){var e=this,f=this.operationQueue,s={execute:function(){var h=e.sourceBuffer[t];h&&(D.logger.log("[buffer-controller]: changing "+t+" sourceBuffer type to "+r),h.changeType(r)),f.shiftAndExecuteNext(t)},onStart:function(){},onComplete:function(){},onError:function(h){D.logger.warn("[buffer-controller]: Failed to change "+t+" SourceBuffer type",h)}};f.append(s,t)},m.onBufferAppending=function(t,r){var e=this,f=this.hls,s=this.operationQueue,l=this.tracks,h=r.data,d=r.type,o=r.frag,a=r.part,i=r.chunkMeta,n=i.buffering[d],v=self.performance.now();n.start=v;var c=o.stats.buffering,x=a?a.stats.buffering:null;c.start===0&&(c.start=v),x&&x.start===0&&(x.start=v);var O=l.audio,I=d==="audio"&&i.id===1&&(O==null?void 0:O.container)==="audio/mpeg",F={execute:function(){if(n.executeStart=self.performance.now(),I){var U=e.sourceBuffer[d];if(U){var k=o.start-U.timestampOffset;Math.abs(k)>=.1&&(D.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+o.start+" (delta: "+k+") sn: "+o.sn+")"),U.timestampOffset=o.start)}}e.appendExecutor(h,d)},onStart:function(){},onComplete:function(){var U=self.performance.now();n.executeEnd=n.end=U,c.first===0&&(c.first=U),x&&x.first===0&&(x.first=U);var k=e.sourceBuffer,N={};for(var K in k)N[K]=P.BufferHelper.getBuffered(k[K]);e.appendError=0,e.hls.trigger(A.Events.BUFFER_APPENDED,{type:d,frag:o,part:a,chunkMeta:i,parent:o.type,timeRanges:N})},onError:function(U){D.logger.error("[buffer-controller]: Error encountered while trying to append to the "+d+" SourceBuffer",U);var k={type:M.ErrorTypes.MEDIA_ERROR,parent:o.type,details:M.ErrorDetails.BUFFER_APPEND_ERROR,err:U,fatal:!1};U.code===DOMException.QUOTA_EXCEEDED_ERR?k.details=M.ErrorDetails.BUFFER_FULL_ERROR:(e.appendError++,k.details=M.ErrorDetails.BUFFER_APPEND_ERROR,e.appendError>f.config.appendErrorMaxRetry&&(D.logger.error("[buffer-controller]: Failed "+f.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),k.fatal=!0)),f.trigger(A.Events.ERROR,k)}};s.append(F,d)},m.onBufferFlushing=function(t,r){var e=this,f=this.operationQueue,s=function(h){return{execute:e.removeExecutor.bind(e,h,r.startOffset,r.endOffset),onStart:function(){},onComplete:function(){e.hls.trigger(A.Events.BUFFER_FLUSHED,{type:h})},onError:function(o){D.logger.warn("[buffer-controller]: Failed to remove from "+h+" SourceBuffer",o)}}};r.type?f.append(s(r.type),r.type):this.getSourceBufferTypes().forEach(function(l){f.append(s(l),l)})},m.onFragParsed=function(t,r){var e=this,f=r.frag,s=r.part,l=[],h=s?s.elementaryStreams:f.elementaryStreams;h[L.ElementaryStreamTypes.AUDIOVIDEO]?l.push("audiovideo"):(h[L.ElementaryStreamTypes.AUDIO]&&l.push("audio"),h[L.ElementaryStreamTypes.VIDEO]&&l.push("video"));var d=function(){var a=self.performance.now();f.stats.buffering.end=a,s&&(s.stats.buffering.end=a);var i=s?s.stats:f.stats;e.hls.trigger(A.Events.FRAG_BUFFERED,{frag:f,part:s,stats:i,id:f.type})};l.length===0&&D.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+f.type+" level: "+f.level+" sn: "+f.sn),this.blockBuffers(d,l)},m.onFragChanged=function(t,r){this.flushBackBuffer()},m.onBufferEos=function(t,r){var e=this,f=this.getSourceBufferTypes().reduce(function(s,l){var h=e.sourceBuffer[l];return(!r.type||r.type===l)&&h&&!h.ended&&(h.ended=!0,D.logger.log("[buffer-controller]: "+l+" sourceBuffer now EOS")),s&&!!(!h||h.ended)},!0);f&&this.blockBuffers(function(){var s=e.mediaSource;!s||s.readyState!=="open"||s.endOfStream()})},m.onLevelUpdated=function(t,r){var e=r.details;!e.fragments.length||(this.details=e,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},m.flushBackBuffer=function(){var t=this.hls,r=this.details,e=this.media,f=this.sourceBuffer;if(!(!e||r===null)){var s=this.getSourceBufferTypes();if(!!s.length){var l=r.live&&t.config.liveBackBufferLength!==null?t.config.liveBackBufferLength:t.config.backBufferLength;if(!(!Object(C.isFiniteNumber)(l)||l<0)){var h=e.currentTime,d=r.levelTargetDuration,o=Math.max(l,d),a=Math.floor(h/d)*d-o;s.forEach(function(i){var n=f[i];if(n){var v=P.BufferHelper.getBuffered(n);v.length>0&&a>v.start(0)&&(t.trigger(A.Events.BACK_BUFFER_REACHED,{bufferEnd:a}),r.live&&t.trigger(A.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:a}),t.trigger(A.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:a,type:i}))}})}}}},m.updateMediaElementDuration=function(){if(!(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")){var t=this.details,r=this.hls,e=this.media,f=this.mediaSource,s=t.fragments[0].start+t.totalduration,l=e.duration,h=Object(C.isFiniteNumber)(f.duration)?f.duration:0;t.live&&r.config.liveDurationInfinity?(D.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),f.duration=1/0,this.updateSeekableRange(t)):(s>h&&s>l||!Object(C.isFiniteNumber)(l))&&(D.logger.log("[buffer-controller]: Updating Media Source duration to "+s.toFixed(3)),f.duration=s)}},m.updateSeekableRange=function(t){var r=this.mediaSource,e=t.fragments,f=e.length;if(f&&t.live&&r!==null&&r!==void 0&&r.setLiveSeekableRange){var s=Math.max(0,e[0].start),l=Math.max(s,s+t.totalduration);r.setLiveSeekableRange(s,l)}},m.checkPendingTracks=function(){var t=this.bufferCodecEventsExpected,r=this.operationQueue,e=this.pendingTracks,f=Object.keys(e).length;if(f&&!t||f===2){this.createSourceBuffers(e),this.pendingTracks={};var s=this.getSourceBufferTypes();if(s.length===0){this.hls.trigger(A.Events.ERROR,{type:M.ErrorTypes.MEDIA_ERROR,details:M.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});return}s.forEach(function(l){r.executeNext(l)})}},m.createSourceBuffers=function(t){var r=this.sourceBuffer,e=this.mediaSource;if(!e)throw Error("createSourceBuffers called when mediaSource was null");var f=0;for(var s in t)if(!r[s]){var l=t[s];if(!l)throw Error("source buffer exists for track "+s+", however track does not");var h=l.levelCodec||l.codec,d=l.container+";codecs="+h;D.logger.log("[buffer-controller]: creating sourceBuffer("+d+")");try{var o=r[s]=e.addSourceBuffer(d),a=s;this.addBufferListener(a,"updatestart",this._onSBUpdateStart),this.addBufferListener(a,"updateend",this._onSBUpdateEnd),this.addBufferListener(a,"error",this._onSBUpdateError),this.tracks[s]={buffer:o,codec:h,container:l.container,levelCodec:l.levelCodec,id:l.id},f++}catch(i){D.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+i.message),this.hls.trigger(A.Events.ERROR,{type:M.ErrorTypes.MEDIA_ERROR,details:M.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:i,mimeType:d})}}f&&this.hls.trigger(A.Events.BUFFER_CREATED,{tracks:this.tracks})},m._onSBUpdateStart=function(t){var r=this.operationQueue,e=r.current(t);e.onStart()},m._onSBUpdateEnd=function(t){var r=this.operationQueue,e=r.current(t);e.onComplete(),r.shiftAndExecuteNext(t)},m._onSBUpdateError=function(t,r){D.logger.error("[buffer-controller]: "+t+" SourceBuffer error",r),this.hls.trigger(A.Events.ERROR,{type:M.ErrorTypes.MEDIA_ERROR,details:M.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var e=this.operationQueue.current(t);e&&e.onError(r)},m.removeExecutor=function(t,r,e){var f=this.media,s=this.mediaSource,l=this.operationQueue,h=this.sourceBuffer,d=h[t];if(!f||!s||!d){D.logger.warn("[buffer-controller]: Attempting to remove from the "+t+" SourceBuffer, but it does not exist"),l.shiftAndExecuteNext(t);return}var o=Object(C.isFiniteNumber)(f.duration)?f.duration:1/0,a=Object(C.isFiniteNumber)(s.duration)?s.duration:1/0,i=Math.max(0,r),n=Math.min(e,o,a);n>i?(D.logger.log("[buffer-controller]: Removing ["+i+","+n+"] from the "+t+" SourceBuffer"),console.assert(!d.updating,t+" sourceBuffer must not be updating"),d.remove(i,n)):l.shiftAndExecuteNext(t)},m.appendExecutor=function(t,r){var e=this.operationQueue,f=this.sourceBuffer,s=f[r];if(!s){D.logger.warn("[buffer-controller]: Attempting to append to the "+r+" SourceBuffer, but it does not exist"),e.shiftAndExecuteNext(r);return}s.ended=!1,console.assert(!s.updating,r+" sourceBuffer must not be updating"),s.appendBuffer(t)},m.blockBuffers=function(t,r){var e=this;if(r===void 0&&(r=this.getSourceBufferTypes()),!r.length){D.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve(t);return}var f=this.operationQueue,s=r.map(function(l){return f.appendBlocker(l)});Promise.all(s).then(function(){t(),r.forEach(function(l){var h=e.sourceBuffer[l];(!h||!h.updating)&&f.shiftAndExecuteNext(l)})})},m.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},m.addBufferListener=function(t,r,e){var f=this.sourceBuffer[t];if(!!f){var s=e.bind(this,t);this.listeners[t].push({event:r,listener:s}),f.addEventListener(r,s)}},m.removeBufferListeners=function(t){var r=this.sourceBuffer[t];!r||this.listeners[t].forEach(function(e){r.removeEventListener(e.event,e.listener)})},E}()},"./src/controller/buffer-operation-queue.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return A});var C=T("./src/utils/logger.ts"),A=function(){function D(P){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=P}var M=D.prototype;return M.append=function(R,L){var g=this.queues[L];g.push(R),g.length===1&&this.buffers[L]&&this.executeNext(L)},M.insertAbort=function(R,L){var g=this.queues[L];g.unshift(R),this.executeNext(L)},M.appendBlocker=function(R){var L,g=new Promise(function(S){L=S}),y={execute:L,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(y,R),g},M.executeNext=function(R){var L=this.buffers,g=this.queues,y=L[R],S=g[R];if(S.length){var p=S[0];try{p.execute()}catch(E){C.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),p.onError(E),(!y||!y.updating)&&(S.shift(),this.executeNext(R))}}},M.shiftAndExecuteNext=function(R){this.queues[R].shift(),this.executeNext(R)},M.current=function(R){return this.queues[R][0]},D}()},"./src/controller/cap-level-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/events.ts");function A(P,R){for(var L=0;L<R.length;L++){var g=R[L];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(P,g.key,g)}}function D(P,R,L){return R&&A(P.prototype,R),L&&A(P,L),P}var M=function(){function P(L){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=L,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var R=P.prototype;return R.setStreamController=function(g){this.streamController=g},R.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},R.registerListeners=function(){var g=this.hls;g.on(C.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),g.on(C.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),g.on(C.Events.MANIFEST_PARSED,this.onManifestParsed,this),g.on(C.Events.BUFFER_CODECS,this.onBufferCodecs,this),g.on(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},R.unregisterListener=function(){var g=this.hls;g.off(C.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),g.off(C.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),g.off(C.Events.MANIFEST_PARSED,this.onManifestParsed,this),g.off(C.Events.BUFFER_CODECS,this.onBufferCodecs,this),g.off(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},R.onFpsDropLevelCapping=function(g,y){P.isLevelAllowed(y.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(y.droppedLevel)},R.onMediaAttaching=function(g,y){this.media=y.media instanceof HTMLVideoElement?y.media:null},R.onManifestParsed=function(g,y){var S=this.hls;this.restrictedLevels=[],this.firstLevel=y.firstLevel,S.config.capLevelToPlayerSize&&y.video&&this.startCapping()},R.onBufferCodecs=function(g,y){var S=this.hls;S.config.capLevelToPlayerSize&&y.video&&this.startCapping()},R.onMediaDetaching=function(){this.stopCapping()},R.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var g=this.hls.levels;if(g.length){var y=this.hls;y.autoLevelCapping=this.getMaxLevel(g.length-1),y.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=y.autoLevelCapping}}},R.getMaxLevel=function(g){var y=this,S=this.hls.levels;if(!S.length)return-1;var p=S.filter(function(E,m){return P.isLevelAllowed(m,y.restrictedLevels)&&m<=g});return this.clientRect=null,P.getMaxLevelByMediaSize(p,this.mediaWidth,this.mediaHeight)},R.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},R.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},R.getDimensions=function(){if(this.clientRect)return this.clientRect;var g=this.media,y={width:0,height:0};if(g){var S=g.getBoundingClientRect();y.width=S.width,y.height=S.height,!y.width&&!y.height&&(y.width=S.right-S.left||g.width||0,y.height=S.bottom-S.top||g.height||0)}return this.clientRect=y,y},P.isLevelAllowed=function(g,y){return y===void 0&&(y=[]),y.indexOf(g)===-1},P.getMaxLevelByMediaSize=function(g,y,S){if(!g||!g.length)return-1;for(var p=function(r,e){return e?r.width!==e.width||r.height!==e.height:!0},E=g.length-1,m=0;m<g.length;m+=1){var u=g[m];if((u.width>=y||u.height>=S)&&p(u,g[m+1])){E=m;break}}return E},D(P,[{key:"mediaWidth",get:function(){return this.getDimensions().width*P.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*P.contentScaleFactor}}],[{key:"contentScaleFactor",get:function(){var g=1;try{g=self.devicePixelRatio}catch(y){}return g}}]),P}();b.default=M},"./src/controller/cmcd-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return p});var C=T("./src/events.ts"),A=T("./src/types/cmcd.ts"),D=T("./src/utils/buffer-helper.ts"),M=T("./src/utils/logger.ts");function P(E,m){for(var u=0;u<m.length;u++){var t=m[u];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(E,t.key,t)}}function R(E,m,u){return m&&P(E.prototype,m),u&&P(E,u),E}function L(E,m){var u=typeof Symbol!="undefined"&&E[Symbol.iterator]||E["@@iterator"];if(u)return(u=u.call(E)).next.bind(u);if(Array.isArray(E)||(u=g(E))||m&&E&&typeof E.length=="number"){u&&(E=u);var t=0;return function(){return t>=E.length?{done:!0}:{done:!1,value:E[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function g(E,m){if(!!E){if(typeof E=="string")return y(E,m);var u=Object.prototype.toString.call(E).slice(8,-1);if(u==="Object"&&E.constructor&&(u=E.constructor.name),u==="Map"||u==="Set")return Array.from(E);if(u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u))return y(E,m)}}function y(E,m){(m==null||m>E.length)&&(m=E.length);for(var u=0,t=new Array(m);u<m;u++)t[u]=E[u];return t}function S(){return S=Object.assign||function(E){for(var m=1;m<arguments.length;m++){var u=arguments[m];for(var t in u)Object.prototype.hasOwnProperty.call(u,t)&&(E[t]=u[t])}return E},S.apply(this,arguments)}var p=function(){function E(u){var t=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){t.initialized&&(t.starved=!0),t.buffering=!0},this.onPlaying=function(){t.initialized||(t.initialized=!0),t.buffering=!1},this.applyPlaylistData=function(f){try{t.apply(f,{ot:A.CMCDObjectType.MANIFEST,su:!t.initialized})}catch(s){M.logger.warn("Could not generate manifest CMCD data.",s)}},this.applyFragmentData=function(f){try{var s=f.frag,l=t.hls.levels[s.level],h=t.getObjectType(s),d={d:s.duration*1e3,ot:h};(h===A.CMCDObjectType.VIDEO||h===A.CMCDObjectType.AUDIO||h==A.CMCDObjectType.MUXED)&&(d.br=l.bitrate/1e3,d.tb=t.getTopBandwidth(h)/1e3,d.bl=t.getBufferLength(h)),t.apply(f,d)}catch(o){M.logger.warn("Could not generate segment CMCD data.",o)}},this.hls=u;var r=this.config=u.config,e=r.cmcd;e!=null&&(r.pLoader=this.createPlaylistLoader(),r.fLoader=this.createFragmentLoader(),this.sid=e.sessionId||E.uuid(),this.cid=e.contentId,this.useHeaders=e.useHeaders===!0,this.registerListeners())}var m=E.prototype;return m.registerListeners=function(){var t=this.hls;t.on(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.Events.MEDIA_DETACHED,this.onMediaDetached,this),t.on(C.Events.BUFFER_CREATED,this.onBufferCreated,this)},m.unregisterListeners=function(){var t=this.hls;t.off(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.Events.MEDIA_DETACHED,this.onMediaDetached,this),t.off(C.Events.BUFFER_CREATED,this.onBufferCreated,this),this.onMediaDetached()},m.destroy=function(){this.unregisterListeners(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},m.onMediaAttached=function(t,r){this.media=r.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},m.onMediaDetached=function(){!this.media||(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},m.onBufferCreated=function(t,r){var e,f;this.audioBuffer=(e=r.tracks.audio)===null||e===void 0?void 0:e.buffer,this.videoBuffer=(f=r.tracks.video)===null||f===void 0?void 0:f.buffer},m.createData=function(){var t;return{v:A.CMCDVersion,sf:A.CMCDStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:(t=this.media)===null||t===void 0?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},m.apply=function(t,r){r===void 0&&(r={}),S(r,this.createData());var e=r.ot===A.CMCDObjectType.INIT||r.ot===A.CMCDObjectType.VIDEO||r.ot===A.CMCDObjectType.MUXED;if(this.starved&&e&&(r.bs=!0,r.su=!0,this.starved=!1),r.su==null&&(r.su=this.buffering),this.useHeaders){var f=E.toHeaders(r);if(!Object.keys(f).length)return;t.headers||(t.headers={}),S(t.headers,f)}else{var s=E.toQuery(r);if(!s)return;t.url=E.appendQueryToUri(t.url,s)}},m.getObjectType=function(t){var r=t.type;if(r==="subtitle")return A.CMCDObjectType.TIMED_TEXT;if(t.sn==="initSegment")return A.CMCDObjectType.INIT;if(r==="audio")return A.CMCDObjectType.AUDIO;if(r==="main")return this.hls.audioTracks.length?A.CMCDObjectType.VIDEO:A.CMCDObjectType.MUXED},m.getTopBandwidth=function(t){var r=0,e,f=this.hls;if(t===A.CMCDObjectType.AUDIO)e=f.audioTracks;else{var s=f.maxAutoLevel,l=s>-1?s+1:f.levels.length;e=f.levels.slice(0,l)}for(var h=L(e),d;!(d=h()).done;){var o=d.value;o.bitrate>r&&(r=o.bitrate)}return r>0?r:NaN},m.getBufferLength=function(t){var r=this.hls.media,e=t===A.CMCDObjectType.AUDIO?this.audioBuffer:this.videoBuffer;if(!e||!r)return NaN;var f=D.BufferHelper.bufferInfo(e,r.currentTime,this.config.maxBufferHole);return f.len*1e3},m.createPlaylistLoader=function(){var t=this.config.pLoader,r=this.applyPlaylistData,e=t||this.config.loader;return function(){function f(l){this.loader=void 0,this.loader=new e(l)}var s=f.prototype;return s.destroy=function(){this.loader.destroy()},s.abort=function(){this.loader.abort()},s.load=function(h,d,o){r(h),this.loader.load(h,d,o)},R(f,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),f}()},m.createFragmentLoader=function(){var t=this.config.fLoader,r=this.applyFragmentData,e=t||this.config.loader;return function(){function f(l){this.loader=void 0,this.loader=new e(l)}var s=f.prototype;return s.destroy=function(){this.loader.destroy()},s.abort=function(){this.loader.abort()},s.load=function(h,d,o){r(h),this.loader.load(h,d,o)},R(f,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),f}()},E.uuid=function(){var t=URL.createObjectURL(new Blob),r=t.toString();return URL.revokeObjectURL(t),r.substr(r.lastIndexOf("/")+1)},E.serialize=function(t){for(var r=[],e=function(I){return!Number.isNaN(I)&&I!=null&&I!==""&&I!==!1},f=function(I){return Math.round(I)},s=function(I){return f(I/100)*100},l=function(I){return encodeURIComponent(I)},h={br:f,d:f,bl:s,dl:s,mtp:s,nor:l,rtp:s,tb:f},d=Object.keys(t||{}).sort(),o=L(d),a;!(a=o()).done;){var i=a.value,n=t[i];if(!!e(n)&&!(i==="v"&&n===1)&&!(i=="pr"&&n===1)){var v=h[i];v&&(n=v(n));var c=typeof n,x=void 0;i==="ot"||i==="sf"||i==="st"?x=i+"="+n:c==="boolean"?x=i:c==="number"?x=i+"="+n:x=i+"="+JSON.stringify(n),r.push(x)}}return r.join(",")},E.toHeaders=function(t){for(var r=Object.keys(t),e={},f=["Object","Request","Session","Status"],s=[{},{},{},{}],l={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},h=0,d=r;h<d.length;h++){var o=d[h],a=l[o]!=null?l[o]:1;s[a][o]=t[o]}for(var i=0;i<s.length;i++){var n=E.serialize(s[i]);n&&(e["CMCD-"+f[i]]=n)}return e},E.toQuery=function(t){return"CMCD="+encodeURIComponent(E.serialize(t))},E.appendQueryToUri=function(t,r){if(!r)return t;var e=t.includes("?")?"&":"?";return""+t+e+r},E}()},"./src/controller/eme-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/events.ts"),A=T("./src/errors.ts"),D=T("./src/utils/logger.ts"),M=T("./src/utils/mediakeys-helper.ts");function P(p,E){for(var m=0;m<E.length;m++){var u=E[m];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(p,u.key,u)}}function R(p,E,m){return E&&P(p.prototype,E),m&&P(p,m),p}var L=3,g=function(E,m,u){var t={audioCapabilities:[],videoCapabilities:[]};return E.forEach(function(r){t.audioCapabilities.push({contentType:'audio/mp4; codecs="'+r+'"',robustness:u.audioRobustness||""})}),m.forEach(function(r){t.videoCapabilities.push({contentType:'video/mp4; codecs="'+r+'"',robustness:u.videoRobustness||""})}),[t]},y=function(E,m,u,t){switch(E){case M.KeySystems.WIDEVINE:return g(m,u,t);default:throw new Error("Unknown key-system: "+E)}},S=function(){function p(m){this.hls=void 0,this._widevineLicenseUrl=void 0,this._licenseXhrSetup=void 0,this._licenseResponseCallback=void 0,this._emeEnabled=void 0,this._requestMediaKeySystemAccess=void 0,this._drmSystemOptions=void 0,this._config=void 0,this._mediaKeysList=[],this._media=null,this._hasSetMediaKeys=!1,this._requestLicenseFailureCount=0,this.mediaKeysPromise=null,this._onMediaEncrypted=this.onMediaEncrypted.bind(this),this.hls=m,this._config=m.config,this._widevineLicenseUrl=this._config.widevineLicenseUrl,this._licenseXhrSetup=this._config.licenseXhrSetup,this._licenseResponseCallback=this._config.licenseResponseCallback,this._emeEnabled=this._config.emeEnabled,this._requestMediaKeySystemAccess=this._config.requestMediaKeySystemAccessFunc,this._drmSystemOptions=this._config.drmSystemOptions,this._registerListeners()}var E=p.prototype;return E.destroy=function(){this._unregisterListeners(),this.hls=this._onMediaEncrypted=null,this._requestMediaKeySystemAccess=null},E._registerListeners=function(){this.hls.on(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(C.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(C.Events.MANIFEST_PARSED,this.onManifestParsed,this)},E._unregisterListeners=function(){this.hls.off(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(C.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(C.Events.MANIFEST_PARSED,this.onManifestParsed,this)},E.getLicenseServerUrl=function(u){switch(u){case M.KeySystems.WIDEVINE:if(!this._widevineLicenseUrl)break;return this._widevineLicenseUrl}throw new Error('no license server URL configured for key-system "'+u+'"')},E._attemptKeySystemAccess=function(u,t,r){var e=this,f=y(u,t,r,this._drmSystemOptions);D.logger.log("Requesting encrypted media key-system access");var s=this.requestMediaKeySystemAccess(u,f);this.mediaKeysPromise=s.then(function(l){return e._onMediaKeySystemAccessObtained(u,l)}),s.catch(function(l){D.logger.error('Failed to obtain key-system "'+u+'" access:',l)})},E._onMediaKeySystemAccessObtained=function(u,t){var r=this;D.logger.log('Access for key-system "'+u+'" obtained');var e={mediaKeysSessionInitialized:!1,mediaKeySystemAccess:t,mediaKeySystemDomain:u};this._mediaKeysList.push(e);var f=Promise.resolve().then(function(){return t.createMediaKeys()}).then(function(s){return e.mediaKeys=s,D.logger.log('Media-keys created for key-system "'+u+'"'),r._onMediaKeysCreated(),s});return f.catch(function(s){D.logger.error("Failed to create media-keys:",s)}),f},E._onMediaKeysCreated=function(){var u=this;this._mediaKeysList.forEach(function(t){t.mediaKeysSession||(t.mediaKeysSession=t.mediaKeys.createSession(),u._onNewMediaKeySession(t.mediaKeysSession))})},E._onNewMediaKeySession=function(u){var t=this;D.logger.log("New key-system session "+u.sessionId),u.addEventListener("message",function(r){t._onKeySessionMessage(u,r.message)},!1)},E._onKeySessionMessage=function(u,t){D.logger.log("Got EME message event, creating license request"),this._requestLicense(t,function(r){D.logger.log("Received license data (length: "+(r&&r.byteLength)+"), updating key-session"),u.update(r)})},E.onMediaEncrypted=function(u){var t=this;if(D.logger.log('Media is encrypted using "'+u.initDataType+'" init data type'),!this.mediaKeysPromise){D.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been requested"),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});return}var r=function(f){!t._media||(t._attemptSetMediaKeys(f),t._generateRequestWithPreferredKeySession(u.initDataType,u.initData))};this.mediaKeysPromise.then(r).catch(r)},E._attemptSetMediaKeys=function(u){if(!this._media)throw new Error("Attempted to set mediaKeys without first attaching a media element");if(!this._hasSetMediaKeys){var t=this._mediaKeysList[0];if(!t||!t.mediaKeys){D.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been obtained yet"),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});return}D.logger.log("Setting keys for encrypted media"),this._media.setMediaKeys(t.mediaKeys),this._hasSetMediaKeys=!0}},E._generateRequestWithPreferredKeySession=function(u,t){var r=this,e=this._mediaKeysList[0];if(!e){D.logger.error("Fatal: Media is encrypted but not any key-system access has been obtained yet"),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});return}if(e.mediaKeysSessionInitialized){D.logger.warn("Key-Session already initialized but requested again");return}var f=e.mediaKeysSession;if(!f){D.logger.error("Fatal: Media is encrypted but no key-session existing"),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!0});return}if(!t){D.logger.warn("Fatal: initData required for generating a key session is null"),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_INIT_DATA,fatal:!0});return}D.logger.log('Generating key-session request for "'+u+'" init data type'),e.mediaKeysSessionInitialized=!0,f.generateRequest(u,t).then(function(){D.logger.debug("Key-session generation succeeded")}).catch(function(s){D.logger.error("Error generating key-session request:",s),r.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!1})})},E._createLicenseXhr=function(u,t,r){var e=new XMLHttpRequest;e.responseType="arraybuffer",e.onreadystatechange=this._onLicenseRequestReadyStageChange.bind(this,e,u,t,r);var f=this._licenseXhrSetup;if(f)try{f.call(this.hls,e,u),f=void 0}catch(s){D.logger.error(s)}try{e.readyState||e.open("POST",u,!0),f&&f.call(this.hls,e,u)}catch(s){throw new Error("issue setting up KeySystem license XHR "+s)}return e},E._onLicenseRequestReadyStageChange=function(u,t,r,e){switch(u.readyState){case 4:if(u.status===200){this._requestLicenseFailureCount=0,D.logger.log("License request succeeded");var f=u.response,s=this._licenseResponseCallback;if(s)try{f=s.call(this.hls,u,t)}catch(h){D.logger.error(h)}e(f)}else{if(D.logger.error("License Request XHR failed ("+t+"). Status: "+u.status+" ("+u.statusText+")"),this._requestLicenseFailureCount++,this._requestLicenseFailureCount>L){this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0});return}var l=L-this._requestLicenseFailureCount+1;D.logger.warn("Retrying license request, "+l+" attempts left"),this._requestLicense(r,e)}break}},E._generateLicenseRequestChallenge=function(u,t){switch(u.mediaKeySystemDomain){case M.KeySystems.WIDEVINE:return t}throw new Error("unsupported key-system: "+u.mediaKeySystemDomain)},E._requestLicense=function(u,t){D.logger.log("Requesting content license for key-system");var r=this._mediaKeysList[0];if(!r){D.logger.error("Fatal error: Media is encrypted but no key-system access has been obtained yet"),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});return}try{var e=this.getLicenseServerUrl(r.mediaKeySystemDomain),f=this._createLicenseXhr(e,u,t);D.logger.log("Sending license request to URL: "+e);var s=this._generateLicenseRequestChallenge(r,u);f.send(s)}catch(l){D.logger.error("Failure requesting DRM license: "+l),this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0})}},E.onMediaAttached=function(u,t){if(!!this._emeEnabled){var r=t.media;this._media=r,r.addEventListener("encrypted",this._onMediaEncrypted)}},E.onMediaDetached=function(){var u=this._media,t=this._mediaKeysList;!u||(u.removeEventListener("encrypted",this._onMediaEncrypted),this._media=null,this._mediaKeysList=[],Promise.all(t.map(function(r){if(r.mediaKeysSession)return r.mediaKeysSession.close().catch(function(){})})).then(function(){return u.setMediaKeys(null)}).catch(function(){}))},E.onManifestParsed=function(u,t){if(!!this._emeEnabled){var r=t.levels.map(function(f){return f.audioCodec}).filter(function(f){return!!f}),e=t.levels.map(function(f){return f.videoCodec}).filter(function(f){return!!f});this._attemptKeySystemAccess(M.KeySystems.WIDEVINE,r,e)}},R(p,[{key:"requestMediaKeySystemAccess",get:function(){if(!this._requestMediaKeySystemAccess)throw new Error("No requestMediaKeySystemAccess function configured");return this._requestMediaKeySystemAccess}}]),p}();b.default=S},"./src/controller/fps-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/events.ts"),A=T("./src/utils/logger.ts"),D=function(){function M(R){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=R,this.registerListeners()}var P=M.prototype;return P.setStreamController=function(L){this.streamController=L},P.registerListeners=function(){this.hls.on(C.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},P.unregisterListeners=function(){this.hls.off(C.Events.MEDIA_ATTACHING,this.onMediaAttaching)},P.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},P.onMediaAttaching=function(L,g){var y=this.hls.config;if(y.capLevelOnFPSDrop){var S=g.media instanceof self.HTMLVideoElement?g.media:null;this.media=S,S&&typeof S.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),y.fpsDroppedMonitoringPeriod)}},P.checkFPS=function(L,g,y){var S=performance.now();if(g){if(this.lastTime){var p=S-this.lastTime,E=y-this.lastDroppedFrames,m=g-this.lastDecodedFrames,u=1e3*E/p,t=this.hls;if(t.trigger(C.Events.FPS_DROP,{currentDropped:E,currentDecoded:m,totalDroppedFrames:y}),u>0&&E>t.config.fpsDroppedMonitoringThreshold*m){var r=t.currentLevel;A.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+r),r>0&&(t.autoLevelCapping===-1||t.autoLevelCapping>=r)&&(r=r-1,t.trigger(C.Events.FPS_DROP_LEVEL_CAPPING,{level:r,droppedLevel:t.currentLevel}),t.autoLevelCapping=r,this.streamController.nextLevelSwitch())}}this.lastTime=S,this.lastDroppedFrames=y,this.lastDecodedFrames=g}},P.checkFPSInterval=function(){var L=this.media;if(L)if(this.isVideoPlaybackQualityAvailable){var g=L.getVideoPlaybackQuality();this.checkFPS(L,g.totalVideoFrames,g.droppedVideoFrames)}else this.checkFPS(L,L.webkitDecodedFrameCount,L.webkitDroppedFrameCount)},M}();b.default=D},"./src/controller/fragment-finders.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"findFragmentByPDT",function(){return D}),T.d(b,"findFragmentByPTS",function(){return M}),T.d(b,"fragmentWithinToleranceTest",function(){return P}),T.d(b,"pdtWithinToleranceTest",function(){return R}),T.d(b,"findFragWithCC",function(){return L});var C=T("./src/polyfills/number.ts"),A=T("./src/utils/binary-search.ts");function D(g,y,S){if(y===null||!Array.isArray(g)||!g.length||!Object(C.isFiniteNumber)(y))return null;var p=g[0].programDateTime;if(y<(p||0))return null;var E=g[g.length-1].endProgramDateTime;if(y>=(E||0))return null;S=S||0;for(var m=0;m<g.length;++m){var u=g[m];if(R(y,S,u))return u}return null}function M(g,y,S,p){S===void 0&&(S=0),p===void 0&&(p=0);var E=null;if(g?E=y[g.sn-y[0].sn+1]||null:S===0&&y[0].start===0&&(E=y[0]),E&&P(S,p,E)===0)return E;var m=A.default.search(y,P.bind(null,S,p));return m||E}function P(g,y,S){g===void 0&&(g=0),y===void 0&&(y=0);var p=Math.min(y,S.duration+(S.deltaPTS?S.deltaPTS:0));return S.start+S.duration-p<=g?1:S.start-p>g&&S.start?-1:0}function R(g,y,S){var p=Math.min(y,S.duration+(S.deltaPTS?S.deltaPTS:0))*1e3,E=S.endProgramDateTime||0;return E-p>g}function L(g,y){return A.default.search(g,function(S){return S.cc<y?1:S.cc>y?-1:0})}},"./src/controller/fragment-tracker.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"FragmentState",function(){return D}),T.d(b,"FragmentTracker",function(){return M});var C=T("./src/events.ts"),A=T("./src/types/loader.ts"),D;(function(L){L.NOT_LOADED="NOT_LOADED",L.BACKTRACKED="BACKTRACKED",L.APPENDING="APPENDING",L.PARTIAL="PARTIAL",L.OK="OK"})(D||(D={}));var M=function(){function L(y){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=y,this._registerListeners()}var g=L.prototype;return g._registerListeners=function(){var S=this.hls;S.on(C.Events.BUFFER_APPENDED,this.onBufferAppended,this),S.on(C.Events.FRAG_BUFFERED,this.onFragBuffered,this),S.on(C.Events.FRAG_LOADED,this.onFragLoaded,this)},g._unregisterListeners=function(){var S=this.hls;S.off(C.Events.BUFFER_APPENDED,this.onBufferAppended,this),S.off(C.Events.FRAG_BUFFERED,this.onFragBuffered,this),S.off(C.Events.FRAG_LOADED,this.onFragLoaded,this)},g.destroy=function(){this._unregisterListeners(),this.fragments=this.timeRanges=null},g.getAppendedFrag=function(S,p){if(p===A.PlaylistLevelType.MAIN){var E=this.activeFragment,m=this.activeParts;if(!E)return null;if(m)for(var u=m.length;u--;){var t=m[u],r=t?t.end:E.appendedPTS;if(t.start<=S&&r!==void 0&&S<=r)return u>9&&(this.activeParts=m.slice(u-9)),t}else if(E.start<=S&&E.appendedPTS!==void 0&&S<=E.appendedPTS)return E}return this.getBufferedFrag(S,p)},g.getBufferedFrag=function(S,p){for(var E=this.fragments,m=Object.keys(E),u=m.length;u--;){var t=E[m[u]];if((t==null?void 0:t.body.type)===p&&t.buffered){var r=t.body;if(r.start<=S&&S<=r.end)return r}}return null},g.detectEvictedFragments=function(S,p,E){var m=this;Object.keys(this.fragments).forEach(function(u){var t=m.fragments[u];if(!!t){if(!t.buffered){t.body.type===E&&m.removeFragment(t.body);return}var r=t.range[S];!r||r.time.some(function(e){var f=!m.isTimeBuffered(e.startPTS,e.endPTS,p);return f&&m.removeFragment(t.body),f})}})},g.detectPartialFragments=function(S){var p=this,E=this.timeRanges,m=S.frag,u=S.part;if(!(!E||m.sn==="initSegment")){var t=R(m),r=this.fragments[t];!r||(Object.keys(E).forEach(function(e){var f=m.elementaryStreams[e];if(!!f){var s=E[e],l=u!==null||f.partial===!0;r.range[e]=p.getBufferedTimes(m,u,l,s)}}),r.backtrack=r.loaded=null,Object.keys(r.range).length?r.buffered=!0:this.removeFragment(r.body))}},g.fragBuffered=function(S){var p=R(S),E=this.fragments[p];E&&(E.backtrack=E.loaded=null,E.buffered=!0)},g.getBufferedTimes=function(S,p,E,m){for(var u={time:[],partial:E},t=p?p.start:S.start,r=p?p.end:S.end,e=S.minEndPTS||r,f=S.maxStartPTS||t,s=0;s<m.length;s++){var l=m.start(s)-this.bufferPadding,h=m.end(s)+this.bufferPadding;if(f>=l&&e<=h){u.time.push({startPTS:Math.max(t,m.start(s)),endPTS:Math.min(r,m.end(s))});break}else if(t<h&&r>l)u.partial=!0,u.time.push({startPTS:Math.max(t,m.start(s)),endPTS:Math.min(r,m.end(s))});else if(r<=l)break}return u},g.getPartialFragment=function(S){var p=null,E,m,u,t=0,r=this.bufferPadding,e=this.fragments;return Object.keys(e).forEach(function(f){var s=e[f];!s||P(s)&&(m=s.body.start-r,u=s.body.end+r,S>=m&&S<=u&&(E=Math.min(S-m,u-S),t<=E&&(p=s.body,t=E)))}),p},g.getState=function(S){var p=R(S),E=this.fragments[p];return E?E.buffered?P(E)?D.PARTIAL:D.OK:E.backtrack?D.BACKTRACKED:D.APPENDING:D.NOT_LOADED},g.backtrack=function(S,p){var E=R(S),m=this.fragments[E];if(!m||m.backtrack)return null;var u=m.backtrack=p||m.loaded;return m.loaded=null,u},g.getBacktrackData=function(S){var p=R(S),E=this.fragments[p];if(E){var m,u=E.backtrack;if(u!=null&&(m=u.payload)!==null&&m!==void 0&&m.byteLength)return u;this.removeFragment(S)}return null},g.isTimeBuffered=function(S,p,E){for(var m,u,t=0;t<E.length;t++){if(m=E.start(t)-this.bufferPadding,u=E.end(t)+this.bufferPadding,S>=m&&p<=u)return!0;if(p<=m)return!1}return!1},g.onFragLoaded=function(S,p){var E=p.frag,m=p.part;if(!(E.sn==="initSegment"||E.bitrateTest||m)){var u=R(E);this.fragments[u]={body:E,loaded:p,backtrack:null,buffered:!1,range:Object.create(null)}}},g.onBufferAppended=function(S,p){var E=this,m=p.frag,u=p.part,t=p.timeRanges;if(m.type===A.PlaylistLevelType.MAIN)if(this.activeFragment=m,u){var r=this.activeParts;r||(this.activeParts=r=[]),r.push(u)}else this.activeParts=null;this.timeRanges=t,Object.keys(t).forEach(function(e){var f=t[e];if(E.detectEvictedFragments(e,f),!u)for(var s=0;s<f.length;s++)m.appendedPTS=Math.max(f.end(s),m.appendedPTS||0)})},g.onFragBuffered=function(S,p){this.detectPartialFragments(p)},g.hasFragment=function(S){var p=R(S);return!!this.fragments[p]},g.removeFragmentsInRange=function(S,p,E){var m=this;Object.keys(this.fragments).forEach(function(u){var t=m.fragments[u];if(!!t&&t.buffered){var r=t.body;r.type===E&&r.start<p&&r.end>S&&m.removeFragment(r)}})},g.removeFragment=function(S){var p=R(S);S.stats.loaded=0,S.clearElementaryStreamInfo(),delete this.fragments[p]},g.removeAllFragments=function(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null},L}();function P(L){var g,y;return L.buffered&&(((g=L.range.video)===null||g===void 0?void 0:g.partial)||((y=L.range.audio)===null||y===void 0?void 0:y.partial))}function R(L){return L.type+"_"+L.level+"_"+L.urlId+"_"+L.sn}},"./src/controller/gap-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"STALL_MINIMUM_DURATION_MS",function(){return P}),T.d(b,"MAX_START_GAP_JUMP",function(){return R}),T.d(b,"SKIP_BUFFER_HOLE_STEP_SECONDS",function(){return L}),T.d(b,"SKIP_BUFFER_RANGE_START",function(){return g}),T.d(b,"default",function(){return y});var C=T("./src/utils/buffer-helper.ts"),A=T("./src/errors.ts"),D=T("./src/events.ts"),M=T("./src/utils/logger.ts"),P=250,R=2,L=.1,g=.05,y=function(){function S(E,m,u,t){this.config=void 0,this.media=void 0,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=E,this.media=m,this.fragmentTracker=u,this.hls=t}var p=S.prototype;return p.destroy=function(){this.hls=this.fragmentTracker=this.media=null},p.poll=function(m){var u=this.config,t=this.media,r=this.stalled,e=t.currentTime,f=t.seeking,s=this.seeking&&!f,l=!this.seeking&&f;if(this.seeking=f,e!==m){if(this.moved=!0,r!==null){if(this.stallReported){var h=self.performance.now()-r;M.logger.warn("playback not stuck anymore @"+e+", after "+Math.round(h)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((l||s)&&(this.stalled=null),!(t.paused||t.ended||t.playbackRate===0||!C.BufferHelper.getBuffered(t).length)){var d=C.BufferHelper.bufferInfo(t,e,0),o=d.len>0,a=d.nextStart||0;if(!(!o&&!a)){if(f){var i=d.len>R,n=!a||a-e>R&&!this.fragmentTracker.getPartialFragment(e);if(i||n)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var v,c=Math.max(a,d.start||0)-e,x=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,O=x==null||(v=x.details)===null||v===void 0?void 0:v.live,I=O?x.details.targetduration*2:R;if(c>0&&c<=I){this._trySkipBufferHole(null);return}}var F=self.performance.now();if(r===null){this.stalled=F;return}var B=F-r;!f&&B>=P&&this._reportStall(d.len);var U=C.BufferHelper.bufferInfo(t,e,u.maxBufferHole);this._tryFixBufferStall(U,B)}}},p._tryFixBufferStall=function(m,u){var t=this.config,r=this.fragmentTracker,e=this.media,f=e.currentTime,s=r.getPartialFragment(f);if(s){var l=this._trySkipBufferHole(s);if(l)return}m.len>t.maxBufferHole&&u>t.highBufferWatchdogPeriod*1e3&&(M.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())},p._reportStall=function(m){var u=this.hls,t=this.media,r=this.stallReported;r||(this.stallReported=!0,M.logger.warn("Playback stalling at @"+t.currentTime+" due to low buffer (buffer="+m+")"),u.trigger(D.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:m}))},p._trySkipBufferHole=function(m){for(var u=this.config,t=this.hls,r=this.media,e=r.currentTime,f=0,s=C.BufferHelper.getBuffered(r),l=0;l<s.length;l++){var h=s.start(l);if(e+u.maxBufferHole>=f&&e<h){var d=Math.max(h+g,r.currentTime+L);return M.logger.warn("skipping hole, adjusting currentTime from "+e+" to "+d),this.moved=!0,this.stalled=null,r.currentTime=d,m&&t.trigger(D.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+e+" to "+d,frag:m}),d}f=s.end(l)}return 0},p._tryNudgeBuffer=function(){var m=this.config,u=this.hls,t=this.media,r=t.currentTime,e=(this.nudgeRetry||0)+1;if(this.nudgeRetry=e,e<m.nudgeMaxRetry){var f=r+e*m.nudgeOffset;M.logger.warn("Nudging 'currentTime' from "+r+" to "+f),t.currentTime=f,u.trigger(D.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else M.logger.error("Playhead still not moving while enough data buffered @"+r+" after "+m.nudgeMaxRetry+" nudges"),u.trigger(D.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})},S}()},"./src/controller/id3-track-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/events.ts"),A=T("./src/utils/texttrack-utils.ts"),D=T("./src/demux/id3.ts"),M=.25,P=function(){function R(g){this.hls=void 0,this.id3Track=null,this.media=null,this.hls=g,this._registerListeners()}var L=R.prototype;return L.destroy=function(){this._unregisterListeners()},L._registerListeners=function(){var y=this.hls;y.on(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),y.on(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this),y.on(C.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),y.on(C.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},L._unregisterListeners=function(){var y=this.hls;y.off(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),y.off(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this),y.off(C.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),y.off(C.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},L.onMediaAttached=function(y,S){this.media=S.media},L.onMediaDetaching=function(){!this.id3Track||(Object(A.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null)},L.getID3Track=function(y){if(!!this.media){for(var S=0;S<y.length;S++){var p=y[S];if(p.kind==="metadata"&&p.label==="id3")return Object(A.sendAddTrackEvent)(p,this.media),p}return this.media.addTextTrack("metadata","id3")}},L.onFragParsingMetadata=function(y,S){if(!!this.media){var p=S.frag,E=S.samples;this.id3Track||(this.id3Track=this.getID3Track(this.media.textTracks),this.id3Track.mode="hidden");for(var m=self.WebKitDataCue||self.VTTCue||self.TextTrackCue,u=0;u<E.length;u++){var t=D.getID3Frames(E[u].data);if(t){var r=E[u].pts,e=u<E.length-1?E[u+1].pts:p.end,f=e-r;f<=0&&(e=r+M);for(var s=0;s<t.length;s++){var l=t[s];if(!D.isTimeStampFrame(l)){var h=new m(r,e,"");h.value=l,this.id3Track.addCue(h)}}}}}},L.onBufferFlushing=function(y,S){var p=S.startOffset,E=S.endOffset,m=S.type;if(!m||m==="audio"){var u=this.id3Track;u&&Object(A.removeCuesInRange)(u,p,E)}},R}();b.default=P},"./src/controller/latency-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return R});var C=T("./src/errors.ts"),A=T("./src/events.ts"),D=T("./src/utils/logger.ts");function M(L,g){for(var y=0;y<g.length;y++){var S=g[y];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(L,S.key,S)}}function P(L,g,y){return g&&M(L.prototype,g),y&&M(L,y),L}var R=function(){function L(y){var S=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return S.timeupdate()},this.hls=y,this.config=y.config,this.registerListeners()}var g=L.prototype;return g.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},g.registerListeners=function(){this.hls.on(A.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(A.Events.ERROR,this.onError,this)},g.unregisterListeners=function(){this.hls.off(A.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(A.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(A.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(A.Events.ERROR,this.onError)},g.onMediaAttached=function(S,p){this.media=p.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},g.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},g.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},g.onLevelUpdated=function(S,p){var E=p.details;this.levelDetails=E,E.advanced&&this.timeupdate(),!E.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},g.onError=function(S,p){p.details===C.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,D.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},g.timeupdate=function(){var S=this.media,p=this.levelDetails;if(!(!S||!p)){this.currentTime=S.currentTime;var E=this.computeLatency();if(E!==null){this._latency=E;var m=this.config,u=m.lowLatencyMode,t=m.maxLiveSyncPlaybackRate;if(!(!u||t===1)){var r=this.targetLatency;if(r!==null){var e=E-r,f=Math.min(this.maxLatency,r+p.targetduration),s=e<f;if(p.live&&s&&e>.05&&this.forwardBufferLength>1){var l=Math.min(2,Math.max(1,t)),h=Math.round(2/(1+Math.exp(-.75*e-this.edgeStalled))*20)/20;S.playbackRate=Math.min(l,Math.max(1,h))}else S.playbackRate!==1&&S.playbackRate!==0&&(S.playbackRate=1)}}}}},g.estimateLiveEdge=function(){var S=this.levelDetails;return S===null?null:S.edge+S.age},g.computeLatency=function(){var S=this.estimateLiveEdge();return S===null?null:S-this.currentTime},P(L,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var S=this.config,p=this.levelDetails;return S.liveMaxLatencyDuration!==void 0?S.liveMaxLatencyDuration:p?S.liveMaxLatencyDurationCount*p.targetduration:0}},{key:"targetLatency",get:function(){var S=this.levelDetails;if(S===null)return null;var p=S.holdBack,E=S.partHoldBack,m=S.targetduration,u=this.config,t=u.liveSyncDuration,r=u.liveSyncDurationCount,e=u.lowLatencyMode,f=this.hls.userConfig,s=e&&E||p;(f.liveSyncDuration||f.liveSyncDurationCount||s===0)&&(s=t!==void 0?t:r*m);var l=m,h=1;return s+Math.min(this.stallCount*h,l)}},{key:"liveSyncPosition",get:function(){var S=this.estimateLiveEdge(),p=this.targetLatency,E=this.levelDetails;if(S===null||p===null||E===null)return null;var m=E.edge,u=S-p-this.edgeStalled,t=m-E.totalduration,r=m-(this.config.lowLatencyMode&&E.partTarget||E.targetduration);return Math.min(Math.max(t,u),r)}},{key:"drift",get:function(){var S=this.levelDetails;return S===null?1:S.drift}},{key:"edgeStalled",get:function(){var S=this.levelDetails;if(S===null)return 0;var p=(this.config.lowLatencyMode&&S.partTarget||S.targetduration)*3;return Math.max(S.age-p,0)}},{key:"forwardBufferLength",get:function(){var S=this.media,p=this.levelDetails;if(!S||!p)return 0;var E=S.buffered.length;return E?S.buffered.end(E-1):p.edge-this.currentTime}}]),L}()},"./src/controller/level-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return u});var C=T("./src/types/level.ts"),A=T("./src/events.ts"),D=T("./src/errors.ts"),M=T("./src/utils/codecs.ts"),P=T("./src/controller/level-helper.ts"),R=T("./src/controller/base-playlist-controller.ts"),L=T("./src/types/loader.ts");function g(){return g=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(t[f]=e[f])}return t},g.apply(this,arguments)}function y(t,r){for(var e=0;e<r.length;e++){var f=r[e];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(t,f.key,f)}}function S(t,r,e){return r&&y(t.prototype,r),e&&y(t,e),t}function p(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,E(t,r)}function E(t,r){return E=Object.setPrototypeOf||function(f,s){return f.__proto__=s,f},E(t,r)}var m=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),u=function(t){p(r,t);function r(f){var s;return s=t.call(this,f,"[level-controller]")||this,s._levels=[],s._firstLevel=-1,s._startLevel=void 0,s.currentLevelIndex=-1,s.manualLevelIndex=-1,s.onParsedComplete=void 0,s._registerListeners(),s}var e=r.prototype;return e._registerListeners=function(){var s=this.hls;s.on(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),s.on(A.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.on(A.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),s.on(A.Events.FRAG_LOADED,this.onFragLoaded,this),s.on(A.Events.ERROR,this.onError,this)},e._unregisterListeners=function(){var s=this.hls;s.off(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),s.off(A.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.off(A.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),s.off(A.Events.FRAG_LOADED,this.onFragLoaded,this),s.off(A.Events.ERROR,this.onError,this)},e.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,t.prototype.destroy.call(this)},e.startLoad=function(){var s=this._levels;s.forEach(function(l){l.loadError=0}),t.prototype.startLoad.call(this)},e.onManifestLoaded=function(s,l){var h=[],d=[],o=[],a,i={},n,v=!1,c=!1,x=!1;if(l.levels.forEach(function(B){var U=B.attrs;v=v||!!(B.width&&B.height),c=c||!!B.videoCodec,x=x||!!B.audioCodec,m&&B.audioCodec&&B.audioCodec.indexOf("mp4a.40.34")!==-1&&(B.audioCodec=void 0);var k=B.bitrate+"-"+B.attrs.RESOLUTION+"-"+B.attrs.CODECS;n=i[k],n?n.url.push(B.url):(n=new C.Level(B),i[k]=n,h.push(n)),U&&(U.AUDIO&&Object(P.addGroupId)(n,"audio",U.AUDIO),U.SUBTITLES&&Object(P.addGroupId)(n,"text",U.SUBTITLES))}),(v||c)&&x&&(h=h.filter(function(B){var U=B.videoCodec,k=B.width,N=B.height;return!!U||!!(k&&N)})),h=h.filter(function(B){var U=B.audioCodec,k=B.videoCodec;return(!U||Object(M.isCodecSupportedInMp4)(U,"audio"))&&(!k||Object(M.isCodecSupportedInMp4)(k,"video"))}),l.audioTracks&&(d=l.audioTracks.filter(function(B){return!B.audioCodec||Object(M.isCodecSupportedInMp4)(B.audioCodec,"audio")}),Object(P.assignTrackIdsByGroup)(d)),l.subtitles&&(o=l.subtitles,Object(P.assignTrackIdsByGroup)(o)),h.length>0){a=h[0].bitrate,h.sort(function(B,U){return B.bitrate-U.bitrate}),this._levels=h;for(var O=0;O<h.length;O++)if(h[O].bitrate===a){this._firstLevel=O,this.log("manifest loaded, "+h.length+" level(s) found, first bitrate: "+a);break}var I=x&&!c,F={levels:h,audioTracks:d,subtitleTracks:o,firstLevel:this._firstLevel,stats:l.stats,audio:x,video:c,altAudio:!I&&d.some(function(B){return!!B.url})};this.hls.trigger(A.Events.MANIFEST_PARSED,F),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(A.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:l.url,reason:"no level with compatible codecs found in manifest"})},e.onError=function(s,l){if(t.prototype.onError.call(this,s,l),!l.fatal){var h=l.context,d=this._levels[this.currentLevelIndex];if(h&&(h.type===L.PlaylistContextType.AUDIO_TRACK&&d.audioGroupIds&&h.groupId===d.audioGroupIds[d.urlId]||h.type===L.PlaylistContextType.SUBTITLE_TRACK&&d.textGroupIds&&h.groupId===d.textGroupIds[d.urlId])){this.redundantFailover(this.currentLevelIndex);return}var o=!1,a=!0,i;switch(l.details){case D.ErrorDetails.FRAG_LOAD_ERROR:case D.ErrorDetails.FRAG_LOAD_TIMEOUT:case D.ErrorDetails.KEY_LOAD_ERROR:case D.ErrorDetails.KEY_LOAD_TIMEOUT:if(l.frag){var n=this._levels[l.frag.level];n?(n.fragmentError++,n.fragmentError>this.hls.config.fragLoadingMaxRetry&&(i=l.frag.level)):i=l.frag.level}break;case D.ErrorDetails.LEVEL_LOAD_ERROR:case D.ErrorDetails.LEVEL_LOAD_TIMEOUT:h&&(h.deliveryDirectives&&(a=!1),i=h.level),o=!0;break;case D.ErrorDetails.REMUX_ALLOC_ERROR:i=l.level,o=!0;break}i!==void 0&&this.recoverLevel(l,i,o,a)}},e.recoverLevel=function(s,l,h,d){var o=s.details,a=this._levels[l];if(a.loadError++,h){var i=this.retryLoadingOrFail(s);if(i)s.levelRetry=!0;else{this.currentLevelIndex=-1;return}}if(d){var n=a.url.length;if(n>1&&a.loadError<n)s.levelRetry=!0,this.redundantFailover(l);else if(this.manualLevelIndex===-1){var v=l===0?this._levels.length-1:l-1;this.currentLevelIndex!==v&&this._levels[v].loadError===0&&(this.warn(o+": switch to "+v),s.levelRetry=!0,this.hls.nextAutoLevel=v)}}},e.redundantFailover=function(s){var l=this._levels[s],h=l.url.length;if(h>1){var d=(l.urlId+1)%h;this.warn("Switching to redundant URL-id "+d),this._levels.forEach(function(o){o.urlId=d}),this.level=s}},e.onFragLoaded=function(s,l){var h=l.frag;if(h!==void 0&&h.type===L.PlaylistLevelType.MAIN){var d=this._levels[h.level];d!==void 0&&(d.fragmentError=0,d.loadError=0)}},e.onLevelLoaded=function(s,l){var h,d=l.level,o=l.details,a=this._levels[d];if(!a){var i;this.warn("Invalid level index "+d),(i=l.deliveryDirectives)!==null&&i!==void 0&&i.skip&&(o.deltaUpdateFailed=!0);return}d===this.currentLevelIndex?(a.fragmentError===0&&(a.loadError=0,this.retryCount=0),this.playlistLoaded(d,l,a.details)):(h=l.deliveryDirectives)!==null&&h!==void 0&&h.skip&&(o.deltaUpdateFailed=!0)},e.onAudioTrackSwitched=function(s,l){var h=this.hls.levels[this.currentLevelIndex];if(!!h&&h.audioGroupIds){for(var d=-1,o=this.hls.audioTracks[l.id].groupId,a=0;a<h.audioGroupIds.length;a++)if(h.audioGroupIds[a]===o){d=a;break}d!==h.urlId&&(h.urlId=d,this.startLoad())}},e.loadPlaylist=function(s){var l=this.currentLevelIndex,h=this._levels[l];if(this.canLoad&&h&&h.url.length>0){var d=h.urlId,o=h.url[d];if(s)try{o=s.addDirectives(o)}catch(a){this.warn("Could not construct new URL with HLS Delivery Directives: "+a)}this.log("Attempt loading level index "+l+(s?" at sn "+s.msn+" part "+s.part:"")+" with URL-id "+d+" "+o),this.clearTimer(),this.hls.trigger(A.Events.LEVEL_LOADING,{url:o,level:l,id:d,deliveryDirectives:s||null})}},e.removeLevel=function(s,l){var h=function(a,i){return i!==l},d=this._levels.filter(function(o,a){return a!==s?!0:o.url.length>1&&l!==void 0?(o.url=o.url.filter(h),o.audioGroupIds&&(o.audioGroupIds=o.audioGroupIds.filter(h)),o.textGroupIds&&(o.textGroupIds=o.textGroupIds.filter(h)),o.urlId=0,!0):!1}).map(function(o,a){var i=o.details;return i!=null&&i.fragments&&i.fragments.forEach(function(n){n.level=a}),o});this._levels=d,this.hls.trigger(A.Events.LEVELS_UPDATED,{levels:d})},S(r,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(s){var l,h=this._levels;if(h.length!==0&&!(this.currentLevelIndex===s&&(l=h[s])!==null&&l!==void 0&&l.details)){if(s<0||s>=h.length){var d=s<0;if(this.hls.trigger(A.Events.ERROR,{type:D.ErrorTypes.OTHER_ERROR,details:D.ErrorDetails.LEVEL_SWITCH_ERROR,level:s,fatal:d,reason:"invalid level idx"}),d)return;s=Math.min(s,h.length-1)}this.clearTimer();var o=this.currentLevelIndex,a=h[o],i=h[s];this.log("switching to level "+s+" from "+o),this.currentLevelIndex=s;var n=g({},i,{level:s,maxBitrate:i.maxBitrate,uri:i.uri,urlId:i.urlId});delete n._urlId,this.hls.trigger(A.Events.LEVEL_SWITCHING,n);var v=i.details;if(!v||v.live){var c=this.switchParams(i.uri,a==null?void 0:a.details);this.loadPlaylist(c)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(s){this.manualLevelIndex=s,this._startLevel===void 0&&(this._startLevel=s),s!==-1&&(this.level=s)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(s){this._firstLevel=s}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var s=this.hls.config.startLevel;return s!==void 0?s:this._firstLevel}else return this._startLevel},set:function(s){this._startLevel=s}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(s){this.level=s,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=s)}}]),r}(R.default)},"./src/controller/level-helper.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"addGroupId",function(){return D}),T.d(b,"assignTrackIdsByGroup",function(){return M}),T.d(b,"updatePTS",function(){return P}),T.d(b,"updateFragPTSDTS",function(){return L}),T.d(b,"mergeDetails",function(){return g}),T.d(b,"mapPartIntersection",function(){return y}),T.d(b,"mapFragmentIntersection",function(){return S}),T.d(b,"adjustSliding",function(){return p}),T.d(b,"addSliding",function(){return E}),T.d(b,"computeReloadInterval",function(){return m}),T.d(b,"getFragmentWithSN",function(){return u}),T.d(b,"getPartWith",function(){return t});var C=T("./src/polyfills/number.ts"),A=T("./src/utils/logger.ts");function D(r,e,f){switch(e){case"audio":r.audioGroupIds||(r.audioGroupIds=[]),r.audioGroupIds.push(f);break;case"text":r.textGroupIds||(r.textGroupIds=[]),r.textGroupIds.push(f);break}}function M(r){var e={};r.forEach(function(f){var s=f.groupId||"";f.id=e[s]=e[s]||0,e[s]++})}function P(r,e,f){var s=r[e],l=r[f];R(s,l)}function R(r,e){var f=e.startPTS;if(Object(C.isFiniteNumber)(f)){var s=0,l;e.sn>r.sn?(s=f-r.start,l=r):(s=r.start-f,l=e),l.duration!==s&&(l.duration=s)}else if(e.sn>r.sn){var h=r.cc===e.cc;h&&r.minEndPTS?e.start=r.start+(r.minEndPTS-r.start):e.start=r.start+r.duration}else e.start=Math.max(r.start-e.duration,0)}function L(r,e,f,s,l,h){var d=s-f;d<=0&&(A.logger.warn("Fragment should have a positive duration",e),s=f+e.duration,h=l+e.duration);var o=f,a=s,i=e.startPTS,n=e.endPTS;if(Object(C.isFiniteNumber)(i)){var v=Math.abs(i-f);Object(C.isFiniteNumber)(e.deltaPTS)?e.deltaPTS=Math.max(v,e.deltaPTS):e.deltaPTS=v,o=Math.max(f,i),f=Math.min(f,i),l=Math.min(l,e.startDTS),a=Math.min(s,n),s=Math.max(s,n),h=Math.max(h,e.endDTS)}e.duration=s-f;var c=f-e.start;e.appendedPTS=s,e.start=e.startPTS=f,e.maxStartPTS=o,e.startDTS=l,e.endPTS=s,e.minEndPTS=a,e.endDTS=h;var x=e.sn;if(!r||x<r.startSN||x>r.endSN)return 0;var O,I=x-r.startSN,F=r.fragments;for(F[I]=e,O=I;O>0;O--)R(F[O],F[O-1]);for(O=I;O<F.length-1;O++)R(F[O],F[O+1]);return r.fragmentHint&&R(F[F.length-1],r.fragmentHint),r.PTSKnown=r.alignedSliding=!0,c}function g(r,e){for(var f=null,s=r.fragments,l=s.length-1;l>=0;l--){var h=s[l].initSegment;if(h){f=h;break}}r.fragmentHint&&delete r.fragmentHint.endPTS;var d=0,o;if(S(r,e,function(O,I){O.relurl&&(d=O.cc-I.cc),Object(C.isFiniteNumber)(O.startPTS)&&Object(C.isFiniteNumber)(O.endPTS)&&(I.start=I.startPTS=O.startPTS,I.startDTS=O.startDTS,I.appendedPTS=O.appendedPTS,I.maxStartPTS=O.maxStartPTS,I.endPTS=O.endPTS,I.endDTS=O.endDTS,I.minEndPTS=O.minEndPTS,I.duration=O.endPTS-O.startPTS,I.duration&&(o=I),e.PTSKnown=e.alignedSliding=!0),I.elementaryStreams=O.elementaryStreams,I.loader=O.loader,I.stats=O.stats,I.urlId=O.urlId,O.initSegment&&(I.initSegment=O.initSegment,f=O.initSegment)}),f){var a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;a.forEach(function(O){var I;(!O.initSegment||O.initSegment.relurl===((I=f)===null||I===void 0?void 0:I.relurl))&&(O.initSegment=f)})}if(e.skippedSegments&&(e.deltaUpdateFailed=e.fragments.some(function(O){return!O}),e.deltaUpdateFailed)){A.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var i=e.skippedSegments;i--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}var n=e.fragments;if(d){A.logger.warn("discontinuity sliding from playlist, take drift into account");for(var v=0;v<n.length;v++)n[v].cc+=d}e.skippedSegments&&(e.startCC=e.fragments[0].cc),y(r.partList,e.partList,function(O,I){I.elementaryStreams=O.elementaryStreams,I.stats=O.stats}),o?L(e,o,o.startPTS,o.endPTS,o.startDTS,o.endDTS):p(r,e),n.length&&(e.totalduration=e.edge-n[0].start),e.driftStartTime=r.driftStartTime,e.driftStart=r.driftStart;var c=e.advancedDateTime;if(e.advanced&&c){var x=e.edge;e.driftStart||(e.driftStartTime=c,e.driftStart=x),e.driftEndTime=c,e.driftEnd=x}else e.driftEndTime=r.driftEndTime,e.driftEnd=r.driftEnd,e.advancedDateTime=r.advancedDateTime}function y(r,e,f){if(r&&e)for(var s=0,l=0,h=r.length;l<=h;l++){var d=r[l],o=e[l+s];d&&o&&d.index===o.index&&d.fragment.sn===o.fragment.sn?f(d,o):s--}}function S(r,e,f){for(var s=e.skippedSegments,l=Math.max(r.startSN,e.startSN)-e.startSN,h=(r.fragmentHint?1:0)+(s?e.endSN:Math.min(r.endSN,e.endSN))-e.startSN,d=e.startSN-r.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,a=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments,i=l;i<=h;i++){var n=a[d+i],v=o[i];s&&!v&&i<s&&(v=e.fragments[i]=n),n&&v&&f(n,v)}}function p(r,e){var f=e.startSN+e.skippedSegments-r.startSN,s=r.fragments;f<0||f>=s.length||E(e,s[f].start)}function E(r,e){if(e){for(var f=r.fragments,s=r.skippedSegments;s<f.length;s++)f[s].start+=e;r.fragmentHint&&(r.fragmentHint.start+=e)}}function m(r,e){var f=1e3*r.levelTargetDuration,s=f/2,l=r.age,h=l>0&&l<f*3,d=e.loading.end-e.loading.start,o,a=r.availabilityDelay;if(r.updated===!1)if(h){var i=333*r.misses;o=Math.max(Math.min(s,d*2),i),r.availabilityDelay=(r.availabilityDelay||0)+o}else o=s;else h?(a=Math.min(a||f/2,l),r.availabilityDelay=a,o=a+f-l):o=f-d;return Math.round(o)}function u(r,e,f){if(!r||!r.details)return null;var s=r.details,l=s.fragments[e-s.startSN];return l||(l=s.fragmentHint,l&&l.sn===e)?l:e<s.startSN&&f&&f.sn===e?f:null}function t(r,e,f){if(!r||!r.details)return null;var s=r.details.partList;if(s)for(var l=s.length;l--;){var h=s[l];if(h.index===f&&h.fragment.sn===e)return h}return null}},"./src/controller/stream-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return s});var C=T("./src/polyfills/number.ts"),A=T("./src/controller/base-stream-controller.ts"),D=T("./src/is-supported.ts"),M=T("./src/events.ts"),P=T("./src/utils/buffer-helper.ts"),R=T("./src/controller/fragment-tracker.ts"),L=T("./src/types/loader.ts"),g=T("./src/loader/fragment.ts"),y=T("./src/demux/transmuxer-interface.ts"),S=T("./src/types/transmuxer.ts"),p=T("./src/controller/gap-controller.ts"),E=T("./src/errors.ts"),m=T("./src/utils/logger.ts");function u(l,h){for(var d=0;d<h.length;d++){var o=h[d];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(l,o.key,o)}}function t(l,h,d){return h&&u(l.prototype,h),d&&u(l,d),l}function r(l,h){l.prototype=Object.create(h.prototype),l.prototype.constructor=l,e(l,h)}function e(l,h){return e=Object.setPrototypeOf||function(o,a){return o.__proto__=a,o},e(l,h)}var f=100,s=function(l){r(h,l);function h(o,a){var i;return i=l.call(this,o,a,"[stream-controller]")||this,i.audioCodecSwap=!1,i.gapController=null,i.level=-1,i._forceStartLoad=!1,i.altAudio=!1,i.audioOnly=!1,i.fragPlaying=null,i.onvplaying=null,i.onvseeked=null,i.fragLastKbps=0,i.stalled=!1,i.couldBacktrack=!1,i.audioCodecSwitch=!1,i.videoBuffer=null,i._registerListeners(),i}var d=h.prototype;return d._registerListeners=function(){var a=this.hls;a.on(M.Events.MEDIA_ATTACHED,this.onMediaAttached,this),a.on(M.Events.MEDIA_DETACHING,this.onMediaDetaching,this),a.on(M.Events.MANIFEST_LOADING,this.onManifestLoading,this),a.on(M.Events.MANIFEST_PARSED,this.onManifestParsed,this),a.on(M.Events.LEVEL_LOADING,this.onLevelLoading,this),a.on(M.Events.LEVEL_LOADED,this.onLevelLoaded,this),a.on(M.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),a.on(M.Events.ERROR,this.onError,this),a.on(M.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),a.on(M.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),a.on(M.Events.BUFFER_CREATED,this.onBufferCreated,this),a.on(M.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),a.on(M.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),a.on(M.Events.FRAG_BUFFERED,this.onFragBuffered,this)},d._unregisterListeners=function(){var a=this.hls;a.off(M.Events.MEDIA_ATTACHED,this.onMediaAttached,this),a.off(M.Events.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(M.Events.MANIFEST_LOADING,this.onManifestLoading,this),a.off(M.Events.MANIFEST_PARSED,this.onManifestParsed,this),a.off(M.Events.LEVEL_LOADED,this.onLevelLoaded,this),a.off(M.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),a.off(M.Events.ERROR,this.onError,this),a.off(M.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),a.off(M.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),a.off(M.Events.BUFFER_CREATED,this.onBufferCreated,this),a.off(M.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),a.off(M.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),a.off(M.Events.FRAG_BUFFERED,this.onFragBuffered,this)},d.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},d.startLoad=function(a){if(this.levels){var i=this.lastCurrentTime,n=this.hls;if(this.stopLoad(),this.setInterval(f),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var v=n.startLevel;v===-1&&(n.config.testBandwidth?(v=0,this.bitrateTest=!0):v=n.nextAutoLevel),this.level=n.nextLoadLevel=v,this.loadedmetadata=!1}i>0&&a===-1&&(this.log("Override startPosition with lastCurrentTime @"+i.toFixed(3)),a=i),this.state=A.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=a,this.tick()}else this._forceStartLoad=!0,this.state=A.State.STOPPED},d.stopLoad=function(){this._forceStartLoad=!1,l.prototype.stopLoad.call(this)},d.doTick=function(){switch(this.state){case A.State.IDLE:this.doTickIdle();break;case A.State.WAITING_LEVEL:{var a,i=this.levels,n=this.level,v=i==null||(a=i[n])===null||a===void 0?void 0:a.details;if(v&&(!v.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(v))break;this.state=A.State.IDLE;break}break}case A.State.FRAG_LOADING_WAITING_RETRY:{var c,x=self.performance.now(),O=this.retryDate;(!O||x>=O||(c=this.media)!==null&&c!==void 0&&c.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.state=A.State.IDLE)}break;default:break}this.onTickEnd()},d.onTickEnd=function(){l.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},d.doTickIdle=function(){var a,i,n=this.hls,v=this.levelLastLoaded,c=this.levels,x=this.media,O=n.config,I=n.nextLoadLevel;if(!(v===null||!x&&(this.startFragRequested||!O.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)&&!(!c||!c[I])){var F=c[I];this.level=n.nextLoadLevel=I;var B=F.details;if(!B||this.state===A.State.WAITING_LEVEL||B.live&&this.levelLastLoaded!==I){this.state=A.State.WAITING_LEVEL;return}var U=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:x,L.PlaylistLevelType.MAIN);if(U!==null){var k=U.len,N=this.getMaxBufferLength(F.maxBitrate);if(!(k>=N)){if(this._streamEnded(U,B)){var K={};this.altAudio&&(K.type="video"),this.hls.trigger(M.Events.BUFFER_EOS,K),this.state=A.State.ENDED;return}var W=U.end,w=this.getNextFragment(W,B);if(this.couldBacktrack&&!this.fragPrevious&&w&&w.sn!=="initSegment"){var H=w.sn-B.startSN;H>1&&(w=B.fragments[H-1],this.fragmentTracker.removeFragment(w))}if(w&&this.fragmentTracker.getState(w)===R.FragmentState.OK&&this.nextLoadPosition>W){var V=this.audioOnly&&!this.altAudio?g.ElementaryStreamTypes.AUDIO:g.ElementaryStreamTypes.VIDEO;this.afterBufferFlushed(x,V,L.PlaylistLevelType.MAIN),w=this.getNextFragment(this.nextLoadPosition,B)}!w||(w.initSegment&&!w.initSegment.data&&!this.bitrateTest&&(w=w.initSegment),((a=w.decryptdata)===null||a===void 0?void 0:a.keyFormat)==="identity"&&!((i=w.decryptdata)!==null&&i!==void 0&&i.key)?this.loadKey(w,B):this.loadFragment(w,B,W))}}}},d.loadFragment=function(a,i,n){var v,c=this.fragmentTracker.getState(a);if(this.fragCurrent=a,c===R.FragmentState.BACKTRACKED){var x=this.fragmentTracker.getBacktrackData(a);if(x){this._handleFragmentLoadProgress(x),this._handleFragmentLoadComplete(x);return}else c=R.FragmentState.NOT_LOADED}c===R.FragmentState.NOT_LOADED||c===R.FragmentState.PARTIAL?a.sn==="initSegment"?this._loadInitSegment(a):this.bitrateTest?(a.bitrateTest=!0,this.log("Fragment "+a.sn+" of level "+a.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(a)):(this.startFragRequested=!0,l.prototype.loadFragment.call(this,a,i,n)):c===R.FragmentState.APPENDING?this.reduceMaxBufferLength(a.duration)&&this.fragmentTracker.removeFragment(a):((v=this.media)===null||v===void 0?void 0:v.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},d.getAppendedFrag=function(a){var i=this.fragmentTracker.getAppendedFrag(a,L.PlaylistLevelType.MAIN);return i&&"fragment"in i?i.fragment:i},d.getBufferedFrag=function(a){return this.fragmentTracker.getBufferedFrag(a,L.PlaylistLevelType.MAIN)},d.followingBufferedFrag=function(a){return a?this.getBufferedFrag(a.end+.5):null},d.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},d.nextLevelSwitch=function(){var a=this.levels,i=this.media;if(i!=null&&i.readyState){var n,v=this.getAppendedFrag(i.currentTime);if(v&&v.start>1&&this.flushMainBuffer(0,v.start-1),!i.paused&&a){var c=this.hls.nextLoadLevel,x=a[c],O=this.fragLastKbps;O&&this.fragCurrent?n=this.fragCurrent.duration*x.maxBitrate/(1e3*O)+1:n=0}else n=0;var I=this.getBufferedFrag(i.currentTime+n);if(I){var F=this.followingBufferedFrag(I);if(F){this.abortCurrentFrag();var B=F.maxStartPTS?F.maxStartPTS:F.start,U=F.duration,k=Math.max(I.end,B+Math.min(Math.max(U-this.config.maxFragLookUpTolerance,U*.5),U*.75));this.flushMainBuffer(k,Number.POSITIVE_INFINITY)}}}},d.abortCurrentFrag=function(){var a=this.fragCurrent;this.fragCurrent=null,a!=null&&a.loader&&a.loader.abort(),this.state===A.State.KEY_LOADING&&(this.state=A.State.IDLE),this.nextLoadPosition=this.getLoadPosition()},d.flushMainBuffer=function(a,i){l.prototype.flushMainBuffer.call(this,a,i,this.altAudio?"video":null)},d.onMediaAttached=function(a,i){l.prototype.onMediaAttached.call(this,a,i);var n=i.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),n.addEventListener("playing",this.onvplaying),n.addEventListener("seeked",this.onvseeked),this.gapController=new p.default(this.config,n,this.fragmentTracker,this.hls)},d.onMediaDetaching=function(){var a=this.media;a&&(a.removeEventListener("playing",this.onvplaying),a.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),l.prototype.onMediaDetaching.call(this)},d.onMediaPlaying=function(){this.tick()},d.onMediaSeeked=function(){var a=this.media,i=a?a.currentTime:null;Object(C.isFiniteNumber)(i)&&this.log("Media seeked to "+i.toFixed(3)),this.tick()},d.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(M.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=this.stalled=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null},d.onManifestParsed=function(a,i){var n=!1,v=!1,c;i.levels.forEach(function(x){c=x.audioCodec,c&&(c.indexOf("mp4a.40.2")!==-1&&(n=!0),c.indexOf("mp4a.40.5")!==-1&&(v=!0))}),this.audioCodecSwitch=n&&v&&!Object(D.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=i.levels,this.startFragRequested=!1},d.onLevelLoading=function(a,i){var n=this.levels;if(!(!n||this.state!==A.State.IDLE)){var v=n[i.level];(!v.details||v.details.live&&this.levelLastLoaded!==i.level||this.waitForCdnTuneIn(v.details))&&(this.state=A.State.WAITING_LEVEL)}},d.onLevelLoaded=function(a,i){var n,v=this.levels,c=i.level,x=i.details,O=x.totalduration;if(!v){this.warn("Levels were reset while loading level "+c);return}this.log("Level "+c+" loaded ["+x.startSN+","+x.endSN+"], cc ["+x.startCC+", "+x.endCC+"] duration:"+O);var I=this.fragCurrent;I&&(this.state===A.State.FRAG_LOADING||this.state===A.State.FRAG_LOADING_WAITING_RETRY)&&I.level!==i.level&&I.loader&&(this.state=A.State.IDLE,I.loader.abort());var F=v[c],B=0;if(x.live||(n=F.details)!==null&&n!==void 0&&n.live){if(x.fragments[0]||(x.deltaUpdateFailed=!0),x.deltaUpdateFailed)return;B=this.alignPlaylists(x,F.details)}if(F.details=x,this.levelLastLoaded=c,this.hls.trigger(M.Events.LEVEL_UPDATED,{details:x,level:c}),this.state===A.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(x))return;this.state=A.State.IDLE}this.startFragRequested?x.live&&this.synchronizeToLiveEdge(x):this.setStartPosition(x,B),this.tick()},d._handleFragmentLoadProgress=function(a){var i,n=a.frag,v=a.part,c=a.payload,x=this.levels;if(!x){this.warn("Levels were reset while fragment load was in progress. Fragment "+n.sn+" of level "+n.level+" will not be buffered");return}var O=x[n.level],I=O.details;if(!I){this.warn("Dropping fragment "+n.sn+" of level "+n.level+" after level details were reset");return}var F=O.videoCodec,B=I.PTSKnown||!I.live,U=(i=n.initSegment)===null||i===void 0?void 0:i.data,k=this._getAudioCodec(O),N=this.transmuxer=this.transmuxer||new y.default(this.hls,L.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),K=v?v.index:-1,W=K!==-1,w=new S.ChunkMetadata(n.level,n.sn,n.stats.chunkCount,c.byteLength,K,W),H=this.initPTS[n.cc];N.push(c,U,k,F,n,v,I.totalduration,B,w,H)},d.onAudioTrackSwitching=function(a,i){var n=this.altAudio,v=!!i.url,c=i.id;if(!v){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var x=this.fragCurrent;x!=null&&x.loader&&(this.log("Switching to main audio track, cancel main fragment load"),x.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var O=this.hls;n&&O.trigger(M.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),O.trigger(M.Events.AUDIO_TRACK_SWITCHED,{id:c})}},d.onAudioTrackSwitched=function(a,i){var n=i.id,v=!!this.hls.audioTracks[n].url;if(v){var c=this.videoBuffer;c&&this.mediaBuffer!==c&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=c)}this.altAudio=v,this.tick()},d.onBufferCreated=function(a,i){var n=i.tracks,v,c,x=!1;for(var O in n){var I=n[O];if(I.id==="main"){if(c=O,v=I,O==="video"){var F=n[O];F&&(this.videoBuffer=F.buffer)}}else x=!0}x&&v?(this.log("Alternate track found, use "+c+".buffered to schedule main fragment loading"),this.mediaBuffer=v.buffer):this.mediaBuffer=this.media},d.onFragBuffered=function(a,i){var n=i.frag,v=i.part;if(!(n&&n.type!==L.PlaylistLevelType.MAIN)){if(this.fragContextChanged(n)){this.warn("Fragment "+n.sn+(v?" p: "+v.index:"")+" of level "+n.level+" finished buffering, but was aborted. state: "+this.state),this.state===A.State.PARSED&&(this.state=A.State.IDLE);return}var c=v?v.stats:n.stats;this.fragLastKbps=Math.round(8*c.total/(c.buffering.end-c.loading.first)),n.sn!=="initSegment"&&(this.fragPrevious=n),this.fragBufferedComplete(n,v)}},d.onError=function(a,i){switch(i.details){case E.ErrorDetails.FRAG_LOAD_ERROR:case E.ErrorDetails.FRAG_LOAD_TIMEOUT:case E.ErrorDetails.KEY_LOAD_ERROR:case E.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(L.PlaylistLevelType.MAIN,i);break;case E.ErrorDetails.LEVEL_LOAD_ERROR:case E.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==A.State.ERROR&&(i.fatal?(this.warn(""+i.details),this.state=A.State.ERROR):!i.levelRetry&&this.state===A.State.WAITING_LEVEL&&(this.state=A.State.IDLE));break;case E.ErrorDetails.BUFFER_FULL_ERROR:if(i.parent==="main"&&(this.state===A.State.PARSING||this.state===A.State.PARSED)){var n=!0,v=this.getFwdBufferInfo(this.media,L.PlaylistLevelType.MAIN);v&&v.len>.5&&(n=!this.reduceMaxBufferLength(v.len)),n&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}break;default:break}},d.checkBuffer=function(){var a=this.media,i=this.gapController;if(!(!a||!i||!a.readyState)){var n=P.BufferHelper.getBuffered(a);!this.loadedmetadata&&n.length?(this.loadedmetadata=!0,this.seekToStartPos()):i.poll(this.lastCurrentTime),this.lastCurrentTime=a.currentTime}},d.onFragLoadEmergencyAborted=function(){this.state=A.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},d.onBufferFlushed=function(a,i){var n=i.type;if(n!==g.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var v=(n===g.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(v,n,L.PlaylistLevelType.MAIN)}},d.onLevelsUpdated=function(a,i){this.levels=i.levels},d.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},d.seekToStartPos=function(){var a=this.media,i=a.currentTime,n=this.startPosition;if(n>=0&&i<n){if(a.seeking){m.logger.log("could not seek to "+n+", already seeking at "+i);return}var v=P.BufferHelper.getBuffered(a),c=v.length?v.start(0):0,x=c-n;x>0&&(x<this.config.maxBufferHole||x<this.config.maxFragLookUpTolerance)&&(m.logger.log("adjusting start position by "+x+" to match buffer start"),n+=x,this.startPosition=n),this.log("seek to target start position "+n+" from current time "+i),a.currentTime=n}},d._getAudioCodec=function(a){var i=this.config.defaultAudioCodec||a.audioCodec;return this.audioCodecSwap&&i&&(this.log("Swapping audio codec"),i.indexOf("mp4a.40.5")!==-1?i="mp4a.40.2":i="mp4a.40.5"),i},d._loadBitrateTestFrag=function(a){var i=this;this._doFragLoad(a).then(function(n){var v=i.hls;if(!(!n||v.nextLoadLevel||i.fragContextChanged(a))){i.fragLoadError=0,i.state=A.State.IDLE,i.startFragRequested=!1,i.bitrateTest=!1;var c=a.stats;c.parsing.start=c.parsing.end=c.buffering.start=c.buffering.end=self.performance.now(),v.trigger(M.Events.FRAG_LOADED,n)}})},d._handleTransmuxComplete=function(a){var i,n="main",v=this.hls,c=a.remuxResult,x=a.chunkMeta,O=this.getCurrentContext(x);if(!O){this.warn("The loading context changed while buffering fragment "+x.sn+" of level "+x.level+". This chunk will not be buffered."),this.resetLiveStartWhenNotLoaded(x.level);return}var I=O.frag,F=O.part,B=O.level,U=c.video,k=c.text,N=c.id3,K=c.initSegment,W=this.altAudio?void 0:c.audio;if(!this.fragContextChanged(I)){if(this.state=A.State.PARSING,K){K.tracks&&(this._bufferInitSegment(B,K.tracks,I,x),v.trigger(M.Events.FRAG_PARSING_INIT_SEGMENT,{frag:I,id:n,tracks:K.tracks}));var w=K.initPTS,H=K.timescale;Object(C.isFiniteNumber)(w)&&(this.initPTS[I.cc]=w,v.trigger(M.Events.INIT_PTS_FOUND,{frag:I,id:n,initPTS:w,timescale:H}))}if(U&&c.independent!==!1){if(B.details){var V=U.startPTS,j=U.endPTS,X=U.startDTS,Y=U.endDTS;if(F)F.elementaryStreams[U.type]={startPTS:V,endPTS:j,startDTS:X,endDTS:Y};else if(U.firstKeyFrame&&U.independent&&(this.couldBacktrack=!0),U.dropped&&U.independent){var $=this.getLoadPosition()+this.config.maxBufferHole;if($<V){this.backtrack(I);return}I.setElementaryStreamInfo(U.type,I.start,j,I.start,Y,!0)}I.setElementaryStreamInfo(U.type,V,j,X,Y),this.bufferFragmentData(U,I,F,x)}}else if(c.independent===!1){this.backtrack(I);return}if(W){var _=W.startPTS,z=W.endPTS,J=W.startDTS,Q=W.endDTS;F&&(F.elementaryStreams[g.ElementaryStreamTypes.AUDIO]={startPTS:_,endPTS:z,startDTS:J,endDTS:Q}),I.setElementaryStreamInfo(g.ElementaryStreamTypes.AUDIO,_,z,J,Q),this.bufferFragmentData(W,I,F,x)}if(N!=null&&(i=N.samples)!==null&&i!==void 0&&i.length){var et={frag:I,id:n,samples:N.samples};v.trigger(M.Events.FRAG_PARSING_METADATA,et)}if(k){var Z={frag:I,id:n,samples:k.samples};v.trigger(M.Events.FRAG_PARSING_USERDATA,Z)}}},d._bufferInitSegment=function(a,i,n,v){var c=this;if(this.state===A.State.PARSING){this.audioOnly=!!i.audio&&!i.video,this.altAudio&&!this.audioOnly&&delete i.audio;var x=i.audio,O=i.video,I=i.audiovideo;if(x){var F=a.audioCodec,B=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(F&&(F.indexOf("mp4a.40.5")!==-1?F="mp4a.40.2":F="mp4a.40.5"),x.metadata.channelCount!==1&&B.indexOf("firefox")===-1&&(F="mp4a.40.5")),B.indexOf("android")!==-1&&x.container!=="audio/mpeg"&&(F="mp4a.40.2",this.log("Android: force audio codec to "+F)),a.audioCodec&&a.audioCodec!==F&&this.log('Swapping manifest audio codec "'+a.audioCodec+'" for "'+F+'"'),x.levelCodec=F,x.id="main",this.log("Init audio buffer, container:"+x.container+", codecs[selected/level/parsed]=["+(F||"")+"/"+(a.audioCodec||"")+"/"+x.codec+"]")}O&&(O.levelCodec=a.videoCodec,O.id="main",this.log("Init video buffer, container:"+O.container+", codecs[level/parsed]=["+(a.videoCodec||"")+"/"+O.codec+"]")),I&&this.log("Init audiovideo buffer, container:"+I.container+", codecs[level/parsed]=["+(a.attrs.CODECS||"")+"/"+I.codec+"]"),this.hls.trigger(M.Events.BUFFER_CODECS,i),Object.keys(i).forEach(function(U){var k=i[U],N=k.initSegment;N!=null&&N.byteLength&&c.hls.trigger(M.Events.BUFFER_APPENDING,{type:U,data:N,frag:n,part:null,chunkMeta:v,parent:n.type})}),this.tick()}},d.backtrack=function(a){this.couldBacktrack=!0,this.resetTransmuxer(),this.flushBufferGap(a);var i=this.fragmentTracker.backtrack(a);this.fragPrevious=null,this.nextLoadPosition=a.start,i?this.resetFragmentLoading(a):this.state=A.State.BACKTRACKING},d.checkFragmentChanged=function(){var a=this.media,i=null;if(a&&a.readyState>1&&a.seeking===!1){var n=a.currentTime;if(P.BufferHelper.isBuffered(a,n)?i=this.getAppendedFrag(n):P.BufferHelper.isBuffered(a,n+.1)&&(i=this.getAppendedFrag(n+.1)),i){var v=this.fragPlaying,c=i.level;(!v||i.sn!==v.sn||v.level!==c||i.urlId!==v.urlId)&&(this.hls.trigger(M.Events.FRAG_CHANGED,{frag:i}),(!v||v.level!==c)&&this.hls.trigger(M.Events.LEVEL_SWITCHED,{level:c}),this.fragPlaying=i)}}},t(h,[{key:"nextLevel",get:function(){var a=this.nextBufferedFrag;return a?a.level:-1}},{key:"currentLevel",get:function(){var a=this.media;if(a){var i=this.getAppendedFrag(a.currentTime);if(i)return i.level}return-1}},{key:"nextBufferedFrag",get:function(){var a=this.media;if(a){var i=this.getAppendedFrag(a.currentTime);return this.followingBufferedFrag(i)}else return null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),h}(A.default)},"./src/controller/subtitle-stream-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"SubtitleStreamController",function(){return r});var C=T("./src/events.ts"),A=T("./src/utils/logger.ts"),D=T("./src/utils/buffer-helper.ts"),M=T("./src/controller/fragment-finders.ts"),P=T("./src/utils/discontinuities.ts"),R=T("./src/controller/level-helper.ts"),L=T("./src/controller/fragment-tracker.ts"),g=T("./src/controller/base-stream-controller.ts"),y=T("./src/types/loader.ts"),S=T("./src/types/level.ts");function p(e,f){for(var s=0;s<f.length;s++){var l=f[s];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}function E(e,f,s){return f&&p(e.prototype,f),s&&p(e,s),e}function m(e,f){e.prototype=Object.create(f.prototype),e.prototype.constructor=e,u(e,f)}function u(e,f){return u=Object.setPrototypeOf||function(l,h){return l.__proto__=h,l},u(e,f)}var t=500,r=function(e){m(f,e);function f(l,h){var d;return d=e.call(this,l,h,"[subtitle-stream-controller]")||this,d.levels=[],d.currentTrackId=-1,d.tracksBuffered=[],d.mainDetails=null,d._registerListeners(),d}var s=f.prototype;return s.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},s._registerListeners=function(){var h=this.hls;h.on(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),h.on(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this),h.on(C.Events.MANIFEST_LOADING,this.onManifestLoading,this),h.on(C.Events.LEVEL_LOADED,this.onLevelLoaded,this),h.on(C.Events.ERROR,this.onError,this),h.on(C.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),h.on(C.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),h.on(C.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),h.on(C.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),h.on(C.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},s._unregisterListeners=function(){var h=this.hls;h.off(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),h.off(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this),h.off(C.Events.MANIFEST_LOADING,this.onManifestLoading,this),h.off(C.Events.LEVEL_LOADED,this.onLevelLoaded,this),h.off(C.Events.ERROR,this.onError,this),h.off(C.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),h.off(C.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),h.off(C.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),h.off(C.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),h.off(C.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},s.startLoad=function(){this.stopLoad(),this.state=g.State.IDLE,this.setInterval(t),this.tick()},s.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},s.onLevelLoaded=function(h,d){this.mainDetails=d.details},s.onSubtitleFragProcessed=function(h,d){var o=d.frag,a=d.success;if(this.fragPrevious=o,this.state=g.State.IDLE,!!a){var i=this.tracksBuffered[this.currentTrackId];if(!!i){for(var n,v=o.start,c=0;c<i.length;c++)if(v>=i[c].start&&v<=i[c].end){n=i[c];break}var x=o.start+o.duration;n?n.end=x:(n={start:v,end:x},i.push(n)),this.fragmentTracker.fragBuffered(o)}}},s.onBufferFlushing=function(h,d){var o=d.startOffset,a=d.endOffset;if(o===0&&a!==Number.POSITIVE_INFINITY){var i=this.currentTrackId,n=this.levels;if(!n.length||!n[i]||!n[i].details)return;var v=n[i].details,c=v.targetduration,x=a-c;if(x<=0)return;d.endOffsetSubtitles=Math.max(0,x),this.tracksBuffered.forEach(function(O){for(var I=0;I<O.length;){if(O[I].end<=x){O.shift();continue}else if(O[I].start<x)O[I].start=x;else break;I++}}),this.fragmentTracker.removeFragmentsInRange(o,x,y.PlaylistLevelType.SUBTITLE)}},s.onError=function(h,d){var o,a=d.frag;!a||a.type!==y.PlaylistLevelType.SUBTITLE||((o=this.fragCurrent)!==null&&o!==void 0&&o.loader&&this.fragCurrent.loader.abort(),this.state=g.State.IDLE)},s.onSubtitleTracksUpdated=function(h,d){var o=this,a=d.subtitleTracks;this.tracksBuffered=[],this.levels=a.map(function(i){return new S.Level(i)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(i){o.tracksBuffered[i.id]=[]}),this.mediaBuffer=null},s.onSubtitleTrackSwitch=function(h,d){if(this.currentTrackId=d.id,!this.levels.length||this.currentTrackId===-1){this.clearInterval();return}var o=this.levels[this.currentTrackId];o!=null&&o.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,o&&this.setInterval(t)},s.onSubtitleTrackLoaded=function(h,d){var o,a=d.details,i=d.id,n=this.currentTrackId,v=this.levels;if(!!v.length){var c=v[n];if(!(i>=v.length||i!==n||!c)){if(this.mediaBuffer=this.mediaBufferTimeRanges,a.live||(o=c.details)!==null&&o!==void 0&&o.live){var x=this.mainDetails;if(a.deltaUpdateFailed||!x)return;var O=x.fragments[0];if(!c.details)a.hasProgramDateTime&&x.hasProgramDateTime?Object(P.alignMediaPlaylistByPDT)(a,x):O&&Object(R.addSliding)(a,O.start);else{var I=this.alignPlaylists(a,c.details);I===0&&O&&Object(R.addSliding)(a,O.start)}}if(c.details=a,this.levelLastLoaded=i,this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===g.State.IDLE){var F=Object(M.findFragmentByPTS)(null,a.fragments,this.media.currentTime,0);F||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)}}}},s._handleFragmentLoadComplete=function(h){var d=h.frag,o=h.payload,a=d.decryptdata,i=this.hls;if(!this.fragContextChanged(d)&&o&&o.byteLength>0&&a&&a.key&&a.iv&&a.method==="AES-128"){var n=performance.now();this.decrypter.webCryptoDecrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer).then(function(v){var c=performance.now();i.trigger(C.Events.FRAG_DECRYPTED,{frag:d,payload:v,stats:{tstart:n,tdecrypt:c}})})}},s.doTick=function(){if(!this.media){this.state=g.State.IDLE;return}if(this.state===g.State.IDLE){var h,d=this.currentTrackId,o=this.levels;if(!o.length||!o[d]||!o[d].details)return;var a=o[d].details,i=a.targetduration,n=this.config,v=this.media,c=D.BufferHelper.bufferedInfo(this.mediaBufferTimeRanges,v.currentTime-i,n.maxBufferHole),x=c.end,O=c.len,I=this.getMaxBufferLength()+i;if(O>I)return;console.assert(a,"Subtitle track details are defined on idle subtitle stream controller tick");var F=a.fragments,B=F.length,U=a.edge,k,N=this.fragPrevious;if(x<U){var K=n.maxFragLookUpTolerance;k=Object(M.findFragmentByPTS)(N,F,x,K),!k&&N&&N.start<F[0].start&&(k=F[0])}else k=F[B-1];(h=k)!==null&&h!==void 0&&h.encrypted?(A.logger.log("Loading key for "+k.sn),this.state=g.State.KEY_LOADING,this.hls.trigger(C.Events.KEY_LOADING,{frag:k})):k&&this.fragmentTracker.getState(k)===L.FragmentState.NOT_LOADED&&this.loadFragment(k,a,x)}},s.loadFragment=function(h,d,o){this.fragCurrent=h,e.prototype.loadFragment.call(this,h,d,o)},E(f,[{key:"mediaBufferTimeRanges",get:function(){return this.tracksBuffered[this.currentTrackId]||[]}}]),f}(g.default)},"./src/controller/subtitle-track-controller.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/events.ts"),A=T("./src/utils/texttrack-utils.ts"),D=T("./src/controller/base-playlist-controller.ts"),M=T("./src/types/loader.ts");function P(p,E){for(var m=0;m<E.length;m++){var u=E[m];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(p,u.key,u)}}function R(p,E,m){return E&&P(p.prototype,E),m&&P(p,m),p}function L(p,E){p.prototype=Object.create(E.prototype),p.prototype.constructor=p,g(p,E)}function g(p,E){return g=Object.setPrototypeOf||function(u,t){return u.__proto__=t,u},g(p,E)}var y=function(p){L(E,p);function E(u){var t;return t=p.call(this,u,"[subtitle-track-controller]")||this,t.media=null,t.tracks=[],t.groupId=null,t.tracksInGroup=[],t.trackId=-1,t.selectDefaultTrack=!0,t.queuedDefaultTrack=-1,t.trackChangeListener=function(){return t.onTextTracksChanged()},t.asyncPollTrackChange=function(){return t.pollTrackChange(0)},t.useTextTrackPolling=!1,t.subtitlePollingInterval=-1,t.subtitleDisplay=!0,t.registerListeners(),t}var m=E.prototype;return m.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,p.prototype.destroy.call(this)},m.registerListeners=function(){var t=this.hls;t.on(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.Events.LEVEL_LOADING,this.onLevelLoading,this),t.on(C.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(C.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(C.Events.ERROR,this.onError,this)},m.unregisterListeners=function(){var t=this.hls;t.off(C.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.Events.LEVEL_LOADING,this.onLevelLoading,this),t.off(C.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(C.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(C.Events.ERROR,this.onError,this)},m.onMediaAttached=function(t,r){this.media=r.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},m.pollTrackChange=function(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,t)},m.onMediaDetaching=function(){if(!!this.media){self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);var t=S(this.media.textTracks);t.forEach(function(r){Object(A.clearCurrentCues)(r)}),this.subtitleTrack=-1,this.media=null}},m.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},m.onManifestParsed=function(t,r){this.tracks=r.subtitleTracks},m.onSubtitleTrackLoaded=function(t,r){var e=r.id,f=r.details,s=this.trackId,l=this.tracksInGroup[s];if(!l){this.warn("Invalid subtitle track id "+e);return}var h=l.details;l.details=r.details,this.log("subtitle track "+e+" loaded ["+f.startSN+"-"+f.endSN+"]"),e===this.trackId&&(this.retryCount=0,this.playlistLoaded(e,r,h))},m.onLevelLoading=function(t,r){this.switchLevel(r.level)},m.onLevelSwitching=function(t,r){this.switchLevel(r.level)},m.switchLevel=function(t){var r=this.hls.levels[t];if(!!(r!=null&&r.textGroupIds)){var e=r.textGroupIds[r.urlId];if(this.groupId!==e){var f=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,s=this.tracks.filter(function(d){return!e||d.groupId===e});this.tracksInGroup=s;var l=this.findTrackId(f==null?void 0:f.name)||this.findTrackId();this.groupId=e;var h={subtitleTracks:s};this.log("Updating subtitle tracks, "+s.length+' track(s) found in "'+e+'" group-id'),this.hls.trigger(C.Events.SUBTITLE_TRACKS_UPDATED,h),l!==-1&&this.setSubtitleTrack(l,f)}}},m.findTrackId=function(t){for(var r=this.tracksInGroup,e=0;e<r.length;e++){var f=r[e];if((!this.selectDefaultTrack||f.default)&&(!t||t===f.name))return f.id}return-1},m.onError=function(t,r){p.prototype.onError.call(this,t,r),!(r.fatal||!r.context)&&r.context.type===M.PlaylistContextType.SUBTITLE_TRACK&&r.context.id===this.trackId&&r.context.groupId===this.groupId&&this.retryLoadingOrFail(r)},m.loadPlaylist=function(t){var r=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(r)){var e=r.id,f=r.groupId,s=r.url;if(t)try{s=t.addDirectives(s)}catch(l){this.warn("Could not construct new URL with HLS Delivery Directives: "+l)}this.log("Loading subtitle playlist for id "+e),this.hls.trigger(C.Events.SUBTITLE_TRACK_LOADING,{url:s,id:e,groupId:f,deliveryDirectives:t||null})}},m.toggleTrackModes=function(t){var r=this,e=this.media,f=this.subtitleDisplay,s=this.trackId;if(!!e){var l=S(e.textTracks),h=l.filter(function(a){return a.groupId===r.groupId});if(t===-1)[].slice.call(l).forEach(function(a){a.mode="disabled"});else{var d=h[s];d&&(d.mode="disabled")}var o=h[t];o&&(o.mode=f?"showing":"hidden")}},m.setSubtitleTrack=function(t,r){var e,f=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(this.trackId!==t&&this.toggleTrackModes(t),!(this.trackId===t&&(t===-1||(e=f[t])!==null&&e!==void 0&&e.details)||t<-1||t>=f.length)){this.clearTimer();var s=f[t];if(this.log("Switching to subtitle track "+t),this.trackId=t,s){var l=s.id,h=s.groupId,d=h===void 0?"":h,o=s.name,a=s.type,i=s.url;this.hls.trigger(C.Events.SUBTITLE_TRACK_SWITCH,{id:l,groupId:d,name:o,type:a,url:i});var n=this.switchParams(s.url,r==null?void 0:r.details);this.loadPlaylist(n)}else this.hls.trigger(C.Events.SUBTITLE_TRACK_SWITCH,{id:t})}},m.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!(!this.media||!this.hls.config.renderTextTracksNatively)){for(var t=-1,r=S(this.media.textTracks),e=0;e<r.length;e++)if(r[e].mode==="hidden")t=e;else if(r[e].mode==="showing"){t=e;break}this.subtitleTrack!==t&&(this.subtitleTrack=t)}},R(E,[{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(t){this.selectDefaultTrack=!1;var r=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(t,r)}}]),E}(D.default);function S(p){for(var E=[],m=0;m<p.length;m++){var u=p[m];u.kind==="subtitles"&&u.label&&E.push(p[m])}return E}b.default=y},"./src/controller/timeline-controller.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"TimelineController",function(){return S});var C=T("./src/polyfills/number.ts"),A=T("./src/events.ts"),D=T("./src/utils/cea-608-parser.ts"),M=T("./src/utils/output-filter.ts"),P=T("./src/utils/webvtt-parser.ts"),R=T("./src/utils/texttrack-utils.ts"),L=T("./src/utils/imsc1-ttml-parser.ts"),g=T("./src/types/loader.ts"),y=T("./src/utils/logger.ts"),S=function(){function u(r){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=m(),this.captionsProperties=void 0,this.hls=r,this.config=r.config,this.Cues=r.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var e=new M.default(this,"textTrack1"),f=new M.default(this,"textTrack2"),s=new M.default(this,"textTrack3"),l=new M.default(this,"textTrack4");this.cea608Parser1=new D.default(1,e,f),this.cea608Parser2=new D.default(3,s,l)}r.on(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.on(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),r.on(A.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),r.on(A.Events.FRAG_LOADING,this.onFragLoading,this),r.on(A.Events.FRAG_LOADED,this.onFragLoaded,this),r.on(A.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),r.on(A.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),r.on(A.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),r.on(A.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),r.on(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var t=u.prototype;return t.destroy=function(){var e=this.hls;e.off(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(A.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(A.Events.FRAG_LOADING,this.onFragLoading,this),e.off(A.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(A.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(A.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(A.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(A.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},t.addCues=function(e,f,s,l,h){for(var d=!1,o=h.length;o--;){var a=h[o],i=E(a[0],a[1],f,s);if(i>=0&&(a[0]=Math.min(a[0],f),a[1]=Math.max(a[1],s),d=!0,i/(s-f)>.5))return}if(d||h.push([f,s]),this.config.renderTextTracksNatively){var n=this.captionsTracks[e];this.Cues.newCue(n,f,s,l)}else{var v=this.Cues.newCue(null,f,s,l);this.hls.trigger(A.Events.CUES_PARSED,{type:"captions",cues:v,track:e})}},t.onInitPtsFound=function(e,f){var s=this,l=f.frag,h=f.id,d=f.initPTS,o=f.timescale,a=this.unparsedVttFrags;h==="main"&&(this.initPTS[l.cc]=d,this.timescale[l.cc]=o),a.length&&(this.unparsedVttFrags=[],a.forEach(function(i){s.onFragLoaded(A.Events.FRAG_LOADED,i)}))},t.getExistingTrack=function(e){var f=this.media;if(f)for(var s=0;s<f.textTracks.length;s++){var l=f.textTracks[s];if(l[e])return l}return null},t.createCaptionsTrack=function(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)},t.createNativeTrack=function(e){if(!this.captionsTracks[e]){var f=this.captionsProperties,s=this.captionsTracks,l=this.media,h=f[e],d=h.label,o=h.languageCode,a=this.getExistingTrack(e);if(a)s[e]=a,Object(R.clearCurrentCues)(s[e]),Object(R.sendAddTrackEvent)(s[e],l);else{var i=this.createTextTrack("captions",d,o);i&&(i[e]=!0,s[e]=i)}}},t.createNonNativeTrack=function(e){if(!this.nonNativeCaptionsTracks[e]){var f=this.captionsProperties[e];if(!!f){var s=f.label,l={_id:e,label:s,kind:"captions",default:f.media?!!f.media.default:!1,closedCaptions:f.media};this.nonNativeCaptionsTracks[e]=l,this.hls.trigger(A.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[l]})}}},t.createTextTrack=function(e,f,s){var l=this.media;if(!!l)return l.addTextTrack(e,f,s)},t.onMediaAttaching=function(e,f){this.media=f.media,this._cleanTracks()},t.onMediaDetaching=function(){var e=this.captionsTracks;Object.keys(e).forEach(function(f){Object(R.clearCurrentCues)(e[f]),delete e[f]}),this.nonNativeCaptionsTracks={}},t.onManifestLoading=function(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=m(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},t._cleanTracks=function(){var e=this.media;if(!!e){var f=e.textTracks;if(f)for(var s=0;s<f.length;s++)Object(R.clearCurrentCues)(f[s])}},t.onSubtitleTracksUpdated=function(e,f){var s=this;this.textTracks=[];var l=f.subtitleTracks||[],h=l.some(function(i){return i.textCodec===L.IMSC1_CODEC});if(this.config.enableWebVTT||h&&this.config.enableIMSC1){var d=this.tracks&&l&&this.tracks.length===l.length;if(this.tracks=l||[],this.config.renderTextTracksNatively){var o=this.media?this.media.textTracks:[];this.tracks.forEach(function(i,n){var v;if(n<o.length){for(var c=null,x=0;x<o.length;x++)if(p(o[x],i)){c=o[x];break}c&&(v=c)}v?Object(R.clearCurrentCues)(v):(v=s.createTextTrack("subtitles",i.name,i.lang),v&&(v.mode="disabled")),v&&(v.groupId=i.groupId,s.textTracks.push(v))})}else if(!d&&this.tracks&&this.tracks.length){var a=this.tracks.map(function(i){return{label:i.name,kind:i.type.toLowerCase(),default:i.default,subtitleTrack:i}});this.hls.trigger(A.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:a})}}},t.onManifestLoaded=function(e,f){var s=this;this.config.enableCEA708Captions&&f.captions&&f.captions.forEach(function(l){var h=/(?:CC|SERVICE)([1-4])/.exec(l.instreamId);if(!!h){var d="textTrack"+h[1],o=s.captionsProperties[d];!o||(o.label=l.name,l.lang&&(o.languageCode=l.lang),o.media=l)}})},t.onFragLoading=function(e,f){var s=this.cea608Parser1,l=this.cea608Parser2,h=this.lastSn,d=this.lastPartIndex;if(!(!this.enabled||!(s&&l))&&f.frag.type===g.PlaylistLevelType.MAIN){var o,a,i=f.frag.sn,n=(o=f==null||(a=f.part)===null||a===void 0?void 0:a.index)!=null?o:-1;i===h+1||i===h&&n===d+1||(s.reset(),l.reset()),this.lastSn=i,this.lastPartIndex=n}},t.onFragLoaded=function(e,f){var s=f.frag,l=f.payload,h=this.initPTS,d=this.unparsedVttFrags;if(s.type===g.PlaylistLevelType.SUBTITLE)if(l.byteLength){if(!Object(C.isFiniteNumber)(h[s.cc])){d.push(f),h.length&&this.hls.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:new Error("Missing initial subtitle PTS")});return}var o=s.decryptdata;if(o==null||o.key==null||o.method!=="AES-128"){var a=this.tracks[s.level],i=this.vttCCs;i[s.cc]||(i[s.cc]={start:s.start,prevCC:this.prevCC,new:!0},this.prevCC=s.cc),a&&a.textCodec===L.IMSC1_CODEC?this._parseIMSC1(s,l):this._parseVTTs(s,l,i)}}else this.hls.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:new Error("Empty subtitle payload")})},t._parseIMSC1=function(e,f){var s=this,l=this.hls;Object(L.parseIMSC1)(f,this.initPTS[e.cc],this.timescale[e.cc],function(h){s._appendCues(h,e.level),l.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(h){y.logger.log("Failed to parse IMSC1: "+h),l.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:h})})},t._parseVTTs=function(e,f,s){var l=this,h=this.hls;Object(P.parseWebVTT)(f,this.initPTS[e.cc],this.timescale[e.cc],s,e.cc,e.start,function(d){l._appendCues(d,e.level),h.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(d){l._fallbackToIMSC1(e,f),y.logger.log("Failed to parse VTT cue: "+d),h.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:d})})},t._fallbackToIMSC1=function(e,f){var s=this,l=this.tracks[e.level];l.textCodec||Object(L.parseIMSC1)(f,this.initPTS[e.cc],this.timescale[e.cc],function(){l.textCodec=L.IMSC1_CODEC,s._parseIMSC1(e,f)},function(){l.textCodec="wvtt"})},t._appendCues=function(e,f){var s=this.hls;if(this.config.renderTextTracksNatively){var l=this.textTracks[f];if(l.mode==="disabled")return;e.forEach(function(o){return Object(R.addCueToTrack)(l,o)})}else{var h=this.tracks[f],d=h.default?"default":"subtitles"+f;s.trigger(A.Events.CUES_PARSED,{type:"subtitles",cues:e,track:d})}},t.onFragDecrypted=function(e,f){var s=f.frag;if(s.type===g.PlaylistLevelType.SUBTITLE){if(!Object(C.isFiniteNumber)(this.initPTS[s.cc])){this.unparsedVttFrags.push(f);return}this.onFragLoaded(A.Events.FRAG_LOADED,f)}},t.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},t.onFragParsingUserdata=function(e,f){var s=this.cea608Parser1,l=this.cea608Parser2;if(!(!this.enabled||!(s&&l)))for(var h=0;h<f.samples.length;h++){var d=f.samples[h].bytes;if(d){var o=this.extractCea608Data(d);s.addData(f.samples[h].pts,o[0]),l.addData(f.samples[h].pts,o[1])}}},t.onBufferFlushing=function(e,f){var s=f.startOffset,l=f.endOffset,h=f.endOffsetSubtitles,d=f.type,o=this.media;if(!(!o||o.currentTime<l)){if(!d||d==="video"){var a=this.captionsTracks;Object.keys(a).forEach(function(n){return Object(R.removeCuesInRange)(a[n],s,l)})}if(this.config.renderTextTracksNatively&&s===0&&h!==void 0){var i=this.textTracks;Object.keys(i).forEach(function(n){return Object(R.removeCuesInRange)(i[n],s,h)})}}},t.extractCea608Data=function(e){for(var f=e[0]&31,s=2,l=[[],[]],h=0;h<f;h++){var d=e[s++],o=127&e[s++],a=127&e[s++],i=(4&d)!==0,n=3&d;o===0&&a===0||i&&(n===0||n===1)&&(l[n].push(o),l[n].push(a))}return l},u}();function p(u,t){return u&&u.label===t.name&&!(u.textTrack1||u.textTrack2)}function E(u,t,r,e){return Math.min(t,e)-Math.max(u,r)}function m(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}}}},"./src/crypt/aes-crypto.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return C});var C=function(){function A(M,P){this.subtle=void 0,this.aesIV=void 0,this.subtle=M,this.aesIV=P}var D=A.prototype;return D.decrypt=function(P,R){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},R,P)},A}()},"./src/crypt/aes-decryptor.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"removePadding",function(){return A}),T.d(b,"default",function(){return D});var C=T("./src/utils/typed-array.ts");function A(M){var P=M.byteLength,R=P&&new DataView(M.buffer).getUint8(P-1);return R?Object(C.sliceUint8)(M,0,P-R):M}var D=function(){function M(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var P=M.prototype;return P.uint8ArrayToUint32Array_=function(L){for(var g=new DataView(L),y=new Uint32Array(4),S=0;S<4;S++)y[S]=g.getUint32(S*4);return y},P.initTable=function(){var L=this.sBox,g=this.invSBox,y=this.subMix,S=y[0],p=y[1],E=y[2],m=y[3],u=this.invSubMix,t=u[0],r=u[1],e=u[2],f=u[3],s=new Uint32Array(256),l=0,h=0,d=0;for(d=0;d<256;d++)d<128?s[d]=d<<1:s[d]=d<<1^283;for(d=0;d<256;d++){var o=h^h<<1^h<<2^h<<3^h<<4;o=o>>>8^o&255^99,L[l]=o,g[o]=l;var a=s[l],i=s[a],n=s[i],v=s[o]*257^o*16843008;S[l]=v<<24|v>>>8,p[l]=v<<16|v>>>16,E[l]=v<<8|v>>>24,m[l]=v,v=n*16843009^i*65537^a*257^l*16843008,t[o]=v<<24|v>>>8,r[o]=v<<16|v>>>16,e[o]=v<<8|v>>>24,f[o]=v,l?(l=a^s[s[s[n^a]]],h^=s[s[h]]):l=h=1}},P.expandKey=function(L){for(var g=this.uint8ArrayToUint32Array_(L),y=!0,S=0;S<g.length&&y;)y=g[S]===this.key[S],S++;if(!y){this.key=g;var p=this.keySize=g.length;if(p!==4&&p!==6&&p!==8)throw new Error("Invalid aes key size="+p);var E=this.ksRows=(p+6+1)*4,m,u,t=this.keySchedule=new Uint32Array(E),r=this.invKeySchedule=new Uint32Array(E),e=this.sBox,f=this.rcon,s=this.invSubMix,l=s[0],h=s[1],d=s[2],o=s[3],a,i;for(m=0;m<E;m++){if(m<p){a=t[m]=g[m];continue}i=a,m%p===0?(i=i<<8|i>>>24,i=e[i>>>24]<<24|e[i>>>16&255]<<16|e[i>>>8&255]<<8|e[i&255],i^=f[m/p|0]<<24):p>6&&m%p===4&&(i=e[i>>>24]<<24|e[i>>>16&255]<<16|e[i>>>8&255]<<8|e[i&255]),t[m]=a=(t[m-p]^i)>>>0}for(u=0;u<E;u++)m=E-u,u&3?i=t[m]:i=t[m-4],u<4||m<=4?r[u]=i:r[u]=l[e[i>>>24]]^h[e[i>>>16&255]]^d[e[i>>>8&255]]^o[e[i&255]],r[u]=r[u]>>>0}},P.networkToHostOrderSwap=function(L){return L<<24|(L&65280)<<8|(L&16711680)>>8|L>>>24},P.decrypt=function(L,g,y){for(var S=this.keySize+6,p=this.invKeySchedule,E=this.invSBox,m=this.invSubMix,u=m[0],t=m[1],r=m[2],e=m[3],f=this.uint8ArrayToUint32Array_(y),s=f[0],l=f[1],h=f[2],d=f[3],o=new Int32Array(L),a=new Int32Array(o.length),i,n,v,c,x,O,I,F,B,U,k,N,K,W,w=this.networkToHostOrderSwap;g<o.length;){for(B=w(o[g]),U=w(o[g+1]),k=w(o[g+2]),N=w(o[g+3]),x=B^p[0],O=N^p[1],I=k^p[2],F=U^p[3],K=4,W=1;W<S;W++)i=u[x>>>24]^t[O>>16&255]^r[I>>8&255]^e[F&255]^p[K],n=u[O>>>24]^t[I>>16&255]^r[F>>8&255]^e[x&255]^p[K+1],v=u[I>>>24]^t[F>>16&255]^r[x>>8&255]^e[O&255]^p[K+2],c=u[F>>>24]^t[x>>16&255]^r[O>>8&255]^e[I&255]^p[K+3],x=i,O=n,I=v,F=c,K=K+4;i=E[x>>>24]<<24^E[O>>16&255]<<16^E[I>>8&255]<<8^E[F&255]^p[K],n=E[O>>>24]<<24^E[I>>16&255]<<16^E[F>>8&255]<<8^E[x&255]^p[K+1],v=E[I>>>24]<<24^E[F>>16&255]<<16^E[x>>8&255]<<8^E[O&255]^p[K+2],c=E[F>>>24]<<24^E[x>>16&255]<<16^E[O>>8&255]<<8^E[I&255]^p[K+3],a[g]=w(i^s),a[g+1]=w(c^l),a[g+2]=w(v^h),a[g+3]=w(n^d),s=B,l=U,h=k,d=N,g=g+4}return a.buffer},M}()},"./src/crypt/decrypter.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return g});var C=T("./src/crypt/aes-crypto.ts"),A=T("./src/crypt/fast-aes-key.ts"),D=T("./src/crypt/aes-decryptor.ts"),M=T("./src/utils/logger.ts"),P=T("./src/utils/mp4-tools.ts"),R=T("./src/utils/typed-array.ts"),L=16,g=function(){function y(p,E,m){var u=m===void 0?{}:m,t=u.removePKCS7Padding,r=t===void 0?!0:t;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=p,this.config=E,this.removePKCS7Padding=r,r)try{var e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(f){}this.subtle===null&&(this.config.enableSoftwareAES=!0)}var S=y.prototype;return S.destroy=function(){this.observer=null},S.isSync=function(){return this.config.enableSoftwareAES},S.flush=function(){var E=this.currentResult;if(!E){this.reset();return}var m=new Uint8Array(E);return this.reset(),this.removePKCS7Padding?Object(D.removePadding)(m):m},S.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},S.decrypt=function(E,m,u,t){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(E),m,u);var r=this.flush();r&&t(r.buffer)}else this.webCryptoDecrypt(new Uint8Array(E),m,u).then(t)},S.softwareDecrypt=function(E,m,u){var t=this.currentIV,r=this.currentResult,e=this.remainderData;this.logOnce("JS AES decrypt"),e&&(E=Object(P.appendUint8Array)(e,E),this.remainderData=null);var f=this.getValidChunk(E);if(!f.length)return null;t&&(u=t);var s=this.softwareDecrypter;s||(s=this.softwareDecrypter=new D.default),s.expandKey(m);var l=r;return this.currentResult=s.decrypt(f.buffer,0,u),this.currentIV=Object(R.sliceUint8)(f,-16).buffer,l||null},S.webCryptoDecrypt=function(E,m,u){var t=this,r=this.subtle;return(this.key!==m||!this.fastAesKey)&&(this.key=m,this.fastAesKey=new A.default(r,m)),this.fastAesKey.expandKey().then(function(e){if(!r)return Promise.reject(new Error("web crypto not initialized"));var f=new C.default(r,u);return f.decrypt(E.buffer,e)}).catch(function(e){return t.onWebCryptoError(e,E,m,u)})},S.onWebCryptoError=function(E,m,u,t){return M.logger.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",E),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(m,u,t)},S.getValidChunk=function(E){var m=E,u=E.length-E.length%L;return u!==E.length&&(m=Object(R.sliceUint8)(E,0,u),this.remainderData=Object(R.sliceUint8)(E,u)),m},S.logOnce=function(E){!this.logEnabled||(M.logger.log("[decrypter.ts]: "+E),this.logEnabled=!1)},y}()},"./src/crypt/fast-aes-key.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return C});var C=function(){function A(M,P){this.subtle=void 0,this.key=void 0,this.subtle=M,this.key=P}var D=A.prototype;return D.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},A}()},"./src/demux/aacdemuxer.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/demux/base-audio-demuxer.ts"),A=T("./src/demux/adts.ts"),D=T("./src/utils/logger.ts"),M=T("./src/demux/id3.ts");function P(g,y){g.prototype=Object.create(y.prototype),g.prototype.constructor=g,R(g,y)}function R(g,y){return R=Object.setPrototypeOf||function(p,E){return p.__proto__=E,p},R(g,y)}var L=function(g){P(y,g);function y(p,E){var m;return m=g.call(this)||this,m.observer=void 0,m.config=void 0,m.observer=p,m.config=E,m}var S=y.prototype;return S.resetInitSegment=function(E,m,u){g.prototype.resetInitSegment.call(this,E,m,u),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,isAAC:!0,samples:[],manifestCodec:E,duration:u,inputTimeScale:9e4,dropped:0}},y.probe=function(E){if(!E)return!1;for(var m=M.getID3Data(E,0)||[],u=m.length,t=E.length;u<t;u++)if(A.probe(E,u))return D.logger.log("ADTS sync word found !"),!0;return!1},S.canParse=function(E,m){return A.canParse(E,m)},S.appendFrame=function(E,m,u){A.initTrackConfig(E,this.observer,m,u,E.manifestCodec);var t=A.appendFrame(E,m,u,this.initPTS,this.frameIndex);if(t&&t.missing===0)return t},y}(C.default);L.minProbeByteLength=9,b.default=L},"./src/demux/adts.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"getAudioConfig",function(){return M}),T.d(b,"isHeaderPattern",function(){return P}),T.d(b,"getHeaderLength",function(){return R}),T.d(b,"getFullFrameLength",function(){return L}),T.d(b,"canGetFrameLength",function(){return g}),T.d(b,"isHeader",function(){return y}),T.d(b,"canParse",function(){return S}),T.d(b,"probe",function(){return p}),T.d(b,"initTrackConfig",function(){return E}),T.d(b,"getFrameDuration",function(){return m}),T.d(b,"parseFrameHeader",function(){return u}),T.d(b,"appendFrame",function(){return t});var C=T("./src/utils/logger.ts"),A=T("./src/errors.ts"),D=T("./src/events.ts");function M(r,e,f,s){var l,h,d,o,a=navigator.userAgent.toLowerCase(),i=s,n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];l=((e[f+2]&192)>>>6)+1;var v=(e[f+2]&60)>>>2;if(v>n.length-1){r.trigger(D.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+v});return}return d=(e[f+2]&1)<<2,d|=(e[f+3]&192)>>>6,C.logger.log("manifest codec:"+s+", ADTS type:"+l+", samplingIndex:"+v),/firefox/i.test(a)?v>=6?(l=5,o=new Array(4),h=v-3):(l=2,o=new Array(2),h=v):a.indexOf("android")!==-1?(l=2,o=new Array(2),h=v):(l=5,o=new Array(4),s&&(s.indexOf("mp4a.40.29")!==-1||s.indexOf("mp4a.40.5")!==-1)||!s&&v>=6?h=v-3:((s&&s.indexOf("mp4a.40.2")!==-1&&(v>=6&&d===1||/vivaldi/i.test(a))||!s&&d===1)&&(l=2,o=new Array(2)),h=v)),o[0]=l<<3,o[0]|=(v&14)>>1,o[1]|=(v&1)<<7,o[1]|=d<<3,l===5&&(o[1]|=(h&14)>>1,o[2]=(h&1)<<7,o[2]|=2<<2,o[3]=0),{config:o,samplerate:n[v],channelCount:d,codec:"mp4a.40."+l,manifestCodec:i}}function P(r,e){return r[e]===255&&(r[e+1]&246)===240}function R(r,e){return r[e+1]&1?7:9}function L(r,e){return(r[e+3]&3)<<11|r[e+4]<<3|(r[e+5]&224)>>>5}function g(r,e){return e+5<r.length}function y(r,e){return e+1<r.length&&P(r,e)}function S(r,e){return g(r,e)&&P(r,e)&&L(r,e)<=r.length-e}function p(r,e){if(y(r,e)){var f=R(r,e);if(e+f>=r.length)return!1;var s=L(r,e);if(s<=f)return!1;var l=e+s;return l===r.length||y(r,l)}return!1}function E(r,e,f,s,l){if(!r.samplerate){var h=M(e,f,s,l);if(!h)return;r.config=h.config,r.samplerate=h.samplerate,r.channelCount=h.channelCount,r.codec=h.codec,r.manifestCodec=h.manifestCodec,C.logger.log("parsed codec:"+r.codec+", rate:"+h.samplerate+", channels:"+h.channelCount)}}function m(r){return 1024*9e4/r}function u(r,e,f,s,l){var h=R(r,e),d=L(r,e);if(d-=h,d>0){var o=f+s*l;return{headerLength:h,frameLength:d,stamp:o}}}function t(r,e,f,s,l){var h=m(r.samplerate),d=u(e,f,s,l,h);if(d){var o=d.frameLength,a=d.headerLength,i=d.stamp,n=a+o,v=Math.max(0,f+n-e.length),c;v?(c=new Uint8Array(n-a),c.set(e.subarray(f+a,e.length),0)):c=e.subarray(f+a,f+n);var x={unit:c,pts:i};return v||r.samples.push(x),{sample:x,length:n,missing:v}}}},"./src/demux/base-audio-demuxer.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"initPTSFn",function(){return L});var C=T("./src/polyfills/number.ts"),A=T("./src/demux/id3.ts"),D=T("./src/demux/dummy-demuxed-track.ts"),M=T("./src/utils/mp4-tools.ts"),P=T("./src/utils/typed-array.ts"),R=function(){function g(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.initPTS=null}var y=g.prototype;return y.resetInitSegment=function(p,E,m){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},y.resetTimeStamp=function(){},y.resetContiguity=function(){},y.canParse=function(p,E){return!1},y.appendFrame=function(p,E,m){},y.demux=function(p,E){this.cachedData&&(p=Object(M.appendUint8Array)(this.cachedData,p),this.cachedData=null);var m=A.getID3Data(p,0),u=m?m.length:0,t,r,e=this._audioTrack,f=this._id3Track,s=m?A.getTimeStamp(m):void 0,l=p.length;for((this.frameIndex===0||this.initPTS===null)&&(this.initPTS=L(s,E)),m&&m.length>0&&f.samples.push({pts:this.initPTS,dts:this.initPTS,data:m}),r=this.initPTS;u<l;){if(this.canParse(p,u)){var h=this.appendFrame(e,p,u);h?(this.frameIndex++,r=h.sample.pts,u+=h.length,t=u):u=l}else A.canParse(p,u)?(m=A.getID3Data(p,u),f.samples.push({pts:r,dts:r,data:m}),u+=m.length,t=u):u++;if(u===l&&t!==l){var d=Object(P.sliceUint8)(p,t);this.cachedData?this.cachedData=Object(M.appendUint8Array)(this.cachedData,d):this.cachedData=d}}return{audioTrack:e,avcTrack:Object(D.dummyTrack)(),id3Track:f,textTrack:Object(D.dummyTrack)()}},y.demuxSampleAes=function(p,E,m){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},y.flush=function(p){var E=this.cachedData;return E&&(this.cachedData=null,this.demux(E,0)),this.frameIndex=0,{audioTrack:this._audioTrack,avcTrack:Object(D.dummyTrack)(),id3Track:this._id3Track,textTrack:Object(D.dummyTrack)()}},y.destroy=function(){},g}(),L=function(y,S){return Object(C.isFiniteNumber)(y)?y*90:S*9e4};b.default=R},"./src/demux/chunk-cache.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return C});var C=function(){function D(){this.chunks=[],this.dataLength=0}var M=D.prototype;return M.push=function(R){this.chunks.push(R),this.dataLength+=R.length},M.flush=function(){var R=this.chunks,L=this.dataLength,g;if(R.length)R.length===1?g=R[0]:g=A(R,L);else return new Uint8Array(0);return this.reset(),g},M.reset=function(){this.chunks.length=0,this.dataLength=0},D}();function A(D,M){for(var P=new Uint8Array(M),R=0,L=0;L<D.length;L++){var g=D[L];P.set(g,R),R+=g.length}return P}},"./src/demux/dummy-demuxed-track.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"dummyTrack",function(){return C});function C(){return{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}},"./src/demux/exp-golomb.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/utils/logger.ts"),A=function(){function D(P){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=P,this.bytesAvailable=P.byteLength,this.word=0,this.bitsAvailable=0}var M=D.prototype;return M.loadWord=function(){var R=this.data,L=this.bytesAvailable,g=R.byteLength-L,y=new Uint8Array(4),S=Math.min(4,L);if(S===0)throw new Error("no bytes available");y.set(R.subarray(g,g+S)),this.word=new DataView(y.buffer).getUint32(0),this.bitsAvailable=S*8,this.bytesAvailable-=S},M.skipBits=function(R){var L;this.bitsAvailable>R?(this.word<<=R,this.bitsAvailable-=R):(R-=this.bitsAvailable,L=R>>3,R-=L>>3,this.bytesAvailable-=L,this.loadWord(),this.word<<=R,this.bitsAvailable-=R)},M.readBits=function(R){var L=Math.min(this.bitsAvailable,R),g=this.word>>>32-L;return R>32&&C.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=L,this.bitsAvailable>0?this.word<<=L:this.bytesAvailable>0&&this.loadWord(),L=R-L,L>0&&this.bitsAvailable?g<<L|this.readBits(L):g},M.skipLZ=function(){var R;for(R=0;R<this.bitsAvailable;++R)if((this.word&2147483648>>>R)!==0)return this.word<<=R,this.bitsAvailable-=R,R;return this.loadWord(),R+this.skipLZ()},M.skipUEG=function(){this.skipBits(1+this.skipLZ())},M.skipEG=function(){this.skipBits(1+this.skipLZ())},M.readUEG=function(){var R=this.skipLZ();return this.readBits(R+1)-1},M.readEG=function(){var R=this.readUEG();return 1&R?1+R>>>1:-1*(R>>>1)},M.readBoolean=function(){return this.readBits(1)===1},M.readUByte=function(){return this.readBits(8)},M.readUShort=function(){return this.readBits(16)},M.readUInt=function(){return this.readBits(32)},M.skipScalingList=function(R){for(var L=8,g=8,y,S=0;S<R;S++)g!==0&&(y=this.readEG(),g=(L+y+256)%256),L=g===0?L:g},M.readSPS=function(){var R=0,L=0,g=0,y=0,S,p,E,m=this.readUByte.bind(this),u=this.readBits.bind(this),t=this.readUEG.bind(this),r=this.readBoolean.bind(this),e=this.skipBits.bind(this),f=this.skipEG.bind(this),s=this.skipUEG.bind(this),l=this.skipScalingList.bind(this);m();var h=m();if(u(5),e(3),m(),s(),h===100||h===110||h===122||h===244||h===44||h===83||h===86||h===118||h===128){var d=t();if(d===3&&e(1),s(),s(),e(1),r())for(p=d!==3?8:12,E=0;E<p;E++)r()&&(E<6?l(16):l(64))}s();var o=t();if(o===0)t();else if(o===1)for(e(1),f(),f(),S=t(),E=0;E<S;E++)f();s(),e(1);var a=t(),i=t(),n=u(1);n===0&&e(1),e(1),r()&&(R=t(),L=t(),g=t(),y=t());var v=[1,1];if(r()&&r()){var c=m();switch(c){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:{v=[m()<<8|m(),m()<<8|m()];break}}}return{width:Math.ceil((a+1)*16-R*2-L*2),height:(2-n)*(i+1)*16-(n?2:4)*(g+y),pixelRatio:v}},M.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},D}();b.default=A},"./src/demux/id3.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"isHeader",function(){return C}),T.d(b,"isFooter",function(){return A}),T.d(b,"getID3Data",function(){return D}),T.d(b,"canParse",function(){return P}),T.d(b,"getTimeStamp",function(){return R}),T.d(b,"isTimeStampFrame",function(){return L}),T.d(b,"getID3Frames",function(){return y}),T.d(b,"decodeFrame",function(){return S}),T.d(b,"utf8ArrayToStr",function(){return t}),T.d(b,"testables",function(){return r});var C=function(l,h){return h+10<=l.length&&l[h]===73&&l[h+1]===68&&l[h+2]===51&&l[h+3]<255&&l[h+4]<255&&l[h+6]<128&&l[h+7]<128&&l[h+8]<128&&l[h+9]<128},A=function(l,h){return h+10<=l.length&&l[h]===51&&l[h+1]===68&&l[h+2]===73&&l[h+3]<255&&l[h+4]<255&&l[h+6]<128&&l[h+7]<128&&l[h+8]<128&&l[h+9]<128},D=function(l,h){for(var d=h,o=0;C(l,h);){o+=10;var a=M(l,h+6);o+=a,A(l,h+10)&&(o+=10),h+=o}if(o>0)return l.subarray(d,d+o)},M=function(l,h){var d=0;return d=(l[h]&127)<<21,d|=(l[h+1]&127)<<14,d|=(l[h+2]&127)<<7,d|=l[h+3]&127,d},P=function(l,h){return C(l,h)&&M(l,h+6)+10<=l.length-h},R=function(l){for(var h=y(l),d=0;d<h.length;d++){var o=h[d];if(L(o))return u(o)}},L=function(l){return l&&l.key==="PRIV"&&l.info==="com.apple.streaming.transportStreamTimestamp"},g=function(l){var h=String.fromCharCode(l[0],l[1],l[2],l[3]),d=M(l,4),o=10;return{type:h,size:d,data:l.subarray(o,o+d)}},y=function(l){for(var h=0,d=[];C(l,h);){var o=M(l,h+6);h+=10;for(var a=h+o;h+8<a;){var i=g(l.subarray(h)),n=S(i);n&&d.push(n),h+=i.size+10}A(l,h)&&(h+=10)}return d},S=function(l){return l.type==="PRIV"?p(l):l.type[0]==="W"?m(l):E(l)},p=function(l){if(!(l.size<2)){var h=t(l.data,!0),d=new Uint8Array(l.data.subarray(h.length+1));return{key:l.type,info:h,data:d.buffer}}},E=function(l){if(!(l.size<2)){if(l.type==="TXXX"){var h=1,d=t(l.data.subarray(h),!0);h+=d.length+1;var o=t(l.data.subarray(h));return{key:l.type,info:d,data:o}}var a=t(l.data.subarray(1));return{key:l.type,data:a}}},m=function(l){if(l.type==="WXXX"){if(l.size<2)return;var h=1,d=t(l.data.subarray(h),!0);h+=d.length+1;var o=t(l.data.subarray(h));return{key:l.type,info:d,data:o}}var a=t(l.data);return{key:l.type,data:a}},u=function(l){if(l.data.byteLength===8){var h=new Uint8Array(l.data),d=h[3]&1,o=(h[4]<<23)+(h[5]<<15)+(h[6]<<7)+h[7];return o/=45,d&&(o+=4772185884e-2),Math.round(o)}},t=function(l,h){h===void 0&&(h=!1);var d=f();if(d){var o=d.decode(l);if(h){var a=o.indexOf("\0");return a!==-1?o.substring(0,a):o}return o.replace(/\0/g,"")}for(var i=l.length,n,v,c,x="",O=0;O<i;){if(n=l[O++],n===0&&h)return x;if(n===0||n===3)continue;switch(n>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:x+=String.fromCharCode(n);break;case 12:case 13:v=l[O++],x+=String.fromCharCode((n&31)<<6|v&63);break;case 14:v=l[O++],c=l[O++],x+=String.fromCharCode((n&15)<<12|(v&63)<<6|(c&63)<<0);break;default:}}return x},r={decodeTextFrame:E},e;function f(){return!e&&typeof self.TextDecoder!="undefined"&&(e=new self.TextDecoder("utf-8")),e}},"./src/demux/mp3demuxer.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/demux/base-audio-demuxer.ts"),A=T("./src/demux/id3.ts"),D=T("./src/utils/logger.ts"),M=T("./src/demux/mpegaudio.ts");function P(g,y){g.prototype=Object.create(y.prototype),g.prototype.constructor=g,R(g,y)}function R(g,y){return R=Object.setPrototypeOf||function(p,E){return p.__proto__=E,p},R(g,y)}var L=function(g){P(y,g);function y(){return g.apply(this,arguments)||this}var S=y.prototype;return S.resetInitSegment=function(E,m,u){g.prototype.resetInitSegment.call(this,E,m,u),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,isAAC:!1,samples:[],manifestCodec:E,duration:u,inputTimeScale:9e4,dropped:0}},y.probe=function(E){if(!E)return!1;for(var m=A.getID3Data(E,0)||[],u=m.length,t=E.length;u<t;u++)if(M.probe(E,u))return D.logger.log("MPEG Audio sync word found !"),!0;return!1},S.canParse=function(E,m){return M.canParse(E,m)},S.appendFrame=function(E,m,u){if(this.initPTS!==null)return M.appendFrame(E,m,u,this.initPTS,this.frameIndex)},y}(C.default);L.minProbeByteLength=4,b.default=L},"./src/demux/mp4demuxer.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/utils/mp4-tools.ts"),A=T("./src/demux/dummy-demuxed-track.ts"),D=function(){function M(R,L){this.remainderData=null,this.config=void 0,this.config=L}var P=M.prototype;return P.resetTimeStamp=function(){},P.resetInitSegment=function(){},P.resetContiguity=function(){},M.probe=function(L){return Object(C.findBox)({data:L,start:0,end:Math.min(L.length,16384)},["moof"]).length>0},P.demux=function(L){var g=L,y=Object(A.dummyTrack)();if(this.config.progressive){this.remainderData&&(g=Object(C.appendUint8Array)(this.remainderData,L));var S=Object(C.segmentValidRange)(g);this.remainderData=S.remainder,y.samples=S.valid||new Uint8Array}else y.samples=g;return{audioTrack:Object(A.dummyTrack)(),avcTrack:y,id3Track:Object(A.dummyTrack)(),textTrack:Object(A.dummyTrack)()}},P.flush=function(){var L=Object(A.dummyTrack)();return L.samples=this.remainderData||new Uint8Array,this.remainderData=null,{audioTrack:Object(A.dummyTrack)(),avcTrack:L,id3Track:Object(A.dummyTrack)(),textTrack:Object(A.dummyTrack)()}},P.demuxSampleAes=function(L,g,y){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},P.destroy=function(){},M}();D.minProbeByteLength=1024,b.default=D},"./src/demux/mpegaudio.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"appendFrame",function(){return R}),T.d(b,"parseHeader",function(){return L}),T.d(b,"isHeaderPattern",function(){return g}),T.d(b,"isHeader",function(){return y}),T.d(b,"canParse",function(){return S}),T.d(b,"probe",function(){return p});var C=null,A=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],D=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],M=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],P=[0,1,1,4];function R(E,m,u,t,r){if(!(u+24>m.length)){var e=L(m,u);if(e&&u+e.frameLength<=m.length){var f=e.samplesPerFrame*9e4/e.sampleRate,s=t+r*f,l={unit:m.subarray(u,u+e.frameLength),pts:s,dts:s};return E.config=[],E.channelCount=e.channelCount,E.samplerate=e.sampleRate,E.samples.push(l),{sample:l,length:e.frameLength,missing:0}}}}function L(E,m){var u=E[m+1]>>3&3,t=E[m+1]>>1&3,r=E[m+2]>>4&15,e=E[m+2]>>2&3;if(u!==1&&r!==0&&r!==15&&e!==3){var f=E[m+2]>>1&1,s=E[m+3]>>6,l=u===3?3-t:t===3?3:4,h=A[l*14+r-1]*1e3,d=u===3?0:u===2?1:2,o=D[d*3+e],a=s===3?1:2,i=M[u][t],n=P[t],v=i*8*n,c=Math.floor(i*h/o+f)*n;if(C===null){var x=navigator.userAgent||"",O=x.match(/Chrome\/(\d+)/i);C=O?parseInt(O[1]):0}var I=!!C&&C<=87;return I&&t===2&&h>=224e3&&s===0&&(E[m+3]=E[m+3]|128),{sampleRate:o,channelCount:a,frameLength:c,samplesPerFrame:v}}}function g(E,m){return E[m]===255&&(E[m+1]&224)===224&&(E[m+1]&6)!==0}function y(E,m){return m+1<E.length&&g(E,m)}function S(E,m){var u=4;return g(E,m)&&u<=E.length-m}function p(E,m){if(m+1<E.length&&g(E,m)){var u=4,t=L(E,m),r=u;t!=null&&t.frameLength&&(r=t.frameLength);var e=m+r;return e===E.length||y(E,e)}return!1}},"./src/demux/sample-aes.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/crypt/decrypter.ts"),A=T("./src/demux/tsdemuxer.ts"),D=function(){function M(R,L,g){this.keyData=void 0,this.decrypter=void 0,this.keyData=g,this.decrypter=new C.default(R,L,{removePKCS7Padding:!1})}var P=M.prototype;return P.decryptBuffer=function(L,g){this.decrypter.decrypt(L,this.keyData.key.buffer,this.keyData.iv.buffer,g)},P.decryptAacSample=function(L,g,y,S){var p=L[g].unit,E=p.subarray(16,p.length-p.length%16),m=E.buffer.slice(E.byteOffset,E.byteOffset+E.length),u=this;this.decryptBuffer(m,function(t){var r=new Uint8Array(t);p.set(r,16),S||u.decryptAacSamples(L,g+1,y)})},P.decryptAacSamples=function(L,g,y){for(;;g++){if(g>=L.length){y();return}if(!(L[g].unit.length<32)){var S=this.decrypter.isSync();if(this.decryptAacSample(L,g,y,S),!S)return}}},P.getAvcEncryptedData=function(L){for(var g=Math.floor((L.length-48)/160)*16+16,y=new Int8Array(g),S=0,p=32;p<L.length-16;p+=160,S+=16)y.set(L.subarray(p,p+16),S);return y},P.getAvcDecryptedUnit=function(L,g){for(var y=new Uint8Array(g),S=0,p=32;p<L.length-16;p+=160,S+=16)L.set(y.subarray(S,S+16),p);return L},P.decryptAvcSample=function(L,g,y,S,p,E){var m=Object(A.discardEPB)(p.data),u=this.getAvcEncryptedData(m),t=this;this.decryptBuffer(u.buffer,function(r){p.data=t.getAvcDecryptedUnit(m,r),E||t.decryptAvcSamples(L,g,y+1,S)})},P.decryptAvcSamples=function(L,g,y,S){if(L instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;g++,y=0){if(g>=L.length){S();return}for(var p=L[g].units;!(y>=p.length);y++){var E=p[y];if(!(E.data.length<=48||E.type!==1&&E.type!==5)){var m=this.decrypter.isSync();if(this.decryptAvcSample(L,g,y,S,E,m),!m)return}}}},M}();b.default=D},"./src/demux/transmuxer-interface.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return p});var C=T("./node_modules/webworkify-webpack/index.js"),A=T.n(C),D=T("./src/events.ts"),M=T("./src/demux/transmuxer.ts"),P=T("./src/utils/logger.ts"),R=T("./src/errors.ts"),L=T("./src/utils/mediasource-helper.ts"),g=T("./node_modules/eventemitter3/index.js"),y=T.n(g),S=Object(L.getMediaSource)()||{isTypeSupported:function(){return!1}},p=function(){function E(u,t,r,e){var f=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.hls=u,this.id=t,this.onTransmuxComplete=r,this.onFlush=e;var s=u.config,l=function(i,n){n=n||{},n.frag=f.frag,n.id=f.id,u.trigger(i,n)};this.observer=new g.EventEmitter,this.observer.on(D.Events.FRAG_DECRYPTED,l),this.observer.on(D.Events.ERROR,l);var h={mp4:S.isTypeSupported("video/mp4"),mpeg:S.isTypeSupported("audio/mpeg"),mp3:S.isTypeSupported('audio/mp4; codecs="mp3"')},d=navigator.vendor;if(s.enableWorker&&typeof Worker!="undefined"){P.logger.log("demuxing in webworker");var o;try{o=this.worker=C("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),o.addEventListener("message",this.onwmsg),o.onerror=function(a){u.trigger(D.Events.ERROR,{type:R.ErrorTypes.OTHER_ERROR,details:R.ErrorDetails.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",error:new Error(a.message+"  ("+a.filename+":"+a.lineno+")")})},o.postMessage({cmd:"init",typeSupported:h,vendor:d,id:t,config:JSON.stringify(s)})}catch(a){P.logger.warn("Error in worker:",a),P.logger.error("Error while initializing DemuxerWorker, fallback to inline"),o&&self.URL.revokeObjectURL(o.objectURL),this.transmuxer=new M.default(this.observer,h,s,d,t),this.worker=null}}else this.transmuxer=new M.default(this.observer,h,s,d,t)}var m=E.prototype;return m.destroy=function(){var t=this.worker;if(t)t.removeEventListener("message",this.onwmsg),t.terminate(),this.worker=null;else{var r=this.transmuxer;r&&(r.destroy(),this.transmuxer=null)}var e=this.observer;e&&e.removeAllListeners(),this.observer=null},m.push=function(t,r,e,f,s,l,h,d,o,a){var i,n,v=this;o.transmuxing.start=self.performance.now();var c=this.transmuxer,x=this.worker,O=l?l.start:s.start,I=s.decryptdata,F=this.frag,B=!(F&&s.cc===F.cc),U=!(F&&o.level===F.level),k=F?o.sn-F.sn:-1,N=this.part?o.part-this.part.index:1,K=!U&&(k===1||k===0&&N===1),W=self.performance.now();(U||k||s.stats.parsing.start===0)&&(s.stats.parsing.start=W),l&&(N||!K)&&(l.stats.parsing.start=W);var w=!(F&&((i=s.initSegment)===null||i===void 0?void 0:i.url)===((n=F.initSegment)===null||n===void 0?void 0:n.url)),H=new M.TransmuxState(B,K,d,U,O,w);if(!K||B||w){P.logger.log("[transmuxer-interface, "+s.type+"]: Starting new transmux session for sn: "+o.sn+" p: "+o.part+" level: "+o.level+" id: "+o.id+`
        discontinuity: `+B+`
        trackSwitch: `+U+`
        contiguous: `+K+`
        accurateTimeOffset: `+d+`
        timeOffset: `+O+`
        initSegmentChange: `+w);var V=new M.TransmuxConfig(e,f,r,h,a);this.configureTransmuxer(V)}if(this.frag=s,this.part=l,x)x.postMessage({cmd:"demux",data:t,decryptdata:I,chunkMeta:o,state:H},t instanceof ArrayBuffer?[t]:[]);else if(c){var j=c.push(t,I,o,H);Object(M.isPromise)(j)?j.then(function(X){v.handleTransmuxComplete(X)}):this.handleTransmuxComplete(j)}},m.flush=function(t){var r=this;t.transmuxing.start=self.performance.now();var e=this.transmuxer,f=this.worker;if(f)f.postMessage({cmd:"flush",chunkMeta:t});else if(e){var s=e.flush(t);Object(M.isPromise)(s)?s.then(function(l){r.handleFlushResult(l,t)}):this.handleFlushResult(s,t)}},m.handleFlushResult=function(t,r){var e=this;t.forEach(function(f){e.handleTransmuxComplete(f)}),this.onFlush(r)},m.onWorkerMessage=function(t){var r=t.data,e=this.hls;switch(r.event){case"init":{self.URL.revokeObjectURL(this.worker.objectURL);break}case"transmuxComplete":{this.handleTransmuxComplete(r.data);break}case"flush":{this.onFlush(r.data);break}default:{r.data=r.data||{},r.data.frag=this.frag,r.data.id=this.id,e.trigger(r.event,r.data);break}}},m.configureTransmuxer=function(t){var r=this.worker,e=this.transmuxer;r?r.postMessage({cmd:"configure",config:t}):e&&e.configure(t)},m.handleTransmuxComplete=function(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)},E}()},"./src/demux/transmuxer-worker.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return R});var C=T("./src/demux/transmuxer.ts"),A=T("./src/events.ts"),D=T("./src/utils/logger.ts"),M=T("./node_modules/eventemitter3/index.js"),P=T.n(M);function R(p){var E=new M.EventEmitter,m=function(t,r){p.postMessage({event:t,data:r})};E.on(A.Events.FRAG_DECRYPTED,m),E.on(A.Events.ERROR,m),p.addEventListener("message",function(u){var t=u.data;switch(t.cmd){case"init":{var r=JSON.parse(t.config);p.transmuxer=new C.default(E,t.typeSupported,r,t.vendor,t.id),Object(D.enableLogs)(r.debug),m("init",null);break}case"configure":{p.transmuxer.configure(t.config);break}case"demux":{var e=p.transmuxer.push(t.data,t.decryptdata,t.chunkMeta,t.state);Object(C.isPromise)(e)?e.then(function(l){L(p,l)}):L(p,e);break}case"flush":{var f=t.chunkMeta,s=p.transmuxer.flush(f);Object(C.isPromise)(s)?s.then(function(l){y(p,l,f)}):y(p,s,f);break}default:break}})}function L(p,E){if(!S(E.remuxResult)){var m=[],u=E.remuxResult,t=u.audio,r=u.video;t&&g(m,t),r&&g(m,r),p.postMessage({event:"transmuxComplete",data:E},m)}}function g(p,E){E.data1&&p.push(E.data1.buffer),E.data2&&p.push(E.data2.buffer)}function y(p,E,m){E.forEach(function(u){L(p,u)}),p.postMessage({event:"flush",data:m})}function S(p){return!p.audio&&!p.video&&!p.text&&!p.id3&&!p.initSegment}},"./src/demux/transmuxer.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return r}),T.d(b,"isPromise",function(){return s}),T.d(b,"TransmuxConfig",function(){return l}),T.d(b,"TransmuxState",function(){return h});var C=T("./src/events.ts"),A=T("./src/errors.ts"),D=T("./src/crypt/decrypter.ts"),M=T("./src/demux/aacdemuxer.ts"),P=T("./src/demux/mp4demuxer.ts"),R=T("./src/demux/tsdemuxer.ts"),L=T("./src/demux/mp3demuxer.ts"),g=T("./src/remux/mp4-remuxer.ts"),y=T("./src/remux/passthrough-remuxer.ts"),S=T("./src/demux/chunk-cache.ts"),p=T("./src/utils/mp4-tools.ts"),E=T("./src/utils/logger.ts"),m;try{m=self.performance.now.bind(self.performance)}catch(d){E.logger.debug("Unable to use Performance API on this environment"),m=self.Date.now}var u=[{demux:R.default,remux:g.default},{demux:P.default,remux:y.default},{demux:M.default,remux:g.default},{demux:L.default,remux:g.default}],t=1024;u.forEach(function(d){var o=d.demux;t=Math.max(t,o.minProbeByteLength)});var r=function(){function d(a,i,n,v,c){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.cache=new S.default,this.observer=a,this.typeSupported=i,this.config=n,this.vendor=v,this.id=c}var o=d.prototype;return o.configure=function(i){this.transmuxConfig=i,this.decrypter&&this.decrypter.reset()},o.push=function(i,n,v,c){var x=this,O=v.transmuxing;O.executeStart=m();var I=new Uint8Array(i),F=this.cache,B=this.config,U=this.currentTransmuxState,k=this.transmuxConfig;c&&(this.currentTransmuxState=c);var N=e(I,n);if(N&&N.method==="AES-128"){var K=this.getDecrypter();if(B.enableSoftwareAES){var W=K.softwareDecrypt(I,N.key.buffer,N.iv.buffer);if(!W)return O.executeEnd=m(),f(v);I=new Uint8Array(W)}else return this.decryptionPromise=K.webCryptoDecrypt(I,N.key.buffer,N.iv.buffer).then(function(at){var rt=x.push(at,null,v);return x.decryptionPromise=null,rt}),this.decryptionPromise}var w=c||U,H=w.contiguous,V=w.discontinuity,j=w.trackSwitch,X=w.accurateTimeOffset,Y=w.timeOffset,$=w.initSegmentChange,_=k.audioCodec,z=k.videoCodec,J=k.defaultInitPts,Q=k.duration,et=k.initSegmentData;if((V||j||$)&&this.resetInitSegment(et,_,z,Q),(V||$)&&this.resetInitialTimestamp(J),H||this.resetContiguity(),this.needsProbing(I,V,j)){if(F.dataLength){var Z=F.flush();I=Object(p.appendUint8Array)(Z,I)}this.configureTransmuxer(I,k)}var it=this.transmux(I,N,Y,X,v),tt=this.currentTransmuxState;return tt.contiguous=!0,tt.discontinuity=!1,tt.trackSwitch=!1,O.executeEnd=m(),it},o.flush=function(i){var n=this,v=i.transmuxing;v.executeStart=m();var c=this.decrypter,x=this.cache,O=this.currentTransmuxState,I=this.decryptionPromise;if(I)return I.then(function(){return n.flush(i)});var F=[],B=O.timeOffset;if(c){var U=c.flush();U&&F.push(this.push(U,null,i))}var k=x.dataLength;x.reset();var N=this.demuxer,K=this.remuxer;if(!N||!K)return k>=t&&this.observer.emit(C.Events.ERROR,C.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),v.executeEnd=m(),[f(i)];var W=N.flush(B);return s(W)?W.then(function(w){return n.flushRemux(F,w,i),F}):(this.flushRemux(F,W,i),F)},o.flushRemux=function(i,n,v){var c=n.audioTrack,x=n.avcTrack,O=n.id3Track,I=n.textTrack,F=this.currentTransmuxState,B=F.accurateTimeOffset,U=F.timeOffset;E.logger.log("[transmuxer.ts]: Flushed fragment "+v.sn+(v.part>-1?" p: "+v.part:"")+" of level "+v.level);var k=this.remuxer.remux(c,x,O,I,U,B,!0,this.id);i.push({remuxResult:k,chunkMeta:v}),v.transmuxing.executeEnd=m()},o.resetInitialTimestamp=function(i){var n=this.demuxer,v=this.remuxer;!n||!v||(n.resetTimeStamp(i),v.resetTimeStamp(i))},o.resetContiguity=function(){var i=this.demuxer,n=this.remuxer;!i||!n||(i.resetContiguity(),n.resetNextTimestamp())},o.resetInitSegment=function(i,n,v,c){var x=this.demuxer,O=this.remuxer;!x||!O||(x.resetInitSegment(n,v,c),O.resetInitSegment(i,n,v))},o.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},o.transmux=function(i,n,v,c,x){var O;return n&&n.method==="SAMPLE-AES"?O=this.transmuxSampleAes(i,n,v,c,x):O=this.transmuxUnencrypted(i,v,c,x),O},o.transmuxUnencrypted=function(i,n,v,c){var x=this.demuxer.demux(i,n,!1,!this.config.progressive),O=x.audioTrack,I=x.avcTrack,F=x.id3Track,B=x.textTrack,U=this.remuxer.remux(O,I,F,B,n,v,!1,this.id);return{remuxResult:U,chunkMeta:c}},o.transmuxSampleAes=function(i,n,v,c,x){var O=this;return this.demuxer.demuxSampleAes(i,n,v).then(function(I){var F=O.remuxer.remux(I.audioTrack,I.avcTrack,I.id3Track,I.textTrack,v,c,!1,O.id);return{remuxResult:F,chunkMeta:x}})},o.configureTransmuxer=function(i,n){for(var v=this.config,c=this.observer,x=this.typeSupported,O=this.vendor,I=n.audioCodec,F=n.defaultInitPts,B=n.duration,U=n.initSegmentData,k=n.videoCodec,N,K=0,W=u.length;K<W;K++)if(u[K].demux.probe(i)){N=u[K];break}N||(E.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),N={demux:P.default,remux:y.default});var w=this.demuxer,H=this.remuxer,V=N.remux,j=N.demux;(!H||!(H instanceof V))&&(this.remuxer=new V(c,v,x,O)),(!w||!(w instanceof j))&&(this.demuxer=new j(c,v,x),this.probe=j.probe),this.resetInitSegment(U,I,k,B),this.resetInitialTimestamp(F)},o.needsProbing=function(i,n,v){return!this.demuxer||!this.remuxer||n||v},o.getDecrypter=function(){var i=this.decrypter;return i||(i=this.decrypter=new D.default(this.observer,this.config)),i},d}();function e(d,o){var a=null;return d.byteLength>0&&o!=null&&o.key!=null&&o.iv!==null&&o.method!=null&&(a=o),a}var f=function(o){return{remuxResult:{},chunkMeta:o}};function s(d){return"then"in d&&d.then instanceof Function}var l=function(o,a,i,n,v){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=o,this.videoCodec=a,this.initSegmentData=i,this.duration=n,this.defaultInitPts=v},h=function(o,a,i,n,v,c){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=o,this.contiguous=a,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=v,this.initSegmentChange=c}},"./src/demux/tsdemuxer.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"discardEPB",function(){return f});var C=T("./src/demux/adts.ts"),A=T("./src/demux/mpegaudio.ts"),D=T("./src/demux/exp-golomb.ts"),M=T("./src/demux/id3.ts"),P=T("./src/demux/sample-aes.ts"),R=T("./src/events.ts"),L=T("./src/utils/mp4-tools.ts"),g=T("./src/utils/logger.ts"),y=T("./src/errors.ts"),S={video:1,audio:2,id3:3,text:4},p=function(){function s(h,d,o){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this.aacLastPTS=null,this._initPTS=null,this._initDTS=null,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=h,this.config=d,this.typeSupported=o}s.probe=function(d){var o=s.syncOffset(d);return o<0?!1:(o&&g.logger.warn("MPEG2-TS detected but first sync word found @ offset "+o+", junk ahead ?"),!0)},s.syncOffset=function(d){for(var o=Math.min(1e3,d.length-564),a=0;a<o;){if(d[a]===71&&d[a+188]===71&&d[a+2*188]===71)return a;a++}return-1},s.createTrack=function(d,o){return{container:d==="video"||d==="audio"?"video/mp2t":void 0,type:d,id:S[d],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:d==="audio"?o:void 0}};var l=s.prototype;return l.resetInitSegment=function(d,o,a){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=s.createTrack("video",a),this._audioTrack=s.createTrack("audio",a),this._id3Track=s.createTrack("id3",a),this._txtTrack=s.createTrack("text",a),this._audioTrack.isAAC=!0,this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=d,this.videoCodec=o,this._duration=a},l.resetTimeStamp=function(){},l.resetContiguity=function(){var d=this._audioTrack,o=this._avcTrack,a=this._id3Track;d&&(d.pesData=null),o&&(o.pesData=null),a&&(a.pesData=null),this.aacOverFlow=null,this.aacLastPTS=null},l.demux=function(d,o,a,i){a===void 0&&(a=!1),i===void 0&&(i=!1),a||(this.sampleAes=null);var n,v=this._avcTrack,c=this._audioTrack,x=this._id3Track,O=v.pid,I=v.pesData,F=c.pid,B=x.pid,U=c.pesData,k=x.pesData,N=!1,K=this.pmtParsed,W=this._pmtId,w=d.length;if(this.remainderData&&(d=Object(L.appendUint8Array)(this.remainderData,d),w=d.length,this.remainderData=null),w<188&&!i)return this.remainderData=d,{audioTrack:c,avcTrack:v,id3Track:x,textTrack:this._txtTrack};var H=Math.max(0,s.syncOffset(d));w-=(w+H)%188,w<d.byteLength&&!i&&(this.remainderData=new Uint8Array(d.buffer,w,d.buffer.byteLength-w));for(var V=0,j=H;j<w;j+=188)if(d[j]===71){var X=!!(d[j+1]&64),Y=((d[j+1]&31)<<8)+d[j+2],$=(d[j+3]&48)>>4,_=void 0;if($>1){if(_=j+5+d[j+4],_===j+188)continue}else _=j+4;switch(Y){case O:X&&(I&&(n=t(I))&&this.parseAVCPES(n,!1),I={data:[],size:0}),I&&(I.data.push(d.subarray(_,j+188)),I.size+=j+188-_);break;case F:X&&(U&&(n=t(U))&&(c.isAAC?this.parseAACPES(n):this.parseMPEGPES(n)),U={data:[],size:0}),U&&(U.data.push(d.subarray(_,j+188)),U.size+=j+188-_);break;case B:X&&(k&&(n=t(k))&&this.parseID3PES(n),k={data:[],size:0}),k&&(k.data.push(d.subarray(_,j+188)),k.size+=j+188-_);break;case 0:X&&(_+=d[_]+1),W=this._pmtId=m(d,_);break;case W:{X&&(_+=d[_]+1);var z=u(d,_,this.typeSupported.mpeg===!0||this.typeSupported.mp3===!0,a);O=z.avc,O>0&&(v.pid=O),F=z.audio,F>0&&(c.pid=F,c.isAAC=z.isAAC),B=z.id3,B>0&&(x.pid=B),N&&!K&&(g.logger.log("reparse from beginning"),N=!1,j=H-188),K=this.pmtParsed=!0;break}case 17:case 8191:break;default:N=!0;break}}else V++;V>0&&this.observer.emit(R.Events.ERROR,R.Events.ERROR,{type:y.ErrorTypes.MEDIA_ERROR,details:y.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+V+" TS packet/s that do not start with 0x47"}),v.pesData=I,c.pesData=U,x.pesData=k;var J={audioTrack:c,avcTrack:v,id3Track:x,textTrack:this._txtTrack};return i&&this.extractRemainingSamples(J),J},l.flush=function(){var d=this.remainderData;this.remainderData=null;var o;return d?o=this.demux(d,-1,!1,!0):o={audioTrack:this._audioTrack,avcTrack:this._avcTrack,textTrack:this._txtTrack,id3Track:this._id3Track},this.extractRemainingSamples(o),this.sampleAes?this.decrypt(o,this.sampleAes):o},l.extractRemainingSamples=function(d){var o=d.audioTrack,a=d.avcTrack,i=d.id3Track,n=a.pesData,v=o.pesData,c=i.pesData,x;n&&(x=t(n))?(this.parseAVCPES(x,!0),a.pesData=null):a.pesData=n,v&&(x=t(v))?(o.isAAC?this.parseAACPES(x):this.parseMPEGPES(x),o.pesData=null):(v!=null&&v.size&&g.logger.log("last AAC PES packet truncated,might overlap between fragments"),o.pesData=v),c&&(x=t(c))?(this.parseID3PES(x),i.pesData=null):i.pesData=c},l.demuxSampleAes=function(d,o,a){var i=this.demux(d,a,!0,!this.config.progressive),n=this.sampleAes=new P.default(this.observer,this.config,o);return this.decrypt(i,n)},l.decrypt=function(d,o){return new Promise(function(a){var i=d.audioTrack,n=d.avcTrack;i.samples&&i.isAAC?o.decryptAacSamples(i.samples,0,function(){n.samples?o.decryptAvcSamples(n.samples,0,0,function(){a(d)}):a(d)}):n.samples&&o.decryptAvcSamples(n.samples,0,0,function(){a(d)})})},l.destroy=function(){this._initPTS=this._initDTS=null,this._duration=0},l.parseAVCPES=function(d,o){var a=this,i=this._avcTrack,n=this.parseAVCNALu(d.data),v=!1,c=this.avcSample,x,O=!1;d.data=null,c&&n.length&&!i.audFound&&(r(c,i),c=this.avcSample=E(!1,d.pts,d.dts,"")),n.forEach(function(I){switch(I.type){case 1:{x=!0,c||(c=a.avcSample=E(!0,d.pts,d.dts,"")),v&&(c.debug+="NDR "),c.frame=!0;var F=I.data;if(O&&F.length>4){var B=new D.default(F).readSliceType();(B===2||B===4||B===7||B===9)&&(c.key=!0)}break}case 5:x=!0,c||(c=a.avcSample=E(!0,d.pts,d.dts,"")),v&&(c.debug+="IDR "),c.key=!0,c.frame=!0;break;case 6:{x=!0,v&&c&&(c.debug+="SEI ");var U=new D.default(f(I.data));U.readUByte();for(var k=0,N=0,K=!1,W=0;!K&&U.bytesAvailable>1;){k=0;do W=U.readUByte(),k+=W;while(W===255);N=0;do W=U.readUByte(),N+=W;while(W===255);if(k===4&&U.bytesAvailable!==0){K=!0;var w=U.readUByte();if(w===181){var H=U.readUShort();if(H===49){var V=U.readUInt();if(V===1195456820){var j=U.readUByte();if(j===3){for(var X=U.readUByte(),Y=U.readUByte(),$=31&X,_=[X,Y],z=0;z<$;z++)_.push(U.readUByte()),_.push(U.readUByte()),_.push(U.readUByte());e(a._txtTrack.samples,{type:3,pts:d.pts,bytes:_})}}}}}else if(k===5&&U.bytesAvailable!==0){if(K=!0,N>16){for(var J=[],Q=0;Q<16;Q++)J.push(U.readUByte().toString(16)),(Q===3||Q===5||Q===7||Q===9)&&J.push("-");for(var et=N-16,Z=new Uint8Array(et),it=0;it<et;it++)Z[it]=U.readUByte();e(a._txtTrack.samples,{pts:d.pts,payloadType:k,uuid:J.join(""),userData:Object(M.utf8ArrayToStr)(Z),userDataBytes:Z})}}else if(N<U.bytesAvailable)for(var tt=0;tt<N;tt++)U.readUByte()}break}case 7:if(x=!0,O=!0,v&&c&&(c.debug+="SPS "),!i.sps){var at=new D.default(I.data),rt=at.readSPS();i.width=rt.width,i.height=rt.height,i.pixelRatio=rt.pixelRatio,i.sps=[I.data],i.duration=a._duration;for(var st=I.data.subarray(1,4),ut="avc1.",q=0;q<3;q++){var ot=st[q].toString(16);ot.length<2&&(ot="0"+ot),ut+=ot}i.codec=ut}break;case 8:x=!0,v&&c&&(c.debug+="PPS "),i.pps||(i.pps=[I.data]);break;case 9:x=!1,i.audFound=!0,c&&r(c,i),c=a.avcSample=E(!1,d.pts,d.dts,v?"AUD ":"");break;case 12:x=!1;break;default:x=!1,c&&(c.debug+="unknown NAL "+I.type+" ");break}if(c&&x){var vt=c.units;vt.push(I)}}),o&&c&&(r(c,i),this.avcSample=null)},l.getLastNalUnit=function(){var d,o=this.avcSample,a;if(!o||o.units.length===0){var i=this._avcTrack.samples;o=i[i.length-1]}if((d=o)!==null&&d!==void 0&&d.units){var n=o.units;a=n[n.length-1]}return a},l.parseAVCNALu=function(d){var o=d.byteLength,a=this._avcTrack,i=a.naluState||0,n=i,v=[],c=0,x,O,I,F=-1,B=0;for(i===-1&&(F=0,B=d[0]&31,i=0,c=1);c<o;){if(x=d[c++],!i){i=x?0:1;continue}if(i===1){i=x?0:2;continue}if(!x)i=3;else if(x===1){if(F>=0){var U={data:d.subarray(F,c-i-1),type:B};v.push(U)}else{var k=this.getLastNalUnit();if(k&&(n&&c<=4-n&&k.state&&(k.data=k.data.subarray(0,k.data.byteLength-n)),O=c-i-1,O>0)){var N=new Uint8Array(k.data.byteLength+O);N.set(k.data,0),N.set(d.subarray(0,O),k.data.byteLength),k.data=N,k.state=0}}c<o?(I=d[c]&31,F=c,B=I,i=0):i=-1}else i=0}if(F>=0&&i>=0){var K={data:d.subarray(F,o),type:B,state:i};v.push(K)}if(v.length===0){var W=this.getLastNalUnit();if(W){var w=new Uint8Array(W.data.byteLength+d.byteLength);w.set(W.data,0),w.set(d,W.data.byteLength),W.data=w}}return a.naluState=i,v},l.parseAACPES=function(d){var o=0,a=this._audioTrack,i=this.aacOverFlow,n=d.data;if(i){this.aacOverFlow=null;var v=i.sample.unit.byteLength,c=Math.min(i.missing,v),x=v-c;i.sample.unit.set(n.subarray(0,c),x),a.samples.push(i.sample),o=i.missing}var O,I;for(O=o,I=n.length;O<I-1&&!C.isHeader(n,O);O++);if(O!==o){var F,B;if(O<I-1?(F="AAC PES did not start with ADTS header,offset:"+O,B=!1):(F="no ADTS header found in AAC PES",B=!0),g.logger.warn("parsing error:"+F),this.observer.emit(R.Events.ERROR,R.Events.ERROR,{type:y.ErrorTypes.MEDIA_ERROR,details:y.ErrorDetails.FRAG_PARSING_ERROR,fatal:B,reason:F}),B)return}C.initTrackConfig(a,this.observer,n,O,this.audioCodec);var U;if(d.pts!==void 0)U=d.pts;else if(i){var k=C.getFrameDuration(a.samplerate);U=i.sample.pts+k}else{g.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var N=0;O<I;)if(C.isHeader(n,O)){if(O+5<I){var K=C.appendFrame(a,n,O,U,N);if(K)if(K.missing)this.aacOverFlow=K;else{O+=K.length,N++;continue}}break}else O++},l.parseMPEGPES=function(d){var o=d.data,a=o.length,i=0,n=0,v=d.pts;if(v===void 0){g.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;n<a;)if(A.isHeader(o,n)){var c=A.appendFrame(this._audioTrack,o,n,v,i);if(c)n+=c.length,i++;else break}else n++},l.parseID3PES=function(d){if(d.pts===void 0){g.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}this._id3Track.samples.push(d)},s}();p.minProbeByteLength=188;function E(s,l,h,d){return{key:s,frame:!1,pts:l,dts:h,units:[],debug:d,length:0}}function m(s,l){return(s[l+10]&31)<<8|s[l+11]}function u(s,l,h,d){var o={audio:-1,avc:-1,id3:-1,isAAC:!0},a=(s[l+1]&15)<<8|s[l+2],i=l+3+a-4,n=(s[l+10]&15)<<8|s[l+11];for(l+=12+n;l<i;){var v=(s[l+1]&31)<<8|s[l+2];switch(s[l]){case 207:if(!d){g.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:o.audio===-1&&(o.audio=v);break;case 21:o.id3===-1&&(o.id3=v);break;case 219:if(!d){g.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:o.avc===-1&&(o.avc=v);break;case 3:case 4:h?o.audio===-1&&(o.audio=v,o.isAAC=!1):g.logger.log("MPEG audio found, not supported in this browser");break;case 36:g.logger.warn("Unsupported HEVC stream type found");break;default:break}l+=((s[l+3]&15)<<8|s[l+4])+5}return o}function t(s){var l=0,h,d,o,a,i,n=s.data;if(!s||s.size===0)return null;for(;n[0].length<19&&n.length>1;){var v=new Uint8Array(n[0].length+n[1].length);v.set(n[0]),v.set(n[1],n[0].length),n[0]=v,n.splice(1,1)}h=n[0];var c=(h[0]<<16)+(h[1]<<8)+h[2];if(c===1){if(d=(h[4]<<8)+h[5],d&&d>s.size-6)return null;var x=h[7];x&192&&(a=(h[9]&14)*536870912+(h[10]&255)*4194304+(h[11]&254)*16384+(h[12]&255)*128+(h[13]&254)/2,x&64?(i=(h[14]&14)*536870912+(h[15]&255)*4194304+(h[16]&254)*16384+(h[17]&255)*128+(h[18]&254)/2,a-i>60*9e4&&(g.logger.warn(Math.round((a-i)/9e4)+"s delta between PTS and DTS, align them"),a=i)):i=a),o=h[8];var O=o+9;if(s.size<=O)return null;s.size-=O;for(var I=new Uint8Array(s.size),F=0,B=n.length;F<B;F++){h=n[F];var U=h.byteLength;if(O)if(O>U){O-=U;continue}else h=h.subarray(O),U-=O,O=0;I.set(h,l),l+=U}return d&&(d-=o+3),{data:I,pts:a,dts:i,len:d}}return null}function r(s,l){if(s.units.length&&s.frame){if(s.pts===void 0){var h=l.samples,d=h.length;if(d){var o=h[d-1];s.pts=o.pts,s.dts=o.dts}else{l.dropped++;return}}l.samples.push(s)}s.debug.length&&g.logger.log(s.pts+"/"+s.dts+":"+s.debug)}function e(s,l){var h=s.length;if(h>0){if(l.pts>=s[h-1].pts)s.push(l);else for(var d=h-1;d>=0;d--)if(l.pts<s[d].pts){s.splice(d,0,l);break}}else s.push(l)}function f(s){for(var l=s.byteLength,h=[],d=1;d<l-2;)s[d]===0&&s[d+1]===0&&s[d+2]===3?(h.push(d+2),d+=2):d++;if(h.length===0)return s;var o=l-h.length,a=new Uint8Array(o),i=0;for(d=0;d<o;i++,d++)i===h[0]&&(i++,h.shift()),a[d]=s[i];return a}b.default=p},"./src/errors.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"ErrorTypes",function(){return C}),T.d(b,"ErrorDetails",function(){return A});var C;(function(D){D.NETWORK_ERROR="networkError",D.MEDIA_ERROR="mediaError",D.KEY_SYSTEM_ERROR="keySystemError",D.MUX_ERROR="muxError",D.OTHER_ERROR="otherError"})(C||(C={}));var A;(function(D){D.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",D.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",D.KEY_SYSTEM_NO_SESSION="keySystemNoSession",D.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",D.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",D.MANIFEST_LOAD_ERROR="manifestLoadError",D.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",D.MANIFEST_PARSING_ERROR="manifestParsingError",D.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",D.LEVEL_EMPTY_ERROR="levelEmptyError",D.LEVEL_LOAD_ERROR="levelLoadError",D.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",D.LEVEL_SWITCH_ERROR="levelSwitchError",D.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",D.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",D.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",D.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",D.FRAG_LOAD_ERROR="fragLoadError",D.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",D.FRAG_DECRYPT_ERROR="fragDecryptError",D.FRAG_PARSING_ERROR="fragParsingError",D.REMUX_ALLOC_ERROR="remuxAllocError",D.KEY_LOAD_ERROR="keyLoadError",D.KEY_LOAD_TIMEOUT="keyLoadTimeOut",D.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",D.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",D.BUFFER_APPEND_ERROR="bufferAppendError",D.BUFFER_APPENDING_ERROR="bufferAppendingError",D.BUFFER_STALLED_ERROR="bufferStalledError",D.BUFFER_FULL_ERROR="bufferFullError",D.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",D.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",D.INTERNAL_EXCEPTION="internalException",D.INTERNAL_ABORTED="aborted",D.UNKNOWN="unknown"})(A||(A={}))},"./src/events.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"Events",function(){return C});var C;(function(A){A.MEDIA_ATTACHING="hlsMediaAttaching",A.MEDIA_ATTACHED="hlsMediaAttached",A.MEDIA_DETACHING="hlsMediaDetaching",A.MEDIA_DETACHED="hlsMediaDetached",A.BUFFER_RESET="hlsBufferReset",A.BUFFER_CODECS="hlsBufferCodecs",A.BUFFER_CREATED="hlsBufferCreated",A.BUFFER_APPENDING="hlsBufferAppending",A.BUFFER_APPENDED="hlsBufferAppended",A.BUFFER_EOS="hlsBufferEos",A.BUFFER_FLUSHING="hlsBufferFlushing",A.BUFFER_FLUSHED="hlsBufferFlushed",A.MANIFEST_LOADING="hlsManifestLoading",A.MANIFEST_LOADED="hlsManifestLoaded",A.MANIFEST_PARSED="hlsManifestParsed",A.LEVEL_SWITCHING="hlsLevelSwitching",A.LEVEL_SWITCHED="hlsLevelSwitched",A.LEVEL_LOADING="hlsLevelLoading",A.LEVEL_LOADED="hlsLevelLoaded",A.LEVEL_UPDATED="hlsLevelUpdated",A.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",A.LEVELS_UPDATED="hlsLevelsUpdated",A.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",A.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",A.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",A.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",A.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",A.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",A.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",A.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",A.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",A.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",A.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",A.CUES_PARSED="hlsCuesParsed",A.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",A.INIT_PTS_FOUND="hlsInitPtsFound",A.FRAG_LOADING="hlsFragLoading",A.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",A.FRAG_LOADED="hlsFragLoaded",A.FRAG_DECRYPTED="hlsFragDecrypted",A.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",A.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",A.FRAG_PARSING_METADATA="hlsFragParsingMetadata",A.FRAG_PARSED="hlsFragParsed",A.FRAG_BUFFERED="hlsFragBuffered",A.FRAG_CHANGED="hlsFragChanged",A.FPS_DROP="hlsFpsDrop",A.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",A.ERROR="hlsError",A.DESTROYING="hlsDestroying",A.KEY_LOADING="hlsKeyLoading",A.KEY_LOADED="hlsKeyLoaded",A.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",A.BACK_BUFFER_REACHED="hlsBackBufferReached"})(C||(C={}))},"./src/hls.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return s});var C=T("./node_modules/url-toolkit/src/url-toolkit.js"),A=T.n(C),D=T("./src/loader/playlist-loader.ts"),M=T("./src/loader/key-loader.ts"),P=T("./src/controller/id3-track-controller.ts"),R=T("./src/controller/latency-controller.ts"),L=T("./src/controller/level-controller.ts"),g=T("./src/controller/fragment-tracker.ts"),y=T("./src/controller/stream-controller.ts"),S=T("./src/is-supported.ts"),p=T("./src/utils/logger.ts"),E=T("./src/config.ts"),m=T("./node_modules/eventemitter3/index.js"),u=T.n(m),t=T("./src/events.ts"),r=T("./src/errors.ts");function e(l,h){for(var d=0;d<h.length;d++){var o=h[d];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(l,o.key,o)}}function f(l,h,d){return h&&e(l.prototype,h),d&&e(l,d),l}var s=function(){l.isSupported=function(){return Object(S.isSupported)()};function l(d){d===void 0&&(d={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new m.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var o=this.config=Object(E.mergeConfig)(l.DefaultConfig,d);this.userConfig=d,Object(p.enableLogs)(o.debug),this._autoLevelCapping=-1,o.progressive&&Object(E.enableStreamingMode)(o);var a=o.abrController,i=o.bufferController,n=o.capLevelController,v=o.fpsController,c=this.abrController=new a(this),x=this.bufferController=new i(this),O=this.capLevelController=new n(this),I=new v(this),F=new D.default(this),B=new M.default(this),U=new P.default(this),k=this.levelController=new L.default(this),N=new g.FragmentTracker(this),K=this.streamController=new y.default(this,N);O.setStreamController(K),I.setStreamController(K);var W=[k,K];this.networkControllers=W;var w=[F,B,c,x,O,I,U,N];this.audioTrackController=this.createController(o.audioTrackController,null,W),this.createController(o.audioStreamController,N,W),this.subtitleTrackController=this.createController(o.subtitleTrackController,null,W),this.createController(o.subtitleStreamController,N,W),this.createController(o.timelineController,null,w),this.emeController=this.createController(o.emeController,null,w),this.cmcdController=this.createController(o.cmcdController,null,w),this.latencyController=this.createController(R.default,null,w),this.coreComponents=w}var h=l.prototype;return h.createController=function(o,a,i){if(o){var n=a?new o(this,a):new o(this);return i&&i.push(n),n}return null},h.on=function(o,a,i){i===void 0&&(i=this),this._emitter.on(o,a,i)},h.once=function(o,a,i){i===void 0&&(i=this),this._emitter.once(o,a,i)},h.removeAllListeners=function(o){this._emitter.removeAllListeners(o)},h.off=function(o,a,i,n){i===void 0&&(i=this),this._emitter.off(o,a,i,n)},h.listeners=function(o){return this._emitter.listeners(o)},h.emit=function(o,a,i){return this._emitter.emit(o,a,i)},h.trigger=function(o,a){if(this.config.debug)return this.emit(o,o,a);try{return this.emit(o,o,a)}catch(i){p.logger.error("An internal error happened while handling event "+o+'. Error message: "'+i.message+'". Here is a stacktrace:',i),this.trigger(t.Events.ERROR,{type:r.ErrorTypes.OTHER_ERROR,details:r.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:o,error:i})}return!1},h.listenerCount=function(o){return this._emitter.listenerCount(o)},h.destroy=function(){p.logger.log("destroy"),this.trigger(t.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(o){return o.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(o){return o.destroy()}),this.coreComponents.length=0},h.attachMedia=function(o){p.logger.log("attachMedia"),this._media=o,this.trigger(t.Events.MEDIA_ATTACHING,{media:o})},h.detachMedia=function(){p.logger.log("detachMedia"),this.trigger(t.Events.MEDIA_DETACHING,void 0),this._media=null},h.loadSource=function(o){this.stopLoad();var a=this.media,i=this.url,n=this.url=C.buildAbsoluteURL(self.location.href,o,{alwaysNormalize:!0});p.logger.log("loadSource:"+n),a&&i&&i!==n&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(a)),this.trigger(t.Events.MANIFEST_LOADING,{url:o})},h.startLoad=function(o){o===void 0&&(o=-1),p.logger.log("startLoad("+o+")"),this.networkControllers.forEach(function(a){a.startLoad(o)})},h.stopLoad=function(){p.logger.log("stopLoad"),this.networkControllers.forEach(function(o){o.stopLoad()})},h.swapAudioCodec=function(){p.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},h.recoverMediaError=function(){p.logger.log("recoverMediaError");var o=this._media;this.detachMedia(),o&&this.attachMedia(o)},h.removeLevel=function(o,a){a===void 0&&(a=0),this.levelController.removeLevel(o,a)},f(l,[{key:"levels",get:function(){var o=this.levelController.levels;return o||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(o){p.logger.log("set currentLevel:"+o),this.loadLevel=o,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(o){p.logger.log("set nextLevel:"+o),this.levelController.manualLevel=o,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(o){p.logger.log("set loadLevel:"+o),this.levelController.manualLevel=o}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(o){this.levelController.nextLoadLevel=o}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(o){p.logger.log("set firstLevel:"+o),this.levelController.firstLevel=o}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(o){p.logger.log("set startLevel:"+o),o!==-1&&(o=Math.max(o,this.minAutoLevel)),this.levelController.startLevel=o}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(o){var a=!!o;a!==this.config.capLevelToPlayerSize&&(a?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=a)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(o){this._autoLevelCapping!==o&&(p.logger.log("set autoLevelCapping:"+o),this._autoLevelCapping=o)}},{key:"bandwidthEstimate",get:function(){var o=this.abrController.bwEstimator;return o?o.getEstimate():NaN}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var o=this.levels,a=this.config.minAutoBitrate;if(!o)return 0;for(var i=o.length,n=0;n<i;n++)if(o[n].maxBitrate>a)return n;return 0}},{key:"maxAutoLevel",get:function(){var o=this.levels,a=this.autoLevelCapping,i;return a===-1&&o&&o.length?i=o.length-1:i=a,i}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(o){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,o)}},{key:"audioTracks",get:function(){var o=this.audioTrackController;return o?o.audioTracks:[]}},{key:"audioTrack",get:function(){var o=this.audioTrackController;return o?o.audioTrack:-1},set:function(o){var a=this.audioTrackController;a&&(a.audioTrack=o)}},{key:"subtitleTracks",get:function(){var o=this.subtitleTrackController;return o?o.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var o=this.subtitleTrackController;return o?o.subtitleTrack:-1},set:function(o){var a=this.subtitleTrackController;a&&(a.subtitleTrack=o)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var o=this.subtitleTrackController;return o?o.subtitleDisplay:!1},set:function(o){var a=this.subtitleTrackController;a&&(a.subtitleDisplay=o)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(o){this.config.lowLatencyMode=o}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.1.3"}},{key:"Events",get:function(){return t.Events}},{key:"ErrorTypes",get:function(){return r.ErrorTypes}},{key:"ErrorDetails",get:function(){return r.ErrorDetails}},{key:"DefaultConfig",get:function(){return l.defaultConfig?l.defaultConfig:E.hlsDefaultConfig},set:function(o){l.defaultConfig=o}}]),l}();s.defaultConfig=void 0},"./src/is-supported.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"isSupported",function(){return D}),T.d(b,"changeTypeSupported",function(){return M});var C=T("./src/utils/mediasource-helper.ts");function A(){return self.SourceBuffer||self.WebKitSourceBuffer}function D(){var P=Object(C.getMediaSource)();if(!P)return!1;var R=A(),L=P&&typeof P.isTypeSupported=="function"&&P.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),g=!R||R.prototype&&typeof R.prototype.appendBuffer=="function"&&typeof R.prototype.remove=="function";return!!L&&!!g}function M(){var P,R=A();return typeof(R==null||(P=R.prototype)===null||P===void 0?void 0:P.changeType)=="function"}},"./src/loader/fragment-loader.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return p}),T.d(b,"LoadError",function(){return m});var C=T("./src/polyfills/number.ts"),A=T("./src/errors.ts");function D(u,t){u.prototype=Object.create(t.prototype),u.prototype.constructor=u,g(u,t)}function M(u){var t=typeof Map=="function"?new Map:void 0;return M=function(e){if(e===null||!L(e))return e;if(typeof e!="function")throw new TypeError("Super expression must either be null or a function");if(typeof t!="undefined"){if(t.has(e))return t.get(e);t.set(e,f)}function f(){return P(e,arguments,y(this).constructor)}return f.prototype=Object.create(e.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),g(f,e)},M(u)}function P(u,t,r){return R()?P=Reflect.construct:P=function(f,s,l){var h=[null];h.push.apply(h,s);var d=Function.bind.apply(f,h),o=new d;return l&&g(o,l.prototype),o},P.apply(null,arguments)}function R(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(u){return!1}}function L(u){return Function.toString.call(u).indexOf("[native code]")!==-1}function g(u,t){return g=Object.setPrototypeOf||function(e,f){return e.__proto__=f,e},g(u,t)}function y(u){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(r){return r.__proto__||Object.getPrototypeOf(r)},y(u)}var S=Math.pow(2,17),p=function(){function u(r){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=r}var t=u.prototype;return t.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},t.abort=function(){this.loader&&this.loader.abort()},t.load=function(e,f){var s=this,l=e.url;if(!l)return Promise.reject(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,networkDetails:null},"Fragment does not have a "+(l?"part list":"url")));this.abort();var h=this.config,d=h.fLoader,o=h.loader;return new Promise(function(a,i){s.loader&&s.loader.destroy();var n=s.loader=e.loader=d?new d(h):new o(h),v=E(e),c={timeout:h.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:h.fragLoadingMaxRetryTimeout,highWaterMark:S};e.stats=n.stats,n.load(v,c,{onSuccess:function(O,I,F,B){s.resetLoader(e,n),a({frag:e,part:null,payload:O.data,networkDetails:B})},onError:function(O,I,F){s.resetLoader(e,n),i(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:O,networkDetails:F}))},onAbort:function(O,I,F){s.resetLoader(e,n),i(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,networkDetails:F}))},onTimeout:function(O,I,F){s.resetLoader(e,n),i(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,networkDetails:F}))},onProgress:function(O,I,F,B){f&&f({frag:e,part:null,payload:F,networkDetails:B})}})})},t.loadPart=function(e,f,s){var l=this;this.abort();var h=this.config,d=h.fLoader,o=h.loader;return new Promise(function(a,i){l.loader&&l.loader.destroy();var n=l.loader=e.loader=d?new d(h):new o(h),v=E(e,f),c={timeout:h.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:h.fragLoadingMaxRetryTimeout,highWaterMark:S};f.stats=n.stats,n.load(v,c,{onSuccess:function(O,I,F,B){l.resetLoader(e,n),l.updateStatsFromPart(e,f);var U={frag:e,part:f,payload:O.data,networkDetails:B};s(U),a(U)},onError:function(O,I,F){l.resetLoader(e,n),i(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:f,response:O,networkDetails:F}))},onAbort:function(O,I,F){e.stats.aborted=f.stats.aborted,l.resetLoader(e,n),i(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,part:f,networkDetails:F}))},onTimeout:function(O,I,F){l.resetLoader(e,n),i(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:f,networkDetails:F}))}})})},t.updateStatsFromPart=function(e,f){var s=e.stats,l=f.stats,h=l.total;if(s.loaded+=l.loaded,h){var d=Math.round(e.duration/f.duration),o=Math.min(Math.round(s.loaded/h),d),a=d-o,i=a*Math.round(s.loaded/o);s.total=s.loaded+i}else s.total=Math.max(s.loaded,s.total);var n=s.loading,v=l.loading;n.start?n.first+=v.first-v.start:(n.start=v.start,n.first=v.first),n.end=v.end},t.resetLoader=function(e,f){e.loader=null,this.loader===f&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),f.destroy()},u}();function E(u,t){t===void 0&&(t=null);var r=t||u,e={frag:u,part:t,responseType:"arraybuffer",url:r.url,headers:{},rangeStart:0,rangeEnd:0},f=r.byteRangeStartOffset,s=r.byteRangeEndOffset;return Object(C.isFiniteNumber)(f)&&Object(C.isFiniteNumber)(s)&&(e.rangeStart=f,e.rangeEnd=s),e}var m=function(u){D(t,u);function t(r){for(var e,f=arguments.length,s=new Array(f>1?f-1:0),l=1;l<f;l++)s[l-1]=arguments[l];return e=u.call.apply(u,[this].concat(s))||this,e.data=void 0,e.data=r,e}return t}(M(Error))},"./src/loader/fragment.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"ElementaryStreamTypes",function(){return p}),T.d(b,"BaseSegment",function(){return E}),T.d(b,"Fragment",function(){return m}),T.d(b,"Part",function(){return u});var C=T("./src/polyfills/number.ts"),A=T("./node_modules/url-toolkit/src/url-toolkit.js"),D=T.n(A),M=T("./src/utils/logger.ts"),P=T("./src/loader/level-key.ts"),R=T("./src/loader/load-stats.ts");function L(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,g(t,r)}function g(t,r){return g=Object.setPrototypeOf||function(f,s){return f.__proto__=s,f},g(t,r)}function y(t,r){for(var e=0;e<r.length;e++){var f=r[e];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(t,f.key,f)}}function S(t,r,e){return r&&y(t.prototype,r),e&&y(t,e),t}var p;(function(t){t.AUDIO="audio",t.VIDEO="video",t.AUDIOVIDEO="audiovideo"})(p||(p={}));var E=function(){function t(e){var f;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(f={},f[p.AUDIO]=null,f[p.VIDEO]=null,f[p.AUDIOVIDEO]=null,f),this.baseurl=e}var r=t.prototype;return r.setByteRange=function(f,s){var l=f.split("@",2),h=[];l.length===1?h[0]=s?s.byteRangeEndOffset:0:h[0]=parseInt(l[1]),h[1]=parseInt(l[0])+h[0],this._byteRange=h},S(t,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Object(A.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(f){this._url=f}}]),t}(),m=function(t){L(r,t);function r(f,s){var l;return l=t.call(this,s)||this,l._decryptdata=null,l.rawProgramDateTime=null,l.programDateTime=null,l.tagList=[],l.duration=0,l.sn=0,l.levelkey=void 0,l.type=void 0,l.loader=null,l.level=-1,l.cc=0,l.startPTS=void 0,l.endPTS=void 0,l.appendedPTS=void 0,l.startDTS=void 0,l.endDTS=void 0,l.start=0,l.deltaPTS=void 0,l.maxStartPTS=void 0,l.minEndPTS=void 0,l.stats=new R.LoadStats,l.urlId=0,l.data=void 0,l.bitrateTest=!1,l.title=null,l.initSegment=null,l.type=f,l}var e=r.prototype;return e.createInitializationVector=function(s){for(var l=new Uint8Array(16),h=12;h<16;h++)l[h]=s>>8*(15-h)&255;return l},e.setDecryptDataFromLevelKey=function(s,l){var h=s;return(s==null?void 0:s.method)==="AES-128"&&s.uri&&!s.iv&&(h=P.LevelKey.fromURI(s.uri),h.method=s.method,h.iv=this.createInitializationVector(l),h.keyFormat="identity"),h},e.setElementaryStreamInfo=function(s,l,h,d,o,a){a===void 0&&(a=!1);var i=this.elementaryStreams,n=i[s];if(!n){i[s]={startPTS:l,endPTS:h,startDTS:d,endDTS:o,partial:a};return}n.startPTS=Math.min(n.startPTS,l),n.endPTS=Math.max(n.endPTS,h),n.startDTS=Math.min(n.startDTS,d),n.endDTS=Math.max(n.endDTS,o)},e.clearElementaryStreamInfo=function(){var s=this.elementaryStreams;s[p.AUDIO]=null,s[p.VIDEO]=null,s[p.AUDIOVIDEO]=null},S(r,[{key:"decryptdata",get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var s=this.sn;typeof s!="number"&&(this.levelkey&&this.levelkey.method==="AES-128"&&!this.levelkey.iv&&M.logger.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),s=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,s)}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null||!Object(C.isFiniteNumber)(this.programDateTime))return null;var s=Object(C.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+s*1e3}},{key:"encrypted",get:function(){var s;return!!((s=this.decryptdata)!==null&&s!==void 0&&s.keyFormat&&this.decryptdata.uri)}}]),r}(E),u=function(t){L(r,t);function r(e,f,s,l,h){var d;d=t.call(this,s)||this,d.fragOffset=0,d.duration=0,d.gap=!1,d.independent=!1,d.relurl=void 0,d.fragment=void 0,d.index=void 0,d.stats=new R.LoadStats,d.duration=e.decimalFloatingPoint("DURATION"),d.gap=e.bool("GAP"),d.independent=e.bool("INDEPENDENT"),d.relurl=e.enumeratedString("URI"),d.fragment=f,d.index=l;var o=e.enumeratedString("BYTERANGE");return o&&d.setByteRange(o,h),h&&(d.fragOffset=h.fragOffset+h.duration),d}return S(r,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var f=this.elementaryStreams;return!!(f.audio||f.video||f.audiovideo)}}]),r}(E)},"./src/loader/key-loader.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return M});var C=T("./src/events.ts"),A=T("./src/errors.ts"),D=T("./src/utils/logger.ts"),M=function(){function P(L){this.hls=void 0,this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=L,this._registerListeners()}var R=P.prototype;return R._registerListeners=function(){this.hls.on(C.Events.KEY_LOADING,this.onKeyLoading,this)},R._unregisterListeners=function(){this.hls.off(C.Events.KEY_LOADING,this.onKeyLoading)},R.destroy=function(){this._unregisterListeners();for(var g in this.loaders){var y=this.loaders[g];y&&y.destroy()}this.loaders={}},R.onKeyLoading=function(g,y){var S=y.frag,p=S.type,E=this.loaders[p];if(!S.decryptdata){D.logger.warn("Missing decryption data on fragment in onKeyLoading");return}var m=S.decryptdata.uri;if(m!==this.decrypturl||this.decryptkey===null){var u=this.hls.config;if(E&&(D.logger.warn("abort previous key loader for type:"+p),E.abort()),!m){D.logger.warn("key uri is falsy");return}var t=u.loader,r=S.loader=this.loaders[p]=new t(u);this.decrypturl=m,this.decryptkey=null;var e={url:m,frag:S,responseType:"arraybuffer"},f={timeout:u.fragLoadingTimeOut,maxRetry:0,retryDelay:u.fragLoadingRetryDelay,maxRetryDelay:u.fragLoadingMaxRetryTimeout,highWaterMark:0},s={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};r.load(e,f,s)}else this.decryptkey&&(S.decryptdata.key=this.decryptkey,this.hls.trigger(C.Events.KEY_LOADED,{frag:S}))},R.loadsuccess=function(g,y,S){var p=S.frag;if(!p.decryptdata){D.logger.error("after key load, decryptdata unset");return}this.decryptkey=p.decryptdata.key=new Uint8Array(g.data),p.loader=null,delete this.loaders[p.type],this.hls.trigger(C.Events.KEY_LOADED,{frag:p})},R.loaderror=function(g,y){var S=y.frag,p=S.loader;p&&p.abort(),delete this.loaders[S.type],this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:S,response:g})},R.loadtimeout=function(g,y){var S=y.frag,p=S.loader;p&&p.abort(),delete this.loaders[S.type],this.hls.trigger(C.Events.ERROR,{type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:S})},P}()},"./src/loader/level-details.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"LevelDetails",function(){return P});var C=T("./src/polyfills/number.ts");function A(R,L){for(var g=0;g<L.length;g++){var y=L[g];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(R,y.key,y)}}function D(R,L,g){return L&&A(R.prototype,L),g&&A(R,g),R}var M=10,P=function(){function R(g){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.url=g}var L=R.prototype;return L.reloaded=function(y){if(!y){this.advanced=!0,this.updated=!0;return}var S=this.lastPartSn-y.lastPartSn,p=this.lastPartIndex-y.lastPartIndex;this.updated=this.endSN!==y.endSN||!!p||!!S,this.advanced=this.endSN>y.endSN||S>0||S===0&&p>0,this.updated||this.advanced?this.misses=Math.floor(y.misses*.6):this.misses=y.misses+1,this.availabilityDelay=y.availabilityDelay},D(R,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?Object(C.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||M}},{key:"drift",get:function(){var y=this.driftEndTime-this.driftStartTime;if(y>0){var S=this.driftEnd-this.driftStart;return S*1e3/y}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var y;return(y=this.partList)!==null&&y!==void 0&&y.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var y;return(y=this.fragments)!==null&&y!==void 0&&y.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var y;return(y=this.partList)!==null&&y!==void 0&&y.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var y;return(y=this.partList)!==null&&y!==void 0&&y.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),R}()},"./src/loader/level-key.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"LevelKey",function(){return P});var C=T("./node_modules/url-toolkit/src/url-toolkit.js"),A=T.n(C);function D(R,L){for(var g=0;g<L.length;g++){var y=L[g];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(R,y.key,y)}}function M(R,L,g){return L&&D(R.prototype,L),g&&D(R,g),R}var P=function(){R.fromURL=function(g,y){return new R(g,y)},R.fromURI=function(g){return new R(g)};function R(L,g){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,g?this._uri=Object(C.buildAbsoluteURL)(L,g,{alwaysNormalize:!0}):this._uri=L}return M(R,[{key:"uri",get:function(){return this._uri}}]),R}()},"./src/loader/load-stats.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"LoadStats",function(){return C});var C=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return r});var C=T("./src/polyfills/number.ts"),A=T("./node_modules/url-toolkit/src/url-toolkit.js"),D=T.n(A),M=T("./src/loader/fragment.ts"),P=T("./src/loader/level-details.ts"),R=T("./src/loader/level-key.ts"),L=T("./src/utils/attr-list.ts"),g=T("./src/utils/logger.ts"),y=T("./src/utils/codecs.ts"),S=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,p=/#EXT-X-MEDIA:(.*)/g,E=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),m=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(PLAYLIST-TYPE):(.+)/.source,/#EXT-X-(MEDIA-SEQUENCE): *(\d+)/.source,/#EXT-X-(SKIP):(.+)/.source,/#EXT-X-(TARGETDURATION): *(\d+)/.source,/#EXT-X-(KEY):(.+)/.source,/#EXT-X-(START):(.+)/.source,/#EXT-X-(ENDLIST)/.source,/#EXT-X-(DISCONTINUITY-SEQ)UENCE: *(\d+)/.source,/#EXT-X-(DIS)CONTINUITY/.source,/#EXT-X-(VERSION):(\d+)/.source,/#EXT-X-(MAP):(.+)/.source,/#EXT-X-(SERVER-CONTROL):(.+)/.source,/#EXT-X-(PART-INF):(.+)/.source,/#EXT-X-(GAP)/.source,/#EXT-X-(BITRATE):\s*(\d+)/.source,/#EXT-X-(PART):(.+)/.source,/#EXT-X-(PRELOAD-HINT):(.+)/.source,/#EXT-X-(RENDITION-REPORT):(.+)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),u=/\.(mp4|m4s|m4v|m4a)$/i;function t(h){var d,o;return u.test((d=(o=A.parseURL(h))===null||o===void 0?void 0:o.path)!=null?d:"")}var r=function(){function h(){}return h.findGroup=function(o,a){for(var i=0;i<o.length;i++){var n=o[i];if(n.id===a)return n}},h.convertAVC1ToAVCOTI=function(o){var a=o.split(".");if(a.length>2){var i=a.shift()+".";return i+=parseInt(a.shift()).toString(16),i+=("000"+parseInt(a.shift()).toString(16)).substr(-4),i}return o},h.resolve=function(o,a){return A.buildAbsoluteURL(a,o,{alwaysNormalize:!0})},h.parseMasterPlaylist=function(o,a){var i=[],n={},v=!1;S.lastIndex=0;for(var c;(c=S.exec(o))!=null;)if(c[1]){var x=new L.AttrList(c[1]),O={attrs:x,bitrate:x.decimalInteger("AVERAGE-BANDWIDTH")||x.decimalInteger("BANDWIDTH"),name:x.NAME,url:h.resolve(c[2],a)},I=x.decimalResolution("RESOLUTION");I&&(O.width=I.width,O.height=I.height),e((x.CODECS||"").split(/[ ,]+/).filter(function(B){return B}),O),O.videoCodec&&O.videoCodec.indexOf("avc1")!==-1&&(O.videoCodec=h.convertAVC1ToAVCOTI(O.videoCodec)),i.push(O)}else if(c[3]){var F=new L.AttrList(c[3]);F["DATA-ID"]&&(v=!0,n[F["DATA-ID"]]=F)}return{levels:i,sessionData:v?n:null}},h.parseMasterPlaylistMedia=function(o,a,i,n){n===void 0&&(n=[]);var v,c=[],x=0;for(p.lastIndex=0;(v=p.exec(o))!==null;){var O=new L.AttrList(v[1]);if(O.TYPE===i){var I={attrs:O,bitrate:0,id:x++,groupId:O["GROUP-ID"],instreamId:O["INSTREAM-ID"],name:O.NAME||O.LANGUAGE||"",type:i,default:O.bool("DEFAULT"),autoselect:O.bool("AUTOSELECT"),forced:O.bool("FORCED"),lang:O.LANGUAGE,url:O.URI?h.resolve(O.URI,a):""};if(n.length){var F=h.findGroup(n,I.groupId)||n[0];f(I,F,"audioCodec"),f(I,F,"textCodec")}c.push(I)}}return c},h.parseLevelPlaylist=function(o,a,i,n,v){var c=new P.LevelDetails(a),x=c.fragments,O=null,I=0,F=0,B=0,U=0,k=null,N=new M.Fragment(n,a),K,W,w,H=-1,V=!1;for(E.lastIndex=0,c.m3u8=o;(K=E.exec(o))!==null;){V&&(V=!1,N=new M.Fragment(n,a),N.start=B,N.sn=I,N.cc=U,N.level=i,O&&(N.initSegment=O,N.rawProgramDateTime=O.rawProgramDateTime));var j=K[1];if(j){N.duration=parseFloat(j);var X=(" "+K[2]).slice(1);N.title=X||null,N.tagList.push(X?["INF",j,X]:["INF",j])}else if(K[3])Object(C.isFiniteNumber)(N.duration)&&(N.start=B,w&&(N.levelkey=w),N.sn=I,N.level=i,N.cc=U,N.urlId=v,x.push(N),N.relurl=(" "+K[3]).slice(1),l(N,k),k=N,B+=N.duration,I++,F=0,V=!0);else if(K[4]){var Y=(" "+K[4]).slice(1);k?N.setByteRange(Y,k):N.setByteRange(Y)}else if(K[5])N.rawProgramDateTime=(" "+K[5]).slice(1),N.tagList.push(["PROGRAM-DATE-TIME",N.rawProgramDateTime]),H===-1&&(H=x.length);else{if(K=K[0].match(m),!K){g.logger.warn("No matches on slow regex match for level playlist!");continue}for(W=1;W<K.length&&typeof K[W]=="undefined";W++);var $=(" "+K[W]).slice(1),_=(" "+K[W+1]).slice(1),z=K[W+2]?(" "+K[W+2]).slice(1):"";switch($){case"PLAYLIST-TYPE":c.type=_.toUpperCase();break;case"MEDIA-SEQUENCE":I=c.startSN=parseInt(_);break;case"SKIP":{var J=new L.AttrList(_),Q=J.decimalInteger("SKIPPED-SEGMENTS");if(Object(C.isFiniteNumber)(Q)){c.skippedSegments=Q;for(var et=Q;et--;)x.unshift(null);I+=Q}var Z=J.enumeratedString("RECENTLY-REMOVED-DATERANGES");Z&&(c.recentlyRemovedDateranges=Z.split("	"));break}case"TARGETDURATION":c.targetduration=parseFloat(_);break;case"VERSION":c.version=parseInt(_);break;case"EXTM3U":break;case"ENDLIST":c.live=!1;break;case"#":(_||z)&&N.tagList.push(z?[_,z]:[_]);break;case"DIS":U++;case"GAP":N.tagList.push([$]);break;case"BITRATE":N.tagList.push([$,_]);break;case"DISCONTINUITY-SEQ":U=parseInt(_);break;case"KEY":{var it,tt=new L.AttrList(_),at=tt.enumeratedString("METHOD"),rt=tt.URI,st=tt.hexadecimalInteger("IV"),ut=tt.enumeratedString("KEYFORMATVERSIONS"),q=tt.enumeratedString("KEYID"),ot=(it=tt.enumeratedString("KEYFORMAT"))!=null?it:"identity",vt=["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"];if(vt.indexOf(ot)>-1){g.logger.warn("Keyformat "+ot+" is not supported from the manifest");continue}else if(ot!=="identity")continue;at&&(w=R.LevelKey.fromURL(a,rt),rt&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(at)>=0&&(w.method=at,w.keyFormat=ot,q&&(w.keyID=q),ut&&(w.keyFormatVersions=ut),w.iv=st));break}case"START":{var gt=new L.AttrList(_),dt=gt.decimalFloatingPoint("TIME-OFFSET");Object(C.isFiniteNumber)(dt)&&(c.startTimeOffset=dt);break}case"MAP":{var ct=new L.AttrList(_);N.relurl=ct.URI,ct.BYTERANGE&&N.setByteRange(ct.BYTERANGE),N.level=i,N.sn="initSegment",w&&(N.levelkey=w),N.initSegment=null,O=N,V=!0;break}case"SERVER-CONTROL":{var lt=new L.AttrList(_);c.canBlockReload=lt.bool("CAN-BLOCK-RELOAD"),c.canSkipUntil=lt.optionalFloat("CAN-SKIP-UNTIL",0),c.canSkipDateRanges=c.canSkipUntil>0&&lt.bool("CAN-SKIP-DATERANGES"),c.partHoldBack=lt.optionalFloat("PART-HOLD-BACK",0),c.holdBack=lt.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{var Tt=new L.AttrList(_);c.partTarget=Tt.decimalFloatingPoint("PART-TARGET");break}case"PART":{var nt=c.partList;nt||(nt=c.partList=[]);var ht=F>0?nt[nt.length-1]:void 0,St=F++,mt=new M.Part(new L.AttrList(_),N,a,St,ht);nt.push(mt),N.duration+=mt.duration;break}case"PRELOAD-HINT":{var Et=new L.AttrList(_);c.preloadHint=Et;break}case"RENDITION-REPORT":{var Lt=new L.AttrList(_);c.renditionReports=c.renditionReports||[],c.renditionReports.push(Lt);break}default:g.logger.warn("line parsed but not handled: "+K);break}}}k&&!k.relurl?(x.pop(),B-=k.duration,c.partList&&(c.fragmentHint=k)):c.partList&&(l(N,k),N.cc=U,c.fragmentHint=N);var pt=x.length,ft=x[0],yt=x[pt-1];if(B+=c.skippedSegments*c.targetduration,B>0&&pt&&yt){c.averagetargetduration=B/pt;var Dt=yt.sn;c.endSN=Dt!=="initSegment"?Dt:0,ft&&(c.startCC=ft.cc,ft.initSegment||c.fragments.every(function(xt){return xt.relurl&&t(xt.relurl)})&&(g.logger.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),N=new M.Fragment(n,a),N.relurl=yt.relurl,N.level=i,N.sn="initSegment",ft.initSegment=N,c.needSidxRanges=!0))}else c.endSN=0,c.startCC=0;return c.fragmentHint&&(B+=c.fragmentHint.duration),c.totalduration=B,c.endCC=U,H>0&&s(x,H),c},h}();function e(h,d){["video","audio","text"].forEach(function(o){var a=h.filter(function(n){return Object(y.isCodecType)(n,o)});if(a.length){var i=a.filter(function(n){return n.lastIndexOf("avc1",0)===0||n.lastIndexOf("mp4a",0)===0});d[o+"Codec"]=i.length>0?i[0]:a[0],h=h.filter(function(n){return a.indexOf(n)===-1})}}),d.unknownCodecs=h}function f(h,d,o){var a=d[o];a&&(h[o]=a)}function s(h,d){for(var o=h[d],a=d;a--;){var i=h[a];if(!i)return;i.programDateTime=o.programDateTime-i.duration*1e3,o=i}}function l(h,d){h.rawProgramDateTime?h.programDateTime=Date.parse(h.rawProgramDateTime):d!=null&&d.programDateTime&&(h.programDateTime=d.endProgramDateTime),Object(C.isFiniteNumber)(h.programDateTime)||(h.programDateTime=null,h.rawProgramDateTime=null)}},"./src/loader/playlist-loader.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/polyfills/number.ts"),A=T("./src/events.ts"),D=T("./src/errors.ts"),M=T("./src/utils/logger.ts"),P=T("./src/utils/mp4-tools.ts"),R=T("./src/loader/m3u8-parser.ts"),L=T("./src/types/loader.ts"),g=T("./src/utils/attr-list.ts");function y(E){var m=E.type;switch(m){case L.PlaylistContextType.AUDIO_TRACK:return L.PlaylistLevelType.AUDIO;case L.PlaylistContextType.SUBTITLE_TRACK:return L.PlaylistLevelType.SUBTITLE;default:return L.PlaylistLevelType.MAIN}}function S(E,m){var u=E.url;return(u===void 0||u.indexOf("data:")===0)&&(u=m.url),u}var p=function(){function E(u){this.hls=void 0,this.loaders=Object.create(null),this.hls=u,this.registerListeners()}var m=E.prototype;return m.registerListeners=function(){var t=this.hls;t.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(A.Events.LEVEL_LOADING,this.onLevelLoading,this),t.on(A.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(A.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},m.unregisterListeners=function(){var t=this.hls;t.off(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(A.Events.LEVEL_LOADING,this.onLevelLoading,this),t.off(A.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(A.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},m.createInternalLoader=function(t){var r=this.hls.config,e=r.pLoader,f=r.loader,s=e||f,l=new s(r);return t.loader=l,this.loaders[t.type]=l,l},m.getInternalLoader=function(t){return this.loaders[t.type]},m.resetInternalLoader=function(t){this.loaders[t]&&delete this.loaders[t]},m.destroyInternalLoaders=function(){for(var t in this.loaders){var r=this.loaders[t];r&&r.destroy(),this.resetInternalLoader(t)}},m.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},m.onManifestLoading=function(t,r){var e=r.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:L.PlaylistContextType.MANIFEST,url:e,deliveryDirectives:null})},m.onLevelLoading=function(t,r){var e=r.id,f=r.level,s=r.url,l=r.deliveryDirectives;this.load({id:e,groupId:null,level:f,responseType:"text",type:L.PlaylistContextType.LEVEL,url:s,deliveryDirectives:l})},m.onAudioTrackLoading=function(t,r){var e=r.id,f=r.groupId,s=r.url,l=r.deliveryDirectives;this.load({id:e,groupId:f,level:null,responseType:"text",type:L.PlaylistContextType.AUDIO_TRACK,url:s,deliveryDirectives:l})},m.onSubtitleTrackLoading=function(t,r){var e=r.id,f=r.groupId,s=r.url,l=r.deliveryDirectives;this.load({id:e,groupId:f,level:null,responseType:"text",type:L.PlaylistContextType.SUBTITLE_TRACK,url:s,deliveryDirectives:l})},m.load=function(t){var r,e=this.hls.config,f=this.getInternalLoader(t);if(f){var s=f.context;if(s&&s.url===t.url){M.logger.trace("[playlist-loader]: playlist request ongoing");return}M.logger.log("[playlist-loader]: aborting previous loader for type: "+t.type),f.abort()}var l,h,d,o;switch(t.type){case L.PlaylistContextType.MANIFEST:l=e.manifestLoadingMaxRetry,h=e.manifestLoadingTimeOut,d=e.manifestLoadingRetryDelay,o=e.manifestLoadingMaxRetryTimeout;break;case L.PlaylistContextType.LEVEL:case L.PlaylistContextType.AUDIO_TRACK:case L.PlaylistContextType.SUBTITLE_TRACK:l=0,h=e.levelLoadingTimeOut;break;default:l=e.levelLoadingMaxRetry,h=e.levelLoadingTimeOut,d=e.levelLoadingRetryDelay,o=e.levelLoadingMaxRetryTimeout;break}if(f=this.createInternalLoader(t),(r=t.deliveryDirectives)!==null&&r!==void 0&&r.part){var a;if(t.type===L.PlaylistContextType.LEVEL&&t.level!==null?a=this.hls.levels[t.level].details:t.type===L.PlaylistContextType.AUDIO_TRACK&&t.id!==null?a=this.hls.audioTracks[t.id].details:t.type===L.PlaylistContextType.SUBTITLE_TRACK&&t.id!==null&&(a=this.hls.subtitleTracks[t.id].details),a){var i=a.partTarget,n=a.targetduration;i&&n&&(h=Math.min(Math.max(i*3,n*.8)*1e3,h))}}var v={timeout:h,maxRetry:l,retryDelay:d,maxRetryDelay:o,highWaterMark:0},c={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};f.load(t,v,c)},m.loadsuccess=function(t,r,e,f){if(f===void 0&&(f=null),e.isSidxRequest){this.handleSidxRequest(t,e),this.handlePlaylistLoaded(t,r,e,f);return}this.resetInternalLoader(e.type);var s=t.data;if(s.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(t,e,"no EXTM3U delimiter",f);return}r.parsing.start=performance.now(),s.indexOf("#EXTINF:")>0||s.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(t,r,e,f):this.handleMasterPlaylist(t,r,e,f)},m.loaderror=function(t,r,e){e===void 0&&(e=null),this.handleNetworkError(r,e,!1,t)},m.loadtimeout=function(t,r,e){e===void 0&&(e=null),this.handleNetworkError(r,e,!0)},m.handleMasterPlaylist=function(t,r,e,f){var s=this.hls,l=t.data,h=S(t,e),d=R.default.parseMasterPlaylist(l,h),o=d.levels,a=d.sessionData;if(!o.length){this.handleManifestParsingError(t,e,"no level found in manifest",f);return}var i=o.map(function(I){return{id:I.attrs.AUDIO,audioCodec:I.audioCodec}}),n=o.map(function(I){return{id:I.attrs.SUBTITLES,textCodec:I.textCodec}}),v=R.default.parseMasterPlaylistMedia(l,h,"AUDIO",i),c=R.default.parseMasterPlaylistMedia(l,h,"SUBTITLES",n),x=R.default.parseMasterPlaylistMedia(l,h,"CLOSED-CAPTIONS");if(v.length){var O=v.some(function(I){return!I.url});!O&&o[0].audioCodec&&!o[0].attrs.AUDIO&&(M.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),v.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new g.AttrList({}),bitrate:0,url:""}))}s.trigger(A.Events.MANIFEST_LOADED,{levels:o,audioTracks:v,subtitles:c,captions:x,url:h,stats:r,networkDetails:f,sessionData:a})},m.handleTrackOrLevelPlaylist=function(t,r,e,f){var s=this.hls,l=e.id,h=e.level,d=e.type,o=S(t,e),a=Object(C.isFiniteNumber)(l)?l:0,i=Object(C.isFiniteNumber)(h)?h:a,n=y(e),v=R.default.parseLevelPlaylist(t.data,o,i,n,a);if(!v.fragments.length){s.trigger(A.Events.ERROR,{type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:o,reason:"no fragments found in level",level:typeof e.level=="number"?e.level:void 0});return}if(d===L.PlaylistContextType.MANIFEST){var c={attrs:new g.AttrList({}),bitrate:0,details:v,name:"",url:o};s.trigger(A.Events.MANIFEST_LOADED,{levels:[c],audioTracks:[],url:o,stats:r,networkDetails:f,sessionData:null})}if(r.parsing.end=performance.now(),v.needSidxRanges){var x,O=(x=v.fragments[0].initSegment)===null||x===void 0?void 0:x.url;this.load({url:O,isSidxRequest:!0,type:d,level:h,levelDetails:v,id:l,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null});return}e.levelDetails=v,this.handlePlaylistLoaded(t,r,e,f)},m.handleSidxRequest=function(t,r){var e=Object(P.parseSegmentIndex)(new Uint8Array(t.data));if(!!e){var f=e.references,s=r.levelDetails;f.forEach(function(l,h){var d=l.info,o=s.fragments[h];o.byteRange.length===0&&o.setByteRange(String(1+d.end-d.start)+"@"+String(d.start)),o.initSegment&&o.initSegment.setByteRange(String(e.moovEndOffset)+"@0")})}},m.handleManifestParsingError=function(t,r,e,f){this.hls.trigger(A.Events.ERROR,{type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:r.type===L.PlaylistContextType.MANIFEST,url:t.url,reason:e,response:t,context:r,networkDetails:f})},m.handleNetworkError=function(t,r,e,f){e===void 0&&(e=!1),M.logger.warn("[playlist-loader]: A network "+(e?"timeout":"error")+" occurred while loading "+t.type+" level: "+t.level+" id: "+t.id+' group-id: "'+t.groupId+'"');var s=D.ErrorDetails.UNKNOWN,l=!1,h=this.getInternalLoader(t);switch(t.type){case L.PlaylistContextType.MANIFEST:s=e?D.ErrorDetails.MANIFEST_LOAD_TIMEOUT:D.ErrorDetails.MANIFEST_LOAD_ERROR,l=!0;break;case L.PlaylistContextType.LEVEL:s=e?D.ErrorDetails.LEVEL_LOAD_TIMEOUT:D.ErrorDetails.LEVEL_LOAD_ERROR,l=!1;break;case L.PlaylistContextType.AUDIO_TRACK:s=e?D.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:D.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case L.PlaylistContextType.SUBTITLE_TRACK:s=e?D.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:D.ErrorDetails.SUBTITLE_LOAD_ERROR,l=!1;break}h&&this.resetInternalLoader(t.type);var d={type:D.ErrorTypes.NETWORK_ERROR,details:s,fatal:l,url:t.url,loader:h,context:t,networkDetails:r};f&&(d.response=f),this.hls.trigger(A.Events.ERROR,d)},m.handlePlaylistLoaded=function(t,r,e,f){var s=e.type,l=e.level,h=e.id,d=e.groupId,o=e.loader,a=e.levelDetails,i=e.deliveryDirectives;if(!(a!=null&&a.targetduration)){this.handleManifestParsingError(t,e,"invalid target duration",f);return}if(!!o)switch(a.live&&(o.getCacheAge&&(a.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(a.ageHeader))&&(a.ageHeader=0)),s){case L.PlaylistContextType.MANIFEST:case L.PlaylistContextType.LEVEL:this.hls.trigger(A.Events.LEVEL_LOADED,{details:a,level:l||0,id:h||0,stats:r,networkDetails:f,deliveryDirectives:i});break;case L.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(A.Events.AUDIO_TRACK_LOADED,{details:a,id:h||0,groupId:d||"",stats:r,networkDetails:f,deliveryDirectives:i});break;case L.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(A.Events.SUBTITLE_TRACK_LOADED,{details:a,id:h||0,groupId:d||"",stats:r,networkDetails:f,deliveryDirectives:i});break}},E}();b.default=p},"./src/polyfills/number.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"isFiniteNumber",function(){return C}),T.d(b,"MAX_SAFE_INTEGER",function(){return A});var C=Number.isFinite||function(D){return typeof D=="number"&&isFinite(D)},A=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":function(G,b,T){"use strict";T.r(b);var C=function(){function A(){}return A.getSilentFrame=function(M,P){switch(M){case"mp4a.40.2":if(P===1)return new Uint8Array([0,200,0,128,35,128]);if(P===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(P===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(P===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(P===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(P===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(P===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(P===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(P===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},A}();b.default=C},"./src/remux/mp4-generator.ts":function(G,b,T){"use strict";T.r(b);var C=Math.pow(2,32)-1,A=function(){function D(){}return D.init=function(){D.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var P;for(P in D.types)D.types.hasOwnProperty(P)&&(D.types[P]=[P.charCodeAt(0),P.charCodeAt(1),P.charCodeAt(2),P.charCodeAt(3)]);var R=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),L=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);D.HDLR_TYPES={video:R,audio:L};var g=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),y=new Uint8Array([0,0,0,0,0,0,0,0]);D.STTS=D.STSC=D.STCO=y,D.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),D.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),D.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),D.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var S=new Uint8Array([105,115,111,109]),p=new Uint8Array([97,118,99,49]),E=new Uint8Array([0,0,0,1]);D.FTYP=D.box(D.types.ftyp,S,E,S,p),D.DINF=D.box(D.types.dinf,D.box(D.types.dref,g))},D.box=function(P){for(var R=8,L=arguments.length,g=new Array(L>1?L-1:0),y=1;y<L;y++)g[y-1]=arguments[y];for(var S=g.length,p=S;S--;)R+=g[S].byteLength;var E=new Uint8Array(R);for(E[0]=R>>24&255,E[1]=R>>16&255,E[2]=R>>8&255,E[3]=R&255,E.set(P,4),S=0,R=8;S<p;S++)E.set(g[S],R),R+=g[S].byteLength;return E},D.hdlr=function(P){return D.box(D.types.hdlr,D.HDLR_TYPES[P])},D.mdat=function(P){return D.box(D.types.mdat,P)},D.mdhd=function(P,R){R*=P;var L=Math.floor(R/(C+1)),g=Math.floor(R%(C+1));return D.box(D.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,P>>24&255,P>>16&255,P>>8&255,P&255,L>>24,L>>16&255,L>>8&255,L&255,g>>24,g>>16&255,g>>8&255,g&255,85,196,0,0]))},D.mdia=function(P){return D.box(D.types.mdia,D.mdhd(P.timescale,P.duration),D.hdlr(P.type),D.minf(P))},D.mfhd=function(P){return D.box(D.types.mfhd,new Uint8Array([0,0,0,0,P>>24,P>>16&255,P>>8&255,P&255]))},D.minf=function(P){return P.type==="audio"?D.box(D.types.minf,D.box(D.types.smhd,D.SMHD),D.DINF,D.stbl(P)):D.box(D.types.minf,D.box(D.types.vmhd,D.VMHD),D.DINF,D.stbl(P))},D.moof=function(P,R,L){return D.box(D.types.moof,D.mfhd(P),D.traf(L,R))},D.moov=function(P){for(var R=P.length,L=[];R--;)L[R]=D.trak(P[R]);return D.box.apply(null,[D.types.moov,D.mvhd(P[0].timescale,P[0].duration)].concat(L).concat(D.mvex(P)))},D.mvex=function(P){for(var R=P.length,L=[];R--;)L[R]=D.trex(P[R]);return D.box.apply(null,[D.types.mvex].concat(L))},D.mvhd=function(P,R){R*=P;var L=Math.floor(R/(C+1)),g=Math.floor(R%(C+1)),y=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,P>>24&255,P>>16&255,P>>8&255,P&255,L>>24,L>>16&255,L>>8&255,L&255,g>>24,g>>16&255,g>>8&255,g&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return D.box(D.types.mvhd,y)},D.sdtp=function(P){var R=P.samples||[],L=new Uint8Array(4+R.length),g,y;for(g=0;g<R.length;g++)y=R[g].flags,L[g+4]=y.dependsOn<<4|y.isDependedOn<<2|y.hasRedundancy;return D.box(D.types.sdtp,L)},D.stbl=function(P){return D.box(D.types.stbl,D.stsd(P),D.box(D.types.stts,D.STTS),D.box(D.types.stsc,D.STSC),D.box(D.types.stsz,D.STSZ),D.box(D.types.stco,D.STCO))},D.avc1=function(P){var R=[],L=[],g,y,S;for(g=0;g<P.sps.length;g++)y=P.sps[g],S=y.byteLength,R.push(S>>>8&255),R.push(S&255),R=R.concat(Array.prototype.slice.call(y));for(g=0;g<P.pps.length;g++)y=P.pps[g],S=y.byteLength,L.push(S>>>8&255),L.push(S&255),L=L.concat(Array.prototype.slice.call(y));var p=D.box(D.types.avcC,new Uint8Array([1,R[3],R[4],R[5],255,224|P.sps.length].concat(R).concat([P.pps.length]).concat(L))),E=P.width,m=P.height,u=P.pixelRatio[0],t=P.pixelRatio[1];return D.box(D.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,E>>8&255,E&255,m>>8&255,m&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),p,D.box(D.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),D.box(D.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,t>>24,t>>16&255,t>>8&255,t&255])))},D.esds=function(P){var R=P.config.length;return new Uint8Array([0,0,0,0,3,23+R,0,1,0,4,15+R,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([R]).concat(P.config).concat([6,1,2]))},D.mp4a=function(P){var R=P.samplerate;return D.box(D.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,P.channelCount,0,16,0,0,0,0,R>>8&255,R&255,0,0]),D.box(D.types.esds,D.esds(P)))},D.mp3=function(P){var R=P.samplerate;return D.box(D.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,P.channelCount,0,16,0,0,0,0,R>>8&255,R&255,0,0]))},D.stsd=function(P){return P.type==="audio"?!P.isAAC&&P.codec==="mp3"?D.box(D.types.stsd,D.STSD,D.mp3(P)):D.box(D.types.stsd,D.STSD,D.mp4a(P)):D.box(D.types.stsd,D.STSD,D.avc1(P))},D.tkhd=function(P){var R=P.id,L=P.duration*P.timescale,g=P.width,y=P.height,S=Math.floor(L/(C+1)),p=Math.floor(L%(C+1));return D.box(D.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,R>>24&255,R>>16&255,R>>8&255,R&255,0,0,0,0,S>>24,S>>16&255,S>>8&255,S&255,p>>24,p>>16&255,p>>8&255,p&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,g>>8&255,g&255,0,0,y>>8&255,y&255,0,0]))},D.traf=function(P,R){var L=D.sdtp(P),g=P.id,y=Math.floor(R/(C+1)),S=Math.floor(R%(C+1));return D.box(D.types.traf,D.box(D.types.tfhd,new Uint8Array([0,0,0,0,g>>24,g>>16&255,g>>8&255,g&255])),D.box(D.types.tfdt,new Uint8Array([1,0,0,0,y>>24,y>>16&255,y>>8&255,y&255,S>>24,S>>16&255,S>>8&255,S&255])),D.trun(P,L.length+16+20+8+16+8+8),L)},D.trak=function(P){return P.duration=P.duration||4294967295,D.box(D.types.trak,D.tkhd(P),D.mdia(P))},D.trex=function(P){var R=P.id;return D.box(D.types.trex,new Uint8Array([0,0,0,0,R>>24,R>>16&255,R>>8&255,R&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},D.trun=function(P,R){var L=P.samples||[],g=L.length,y=12+16*g,S=new Uint8Array(y),p,E,m,u,t,r;for(R+=8+y,S.set([0,0,15,1,g>>>24&255,g>>>16&255,g>>>8&255,g&255,R>>>24&255,R>>>16&255,R>>>8&255,R&255],0),p=0;p<g;p++)E=L[p],m=E.duration,u=E.size,t=E.flags,r=E.cts,S.set([m>>>24&255,m>>>16&255,m>>>8&255,m&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.paddingValue<<1|t.isNonSync,t.degradPrio&240<<8,t.degradPrio&15,r>>>24&255,r>>>16&255,r>>>8&255,r&255],12+16*p);return D.box(D.types.trun,S)},D.initSegment=function(P){D.types||D.init();var R=D.moov(P),L=new Uint8Array(D.FTYP.byteLength+R.byteLength);return L.set(D.FTYP),L.set(R,D.FTYP.byteLength),L},D}();A.types=void 0,A.HDLR_TYPES=void 0,A.STTS=void 0,A.STSC=void 0,A.STCO=void 0,A.STSZ=void 0,A.VMHD=void 0,A.SMHD=void 0,A.STSD=void 0,A.FTYP=void 0,A.DINF=void 0,b.default=A},"./src/remux/mp4-remuxer.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return r}),T.d(b,"normalizePts",function(){return e});var C=T("./src/polyfills/number.ts"),A=T("./src/remux/aac-helper.ts"),D=T("./src/remux/mp4-generator.ts"),M=T("./src/events.ts"),P=T("./src/errors.ts"),R=T("./src/utils/logger.ts"),L=T("./src/types/loader.ts"),g=T("./src/utils/timescale-conversion.ts");function y(){return y=Object.assign||function(h){for(var d=1;d<arguments.length;d++){var o=arguments[d];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(h[a]=o[a])}return h},y.apply(this,arguments)}var S=10*1e3,p=1024,E=1152,m=null,u=null,t=!1,r=function(){function h(o,a,i,n){if(n===void 0&&(n=""),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=o,this.config=a,this.typeSupported=i,this.ISGenerated=!1,m===null){var v=navigator.userAgent||"",c=v.match(/Chrome\/(\d+)/i);m=c?parseInt(c[1]):0}if(u===null){var x=navigator.userAgent.match(/Safari\/(\d+)/i);u=x?parseInt(x[1]):0}t=!!m&&m<75||!!u&&u<600}var d=h.prototype;return d.destroy=function(){},d.resetTimeStamp=function(a){R.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=a},d.resetNextTimestamp=function(){R.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},d.resetInitSegment=function(){R.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},d.getVideoStartPts=function(a){var i=!1,n=a.reduce(function(v,c){var x=c.pts-v;return x<-4294967296?(i=!0,e(v,c.pts)):x>0?v:c.pts},a[0].pts);return i&&R.logger.debug("PTS rollover detected"),n},d.remux=function(a,i,n,v,c,x,O,I){var F,B,U,k,N,K,W=c,w=c,H=a.pid>-1,V=i.pid>-1,j=i.samples.length,X=a.samples.length>0,Y=j>1,$=(!H||X)&&(!V||Y)||this.ISGenerated||O;if($){this.ISGenerated||(U=this.generateIS(a,i,c));var _=this.isVideoContiguous,z=-1;if(Y&&(z=f(i.samples),!_&&this.config.forceKeyFrameOnDiscontinuity))if(K=!0,z>0){R.logger.warn("[mp4-remuxer]: Dropped "+z+" out of "+j+" video samples due to a missing keyframe");var J=this.getVideoStartPts(i.samples);i.samples=i.samples.slice(z),i.dropped+=z,w+=(i.samples[0].pts-J)/(i.timescale||9e4)}else z===-1&&(R.logger.warn("[mp4-remuxer]: No keyframe found out of "+j+" video samples"),K=!1);if(this.ISGenerated){if(X&&Y){var Q=this.getVideoStartPts(i.samples),et=e(a.samples[0].pts,Q)-Q,Z=et/i.inputTimeScale;W+=Math.max(0,Z),w+=Math.max(0,-Z)}if(X){if(a.samplerate||(R.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),U=this.generateIS(a,i,c)),B=this.remuxAudio(a,W,this.isAudioContiguous,x,V||Y||I===L.PlaylistLevelType.AUDIO?w:void 0),Y){var it=B?B.endPTS-B.startPTS:0;i.inputTimeScale||(R.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),U=this.generateIS(a,i,c)),F=this.remuxVideo(i,w,_,it)}}else Y&&(F=this.remuxVideo(i,w,_,0));F&&(F.firstKeyFrame=z,F.independent=z!==-1)}}return this.ISGenerated&&(n.samples.length&&(N=this.remuxID3(n,c)),v.samples.length&&(k=this.remuxText(v,c))),{audio:B,video:F,initSegment:U,independent:K,text:k,id3:N}},d.generateIS=function(a,i,n){var v=a.samples,c=i.samples,x=this.typeSupported,O={},I=!Object(C.isFiniteNumber)(this._initPTS),F="audio/mp4",B,U,k;if(I&&(B=U=1/0),a.config&&v.length&&(a.timescale=a.samplerate,a.isAAC||(x.mpeg?(F="audio/mpeg",a.codec=""):x.mp3&&(a.codec="mp3")),O.audio={id:"audio",container:F,codec:a.codec,initSegment:!a.isAAC&&x.mpeg?new Uint8Array(0):D.default.initSegment([a]),metadata:{channelCount:a.channelCount}},I&&(k=a.inputTimeScale,B=U=v[0].pts-Math.round(k*n))),i.sps&&i.pps&&c.length&&(i.timescale=i.inputTimeScale,O.video={id:"main",container:"video/mp4",codec:i.codec,initSegment:D.default.initSegment([i]),metadata:{width:i.width,height:i.height}},I)){k=i.inputTimeScale;var N=this.getVideoStartPts(c),K=Math.round(k*n);U=Math.min(U,e(c[0].dts,N)-K),B=Math.min(B,N-K)}if(Object.keys(O).length)return this.ISGenerated=!0,I&&(this._initPTS=B,this._initDTS=U),{tracks:O,initPTS:B,timescale:k}},d.remuxVideo=function(a,i,n,v){var c=a.inputTimeScale,x=a.samples,O=[],I=x.length,F=this._initPTS,B=this.nextAvcDts,U=8,k,N,K,W=Number.POSITIVE_INFINITY,w=Number.NEGATIVE_INFINITY,H=0,V=!1;if(!n||B===null){var j=i*c,X=x[0].pts-e(x[0].dts,x[0].pts);B=j-X}for(var Y=0;Y<I;Y++){var $=x[Y];if($.pts=e($.pts-F,B),$.dts=e($.dts-F,B),$.dts>$.pts){var _=18e3;H=Math.max(Math.min(H,$.pts-$.dts),-1*_)}$.dts<x[Y>0?Y-1:Y].dts&&(V=!0)}V&&x.sort(function(Ot,It){var Ut=Ot.dts-It.dts,Nt=Ot.pts-It.pts;return Ut||Nt}),N=x[0].dts,K=x[x.length-1].dts;var z=Math.round((K-N)/(I-1));if(H<0){if(H<z*-2){R.logger.warn("PTS < DTS detected in video samples, offsetting DTS from PTS by "+Object(g.toMsFromMpegTsClock)(-z,!0)+" ms");for(var J=H,Q=0;Q<I;Q++)x[Q].dts=J=Math.max(J,x[Q].pts-z),x[Q].pts=Math.max(J,x[Q].pts)}else{R.logger.warn("PTS < DTS detected in video samples, shifting DTS by "+Object(g.toMsFromMpegTsClock)(H,!0)+" ms to overcome this issue");for(var et=0;et<I;et++)x[et].dts=x[et].dts+H}N=x[0].dts}if(n){var Z=N-B,it=Z>z,tt=Z<-1;if(it||tt){it?R.logger.warn("AVC: "+Object(g.toMsFromMpegTsClock)(Z,!0)+" ms ("+Z+"dts) hole between fragments detected, filling it"):R.logger.warn("AVC: "+Object(g.toMsFromMpegTsClock)(-Z,!0)+" ms ("+Z+"dts) overlapping between fragments detected"),N=B;var at=x[0].pts-Z;x[0].dts=N,x[0].pts=at,R.logger.log("Video: First PTS/DTS adjusted: "+Object(g.toMsFromMpegTsClock)(at,!0)+"/"+Object(g.toMsFromMpegTsClock)(N,!0)+", delta: "+Object(g.toMsFromMpegTsClock)(Z,!0)+" ms")}}t&&(N=Math.max(0,N));for(var rt=0,st=0,ut=0;ut<I;ut++){for(var q=x[ut],ot=q.units,vt=ot.length,gt=0,dt=0;dt<vt;dt++)gt+=ot[dt].data.length;st+=gt,rt+=vt,q.length=gt,q.dts=Math.max(q.dts,N),q.pts=Math.max(q.pts,q.dts,0),W=Math.min(q.pts,W),w=Math.max(q.pts,w)}K=x[I-1].dts;var ct=st+4*rt+8,lt;try{lt=new Uint8Array(ct)}catch(Ot){this.observer.emit(M.Events.ERROR,M.Events.ERROR,{type:P.ErrorTypes.MUX_ERROR,details:P.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ct,reason:"fail allocating video mdat "+ct});return}var Tt=new DataView(lt.buffer);Tt.setUint32(0,ct),lt.set(D.default.types.mdat,4);for(var nt=0;nt<I;nt++){for(var ht=x[nt],St=ht.units,mt=0,Et=0,Lt=St.length;Et<Lt;Et++){var pt=St[Et],ft=pt.data,yt=pt.data.byteLength;Tt.setUint32(U,yt),U+=4,lt.set(ft,U),U+=yt,mt+=4+yt}if(nt<I-1)k=x[nt+1].dts-ht.dts;else{var Dt=this.config,xt=ht.dts-x[nt>0?nt-1:nt].dts;if(Dt.stretchShortVideoTrack&&this.nextAudioPts!==null){var Ct=Math.floor(Dt.maxBufferHole*c),At=(v?W+v*c:this.nextAudioPts)-ht.pts;At>Ct?(k=At-xt,k<0&&(k=xt),R.logger.log("[mp4-remuxer]: It is approximately "+At/90+" ms to the next segment; using duration "+k/90+" ms for the last video frame.")):k=xt}else k=xt}var Mt=Math.round(ht.pts-ht.dts);O.push(new s(ht.key,k,mt,Mt))}if(O.length&&m&&m<70){var Rt=O[0].flags;Rt.dependsOn=2,Rt.isNonSync=0}console.assert(k!==void 0,"mp4SampleDuration must be computed"),this.nextAvcDts=B=K+k,this.isVideoContiguous=!0;var bt=D.default.moof(a.sequenceNumber++,N,y({},a,{samples:O})),Ft="video",Bt={data1:bt,data2:lt,startPTS:W/c,endPTS:(w+k)/c,startDTS:N/c,endDTS:B/c,type:Ft,hasAudio:!1,hasVideo:!0,nb:O.length,dropped:a.dropped};return a.samples=[],a.dropped=0,console.assert(lt.length,"MDAT length must not be zero"),Bt},d.remuxAudio=function(a,i,n,v,c){var x=a.inputTimeScale,O=a.samplerate?a.samplerate:x,I=x/O,F=a.isAAC?p:E,B=F*I,U=this._initPTS,k=!a.isAAC&&this.typeSupported.mpeg,N=[],K=a.samples,W=k?0:8,w=this.nextAudioPts||-1,H=i*x;if(this.isAudioContiguous=n=n||K.length&&w>0&&(v&&Math.abs(H-w)<9e3||Math.abs(e(K[0].pts-U,H)-w)<20*B),K.forEach(function(ft){ft.pts=e(ft.pts-U,H)}),!n||w<0){if(K=K.filter(function(ft){return ft.pts>=0}),!K.length)return;c===0?w=0:v?w=Math.max(0,H):w=K[0].pts}if(a.isAAC)for(var V=c!==void 0,j=this.config.maxAudioFramesDrift,X=0,Y=w;X<K.length;X++){var $=K[X],_=$.pts,z=_-Y,J=Math.abs(1e3*z/x);if(z<=-j*B&&V)X===0&&(R.logger.warn("Audio frame @ "+(_/x).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*z/x)+" ms."),this.nextAudioPts=w=Y=_);else if(z>=j*B&&J<S&&V){var Q=Math.round(z/B);Y=_-Q*B,Y<0&&(Q--,Y+=B),X===0&&(this.nextAudioPts=w=Y),R.logger.warn("[mp4-remuxer]: Injecting "+Q+" audio frame @ "+(Y/x).toFixed(3)+"s due to "+Math.round(1e3*z/x)+" ms gap.");for(var et=0;et<Q;et++){var Z=Math.max(Y,0),it=A.default.getSilentFrame(a.manifestCodec||a.codec,a.channelCount);it||(R.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),it=$.unit.subarray()),K.splice(X,0,{unit:it,pts:Z}),Y+=B,X++}}$.pts=Y,Y+=B}for(var tt=null,at=null,rt,st=0,ut=K.length;ut--;)st+=K[ut].unit.byteLength;for(var q=0,ot=K.length;q<ot;q++){var vt=K[q],gt=vt.unit,dt=vt.pts;if(at!==null){var ct=N[q-1];ct.duration=Math.round((dt-at)/I)}else if(n&&a.isAAC&&(dt=w),tt=dt,st>0){st+=W;try{rt=new Uint8Array(st)}catch(ft){this.observer.emit(M.Events.ERROR,M.Events.ERROR,{type:P.ErrorTypes.MUX_ERROR,details:P.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:st,reason:"fail allocating audio mdat "+st});return}if(!k){var lt=new DataView(rt.buffer);lt.setUint32(0,st),rt.set(D.default.types.mdat,4)}}else return;rt.set(gt,W);var Tt=gt.byteLength;W+=Tt,N.push(new s(!0,F,Tt,0)),at=dt}var nt=N.length;if(!!nt){var ht=N[N.length-1];this.nextAudioPts=w=at+I*ht.duration;var St=k?new Uint8Array(0):D.default.moof(a.sequenceNumber++,tt/I,y({},a,{samples:N}));a.samples=[];var mt=tt/x,Et=w/x,Lt="audio",pt={data1:St,data2:rt,startPTS:mt,endPTS:Et,startDTS:mt,endDTS:Et,type:Lt,hasAudio:!0,hasVideo:!1,nb:nt};return this.isAudioContiguous=!0,console.assert(rt.length,"MDAT length must not be zero"),pt}},d.remuxEmptyAudio=function(a,i,n,v){var c=a.inputTimeScale,x=a.samplerate?a.samplerate:c,O=c/x,I=this.nextAudioPts,F=(I!==null?I:v.startDTS*c)+this._initDTS,B=v.endDTS*c+this._initDTS,U=O*p,k=Math.ceil((B-F)/U),N=A.default.getSilentFrame(a.manifestCodec||a.codec,a.channelCount);if(R.logger.warn("[mp4-remuxer]: remux empty Audio"),!N){R.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}for(var K=[],W=0;W<k;W++){var w=F+W*U;K.push({unit:N,pts:w,dts:w})}return a.samples=K,this.remuxAudio(a,i,n,!1)},d.remuxID3=function(a,i){var n=a.samples.length;if(!!n){for(var v=a.inputTimeScale,c=this._initPTS,x=this._initDTS,O=0;O<n;O++){var I=a.samples[O];I.pts=e(I.pts-c,i*v)/v,I.dts=e(I.dts-x,i*v)/v}var F=a.samples;return a.samples=[],{samples:F}}},d.remuxText=function(a,i){var n=a.samples.length;if(!!n){for(var v=a.inputTimeScale,c=this._initPTS,x=0;x<n;x++){var O=a.samples[x];O.pts=e(O.pts-c,i*v)/v}a.samples.sort(function(F,B){return F.pts-B.pts});var I=a.samples;return a.samples=[],{samples:I}}},h}();function e(h,d){var o;if(d===null)return h;for(d<h?o=-8589934592:o=8589934592;Math.abs(h-d)>4294967296;)h+=o;return h}function f(h){for(var d=0;d<h.length;d++)if(h[d].key)return d;return-1}var s=function(d,o,a,i){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=o,this.size=a,this.cts=i,this.flags=new l(d)},l=function(d){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=d?2:1,this.isNonSync=d?0:1}},"./src/remux/passthrough-remuxer.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/polyfills/number.ts"),A=T("./src/utils/mp4-tools.ts"),D=T("./src/loader/fragment.ts"),M=T("./src/utils/logger.ts"),P=function(){function g(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndDTS=null}var y=g.prototype;return y.destroy=function(){},y.resetTimeStamp=function(p){this.initPTS=p,this.lastEndDTS=null},y.resetNextTimestamp=function(){this.lastEndDTS=null},y.resetInitSegment=function(p,E,m){this.audioCodec=E,this.videoCodec=m,this.generateInitSegment(p),this.emitInitSegment=!0},y.generateInitSegment=function(p){var E=this.audioCodec,m=this.videoCodec;if(!p||!p.byteLength){this.initTracks=void 0,this.initData=void 0;return}var u=this.initData=Object(A.parseInitSegment)(p);E||(E=L(u.audio,D.ElementaryStreamTypes.AUDIO)),m||(m=L(u.video,D.ElementaryStreamTypes.VIDEO));var t={};u.audio&&u.video?t.audiovideo={container:"video/mp4",codec:E+","+m,initSegment:p,id:"main"}:u.audio?t.audio={container:"audio/mp4",codec:E,initSegment:p,id:"audio"}:u.video?t.video={container:"video/mp4",codec:m,initSegment:p,id:"main"}:M.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=t},y.remux=function(p,E,m,u,t){var r=this.initPTS,e=this.lastEndDTS,f={audio:void 0,video:void 0,text:u,id3:m,initSegment:void 0};Object(C.isFiniteNumber)(e)||(e=this.lastEndDTS=t||0);var s=E.samples;if(!s||!s.length)return f;var l={initPTS:void 0,timescale:1},h=this.initData;if((!h||!h.length)&&(this.generateInitSegment(s),h=this.initData),!h||!h.length)return M.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),f;this.emitInitSegment&&(l.tracks=this.initTracks,this.emitInitSegment=!1),Object(C.isFiniteNumber)(r)||(this.initPTS=l.initPTS=r=R(h,s,e));var d=Object(A.getDuration)(s,h),o=e,a=d+o;Object(A.offsetStartDTS)(h,s,r),d>0?this.lastEndDTS=a:(M.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var i=!!h.audio,n=!!h.video,v="";i&&(v+="audio"),n&&(v+="video");var c={data1:s,startPTS:o,startDTS:o,endPTS:a,endDTS:a,type:v,hasAudio:i,hasVideo:n,nb:1,dropped:0};return f.audio=c.type==="audio"?c:void 0,f.video=c.type!=="audio"?c:void 0,f.text=u,f.id3=m,f.initSegment=l,f},g}(),R=function(y,S,p){return Object(A.getStartDTS)(y,S)-p};function L(g,y){var S=g==null?void 0:g.codec;return S&&S.length>4?S:S==="hvc1"?"hvc1.1.c.L120.90":S==="av01"?"av01.0.04M.08":S==="avc1"||y===D.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}b.default=P},"./src/task-loop.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return C});var C=function(){function A(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var D=A.prototype;return D.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},D.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},D.onHandlerDestroyed=function(){},D.hasInterval=function(){return!!this._tickInterval},D.hasNextTick=function(){return!!this._tickTimer},D.setInterval=function(P){return this._tickInterval?!1:(this._tickInterval=self.setInterval(this._boundTick,P),!0)},D.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},D.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},D.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},D.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},D.doTick=function(){},A}()},"./src/types/cmcd.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"CMCDVersion",function(){return C}),T.d(b,"CMCDObjectType",function(){return A}),T.d(b,"CMCDStreamingFormat",function(){return D}),T.d(b,"CMCDStreamType",function(){return M});var C=1,A;(function(P){P.MANIFEST="m",P.AUDIO="a",P.VIDEO="v",P.MUXED="av",P.INIT="i",P.CAPTION="c",P.TIMED_TEXT="tt",P.KEY="k",P.OTHER="o"})(A||(A={}));var D;(function(P){P.DASH="d",P.HLS="h",P.SMOOTH="s",P.OTHER="o"})(D||(D={}));var M;(function(P){P.VOD="v",P.LIVE="l"})(M||(M={}))},"./src/types/level.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"HlsSkip",function(){return D}),T.d(b,"getSkipValue",function(){return M}),T.d(b,"HlsUrlParameters",function(){return P}),T.d(b,"Level",function(){return R});function C(L,g){for(var y=0;y<g.length;y++){var S=g[y];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(L,S.key,S)}}function A(L,g,y){return g&&C(L.prototype,g),y&&C(L,y),L}var D;(function(L){L.No="",L.Yes="YES",L.v2="v2"})(D||(D={}));function M(L,g){var y=L.canSkipUntil,S=L.canSkipDateRanges,p=L.endSN,E=g!==void 0?g-p:0;return y&&E<y?S?D.v2:D.Yes:D.No}var P=function(){function L(y,S,p){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=y,this.part=S,this.skip=p}var g=L.prototype;return g.addDirectives=function(S){var p=new self.URL(S);return this.msn!==void 0&&p.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&p.searchParams.set("_HLS_part",this.part.toString()),this.skip&&p.searchParams.set("_HLS_skip",this.skip),p.toString()},L}(),R=function(){function L(g){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[g.url],this.attrs=g.attrs,this.bitrate=g.bitrate,g.details&&(this.details=g.details),this.id=g.id||0,this.name=g.name,this.width=g.width||0,this.height=g.height||0,this.audioCodec=g.audioCodec,this.videoCodec=g.videoCodec,this.unknownCodecs=g.unknownCodecs,this.codecSet=[g.videoCodec,g.audioCodec].filter(function(y){return y}).join(",").replace(/\.[^.,]+/g,"")}return A(L,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(y){var S=y%this.url.length;this._urlId!==S&&(this.details=void 0,this._urlId=S)}}]),L}()},"./src/types/loader.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"PlaylistContextType",function(){return C}),T.d(b,"PlaylistLevelType",function(){return A});var C;(function(D){D.MANIFEST="manifest",D.LEVEL="level",D.AUDIO_TRACK="audioTrack",D.SUBTITLE_TRACK="subtitleTrack"})(C||(C={}));var A;(function(D){D.MAIN="main",D.AUDIO="audio",D.SUBTITLE="subtitle"})(A||(A={}))},"./src/types/transmuxer.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"ChunkMetadata",function(){return C});var C=function(M,P,R,L,g,y){L===void 0&&(L=0),g===void 0&&(g=-1),y===void 0&&(y=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=A(),this.buffering={audio:A(),video:A(),audiovideo:A()},this.level=M,this.sn=P,this.id=R,this.size=L,this.part=g,this.partial=y};function A(){return{start:0,executeStart:0,executeEnd:0,end:0}}},"./src/utils/attr-list.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"AttrList",function(){return D});var C=/^(\d+)x(\d+)$/,A=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,D=function(){function M(R){typeof R=="string"&&(R=M.parseAttrList(R));for(var L in R)R.hasOwnProperty(L)&&(this[L]=R[L])}var P=M.prototype;return P.decimalInteger=function(L){var g=parseInt(this[L],10);return g>Number.MAX_SAFE_INTEGER?1/0:g},P.hexadecimalInteger=function(L){if(this[L]){var g=(this[L]||"0x").slice(2);g=(g.length&1?"0":"")+g;for(var y=new Uint8Array(g.length/2),S=0;S<g.length/2;S++)y[S]=parseInt(g.slice(S*2,S*2+2),16);return y}else return null},P.hexadecimalIntegerAsNumber=function(L){var g=parseInt(this[L],16);return g>Number.MAX_SAFE_INTEGER?1/0:g},P.decimalFloatingPoint=function(L){return parseFloat(this[L])},P.optionalFloat=function(L,g){var y=this[L];return y?parseFloat(y):g},P.enumeratedString=function(L){return this[L]},P.bool=function(L){return this[L]==="YES"},P.decimalResolution=function(L){var g=C.exec(this[L]);if(g!==null)return{width:parseInt(g[1],10),height:parseInt(g[2],10)}},M.parseAttrList=function(L){var g,y={},S='"';for(A.lastIndex=0;(g=A.exec(L))!==null;){var p=g[2];p.indexOf(S)===0&&p.lastIndexOf(S)===p.length-1&&(p=p.slice(1,-1)),y[g[1]]=p}return y},M}()},"./src/utils/binary-search.ts":function(G,b,T){"use strict";T.r(b);var C={search:function(D,M){for(var P=0,R=D.length-1,L=null,g=null;P<=R;){L=(P+R)/2|0,g=D[L];var y=M(g);if(y>0)P=L+1;else if(y<0)R=L-1;else return g}return null}};b.default=C},"./src/utils/buffer-helper.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"BufferHelper",function(){return D});var C=T("./src/utils/logger.ts"),A={length:0,start:function(){return 0},end:function(){return 0}},D=function(){function M(){}return M.isBuffered=function(R,L){try{if(R){for(var g=M.getBuffered(R),y=0;y<g.length;y++)if(L>=g.start(y)&&L<=g.end(y))return!0}}catch(S){}return!1},M.bufferInfo=function(R,L,g){try{if(R){var y=M.getBuffered(R),S=[],p;for(p=0;p<y.length;p++)S.push({start:y.start(p),end:y.end(p)});return this.bufferedInfo(S,L,g)}}catch(E){}return{len:0,start:L,end:L,nextStart:void 0}},M.bufferedInfo=function(R,L,g){L=Math.max(0,L),R.sort(function(l,h){var d=l.start-h.start;return d||h.end-l.end});var y=[];if(g)for(var S=0;S<R.length;S++){var p=y.length;if(p){var E=y[p-1].end;R[S].start-E<g?R[S].end>E&&(y[p-1].end=R[S].end):y.push(R[S])}else y.push(R[S])}else y=R;for(var m=0,u,t=L,r=L,e=0;e<y.length;e++){var f=y[e].start,s=y[e].end;if(L+g>=f&&L<s)t=f,r=s,m=r-L;else if(L+g<f){u=f;break}}return{len:m,start:t||0,end:r||0,nextStart:u}},M.getBuffered=function(R){try{return R.buffered}catch(L){return C.logger.log("failed to get media.buffered",L),A}},M}()},"./src/utils/cea-608-parser.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"Row",function(){return r}),T.d(b,"CaptionScreen",function(){return e});var C=T("./src/utils/logger.ts"),A={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},D=function(a){var i=a;return A.hasOwnProperty(a)&&(i=A[a]),String.fromCharCode(i)},M=15,P=100,R={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},L={17:2,18:4,21:6,22:8,23:10,19:13,20:15},g={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},y={25:2,26:4,29:6,30:8,31:10,27:13,28:15},S=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],p;(function(o){o[o.ERROR=0]="ERROR",o[o.TEXT=1]="TEXT",o[o.WARNING=2]="WARNING",o[o.INFO=2]="INFO",o[o.DEBUG=3]="DEBUG",o[o.DATA=3]="DATA"})(p||(p={}));var E=function(){function o(){this.time=null,this.verboseLevel=p.ERROR}var a=o.prototype;return a.log=function(n,v){this.verboseLevel>=n&&C.logger.log(this.time+" ["+n+"] "+v)},o}(),m=function(a){for(var i=[],n=0;n<a.length;n++)i.push(a[n].toString(16));return i},u=function(){function o(i,n,v,c,x){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=i||"white",this.underline=n||!1,this.italics=v||!1,this.background=c||"black",this.flash=x||!1}var a=o.prototype;return a.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},a.setStyles=function(n){for(var v=["foreground","underline","italics","background","flash"],c=0;c<v.length;c++){var x=v[c];n.hasOwnProperty(x)&&(this[x]=n[x])}},a.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},a.equals=function(n){return this.foreground===n.foreground&&this.underline===n.underline&&this.italics===n.italics&&this.background===n.background&&this.flash===n.flash},a.copy=function(n){this.foreground=n.foreground,this.underline=n.underline,this.italics=n.italics,this.background=n.background,this.flash=n.flash},a.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},o}(),t=function(){function o(i,n,v,c,x,O){this.uchar=void 0,this.penState=void 0,this.uchar=i||" ",this.penState=new u(n,v,c,x,O)}var a=o.prototype;return a.reset=function(){this.uchar=" ",this.penState.reset()},a.setChar=function(n,v){this.uchar=n,this.penState.copy(v)},a.setPenState=function(n){this.penState.copy(n)},a.equals=function(n){return this.uchar===n.uchar&&this.penState.equals(n.penState)},a.copy=function(n){this.uchar=n.uchar,this.penState.copy(n.penState)},a.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},o}(),r=function(){function o(i){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var n=0;n<P;n++)this.chars.push(new t);this.logger=i,this.pos=0,this.currPenState=new u}var a=o.prototype;return a.equals=function(n){for(var v=!0,c=0;c<P;c++)if(!this.chars[c].equals(n.chars[c])){v=!1;break}return v},a.copy=function(n){for(var v=0;v<P;v++)this.chars[v].copy(n.chars[v])},a.isEmpty=function(){for(var n=!0,v=0;v<P;v++)if(!this.chars[v].isEmpty()){n=!1;break}return n},a.setCursor=function(n){this.pos!==n&&(this.pos=n),this.pos<0?(this.logger.log(p.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>P&&(this.logger.log(p.DEBUG,"Too large cursor position "+this.pos),this.pos=P)},a.moveCursor=function(n){var v=this.pos+n;if(n>1)for(var c=this.pos+1;c<v+1;c++)this.chars[c].setPenState(this.currPenState);this.setCursor(v)},a.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},a.insertChar=function(n){n>=144&&this.backSpace();var v=D(n);if(this.pos>=P){this.logger.log(p.ERROR,"Cannot insert "+n.toString(16)+" ("+v+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(v,this.currPenState),this.moveCursor(1)},a.clearFromPos=function(n){var v;for(v=n;v<P;v++)this.chars[v].reset()},a.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},a.clearToEndOfRow=function(){this.clearFromPos(this.pos)},a.getTextString=function(){for(var n=[],v=!0,c=0;c<P;c++){var x=this.chars[c].uchar;x!==" "&&(v=!1),n.push(x)}return v?"":n.join("")},a.setPenStyles=function(n){this.currPenState.setStyles(n);var v=this.chars[this.pos];v.setPenState(this.currPenState)},o}(),e=function(){function o(i){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var n=0;n<M;n++)this.rows.push(new r(i));this.logger=i,this.currRow=M-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var a=o.prototype;return a.reset=function(){for(var n=0;n<M;n++)this.rows[n].clear();this.currRow=M-1},a.equals=function(n){for(var v=!0,c=0;c<M;c++)if(!this.rows[c].equals(n.rows[c])){v=!1;break}return v},a.copy=function(n){for(var v=0;v<M;v++)this.rows[v].copy(n.rows[v])},a.isEmpty=function(){for(var n=!0,v=0;v<M;v++)if(!this.rows[v].isEmpty()){n=!1;break}return n},a.backSpace=function(){var n=this.rows[this.currRow];n.backSpace()},a.clearToEndOfRow=function(){var n=this.rows[this.currRow];n.clearToEndOfRow()},a.insertChar=function(n){var v=this.rows[this.currRow];v.insertChar(n)},a.setPen=function(n){var v=this.rows[this.currRow];v.setPenStyles(n)},a.moveCursor=function(n){var v=this.rows[this.currRow];v.moveCursor(n)},a.setCursor=function(n){this.logger.log(p.INFO,"setCursor: "+n);var v=this.rows[this.currRow];v.setCursor(n)},a.setPAC=function(n){this.logger.log(p.INFO,"pacData = "+JSON.stringify(n));var v=n.row-1;if(this.nrRollUpRows&&v<this.nrRollUpRows-1&&(v=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==v){for(var c=0;c<M;c++)this.rows[c].clear();var x=this.currRow+1-this.nrRollUpRows,O=this.lastOutputScreen;if(O){var I=O.rows[x].cueStartTime,F=this.logger.time;if(I&&F!==null&&I<F)for(var B=0;B<this.nrRollUpRows;B++)this.rows[v-this.nrRollUpRows+B+1].copy(O.rows[x+B])}}this.currRow=v;var U=this.rows[this.currRow];if(n.indent!==null){var k=n.indent,N=Math.max(k-1,0);U.setCursor(n.indent),n.color=U.chars[N].penState.foreground}var K={foreground:n.color,underline:n.underline,italics:n.italics,background:"black",flash:!1};this.setPen(K)},a.setBkgData=function(n){this.logger.log(p.INFO,"bkgData = "+JSON.stringify(n)),this.backSpace(),this.setPen(n),this.insertChar(32)},a.setRollUpRows=function(n){this.nrRollUpRows=n},a.rollUp=function(){if(this.nrRollUpRows===null){this.logger.log(p.DEBUG,"roll_up but nrRollUpRows not set yet");return}this.logger.log(p.TEXT,this.getDisplayText());var n=this.currRow+1-this.nrRollUpRows,v=this.rows.splice(n,1)[0];v.clear(),this.rows.splice(this.currRow,0,v),this.logger.log(p.INFO,"Rolling up")},a.getDisplayText=function(n){n=n||!1;for(var v=[],c="",x=-1,O=0;O<M;O++){var I=this.rows[O].getTextString();I&&(x=O+1,n?v.push("Row "+x+": '"+I+"'"):v.push(I.trim()))}return v.length>0&&(n?c="["+v.join(" | ")+"]":c=v.join(`
`)),c},a.getTextAndFormat=function(){return this.rows},o}(),f=function(){function o(i,n,v){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=i,this.outputFilter=n,this.mode=null,this.verbose=0,this.displayedMemory=new e(v),this.nonDisplayedMemory=new e(v),this.lastOutputScreen=new e(v),this.currRollUpRow=this.displayedMemory.rows[M-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=v}var a=o.prototype;return a.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[M-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},a.getHandler=function(){return this.outputFilter},a.setHandler=function(n){this.outputFilter=n},a.setPAC=function(n){this.writeScreen.setPAC(n)},a.setBkgData=function(n){this.writeScreen.setBkgData(n)},a.setMode=function(n){n!==this.mode&&(this.mode=n,this.logger.log(p.INFO,"MODE="+n),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=n)},a.insertChars=function(n){for(var v=0;v<n.length;v++)this.writeScreen.insertChar(n[v]);var c=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(p.INFO,c+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(p.TEXT,"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())},a.ccRCL=function(){this.logger.log(p.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},a.ccBS=function(){this.logger.log(p.INFO,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},a.ccAOF=function(){},a.ccAON=function(){},a.ccDER=function(){this.logger.log(p.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},a.ccRU=function(n){this.logger.log(p.INFO,"RU("+n+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(n)},a.ccFON=function(){this.logger.log(p.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},a.ccRDC=function(){this.logger.log(p.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},a.ccTR=function(){this.logger.log(p.INFO,"TR"),this.setMode("MODE_TEXT")},a.ccRTD=function(){this.logger.log(p.INFO,"RTD"),this.setMode("MODE_TEXT")},a.ccEDM=function(){this.logger.log(p.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},a.ccCR=function(){this.logger.log(p.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},a.ccENM=function(){this.logger.log(p.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},a.ccEOC=function(){if(this.logger.log(p.INFO,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var n=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=n,this.writeScreen=this.nonDisplayedMemory,this.logger.log(p.TEXT,"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)},a.ccTO=function(n){this.logger.log(p.INFO,"TO("+n+") - Tab Offset"),this.writeScreen.moveCursor(n)},a.ccMIDROW=function(n){var v={flash:!1};if(v.underline=n%2===1,v.italics=n>=46,v.italics)v.foreground="white";else{var c=Math.floor(n/2)-16,x=["white","green","blue","cyan","red","yellow","magenta"];v.foreground=x[c]}this.logger.log(p.INFO,"MIDROW: "+JSON.stringify(v)),this.writeScreen.setPen(v)},a.outputDataUpdate=function(n){n===void 0&&(n=!1);var v=this.logger.time;v!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=v:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,v,this.lastOutputScreen),n&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:v),this.lastOutputScreen.copy(this.displayedMemory))},a.cueSplitAtTime=function(n){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,n,this.displayedMemory),this.cueStartTime=n))},o}(),s=function(){function o(i,n,v){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var c=new E;this.channels=[null,new f(i,n,c),new f(i+1,v,c)],this.cmdHistory=d(),this.logger=c}var a=o.prototype;return a.getHandler=function(n){return this.channels[n].getHandler()},a.setHandler=function(n,v){this.channels[n].setHandler(v)},a.addData=function(n,v){var c,x,O,I=!1;this.logger.time=n;for(var F=0;F<v.length;F+=2)if(x=v[F]&127,O=v[F+1]&127,!(x===0&&O===0)){if(this.logger.log(p.DATA,"["+m([v[F],v[F+1]])+"] -> ("+m([x,O])+")"),c=this.parseCmd(x,O),c||(c=this.parseMidrow(x,O)),c||(c=this.parsePAC(x,O)),c||(c=this.parseBackgroundAttributes(x,O)),!c&&(I=this.parseChars(x,O),I)){var B=this.currentChannel;if(B&&B>0){var U=this.channels[B];U.insertChars(I)}else this.logger.log(p.WARNING,"No channel found yet. TEXT-MODE?")}!c&&!I&&this.logger.log(p.WARNING,"Couldn't parse cleaned data "+m([x,O])+" orig: "+m([v[F],v[F+1]]))}},a.parseCmd=function(n,v){var c=this.cmdHistory,x=(n===20||n===28||n===21||n===29)&&v>=32&&v<=47,O=(n===23||n===31)&&v>=33&&v<=35;if(!(x||O))return!1;if(h(n,v,c))return l(null,null,c),this.logger.log(p.DEBUG,"Repeated command ("+m([n,v])+") is dropped"),!0;var I=n===20||n===21||n===23?1:2,F=this.channels[I];return n===20||n===21||n===28||n===29?v===32?F.ccRCL():v===33?F.ccBS():v===34?F.ccAOF():v===35?F.ccAON():v===36?F.ccDER():v===37?F.ccRU(2):v===38?F.ccRU(3):v===39?F.ccRU(4):v===40?F.ccFON():v===41?F.ccRDC():v===42?F.ccTR():v===43?F.ccRTD():v===44?F.ccEDM():v===45?F.ccCR():v===46?F.ccENM():v===47&&F.ccEOC():F.ccTO(v-32),l(n,v,c),this.currentChannel=I,!0},a.parseMidrow=function(n,v){var c=0;if((n===17||n===25)&&v>=32&&v<=47){if(n===17?c=1:c=2,c!==this.currentChannel)return this.logger.log(p.ERROR,"Mismatch channel in midrow parsing"),!1;var x=this.channels[c];return x?(x.ccMIDROW(v),this.logger.log(p.DEBUG,"MIDROW ("+m([n,v])+")"),!0):!1}return!1},a.parsePAC=function(n,v){var c,x=this.cmdHistory,O=(n>=17&&n<=23||n>=25&&n<=31)&&v>=64&&v<=127,I=(n===16||n===24)&&v>=64&&v<=95;if(!(O||I))return!1;if(h(n,v,x))return l(null,null,x),!0;var F=n<=23?1:2;v>=64&&v<=95?c=F===1?R[n]:g[n]:c=F===1?L[n]:y[n];var B=this.channels[F];return B?(B.setPAC(this.interpretPAC(c,v)),l(n,v,x),this.currentChannel=F,!0):!1},a.interpretPAC=function(n,v){var c,x={color:null,italics:!1,indent:null,underline:!1,row:n};return v>95?c=v-96:c=v-64,x.underline=(c&1)===1,c<=13?x.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(c/2)]:c<=15?(x.italics=!0,x.color="white"):x.indent=Math.floor((c-16)/2)*4,x},a.parseChars=function(n,v){var c,x=null,O=null;if(n>=25?(c=2,O=n-8):(c=1,O=n),O>=17&&O<=19){var I;O===17?I=v+80:O===18?I=v+112:I=v+144,this.logger.log(p.INFO,"Special char '"+D(I)+"' in channel "+c),x=[I]}else n>=32&&n<=127&&(x=v===0?[n]:[n,v]);if(x){var F=m(x);this.logger.log(p.DEBUG,"Char codes =  "+F.join(",")),l(n,v,this.cmdHistory)}return x},a.parseBackgroundAttributes=function(n,v){var c=(n===16||n===24)&&v>=32&&v<=47,x=(n===23||n===31)&&v>=45&&v<=47;if(!(c||x))return!1;var O,I={};n===16||n===24?(O=Math.floor((v-32)/2),I.background=S[O],v%2===1&&(I.background=I.background+"_semi")):v===45?I.background="transparent":(I.foreground="black",v===47&&(I.underline=!0));var F=n<=23?1:2,B=this.channels[F];return B.setBkgData(I),l(n,v,this.cmdHistory),!0},a.reset=function(){for(var n=0;n<Object.keys(this.channels).length;n++){var v=this.channels[n];v&&v.reset()}this.cmdHistory=d()},a.cueSplitAtTime=function(n){for(var v=0;v<this.channels.length;v++){var c=this.channels[v];c&&c.cueSplitAtTime(n)}},o}();function l(o,a,i){i.a=o,i.b=a}function h(o,a,i){return i.a===o&&i.b===a}function d(){return{a:null,b:null}}b.default=s},"./src/utils/codecs.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"isCodecType",function(){return A}),T.d(b,"isCodecSupportedInMp4",function(){return D});var C={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function A(M,P){var R=C[P];return!!R&&R[M.slice(0,4)]===!0}function D(M,P){return MediaSource.isTypeSupported((P||"video")+'/mp4;codecs="'+M+'"')}},"./src/utils/cues.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/utils/vttparser.ts"),A=T("./src/utils/webvtt-parser.ts"),D=T("./src/utils/texttrack-utils.ts"),M=/\s/,P={newCue:function(L,g,y,S){for(var p=[],E,m,u,t,r,e=self.VTTCue||self.TextTrackCue,f=0;f<S.rows.length;f++)if(E=S.rows[f],u=!0,t=0,r="",!E.isEmpty()){for(var s=0;s<E.chars.length;s++)M.test(E.chars[s].uchar)&&u?t++:(r+=E.chars[s].uchar,u=!1);E.cueStartTime=g,g===y&&(y+=1e-4),t>=16?t--:t++;var l=Object(C.fixLineBreaks)(r.trim()),h=Object(A.generateCueId)(g,y,l);(!L||!L.cues||!L.cues.getCueById(h))&&(m=new e(g,y,l),m.id=h,m.line=f+1,m.align="left",m.position=10+Math.min(80,Math.floor(t*8/32)*10),p.push(m))}return L&&p.length&&(p.sort(function(d,o){return d.line==="auto"||o.line==="auto"?0:d.line>8&&o.line>8?o.line-d.line:d.line-o.line}),p.forEach(function(d){return Object(D.addCueToTrack)(L,d)})),p}};b.default=P},"./src/utils/discontinuities.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"findFirstFragWithCC",function(){return M}),T.d(b,"shouldAlignOnDiscontinuities",function(){return P}),T.d(b,"findDiscontinuousReferenceFrag",function(){return R}),T.d(b,"adjustSlidingStart",function(){return g}),T.d(b,"alignStream",function(){return y}),T.d(b,"alignPDT",function(){return p}),T.d(b,"alignFragmentByPDTDelta",function(){return E}),T.d(b,"alignMediaPlaylistByPDT",function(){return m});var C=T("./src/polyfills/number.ts"),A=T("./src/utils/logger.ts"),D=T("./src/controller/level-helper.ts");function M(u,t){for(var r=null,e=0,f=u.length;e<f;e++){var s=u[e];if(s&&s.cc===t){r=s;break}}return r}function P(u,t,r){return!!(t.details&&(r.endCC>r.startCC||u&&u.cc<r.startCC))}function R(u,t){var r=u.fragments,e=t.fragments;if(!e.length||!r.length){A.logger.log("No fragments to align");return}var f=M(r,e[0].cc);if(!f||f&&!f.startPTS){A.logger.log("No frag in previous level to align on");return}return f}function L(u,t){if(u){var r=u.start+t;u.start=u.startPTS=r,u.endPTS=r+u.duration}}function g(u,t){for(var r=t.fragments,e=0,f=r.length;e<f;e++)L(r[e],u);t.fragmentHint&&L(t.fragmentHint,u),t.alignedSliding=!0}function y(u,t,r){!t||(S(u,r,t),!r.alignedSliding&&t.details&&p(r,t.details),!r.alignedSliding&&t.details&&!r.skippedSegments&&Object(D.adjustSliding)(t.details,r))}function S(u,t,r){if(P(u,r,t)){var e=R(r.details,t);e&&Object(C.isFiniteNumber)(e.start)&&(A.logger.log("Adjusting PTS using last level due to CC increase within current level "+t.url),g(e.start,t))}}function p(u,t){if(!(!t.fragments.length||!u.hasProgramDateTime||!t.hasProgramDateTime)){var r=t.fragments[0].programDateTime,e=u.fragments[0].programDateTime,f=(e-r)/1e3+t.fragments[0].start;f&&Object(C.isFiniteNumber)(f)&&(A.logger.log("Adjusting PTS using programDateTime delta "+(e-r)+"ms, sliding:"+f.toFixed(3)+" "+u.url+" "),g(f,u))}}function E(u,t){var r=u.programDateTime;if(!!r){var e=(r-t)/1e3;u.start=u.startPTS=e,u.endPTS=e+u.duration}}function m(u,t){if(!(!t.fragments.length||!u.hasProgramDateTime||!t.hasProgramDateTime)){var r=t.fragments[0].programDateTime,e=t.fragments[0].start,f=r-e*1e3;u.fragments.forEach(function(s){E(s,f)}),u.fragmentHint&&E(u.fragmentHint,f),u.alignedSliding=!0}}},"./src/utils/ewma-bandwidth-estimator.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/utils/ewma.ts"),A=function(){function D(P,R,L){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=L,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new C.default(P),this.fast_=new C.default(R)}var M=D.prototype;return M.update=function(R,L){var g=this.slow_,y=this.fast_;this.slow_.halfLife!==R&&(this.slow_=new C.default(R,g.getEstimate(),g.getTotalWeight())),this.fast_.halfLife!==L&&(this.fast_=new C.default(L,y.getEstimate(),y.getTotalWeight()))},M.sample=function(R,L){R=Math.max(R,this.minDelayMs_);var g=8*L,y=R/1e3,S=g/y;this.fast_.sample(y,S),this.slow_.sample(y,S)},M.canEstimate=function(){var R=this.fast_;return R&&R.getTotalWeight()>=this.minWeight_},M.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},M.destroy=function(){},D}();b.default=A},"./src/utils/ewma.ts":function(G,b,T){"use strict";T.r(b);var C=function(){function A(M,P,R){P===void 0&&(P=0),R===void 0&&(R=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=M,this.alpha_=M?Math.exp(Math.log(.5)/M):0,this.estimate_=P,this.totalWeight_=R}var D=A.prototype;return D.sample=function(P,R){var L=Math.pow(this.alpha_,P);this.estimate_=R*(1-L)+L*this.estimate_,this.totalWeight_+=P},D.getTotalWeight=function(){return this.totalWeight_},D.getEstimate=function(){if(this.alpha_){var P=1-Math.pow(this.alpha_,this.totalWeight_);if(P)return this.estimate_/P}return this.estimate_},A}();b.default=C},"./src/utils/fetch-loader.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"fetchSupported",function(){return E});var C=T("./src/polyfills/number.ts"),A=T("./src/loader/load-stats.ts"),D=T("./src/demux/chunk-cache.ts");function M(e,f){e.prototype=Object.create(f.prototype),e.prototype.constructor=e,y(e,f)}function P(e){var f=typeof Map=="function"?new Map:void 0;return P=function(l){if(l===null||!g(l))return l;if(typeof l!="function")throw new TypeError("Super expression must either be null or a function");if(typeof f!="undefined"){if(f.has(l))return f.get(l);f.set(l,h)}function h(){return R(l,arguments,S(this).constructor)}return h.prototype=Object.create(l.prototype,{constructor:{value:h,enumerable:!1,writable:!0,configurable:!0}}),y(h,l)},P(e)}function R(e,f,s){return L()?R=Reflect.construct:R=function(h,d,o){var a=[null];a.push.apply(a,d);var i=Function.bind.apply(h,a),n=new i;return o&&y(n,o.prototype),n},R.apply(null,arguments)}function L(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function g(e){return Function.toString.call(e).indexOf("[native code]")!==-1}function y(e,f){return y=Object.setPrototypeOf||function(l,h){return l.__proto__=h,l},y(e,f)}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(s){return s.__proto__||Object.getPrototypeOf(s)},S(e)}function p(){return p=Object.assign||function(e){for(var f=1;f<arguments.length;f++){var s=arguments[f];for(var l in s)Object.prototype.hasOwnProperty.call(s,l)&&(e[l]=s[l])}return e},p.apply(this,arguments)}function E(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}var m=function(){function e(s){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=s.fetchSetup||t,this.controller=new self.AbortController,this.stats=new A.LoadStats}var f=e.prototype;return f.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},f.abortInternal=function(){var l=this.response;(!l||!l.ok)&&(this.stats.aborted=!0,this.controller.abort())},f.abort=function(){var l;this.abortInternal(),(l=this.callbacks)!==null&&l!==void 0&&l.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},f.load=function(l,h,d){var o=this,a=this.stats;if(a.loading.start)throw new Error("Loader can only be used once.");a.loading.start=self.performance.now();var i=u(l,this.controller.signal),n=d.onProgress,v=l.responseType==="arraybuffer",c=v?"byteLength":"length";this.context=l,this.config=h,this.callbacks=d,this.request=this.fetchSetup(l,i),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){o.abortInternal(),d.onTimeout(a,l,o.response)},h.timeout),self.fetch(this.request).then(function(x){if(o.response=o.loader=x,!x.ok){var O=x.status,I=x.statusText;throw new r(I||"fetch, bad network response",O,x)}return a.loading.first=Math.max(self.performance.now(),a.loading.start),a.total=parseInt(x.headers.get("Content-Length")||"0"),n&&Object(C.isFiniteNumber)(h.highWaterMark)?o.loadProgressively(x,a,l,h.highWaterMark,n):v?x.arrayBuffer():x.text()}).then(function(x){var O=o.response;self.clearTimeout(o.requestTimeout),a.loading.end=Math.max(self.performance.now(),a.loading.first),a.loaded=a.total=x[c];var I={url:O.url,data:x};n&&!Object(C.isFiniteNumber)(h.highWaterMark)&&n(a,l,x,O),d.onSuccess(I,a,l,O)}).catch(function(x){if(self.clearTimeout(o.requestTimeout),!a.aborted){var O=x.code||0;d.onError({code:O,text:x.message},l,x.details)}})},f.getCacheAge=function(){var l=null;if(this.response){var h=this.response.headers.get("age");l=h?parseFloat(h):null}return l},f.loadProgressively=function(l,h,d,o,a){o===void 0&&(o=0);var i=new D.default,n=l.body.getReader(),v=function c(){return n.read().then(function(x){if(x.done)return i.dataLength&&a(h,d,i.flush(),l),Promise.resolve(new ArrayBuffer(0));var O=x.value,I=O.length;return h.loaded+=I,I<o||i.dataLength?(i.push(O),i.dataLength>=o&&a(h,d,i.flush(),l)):a(h,d,O,l),c()}).catch(function(){return Promise.reject()})};return v()},e}();function u(e,f){var s={method:"GET",mode:"cors",credentials:"same-origin",signal:f,headers:new self.Headers(p({},e.headers))};return e.rangeEnd&&s.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1)),s}function t(e,f){return new self.Request(e.url,f)}var r=function(e){M(f,e);function f(s,l,h){var d;return d=e.call(this,s)||this,d.code=void 0,d.details=void 0,d.code=l,d.details=h,d}return f}(P(Error));b.default=m},"./src/utils/imsc1-ttml-parser.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"IMSC1_CODEC",function(){return g}),T.d(b,"parseIMSC1",function(){return E});var C=T("./src/utils/mp4-tools.ts"),A=T("./src/utils/vttparser.ts"),D=T("./src/utils/vttcue.ts"),M=T("./src/demux/id3.ts"),P=T("./src/utils/timescale-conversion.ts"),R=T("./src/utils/webvtt-parser.ts");function L(){return L=Object.assign||function(o){for(var a=1;a<arguments.length;a++){var i=arguments[a];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(o[n]=i[n])}return o},L.apply(this,arguments)}var g="stpp.ttml.im1t",y=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,S=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,p={left:"start",center:"center",right:"end",start:"start",end:"end"};function E(o,a,i,n,v){var c=Object(C.findBox)(new Uint8Array(o),["mdat"]);if(c.length===0){v(new Error("Could not parse IMSC1 mdat"));return}var x=c[0],O=Object(M.utf8ArrayToStr)(new Uint8Array(o,x.start,x.end-x.start)),I=Object(P.toTimescaleFromScale)(a,1,i);try{n(m(O,I))}catch(F){v(F)}}function m(o,a){var i=new DOMParser,n=i.parseFromString(o,"text/xml"),v=n.getElementsByTagName("tt")[0];if(!v)throw new Error("Invalid ttml");var c={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},x=Object.keys(c).reduce(function(U,k){return U[k]=v.getAttribute("ttp:"+k)||c[k],U},{}),O=v.getAttribute("xml:space")!=="preserve",I=t(u(v,"styling","style")),F=t(u(v,"layout","region")),B=u(v,"body","[begin]");return[].map.call(B,function(U){var k=r(U,O);if(!k||!U.hasAttribute("begin"))return null;var N=l(U.getAttribute("begin"),x),K=l(U.getAttribute("dur"),x),W=l(U.getAttribute("end"),x);if(N===null)throw s(U);if(W===null){if(K===null)throw s(U);W=N+K}var w=new D.default(N-a,W-a,k);w.id=Object(R.generateCueId)(w.startTime,w.endTime,w.text);var H=F[U.getAttribute("region")],V=I[U.getAttribute("style")];w.position=10,w.size=80;var j=e(H,V),X=j.textAlign;if(X){var Y=p[X];Y&&(w.lineAlign=Y),w.align=X}return L(w,j),w}).filter(function(U){return U!==null})}function u(o,a,i){var n=o.getElementsByTagName(a)[0];return n?[].slice.call(n.querySelectorAll(i)):[]}function t(o){return o.reduce(function(a,i){var n=i.getAttribute("xml:id");return n&&(a[n]=i),a},{})}function r(o,a){return[].slice.call(o.childNodes).reduce(function(i,n,v){var c;return n.nodeName==="br"&&v?i+`
`:(c=n.childNodes)!==null&&c!==void 0&&c.length?r(n,a):a?i+n.textContent.trim().replace(/\s+/g," "):i+n.textContent},"")}function e(o,a){var i="http://www.w3.org/ns/ttml#styling",n=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"];return n.reduce(function(v,c){var x=f(a,i,c)||f(o,i,c);return x&&(v[c]=x),v},{})}function f(o,a,i){return o.hasAttributeNS(a,i)?o.getAttributeNS(a,i):null}function s(o){return new Error("Could not parse ttml timestamp "+o)}function l(o,a){if(!o)return null;var i=Object(A.parseTimeStamp)(o);return i===null&&(y.test(o)?i=h(o,a):S.test(o)&&(i=d(o,a))),i}function h(o,a){var i=y.exec(o),n=(i[4]|0)+(i[5]|0)/a.subFrameRate;return(i[1]|0)*3600+(i[2]|0)*60+(i[3]|0)+n/a.frameRate}function d(o,a){var i=S.exec(o),n=Number(i[1]),v=i[2];switch(v){case"h":return n*3600;case"m":return n*60;case"ms":return n*1e3;case"f":return n/a.frameRate;case"t":return n/a.tickRate}return n}},"./src/utils/logger.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"enableLogs",function(){return R}),T.d(b,"logger",function(){return L});var C=function(){},A={trace:C,debug:C,log:C,warn:C,info:C,error:C},D=A;function M(g){var y=self.console[g];return y?y.bind(self.console,"["+g+"] >"):C}function P(g){for(var y=arguments.length,S=new Array(y>1?y-1:0),p=1;p<y;p++)S[p-1]=arguments[p];S.forEach(function(E){D[E]=g[E]?g[E].bind(g):M(E)})}function R(g){if(self.console&&g===!0||typeof g=="object"){P(g,"debug","log","info","warn","error");try{D.log()}catch(y){D=A}}else D=A}var L=D},"./src/utils/mediakeys-helper.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"KeySystems",function(){return C}),T.d(b,"requestMediaKeySystemAccess",function(){return A});var C;(function(D){D.WIDEVINE="com.widevine.alpha",D.PLAYREADY="com.microsoft.playready"})(C||(C={}));var A=function(){return typeof self!="undefined"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}()},"./src/utils/mediasource-helper.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"getMediaSource",function(){return C});function C(){return self.MediaSource||self.WebKitMediaSource}},"./src/utils/mp4-tools.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"bin2str",function(){return P}),T.d(b,"readUint16",function(){return R}),T.d(b,"readUint32",function(){return L}),T.d(b,"writeUint32",function(){return g}),T.d(b,"findBox",function(){return y}),T.d(b,"parseSegmentIndex",function(){return S}),T.d(b,"parseInitSegment",function(){return p}),T.d(b,"getStartDTS",function(){return E}),T.d(b,"getDuration",function(){return m}),T.d(b,"computeRawDurationFromSamples",function(){return u}),T.d(b,"offsetStartDTS",function(){return t}),T.d(b,"segmentValidRange",function(){return r}),T.d(b,"appendUint8Array",function(){return e});var C=T("./src/utils/typed-array.ts"),A=T("./src/loader/fragment.ts"),D=Math.pow(2,32)-1,M=[].push;function P(f){return String.fromCharCode.apply(null,f)}function R(f,s){"data"in f&&(s+=f.start,f=f.data);var l=f[s]<<8|f[s+1];return l<0?65536+l:l}function L(f,s){"data"in f&&(s+=f.start,f=f.data);var l=f[s]<<24|f[s+1]<<16|f[s+2]<<8|f[s+3];return l<0?4294967296+l:l}function g(f,s,l){"data"in f&&(s+=f.start,f=f.data),f[s]=l>>24,f[s+1]=l>>16&255,f[s+2]=l>>8&255,f[s+3]=l&255}function y(f,s){var l=[];if(!s.length)return l;var h,d,o;"data"in f?(h=f.data,d=f.start,o=f.end):(h=f,d=0,o=h.byteLength);for(var a=d;a<o;){var i=L(h,a),n=P(h.subarray(a+4,a+8)),v=i>1?a+i:o;if(n===s[0])if(s.length===1)l.push({data:h,start:a+8,end:v});else{var c=y({data:h,start:a+8,end:v},s.slice(1));c.length&&M.apply(l,c)}a=v}return l}function S(f){var s=y(f,["moov"]),l=s[0],h=l?l.end:null,d=y(f,["sidx"]);if(!d||!d[0])return null;var o=[],a=d[0],i=a.data[0],n=i===0?8:16,v=L(a,n);n+=4;var c=0,x=0;i===0?n+=8:n+=16,n+=2;var O=a.end+x,I=R(a,n);n+=2;for(var F=0;F<I;F++){var B=n,U=L(a,B);B+=4;var k=U&2147483647,N=(U&2147483648)>>>31;if(N===1)return console.warn("SIDX has hierarchical references (not supported)"),null;var K=L(a,B);B+=4,o.push({referenceSize:k,subsegmentDuration:K,info:{duration:K/v,start:O,end:O+k-1}}),O+=k,B+=4,n=B}return{earliestPresentationTime:c,timescale:v,version:i,referencesCount:I,references:o,moovEndOffset:h}}function p(f){for(var s=[],l=y(f,["moov","trak"]),h=0;h<l.length;h++){var d=l[h],o=y(d,["tkhd"])[0];if(o){var a=o.data[o.start],i=a===0?12:20,n=L(o,i),v=y(d,["mdia","mdhd"])[0];if(v){a=v.data[v.start],i=a===0?12:20;var c=L(v,i),x=y(d,["mdia","hdlr"])[0];if(x){var O=P(x.data.subarray(x.start+8,x.start+12)),I={soun:A.ElementaryStreamTypes.AUDIO,vide:A.ElementaryStreamTypes.VIDEO}[O];if(I){var F=y(d,["mdia","minf","stbl","stsd"])[0],B=void 0;F&&(B=P(F.data.subarray(F.start+12,F.start+16))),s[n]={timescale:c,type:I},s[I]={timescale:c,id:n,codec:B}}}}}}var U=y(f,["moov","mvex","trex"]);return U.forEach(function(k){var N=L(k,4),K=s[N];K&&(K.default={duration:L(k,12),flags:L(k,20)})}),s}function E(f,s){return y(s,["moof","traf"]).reduce(function(l,h){var d=y(h,["tfdt"])[0],o=d.data[d.start],a=y(h,["tfhd"]).reduce(function(i,n){var v=L(n,4),c=f[v];if(c){var x=L(d,4);o===1&&(x*=Math.pow(2,32),x+=L(d,8));var O=c.timescale||9e4,I=x/O;if(isFinite(I)&&(i===null||I<i))return I}return i},null);return a!==null&&isFinite(a)&&(l===null||a<l)?a:l},null)||0}function m(f,s){for(var l=0,h=0,d=0,o=y(f,["moof","traf"]),a=0;a<o.length;a++){var i=o[a],n=y(i,["tfhd"])[0],v=L(n,4),c=s[v];if(!!c){var x=c.default,O=L(n,0)|(x==null?void 0:x.flags),I=x==null?void 0:x.duration;O&8&&(O&2?I=L(n,12):I=L(n,8));for(var F=c.timescale||9e4,B=y(i,["trun"]),U=0;U<B.length;U++){if(l=u(B[U]),!l&&I){var k=L(B[U],4);l=I*k}c.type===A.ElementaryStreamTypes.VIDEO?h+=l/F:c.type===A.ElementaryStreamTypes.AUDIO&&(d+=l/F)}}}if(h===0&&d===0){var N=S(f);if(N!=null&&N.references)return N.references.reduce(function(K,W){return K+W.info.duration||0},0)}return h||d}function u(f){var s=L(f,0),l=8;s&1&&(l+=4),s&4&&(l+=4);for(var h=0,d=L(f,4),o=0;o<d;o++){if(s&256){var a=L(f,l);h+=a,l+=4}s&512&&(l+=4),s&1024&&(l+=4),s&2048&&(l+=4)}return h}function t(f,s,l){y(s,["moof","traf"]).forEach(function(h){y(h,["tfhd"]).forEach(function(d){var o=L(d,4),a=f[o];if(!!a){var i=a.timescale||9e4;y(h,["tfdt"]).forEach(function(n){var v=n.data[n.start],c=L(n,4);if(v===0)g(n,4,c-l*i);else{c*=Math.pow(2,32),c+=L(n,8),c-=l*i,c=Math.max(c,0);var x=Math.floor(c/(D+1)),O=Math.floor(c%(D+1));g(n,4,x),g(n,8,O)}})}})})}function r(f){var s={valid:null,remainder:null},l=y(f,["moof"]);if(l){if(l.length<2)return s.remainder=f,s}else return s;var h=l[l.length-1];return s.valid=Object(C.sliceUint8)(f,0,h.start-8),s.remainder=Object(C.sliceUint8)(f,h.start-8),s}function e(f,s){var l=new Uint8Array(f.length+s.length);return l.set(f),l.set(s,f.length),l}},"./src/utils/output-filter.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"default",function(){return C});var C=function(){function A(M,P){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=M,this.trackName=P}var D=A.prototype;return D.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},D.newCue=function(P,R,L){(this.startTime===null||this.startTime>P)&&(this.startTime=P),this.endTime=R,this.screen=L,this.timelineController.createCaptionsTrack(this.trackName)},D.reset=function(){this.cueRanges=[],this.startTime=null},A}()},"./src/utils/texttrack-utils.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"sendAddTrackEvent",function(){return A}),T.d(b,"addCueToTrack",function(){return D}),T.d(b,"clearCurrentCues",function(){return M}),T.d(b,"removeCuesInRange",function(){return P}),T.d(b,"getCuesInRange",function(){return L});var C=T("./src/utils/logger.ts");function A(g,y){var S;try{S=new Event("addtrack")}catch(p){S=document.createEvent("Event"),S.initEvent("addtrack",!1,!1)}S.track=g,y.dispatchEvent(S)}function D(g,y){var S=g.mode;if(S==="disabled"&&(g.mode="hidden"),g.cues&&!g.cues.getCueById(y.id))try{if(g.addCue(y),!g.cues.getCueById(y.id))throw new Error("addCue is failed for: "+y)}catch(E){C.logger.debug("[texttrack-utils]: "+E);var p=new self.TextTrackCue(y.startTime,y.endTime,y.text);p.id=y.id,g.addCue(p)}S==="disabled"&&(g.mode=S)}function M(g){var y=g.mode;if(y==="disabled"&&(g.mode="hidden"),g.cues)for(var S=g.cues.length;S--;)g.removeCue(g.cues[S]);y==="disabled"&&(g.mode=y)}function P(g,y,S){var p=g.mode;if(p==="disabled"&&(g.mode="hidden"),g.cues&&g.cues.length>0)for(var E=L(g.cues,y,S),m=0;m<E.length;m++)g.removeCue(E[m]);p==="disabled"&&(g.mode=p)}function R(g,y){if(y<g[0].startTime)return 0;var S=g.length-1;if(y>g[S].endTime)return-1;for(var p=0,E=S;p<=E;){var m=Math.floor((E+p)/2);if(y<g[m].startTime)E=m-1;else if(y>g[m].startTime&&p<S)p=m+1;else return m}return g[p].startTime-y<y-g[E].startTime?p:E}function L(g,y,S){var p=[],E=R(g,y);if(E>-1)for(var m=E,u=g.length;m<u;m++){var t=g[m];if(t.startTime>=y&&t.endTime<=S)p.push(t);else if(t.startTime>S)return p}return p}},"./src/utils/time-ranges.ts":function(G,b,T){"use strict";T.r(b);var C={toString:function(D){for(var M="",P=D.length,R=0;R<P;R++)M+="["+D.start(R).toFixed(3)+","+D.end(R).toFixed(3)+"]";return M}};b.default=C},"./src/utils/timescale-conversion.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"toTimescaleFromBase",function(){return A}),T.d(b,"toTimescaleFromScale",function(){return D}),T.d(b,"toMsFromMpegTsClock",function(){return M}),T.d(b,"toMpegTsClockFromTimescale",function(){return P});var C=9e4;function A(R,L,g,y){g===void 0&&(g=1),y===void 0&&(y=!1);var S=R*L*g;return y?Math.round(S):S}function D(R,L,g,y){return g===void 0&&(g=1),y===void 0&&(y=!1),A(R,L,1/g,y)}function M(R,L){return L===void 0&&(L=!1),A(R,1e3,1/C,L)}function P(R,L){return L===void 0&&(L=1),A(R,C,1/L)}},"./src/utils/typed-array.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"sliceUint8",function(){return C});function C(A,D,M){return Uint8Array.prototype.slice?A.slice(D,M):new Uint8Array(Array.prototype.slice.call(A,D,M))}},"./src/utils/vttcue.ts":function(G,b,T){"use strict";T.r(b),b.default=function(){if(typeof self!="undefined"&&self.VTTCue)return self.VTTCue;var C=["","lr","rl"],A=["start","middle","end","left","right"];function D(g,y){if(typeof y!="string"||!Array.isArray(g))return!1;var S=y.toLowerCase();return~g.indexOf(S)?S:!1}function M(g){return D(C,g)}function P(g){return D(A,g)}function R(g){for(var y=arguments.length,S=new Array(y>1?y-1:0),p=1;p<y;p++)S[p-1]=arguments[p];for(var E=1;E<arguments.length;E++){var m=arguments[E];for(var u in m)g[u]=m[u]}return g}function L(g,y,S){var p=this,E={enumerable:!0};p.hasBeenReset=!1;var m="",u=!1,t=g,r=y,e=S,f=null,s="",l=!0,h="auto",d="start",o=50,a="middle",i=50,n="middle";Object.defineProperty(p,"id",R({},E,{get:function(){return m},set:function(c){m=""+c}})),Object.defineProperty(p,"pauseOnExit",R({},E,{get:function(){return u},set:function(c){u=!!c}})),Object.defineProperty(p,"startTime",R({},E,{get:function(){return t},set:function(c){if(typeof c!="number")throw new TypeError("Start time must be set to a number.");t=c,this.hasBeenReset=!0}})),Object.defineProperty(p,"endTime",R({},E,{get:function(){return r},set:function(c){if(typeof c!="number")throw new TypeError("End time must be set to a number.");r=c,this.hasBeenReset=!0}})),Object.defineProperty(p,"text",R({},E,{get:function(){return e},set:function(c){e=""+c,this.hasBeenReset=!0}})),Object.defineProperty(p,"region",R({},E,{get:function(){return f},set:function(c){f=c,this.hasBeenReset=!0}})),Object.defineProperty(p,"vertical",R({},E,{get:function(){return s},set:function(c){var x=M(c);if(x===!1)throw new SyntaxError("An invalid or illegal string was specified.");s=x,this.hasBeenReset=!0}})),Object.defineProperty(p,"snapToLines",R({},E,{get:function(){return l},set:function(c){l=!!c,this.hasBeenReset=!0}})),Object.defineProperty(p,"line",R({},E,{get:function(){return h},set:function(c){if(typeof c!="number"&&c!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");h=c,this.hasBeenReset=!0}})),Object.defineProperty(p,"lineAlign",R({},E,{get:function(){return d},set:function(c){var x=P(c);if(!x)throw new SyntaxError("An invalid or illegal string was specified.");d=x,this.hasBeenReset=!0}})),Object.defineProperty(p,"position",R({},E,{get:function(){return o},set:function(c){if(c<0||c>100)throw new Error("Position must be between 0 and 100.");o=c,this.hasBeenReset=!0}})),Object.defineProperty(p,"positionAlign",R({},E,{get:function(){return a},set:function(c){var x=P(c);if(!x)throw new SyntaxError("An invalid or illegal string was specified.");a=x,this.hasBeenReset=!0}})),Object.defineProperty(p,"size",R({},E,{get:function(){return i},set:function(c){if(c<0||c>100)throw new Error("Size must be between 0 and 100.");i=c,this.hasBeenReset=!0}})),Object.defineProperty(p,"align",R({},E,{get:function(){return n},set:function(c){var x=P(c);if(!x)throw new SyntaxError("An invalid or illegal string was specified.");n=x,this.hasBeenReset=!0}})),p.displayState=void 0}return L.prototype.getCueAsHTML=function(){var g=self.WebVTT;return g.convertCueToDOMTree(self,this.text)},L}()},"./src/utils/vttparser.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"parseTimeStamp",function(){return D}),T.d(b,"fixLineBreaks",function(){return y}),T.d(b,"VTTParser",function(){return S});var C=T("./src/utils/vttcue.ts"),A=function(){function p(){}var E=p.prototype;return E.decode=function(u,t){if(!u)return"";if(typeof u!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(u))},p}();function D(p){function E(u,t,r,e){return(u|0)*3600+(t|0)*60+(r|0)+parseFloat(e||0)}var m=p.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return m?parseFloat(m[2])>59?E(m[2],m[3],0,m[4]):E(m[1],m[2],m[3],m[4]):null}var M=function(){function p(){this.values=Object.create(null)}var E=p.prototype;return E.set=function(u,t){!this.get(u)&&t!==""&&(this.values[u]=t)},E.get=function(u,t,r){return r?this.has(u)?this.values[u]:t[r]:this.has(u)?this.values[u]:t},E.has=function(u){return u in this.values},E.alt=function(u,t,r){for(var e=0;e<r.length;++e)if(t===r[e]){this.set(u,t);break}},E.integer=function(u,t){/^-?\d+$/.test(t)&&this.set(u,parseInt(t,10))},E.percent=function(u,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var r=parseFloat(t);if(r>=0&&r<=100)return this.set(u,r),!0}return!1},p}();function P(p,E,m,u){var t=u?p.split(u):[p];for(var r in t)if(typeof t[r]=="string"){var e=t[r].split(m);if(e.length===2){var f=e[0],s=e[1];E(f,s)}}}var R=new C.default(0,0,""),L=R.align==="middle"?"middle":"center";function g(p,E,m){var u=p;function t(){var f=D(p);if(f===null)throw new Error("Malformed timestamp: "+u);return p=p.replace(/^[^\sa-zA-Z-]+/,""),f}function r(f,s){var l=new M;P(f,function(o,a){var i;switch(o){case"region":for(var n=m.length-1;n>=0;n--)if(m[n].id===a){l.set(o,m[n].region);break}break;case"vertical":l.alt(o,a,["rl","lr"]);break;case"line":i=a.split(","),l.integer(o,i[0]),l.percent(o,i[0])&&l.set("snapToLines",!1),l.alt(o,i[0],["auto"]),i.length===2&&l.alt("lineAlign",i[1],["start",L,"end"]);break;case"position":i=a.split(","),l.percent(o,i[0]),i.length===2&&l.alt("positionAlign",i[1],["start",L,"end","line-left","line-right","auto"]);break;case"size":l.percent(o,a);break;case"align":l.alt(o,a,["start",L,"end","left","right"]);break}},/:/,/\s/),s.region=l.get("region",null),s.vertical=l.get("vertical","");var h=l.get("line","auto");h==="auto"&&R.line===-1&&(h=-1),s.line=h,s.lineAlign=l.get("lineAlign","start"),s.snapToLines=l.get("snapToLines",!0),s.size=l.get("size",100),s.align=l.get("align",L);var d=l.get("position","auto");d==="auto"&&R.position===50&&(d=s.align==="start"||s.align==="left"?0:s.align==="end"||s.align==="right"?100:50),s.position=d}function e(){p=p.replace(/^\s+/,"")}if(e(),E.startTime=t(),e(),p.substr(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+u);p=p.substr(3),e(),E.endTime=t(),e(),r(p,E)}function y(p){return p.replace(/<br(?: \/)?>/gi,`
`)}var S=function(){function p(){this.state="INITIAL",this.buffer="",this.decoder=new A,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var E=p.prototype;return E.parse=function(u){var t=this;u&&(t.buffer+=t.decoder.decode(u,{stream:!0}));function r(){var d=t.buffer,o=0;for(d=y(d);o<d.length&&d[o]!=="\r"&&d[o]!==`
`;)++o;var a=d.substr(0,o);return d[o]==="\r"&&++o,d[o]===`
`&&++o,t.buffer=d.substr(o),a}function e(d){P(d,function(o,a){},/:/)}try{var f="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;f=r();var s=f.match(/^()?WEBVTT([ \t].*)?$/);if(!s||!s[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}for(var l=!1;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(l?l=!1:f=r(),t.state){case"HEADER":/:/.test(f)?e(f):f||(t.state="ID");continue;case"NOTE":f||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(f)){t.state="NOTE";break}if(!f)continue;if(t.cue=new C.default(0,0,""),t.state="CUE",f.indexOf("-->")===-1){t.cue.id=f;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{g(f,t.cue,t.regionList)}catch(d){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{var h=f.indexOf("-->")!==-1;if(!f||h&&(l=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=f}continue;case"BADCUE":f||(t.state="ID")}}}catch(d){t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},E.flush=function(){var u=this;try{if((u.cue||u.state==="HEADER")&&(u.buffer+=`

`,u.parse()),u.state==="INITIAL"||u.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){u.onparsingerror&&u.onparsingerror(t)}return u.onflush&&u.onflush(),this},p}()},"./src/utils/webvtt-parser.ts":function(G,b,T){"use strict";T.r(b),T.d(b,"generateCueId",function(){return S}),T.d(b,"parseWebVTT",function(){return E});var C=T("./src/polyfills/number.ts"),A=T("./src/utils/vttparser.ts"),D=T("./src/demux/id3.ts"),M=T("./src/utils/timescale-conversion.ts"),P=T("./src/remux/mp4-remuxer.ts"),R=/\r\n|\n\r|\n|\r/g,L=function(u,t,r){return r===void 0&&(r=0),u.substr(r,t.length)===t},g=function(u){var t=parseInt(u.substr(-3)),r=parseInt(u.substr(-6,2)),e=parseInt(u.substr(-9,2)),f=u.length>9?parseInt(u.substr(0,u.indexOf(":"))):0;if(!Object(C.isFiniteNumber)(t)||!Object(C.isFiniteNumber)(r)||!Object(C.isFiniteNumber)(e)||!Object(C.isFiniteNumber)(f))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+u);return t+=1e3*r,t+=60*1e3*e,t+=60*60*1e3*f,t},y=function(u){for(var t=5381,r=u.length;r;)t=t*33^u.charCodeAt(--r);return(t>>>0).toString()};function S(m,u,t){return y(m.toString())+y(u.toString())+y(t)}var p=function(u,t,r){var e=u[t],f=u[e.prevCC];if(!f||!f.new&&e.new){u.ccOffset=u.presentationOffset=e.start,e.new=!1;return}for(;(s=f)!==null&&s!==void 0&&s.new;){var s;u.ccOffset+=e.start-f.start,e.new=!1,e=f,f=u[e.prevCC]}u.presentationOffset=r};function E(m,u,t,r,e,f,s,l){var h=new A.VTTParser,d=Object(D.utf8ArrayToStr)(new Uint8Array(m)).trim().replace(R,`
`).split(`
`),o=[],a=Object(M.toMpegTsClockFromTimescale)(u,t),i="00:00.000",n=0,v=0,c,x=!0,O=!1;h.oncue=function(I){var F=r[e],B=r.ccOffset,U=(n-a)/9e4;if(F!=null&&F.new&&(v!==void 0?B=r.ccOffset=F.start:p(r,e,U)),U&&(B=U-r.presentationOffset),O){var k=I.endTime-I.startTime,N=Object(P.normalizePts)((I.startTime+B-v)*9e4,f*9e4)/9e4;I.startTime=N,I.endTime=N+k}var K=I.text.trim();I.text=decodeURIComponent(encodeURIComponent(K)),I.id||(I.id=S(I.startTime,I.endTime,K)),I.endTime>0&&o.push(I)},h.onparsingerror=function(I){c=I},h.onflush=function(){if(c){l(c);return}s(o)},d.forEach(function(I){if(x)if(L(I,"X-TIMESTAMP-MAP=")){x=!1,O=!0,I.substr(16).split(",").forEach(function(F){L(F,"LOCAL:")?i=F.substr(6):L(F,"MPEGTS:")&&(n=parseInt(F.substr(7)))});try{v=g(i)/1e3}catch(F){O=!1,c=F}return}else I===""&&(x=!1);h.parse(I+`
`)}),h.flush()}},"./src/utils/xhr-loader.ts":function(G,b,T){"use strict";T.r(b);var C=T("./src/utils/logger.ts"),A=T("./src/loader/load-stats.ts"),D=/^age:\s*[\d.]+\s*$/m,M=function(){function P(L){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=L?L.xhrSetup:null,this.stats=new A.LoadStats,this.retryDelay=0}var R=P.prototype;return R.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},R.abortInternal=function(){var g=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),g&&(g.onreadystatechange=null,g.onprogress=null,g.readyState!==4&&(this.stats.aborted=!0,g.abort()))},R.abort=function(){var g;this.abortInternal(),(g=this.callbacks)!==null&&g!==void 0&&g.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},R.load=function(g,y,S){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=g,this.config=y,this.callbacks=S,this.retryDelay=y.retryDelay,this.loadInternal()},R.loadInternal=function(){var g=this.config,y=this.context;if(!!g){var S=this.loader=new self.XMLHttpRequest,p=this.stats;p.loading.first=0,p.loaded=0;var E=this.xhrSetup;try{if(E)try{E(S,y.url)}catch(t){S.open("GET",y.url,!0),E(S,y.url)}S.readyState||S.open("GET",y.url,!0);var m=this.context.headers;if(m)for(var u in m)S.setRequestHeader(u,m[u])}catch(t){this.callbacks.onError({code:S.status,text:t.message},y,S);return}y.rangeEnd&&S.setRequestHeader("Range","bytes="+y.rangeStart+"-"+(y.rangeEnd-1)),S.onreadystatechange=this.readystatechange.bind(this),S.onprogress=this.loadprogress.bind(this),S.responseType=y.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),g.timeout),S.send()}},R.readystatechange=function(){var g=this.context,y=this.loader,S=this.stats;if(!(!g||!y)){var p=y.readyState,E=this.config;if(!S.aborted&&p>=2)if(self.clearTimeout(this.requestTimeout),S.loading.first===0&&(S.loading.first=Math.max(self.performance.now(),S.loading.start)),p===4){y.onreadystatechange=null,y.onprogress=null;var m=y.status;if(m>=200&&m<300){S.loading.end=Math.max(self.performance.now(),S.loading.first);var u,t;if(g.responseType==="arraybuffer"?(u=y.response,t=u.byteLength):(u=y.responseText,t=u.length),S.loaded=S.total=t,!this.callbacks)return;var r=this.callbacks.onProgress;if(r&&r(S,g,u,y),!this.callbacks)return;var e={url:y.responseURL,data:u};this.callbacks.onSuccess(e,S,g,y)}else S.retry>=E.maxRetry||m>=400&&m<499?(C.logger.error(m+" while loading "+g.url),this.callbacks.onError({code:m,text:y.statusText},g,y)):(C.logger.warn(m+" while loading "+g.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,E.maxRetryDelay),S.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),E.timeout)}},R.loadtimeout=function(){C.logger.warn("timeout while loading "+this.context.url);var g=this.callbacks;g&&(this.abortInternal(),g.onTimeout(this.stats,this.context,this.loader))},R.loadprogress=function(g){var y=this.stats;y.loaded=g.loaded,g.lengthComputable&&(y.total=g.total)},R.getCacheAge=function(){var g=null;if(this.loader&&D.test(this.loader.getAllResponseHeaders())){var y=this.loader.getResponseHeader("age");g=y?parseFloat(y):null}return g},P}();b.default=M}}).default})}}]);
