import{$o as e,Ao as t,Fo as n,Hn as r,Ko as i,Mo as a,No as o,Oa as s,kr as c,ni as l,qo as u,ti as d,wr as f}from"./index-zRImlZB6.js";var p=u(((e,t)=>{Object.defineProperty(e,`__esModule`,{value:!0});function n(e){return typeof e==`object`&&!(`toString`in e)?Object.prototype.toString.call(e).slice(8,-1):e}var r=typeof process==`object`&&!0;function i(e,t){if(!e)throw r?Error(`Invariant failed`):Error(t())}e.invariant=i;var a=Object.prototype.hasOwnProperty,o=Array.prototype.splice,s=Object.prototype.toString;function c(e){return s.call(e).slice(8,-1)}var l=Object.assign||(function(e,t){return u(t).forEach(function(n){a.call(t,n)&&(e[n]=t[n])}),e}),u=typeof Object.getOwnPropertySymbols==`function`?function(e){return Object.keys(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.keys(e)};function d(e){return Array.isArray(e)?l(e.constructor(e.length),e):c(e)===`Map`?new Map(e):c(e)===`Set`?new Set(e):e&&typeof e==`object`?l(Object.create(Object.getPrototypeOf(e)),e):e}var f=function(){function e(){this.commands=l({},p),this.update=this.update.bind(this),this.update.extend=this.extend=this.extend.bind(this),this.update.isEquals=function(e,t){return e===t},this.update.newContext=function(){return new e().update}}return Object.defineProperty(e.prototype,`isEquals`,{get:function(){return this.update.isEquals},set:function(e){this.update.isEquals=e},enumerable:!0,configurable:!0}),e.prototype.extend=function(e,t){this.commands[e]=t},e.prototype.update=function(e,t){var n=this,r=typeof t==`function`?{$apply:t}:t;Array.isArray(e)&&Array.isArray(r)||i(!Array.isArray(r),function(){return`update(): You provided an invalid spec to update(). The spec may not contain an array except as the value of $set, $push, $unshift, $splice or any custom command allowing an array value.`}),i(typeof r==`object`&&!!r,function(){return`update(): You provided an invalid spec to update(). The spec and every included key path must be plain objects containing one of the `+(`following commands: `+Object.keys(n.commands).join(`, `)+`.`)});var o=e;return u(r).forEach(function(t){if(a.call(n.commands,t)){var i=e===o;o=n.commands[t](r[t],o,r,e),i&&n.isEquals(o,e)&&(o=e)}else{var s=c(e)===`Map`?n.update(e.get(t),r[t]):n.update(e[t],r[t]),l=c(o)===`Map`?o.get(t):o[t];(!n.isEquals(s,l)||s===void 0&&!a.call(e,t))&&(o===e&&(o=d(e)),c(o)===`Map`?o.set(t,s):o[t]=s)}}),o},e}();e.Context=f;var p={$push:function(e,t,n){return h(t,n,`$push`),e.length?t.concat(e):t},$unshift:function(e,t,n){return h(t,n,`$unshift`),e.length?e.concat(t):t},$splice:function(e,t,n,r){return _(t,n),e.forEach(function(e){v(e),t===r&&e.length&&(t=d(r)),o.apply(t,e)}),t},$set:function(e,t,n){return b(n),e},$toggle:function(e,t){g(e,`$toggle`);var n=e.length?d(t):t;return e.forEach(function(e){n[e]=!t[e]}),n},$unset:function(e,t,n,r){return g(e,`$unset`),e.forEach(function(e){Object.hasOwnProperty.call(t,e)&&(t===r&&(t=d(r)),delete t[e])}),t},$add:function(e,t,n,r){return S(t,`$add`),g(e,`$add`),c(t)===`Map`?e.forEach(function(e){var n=e[0],i=e[1];t===r&&t.get(n)!==i&&(t=d(r)),t.set(n,i)}):e.forEach(function(e){t===r&&!t.has(e)&&(t=d(r)),t.add(e)}),t},$remove:function(e,t,n,r){return S(t,`$remove`),g(e,`$remove`),e.forEach(function(e){t===r&&t.has(e)&&(t=d(r)),t.delete(e)}),t},$merge:function(e,t,n,r){return x(t,e),u(e).forEach(function(n){e[n]!==t[n]&&(t===r&&(t=d(r)),t[n]=e[n])}),t},$apply:function(e,t){return y(e),e(t)}},m=new f;e.isEquals=m.update.isEquals,e.extend=m.extend,e.default=m.update,e.default.default=t.exports=l(e.default,e);function h(e,t,r){i(Array.isArray(e),function(){return`update(): expected target of `+n(r)+` to be an array; got `+n(e)+`.`}),g(t[r],r)}function g(e,t){i(Array.isArray(e),function(){return`update(): expected spec of `+n(t)+` to be an array; got `+n(e)+`. Did you forget to wrap your parameter in an array?`})}function _(e,t){i(Array.isArray(e),function(){return`Expected $splice target to be an array; got `+n(e)}),v(t.$splice)}function v(e){i(Array.isArray(e),function(){return`update(): expected spec of $splice to be an array of arrays; got `+n(e)+`. Did you forget to wrap your parameters in an array?`})}function y(e){i(typeof e==`function`,function(){return`update(): expected spec of $apply to be a function; got `+n(e)+`.`})}function b(e){i(Object.keys(e).length===1,function(){return`Cannot have more than one key in an object with $set`})}function x(e,t){i(t&&typeof t==`object`,function(){return`update(): $merge expects a spec of type 'object'; got `+n(t)}),i(e&&typeof e==`object`,function(){return`update(): $merge expects a target of type 'object'; got `+n(e)})}function S(e,t){var r=c(e);i(r===`Map`||r===`Set`,function(){return`update(): `+n(t)+` expects a target of type Set or Map; got `+n(r)})}})),m=e(i()),h=e(p()),g=function(e){o(n,e);function n(t){var n=e.call(this,t)||this;return n.state={items:t.items?t.items.concat():[]},n.handleLoaded=n.handleLoaded.bind(n),n.tick=n.tick.bind(n),n}return n.prototype.componentDidMount=function(){this.tick(!!this.props.checkApi)},n.prototype.componentDidUpdate=function(e){var t=this.props;e.items===t.items?d(e.checkApi,t.checkApi,e.data,t.data)&&this.tick(!0):this.setState({items:t.items?t.items.concat():[]})},n.prototype.componentWillUnmount=function(){clearTimeout(this.timer)},n.prototype.reload=function(){this.tick(!0)},n.prototype.tick=function(e){var t=this;e===void 0&&(e=!1);var n=this.props,r=n.loadingStatusCode,i=n.data,a=n.interval,o=n.checkApi,s=n.env,c=this.state.items;if(clearTimeout(this.timer),!(!e&&!c.some(function(e){return e.status===r}))){if(a&&!l(o))return s.alert(`checkApi 没有设置, 不能及时获取任务状态`);l(o,i)&&s&&s.fetcher(o,i).then(this.handleLoaded).catch(function(e){return t.setState({error:e})})}},n.prototype.handleLoaded=function(e){if(!Array.isArray(e.data))return this.props.env.alert(`返回格式不正确, 期望 response.data 为数组, 包含每个 task 的状态信息`);this.setState({items:e.data});var t=this.props.interval;clearTimeout(this.timer),this.timer=setTimeout(this.tick,t)},n.prototype.submitTask=function(e,n,r){var i=this;r===void 0&&(r=!1);var a=this.props,o=a.submitApi,c=a.reSubmitApi,u=a.loadingStatusCode,d=a.errorStatusCode,f=a.data,p=a.env;if(!r&&!l(o))return p.alert(`submitApi 没有配置`);if(r&&!l(c))return p.alert(`reSubmitApi 没有配置`);this.setState((0,h.default)(this.state,{items:{$splice:[[n,1,t(t({},e),{status:u})]]}}));var m=r?c:o;l(m,f)&&p&&p.fetcher(m,s(f,e)).then(function(e){if(e&&e.data){if(Array.isArray(e.data))i.handleLoaded(e);else{m&&m.replaceData;var n=i.state.items.map(function(n){return n.key===e.data.key?t(t({},m.replaceData?{}:n),e.data):n});i.handleLoaded(t(t({},e),{data:n}))}return}clearTimeout(i.timer),i.timer=setTimeout(i.tick,4)}).catch(function(r){return i.setState((0,h.default)(i.state,{items:{$splice:[[n,1,t(t({},e),{status:d,remark:r.message||r})]]}}))})},n.prototype.render=function(){var e=this,t=this.props,n=t.classnames,i=t.className,a=t.style,o=t.tableClassName,s=t.taskNameLabel,c=t.operationLabel,l=t.statusLabel,u=t.remarkLabel,d=t.btnText,f=t.retryBtnText,p=t.btnClassName,h=t.retryBtnClassName,g=t.statusLabelMap,_=t.statusTextMap,v=t.readyStatusCode,y=t.loadingStatusCode,b=t.canRetryStatusCode,x=t.translate,S=t.render,C=t.loadingConfig,w=this.state.items,T=this.state.error;return m.createElement(`div`,{className:n(`Table-content`,i),style:a},m.createElement(`table`,{className:n(`Table-table`,o)},m.createElement(`thead`,null,m.createElement(`tr`,null,m.createElement(`th`,null,s),m.createElement(`th`,null,x(c)),m.createElement(`th`,null,l),m.createElement(`th`,null,u))),m.createElement(`tbody`,null,T?m.createElement(`tr`,null,m.createElement(`td`,{colSpan:4},m.createElement(`div`,{className:`text-danger`},T))):w.map(function(t,i){var a;return m.createElement(`tr`,{key:i},m.createElement(`td`,null,m.createElement(`span`,{className:n(`word-break`)},t.label)),m.createElement(`td`,null,t.status==y?m.createElement(r,{loadingConfig:C,show:!0,icon:`reload`,spinnerClassName:n(`Task-spinner`)}):t.status==b?m.createElement(`a`,{onClick:function(){return e.submitTask(t,i,!0)},className:n(`Button`,`Button--danger`,`Button--size-md`,h||p)},f||d):m.createElement(`a`,{onClick:function(){return e.submitTask(t,i)},className:n(`Button`,`Button--default`,`Button--size-md`,p,(a={},a[`is-disabled`]=t.status!==v,a))},d)),m.createElement(`td`,null,m.createElement(`span`,{className:n(`label`,g&&g[t.status||0])},_&&_[t.status||0])),m.createElement(`td`,null,t.remark?S(`${i}/remark`,t.remark):null))}))))},n.defaultProps={className:``,tableClassName:``,taskNameLabel:`任务名称`,operationLabel:`Table.operation`,statusLabel:`状态`,remarkLabel:`备注说明`,btnText:`上线`,retryBtnText:`重试`,btnClassName:``,retryBtnClassName:``,statusLabelMap:[`label-warning`,`label-info`,`label-info`,`label-danger`,`label-success`,`label-danger`],statusTextMap:[`未开始`,`就绪`,`进行中`,`出错`,`已完成`,`出错`],initialStatusCode:0,readyStatusCode:1,loadingStatusCode:2,errorStatusCode:3,finishStatusCode:4,canRetryStatusCode:5,interval:3e3},n}(m.Component),_=function(e){o(t,e);function t(t,n){var r=e.call(this,t)||this;return n.registerComponent(r),r}return t.prototype.componentWillUnmount=function(){e.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},t.contextType=c,t=a([f({type:`tasks`}),n(`design:paramtypes`,[Object,Object])],t),t}(g);export{_ as TaskRenderer,g as default};