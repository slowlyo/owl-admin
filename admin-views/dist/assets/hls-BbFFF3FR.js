import{qo as e}from"./index-Z33w_AY6.js";var t=e(((e,t)=>{typeof window<`u`&&(function(n,r){typeof e==`object`&&typeof t==`object`?t.exports=r():typeof define==`function`&&define.amd?define([],r):typeof e==`object`?e.Hls=r():n.Hls=r()})(e,function(){return(function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){typeof Symbol<`u`&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:`Module`}),Object.defineProperty(e,`__esModule`,{value:!0})},n.t=function(e,t){if(t&1&&(e=n(e)),t&8||t&4&&typeof e==`object`&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,`default`,{enumerable:!0,value:e}),t&2&&typeof e!=`string`)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,`a`,t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=`/dist/`,n(n.s=`./src/hls.ts`)})({"./node_modules/eventemitter3/index.js":(function(e,t,n){var r=Object.prototype.hasOwnProperty,i=`~`;function a(){}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(i=!1));function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,n,r,a){if(typeof n!=`function`)throw TypeError(`The listener must be a function`);var s=new o(n,r||e,a),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function c(e,t){--e._eventsCount===0?e._events=new a:delete e._events[t]}function l(){this._events=new a,this._eventsCount=0}l.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)r.call(t,n)&&e.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e},l.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,a=n.length,o=Array(a);r<a;r++)o[r]=n[r].fn;return o},l.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},l.prototype.emit=function(e,t,n,r,a,o){var s=i?i+e:e;if(!this._events[s])return!1;var c=this._events[s],l=arguments.length,u,d;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,r),!0;case 5:return c.fn.call(c.context,t,n,r,a),!0;case 6:return c.fn.call(c.context,t,n,r,a,o),!0}for(d=1,u=Array(l-1);d<l;d++)u[d-1]=arguments[d];c.fn.apply(c.context,u)}else{var f=c.length,p;for(d=0;d<f;d++)switch(c[d].once&&this.removeListener(e,c[d].fn,void 0,!0),l){case 1:c[d].fn.call(c[d].context);break;case 2:c[d].fn.call(c[d].context,t);break;case 3:c[d].fn.call(c[d].context,t,n);break;case 4:c[d].fn.call(c[d].context,t,n,r);break;default:if(!u)for(p=1,u=Array(l-1);p<l;p++)u[p-1]=arguments[p];c[d].fn.apply(c[d].context,u)}}return!0},l.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},l.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},l.prototype.removeListener=function(e,t,n,r){var a=i?i+e:e;if(!this._events[a])return this;if(!t)return c(this,a),this;var o=this._events[a];if(o.fn)o.fn===t&&(!r||o.once)&&(!n||o.context===n)&&c(this,a);else{for(var s=0,l=[],u=o.length;s<u;s++)(o[s].fn!==t||r&&!o[s].once||n&&o[s].context!==n)&&l.push(o[s]);l.length?this._events[a]=l.length===1?l[0]:l:c(this,a)}return this},l.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&c(this,t)):(this._events=new a,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=i,l.EventEmitter=l,e.exports=l}),"./node_modules/url-toolkit/src/url-toolkit.js":(function(e,t,n){(function(t){var n=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#[^]*)?$/,r=/^([^\/?#]*)([^]*)$/,i=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(e,t,n){if(n||={},e=e.trim(),t=t.trim(),!t){if(!n.alwaysNormalize)return e;var i=o.parseURL(e);if(!i)throw Error(`Error trying to parse base URL.`);return i.path=o.normalizePath(i.path),o.buildURLFromParts(i)}var a=o.parseURL(t);if(!a)throw Error(`Error trying to parse relative URL.`);if(a.scheme)return n.alwaysNormalize?(a.path=o.normalizePath(a.path),o.buildURLFromParts(a)):t;var s=o.parseURL(e);if(!s)throw Error(`Error trying to parse base URL.`);if(!s.netLoc&&s.path&&s.path[0]!==`/`){var c=r.exec(s.path);s.netLoc=c[1],s.path=c[2]}s.netLoc&&!s.path&&(s.path=`/`);var l={scheme:s.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(l.netLoc=s.netLoc,a.path[0]!==`/`))if(!a.path)l.path=s.path,a.params||(l.params=s.params,a.query||(l.query=s.query));else{var u=s.path,d=u.substring(0,u.lastIndexOf(`/`)+1)+a.path;l.path=o.normalizePath(d)}return l.path===null&&(l.path=n.alwaysNormalize?o.normalizePath(a.path):a.path),o.buildURLFromParts(l)},parseURL:function(e){var t=n.exec(e);return t?{scheme:t[1]||``,netLoc:t[2]||``,path:t[3]||``,params:t[4]||``,query:t[5]||``,fragment:t[6]||``}:null},normalizePath:function(e){for(e=e.split(``).reverse().join(``).replace(i,``);e.length!==(e=e.replace(a,``)).length;);return e.split(``).reverse().join(``)},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};e.exports=o})(this)}),"./node_modules/webworkify-webpack/index.js":(function(e,t,n){function r(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,`__esModule`,{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,`a`,t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=`/`,n.oe=function(e){throw console.error(e),e};var r=n(n.s=ENTRY_MODULE);return r.default||r}var i=`[\\.|\\-|\\+|\\w|/|@]+`,a=`\\(\\s*(/\\*.*?\\*/)?\\s*.*?(`+i+`).*?\\)`;function o(e){return(e+``).replace(/[.?*+^$[\]\\(){}|-]/g,`\\$&`)}function s(e){return!isNaN(1*e)}function c(e,t,r){var c={};c[r]=[];var l=t.toString(),u=l.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!u)return c;for(var d=u[1],f=RegExp(`(\\\\n|\\W)`+o(d)+a,`g`),p;p=f.exec(l);)p[3]!==`dll-reference`&&c[r].push(p[3]);for(f=RegExp(`\\(`+o(d)+`\\("(dll-reference\\s(`+i+`))"\\)\\)`+a,`g`);p=f.exec(l);)e[p[2]]||(c[r].push(p[1]),e[p[2]]=n(p[1]).m),c[p[2]]=c[p[2]]||[],c[p[2]].push(p[4]);for(var m=Object.keys(c),h=0;h<m.length;h++)for(var g=0;g<c[m[h]].length;g++)s(c[m[h]][g])&&(c[m[h]][g]=1*c[m[h]][g]);return c}function l(e){return Object.keys(e).reduce(function(t,n){return t||e[n].length>0},!1)}function u(e,t){for(var n={main:[t]},r={main:[]},i={main:{}};l(n);)for(var a=Object.keys(n),o=0;o<a.length;o++){var s=a[o],u=n[s].pop();if(i[s]=i[s]||{},!(i[s][u]||!e[s][u])){i[s][u]=!0,r[s]=r[s]||[],r[s].push(u);for(var d=c(e,e[s][u],s),f=Object.keys(d),p=0;p<f.length;p++)n[f[p]]=n[f[p]]||[],n[f[p]]=n[f[p]].concat(d[f[p]])}}return r}e.exports=function(e,t){t||={};var i={main:n.m},a=t.all?{main:Object.keys(i.main)}:u(i,e),o=``;Object.keys(a).filter(function(e){return e!==`main`}).forEach(function(e){for(var t=0;a[e][t];)t++;a[e].push(t),i[e][t]=`(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })`,o=o+`var `+e+` = (`+r.toString().replace(`ENTRY_MODULE`,JSON.stringify(t))+`)({`+a[e].map(function(t){return``+JSON.stringify(t)+`: `+i[e][t].toString()}).join(`,`)+`});
`}),o=o+`new ((`+r.toString().replace(`ENTRY_MODULE`,JSON.stringify(e))+`)({`+a.main.map(function(e){return``+JSON.stringify(e)+`: `+i.main[e].toString()}).join(`,`)+`}))(self);`;var s=new window.Blob([o],{type:`text/javascript`});if(t.bare)return s;var c=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(s),l=new window.Worker(c);return l.objectURL=c,l}}),"./src/config.ts":(function(e,t,n){n.r(t),n.d(t,`hlsDefaultConfig`,function(){return C}),n.d(t,`mergeConfig`,function(){return T}),n.d(t,`enableStreamingMode`,function(){return E});var r=n(`./src/controller/abr-controller.ts`),i=n(`./src/controller/audio-stream-controller.ts`),a=n(`./src/controller/audio-track-controller.ts`),o=n(`./src/controller/subtitle-stream-controller.ts`),s=n(`./src/controller/subtitle-track-controller.ts`),c=n(`./src/controller/buffer-controller.ts`),l=n(`./src/controller/timeline-controller.ts`),u=n(`./src/controller/cap-level-controller.ts`),d=n(`./src/controller/fps-controller.ts`),f=n(`./src/controller/eme-controller.ts`),p=n(`./src/controller/cmcd-controller.ts`),m=n(`./src/utils/xhr-loader.ts`),h=n(`./src/utils/fetch-loader.ts`),g=n(`./src/utils/cues.ts`),_=n(`./src/utils/mediakeys-helper.ts`),v=n(`./src/utils/logger.ts`);function y(){return y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},y.apply(this,arguments)}function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]==null?{}:arguments[t];t%2?b(Object(n),!0).forEach(function(t){S(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var C=x(x({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:m.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:r.default,bufferController:c.default,capLevelController:u.default,fpsController:d.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:_.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0},w()),{},{subtitleStreamController:o.SubtitleStreamController,subtitleTrackController:s.default,timelineController:l.TimelineController,audioStreamController:i.default,audioTrackController:a.default,emeController:f.default,cmcdController:p.default});function w(){return{cueHandler:g.default,enableCEA708Captions:!0,enableWebVTT:!0,enableIMSC1:!0,captionsTextTrack1Label:`English`,captionsTextTrack1LanguageCode:`en`,captionsTextTrack2Label:`Spanish`,captionsTextTrack2LanguageCode:`es`,captionsTextTrack3Label:`Unknown CC`,captionsTextTrack3LanguageCode:``,captionsTextTrack4Label:`Unknown CC`,captionsTextTrack4LanguageCode:``,renderTextTracksNatively:!0}}function T(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw Error(`Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration`);if(t.liveMaxLatencyDurationCount!==void 0&&(t.liveSyncDurationCount===void 0||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw Error(`Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"`);if(t.liveMaxLatencyDuration!==void 0&&(t.liveSyncDuration===void 0||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw Error(`Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"`);return y({},e,t)}function E(e){var t=e.loader;t!==h.default&&t!==m.default?(v.logger.log(`[config]: Custom loader detected, cannot enable progressive streaming`),e.progressive=!1):(0,h.fetchSupported)()&&(e.loader=h.default,e.progressive=!0,e.enableSoftwareAES=!0,v.logger.log(`[config]: Progressive streaming enabled, using FetchLoader`))}}),"./src/controller/abr-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/polyfills/number.ts`),i=n(`./src/utils/ewma-bandwidth-estimator.ts`),a=n(`./src/events.ts`),o=n(`./src/utils/buffer-helper.ts`),s=n(`./src/errors.ts`),c=n(`./src/types/loader.ts`),l=n(`./src/utils/logger.ts`);function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}t.default=function(){function e(e){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=e;var t=e.config;this.bwEstimator=new i.default(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate),this.registerListeners()}var t=e.prototype;return t.registerListeners=function(){var e=this.hls;e.on(a.Events.FRAG_LOADING,this.onFragLoading,this),e.on(a.Events.FRAG_LOADED,this.onFragLoaded,this),e.on(a.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(a.Events.ERROR,this.onError,this)},t.unregisterListeners=function(){var e=this.hls;e.off(a.Events.FRAG_LOADING,this.onFragLoading,this),e.off(a.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(a.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(a.Events.ERROR,this.onError,this)},t.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},t.onFragLoading=function(e,t){var n=t.frag;n.type===c.PlaylistLevelType.MAIN&&!this.timer&&(this.fragCurrent=n,this.partCurrent=t.part??null,this.timer=self.setInterval(this.onCheck,100))},t.onLevelLoaded=function(e,t){var n=this.hls.config;t.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD)},t._abandonRulesCheck=function(){var e=this.fragCurrent,t=this.partCurrent,n=this.hls,i=n.autoLevelEnabled,s=n.config,c=n.media;if(!(!e||!c)){var u=t?t.stats:e.stats,d=t?t.duration:e.duration;if(u.aborted){l.logger.warn(`frag loader destroy or aborted, disarm abandonRules`),this.clearTimer(),this._nextAutoLevel=-1;return}if(!(!i||c.paused||!c.playbackRate||!c.readyState)){var f=performance.now()-u.loading.start,p=Math.abs(c.playbackRate);if(!(f<=500*d/p)){var m=n.levels,h=n.minAutoLevel,g=m[e.level],_=u.total||Math.max(u.loaded,Math.round(d*g.maxBitrate/8)),v=Math.max(1,u.bwEstimate?u.bwEstimate/8:u.loaded*1e3/f),y=(_-u.loaded)/v,b=c.currentTime,x=(o.BufferHelper.bufferInfo(c,b,s.maxBufferHole).end-b)/p;if(!(x>=2*d/p||y<=x)){var S=1/0,C;for(C=e.level-1;C>h&&(S=d*m[C].maxBitrate/(8*.8*v),!(S<x));C--);if(!(S>=y)){var w=this.bwEstimator.getEstimate();l.logger.warn(`Fragment `+e.sn+(t?` part `+t.index:``)+` of level `+e.level+` is loading too slowly and will cause an underbuffer; aborting and switching to level `+C+`
      Current BW estimate: `+((0,r.isFiniteNumber)(w)?(w/1024).toFixed(3):`Unknown`)+` Kb/s
      Estimated load time for current fragment: `+y.toFixed(3)+` s
      Estimated load time for the next fragment: `+S.toFixed(3)+` s
      Time to underbuffer: `+x.toFixed(3)+` s`),n.nextLoadLevel=C,this.bwEstimator.sample(f,u.loaded),this.clearTimer(),e.loader&&(this.fragCurrent=this.partCurrent=null,e.loader.abort()),n.trigger(a.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:u})}}}}}},t.onFragLoaded=function(e,t){var n=t.frag,i=t.part;if(n.type===c.PlaylistLevelType.MAIN&&(0,r.isFiniteNumber)(n.sn)){var o=i?i.stats:n.stats,s=i?i.duration:n.duration;if(this.clearTimer(),this.lastLoadedFragLevel=n.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var l=this.hls.levels[n.level],u=(l.loaded?l.loaded.bytes:0)+o.loaded,d=(l.loaded?l.loaded.duration:0)+s;l.loaded={bytes:u,duration:d},l.realBitrate=Math.round(8*u/d)}if(n.bitrateTest){var f={stats:o,frag:n,part:i,id:n.type};this.onFragBuffered(a.Events.FRAG_BUFFERED,f),n.bitrateTest=!1}}},t.onFragBuffered=function(e,t){var n=t.frag,r=t.part,i=r?r.stats:n.stats;if(!i.aborted&&!(n.type!==c.PlaylistLevelType.MAIN||n.sn===`initSegment`)){var a=i.parsing.end-i.loading.start;this.bwEstimator.sample(a,i.loaded),i.bwEstimate=this.bwEstimator.getEstimate(),n.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}},t.onError=function(e,t){switch(t.details){case s.ErrorDetails.FRAG_LOAD_ERROR:case s.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer();break;default:break}},t.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},t.getNextABRAutoLevel=function(){var e=this.fragCurrent,t=this.partCurrent,n=this.hls,r=n.maxAutoLevel,i=n.config,a=n.minAutoLevel,s=n.media,c=t?t.duration:e?e.duration:0,u=s?s.currentTime:0,d=s&&s.playbackRate!==0?Math.abs(s.playbackRate):1,f=this.bwEstimator?this.bwEstimator.getEstimate():i.abrEwmaDefaultEstimate,p=(o.BufferHelper.bufferInfo(s,u,i.maxBufferHole).end-u)/d,m=this.findBestLevel(f,a,r,p,i.abrBandWidthFactor,i.abrBandWidthUpFactor);if(m>=0)return m;l.logger.trace((p?`rebuffering expected`:`buffer is empty`)+`, finding optimal quality level`);var h=c?Math.min(c,i.maxStarvationDelay):i.maxStarvationDelay,g=i.abrBandWidthFactor,_=i.abrBandWidthUpFactor;if(!p){var v=this.bitrateTestDelay;v&&(h=(c?Math.min(c,i.maxLoadingDelay):i.maxLoadingDelay)-v,l.logger.trace(`bitrate test took `+Math.round(1e3*v)+`ms, set first fragment max fetchDuration to `+Math.round(1e3*h)+` ms`),g=_=1)}return m=this.findBestLevel(f,a,r,p+h,g,_),Math.max(m,0)},t.findBestLevel=function(e,t,n,r,i,a){for(var o,s=this.fragCurrent,c=this.partCurrent,u=this.lastLoadedFragLevel,d=this.hls.levels,f=d[u],p=!!(f!=null&&(o=f.details)!=null&&o.live),m=f?.codecSet,h=c?c.duration:s?s.duration:0,g=n;g>=t;g--){var _=d[g];if(!(!_||m&&_.codecSet!==m)){var v=_.details,y=(c?v?.partTarget:v?.averagetargetduration)||h,b=void 0;b=g<=u?i*e:a*e;var x=d[g].maxBitrate,S=x*y/b;if(l.logger.trace(`level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: `+g+`/`+Math.round(b)+`/`+x+`/`+y+`/`+r+`/`+S),b>x&&(!S||p&&!this.bitrateTestDelay||S<r))return g}}return-1},d(e,[{key:`nextAutoLevel`,get:function(){var e=this._nextAutoLevel,t=this.bwEstimator;if(e!==-1&&(!t||!t.canEstimate()))return e;var n=this.getNextABRAutoLevel();return e!==-1&&(n=Math.min(e,n)),n},set:function(e){this._nextAutoLevel=e}}]),e}()}),"./src/controller/audio-stream-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/polyfills/number.ts`),i=n(`./src/controller/base-stream-controller.ts`),a=n(`./src/events.ts`),o=n(`./src/utils/buffer-helper.ts`),s=n(`./src/controller/fragment-tracker.ts`),c=n(`./src/types/level.ts`),l=n(`./src/types/loader.ts`),u=n(`./src/loader/fragment.ts`),d=n(`./src/demux/chunk-cache.ts`),f=n(`./src/demux/transmuxer-interface.ts`),p=n(`./src/types/transmuxer.ts`),m=n(`./src/controller/fragment-finders.ts`),h=n(`./src/utils/discontinuities.ts`),g=n(`./src/errors.ts`),_=n(`./src/utils/logger.ts`);function v(){return v=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},v.apply(this,arguments)}function y(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,b(e,t)}function b(e,t){return b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},b(e,t)}var x=100;t.default=function(e){y(t,e);function t(t,n){var r=e.call(this,t,n,`[audio-stream-controller]`)||this;return r.videoBuffer=null,r.videoTrackCC=-1,r.waitingVideoCC=-1,r.audioSwitch=!1,r.trackId=-1,r.waitingData=null,r.mainDetails=null,r.bufferFlushed=!1,r._registerListeners(),r}var n=t.prototype;return n.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},n._registerListeners=function(){var e=this.hls;e.on(a.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(a.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(a.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(a.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(a.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(a.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(a.Events.ERROR,this.onError,this),e.on(a.Events.BUFFER_RESET,this.onBufferReset,this),e.on(a.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(a.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(a.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(a.Events.FRAG_BUFFERED,this.onFragBuffered,this)},n._unregisterListeners=function(){var e=this.hls;e.off(a.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(a.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(a.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(a.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(a.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(a.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(a.Events.ERROR,this.onError,this),e.off(a.Events.BUFFER_RESET,this.onBufferReset,this),e.off(a.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(a.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(a.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(a.Events.FRAG_BUFFERED,this.onFragBuffered,this)},n.onInitPtsFound=function(e,t){var n=t.frag,r=t.id,a=t.initPTS;if(r===`main`){var o=n.cc;this.initPTS[n.cc]=a,this.log(`InitPTS for cc: `+o+` found from main: `+a),this.videoTrackCC=o,this.state===i.State.WAITING_INIT_PTS&&this.tick()}},n.startLoad=function(e){if(!this.levels){this.startPosition=e,this.state=i.State.STOPPED;return}var t=this.lastCurrentTime;this.stopLoad(),this.setInterval(x),this.fragLoadError=0,t>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @`+t.toFixed(3)),this.state=i.State.IDLE):(this.loadedmetadata=!1,this.state=i.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},n.doTick=function(){switch(this.state){case i.State.IDLE:this.doTickIdle();break;case i.State.WAITING_TRACK:var t=this.levels,n=this.trackId,r=t?.[n]?.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=i.State.WAITING_INIT_PTS}break;case i.State.FRAG_LOADING_WAITING_RETRY:var a,s=performance.now(),c=this.retryDate;(!c||s>=c||(a=this.media)!=null&&a.seeking)&&(this.log(`RetryDate reached, switch back to IDLE state`),this.state=i.State.IDLE);break;case i.State.WAITING_INIT_PTS:var l=this.waitingData;if(l){var u=l.frag,d=l.part,f=l.cache,p=l.complete;if(this.initPTS[u.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=i.State.FRAG_LOADING;var h={frag:u,part:d,payload:f.flush(),networkDetails:null};this._handleFragmentLoadProgress(h),p&&e.prototype._handleFragmentLoadComplete.call(this,h)}else if(this.videoTrackCC!==this.waitingVideoCC)_.logger.log(`Waiting fragment cc (`+u.cc+`) cancelled because video is at cc `+this.videoTrackCC),this.clearWaitingFragment();else{var g=this.getLoadPosition(),v=o.BufferHelper.bufferInfo(this.mediaBuffer,g,this.config.maxBufferHole);(0,m.fragmentWithinToleranceTest)(v.end,this.config.maxFragLookUpTolerance,u)<0&&(_.logger.log(`Waiting fragment cc (`+u.cc+`) @ `+u.start+` cancelled because another fragment at `+v.end+` is needed`),this.clearWaitingFragment())}}else this.state=i.State.IDLE}this.onTickEnd()},n.clearWaitingFragment=function(){var e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=i.State.IDLE)},n.onTickEnd=function(){var e=this.media;if(!(!e||!e.readyState)){var t=(this.mediaBuffer?this.mediaBuffer:e).buffered;!this.loadedmetadata&&t.length&&(this.loadedmetadata=!0),this.lastCurrentTime=e.currentTime}},n.doTickIdle=function(){var e,t=this.hls,n=this.levels,r=this.media,o=this.trackId,s=t.config;if(!(!n||!n[o])&&!(!r&&(this.startFragRequested||!s.startFragPrefetch))){var c=n[o].details;if(!c||c.live&&this.levelLastLoaded!==o||this.waitForCdnTuneIn(c)){this.state=i.State.WAITING_TRACK;return}this.bufferFlushed&&(this.bufferFlushed=!1,this.afterBufferFlushed(this.mediaBuffer?this.mediaBuffer:this.media,u.ElementaryStreamTypes.AUDIO,l.PlaylistLevelType.AUDIO));var d=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,l.PlaylistLevelType.AUDIO);if(d!==null){var f=d.len,p=this.getMaxBufferLength(),m=this.audioSwitch;if(!(f>=p&&!m)){if(!m&&this._streamEnded(d,c)){t.trigger(a.Events.BUFFER_EOS,{type:`audio`}),this.state=i.State.ENDED;return}var h=c.fragments[0].start,g=d.end;if(m){var _=this.getLoadPosition();g=_,c.PTSKnown&&_<h&&(d.end>h||d.nextStart)&&(this.log(`Alt audio track ahead of main track, seek to start of alt audio track`),r.currentTime=h+.05)}var v=this.getNextFragment(g,c);if(!v){this.bufferFlushed=!0;return}v.decryptdata?.keyFormat===`identity`&&!((e=v.decryptdata)!=null&&e.key)?this.loadKey(v,c):this.loadFragment(v,c,g)}}}},n.getMaxBufferLength=function(){var t=e.prototype.getMaxBufferLength.call(this),n=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,l.PlaylistLevelType.MAIN);return n===null?t:Math.max(t,n.len)},n.onMediaDetaching=function(){this.videoBuffer=null,e.prototype.onMediaDetaching.call(this)},n.onAudioTracksUpdated=function(e,t){var n=t.audioTracks;this.resetTransmuxer(),this.levels=n.map(function(e){return new c.Level(e)})},n.onAudioTrackSwitching=function(e,t){var n=!!t.url;this.trackId=t.id;var r=this.fragCurrent;r!=null&&r.loader&&r.loader.abort(),this.fragCurrent=null,this.clearWaitingFragment(),n?this.setInterval(x):this.resetTransmuxer(),n?(this.audioSwitch=!0,this.state=i.State.IDLE):this.state=i.State.STOPPED,this.tick()},n.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},n.onLevelLoaded=function(e,t){this.mainDetails=t.details},n.onAudioTrackLoaded=function(e,t){var n,r=this.levels,a=t.details,o=t.id;if(!r){this.warn(`Audio tracks were reset while loading level `+o);return}this.log(`Track `+o+` loaded [`+a.startSN+`,`+a.endSN+`],duration:`+a.totalduration);var s=r[o],c=0;if(a.live||(n=s.details)!=null&&n.live){var l=this.mainDetails;if(a.fragments[0]||(a.deltaUpdateFailed=!0),a.deltaUpdateFailed||!l)return;!s.details&&a.hasProgramDateTime&&l.hasProgramDateTime?((0,h.alignMediaPlaylistByPDT)(a,l),c=a.fragments[0].start):c=this.alignPlaylists(a,s.details)}s.details=a,this.levelLastLoaded=o,!this.startFragRequested&&(this.mainDetails||!a.live)&&this.setStartPosition(s.details,c),this.state===i.State.WAITING_TRACK&&!this.waitForCdnTuneIn(a)&&(this.state=i.State.IDLE),this.tick()},n._handleFragmentLoadProgress=function(e){var t=e.frag,n=e.part,r=e.payload,a=this.config,o=this.trackId,s=this.levels;if(!s){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment `+t.sn+` of level `+t.level+` will not be buffered`);return}var c=s[o];console.assert(c,`Audio track is defined on fragment load progress`);var u=c.details;console.assert(u,`Audio track details are defined on fragment load progress`);var m=a.defaultAudioCodec||c.audioCodec||`mp4a.40.2`,h=this.transmuxer;h||=this.transmuxer=new f.default(this.hls,l.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this));var g=this.initPTS[t.cc],v=t.initSegment?.data;if(g!==void 0){var y=!1,b=n?n.index:-1,x=b!==-1,S=new p.ChunkMetadata(t.level,t.sn,t.stats.chunkCount,r.byteLength,b,x);h.push(r,v,m,``,t,n,u.totalduration,y,S,g)}else _.logger.log(`Unknown video PTS for cc `+t.cc+`, waiting for video PTS before demuxing audio frag `+t.sn+` of [`+u.startSN+` ,`+u.endSN+`],track `+o),(this.waitingData=this.waitingData||{frag:t,part:n,cache:new d.default,complete:!1}).cache.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state=i.State.WAITING_INIT_PTS},n._handleFragmentLoadComplete=function(t){if(this.waitingData){this.waitingData.complete=!0;return}e.prototype._handleFragmentLoadComplete.call(this,t)},n.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},n.onBufferCreated=function(e,t){var n=t.tracks.audio;n&&(this.mediaBuffer=n.buffer),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer)},n.onFragBuffered=function(e,t){var n=t.frag,r=t.part;if(n.type===l.PlaylistLevelType.AUDIO){if(this.fragContextChanged(n)){this.warn(`Fragment `+n.sn+(r?` p: `+r.index:``)+` of level `+n.level+` finished buffering, but was aborted. state: `+this.state+`, audioSwitch: `+this.audioSwitch);return}n.sn!==`initSegment`&&(this.fragPrevious=n,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(a.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(n,r)}},n.onError=function(t,n){switch(n.details){case g.ErrorDetails.FRAG_LOAD_ERROR:case g.ErrorDetails.FRAG_LOAD_TIMEOUT:case g.ErrorDetails.KEY_LOAD_ERROR:case g.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(l.PlaylistLevelType.AUDIO,n);break;case g.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case g.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==i.State.ERROR&&this.state!==i.State.STOPPED&&(this.state=n.fatal?i.State.ERROR:i.State.IDLE,this.warn(n.details+` while loading frag, switching to `+this.state+` state`));break;case g.ErrorDetails.BUFFER_FULL_ERROR:if(n.parent===`audio`&&(this.state===i.State.PARSING||this.state===i.State.PARSED)){var r=!0,a=this.getFwdBufferInfo(this.mediaBuffer,l.PlaylistLevelType.AUDIO);a&&a.len>.5&&(r=!this.reduceMaxBufferLength(a.len)),r&&(this.warn(`Buffer full error also media.currentTime is not buffered, flush audio buffer`),this.fragCurrent=null,e.prototype.flushMainBuffer.call(this,0,1/0,`audio`)),this.resetLoadingState()}break;default:break}},n.onBufferFlushed=function(e,t){t.type===u.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0)},n._handleTransmuxComplete=function(e){var t,n=`audio`,r=this.hls,o=e.remuxResult,s=e.chunkMeta,c=this.getCurrentContext(s);if(!c){this.warn(`The loading context changed while buffering fragment `+s.sn+` of level `+s.level+`. This chunk will not be buffered.`),this.resetLiveStartWhenNotLoaded(s.level);return}var l=c.frag,d=c.part,f=o.audio,p=o.text,m=o.id3,h=o.initSegment;if(!this.fragContextChanged(l)){if(this.state=i.State.PARSING,this.audioSwitch&&f&&this.completeAudioSwitch(),h!=null&&h.tracks&&(this._bufferInitSegment(h.tracks,l,s),r.trigger(a.Events.FRAG_PARSING_INIT_SEGMENT,{frag:l,id:n,tracks:h.tracks})),f){var g=f.startPTS,_=f.endPTS,y=f.startDTS,b=f.endDTS;d&&(d.elementaryStreams[u.ElementaryStreamTypes.AUDIO]={startPTS:g,endPTS:_,startDTS:y,endDTS:b}),l.setElementaryStreamInfo(u.ElementaryStreamTypes.AUDIO,g,_,y,b),this.bufferFragmentData(f,l,d,s)}if(m!=null&&(t=m.samples)!=null&&t.length){var x=v({frag:l,id:n},m);r.trigger(a.Events.FRAG_PARSING_METADATA,x)}if(p){var S=v({frag:l,id:n},p);r.trigger(a.Events.FRAG_PARSING_USERDATA,S)}}},n._bufferInitSegment=function(e,t,n){if(this.state===i.State.PARSING){e.video&&delete e.video;var r=e.audio;if(r){r.levelCodec=r.codec,r.id=`audio`,this.log(`Init audio buffer, container:`+r.container+`, codecs[parsed]=[`+r.codec+`]`),this.hls.trigger(a.Events.BUFFER_CODECS,e);var o=r.initSegment;if(o!=null&&o.byteLength){var s={type:`audio`,frag:t,part:null,chunkMeta:n,parent:t.type,data:o};this.hls.trigger(a.Events.BUFFER_APPENDING,s)}this.tick()}}},n.loadFragment=function(t,n,a){var o=this.fragmentTracker.getState(t);this.fragCurrent=t,(this.audioSwitch||o===s.FragmentState.NOT_LOADED||o===s.FragmentState.PARTIAL)&&(t.sn===`initSegment`?this._loadInitSegment(t):n.live&&!(0,r.isFiniteNumber)(this.initPTS[t.cc])?(this.log(`Waiting for video PTS in continuity counter `+t.cc+` of live stream before loading audio fragment `+t.sn+` of level `+this.trackId),this.state=i.State.WAITING_INIT_PTS):(this.startFragRequested=!0,e.prototype.loadFragment.call(this,t,n,a)))},n.completeAudioSwitch=function(){var t=this.hls,n=this.media,r=this.trackId;n&&(this.log(`Switching audio track : flushing all audio`),e.prototype.flushMainBuffer.call(this,0,1/0,`audio`)),this.audioSwitch=!1,t.trigger(a.Events.AUDIO_TRACK_SWITCHED,{id:r})},t}(i.default)}),"./src/controller/audio-track-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/events.ts`),i=n(`./src/errors.ts`),a=n(`./src/controller/base-playlist-controller.ts`),o=n(`./src/types/loader.ts`);function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,u(e,t)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}t.default=function(e){l(t,e);function t(t){var n=e.call(this,t,`[audio-track-controller]`)||this;return n.tracks=[],n.groupId=null,n.tracksInGroup=[],n.trackId=-1,n.trackName=``,n.selectDefaultTrack=!0,n.registerListeners(),n}var n=t.prototype;return n.registerListeners=function(){var e=this.hls;e.on(r.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(r.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(r.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(r.Events.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e.off(r.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(r.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(r.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(r.Events.ERROR,this.onError,this)},n.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,e.prototype.destroy.call(this)},n.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName=``,this.selectDefaultTrack=!0},n.onManifestParsed=function(e,t){this.tracks=t.audioTracks||[]},n.onAudioTrackLoaded=function(e,t){var n=t.id,r=t.details,i=this.tracksInGroup[n];if(!i){this.warn(`Invalid audio track id `+n);return}var a=i.details;i.details=t.details,this.log(`audioTrack `+n+` loaded [`+r.startSN+`-`+r.endSN+`]`),n===this.trackId&&(this.retryCount=0,this.playlistLoaded(n,t,a))},n.onLevelLoading=function(e,t){this.switchLevel(t.level)},n.onLevelSwitching=function(e,t){this.switchLevel(t.level)},n.switchLevel=function(e){var t=this.hls.levels[e];if(t!=null&&t.audioGroupIds){var n=t.audioGroupIds[t.urlId];if(this.groupId!==n){this.groupId=n;var i=this.tracks.filter(function(e){return!n||e.groupId===n});this.selectDefaultTrack&&!i.some(function(e){return e.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=i;var a={audioTracks:i};this.log(`Updating audio tracks, `+i.length+` track(s) found in "`+n+`" group-id`),this.hls.trigger(r.Events.AUDIO_TRACKS_UPDATED,a),this.selectInitialTrack()}}},n.onError=function(t,n){e.prototype.onError.call(this,t,n),!(n.fatal||!n.context)&&n.context.type===o.PlaylistContextType.AUDIO_TRACK&&n.context.id===this.trackId&&n.context.groupId===this.groupId&&this.retryLoadingOrFail(n)},n.setAudioTrack=function(e){var t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid id passed to audio-track controller`);return}this.clearTimer();var n=t[this.trackId];this.log(`Now switching to audio-track index `+e);var i=t[e],a=i.id,o=i.groupId,s=o===void 0?``:o,c=i.name,l=i.type,u=i.url;if(this.trackId=e,this.trackName=c,this.selectDefaultTrack=!1,this.hls.trigger(r.Events.AUDIO_TRACK_SWITCHING,{id:a,groupId:s,name:c,type:l,url:u}),!(i.details&&!i.details.live)){var d=this.switchParams(i.url,n?.details);this.loadPlaylist(d)}},n.selectInitialTrack=function(){var e=this.tracksInGroup;console.assert(e.length,`Initial audio track should be selected when tracks are known`);var t=this.trackName,n=this.findTrackId(t)||this.findTrackId();n===-1?(this.warn(`No track found for running audio group-ID: `+this.groupId),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0})):this.setAudioTrack(n)},n.findTrackId=function(e){for(var t=this.tracksInGroup,n=0;n<t.length;n++){var r=t[n];if((!this.selectDefaultTrack||r.default)&&(!e||e===r.name))return r.id}return-1},n.loadPlaylist=function(e){var t=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(t)){var n=t.id,i=t.groupId,a=t.url;if(e)try{a=e.addDirectives(a)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: `+e)}this.log(`loading audio-track playlist for id: `+n),this.clearTimer(),this.hls.trigger(r.Events.AUDIO_TRACK_LOADING,{url:a,id:n,groupId:i,deliveryDirectives:e||null})}},c(t,[{key:`audioTracks`,get:function(){return this.tracksInGroup}},{key:`audioTrack`,get:function(){return this.trackId},set:function(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}}]),t}(a.default)}),"./src/controller/base-playlist-controller.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return c});var r=n(`./src/polyfills/number.ts`),i=n(`./src/types/level.ts`),a=n(`./src/controller/level-helper.ts`),o=n(`./src/utils/logger.ts`),s=n(`./src/errors.ts`),c=function(){function e(e,t){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=o.logger.log.bind(o.logger,t+`:`),this.warn=o.logger.warn.bind(o.logger,t+`:`),this.hls=e}var t=e.prototype;return t.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},t.onError=function(e,t){t.fatal&&t.type===s.ErrorTypes.NETWORK_ERROR&&this.clearTimer()},t.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},t.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()},t.stopLoad=function(){this.canLoad=!1,this.clearTimer()},t.switchParams=function(e,t){var n=t?.renditionReports;if(n)for(var a=0;a<n.length;a++){var o=n[a],s=``+o.URI;if(s===e.substr(-s.length)){var c=parseInt(o[`LAST-MSN`]),l=parseInt(o[`LAST-PART`]);if(t&&this.hls.config.lowLatencyMode){var u=Math.min(t.age-t.partTarget,t.targetduration);l!==void 0&&u>t.partTarget&&(l+=1)}if((0,r.isFiniteNumber)(c))return new i.HlsUrlParameters(c,(0,r.isFiniteNumber)(l)?l:void 0,i.HlsSkip.No)}}},t.loadPlaylist=function(e){},t.shouldLoadTrack=function(e){return this.canLoad&&e&&!!e.url&&(!e.details||e.details.live)},t.playlistLoaded=function(e,t,n){var r=this,i=t.details,o=t.stats,s=o.loading.end?Math.max(0,self.performance.now()-o.loading.end):0;if(i.advancedDateTime=Date.now()-s,i.live||n!=null&&n.live){if(i.reloaded(n),n&&this.log(`live playlist `+e+` `+(i.advanced?`REFRESHED `+i.lastPartSn+`-`+i.lastPartIndex:`MISSED`)),n&&i.fragments.length>0&&(0,a.mergeDetails)(n,i),!this.canLoad||!i.live)return;var c,l=void 0,u=void 0;if(i.canBlockReload&&i.endSN&&i.advanced){var d=this.hls.config.lowLatencyMode,f=i.lastPartSn,p=i.endSN,m=i.lastPartIndex,h=m!==-1,g=f===p,_=d?0:m;h?(l=g?p+1:f,u=g?_:m+1):l=p+1;var v=i.age,y=v+i.ageHeader,b=Math.min(y-i.partTarget,i.targetduration*1.5);if(b>0){if(n&&b>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: `+n.tuneInGoal+` to: `+b+` with playlist age: `+i.age),b=0;else{var x=Math.floor(b/i.targetduration);if(l+=x,u!==void 0){var S=Math.round(b%i.targetduration/i.partTarget);u+=S}this.log(`CDN Tune-in age: `+i.ageHeader+`s last advanced `+v.toFixed(2)+`s goal: `+b+` skip sn `+x+` to part `+u)}i.tuneInGoal=b}if(c=this.getDeliveryDirectives(i,t.deliveryDirectives,l,u),d||!g){this.loadPlaylist(c);return}}else c=this.getDeliveryDirectives(i,t.deliveryDirectives,l,u);var C=(0,a.computeReloadInterval)(i,o);l!==void 0&&i.canBlockReload&&(C-=i.partTarget||1),this.log(`reload live playlist `+e+` in `+Math.round(C)+` ms`),this.timer=self.setTimeout(function(){return r.loadPlaylist(c)},C)}else this.clearTimer()},t.getDeliveryDirectives=function(e,t,n,r){var a=(0,i.getSkipValue)(e,n);return t!=null&&t.skip&&e.deltaUpdateFailed&&(n=t.msn,r=t.part,a=i.HlsSkip.No),new i.HlsUrlParameters(n,r,a)},t.retryLoadingOrFail=function(e){var t=this,n=this.hls.config,r=this.retryCount<n.levelLoadingMaxRetry;if(r){var i;if(this.retryCount++,e.details.indexOf(`LoadTimeOut`)>-1&&(i=e.context)!=null&&i.deliveryDirectives)this.warn(`retry playlist loading #`+this.retryCount+` after "`+e.details+`"`),this.loadPlaylist();else{var a=Math.min(2**this.retryCount*n.levelLoadingRetryDelay,n.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return t.loadPlaylist()},a),this.warn(`retry playlist loading #`+this.retryCount+` in `+a+` ms after "`+e.details+`"`)}}else this.warn(`cannot recover from error "`+e.details+`"`),this.clearTimer(),e.fatal=!0;return r},e}()}),"./src/controller/base-stream-controller.ts":(function(e,t,n){n.r(t),n.d(t,`State`,function(){return w}),n.d(t,`default`,function(){return T});var r=n(`./src/polyfills/number.ts`),i=n(`./src/task-loop.ts`),a=n(`./src/controller/fragment-tracker.ts`),o=n(`./src/utils/buffer-helper.ts`),s=n(`./src/utils/logger.ts`),c=n(`./src/events.ts`),l=n(`./src/errors.ts`),u=n(`./src/types/transmuxer.ts`),d=n(`./src/utils/mp4-tools.ts`),f=n(`./src/utils/discontinuities.ts`),p=n(`./src/controller/fragment-finders.ts`),m=n(`./src/controller/level-helper.ts`),h=n(`./src/loader/fragment-loader.ts`),g=n(`./src/crypt/decrypter.ts`),_=n(`./src/utils/time-ranges.ts`),v=n(`./src/types/loader.ts`);function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t,n){return t&&y(e.prototype,t),n&&y(e,n),e}function x(e){if(e===void 0)throw ReferenceError(`this hasn't been initialised - super() hasn't been called`);return e}function S(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,C(e,t)}function C(e,t){return C=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},C(e,t)}var w={STOPPED:`STOPPED`,IDLE:`IDLE`,KEY_LOADING:`KEY_LOADING`,FRAG_LOADING:`FRAG_LOADING`,FRAG_LOADING_WAITING_RETRY:`FRAG_LOADING_WAITING_RETRY`,WAITING_TRACK:`WAITING_TRACK`,PARSING:`PARSING`,PARSED:`PARSED`,BACKTRACKING:`BACKTRACKING`,ENDED:`ENDED`,ERROR:`ERROR`,WAITING_INIT_PTS:`WAITING_INIT_PTS`,WAITING_LEVEL:`WAITING_LEVEL`},T=function(e){S(t,e);function t(t,n,r){var i=e.call(this)||this;return i.hls=void 0,i.fragPrevious=null,i.fragCurrent=null,i.fragmentTracker=void 0,i.transmuxer=null,i._state=w.STOPPED,i.media=void 0,i.mediaBuffer=void 0,i.config=void 0,i.bitrateTest=!1,i.lastCurrentTime=0,i.nextLoadPosition=0,i.startPosition=0,i.loadedmetadata=!1,i.fragLoadError=0,i.retryDate=0,i.levels=null,i.fragmentLoader=void 0,i.levelLastLoaded=null,i.startFragRequested=!1,i.decrypter=void 0,i.initPTS=[],i.onvseeking=null,i.onvended=null,i.logPrefix=``,i.log=void 0,i.warn=void 0,i.logPrefix=r,i.log=s.logger.log.bind(s.logger,r+`:`),i.warn=s.logger.warn.bind(s.logger,r+`:`),i.hls=t,i.fragmentLoader=new h.default(t.config),i.fragmentTracker=n,i.config=t.config,i.decrypter=new g.default(t,t.config),t.on(c.Events.KEY_LOADED,i.onKeyLoaded,x(i)),i}var n=t.prototype;return n.doTick=function(){this.onTickEnd()},n.onTickEnd=function(){},n.startLoad=function(e){},n.stopLoad=function(){this.fragmentLoader.abort();var e=this.fragCurrent;e&&this.fragmentTracker.removeFragment(e),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=w.STOPPED},n._streamEnded=function(e,t){var n=this.fragCurrent,r=this.fragmentTracker;if(!t.live&&n&&n.sn===t.endSN&&!e.nextStart){var i=r.getState(n);return i===a.FragmentState.PARTIAL||i===a.FragmentState.OK}return!1},n.onMediaAttached=function(e,t){var n=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),n.addEventListener(`seeking`,this.onvseeking),n.addEventListener(`ended`,this.onvended);var r=this.config;this.levels&&r.autoStartLoad&&this.state===w.STOPPED&&this.startLoad(r.startPosition)},n.onMediaDetaching=function(){var e=this.media;e!=null&&e.ended&&(this.log(`MSE detaching and video ended, reset startPosition`),this.startPosition=this.lastCurrentTime=0),e&&(e.removeEventListener(`seeking`,this.onvseeking),e.removeEventListener(`ended`,this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},n.onMediaSeeking=function(){var e=this.config,t=this.fragCurrent,n=this.media,i=this.mediaBuffer,a=this.state,s=n?n.currentTime:0,c=o.BufferHelper.bufferInfo(i||n,s,e.maxBufferHole);if(this.log(`media seeking to `+((0,r.isFiniteNumber)(s)?s.toFixed(3):s)+`, state: `+a),a===w.ENDED)this.resetLoadingState();else if(t&&!c.len){var l=e.maxFragLookUpTolerance,u=t.start-l,d=s>t.start+t.duration+l;(s<u||d)&&(d&&t.loader&&(this.log(`seeking outside of buffer while fragment load in progress, cancel fragment load`),t.loader.abort()),this.resetLoadingState())}n&&(this.lastCurrentTime=s),!this.loadedmetadata&&!c.len&&(this.nextLoadPosition=this.startPosition=s),this.tickImmediate()},n.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},n.onKeyLoaded=function(e,t){if(!(this.state!==w.KEY_LOADING||t.frag!==this.fragCurrent||!this.levels)){this.state=w.IDLE;var n=this.levels[t.frag.level].details;n&&this.loadFragment(t.frag,n,t.frag.start)}},n.onHandlerDestroying=function(){this.stopLoad(),e.prototype.onHandlerDestroying.call(this)},n.onHandlerDestroyed=function(){this.state=w.STOPPED,this.hls.off(c.Events.KEY_LOADED,this.onKeyLoaded,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,e.prototype.onHandlerDestroyed.call(this)},n.loadKey=function(e,t){this.log(`Loading key for `+e.sn+` of [`+t.startSN+`-`+t.endSN+`], `+(this.logPrefix===`[stream-controller]`?`level`:`track`)+` `+e.level),this.state=w.KEY_LOADING,this.fragCurrent=e,this.hls.trigger(c.Events.KEY_LOADING,{frag:e})},n.loadFragment=function(e,t,n){this._loadFragForPlayback(e,t,n)},n._loadFragForPlayback=function(e,t,n){var r=this;this._doFragLoad(e,t,n,function(t){if(r.fragContextChanged(e)){r.warn(`Fragment `+e.sn+(t.part?` p: `+t.part.index:``)+` of level `+e.level+` was dropped during download.`),r.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,r._handleFragmentLoadProgress(t)}).then(function(t){if(t){r.fragLoadError=0;var n=r.state;if(r.fragContextChanged(e)){(n===w.FRAG_LOADING||n===w.BACKTRACKING||!r.fragCurrent&&n===w.PARSING)&&(r.fragmentTracker.removeFragment(e),r.state=w.IDLE);return}if(`payload`in t&&(r.log(`Loaded fragment `+e.sn+` of level `+e.level),r.hls.trigger(c.Events.FRAG_LOADED,t),r.state===w.BACKTRACKING)){r.fragmentTracker.backtrack(e,t),r.resetFragmentLoading(e);return}r._handleFragmentLoadComplete(t)}}).catch(function(t){r.warn(t),r.resetFragmentLoading(e)})},n.flushMainBuffer=function(e,t,n){if(n===void 0&&(n=null),e-t){var r={startOffset:e,endOffset:t,type:n};this.fragLoadError=0,this.hls.trigger(c.Events.BUFFER_FLUSHING,r)}},n._loadInitSegment=function(e){var t=this;this._doFragLoad(e).then(function(n){if(!n||t.fragContextChanged(e)||!t.levels)throw Error(`init load aborted`);return n}).then(function(n){var r=t.hls,i=n.payload,a=e.decryptdata;if(i&&i.byteLength>0&&a&&a.key&&a.iv&&a.method===`AES-128`){var o=self.performance.now();return t.decrypter.webCryptoDecrypt(new Uint8Array(i),a.key.buffer,a.iv.buffer).then(function(t){var i=self.performance.now();return r.trigger(c.Events.FRAG_DECRYPTED,{frag:e,payload:t,stats:{tstart:o,tdecrypt:i}}),n.payload=t,n})}return n}).then(function(n){var r=t.fragCurrent,i=t.hls,a=t.levels;if(!a)throw Error(`init load aborted, missing levels`);var o=a[e.level].details;console.assert(o,`Level details are defined when init segment is loaded`);var s=e.stats;t.state=w.IDLE,t.fragLoadError=0,e.data=new Uint8Array(n.payload),s.parsing.start=s.buffering.start=self.performance.now(),s.parsing.end=s.buffering.end=self.performance.now(),n.frag===r&&i.trigger(c.Events.FRAG_BUFFERED,{stats:s,frag:r,part:null,id:e.type}),t.tick()}).catch(function(n){t.warn(n),t.resetFragmentLoading(e)})},n.fragContextChanged=function(e){var t=this.fragCurrent;return!e||!t||e.level!==t.level||e.sn!==t.sn||e.urlId!==t.urlId},n.fragBufferedComplete=function(e,t){var n=this.mediaBuffer?this.mediaBuffer:this.media;this.log(`Buffered `+e.type+` sn: `+e.sn+(t?` part: `+t.index:``)+` of `+(this.logPrefix===`[stream-controller]`?`level`:`track`)+` `+e.level+` `+_.default.toString(o.BufferHelper.getBuffered(n))),this.state=w.IDLE,this.tick()},n._handleFragmentLoadComplete=function(e){var t=this.transmuxer;if(t){var n=e.frag,r=e.part,i=e.partsLoaded,a=!i||i.length===0||i.some(function(e){return!e}),o=new u.ChunkMetadata(n.level,n.sn,n.stats.chunkCount+1,0,r?r.index:-1,!a);t.flush(o)}},n._handleFragmentLoadProgress=function(e){},n._doFragLoad=function(e,t,n,i){var a=this;if(n===void 0&&(n=null),!this.levels)throw Error(`frag load aborted, missing levels`);if(n=Math.max(e.start,n||0),this.config.lowLatencyMode&&t){var o=t.partList;if(o&&i){n>e.end&&t.fragmentHint&&(e=t.fragmentHint);var s=this.getNextPart(o,e,n);if(s>-1){var l=o[s];return this.log(`Loading part sn: `+e.sn+` p: `+l.index+` cc: `+e.cc+` of playlist [`+t.startSN+`-`+t.endSN+`] parts [0-`+s+`-`+(o.length-1)+`] `+(this.logPrefix===`[stream-controller]`?`level`:`track`)+`: `+e.level+`, target: `+parseFloat(n.toFixed(3))),this.nextLoadPosition=l.start+l.duration,this.state=w.FRAG_LOADING,this.hls.trigger(c.Events.FRAG_LOADING,{frag:e,part:o[s],targetBufferTime:n}),this.doFragPartsLoad(e,o,s,i).catch(function(e){return a.handleFragLoadError(e)})}else if(!e.url||this.loadedEndOfParts(o,n))return Promise.resolve(null)}}return this.log(`Loading fragment `+e.sn+` cc: `+e.cc+` `+(t?`of [`+t.startSN+`-`+t.endSN+`] `:``)+(this.logPrefix===`[stream-controller]`?`level`:`track`)+`: `+e.level+`, target: `+parseFloat(n.toFixed(3))),(0,r.isFiniteNumber)(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=w.FRAG_LOADING,this.hls.trigger(c.Events.FRAG_LOADING,{frag:e,targetBufferTime:n}),this.fragmentLoader.load(e,i).catch(function(e){return a.handleFragLoadError(e)})},n.doFragPartsLoad=function(e,t,n,r){var i=this;return new Promise(function(a,o){var s=[];(function n(l){var u=t[l];i.fragmentLoader.loadPart(e,u,r).then(function(r){s[u.index]=r;var o=r.part;i.hls.trigger(c.Events.FRAG_LOADED,r);var d=t[l+1];if(d&&d.fragment===e)n(l+1);else return a({frag:e,part:o,partsLoaded:s})}).catch(o)})(n)})},n.handleFragLoadError=function(e){var t=e.data;return t&&t.details===l.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(c.Events.ERROR,t),null},n._handleTransmuxerFlush=function(e){var t=this.getCurrentContext(e);if(!t||this.state!==w.PARSING){this.fragCurrent||(this.state=w.IDLE);return}var n=t.frag,r=t.part,i=t.level,a=self.performance.now();n.stats.parsing.end=a,r&&(r.stats.parsing.end=a),this.updateLevelTiming(n,r,i,e.partial)},n.getCurrentContext=function(e){var t=this.levels,n=e.level,r=e.sn,i=e.part;if(!t||!t[n])return this.warn(`Levels object was unset while buffering fragment `+r+` of level `+n+`. The current chunk will not be buffered.`),null;var a=t[n],o=i>-1?(0,m.getPartWith)(a,r,i):null,s=o?o.fragment:(0,m.getFragmentWithSN)(a,r,this.fragCurrent);return s?{frag:s,part:o,level:a}:null},n.bufferFragmentData=function(e,t,n,r){if(!(!e||this.state!==w.PARSING)){var i=e.data1,a=e.data2,o=i;if(i&&a&&(o=(0,d.appendUint8Array)(i,a)),!(!o||!o.length)){var s={type:e.type,frag:t,part:n,chunkMeta:r,parent:t.type,data:o};this.hls.trigger(c.Events.BUFFER_APPENDING,s),e.dropped&&e.independent&&!n&&this.flushBufferGap(t)}}},n.flushBufferGap=function(e){var t=this.media;if(t){if(!o.BufferHelper.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}var n=t.currentTime,r=o.BufferHelper.bufferInfo(t,n,0),i=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,i*.25),s=Math.max(Math.min(e.start-a,r.end-a),n+a);e.start-s>a&&this.flushMainBuffer(s,e.start)}},n.getFwdBufferInfo=function(e,t){var n=this.config,i=this.getLoadPosition();if(!(0,r.isFiniteNumber)(i))return null;var a=o.BufferHelper.bufferInfo(e,i,n.maxBufferHole);if(a.len===0&&a.nextStart!==void 0){var s=this.fragmentTracker.getBufferedFrag(i,t);if(s&&a.nextStart<s.end)return o.BufferHelper.bufferInfo(e,i,Math.max(a.nextStart,n.maxBufferHole))}return a},n.getMaxBufferLength=function(e){var t=this.config,n=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength;return Math.min(n,t.maxMaxBufferLength)},n.reduceMaxBufferLength=function(e){var t=this.config,n=e||t.maxBufferLength;return t.maxMaxBufferLength>=n?(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to `+t.maxMaxBufferLength+`s`),!0):!1},n.getNextFragment=function(e,t){var n,r,i=t.fragments,a=i.length;if(!a)return null;var o=this.config,s=i[0].start,c;if(t.live){var l=o.initialLiveManifestSize;if(a<l)return this.warn(`Not enough fragments to start playback (have: `+a+`, need: `+l+`)`),null;!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(c=this.getInitialLiveFragment(t,i),this.startPosition=c?this.hls.liveSyncPosition||c.start:e)}else e<=s&&(c=i[0]);if(!c){var u=o.lowLatencyMode?t.partEnd:t.fragmentEnd;c=this.getFragmentAtPosition(e,u,t)}return(n=c)!=null&&n.initSegment&&!((r=c)!=null&&r.initSegment.data)&&!this.bitrateTest&&(c=c.initSegment),c},n.getNextPart=function(e,t,n){for(var r=-1,i=!1,a=!0,o=0,s=e.length;o<s;o++){var c=e[o];if(a&&=!c.independent,r>-1&&n<c.start)break;var l=c.loaded;!l&&(i||c.independent||a)&&c.fragment===t&&(r=o),i=l}return r},n.loadedEndOfParts=function(e,t){var n=e[e.length-1];return n&&t>n.start&&n.loaded},n.getInitialLiveFragment=function(e,t){var n=this.fragPrevious,r=null;if(n){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: `+n.programDateTime),r=(0,p.findFragmentByPDT)(t,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){var i=n.sn+1;if(i>=e.startSN&&i<=e.endSN){var a=t[i-e.startSN];n.cc===a.cc&&(r=a,this.log(`Live playlist, switching playlist, load frag with next SN: `+r.sn))}r||(r=(0,p.findFragWithCC)(t,n.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: `+r.sn))}}else{var o=this.hls.liveSyncPosition;o!==null&&(r=this.getFragmentAtPosition(o,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r},n.getFragmentAtPosition=function(e,t,n){var r=this.config,i=this.fragPrevious,o=n.fragments,s=n.endSN,c=n.fragmentHint,l=r.maxFragLookUpTolerance,u=!!(r.lowLatencyMode&&n.partList&&c);u&&c&&!this.bitrateTest&&(o=o.concat(c),s=c.sn);var d;if(e<t){var f=e>t-l?0:l;d=(0,p.findFragmentByPTS)(i,o,e,f)}else d=o[o.length-1];if(d){var m=d.sn-n.startSN,h=i&&d.level===i.level,g=o[m+1];if(this.fragmentTracker.getState(d)===a.FragmentState.BACKTRACKED){d=null;for(var _=m;o[_]&&this.fragmentTracker.getState(o[_])===a.FragmentState.BACKTRACKED;)d=i?o[_--]:o[--_];d||=g}else i&&d.sn===i.sn&&!u&&h&&(d.sn<s&&this.fragmentTracker.getState(g)!==a.FragmentState.OK?(this.log(`SN `+d.sn+` just loaded, load next one: `+g.sn),d=g):d=null)}return d},n.synchronizeToLiveEdge=function(e){var t=this.config,n=this.media;if(n){var r=this.hls.liveSyncPosition,i=n.currentTime,a=e.fragments[0].start,o=e.edge,s=i>=a-t.maxFragLookUpTolerance&&i<=o;if(r!==null&&n.duration>r&&(i<r||!s)){var c=t.liveMaxLatencyDuration===void 0?t.liveMaxLatencyDurationCount*e.targetduration:t.liveMaxLatencyDuration;(!s&&n.readyState<4||i<o-c)&&(this.loadedmetadata||(this.nextLoadPosition=r),n.readyState&&(this.warn(`Playback: `+i.toFixed(3)+` is located too far from the end of live sliding playlist: `+o+`, reset currentTime to : `+r.toFixed(3)),n.currentTime=r))}}},n.alignPlaylists=function(e,t){var n=this.levels,i=this.levelLastLoaded,a=this.fragPrevious,o=i===null?null:n[i],s=e.fragments.length;if(!s)return this.warn(`No fragments in live playlist`),0;var c=e.fragments[0].start,l=!t,u=e.alignedSliding&&(0,r.isFiniteNumber)(c);if(l||!u&&!c){(0,f.alignStream)(a,o,e);var d=e.fragments[0].start;return this.log(`Live playlist sliding: `+d.toFixed(2)+` start-sn: `+(t?t.startSN:`na`)+`->`+e.startSN+` prev-sn: `+(a?a.sn:`na`)+` fragments: `+s),d}return c},n.waitForCdnTuneIn=function(e){return e.live&&e.canBlockReload&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)},n.setStartPosition=function(e,t){var n=this.startPosition;if(n<t&&(n=-1),n===-1||this.lastCurrentTime===-1){var i=e.startTimeOffset;(0,r.isFiniteNumber)(i)?(n=t+i,i<0&&(n+=e.totalduration),n=Math.min(Math.max(t,n),t+e.totalduration),this.log(`Start time offset `+i+` found in playlist, adjust startPosition to `+n),this.startPosition=n):e.live?n=this.hls.liveSyncPosition||t:this.startPosition=n=0,this.lastCurrentTime=n}this.nextLoadPosition=n},n.getLoadPosition=function(){var e=this.media,t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t},n.handleFragLoadAborted=function(e,t){this.transmuxer&&e.sn!==`initSegment`&&e.stats.aborted&&(this.warn(`Fragment `+e.sn+(t?` part`+t.index:``)+` of level `+e.level+` was aborted`),this.resetFragmentLoading(e))},n.resetFragmentLoading=function(e){(!this.fragCurrent||!this.fragContextChanged(e))&&(this.state=w.IDLE)},n.onFragmentOrKeyLoadError=function(e,t){if(!t.fatal){var n=t.frag;if(!(!n||n.type!==e)){var r=this.fragCurrent;console.assert(r&&n.sn===r.sn&&n.level===r.level&&n.urlId===r.urlId,`Frag load error must match current frag to retry`);var i=this.config;if(this.fragLoadError+1<=i.fragLoadingMaxRetry){if(this.resetLiveStartWhenNotLoaded(n.level))return;var a=Math.min(2**this.fragLoadError*i.fragLoadingRetryDelay,i.fragLoadingMaxRetryTimeout);this.warn(`Fragment `+n.sn+` of `+e+` `+n.level+` failed to load, retrying in `+a+`ms`),this.retryDate=self.performance.now()+a,this.fragLoadError++,this.state=w.FRAG_LOADING_WAITING_RETRY}else t.levelRetry?(e===v.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=w.IDLE):(s.logger.error(t.details+` reaches max retry, redispatch as fatal ...`),t.fatal=!0,this.hls.stopLoad(),this.state=w.ERROR)}}},n.afterBufferFlushed=function(e,t,n){if(e){var r=o.BufferHelper.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,n),this.state===w.ENDED&&this.resetLoadingState()}},n.resetLoadingState=function(){this.fragCurrent=null,this.fragPrevious=null,this.state=w.IDLE},n.resetLiveStartWhenNotLoaded=function(e){if(!this.loadedmetadata){this.startFragRequested=!1;var t=this.levels?this.levels[e].details:null;if(t!=null&&t.live)return this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState(),!0;this.nextLoadPosition=this.startPosition}return!1},n.updateLevelTiming=function(e,t,n,r){var i=this,a=n.details;console.assert(!!a,`level.details must be defined`),Object.keys(e.elementaryStreams).reduce(function(t,o){var s=e.elementaryStreams[o];if(s){var l=s.endPTS-s.startPTS;if(l<=0)return i.warn(`Could not parse fragment `+e.sn+` `+o+` duration reliably (`+l+`) resetting transmuxer to fallback to playlist timing`),i.resetTransmuxer(),t||!1;var u=r?0:(0,m.updateFragPTSDTS)(a,e,s.startPTS,s.endPTS,s.startDTS,s.endDTS);return i.hls.trigger(c.Events.LEVEL_PTS_UPDATED,{details:a,level:n,drift:u,type:o,frag:e,start:s.startPTS,end:s.endPTS}),!0}return t},!1)?(this.state=w.PARSED,this.hls.trigger(c.Events.FRAG_PARSED,{frag:e,part:t})):this.resetLoadingState()},n.resetTransmuxer=function(){this.transmuxer&&=(this.transmuxer.destroy(),null)},b(t,[{key:`state`,get:function(){return this._state},set:function(e){var t=this._state;t!==e&&(this._state=e,this.log(t+`->`+e))}}]),t}(i.default)}),"./src/controller/buffer-controller.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return p});var r=n(`./src/polyfills/number.ts`),i=n(`./src/events.ts`),a=n(`./src/utils/logger.ts`),o=n(`./src/errors.ts`),s=n(`./src/utils/buffer-helper.ts`),c=n(`./src/utils/mediasource-helper.ts`),l=n(`./src/loader/fragment.ts`),u=n(`./src/controller/buffer-operation-queue.ts`),d=(0,c.getMediaSource)(),f=/([ha]vc.)(?:\.[^.,]+)+/,p=function(){function e(e){var t=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var e=t.hls,n=t.media,r=t.mediaSource;a.logger.log(`[buffer-controller]: Media source opened`),n&&(t.updateMediaElementDuration(),e.trigger(i.Events.MEDIA_ATTACHED,{media:n})),r&&r.removeEventListener(`sourceopen`,t._onMediaSourceOpen),t.checkPendingTracks()},this._onMediaSourceClose=function(){a.logger.log(`[buffer-controller]: Media source closed`)},this._onMediaSourceEnded=function(){a.logger.log(`[buffer-controller]: Media source ended`)},this.hls=e,this._initSourceBuffer(),this.registerListeners()}var t=e.prototype;return t.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},t.destroy=function(){this.unregisterListeners(),this.details=null},t.registerListeners=function(){var e=this.hls;e.on(i.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(i.Events.BUFFER_RESET,this.onBufferReset,this),e.on(i.Events.BUFFER_APPENDING,this.onBufferAppending,this),e.on(i.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.on(i.Events.BUFFER_EOS,this.onBufferEos,this),e.on(i.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(i.Events.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(i.Events.FRAG_PARSED,this.onFragParsed,this),e.on(i.Events.FRAG_CHANGED,this.onFragChanged,this)},t.unregisterListeners=function(){var e=this.hls;e.off(i.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(i.Events.BUFFER_RESET,this.onBufferReset,this),e.off(i.Events.BUFFER_APPENDING,this.onBufferAppending,this),e.off(i.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.off(i.Events.BUFFER_EOS,this.onBufferEos,this),e.off(i.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(i.Events.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(i.Events.FRAG_PARSED,this.onFragParsed,this),e.off(i.Events.FRAG_CHANGED,this.onFragChanged,this)},t._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new u.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}},t.onManifestParsed=function(e,t){var n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=n,this.details=null,a.logger.log(this.bufferCodecEventsExpected+` bufferCodec event(s) expected`)},t.onMediaAttaching=function(e,t){var n=this.media=t.media;if(n&&d){var r=this.mediaSource=new d;r.addEventListener(`sourceopen`,this._onMediaSourceOpen),r.addEventListener(`sourceended`,this._onMediaSourceEnded),r.addEventListener(`sourceclose`,this._onMediaSourceClose),n.src=self.URL.createObjectURL(r),this._objectUrl=n.src}},t.onMediaDetaching=function(){var e=this.media,t=this.mediaSource,n=this._objectUrl;if(t){if(a.logger.log(`[buffer-controller]: media source detaching`),t.readyState===`open`)try{t.endOfStream()}catch(e){a.logger.warn(`[buffer-controller]: onMediaDetaching: `+e.message+` while calling endOfStream`)}this.onBufferReset(),t.removeEventListener(`sourceopen`,this._onMediaSourceOpen),t.removeEventListener(`sourceended`,this._onMediaSourceEnded),t.removeEventListener(`sourceclose`,this._onMediaSourceClose),e&&(n&&self.URL.revokeObjectURL(n),e.src===n?(e.removeAttribute(`src`),e.load()):a.logger.warn(`[buffer-controller]: media.src was changed by a third party - skip cleanup`)),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(i.Events.MEDIA_DETACHED,void 0)},t.onBufferReset=function(){var e=this;this.getSourceBufferTypes().forEach(function(t){var n=e.sourceBuffer[t];try{n&&(e.removeBufferListeners(t),e.mediaSource&&e.mediaSource.removeSourceBuffer(n),e.sourceBuffer[t]=void 0)}catch(e){a.logger.warn(`[buffer-controller]: Failed to reset the `+t+` buffer`,e)}}),this._initSourceBuffer()},t.onBufferCodecs=function(e,t){var n=this,r=this.getSourceBufferTypes().length;Object.keys(t).forEach(function(e){if(r){var i=n.tracks[e];if(i&&typeof i.buffer.changeType==`function`){var a=t[e],o=a.codec,s=a.levelCodec,c=a.container;if((i.levelCodec||i.codec).replace(f,`$1`)!==(s||o).replace(f,`$1`)){var l=c+`;codecs=`+(s||o);n.appendChangeType(e,l)}}}else n.pendingTracks[e]=t[e]}),!r&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState===`open`&&this.checkPendingTracks())},t.appendChangeType=function(e,t){var n=this,r=this.operationQueue;r.append({execute:function(){var i=n.sourceBuffer[e];i&&(a.logger.log(`[buffer-controller]: changing `+e+` sourceBuffer type to `+t),i.changeType(t)),r.shiftAndExecuteNext(e)},onStart:function(){},onComplete:function(){},onError:function(t){a.logger.warn(`[buffer-controller]: Failed to change `+e+` SourceBuffer type`,t)}},e)},t.onBufferAppending=function(e,t){var n=this,r=this.hls,c=this.operationQueue,l=this.tracks,u=t.data,d=t.type,f=t.frag,p=t.part,m=t.chunkMeta,h=m.buffering[d],g=self.performance.now();h.start=g;var _=f.stats.buffering,v=p?p.stats.buffering:null;_.start===0&&(_.start=g),v&&v.start===0&&(v.start=g);var y=l.audio,b=d===`audio`&&m.id===1&&y?.container===`audio/mpeg`;c.append({execute:function(){if(h.executeStart=self.performance.now(),b){var e=n.sourceBuffer[d];if(e){var t=f.start-e.timestampOffset;Math.abs(t)>=.1&&(a.logger.log(`[buffer-controller]: Updating audio SourceBuffer timestampOffset to `+f.start+` (delta: `+t+`) sn: `+f.sn+`)`),e.timestampOffset=f.start)}}n.appendExecutor(u,d)},onStart:function(){},onComplete:function(){var e=self.performance.now();h.executeEnd=h.end=e,_.first===0&&(_.first=e),v&&v.first===0&&(v.first=e);var t=n.sourceBuffer,r={};for(var a in t)r[a]=s.BufferHelper.getBuffered(t[a]);n.appendError=0,n.hls.trigger(i.Events.BUFFER_APPENDED,{type:d,frag:f,part:p,chunkMeta:m,parent:f.type,timeRanges:r})},onError:function(e){a.logger.error(`[buffer-controller]: Error encountered while trying to append to the `+d+` SourceBuffer`,e);var t={type:o.ErrorTypes.MEDIA_ERROR,parent:f.type,details:o.ErrorDetails.BUFFER_APPEND_ERROR,err:e,fatal:!1};e.code===DOMException.QUOTA_EXCEEDED_ERR?t.details=o.ErrorDetails.BUFFER_FULL_ERROR:(n.appendError++,t.details=o.ErrorDetails.BUFFER_APPEND_ERROR,n.appendError>r.config.appendErrorMaxRetry&&(a.logger.error(`[buffer-controller]: Failed `+r.config.appendErrorMaxRetry+` times to append segment in sourceBuffer`),t.fatal=!0)),r.trigger(i.Events.ERROR,t)}},d)},t.onBufferFlushing=function(e,t){var n=this,r=this.operationQueue,o=function(e){return{execute:n.removeExecutor.bind(n,e,t.startOffset,t.endOffset),onStart:function(){},onComplete:function(){n.hls.trigger(i.Events.BUFFER_FLUSHED,{type:e})},onError:function(t){a.logger.warn(`[buffer-controller]: Failed to remove from `+e+` SourceBuffer`,t)}}};t.type?r.append(o(t.type),t.type):this.getSourceBufferTypes().forEach(function(e){r.append(o(e),e)})},t.onFragParsed=function(e,t){var n=this,r=t.frag,o=t.part,s=[],c=o?o.elementaryStreams:r.elementaryStreams;c[l.ElementaryStreamTypes.AUDIOVIDEO]?s.push(`audiovideo`):(c[l.ElementaryStreamTypes.AUDIO]&&s.push(`audio`),c[l.ElementaryStreamTypes.VIDEO]&&s.push(`video`)),s.length===0&&a.logger.warn(`Fragments must have at least one ElementaryStreamType set. type: `+r.type+` level: `+r.level+` sn: `+r.sn),this.blockBuffers(function(){var e=self.performance.now();r.stats.buffering.end=e,o&&(o.stats.buffering.end=e);var t=o?o.stats:r.stats;n.hls.trigger(i.Events.FRAG_BUFFERED,{frag:r,part:o,stats:t,id:r.type})},s)},t.onFragChanged=function(e,t){this.flushBackBuffer()},t.onBufferEos=function(e,t){var n=this;this.getSourceBufferTypes().reduce(function(e,r){var i=n.sourceBuffer[r];return(!t.type||t.type===r)&&i&&!i.ended&&(i.ended=!0,a.logger.log(`[buffer-controller]: `+r+` sourceBuffer now EOS`)),e&&!!(!i||i.ended)},!0)&&this.blockBuffers(function(){var e=n.mediaSource;!e||e.readyState!==`open`||e.endOfStream()})},t.onLevelUpdated=function(e,t){var n=t.details;n.fragments.length&&(this.details=n,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},t.flushBackBuffer=function(){var e=this.hls,t=this.details,n=this.media,a=this.sourceBuffer;if(!(!n||t===null)){var o=this.getSourceBufferTypes();if(o.length){var c=t.live&&e.config.liveBackBufferLength!==null?e.config.liveBackBufferLength:e.config.backBufferLength;if(!(!(0,r.isFiniteNumber)(c)||c<0)){var l=n.currentTime,u=t.levelTargetDuration,d=Math.max(c,u),f=Math.floor(l/u)*u-d;o.forEach(function(n){var r=a[n];if(r){var o=s.BufferHelper.getBuffered(r);o.length>0&&f>o.start(0)&&(e.trigger(i.Events.BACK_BUFFER_REACHED,{bufferEnd:f}),t.live&&e.trigger(i.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:f}),e.trigger(i.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:f,type:n}))}})}}}},t.updateMediaElementDuration=function(){if(!(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!==`open`)){var e=this.details,t=this.hls,n=this.media,i=this.mediaSource,o=e.fragments[0].start+e.totalduration,s=n.duration,c=(0,r.isFiniteNumber)(i.duration)?i.duration:0;e.live&&t.config.liveDurationInfinity?(a.logger.log(`[buffer-controller]: Media Source duration is set to Infinity`),i.duration=1/0,this.updateSeekableRange(e)):(o>c&&o>s||!(0,r.isFiniteNumber)(s))&&(a.logger.log(`[buffer-controller]: Updating Media Source duration to `+o.toFixed(3)),i.duration=o)}},t.updateSeekableRange=function(e){var t=this.mediaSource,n=e.fragments;if(n.length&&e.live&&t!=null&&t.setLiveSeekableRange){var r=Math.max(0,n[0].start),i=Math.max(r,r+e.totalduration);t.setLiveSeekableRange(r,i)}},t.checkPendingTracks=function(){var e=this.bufferCodecEventsExpected,t=this.operationQueue,n=this.pendingTracks,r=Object.keys(n).length;if(r&&!e||r===2){this.createSourceBuffers(n),this.pendingTracks={};var a=this.getSourceBufferTypes();if(a.length===0){this.hls.trigger(i.Events.ERROR,{type:o.ErrorTypes.MEDIA_ERROR,details:o.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:`could not create source buffer for media codec(s)`});return}a.forEach(function(e){t.executeNext(e)})}},t.createSourceBuffers=function(e){var t=this.sourceBuffer,n=this.mediaSource;if(!n)throw Error(`createSourceBuffers called when mediaSource was null`);var r=0;for(var s in e)if(!t[s]){var c=e[s];if(!c)throw Error(`source buffer exists for track `+s+`, however track does not`);var l=c.levelCodec||c.codec,u=c.container+`;codecs=`+l;a.logger.log(`[buffer-controller]: creating sourceBuffer(`+u+`)`);try{var d=t[s]=n.addSourceBuffer(u),f=s;this.addBufferListener(f,`updatestart`,this._onSBUpdateStart),this.addBufferListener(f,`updateend`,this._onSBUpdateEnd),this.addBufferListener(f,`error`,this._onSBUpdateError),this.tracks[s]={buffer:d,codec:l,container:c.container,levelCodec:c.levelCodec,id:c.id},r++}catch(e){a.logger.error(`[buffer-controller]: error while trying to add sourceBuffer: `+e.message),this.hls.trigger(i.Events.ERROR,{type:o.ErrorTypes.MEDIA_ERROR,details:o.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,mimeType:u})}}r&&this.hls.trigger(i.Events.BUFFER_CREATED,{tracks:this.tracks})},t._onSBUpdateStart=function(e){this.operationQueue.current(e).onStart()},t._onSBUpdateEnd=function(e){var t=this.operationQueue;t.current(e).onComplete(),t.shiftAndExecuteNext(e)},t._onSBUpdateError=function(e,t){a.logger.error(`[buffer-controller]: `+e+` SourceBuffer error`,t),this.hls.trigger(i.Events.ERROR,{type:o.ErrorTypes.MEDIA_ERROR,details:o.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var n=this.operationQueue.current(e);n&&n.onError(t)},t.removeExecutor=function(e,t,n){var i=this.media,o=this.mediaSource,s=this.operationQueue,c=this.sourceBuffer[e];if(!i||!o||!c){a.logger.warn(`[buffer-controller]: Attempting to remove from the `+e+` SourceBuffer, but it does not exist`),s.shiftAndExecuteNext(e);return}var l=(0,r.isFiniteNumber)(i.duration)?i.duration:1/0,u=(0,r.isFiniteNumber)(o.duration)?o.duration:1/0,d=Math.max(0,t),f=Math.min(n,l,u);f>d?(a.logger.log(`[buffer-controller]: Removing [`+d+`,`+f+`] from the `+e+` SourceBuffer`),console.assert(!c.updating,e+` sourceBuffer must not be updating`),c.remove(d,f)):s.shiftAndExecuteNext(e)},t.appendExecutor=function(e,t){var n=this.operationQueue,r=this.sourceBuffer[t];if(!r){a.logger.warn(`[buffer-controller]: Attempting to append to the `+t+` SourceBuffer, but it does not exist`),n.shiftAndExecuteNext(t);return}r.ended=!1,console.assert(!r.updating,t+` sourceBuffer must not be updating`),r.appendBuffer(e)},t.blockBuffers=function(e,t){var n=this;if(t===void 0&&(t=this.getSourceBufferTypes()),!t.length){a.logger.log(`[buffer-controller]: Blocking operation requested, but no SourceBuffers exist`),Promise.resolve(e);return}var r=this.operationQueue,i=t.map(function(e){return r.appendBlocker(e)});Promise.all(i).then(function(){e(),t.forEach(function(e){var t=n.sourceBuffer[e];(!t||!t.updating)&&r.shiftAndExecuteNext(e)})})},t.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},t.addBufferListener=function(e,t,n){var r=this.sourceBuffer[e];if(r){var i=n.bind(this,e);this.listeners[e].push({event:t,listener:i}),r.addEventListener(t,i)}},t.removeBufferListeners=function(e){var t=this.sourceBuffer[e];t&&this.listeners[e].forEach(function(e){t.removeEventListener(e.event,e.listener)})},e}()}),"./src/controller/buffer-operation-queue.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return i});var r=n(`./src/utils/logger.ts`),i=function(){function e(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}var t=e.prototype;return t.append=function(e,t){var n=this.queues[t];n.push(e),n.length===1&&this.buffers[t]&&this.executeNext(t)},t.insertAbort=function(e,t){this.queues[t].unshift(e),this.executeNext(t)},t.appendBlocker=function(e){var t,n=new Promise(function(e){t=e}),r={execute:t,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(r,e),n},t.executeNext=function(e){var t=this.buffers,n=this.queues,i=t[e],a=n[e];if(a.length){var o=a[0];try{o.execute()}catch(t){r.logger.warn(`[buffer-operation-queue]: Unhandled exception executing the current operation`),o.onError(t),(!i||!i.updating)&&(a.shift(),this.executeNext(e))}}},t.shiftAndExecuteNext=function(e){this.queues[e].shift(),this.executeNext(e)},t.current=function(e){return this.queues[e][0]},e}()}),"./src/controller/cap-level-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/events.ts`);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}t.default=function(){function e(e){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=e,this.autoLevelCapping=1/0,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var t=e.prototype;return t.setStreamController=function(e){this.streamController=e},t.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},t.registerListeners=function(){var e=this.hls;e.on(r.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(r.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(r.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.on(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},t.unregisterListener=function(){var e=this.hls;e.off(r.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(r.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(r.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.off(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},t.onFpsDropLevelCapping=function(t,n){e.isLevelAllowed(n.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(n.droppedLevel)},t.onMediaAttaching=function(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null},t.onManifestParsed=function(e,t){var n=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,n.config.capLevelToPlayerSize&&t.video&&this.startCapping()},t.onBufferCodecs=function(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()},t.onMediaDetaching=function(){this.stopCapping()},t.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var e=this.hls.levels;if(e.length){var t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}},t.getMaxLevel=function(t){var n=this,r=this.hls.levels;if(!r.length)return-1;var i=r.filter(function(r,i){return e.isLevelAllowed(i,n.restrictedLevels)&&i<=t});return this.clientRect=null,e.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)},t.startCapping=function(){this.timer||(this.autoLevelCapping=1/0,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},t.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=1/0,this.timer&&=(self.clearInterval(this.timer),void 0)},t.getDimensions=function(){if(this.clientRect)return this.clientRect;var e=this.media,t={width:0,height:0};if(e){var n=e.getBoundingClientRect();t.width=n.width,t.height=n.height,!t.width&&!t.height&&(t.width=n.right-n.left||e.width||0,t.height=n.bottom-n.top||e.height||0)}return this.clientRect=t,t},e.isLevelAllowed=function(e,t){return t===void 0&&(t=[]),t.indexOf(e)===-1},e.getMaxLevelByMediaSize=function(e,t,n){if(!e||!e.length)return-1;for(var r=function(e,t){return t?e.width!==t.width||e.height!==t.height:!0},i=e.length-1,a=0;a<e.length;a+=1){var o=e[a];if((o.width>=t||o.height>=n)&&r(o,e[a+1])){i=a;break}}return i},a(e,[{key:`mediaWidth`,get:function(){return this.getDimensions().width*e.contentScaleFactor}},{key:`mediaHeight`,get:function(){return this.getDimensions().height*e.contentScaleFactor}}],[{key:`contentScaleFactor`,get:function(){var e=1;try{e=self.devicePixelRatio}catch{}return e}}]),e}()}),"./src/controller/cmcd-controller.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return p});var r=n(`./src/events.ts`),i=n(`./src/types/cmcd.ts`),a=n(`./src/utils/buffer-helper.ts`),o=n(`./src/utils/logger.ts`);function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function l(e,t){var n=typeof Symbol<`u`&&e[Symbol.iterator]||e[`@@iterator`];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=u(e))||t&&e&&typeof e.length==`number`){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function u(e,t){if(e){if(typeof e==`string`)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n===`Object`&&e.constructor&&(n=e.constructor.name),n===`Map`||n===`Set`)return Array.from(e);if(n===`Arguments`||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return d(e,t)}}function d(e,t){(t==null||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function f(){return f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},f.apply(this,arguments)}var p=function(){function e(t){var n=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){n.initialized&&(n.starved=!0),n.buffering=!0},this.onPlaying=function(){n.initialized||=!0,n.buffering=!1},this.applyPlaylistData=function(e){try{n.apply(e,{ot:i.CMCDObjectType.MANIFEST,su:!n.initialized})}catch(e){o.logger.warn(`Could not generate manifest CMCD data.`,e)}},this.applyFragmentData=function(e){try{var t=e.frag,r=n.hls.levels[t.level],a=n.getObjectType(t),s={d:t.duration*1e3,ot:a};(a===i.CMCDObjectType.VIDEO||a===i.CMCDObjectType.AUDIO||a==i.CMCDObjectType.MUXED)&&(s.br=r.bitrate/1e3,s.tb=n.getTopBandwidth(a)/1e3,s.bl=n.getBufferLength(a)),n.apply(e,s)}catch(e){o.logger.warn(`Could not generate segment CMCD data.`,e)}},this.hls=t;var r=this.config=t.config,a=r.cmcd;a!=null&&(r.pLoader=this.createPlaylistLoader(),r.fLoader=this.createFragmentLoader(),this.sid=a.sessionId||e.uuid(),this.cid=a.contentId,this.useHeaders=a.useHeaders===!0,this.registerListeners())}var t=e.prototype;return t.registerListeners=function(){var e=this.hls;e.on(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.Events.MEDIA_DETACHED,this.onMediaDetached,this),e.on(r.Events.BUFFER_CREATED,this.onBufferCreated,this)},t.unregisterListeners=function(){var e=this.hls;e.off(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.Events.MEDIA_DETACHED,this.onMediaDetached,this),e.off(r.Events.BUFFER_CREATED,this.onBufferCreated,this),this.onMediaDetached()},t.destroy=function(){this.unregisterListeners(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},t.onMediaAttached=function(e,t){this.media=t.media,this.media.addEventListener(`waiting`,this.onWaiting),this.media.addEventListener(`playing`,this.onPlaying)},t.onMediaDetached=function(){this.media&&=(this.media.removeEventListener(`waiting`,this.onWaiting),this.media.removeEventListener(`playing`,this.onPlaying),null)},t.onBufferCreated=function(e,t){this.audioBuffer=t.tracks.audio?.buffer,this.videoBuffer=t.tracks.video?.buffer},t.createData=function(){return{v:i.CMCDVersion,sf:i.CMCDStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:this.media?.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},t.apply=function(t,n){n===void 0&&(n={}),f(n,this.createData());var r=n.ot===i.CMCDObjectType.INIT||n.ot===i.CMCDObjectType.VIDEO||n.ot===i.CMCDObjectType.MUXED;if(this.starved&&r&&(n.bs=!0,n.su=!0,this.starved=!1),n.su??=this.buffering,this.useHeaders){var a=e.toHeaders(n);if(!Object.keys(a).length)return;t.headers||={},f(t.headers,a)}else{var o=e.toQuery(n);if(!o)return;t.url=e.appendQueryToUri(t.url,o)}},t.getObjectType=function(e){var t=e.type;if(t===`subtitle`)return i.CMCDObjectType.TIMED_TEXT;if(e.sn===`initSegment`)return i.CMCDObjectType.INIT;if(t===`audio`)return i.CMCDObjectType.AUDIO;if(t===`main`)return this.hls.audioTracks.length?i.CMCDObjectType.VIDEO:i.CMCDObjectType.MUXED},t.getTopBandwidth=function(e){var t=0,n,r=this.hls;if(e===i.CMCDObjectType.AUDIO)n=r.audioTracks;else{var a=r.maxAutoLevel,o=a>-1?a+1:r.levels.length;n=r.levels.slice(0,o)}for(var s=l(n),c;!(c=s()).done;){var u=c.value;u.bitrate>t&&(t=u.bitrate)}return t>0?t:NaN},t.getBufferLength=function(e){var t=this.hls.media,n=e===i.CMCDObjectType.AUDIO?this.audioBuffer:this.videoBuffer;return!n||!t?NaN:a.BufferHelper.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len*1e3},t.createPlaylistLoader=function(){var e=this.config.pLoader,t=this.applyPlaylistData,n=e||this.config.loader;return function(){function e(e){this.loader=void 0,this.loader=new n(e)}var r=e.prototype;return r.destroy=function(){this.loader.destroy()},r.abort=function(){this.loader.abort()},r.load=function(e,n,r){t(e),this.loader.load(e,n,r)},c(e,[{key:`stats`,get:function(){return this.loader.stats}},{key:`context`,get:function(){return this.loader.context}}]),e}()},t.createFragmentLoader=function(){var e=this.config.fLoader,t=this.applyFragmentData,n=e||this.config.loader;return function(){function e(e){this.loader=void 0,this.loader=new n(e)}var r=e.prototype;return r.destroy=function(){this.loader.destroy()},r.abort=function(){this.loader.abort()},r.load=function(e,n,r){t(e),this.loader.load(e,n,r)},c(e,[{key:`stats`,get:function(){return this.loader.stats}},{key:`context`,get:function(){return this.loader.context}}]),e}()},e.uuid=function(){var e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.substr(t.lastIndexOf(`/`)+1)},e.serialize=function(e){for(var t=[],n=function(e){return!Number.isNaN(e)&&e!=null&&e!==``&&e!==!1},r=function(e){return Math.round(e)},i=function(e){return r(e/100)*100},a={br:r,d:r,bl:i,dl:i,mtp:i,nor:function(e){return encodeURIComponent(e)},rtp:i,tb:r},o=l(Object.keys(e||{}).sort()),s;!(s=o()).done;){var c=s.value,u=e[c];if(n(u)&&!(c===`v`&&u===1)&&!(c==`pr`&&u===1)){var d=a[c];d&&(u=d(u));var f=typeof u,p=void 0;p=c===`ot`||c===`sf`||c===`st`?c+`=`+u:f===`boolean`?c:f===`number`?c+`=`+u:c+`=`+JSON.stringify(u),t.push(p)}}return t.join(`,`)},e.toHeaders=function(t){for(var n=Object.keys(t),r={},i=[`Object`,`Request`,`Session`,`Status`],a=[{},{},{},{}],o={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},s=0,c=n;s<c.length;s++){var l=c[s],u=o[l]==null?1:o[l];a[u][l]=t[l]}for(var d=0;d<a.length;d++){var f=e.serialize(a[d]);f&&(r[`CMCD-`+i[d]]=f)}return r},e.toQuery=function(t){return`CMCD=`+encodeURIComponent(e.serialize(t))},e.appendQueryToUri=function(e,t){if(!t)return e;var n=e.includes(`?`)?`&`:`?`;return``+e+n+t},e}()}),"./src/controller/eme-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/events.ts`),i=n(`./src/errors.ts`),a=n(`./src/utils/logger.ts`),o=n(`./src/utils/mediakeys-helper.ts`);function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}var l=3,u=function(e,t,n){var r={audioCapabilities:[],videoCapabilities:[]};return e.forEach(function(e){r.audioCapabilities.push({contentType:`audio/mp4; codecs="`+e+`"`,robustness:n.audioRobustness||``})}),t.forEach(function(e){r.videoCapabilities.push({contentType:`video/mp4; codecs="`+e+`"`,robustness:n.videoRobustness||``})}),[r]},d=function(e,t,n,r){switch(e){case o.KeySystems.WIDEVINE:return u(t,n,r);default:throw Error(`Unknown key-system: `+e)}};t.default=function(){function e(e){this.hls=void 0,this._widevineLicenseUrl=void 0,this._licenseXhrSetup=void 0,this._licenseResponseCallback=void 0,this._emeEnabled=void 0,this._requestMediaKeySystemAccess=void 0,this._drmSystemOptions=void 0,this._config=void 0,this._mediaKeysList=[],this._media=null,this._hasSetMediaKeys=!1,this._requestLicenseFailureCount=0,this.mediaKeysPromise=null,this._onMediaEncrypted=this.onMediaEncrypted.bind(this),this.hls=e,this._config=e.config,this._widevineLicenseUrl=this._config.widevineLicenseUrl,this._licenseXhrSetup=this._config.licenseXhrSetup,this._licenseResponseCallback=this._config.licenseResponseCallback,this._emeEnabled=this._config.emeEnabled,this._requestMediaKeySystemAccess=this._config.requestMediaKeySystemAccessFunc,this._drmSystemOptions=this._config.drmSystemOptions,this._registerListeners()}var t=e.prototype;return t.destroy=function(){this._unregisterListeners(),this.hls=this._onMediaEncrypted=null,this._requestMediaKeySystemAccess=null},t._registerListeners=function(){this.hls.on(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(r.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(r.Events.MANIFEST_PARSED,this.onManifestParsed,this)},t._unregisterListeners=function(){this.hls.off(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(r.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(r.Events.MANIFEST_PARSED,this.onManifestParsed,this)},t.getLicenseServerUrl=function(e){switch(e){case o.KeySystems.WIDEVINE:if(!this._widevineLicenseUrl)break;return this._widevineLicenseUrl}throw Error(`no license server URL configured for key-system "`+e+`"`)},t._attemptKeySystemAccess=function(e,t,n){var r=this,i=d(e,t,n,this._drmSystemOptions);a.logger.log(`Requesting encrypted media key-system access`);var o=this.requestMediaKeySystemAccess(e,i);this.mediaKeysPromise=o.then(function(t){return r._onMediaKeySystemAccessObtained(e,t)}),o.catch(function(t){a.logger.error(`Failed to obtain key-system "`+e+`" access:`,t)})},t._onMediaKeySystemAccessObtained=function(e,t){var n=this;a.logger.log(`Access for key-system "`+e+`" obtained`);var r={mediaKeysSessionInitialized:!1,mediaKeySystemAccess:t,mediaKeySystemDomain:e};this._mediaKeysList.push(r);var i=Promise.resolve().then(function(){return t.createMediaKeys()}).then(function(t){return r.mediaKeys=t,a.logger.log(`Media-keys created for key-system "`+e+`"`),n._onMediaKeysCreated(),t});return i.catch(function(e){a.logger.error(`Failed to create media-keys:`,e)}),i},t._onMediaKeysCreated=function(){var e=this;this._mediaKeysList.forEach(function(t){t.mediaKeysSession||(t.mediaKeysSession=t.mediaKeys.createSession(),e._onNewMediaKeySession(t.mediaKeysSession))})},t._onNewMediaKeySession=function(e){var t=this;a.logger.log(`New key-system session `+e.sessionId),e.addEventListener(`message`,function(n){t._onKeySessionMessage(e,n.message)},!1)},t._onKeySessionMessage=function(e,t){a.logger.log(`Got EME message event, creating license request`),this._requestLicense(t,function(t){a.logger.log(`Received license data (length: `+(t&&t.byteLength)+`), updating key-session`),e.update(t)})},t.onMediaEncrypted=function(e){var t=this;if(a.logger.log(`Media is encrypted using "`+e.initDataType+`" init data type`),!this.mediaKeysPromise){a.logger.error(`Fatal: Media is encrypted but no CDM access or no keys have been requested`),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});return}var n=function(n){t._media&&(t._attemptSetMediaKeys(n),t._generateRequestWithPreferredKeySession(e.initDataType,e.initData))};this.mediaKeysPromise.then(n).catch(n)},t._attemptSetMediaKeys=function(e){if(!this._media)throw Error(`Attempted to set mediaKeys without first attaching a media element`);if(!this._hasSetMediaKeys){var t=this._mediaKeysList[0];if(!t||!t.mediaKeys){a.logger.error(`Fatal: Media is encrypted but no CDM access or no keys have been obtained yet`),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});return}a.logger.log(`Setting keys for encrypted media`),this._media.setMediaKeys(t.mediaKeys),this._hasSetMediaKeys=!0}},t._generateRequestWithPreferredKeySession=function(e,t){var n=this,o=this._mediaKeysList[0];if(!o){a.logger.error(`Fatal: Media is encrypted but not any key-system access has been obtained yet`),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});return}if(o.mediaKeysSessionInitialized){a.logger.warn(`Key-Session already initialized but requested again`);return}var s=o.mediaKeysSession;if(!s){a.logger.error(`Fatal: Media is encrypted but no key-session existing`),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!0});return}if(!t){a.logger.warn(`Fatal: initData required for generating a key session is null`),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_INIT_DATA,fatal:!0});return}a.logger.log(`Generating key-session request for "`+e+`" init data type`),o.mediaKeysSessionInitialized=!0,s.generateRequest(e,t).then(function(){a.logger.debug(`Key-session generation succeeded`)}).catch(function(e){a.logger.error(`Error generating key-session request:`,e),n.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!1})})},t._createLicenseXhr=function(e,t,n){var r=new XMLHttpRequest;r.responseType=`arraybuffer`,r.onreadystatechange=this._onLicenseRequestReadyStageChange.bind(this,r,e,t,n);var i=this._licenseXhrSetup;if(i)try{i.call(this.hls,r,e),i=void 0}catch(e){a.logger.error(e)}try{r.readyState||r.open(`POST`,e,!0),i&&i.call(this.hls,r,e)}catch(e){throw Error(`issue setting up KeySystem license XHR `+e)}return r},t._onLicenseRequestReadyStageChange=function(e,t,n,o){switch(e.readyState){case 4:if(e.status===200){this._requestLicenseFailureCount=0,a.logger.log(`License request succeeded`);var s=e.response,c=this._licenseResponseCallback;if(c)try{s=c.call(this.hls,e,t)}catch(e){a.logger.error(e)}o(s)}else{if(a.logger.error(`License Request XHR failed (`+t+`). Status: `+e.status+` (`+e.statusText+`)`),this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l){this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0});return}var u=l-this._requestLicenseFailureCount+1;a.logger.warn(`Retrying license request, `+u+` attempts left`),this._requestLicense(n,o)}break}},t._generateLicenseRequestChallenge=function(e,t){switch(e.mediaKeySystemDomain){case o.KeySystems.WIDEVINE:return t}throw Error(`unsupported key-system: `+e.mediaKeySystemDomain)},t._requestLicense=function(e,t){a.logger.log(`Requesting content license for key-system`);var n=this._mediaKeysList[0];if(!n){a.logger.error(`Fatal error: Media is encrypted but no key-system access has been obtained yet`),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});return}try{var o=this.getLicenseServerUrl(n.mediaKeySystemDomain),s=this._createLicenseXhr(o,e,t);a.logger.log(`Sending license request to URL: `+o);var c=this._generateLicenseRequestChallenge(n,e);s.send(c)}catch(e){a.logger.error(`Failure requesting DRM license: `+e),this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.KEY_SYSTEM_ERROR,details:i.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0})}},t.onMediaAttached=function(e,t){if(this._emeEnabled){var n=t.media;this._media=n,n.addEventListener(`encrypted`,this._onMediaEncrypted)}},t.onMediaDetached=function(){var e=this._media,t=this._mediaKeysList;e&&(e.removeEventListener(`encrypted`,this._onMediaEncrypted),this._media=null,this._mediaKeysList=[],Promise.all(t.map(function(e){if(e.mediaKeysSession)return e.mediaKeysSession.close().catch(function(){})})).then(function(){return e.setMediaKeys(null)}).catch(function(){}))},t.onManifestParsed=function(e,t){if(this._emeEnabled){var n=t.levels.map(function(e){return e.audioCodec}).filter(function(e){return!!e}),r=t.levels.map(function(e){return e.videoCodec}).filter(function(e){return!!e});this._attemptKeySystemAccess(o.KeySystems.WIDEVINE,n,r)}},c(e,[{key:`requestMediaKeySystemAccess`,get:function(){if(!this._requestMediaKeySystemAccess)throw Error(`No requestMediaKeySystemAccess function configured`);return this._requestMediaKeySystemAccess}}]),e}()}),"./src/controller/fps-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/events.ts`),i=n(`./src/utils/logger.ts`);t.default=function(){function e(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}var t=e.prototype;return t.setStreamController=function(e){this.streamController=e},t.registerListeners=function(){this.hls.on(r.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},t.unregisterListeners=function(){this.hls.off(r.Events.MEDIA_ATTACHING,this.onMediaAttaching)},t.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},t.onMediaAttaching=function(e,t){var n=this.hls.config;if(n.capLevelOnFPSDrop){var r=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=r,r&&typeof r.getVideoPlaybackQuality==`function`&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}},t.checkFPS=function(e,t,n){var a=performance.now();if(t){if(this.lastTime){var o=a-this.lastTime,s=n-this.lastDroppedFrames,c=t-this.lastDecodedFrames,l=1e3*s/o,u=this.hls;if(u.trigger(r.Events.FPS_DROP,{currentDropped:s,currentDecoded:c,totalDroppedFrames:n}),l>0&&s>u.config.fpsDroppedMonitoringThreshold*c){var d=u.currentLevel;i.logger.warn(`drop FPS ratio greater than max allowed value for currentLevel: `+d),d>0&&(u.autoLevelCapping===-1||u.autoLevelCapping>=d)&&(--d,u.trigger(r.Events.FPS_DROP_LEVEL_CAPPING,{level:d,droppedLevel:u.currentLevel}),u.autoLevelCapping=d,this.streamController.nextLevelSwitch())}}this.lastTime=a,this.lastDroppedFrames=n,this.lastDecodedFrames=t}},t.checkFPSInterval=function(){var e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){var t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)},e}()}),"./src/controller/fragment-finders.ts":(function(e,t,n){n.r(t),n.d(t,`findFragmentByPDT`,function(){return a}),n.d(t,`findFragmentByPTS`,function(){return o}),n.d(t,`fragmentWithinToleranceTest`,function(){return s}),n.d(t,`pdtWithinToleranceTest`,function(){return c}),n.d(t,`findFragWithCC`,function(){return l});var r=n(`./src/polyfills/number.ts`),i=n(`./src/utils/binary-search.ts`);function a(e,t,n){if(t===null||!Array.isArray(e)||!e.length||!(0,r.isFiniteNumber)(t)||t<(e[0].programDateTime||0)||t>=(e[e.length-1].endProgramDateTime||0))return null;n||=0;for(var i=0;i<e.length;++i){var a=e[i];if(c(t,n,a))return a}return null}function o(e,t,n,r){n===void 0&&(n=0),r===void 0&&(r=0);var a=null;return e?a=t[e.sn-t[0].sn+1]||null:n===0&&t[0].start===0&&(a=t[0]),a&&s(n,r,a)===0?a:i.default.search(t,s.bind(null,n,r))||a}function s(e,t,n){e===void 0&&(e=0),t===void 0&&(t=0);var r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-r<=e?1:n.start-r>e&&n.start?-1:0}function c(e,t,n){var r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0))*1e3;return(n.endProgramDateTime||0)-r>e}function l(e,t){return i.default.search(e,function(e){return e.cc<t?1:e.cc>t?-1:0})}}),"./src/controller/fragment-tracker.ts":(function(e,t,n){n.r(t),n.d(t,`FragmentState`,function(){return a}),n.d(t,`FragmentTracker`,function(){return o});var r=n(`./src/events.ts`),i=n(`./src/types/loader.ts`),a;(function(e){e.NOT_LOADED=`NOT_LOADED`,e.BACKTRACKED=`BACKTRACKED`,e.APPENDING=`APPENDING`,e.PARTIAL=`PARTIAL`,e.OK=`OK`})(a||={});var o=function(){function e(e){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=e,this._registerListeners()}var t=e.prototype;return t._registerListeners=function(){var e=this.hls;e.on(r.Events.BUFFER_APPENDED,this.onBufferAppended,this),e.on(r.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(r.Events.FRAG_LOADED,this.onFragLoaded,this)},t._unregisterListeners=function(){var e=this.hls;e.off(r.Events.BUFFER_APPENDED,this.onBufferAppended,this),e.off(r.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(r.Events.FRAG_LOADED,this.onFragLoaded,this)},t.destroy=function(){this._unregisterListeners(),this.fragments=this.timeRanges=null},t.getAppendedFrag=function(e,t){if(t===i.PlaylistLevelType.MAIN){var n=this.activeFragment,r=this.activeParts;if(!n)return null;if(r)for(var a=r.length;a--;){var o=r[a],s=o?o.end:n.appendedPTS;if(o.start<=e&&s!==void 0&&e<=s)return a>9&&(this.activeParts=r.slice(a-9)),o}else if(n.start<=e&&n.appendedPTS!==void 0&&e<=n.appendedPTS)return n}return this.getBufferedFrag(e,t)},t.getBufferedFrag=function(e,t){for(var n=this.fragments,r=Object.keys(n),i=r.length;i--;){var a=n[r[i]];if(a?.body.type===t&&a.buffered){var o=a.body;if(o.start<=e&&e<=o.end)return o}}return null},t.detectEvictedFragments=function(e,t,n){var r=this;Object.keys(this.fragments).forEach(function(i){var a=r.fragments[i];if(a){if(!a.buffered){a.body.type===n&&r.removeFragment(a.body);return}var o=a.range[e];o&&o.time.some(function(e){var n=!r.isTimeBuffered(e.startPTS,e.endPTS,t);return n&&r.removeFragment(a.body),n})}})},t.detectPartialFragments=function(e){var t=this,n=this.timeRanges,r=e.frag,i=e.part;if(!(!n||r.sn===`initSegment`)){var a=c(r),o=this.fragments[a];o&&(Object.keys(n).forEach(function(e){var a=r.elementaryStreams[e];if(a){var s=n[e],c=i!==null||a.partial===!0;o.range[e]=t.getBufferedTimes(r,i,c,s)}}),o.backtrack=o.loaded=null,Object.keys(o.range).length?o.buffered=!0:this.removeFragment(o.body))}},t.fragBuffered=function(e){var t=c(e),n=this.fragments[t];n&&(n.backtrack=n.loaded=null,n.buffered=!0)},t.getBufferedTimes=function(e,t,n,r){for(var i={time:[],partial:n},a=t?t.start:e.start,o=t?t.end:e.end,s=e.minEndPTS||o,c=e.maxStartPTS||a,l=0;l<r.length;l++){var u=r.start(l)-this.bufferPadding,d=r.end(l)+this.bufferPadding;if(c>=u&&s<=d){i.time.push({startPTS:Math.max(a,r.start(l)),endPTS:Math.min(o,r.end(l))});break}else if(a<d&&o>u)i.partial=!0,i.time.push({startPTS:Math.max(a,r.start(l)),endPTS:Math.min(o,r.end(l))});else if(o<=u)break}return i},t.getPartialFragment=function(e){var t=null,n,r,i,a=0,o=this.bufferPadding,c=this.fragments;return Object.keys(c).forEach(function(l){var u=c[l];u&&s(u)&&(r=u.body.start-o,i=u.body.end+o,e>=r&&e<=i&&(n=Math.min(e-r,i-e),a<=n&&(t=u.body,a=n)))}),t},t.getState=function(e){var t=c(e),n=this.fragments[t];return n?n.buffered?s(n)?a.PARTIAL:a.OK:n.backtrack?a.BACKTRACKED:a.APPENDING:a.NOT_LOADED},t.backtrack=function(e,t){var n=c(e),r=this.fragments[n];if(!r||r.backtrack)return null;var i=r.backtrack=t||r.loaded;return r.loaded=null,i},t.getBacktrackData=function(e){var t=c(e),n=this.fragments[t];if(n){var r,i=n.backtrack;if(i!=null&&(r=i.payload)!=null&&r.byteLength)return i;this.removeFragment(e)}return null},t.isTimeBuffered=function(e,t,n){for(var r,i,a=0;a<n.length;a++){if(r=n.start(a)-this.bufferPadding,i=n.end(a)+this.bufferPadding,e>=r&&t<=i)return!0;if(t<=r)return!1}return!1},t.onFragLoaded=function(e,t){var n=t.frag,r=t.part;if(!(n.sn===`initSegment`||n.bitrateTest||r)){var i=c(n);this.fragments[i]={body:n,loaded:t,backtrack:null,buffered:!1,range:Object.create(null)}}},t.onBufferAppended=function(e,t){var n=this,r=t.frag,a=t.part,o=t.timeRanges;if(r.type===i.PlaylistLevelType.MAIN)if(this.activeFragment=r,a){var s=this.activeParts;s||(this.activeParts=s=[]),s.push(a)}else this.activeParts=null;this.timeRanges=o,Object.keys(o).forEach(function(e){var t=o[e];if(n.detectEvictedFragments(e,t),!a)for(var i=0;i<t.length;i++)r.appendedPTS=Math.max(t.end(i),r.appendedPTS||0)})},t.onFragBuffered=function(e,t){this.detectPartialFragments(t)},t.hasFragment=function(e){var t=c(e);return!!this.fragments[t]},t.removeFragmentsInRange=function(e,t,n){var r=this;Object.keys(this.fragments).forEach(function(i){var a=r.fragments[i];if(a&&a.buffered){var o=a.body;o.type===n&&o.start<t&&o.end>e&&r.removeFragment(o)}})},t.removeFragment=function(e){var t=c(e);e.stats.loaded=0,e.clearElementaryStreamInfo(),delete this.fragments[t]},t.removeAllFragments=function(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null},e}();function s(e){return e.buffered&&(e.range.video?.partial||e.range.audio?.partial)}function c(e){return e.type+`_`+e.level+`_`+e.urlId+`_`+e.sn}}),"./src/controller/gap-controller.ts":(function(e,t,n){n.r(t),n.d(t,`STALL_MINIMUM_DURATION_MS`,function(){return s}),n.d(t,`MAX_START_GAP_JUMP`,function(){return c}),n.d(t,`SKIP_BUFFER_HOLE_STEP_SECONDS`,function(){return l}),n.d(t,`SKIP_BUFFER_RANGE_START`,function(){return u}),n.d(t,`default`,function(){return d});var r=n(`./src/utils/buffer-helper.ts`),i=n(`./src/errors.ts`),a=n(`./src/events.ts`),o=n(`./src/utils/logger.ts`),s=250,c=2,l=.1,u=.05,d=function(){function e(e,t,n,r){this.config=void 0,this.media=void 0,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=n,this.hls=r}var t=e.prototype;return t.destroy=function(){this.hls=this.fragmentTracker=this.media=null},t.poll=function(e){var t=this.config,n=this.media,i=this.stalled,a=n.currentTime,l=n.seeking,u=this.seeking&&!l,d=!this.seeking&&l;if(this.seeking=l,a!==e){if(this.moved=!0,i!==null){if(this.stallReported){var f=self.performance.now()-i;o.logger.warn(`playback not stuck anymore @`+a+`, after `+Math.round(f)+`ms`),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((d||u)&&(this.stalled=null),!(n.paused||n.ended||n.playbackRate===0||!r.BufferHelper.getBuffered(n).length)){var p=r.BufferHelper.bufferInfo(n,a,0),m=p.len>0,h=p.nextStart||0;if(!(!m&&!h)){if(l){var g=p.len>c,_=!h||h-a>c&&!this.fragmentTracker.getPartialFragment(a);if(g||_)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var v=Math.max(h,p.start||0)-a,y=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,b=y!=null&&y.details?.live?y.details.targetduration*2:c;if(v>0&&v<=b){this._trySkipBufferHole(null);return}}var x=self.performance.now();if(i===null){this.stalled=x;return}var S=x-i;!l&&S>=s&&this._reportStall(p.len);var C=r.BufferHelper.bufferInfo(n,a,t.maxBufferHole);this._tryFixBufferStall(C,S)}}},t._tryFixBufferStall=function(e,t){var n=this.config,r=this.fragmentTracker,i=this.media.currentTime,a=r.getPartialFragment(i);a&&this._trySkipBufferHole(a)||e.len>n.maxBufferHole&&t>n.highBufferWatchdogPeriod*1e3&&(o.logger.warn(`Trying to nudge playhead over buffer-hole`),this.stalled=null,this._tryNudgeBuffer())},t._reportStall=function(e){var t=this.hls,n=this.media;this.stallReported||(this.stallReported=!0,o.logger.warn(`Playback stalling at @`+n.currentTime+` due to low buffer (buffer=`+e+`)`),t.trigger(a.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:e}))},t._trySkipBufferHole=function(e){for(var t=this.config,n=this.hls,s=this.media,c=s.currentTime,d=0,f=r.BufferHelper.getBuffered(s),p=0;p<f.length;p++){var m=f.start(p);if(c+t.maxBufferHole>=d&&c<m){var h=Math.max(m+u,s.currentTime+l);return o.logger.warn(`skipping hole, adjusting currentTime from `+c+` to `+h),this.moved=!0,this.stalled=null,s.currentTime=h,e&&n.trigger(a.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:`fragment loaded with buffer holes, seeking from `+c+` to `+h,frag:e}),h}d=f.end(p)}return 0},t._tryNudgeBuffer=function(){var e=this.config,t=this.hls,n=this.media,r=n.currentTime,s=(this.nudgeRetry||0)+1;if(this.nudgeRetry=s,s<e.nudgeMaxRetry){var c=r+s*e.nudgeOffset;o.logger.warn(`Nudging 'currentTime' from `+r+` to `+c),n.currentTime=c,t.trigger(a.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else o.logger.error(`Playhead still not moving while enough data buffered @`+r+` after `+e.nudgeMaxRetry+` nudges`),t.trigger(a.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})},e}()}),"./src/controller/id3-track-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/events.ts`),i=n(`./src/utils/texttrack-utils.ts`),a=n(`./src/demux/id3.ts`),o=.25;t.default=function(){function e(e){this.hls=void 0,this.id3Track=null,this.media=null,this.hls=e,this._registerListeners()}var t=e.prototype;return t.destroy=function(){this._unregisterListeners()},t._registerListeners=function(){var e=this.hls;e.on(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(r.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},t._unregisterListeners=function(){var e=this.hls;e.off(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(r.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},t.onMediaAttached=function(e,t){this.media=t.media},t.onMediaDetaching=function(){this.id3Track&&((0,i.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null)},t.getID3Track=function(e){if(this.media){for(var t=0;t<e.length;t++){var n=e[t];if(n.kind===`metadata`&&n.label===`id3`)return(0,i.sendAddTrackEvent)(n,this.media),n}return this.media.addTextTrack(`metadata`,`id3`)}},t.onFragParsingMetadata=function(e,t){if(this.media){var n=t.frag,r=t.samples;this.id3Track||(this.id3Track=this.getID3Track(this.media.textTracks),this.id3Track.mode=`hidden`);for(var i=self.WebKitDataCue||self.VTTCue||self.TextTrackCue,s=0;s<r.length;s++){var c=a.getID3Frames(r[s].data);if(c){var l=r[s].pts,u=s<r.length-1?r[s+1].pts:n.end;u-l<=0&&(u=l+o);for(var d=0;d<c.length;d++){var f=c[d];if(!a.isTimeStampFrame(f)){var p=new i(l,u,``);p.value=f,this.id3Track.addCue(p)}}}}}},t.onBufferFlushing=function(e,t){var n=t.startOffset,r=t.endOffset,a=t.type;if(!a||a===`audio`){var o=this.id3Track;o&&(0,i.removeCuesInRange)(o,n,r)}},e}()}),"./src/controller/latency-controller.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return c});var r=n(`./src/errors.ts`),i=n(`./src/events.ts`),a=n(`./src/utils/logger.ts`);function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}var c=function(){function e(e){var t=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return t.timeupdate()},this.hls=e,this.config=e.config,this.registerListeners()}var t=e.prototype;return t.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},t.registerListeners=function(){this.hls.on(i.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(i.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(i.Events.ERROR,this.onError,this)},t.unregisterListeners=function(){this.hls.off(i.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(i.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(i.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(i.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(i.Events.ERROR,this.onError)},t.onMediaAttached=function(e,t){this.media=t.media,this.media.addEventListener(`timeupdate`,this.timeupdateHandler)},t.onMediaDetaching=function(){this.media&&=(this.media.removeEventListener(`timeupdate`,this.timeupdateHandler),null)},t.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},t.onLevelUpdated=function(e,t){var n=t.details;this.levelDetails=n,n.advanced&&this.timeupdate(),!n.live&&this.media&&this.media.removeEventListener(`timeupdate`,this.timeupdateHandler)},t.onError=function(e,t){t.details===r.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,a.logger.warn(`[playback-rate-controller]: Stall detected, adjusting target latency`))},t.timeupdate=function(){var e=this.media,t=this.levelDetails;if(!(!e||!t)){this.currentTime=e.currentTime;var n=this.computeLatency();if(n!==null){this._latency=n;var r=this.config,i=r.lowLatencyMode,a=r.maxLiveSyncPlaybackRate;if(!(!i||a===1)){var o=this.targetLatency;if(o!==null){var s=n-o,c=s<Math.min(this.maxLatency,o+t.targetduration);if(t.live&&c&&s>.05&&this.forwardBufferLength>1){var l=Math.min(2,Math.max(1,a)),u=Math.round(2/(1+Math.exp(-.75*s-this.edgeStalled))*20)/20;e.playbackRate=Math.min(l,Math.max(1,u))}else e.playbackRate!==1&&e.playbackRate!==0&&(e.playbackRate=1)}}}}},t.estimateLiveEdge=function(){var e=this.levelDetails;return e===null?null:e.edge+e.age},t.computeLatency=function(){var e=this.estimateLiveEdge();return e===null?null:e-this.currentTime},s(e,[{key:`latency`,get:function(){return this._latency||0}},{key:`maxLatency`,get:function(){var e=this.config,t=this.levelDetails;return e.liveMaxLatencyDuration===void 0?t?e.liveMaxLatencyDurationCount*t.targetduration:0:e.liveMaxLatencyDuration}},{key:`targetLatency`,get:function(){var e=this.levelDetails;if(e===null)return null;var t=e.holdBack,n=e.partHoldBack,r=e.targetduration,i=this.config,a=i.liveSyncDuration,o=i.liveSyncDurationCount,s=i.lowLatencyMode,c=this.hls.userConfig,l=s&&n||t;(c.liveSyncDuration||c.liveSyncDurationCount||l===0)&&(l=a===void 0?o*r:a);var u=r;return l+Math.min(this.stallCount*1,u)}},{key:`liveSyncPosition`,get:function(){var e=this.estimateLiveEdge(),t=this.targetLatency,n=this.levelDetails;if(e===null||t===null||n===null)return null;var r=n.edge,i=e-t-this.edgeStalled,a=r-n.totalduration,o=r-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(a,i),o)}},{key:`drift`,get:function(){var e=this.levelDetails;return e===null?1:e.drift}},{key:`edgeStalled`,get:function(){var e=this.levelDetails;if(e===null)return 0;var t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}},{key:`forwardBufferLength`,get:function(){var e=this.media,t=this.levelDetails;if(!e||!t)return 0;var n=e.buffered.length;return n?e.buffered.end(n-1):t.edge-this.currentTime}}]),e}()}),"./src/controller/level-controller.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return g});var r=n(`./src/types/level.ts`),i=n(`./src/events.ts`),a=n(`./src/errors.ts`),o=n(`./src/utils/codecs.ts`),s=n(`./src/controller/level-helper.ts`),c=n(`./src/controller/base-playlist-controller.ts`),l=n(`./src/types/loader.ts`);function u(){return u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u.apply(this,arguments)}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t&&d(e.prototype,t),n&&d(e,n),e}function p(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,m(e,t)}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}var h=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),g=function(e){p(t,e);function t(t){var n=e.call(this,t,`[level-controller]`)||this;return n._levels=[],n._firstLevel=-1,n._startLevel=void 0,n.currentLevelIndex=-1,n.manualLevelIndex=-1,n.onParsedComplete=void 0,n._registerListeners(),n}var n=t.prototype;return n._registerListeners=function(){var e=this.hls;e.on(i.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(i.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(i.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(i.Events.FRAG_LOADED,this.onFragLoaded,this),e.on(i.Events.ERROR,this.onError,this)},n._unregisterListeners=function(){var e=this.hls;e.off(i.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(i.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(i.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(i.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(i.Events.ERROR,this.onError,this)},n.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,e.prototype.destroy.call(this)},n.startLoad=function(){this._levels.forEach(function(e){e.loadError=0}),e.prototype.startLoad.call(this)},n.onManifestLoaded=function(e,t){var n=[],c=[],l=[],u,d={},f,p=!1,m=!1,g=!1;if(t.levels.forEach(function(e){var t=e.attrs;p||=!!(e.width&&e.height),m||=!!e.videoCodec,g||=!!e.audioCodec,h&&e.audioCodec&&e.audioCodec.indexOf(`mp4a.40.34`)!==-1&&(e.audioCodec=void 0);var i=e.bitrate+`-`+e.attrs.RESOLUTION+`-`+e.attrs.CODECS;f=d[i],f?f.url.push(e.url):(f=new r.Level(e),d[i]=f,n.push(f)),t&&(t.AUDIO&&(0,s.addGroupId)(f,`audio`,t.AUDIO),t.SUBTITLES&&(0,s.addGroupId)(f,`text`,t.SUBTITLES))}),(p||m)&&g&&(n=n.filter(function(e){var t=e.videoCodec,n=e.width,r=e.height;return!!t||!!(n&&r)})),n=n.filter(function(e){var t=e.audioCodec,n=e.videoCodec;return(!t||(0,o.isCodecSupportedInMp4)(t,`audio`))&&(!n||(0,o.isCodecSupportedInMp4)(n,`video`))}),t.audioTracks&&(c=t.audioTracks.filter(function(e){return!e.audioCodec||(0,o.isCodecSupportedInMp4)(e.audioCodec,`audio`)}),(0,s.assignTrackIdsByGroup)(c)),t.subtitles&&(l=t.subtitles,(0,s.assignTrackIdsByGroup)(l)),n.length>0){u=n[0].bitrate,n.sort(function(e,t){return e.bitrate-t.bitrate}),this._levels=n;for(var _=0;_<n.length;_++)if(n[_].bitrate===u){this._firstLevel=_,this.log(`manifest loaded, `+n.length+` level(s) found, first bitrate: `+u);break}var v=g&&!m,y={levels:n,audioTracks:c,subtitleTracks:l,firstLevel:this._firstLevel,stats:t.stats,audio:g,video:m,altAudio:!v&&c.some(function(e){return!!e.url})};this.hls.trigger(i.Events.MANIFEST_PARSED,y),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(i.Events.ERROR,{type:a.ErrorTypes.MEDIA_ERROR,details:a.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,reason:`no level with compatible codecs found in manifest`})},n.onError=function(t,n){if(e.prototype.onError.call(this,t,n),!n.fatal){var r=n.context,i=this._levels[this.currentLevelIndex];if(r&&(r.type===l.PlaylistContextType.AUDIO_TRACK&&i.audioGroupIds&&r.groupId===i.audioGroupIds[i.urlId]||r.type===l.PlaylistContextType.SUBTITLE_TRACK&&i.textGroupIds&&r.groupId===i.textGroupIds[i.urlId])){this.redundantFailover(this.currentLevelIndex);return}var o=!1,s=!0,c;switch(n.details){case a.ErrorDetails.FRAG_LOAD_ERROR:case a.ErrorDetails.FRAG_LOAD_TIMEOUT:case a.ErrorDetails.KEY_LOAD_ERROR:case a.ErrorDetails.KEY_LOAD_TIMEOUT:if(n.frag){var u=this._levels[n.frag.level];u?(u.fragmentError++,u.fragmentError>this.hls.config.fragLoadingMaxRetry&&(c=n.frag.level)):c=n.frag.level}break;case a.ErrorDetails.LEVEL_LOAD_ERROR:case a.ErrorDetails.LEVEL_LOAD_TIMEOUT:r&&(r.deliveryDirectives&&(s=!1),c=r.level),o=!0;break;case a.ErrorDetails.REMUX_ALLOC_ERROR:c=n.level,o=!0;break}c!==void 0&&this.recoverLevel(n,c,o,s)}},n.recoverLevel=function(e,t,n,r){var i=e.details,a=this._levels[t];if(a.loadError++,n)if(this.retryLoadingOrFail(e))e.levelRetry=!0;else{this.currentLevelIndex=-1;return}if(r){var o=a.url.length;if(o>1&&a.loadError<o)e.levelRetry=!0,this.redundantFailover(t);else if(this.manualLevelIndex===-1){var s=t===0?this._levels.length-1:t-1;this.currentLevelIndex!==s&&this._levels[s].loadError===0&&(this.warn(i+`: switch to `+s),e.levelRetry=!0,this.hls.nextAutoLevel=s)}}},n.redundantFailover=function(e){var t=this._levels[e],n=t.url.length;if(n>1){var r=(t.urlId+1)%n;this.warn(`Switching to redundant URL-id `+r),this._levels.forEach(function(e){e.urlId=r}),this.level=e}},n.onFragLoaded=function(e,t){var n=t.frag;if(n!==void 0&&n.type===l.PlaylistLevelType.MAIN){var r=this._levels[n.level];r!==void 0&&(r.fragmentError=0,r.loadError=0)}},n.onLevelLoaded=function(e,t){var n,r=t.level,i=t.details,a=this._levels[r];if(!a){var o;this.warn(`Invalid level index `+r),(o=t.deliveryDirectives)!=null&&o.skip&&(i.deltaUpdateFailed=!0);return}r===this.currentLevelIndex?(a.fragmentError===0&&(a.loadError=0,this.retryCount=0),this.playlistLoaded(r,t,a.details)):(n=t.deliveryDirectives)!=null&&n.skip&&(i.deltaUpdateFailed=!0)},n.onAudioTrackSwitched=function(e,t){var n=this.hls.levels[this.currentLevelIndex];if(n&&n.audioGroupIds){for(var r=-1,i=this.hls.audioTracks[t.id].groupId,a=0;a<n.audioGroupIds.length;a++)if(n.audioGroupIds[a]===i){r=a;break}r!==n.urlId&&(n.urlId=r,this.startLoad())}},n.loadPlaylist=function(e){var t=this.currentLevelIndex,n=this._levels[t];if(this.canLoad&&n&&n.url.length>0){var r=n.urlId,a=n.url[r];if(e)try{a=e.addDirectives(a)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: `+e)}this.log(`Attempt loading level index `+t+(e?` at sn `+e.msn+` part `+e.part:``)+` with URL-id `+r+` `+a),this.clearTimer(),this.hls.trigger(i.Events.LEVEL_LOADING,{url:a,level:t,id:r,deliveryDirectives:e||null})}},n.removeLevel=function(e,t){var n=function(e,n){return n!==t},r=this._levels.filter(function(r,i){return i===e?r.url.length>1&&t!==void 0?(r.url=r.url.filter(n),r.audioGroupIds&&=r.audioGroupIds.filter(n),r.textGroupIds&&=r.textGroupIds.filter(n),r.urlId=0,!0):!1:!0}).map(function(e,t){var n=e.details;return n!=null&&n.fragments&&n.fragments.forEach(function(e){e.level=t}),e});this._levels=r,this.hls.trigger(i.Events.LEVELS_UPDATED,{levels:r})},f(t,[{key:`levels`,get:function(){return this._levels.length===0?null:this._levels}},{key:`level`,get:function(){return this.currentLevelIndex},set:function(e){var t,n=this._levels;if(n.length!==0&&!(this.currentLevelIndex===e&&(t=n[e])!=null&&t.details)){if(e<0||e>=n.length){var r=e<0;if(this.hls.trigger(i.Events.ERROR,{type:a.ErrorTypes.OTHER_ERROR,details:a.ErrorDetails.LEVEL_SWITCH_ERROR,level:e,fatal:r,reason:`invalid level idx`}),r)return;e=Math.min(e,n.length-1)}this.clearTimer();var o=this.currentLevelIndex,s=n[o],c=n[e];this.log(`switching to level `+e+` from `+o),this.currentLevelIndex=e;var l=u({},c,{level:e,maxBitrate:c.maxBitrate,uri:c.uri,urlId:c.urlId});delete l._urlId,this.hls.trigger(i.Events.LEVEL_SWITCHING,l);var d=c.details;if(!d||d.live){var f=this.switchParams(c.uri,s?.details);this.loadPlaylist(f)}}}},{key:`manualLevel`,get:function(){return this.manualLevelIndex},set:function(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}},{key:`firstLevel`,get:function(){return this._firstLevel},set:function(e){this._firstLevel=e}},{key:`startLevel`,get:function(){if(this._startLevel===void 0){var e=this.hls.config.startLevel;return e===void 0?this._firstLevel:e}else return this._startLevel},set:function(e){this._startLevel=e}},{key:`nextLoadLevel`,get:function(){return this.manualLevelIndex===-1?this.hls.nextAutoLevel:this.manualLevelIndex},set:function(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}}]),t}(c.default)}),"./src/controller/level-helper.ts":(function(e,t,n){n.r(t),n.d(t,`addGroupId`,function(){return a}),n.d(t,`assignTrackIdsByGroup`,function(){return o}),n.d(t,`updatePTS`,function(){return s}),n.d(t,`updateFragPTSDTS`,function(){return l}),n.d(t,`mergeDetails`,function(){return u}),n.d(t,`mapPartIntersection`,function(){return d}),n.d(t,`mapFragmentIntersection`,function(){return f}),n.d(t,`adjustSliding`,function(){return p}),n.d(t,`addSliding`,function(){return m}),n.d(t,`computeReloadInterval`,function(){return h}),n.d(t,`getFragmentWithSN`,function(){return g}),n.d(t,`getPartWith`,function(){return _});var r=n(`./src/polyfills/number.ts`),i=n(`./src/utils/logger.ts`);function a(e,t,n){switch(t){case`audio`:e.audioGroupIds||=[],e.audioGroupIds.push(n);break;case`text`:e.textGroupIds||=[],e.textGroupIds.push(n);break}}function o(e){var t={};e.forEach(function(e){var n=e.groupId||``;e.id=t[n]=t[n]||0,t[n]++})}function s(e,t,n){var r=e[t],i=e[n];c(r,i)}function c(e,t){var n=t.startPTS;if((0,r.isFiniteNumber)(n)){var i=0,a;t.sn>e.sn?(i=n-e.start,a=e):(i=e.start-n,a=t),a.duration!==i&&(a.duration=i)}else t.sn>e.sn?e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration:t.start=Math.max(e.start-t.duration,0)}function l(e,t,n,a,o,s){a-n<=0&&(i.logger.warn(`Fragment should have a positive duration`,t),a=n+t.duration,s=o+t.duration);var l=n,u=a,d=t.startPTS,f=t.endPTS;if((0,r.isFiniteNumber)(d)){var p=Math.abs(d-n);(0,r.isFiniteNumber)(t.deltaPTS)?t.deltaPTS=Math.max(p,t.deltaPTS):t.deltaPTS=p,l=Math.max(n,d),n=Math.min(n,d),o=Math.min(o,t.startDTS),u=Math.min(a,f),a=Math.max(a,f),s=Math.max(s,t.endDTS)}t.duration=a-n;var m=n-t.start;t.appendedPTS=a,t.start=t.startPTS=n,t.maxStartPTS=l,t.startDTS=o,t.endPTS=a,t.minEndPTS=u,t.endDTS=s;var h=t.sn;if(!e||h<e.startSN||h>e.endSN)return 0;var g,_=h-e.startSN,v=e.fragments;for(v[_]=t,g=_;g>0;g--)c(v[g],v[g-1]);for(g=_;g<v.length-1;g++)c(v[g],v[g+1]);return e.fragmentHint&&c(v[v.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,m}function u(e,t){for(var n=null,a=e.fragments,o=a.length-1;o>=0;o--){var s=a[o].initSegment;if(s){n=s;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;var c=0,u;if(f(e,t,function(e,i){e.relurl&&(c=e.cc-i.cc),(0,r.isFiniteNumber)(e.startPTS)&&(0,r.isFiniteNumber)(e.endPTS)&&(i.start=i.startPTS=e.startPTS,i.startDTS=e.startDTS,i.appendedPTS=e.appendedPTS,i.maxStartPTS=e.maxStartPTS,i.endPTS=e.endPTS,i.endDTS=e.endDTS,i.minEndPTS=e.minEndPTS,i.duration=e.endPTS-e.startPTS,i.duration&&(u=i),t.PTSKnown=t.alignedSliding=!0),i.elementaryStreams=e.elementaryStreams,i.loader=e.loader,i.stats=e.stats,i.urlId=e.urlId,e.initSegment&&(i.initSegment=e.initSegment,n=e.initSegment)}),n&&(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach(function(e){(!e.initSegment||e.initSegment.relurl===n?.relurl)&&(e.initSegment=n)}),t.skippedSegments&&(t.deltaUpdateFailed=t.fragments.some(function(e){return!e}),t.deltaUpdateFailed)){i.logger.warn(`[level-helper] Previous playlist missing segments skipped in delta playlist`);for(var m=t.skippedSegments;m--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}var h=t.fragments;if(c){i.logger.warn(`discontinuity sliding from playlist, take drift into account`);for(var g=0;g<h.length;g++)h[g].cc+=c}t.skippedSegments&&(t.startCC=t.fragments[0].cc),d(e.partList,t.partList,function(e,t){t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),u?l(t,u,u.startPTS,u.endPTS,u.startDTS,u.endDTS):p(e,t),h.length&&(t.totalduration=t.edge-h[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;var _=t.advancedDateTime;if(t.advanced&&_){var v=t.edge;t.driftStart||=(t.driftStartTime=_,v),t.driftEndTime=_,t.driftEnd=v}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function d(e,t,n){if(e&&t)for(var r=0,i=0,a=e.length;i<=a;i++){var o=e[i],s=t[i+r];o&&s&&o.index===s.index&&o.fragment.sn===s.fragment.sn?n(o,s):r--}}function f(e,t,n){for(var r=t.skippedSegments,i=Math.max(e.startSN,t.startSN)-t.startSN,a=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,o=t.startSN-e.startSN,s=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,c=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=i;l<=a;l++){var u=c[o+l],d=s[l];r&&!d&&l<r&&(d=t.fragments[l]=u),u&&d&&n(u,d)}}function p(e,t){var n=t.startSN+t.skippedSegments-e.startSN,r=e.fragments;n<0||n>=r.length||m(t,r[n].start)}function m(e,t){if(t){for(var n=e.fragments,r=e.skippedSegments;r<n.length;r++)n[r].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function h(e,t){var n=1e3*e.levelTargetDuration,r=n/2,i=e.age,a=i>0&&i<n*3,o=t.loading.end-t.loading.start,s,c=e.availabilityDelay;if(e.updated===!1)if(a){var l=333*e.misses;s=Math.max(Math.min(r,o*2),l),e.availabilityDelay=(e.availabilityDelay||0)+s}else s=r;else a?(c=Math.min(c||n/2,i),e.availabilityDelay=c,s=c+n-i):s=n-o;return Math.round(s)}function g(e,t,n){if(!e||!e.details)return null;var r=e.details,i=r.fragments[t-r.startSN];return i||(i=r.fragmentHint,i&&i.sn===t)?i:t<r.startSN&&n&&n.sn===t?n:null}function _(e,t,n){if(!e||!e.details)return null;var r=e.details.partList;if(r)for(var i=r.length;i--;){var a=r[i];if(a.index===n&&a.fragment.sn===t)return a}return null}}),"./src/controller/stream-controller.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return x});var r=n(`./src/polyfills/number.ts`),i=n(`./src/controller/base-stream-controller.ts`),a=n(`./src/is-supported.ts`),o=n(`./src/events.ts`),s=n(`./src/utils/buffer-helper.ts`),c=n(`./src/controller/fragment-tracker.ts`),l=n(`./src/types/loader.ts`),u=n(`./src/loader/fragment.ts`),d=n(`./src/demux/transmuxer-interface.ts`),f=n(`./src/types/transmuxer.ts`),p=n(`./src/controller/gap-controller.ts`),m=n(`./src/errors.ts`),h=n(`./src/utils/logger.ts`);function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),e}function v(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,y(e,t)}function y(e,t){return y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},y(e,t)}var b=100,x=function(e){v(t,e);function t(t,n){var r=e.call(this,t,n,`[stream-controller]`)||this;return r.audioCodecSwap=!1,r.gapController=null,r.level=-1,r._forceStartLoad=!1,r.altAudio=!1,r.audioOnly=!1,r.fragPlaying=null,r.onvplaying=null,r.onvseeked=null,r.fragLastKbps=0,r.stalled=!1,r.couldBacktrack=!1,r.audioCodecSwitch=!1,r.videoBuffer=null,r._registerListeners(),r}var n=t.prototype;return n._registerListeners=function(){var e=this.hls;e.on(o.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(o.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(o.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(o.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(o.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(o.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(o.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(o.Events.ERROR,this.onError,this),e.on(o.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(o.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(o.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(o.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(o.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(o.Events.FRAG_BUFFERED,this.onFragBuffered,this)},n._unregisterListeners=function(){var e=this.hls;e.off(o.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(o.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(o.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(o.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(o.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(o.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(o.Events.ERROR,this.onError,this),e.off(o.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(o.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(o.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(o.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(o.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(o.Events.FRAG_BUFFERED,this.onFragBuffered,this)},n.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},n.startLoad=function(e){if(this.levels){var t=this.lastCurrentTime,n=this.hls;if(this.stopLoad(),this.setInterval(b),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var r=n.startLevel;r===-1&&(n.config.testBandwidth?(r=0,this.bitrateTest=!0):r=n.nextAutoLevel),this.level=n.nextLoadLevel=r,this.loadedmetadata=!1}t>0&&e===-1&&(this.log(`Override startPosition with lastCurrentTime @`+t.toFixed(3)),e=t),this.state=i.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=i.State.STOPPED},n.stopLoad=function(){this._forceStartLoad=!1,e.prototype.stopLoad.call(this)},n.doTick=function(){switch(this.state){case i.State.IDLE:this.doTickIdle();break;case i.State.WAITING_LEVEL:var e=this.levels,t=this.level,n=e?.[t]?.details;if(n&&(!n.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(n))break;this.state=i.State.IDLE;break}break;case i.State.FRAG_LOADING_WAITING_RETRY:var r,a=self.performance.now(),o=this.retryDate;(!o||a>=o||(r=this.media)!=null&&r.seeking)&&(this.log(`retryDate reached, switch back to IDLE state`),this.state=i.State.IDLE);break;default:break}this.onTickEnd()},n.onTickEnd=function(){e.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},n.doTickIdle=function(){var e,t=this.hls,n=this.levelLastLoaded,r=this.levels,a=this.media,s=t.config,d=t.nextLoadLevel;if(!(n===null||!a&&(this.startFragRequested||!s.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)&&!(!r||!r[d])){var f=r[d];this.level=t.nextLoadLevel=d;var p=f.details;if(!p||this.state===i.State.WAITING_LEVEL||p.live&&this.levelLastLoaded!==d){this.state=i.State.WAITING_LEVEL;return}var m=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:a,l.PlaylistLevelType.MAIN);if(m!==null&&!(m.len>=this.getMaxBufferLength(f.maxBitrate))){if(this._streamEnded(m,p)){var h={};this.altAudio&&(h.type=`video`),this.hls.trigger(o.Events.BUFFER_EOS,h),this.state=i.State.ENDED;return}var g=m.end,_=this.getNextFragment(g,p);if(this.couldBacktrack&&!this.fragPrevious&&_&&_.sn!==`initSegment`){var v=_.sn-p.startSN;v>1&&(_=p.fragments[v-1],this.fragmentTracker.removeFragment(_))}if(_&&this.fragmentTracker.getState(_)===c.FragmentState.OK&&this.nextLoadPosition>g){var y=this.audioOnly&&!this.altAudio?u.ElementaryStreamTypes.AUDIO:u.ElementaryStreamTypes.VIDEO;this.afterBufferFlushed(a,y,l.PlaylistLevelType.MAIN),_=this.getNextFragment(this.nextLoadPosition,p)}_&&(_.initSegment&&!_.initSegment.data&&!this.bitrateTest&&(_=_.initSegment),_.decryptdata?.keyFormat===`identity`&&!((e=_.decryptdata)!=null&&e.key)?this.loadKey(_,p):this.loadFragment(_,p,g))}}},n.loadFragment=function(t,n,r){var i=this.fragmentTracker.getState(t);if(this.fragCurrent=t,i===c.FragmentState.BACKTRACKED){var a=this.fragmentTracker.getBacktrackData(t);if(a){this._handleFragmentLoadProgress(a),this._handleFragmentLoadComplete(a);return}else i=c.FragmentState.NOT_LOADED}i===c.FragmentState.NOT_LOADED||i===c.FragmentState.PARTIAL?t.sn===`initSegment`?this._loadInitSegment(t):this.bitrateTest?(t.bitrateTest=!0,this.log(`Fragment `+t.sn+` of level `+t.level+` is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t)):(this.startFragRequested=!0,e.prototype.loadFragment.call(this,t,n,r)):i===c.FragmentState.APPENDING?this.reduceMaxBufferLength(t.duration)&&this.fragmentTracker.removeFragment(t):this.media?.buffered.length===0&&this.fragmentTracker.removeAllFragments()},n.getAppendedFrag=function(e){var t=this.fragmentTracker.getAppendedFrag(e,l.PlaylistLevelType.MAIN);return t&&`fragment`in t?t.fragment:t},n.getBufferedFrag=function(e){return this.fragmentTracker.getBufferedFrag(e,l.PlaylistLevelType.MAIN)},n.followingBufferedFrag=function(e){return e?this.getBufferedFrag(e.end+.5):null},n.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,1/0)},n.nextLevelSwitch=function(){var e=this.levels,t=this.media;if(t!=null&&t.readyState){var n,r=this.getAppendedFrag(t.currentTime);if(r&&r.start>1&&this.flushMainBuffer(0,r.start-1),!t.paused&&e){var i=e[this.hls.nextLoadLevel],a=this.fragLastKbps;n=a&&this.fragCurrent?this.fragCurrent.duration*i.maxBitrate/(1e3*a)+1:0}else n=0;var o=this.getBufferedFrag(t.currentTime+n);if(o){var s=this.followingBufferedFrag(o);if(s){this.abortCurrentFrag();var c=s.maxStartPTS?s.maxStartPTS:s.start,l=s.duration,u=Math.max(o.end,c+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*.5),l*.75));this.flushMainBuffer(u,1/0)}}}},n.abortCurrentFrag=function(){var e=this.fragCurrent;this.fragCurrent=null,e!=null&&e.loader&&e.loader.abort(),this.state===i.State.KEY_LOADING&&(this.state=i.State.IDLE),this.nextLoadPosition=this.getLoadPosition()},n.flushMainBuffer=function(t,n){e.prototype.flushMainBuffer.call(this,t,n,this.altAudio?`video`:null)},n.onMediaAttached=function(t,n){e.prototype.onMediaAttached.call(this,t,n);var r=n.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),r.addEventListener(`playing`,this.onvplaying),r.addEventListener(`seeked`,this.onvseeked),this.gapController=new p.default(this.config,r,this.fragmentTracker,this.hls)},n.onMediaDetaching=function(){var t=this.media;t&&(t.removeEventListener(`playing`,this.onvplaying),t.removeEventListener(`seeked`,this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&=(this.gapController.destroy(),null),e.prototype.onMediaDetaching.call(this)},n.onMediaPlaying=function(){this.tick()},n.onMediaSeeked=function(){var e=this.media,t=e?e.currentTime:null;(0,r.isFiniteNumber)(t)&&this.log(`Media seeked to `+t.toFixed(3)),this.tick()},n.onManifestLoading=function(){this.log(`Trigger BUFFER_RESET`),this.hls.trigger(o.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=this.stalled=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null},n.onManifestParsed=function(e,t){var n=!1,r=!1,i;t.levels.forEach(function(e){i=e.audioCodec,i&&(i.indexOf(`mp4a.40.2`)!==-1&&(n=!0),i.indexOf(`mp4a.40.5`)!==-1&&(r=!0))}),this.audioCodecSwitch=n&&r&&!(0,a.changeTypeSupported)(),this.audioCodecSwitch&&this.log(`Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC`),this.levels=t.levels,this.startFragRequested=!1},n.onLevelLoading=function(e,t){var n=this.levels;if(!(!n||this.state!==i.State.IDLE)){var r=n[t.level];(!r.details||r.details.live&&this.levelLastLoaded!==t.level||this.waitForCdnTuneIn(r.details))&&(this.state=i.State.WAITING_LEVEL)}},n.onLevelLoaded=function(e,t){var n,r=this.levels,a=t.level,s=t.details,c=s.totalduration;if(!r){this.warn(`Levels were reset while loading level `+a);return}this.log(`Level `+a+` loaded [`+s.startSN+`,`+s.endSN+`], cc [`+s.startCC+`, `+s.endCC+`] duration:`+c);var l=this.fragCurrent;l&&(this.state===i.State.FRAG_LOADING||this.state===i.State.FRAG_LOADING_WAITING_RETRY)&&l.level!==t.level&&l.loader&&(this.state=i.State.IDLE,l.loader.abort());var u=r[a],d=0;if(s.live||(n=u.details)!=null&&n.live){if(s.fragments[0]||(s.deltaUpdateFailed=!0),s.deltaUpdateFailed)return;d=this.alignPlaylists(s,u.details)}if(u.details=s,this.levelLastLoaded=a,this.hls.trigger(o.Events.LEVEL_UPDATED,{details:s,level:a}),this.state===i.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(s))return;this.state=i.State.IDLE}this.startFragRequested?s.live&&this.synchronizeToLiveEdge(s):this.setStartPosition(s,d),this.tick()},n._handleFragmentLoadProgress=function(e){var t=e.frag,n=e.part,r=e.payload,i=this.levels;if(!i){this.warn(`Levels were reset while fragment load was in progress. Fragment `+t.sn+` of level `+t.level+` will not be buffered`);return}var a=i[t.level],o=a.details;if(!o){this.warn(`Dropping fragment `+t.sn+` of level `+t.level+` after level details were reset`);return}var s=a.videoCodec,c=o.PTSKnown||!o.live,u=t.initSegment?.data,p=this._getAudioCodec(a),m=this.transmuxer=this.transmuxer||new d.default(this.hls,l.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),h=n?n.index:-1,g=h!==-1,_=new f.ChunkMetadata(t.level,t.sn,t.stats.chunkCount,r.byteLength,h,g),v=this.initPTS[t.cc];m.push(r,u,p,s,t,n,o.totalduration,c,_,v)},n.onAudioTrackSwitching=function(e,t){var n=this.altAudio,r=!!t.url,i=t.id;if(!r){if(this.mediaBuffer!==this.media){this.log(`Switching on main audio, use media.buffered to schedule main fragment loading`),this.mediaBuffer=this.media;var a=this.fragCurrent;a!=null&&a.loader&&(this.log(`Switching to main audio track, cancel main fragment load`),a.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var s=this.hls;n&&s.trigger(o.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:1/0,type:`audio`}),s.trigger(o.Events.AUDIO_TRACK_SWITCHED,{id:i})}},n.onAudioTrackSwitched=function(e,t){var n=t.id,r=!!this.hls.audioTracks[n].url;if(r){var i=this.videoBuffer;i&&this.mediaBuffer!==i&&(this.log(`Switching on alternate audio, use video.buffered to schedule main fragment loading`),this.mediaBuffer=i)}this.altAudio=r,this.tick()},n.onBufferCreated=function(e,t){var n=t.tracks,r,i,a=!1;for(var o in n){var s=n[o];if(s.id===`main`){if(i=o,r=s,o===`video`){var c=n[o];c&&(this.videoBuffer=c.buffer)}}else a=!0}a&&r?(this.log(`Alternate track found, use `+i+`.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media},n.onFragBuffered=function(e,t){var n=t.frag,r=t.part;if(!(n&&n.type!==l.PlaylistLevelType.MAIN)){if(this.fragContextChanged(n)){this.warn(`Fragment `+n.sn+(r?` p: `+r.index:``)+` of level `+n.level+` finished buffering, but was aborted. state: `+this.state),this.state===i.State.PARSED&&(this.state=i.State.IDLE);return}var a=r?r.stats:n.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),n.sn!==`initSegment`&&(this.fragPrevious=n),this.fragBufferedComplete(n,r)}},n.onError=function(e,t){switch(t.details){case m.ErrorDetails.FRAG_LOAD_ERROR:case m.ErrorDetails.FRAG_LOAD_TIMEOUT:case m.ErrorDetails.KEY_LOAD_ERROR:case m.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(l.PlaylistLevelType.MAIN,t);break;case m.ErrorDetails.LEVEL_LOAD_ERROR:case m.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==i.State.ERROR&&(t.fatal?(this.warn(``+t.details),this.state=i.State.ERROR):!t.levelRetry&&this.state===i.State.WAITING_LEVEL&&(this.state=i.State.IDLE));break;case m.ErrorDetails.BUFFER_FULL_ERROR:if(t.parent===`main`&&(this.state===i.State.PARSING||this.state===i.State.PARSED)){var n=!0,r=this.getFwdBufferInfo(this.media,l.PlaylistLevelType.MAIN);r&&r.len>.5&&(n=!this.reduceMaxBufferLength(r.len)),n&&(this.warn(`buffer full error also media.currentTime is not buffered, flush main`),this.immediateLevelSwitch()),this.resetLoadingState()}break;default:break}},n.checkBuffer=function(){var e=this.media,t=this.gapController;if(!(!e||!t||!e.readyState)){var n=s.BufferHelper.getBuffered(e);!this.loadedmetadata&&n.length?(this.loadedmetadata=!0,this.seekToStartPos()):t.poll(this.lastCurrentTime),this.lastCurrentTime=e.currentTime}},n.onFragLoadEmergencyAborted=function(){this.state=i.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},n.onBufferFlushed=function(e,t){var n=t.type;if(n!==u.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var r=(n===u.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(r,n,l.PlaylistLevelType.MAIN)}},n.onLevelsUpdated=function(e,t){this.levels=t.levels},n.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},n.seekToStartPos=function(){var e=this.media,t=e.currentTime,n=this.startPosition;if(n>=0&&t<n){if(e.seeking){h.logger.log(`could not seek to `+n+`, already seeking at `+t);return}var r=s.BufferHelper.getBuffered(e),i=(r.length?r.start(0):0)-n;i>0&&(i<this.config.maxBufferHole||i<this.config.maxFragLookUpTolerance)&&(h.logger.log(`adjusting start position by `+i+` to match buffer start`),n+=i,this.startPosition=n),this.log(`seek to target start position `+n+` from current time `+t),e.currentTime=n}},n._getAudioCodec=function(e){var t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log(`Swapping audio codec`),t=t.indexOf(`mp4a.40.5`)===-1?`mp4a.40.5`:`mp4a.40.2`),t},n._loadBitrateTestFrag=function(e){var t=this;this._doFragLoad(e).then(function(n){var r=t.hls;if(!(!n||r.nextLoadLevel||t.fragContextChanged(e))){t.fragLoadError=0,t.state=i.State.IDLE,t.startFragRequested=!1,t.bitrateTest=!1;var a=e.stats;a.parsing.start=a.parsing.end=a.buffering.start=a.buffering.end=self.performance.now(),r.trigger(o.Events.FRAG_LOADED,n)}})},n._handleTransmuxComplete=function(e){var t,n=`main`,a=this.hls,s=e.remuxResult,c=e.chunkMeta,l=this.getCurrentContext(c);if(!l){this.warn(`The loading context changed while buffering fragment `+c.sn+` of level `+c.level+`. This chunk will not be buffered.`),this.resetLiveStartWhenNotLoaded(c.level);return}var d=l.frag,f=l.part,p=l.level,m=s.video,h=s.text,g=s.id3,_=s.initSegment,v=this.altAudio?void 0:s.audio;if(!this.fragContextChanged(d)){if(this.state=i.State.PARSING,_){_.tracks&&(this._bufferInitSegment(p,_.tracks,d,c),a.trigger(o.Events.FRAG_PARSING_INIT_SEGMENT,{frag:d,id:n,tracks:_.tracks}));var y=_.initPTS,b=_.timescale;(0,r.isFiniteNumber)(y)&&(this.initPTS[d.cc]=y,a.trigger(o.Events.INIT_PTS_FOUND,{frag:d,id:n,initPTS:y,timescale:b}))}if(m&&s.independent!==!1){if(p.details){var x=m.startPTS,S=m.endPTS,C=m.startDTS,w=m.endDTS;if(f)f.elementaryStreams[m.type]={startPTS:x,endPTS:S,startDTS:C,endDTS:w};else if(m.firstKeyFrame&&m.independent&&(this.couldBacktrack=!0),m.dropped&&m.independent){if(this.getLoadPosition()+this.config.maxBufferHole<x){this.backtrack(d);return}d.setElementaryStreamInfo(m.type,d.start,S,d.start,w,!0)}d.setElementaryStreamInfo(m.type,x,S,C,w),this.bufferFragmentData(m,d,f,c)}}else if(s.independent===!1){this.backtrack(d);return}if(v){var T=v.startPTS,E=v.endPTS,D=v.startDTS,O=v.endDTS;f&&(f.elementaryStreams[u.ElementaryStreamTypes.AUDIO]={startPTS:T,endPTS:E,startDTS:D,endDTS:O}),d.setElementaryStreamInfo(u.ElementaryStreamTypes.AUDIO,T,E,D,O),this.bufferFragmentData(v,d,f,c)}if(g!=null&&(t=g.samples)!=null&&t.length){var k={frag:d,id:n,samples:g.samples};a.trigger(o.Events.FRAG_PARSING_METADATA,k)}if(h){var A={frag:d,id:n,samples:h.samples};a.trigger(o.Events.FRAG_PARSING_USERDATA,A)}}},n._bufferInitSegment=function(e,t,n,r){var a=this;if(this.state===i.State.PARSING){this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;var s=t.audio,c=t.video,l=t.audiovideo;if(s){var u=e.audioCodec,d=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(u&&=u.indexOf(`mp4a.40.5`)===-1?`mp4a.40.5`:`mp4a.40.2`,s.metadata.channelCount!==1&&d.indexOf(`firefox`)===-1&&(u=`mp4a.40.5`)),d.indexOf(`android`)!==-1&&s.container!==`audio/mpeg`&&(u=`mp4a.40.2`,this.log(`Android: force audio codec to `+u)),e.audioCodec&&e.audioCodec!==u&&this.log(`Swapping manifest audio codec "`+e.audioCodec+`" for "`+u+`"`),s.levelCodec=u,s.id=`main`,this.log(`Init audio buffer, container:`+s.container+`, codecs[selected/level/parsed]=[`+(u||``)+`/`+(e.audioCodec||``)+`/`+s.codec+`]`)}c&&(c.levelCodec=e.videoCodec,c.id=`main`,this.log(`Init video buffer, container:`+c.container+`, codecs[level/parsed]=[`+(e.videoCodec||``)+`/`+c.codec+`]`)),l&&this.log(`Init audiovideo buffer, container:`+l.container+`, codecs[level/parsed]=[`+(e.attrs.CODECS||``)+`/`+l.codec+`]`),this.hls.trigger(o.Events.BUFFER_CODECS,t),Object.keys(t).forEach(function(e){var i=t[e].initSegment;i!=null&&i.byteLength&&a.hls.trigger(o.Events.BUFFER_APPENDING,{type:e,data:i,frag:n,part:null,chunkMeta:r,parent:n.type})}),this.tick()}},n.backtrack=function(e){this.couldBacktrack=!0,this.resetTransmuxer(),this.flushBufferGap(e);var t=this.fragmentTracker.backtrack(e);this.fragPrevious=null,this.nextLoadPosition=e.start,t?this.resetFragmentLoading(e):this.state=i.State.BACKTRACKING},n.checkFragmentChanged=function(){var e=this.media,t=null;if(e&&e.readyState>1&&e.seeking===!1){var n=e.currentTime;if(s.BufferHelper.isBuffered(e,n)?t=this.getAppendedFrag(n):s.BufferHelper.isBuffered(e,n+.1)&&(t=this.getAppendedFrag(n+.1)),t){var r=this.fragPlaying,i=t.level;(!r||t.sn!==r.sn||r.level!==i||t.urlId!==r.urlId)&&(this.hls.trigger(o.Events.FRAG_CHANGED,{frag:t}),(!r||r.level!==i)&&this.hls.trigger(o.Events.LEVEL_SWITCHED,{level:i}),this.fragPlaying=t)}}},_(t,[{key:`nextLevel`,get:function(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:`currentLevel`,get:function(){var e=this.media;if(e){var t=this.getAppendedFrag(e.currentTime);if(t)return t.level}return-1}},{key:`nextBufferedFrag`,get:function(){var e=this.media;if(e){var t=this.getAppendedFrag(e.currentTime);return this.followingBufferedFrag(t)}else return null}},{key:`forceStartLoad`,get:function(){return this._forceStartLoad}}]),t}(i.default)}),"./src/controller/subtitle-stream-controller.ts":(function(e,t,n){n.r(t),n.d(t,`SubtitleStreamController`,function(){return v});var r=n(`./src/events.ts`),i=n(`./src/utils/logger.ts`),a=n(`./src/utils/buffer-helper.ts`),o=n(`./src/controller/fragment-finders.ts`),s=n(`./src/utils/discontinuities.ts`),c=n(`./src/controller/level-helper.ts`),l=n(`./src/controller/fragment-tracker.ts`),u=n(`./src/controller/base-stream-controller.ts`),d=n(`./src/types/loader.ts`),f=n(`./src/types/level.ts`);function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e}function h(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,g(e,t)}function g(e,t){return g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},g(e,t)}var _=500,v=function(e){h(t,e);function t(t,n){var r=e.call(this,t,n,`[subtitle-stream-controller]`)||this;return r.levels=[],r.currentTrackId=-1,r.tracksBuffered=[],r.mainDetails=null,r._registerListeners(),r}var n=t.prototype;return n.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},n._registerListeners=function(){var e=this.hls;e.on(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(r.Events.ERROR,this.onError,this),e.on(r.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(r.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(r.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(r.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(r.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},n._unregisterListeners=function(){var e=this.hls;e.off(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(r.Events.ERROR,this.onError,this),e.off(r.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(r.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(r.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(r.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(r.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},n.startLoad=function(){this.stopLoad(),this.state=u.State.IDLE,this.setInterval(_),this.tick()},n.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},n.onLevelLoaded=function(e,t){this.mainDetails=t.details},n.onSubtitleFragProcessed=function(e,t){var n=t.frag,r=t.success;if(this.fragPrevious=n,this.state=u.State.IDLE,r){var i=this.tracksBuffered[this.currentTrackId];if(i){for(var a,o=n.start,s=0;s<i.length;s++)if(o>=i[s].start&&o<=i[s].end){a=i[s];break}var c=n.start+n.duration;a?a.end=c:(a={start:o,end:c},i.push(a)),this.fragmentTracker.fragBuffered(n)}}},n.onBufferFlushing=function(e,t){var n=t.startOffset,r=t.endOffset;if(n===0&&r!==1/0){var i=this.currentTrackId,a=this.levels;if(!a.length||!a[i]||!a[i].details)return;var o=r-a[i].details.targetduration;if(o<=0)return;t.endOffsetSubtitles=Math.max(0,o),this.tracksBuffered.forEach(function(e){for(var t=0;t<e.length;){if(e[t].end<=o){e.shift();continue}else if(e[t].start<o)e[t].start=o;else break;t++}}),this.fragmentTracker.removeFragmentsInRange(n,o,d.PlaylistLevelType.SUBTITLE)}},n.onError=function(e,t){var n,r=t.frag;!r||r.type!==d.PlaylistLevelType.SUBTITLE||((n=this.fragCurrent)!=null&&n.loader&&this.fragCurrent.loader.abort(),this.state=u.State.IDLE)},n.onSubtitleTracksUpdated=function(e,t){var n=this,r=t.subtitleTracks;this.tracksBuffered=[],this.levels=r.map(function(e){return new f.Level(e)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(e){n.tracksBuffered[e.id]=[]}),this.mediaBuffer=null},n.onSubtitleTrackSwitch=function(e,t){if(this.currentTrackId=t.id,!this.levels.length||this.currentTrackId===-1){this.clearInterval();return}var n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.setInterval(_)},n.onSubtitleTrackLoaded=function(e,t){var n,r=t.details,i=t.id,a=this.currentTrackId,l=this.levels;if(l.length){var d=l[a];if(!(i>=l.length||i!==a||!d)){if(this.mediaBuffer=this.mediaBufferTimeRanges,r.live||(n=d.details)!=null&&n.live){var f=this.mainDetails;if(r.deltaUpdateFailed||!f)return;var p=f.fragments[0];d.details?this.alignPlaylists(r,d.details)===0&&p&&(0,c.addSliding)(r,p.start):r.hasProgramDateTime&&f.hasProgramDateTime?(0,s.alignMediaPlaylistByPDT)(r,f):p&&(0,c.addSliding)(r,p.start)}d.details=r,this.levelLastLoaded=i,this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===u.State.IDLE&&((0,o.findFragmentByPTS)(null,r.fragments,this.media.currentTime,0)||(this.warn(`Subtitle playlist not aligned with playback`),d.details=void 0))}}},n._handleFragmentLoadComplete=function(e){var t=e.frag,n=e.payload,i=t.decryptdata,a=this.hls;if(!this.fragContextChanged(t)&&n&&n.byteLength>0&&i&&i.key&&i.iv&&i.method===`AES-128`){var o=performance.now();this.decrypter.webCryptoDecrypt(new Uint8Array(n),i.key.buffer,i.iv.buffer).then(function(e){var n=performance.now();a.trigger(r.Events.FRAG_DECRYPTED,{frag:t,payload:e,stats:{tstart:o,tdecrypt:n}})})}},n.doTick=function(){if(!this.media){this.state=u.State.IDLE;return}if(this.state===u.State.IDLE){var e,t=this.currentTrackId,n=this.levels;if(!n.length||!n[t]||!n[t].details)return;var s=n[t].details,c=s.targetduration,d=this.config,f=this.media,p=a.BufferHelper.bufferedInfo(this.mediaBufferTimeRanges,f.currentTime-c,d.maxBufferHole),m=p.end;if(p.len>this.getMaxBufferLength()+c)return;console.assert(s,`Subtitle track details are defined on idle subtitle stream controller tick`);var h=s.fragments,g=h.length,_=s.edge,v,y=this.fragPrevious;if(m<_){var b=d.maxFragLookUpTolerance;v=(0,o.findFragmentByPTS)(y,h,m,b),!v&&y&&y.start<h[0].start&&(v=h[0])}else v=h[g-1];(e=v)!=null&&e.encrypted?(i.logger.log(`Loading key for `+v.sn),this.state=u.State.KEY_LOADING,this.hls.trigger(r.Events.KEY_LOADING,{frag:v})):v&&this.fragmentTracker.getState(v)===l.FragmentState.NOT_LOADED&&this.loadFragment(v,s,m)}},n.loadFragment=function(t,n,r){this.fragCurrent=t,e.prototype.loadFragment.call(this,t,n,r)},m(t,[{key:`mediaBufferTimeRanges`,get:function(){return this.tracksBuffered[this.currentTrackId]||[]}}]),t}(u.default)}),"./src/controller/subtitle-track-controller.ts":(function(e,t,n){n.r(t);var r=n(`./src/events.ts`),i=n(`./src/utils/texttrack-utils.ts`),a=n(`./src/controller/base-playlist-controller.ts`),o=n(`./src/types/loader.ts`);function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,u(e,t)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}var d=function(e){l(t,e);function t(t){var n=e.call(this,t,`[subtitle-track-controller]`)||this;return n.media=null,n.tracks=[],n.groupId=null,n.tracksInGroup=[],n.trackId=-1,n.selectDefaultTrack=!0,n.queuedDefaultTrack=-1,n.trackChangeListener=function(){return n.onTextTracksChanged()},n.asyncPollTrackChange=function(){return n.pollTrackChange(0)},n.useTextTrackPolling=!1,n.subtitlePollingInterval=-1,n.subtitleDisplay=!0,n.registerListeners(),n}var n=t.prototype;return n.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,e.prototype.destroy.call(this)},n.registerListeners=function(){var e=this.hls;e.on(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(r.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(r.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(r.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(r.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(r.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(r.Events.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e.off(r.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(r.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(r.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(r.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(r.Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(r.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(r.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(r.Events.ERROR,this.onError,this)},n.onMediaAttached=function(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&`onchange`in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener(`change`,this.asyncPollTrackChange))},n.pollTrackChange=function(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,e)},n.onMediaDetaching=function(){this.media&&=(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener(`change`,this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),f(this.media.textTracks).forEach(function(e){(0,i.clearCurrentCues)(e)}),this.subtitleTrack=-1,null)},n.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},n.onManifestParsed=function(e,t){this.tracks=t.subtitleTracks},n.onSubtitleTrackLoaded=function(e,t){var n=t.id,r=t.details,i=this.trackId,a=this.tracksInGroup[i];if(!a){this.warn(`Invalid subtitle track id `+n);return}var o=a.details;a.details=t.details,this.log(`subtitle track `+n+` loaded [`+r.startSN+`-`+r.endSN+`]`),n===this.trackId&&(this.retryCount=0,this.playlistLoaded(n,t,o))},n.onLevelLoading=function(e,t){this.switchLevel(t.level)},n.onLevelSwitching=function(e,t){this.switchLevel(t.level)},n.switchLevel=function(e){var t=this.hls.levels[e];if(t!=null&&t.textGroupIds){var n=t.textGroupIds[t.urlId];if(this.groupId!==n){var i=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,a=this.tracks.filter(function(e){return!n||e.groupId===n});this.tracksInGroup=a;var o=this.findTrackId(i?.name)||this.findTrackId();this.groupId=n;var s={subtitleTracks:a};this.log(`Updating subtitle tracks, `+a.length+` track(s) found in "`+n+`" group-id`),this.hls.trigger(r.Events.SUBTITLE_TRACKS_UPDATED,s),o!==-1&&this.setSubtitleTrack(o,i)}}},n.findTrackId=function(e){for(var t=this.tracksInGroup,n=0;n<t.length;n++){var r=t[n];if((!this.selectDefaultTrack||r.default)&&(!e||e===r.name))return r.id}return-1},n.onError=function(t,n){e.prototype.onError.call(this,t,n),!(n.fatal||!n.context)&&n.context.type===o.PlaylistContextType.SUBTITLE_TRACK&&n.context.id===this.trackId&&n.context.groupId===this.groupId&&this.retryLoadingOrFail(n)},n.loadPlaylist=function(e){var t=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(t)){var n=t.id,i=t.groupId,a=t.url;if(e)try{a=e.addDirectives(a)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: `+e)}this.log(`Loading subtitle playlist for id `+n),this.hls.trigger(r.Events.SUBTITLE_TRACK_LOADING,{url:a,id:n,groupId:i,deliveryDirectives:e||null})}},n.toggleTrackModes=function(e){var t=this,n=this.media,r=this.subtitleDisplay,i=this.trackId;if(n){var a=f(n.textTracks),o=a.filter(function(e){return e.groupId===t.groupId});if(e===-1)[].slice.call(a).forEach(function(e){e.mode=`disabled`});else{var s=o[i];s&&(s.mode=`disabled`)}var c=o[e];c&&(c.mode=r?`showing`:`hidden`)}},n.setSubtitleTrack=function(e,t){var n,i=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(this.trackId!==e&&this.toggleTrackModes(e),!(this.trackId===e&&(e===-1||(n=i[e])!=null&&n.details)||e<-1||e>=i.length)){this.clearTimer();var a=i[e];if(this.log(`Switching to subtitle track `+e),this.trackId=e,a){var o=a.id,s=a.groupId,c=s===void 0?``:s,l=a.name,u=a.type,d=a.url;this.hls.trigger(r.Events.SUBTITLE_TRACK_SWITCH,{id:o,groupId:c,name:l,type:u,url:d});var f=this.switchParams(a.url,t?.details);this.loadPlaylist(f)}else this.hls.trigger(r.Events.SUBTITLE_TRACK_SWITCH,{id:e})}},n.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!(!this.media||!this.hls.config.renderTextTracksNatively)){for(var e=-1,t=f(this.media.textTracks),n=0;n<t.length;n++)if(t[n].mode===`hidden`)e=n;else if(t[n].mode===`showing`){e=n;break}this.subtitleTrack!==e&&(this.subtitleTrack=e)}},c(t,[{key:`subtitleTracks`,get:function(){return this.tracksInGroup}},{key:`subtitleTrack`,get:function(){return this.trackId},set:function(e){this.selectDefaultTrack=!1;var t=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(e,t)}}]),t}(a.default);function f(e){for(var t=[],n=0;n<e.length;n++){var r=e[n];r.kind===`subtitles`&&r.label&&t.push(e[n])}return t}t.default=d}),"./src/controller/timeline-controller.ts":(function(e,t,n){n.r(t),n.d(t,`TimelineController`,function(){return f});var r=n(`./src/polyfills/number.ts`),i=n(`./src/events.ts`),a=n(`./src/utils/cea-608-parser.ts`),o=n(`./src/utils/output-filter.ts`),s=n(`./src/utils/webvtt-parser.ts`),c=n(`./src/utils/texttrack-utils.ts`),l=n(`./src/utils/imsc1-ttml-parser.ts`),u=n(`./src/types/loader.ts`),d=n(`./src/utils/logger.ts`),f=function(){function e(e){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=h(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var t=new o.default(this,`textTrack1`),n=new o.default(this,`textTrack2`),r=new o.default(this,`textTrack3`),s=new o.default(this,`textTrack4`);this.cea608Parser1=new a.default(1,t,n),this.cea608Parser2=new a.default(3,r,s)}e.on(i.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(i.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(i.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(i.Events.FRAG_LOADING,this.onFragLoading,this),e.on(i.Events.FRAG_LOADED,this.onFragLoaded,this),e.on(i.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(i.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(i.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(i.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(i.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var t=e.prototype;return t.destroy=function(){var e=this.hls;e.off(i.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(i.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(i.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(i.Events.FRAG_LOADING,this.onFragLoading,this),e.off(i.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(i.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(i.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(i.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(i.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(i.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},t.addCues=function(e,t,n,r,a){for(var o=!1,s=a.length;s--;){var c=a[s],l=m(c[0],c[1],t,n);if(l>=0&&(c[0]=Math.min(c[0],t),c[1]=Math.max(c[1],n),o=!0,l/(n-t)>.5))return}if(o||a.push([t,n]),this.config.renderTextTracksNatively){var u=this.captionsTracks[e];this.Cues.newCue(u,t,n,r)}else{var d=this.Cues.newCue(null,t,n,r);this.hls.trigger(i.Events.CUES_PARSED,{type:`captions`,cues:d,track:e})}},t.onInitPtsFound=function(e,t){var n=this,r=t.frag,a=t.id,o=t.initPTS,s=t.timescale,c=this.unparsedVttFrags;a===`main`&&(this.initPTS[r.cc]=o,this.timescale[r.cc]=s),c.length&&(this.unparsedVttFrags=[],c.forEach(function(e){n.onFragLoaded(i.Events.FRAG_LOADED,e)}))},t.getExistingTrack=function(e){var t=this.media;if(t)for(var n=0;n<t.textTracks.length;n++){var r=t.textTracks[n];if(r[e])return r}return null},t.createCaptionsTrack=function(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)},t.createNativeTrack=function(e){if(!this.captionsTracks[e]){var t=this.captionsProperties,n=this.captionsTracks,r=this.media,i=t[e],a=i.label,o=i.languageCode,s=this.getExistingTrack(e);if(s)n[e]=s,(0,c.clearCurrentCues)(n[e]),(0,c.sendAddTrackEvent)(n[e],r);else{var l=this.createTextTrack(`captions`,a,o);l&&(l[e]=!0,n[e]=l)}}},t.createNonNativeTrack=function(e){if(!this.nonNativeCaptionsTracks[e]){var t=this.captionsProperties[e];if(t){var n={_id:e,label:t.label,kind:`captions`,default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(i.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}}},t.createTextTrack=function(e,t,n){var r=this.media;if(r)return r.addTextTrack(e,t,n)},t.onMediaAttaching=function(e,t){this.media=t.media,this._cleanTracks()},t.onMediaDetaching=function(){var e=this.captionsTracks;Object.keys(e).forEach(function(t){(0,c.clearCurrentCues)(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}},t.onManifestLoading=function(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=h(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},t._cleanTracks=function(){var e=this.media;if(e){var t=e.textTracks;if(t)for(var n=0;n<t.length;n++)(0,c.clearCurrentCues)(t[n])}},t.onSubtitleTracksUpdated=function(e,t){var n=this;this.textTracks=[];var r=t.subtitleTracks||[],a=r.some(function(e){return e.textCodec===l.IMSC1_CODEC});if(this.config.enableWebVTT||a&&this.config.enableIMSC1){var o=this.tracks&&r&&this.tracks.length===r.length;if(this.tracks=r||[],this.config.renderTextTracksNatively){var s=this.media?this.media.textTracks:[];this.tracks.forEach(function(e,t){var r;if(t<s.length){for(var i=null,a=0;a<s.length;a++)if(p(s[a],e)){i=s[a];break}i&&(r=i)}r?(0,c.clearCurrentCues)(r):(r=n.createTextTrack(`subtitles`,e.name,e.lang),r&&(r.mode=`disabled`)),r&&(r.groupId=e.groupId,n.textTracks.push(r))})}else if(!o&&this.tracks&&this.tracks.length){var u=this.tracks.map(function(e){return{label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}});this.hls.trigger(i.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:u})}}},t.onManifestLoaded=function(e,t){var n=this;this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(function(e){var t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(t){var r=`textTrack`+t[1],i=n.captionsProperties[r];i&&(i.label=e.name,e.lang&&(i.languageCode=e.lang),i.media=e)}})},t.onFragLoading=function(e,t){var n=this.cea608Parser1,r=this.cea608Parser2,i=this.lastSn,a=this.lastPartIndex;if(!(!this.enabled||!(n&&r))&&t.frag.type===u.PlaylistLevelType.MAIN){var o=t.frag.sn,s=t?.part?.index??-1;o===i+1||o===i&&s===a+1||(n.reset(),r.reset()),this.lastSn=o,this.lastPartIndex=s}},t.onFragLoaded=function(e,t){var n=t.frag,a=t.payload,o=this.initPTS,s=this.unparsedVttFrags;if(n.type===u.PlaylistLevelType.SUBTITLE)if(a.byteLength){if(!(0,r.isFiniteNumber)(o[n.cc])){s.push(t),o.length&&this.hls.trigger(i.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:Error(`Missing initial subtitle PTS`)});return}var c=n.decryptdata;if(c==null||c.key==null||c.method!==`AES-128`){var d=this.tracks[n.level],f=this.vttCCs;f[n.cc]||(f[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),d&&d.textCodec===l.IMSC1_CODEC?this._parseIMSC1(n,a):this._parseVTTs(n,a,f)}}else this.hls.trigger(i.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:Error(`Empty subtitle payload`)})},t._parseIMSC1=function(e,t){var n=this,r=this.hls;(0,l.parseIMSC1)(t,this.initPTS[e.cc],this.timescale[e.cc],function(t){n._appendCues(t,e.level),r.trigger(i.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(t){d.logger.log(`Failed to parse IMSC1: `+t),r.trigger(i.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})},t._parseVTTs=function(e,t,n){var r=this,a=this.hls;(0,s.parseWebVTT)(t,this.initPTS[e.cc],this.timescale[e.cc],n,e.cc,e.start,function(t){r._appendCues(t,e.level),a.trigger(i.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(n){r._fallbackToIMSC1(e,t),d.logger.log(`Failed to parse VTT cue: `+n),a.trigger(i.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})},t._fallbackToIMSC1=function(e,t){var n=this,r=this.tracks[e.level];r.textCodec||(0,l.parseIMSC1)(t,this.initPTS[e.cc],this.timescale[e.cc],function(){r.textCodec=l.IMSC1_CODEC,n._parseIMSC1(e,t)},function(){r.textCodec=`wvtt`})},t._appendCues=function(e,t){var n=this.hls;if(this.config.renderTextTracksNatively){var r=this.textTracks[t];if(r.mode===`disabled`)return;e.forEach(function(e){return(0,c.addCueToTrack)(r,e)})}else{var a=this.tracks[t].default?`default`:`subtitles`+t;n.trigger(i.Events.CUES_PARSED,{type:`subtitles`,cues:e,track:a})}},t.onFragDecrypted=function(e,t){var n=t.frag;if(n.type===u.PlaylistLevelType.SUBTITLE){if(!(0,r.isFiniteNumber)(this.initPTS[n.cc])){this.unparsedVttFrags.push(t);return}this.onFragLoaded(i.Events.FRAG_LOADED,t)}},t.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},t.onFragParsingUserdata=function(e,t){var n=this.cea608Parser1,r=this.cea608Parser2;if(!(!this.enabled||!(n&&r)))for(var i=0;i<t.samples.length;i++){var a=t.samples[i].bytes;if(a){var o=this.extractCea608Data(a);n.addData(t.samples[i].pts,o[0]),r.addData(t.samples[i].pts,o[1])}}},t.onBufferFlushing=function(e,t){var n=t.startOffset,r=t.endOffset,i=t.endOffsetSubtitles,a=t.type,o=this.media;if(!(!o||o.currentTime<r)){if(!a||a===`video`){var s=this.captionsTracks;Object.keys(s).forEach(function(e){return(0,c.removeCuesInRange)(s[e],n,r)})}if(this.config.renderTextTracksNatively&&n===0&&i!==void 0){var l=this.textTracks;Object.keys(l).forEach(function(e){return(0,c.removeCuesInRange)(l[e],n,i)})}}},t.extractCea608Data=function(e){for(var t=e[0]&31,n=2,r=[[],[]],i=0;i<t;i++){var a=e[n++],o=127&e[n++],s=127&e[n++],c=(4&a)!=0,l=3&a;o===0&&s===0||c&&(l===0||l===1)&&(r[l].push(o),r[l].push(s))}return r},e}();function p(e,t){return e&&e.label===t.name&&!(e.textTrack1||e.textTrack2)}function m(e,t,n,r){return Math.min(t,r)-Math.max(e,n)}function h(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}}}}),"./src/crypt/aes-crypto.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return r});var r=function(){function e(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}var t=e.prototype;return t.decrypt=function(e,t){return this.subtle.decrypt({name:`AES-CBC`,iv:this.aesIV},t,e)},e}()}),"./src/crypt/aes-decryptor.ts":(function(e,t,n){n.r(t),n.d(t,`removePadding`,function(){return i}),n.d(t,`default`,function(){return a});var r=n(`./src/utils/typed-array.ts`);function i(e){var t=e.byteLength,n=t&&new DataView(e.buffer).getUint8(t-1);return n?(0,r.sliceUint8)(e,0,t-n):e}var a=function(){function e(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array,this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var t=e.prototype;return t.uint8ArrayToUint32Array_=function(e){for(var t=new DataView(e),n=new Uint32Array(4),r=0;r<4;r++)n[r]=t.getUint32(r*4);return n},t.initTable=function(){var e=this.sBox,t=this.invSBox,n=this.subMix,r=n[0],i=n[1],a=n[2],o=n[3],s=this.invSubMix,c=s[0],l=s[1],u=s[2],d=s[3],f=new Uint32Array(256),p=0,m=0,h=0;for(h=0;h<256;h++)h<128?f[h]=h<<1:f[h]=h<<1^283;for(h=0;h<256;h++){var g=m^m<<1^m<<2^m<<3^m<<4;g=g>>>8^g&255^99,e[p]=g,t[g]=p;var _=f[p],v=f[_],y=f[v],b=f[g]*257^g*16843008;r[p]=b<<24|b>>>8,i[p]=b<<16|b>>>16,a[p]=b<<8|b>>>24,o[p]=b,b=y*16843009^v*65537^_*257^p*16843008,c[g]=b<<24|b>>>8,l[g]=b<<16|b>>>16,u[g]=b<<8|b>>>24,d[g]=b,p?(p=_^f[f[f[y^_]]],m^=f[f[m]]):p=m=1}},t.expandKey=function(e){for(var t=this.uint8ArrayToUint32Array_(e),n=!0,r=0;r<t.length&&n;)n=t[r]===this.key[r],r++;if(!n){this.key=t;var i=this.keySize=t.length;if(i!==4&&i!==6&&i!==8)throw Error(`Invalid aes key size=`+i);var a=this.ksRows=(i+6+1)*4,o,s,c=this.keySchedule=new Uint32Array(a),l=this.invKeySchedule=new Uint32Array(a),u=this.sBox,d=this.rcon,f=this.invSubMix,p=f[0],m=f[1],h=f[2],g=f[3],_,v;for(o=0;o<a;o++){if(o<i){_=c[o]=t[o];continue}v=_,o%i===0?(v=v<<8|v>>>24,v=u[v>>>24]<<24|u[v>>>16&255]<<16|u[v>>>8&255]<<8|u[v&255],v^=d[o/i|0]<<24):i>6&&o%i===4&&(v=u[v>>>24]<<24|u[v>>>16&255]<<16|u[v>>>8&255]<<8|u[v&255]),c[o]=_=(c[o-i]^v)>>>0}for(s=0;s<a;s++)o=a-s,v=s&3?c[o]:c[o-4],s<4||o<=4?l[s]=v:l[s]=p[u[v>>>24]]^m[u[v>>>16&255]]^h[u[v>>>8&255]]^g[u[v&255]],l[s]=l[s]>>>0}},t.networkToHostOrderSwap=function(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24},t.decrypt=function(e,t,n){for(var r=this.keySize+6,i=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,s=o[0],c=o[1],l=o[2],u=o[3],d=this.uint8ArrayToUint32Array_(n),f=d[0],p=d[1],m=d[2],h=d[3],g=new Int32Array(e),_=new Int32Array(g.length),v,y,b,x,S,C,w,T,E,D,O,k,A,j,M=this.networkToHostOrderSwap;t<g.length;){for(E=M(g[t]),D=M(g[t+1]),O=M(g[t+2]),k=M(g[t+3]),S=E^i[0],C=k^i[1],w=O^i[2],T=D^i[3],A=4,j=1;j<r;j++)v=s[S>>>24]^c[C>>16&255]^l[w>>8&255]^u[T&255]^i[A],y=s[C>>>24]^c[w>>16&255]^l[T>>8&255]^u[S&255]^i[A+1],b=s[w>>>24]^c[T>>16&255]^l[S>>8&255]^u[C&255]^i[A+2],x=s[T>>>24]^c[S>>16&255]^l[C>>8&255]^u[w&255]^i[A+3],S=v,C=y,w=b,T=x,A+=4;v=a[S>>>24]<<24^a[C>>16&255]<<16^a[w>>8&255]<<8^a[T&255]^i[A],y=a[C>>>24]<<24^a[w>>16&255]<<16^a[T>>8&255]<<8^a[S&255]^i[A+1],b=a[w>>>24]<<24^a[T>>16&255]<<16^a[S>>8&255]<<8^a[C&255]^i[A+2],x=a[T>>>24]<<24^a[S>>16&255]<<16^a[C>>8&255]<<8^a[w&255]^i[A+3],_[t]=M(v^f),_[t+1]=M(x^p),_[t+2]=M(b^m),_[t+3]=M(y^h),f=E,p=D,m=O,h=k,t+=4}return _.buffer},e}()}),"./src/crypt/decrypter.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return u});var r=n(`./src/crypt/aes-crypto.ts`),i=n(`./src/crypt/fast-aes-key.ts`),a=n(`./src/crypt/aes-decryptor.ts`),o=n(`./src/utils/logger.ts`),s=n(`./src/utils/mp4-tools.ts`),c=n(`./src/utils/typed-array.ts`),l=16,u=function(){function e(e,t,n){var r=(n===void 0?{}:n).removePKCS7Padding,i=r===void 0?!0:r;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=e,this.config=t,this.removePKCS7Padding=i,i)try{var a=self.crypto;a&&(this.subtle=a.subtle||a.webkitSubtle)}catch{}this.subtle===null&&(this.config.enableSoftwareAES=!0)}var t=e.prototype;return t.destroy=function(){this.observer=null},t.isSync=function(){return this.config.enableSoftwareAES},t.flush=function(){var e=this.currentResult;if(!e){this.reset();return}var t=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?(0,a.removePadding)(t):t},t.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&=null},t.decrypt=function(e,t,n,r){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(e),t,n);var i=this.flush();i&&r(i.buffer)}else this.webCryptoDecrypt(new Uint8Array(e),t,n).then(r)},t.softwareDecrypt=function(e,t,n){var r=this.currentIV,i=this.currentResult,o=this.remainderData;this.logOnce(`JS AES decrypt`),o&&(e=(0,s.appendUint8Array)(o,e),this.remainderData=null);var l=this.getValidChunk(e);if(!l.length)return null;r&&(n=r);var u=this.softwareDecrypter;u||=this.softwareDecrypter=new a.default,u.expandKey(t);var d=i;return this.currentResult=u.decrypt(l.buffer,0,n),this.currentIV=(0,c.sliceUint8)(l,-16).buffer,d||null},t.webCryptoDecrypt=function(e,t,n){var a=this,o=this.subtle;return(this.key!==t||!this.fastAesKey)&&(this.key=t,this.fastAesKey=new i.default(o,t)),this.fastAesKey.expandKey().then(function(t){return o?new r.default(o,n).decrypt(e.buffer,t):Promise.reject(Error(`web crypto not initialized`))}).catch(function(r){return a.onWebCryptoError(r,e,t,n)})},t.onWebCryptoError=function(e,t,n,r){return o.logger.warn(`[decrypter.ts]: WebCrypto Error, disable WebCrypto API:`,e),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(t,n,r)},t.getValidChunk=function(e){var t=e,n=e.length-e.length%l;return n!==e.length&&(t=(0,c.sliceUint8)(e,0,n),this.remainderData=(0,c.sliceUint8)(e,n)),t},t.logOnce=function(e){this.logEnabled&&=(o.logger.log(`[decrypter.ts]: `+e),!1)},e}()}),"./src/crypt/fast-aes-key.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return r});var r=function(){function e(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}var t=e.prototype;return t.expandKey=function(){return this.subtle.importKey(`raw`,this.key,{name:`AES-CBC`},!1,[`encrypt`,`decrypt`])},e}()}),"./src/demux/aacdemuxer.ts":(function(e,t,n){n.r(t);var r=n(`./src/demux/base-audio-demuxer.ts`),i=n(`./src/demux/adts.ts`),a=n(`./src/utils/logger.ts`),o=n(`./src/demux/id3.ts`);function s(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,c(e,t)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}var l=function(e){s(t,e);function t(t,n){var r=e.call(this)||this;return r.observer=void 0,r.config=void 0,r.observer=t,r.config=n,r}var n=t.prototype;return n.resetInitSegment=function(t,n,r){e.prototype.resetInitSegment.call(this,t,n,r),this._audioTrack={container:`audio/adts`,type:`audio`,id:2,pid:-1,sequenceNumber:0,isAAC:!0,samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}},t.probe=function(e){if(!e)return!1;for(var t=(o.getID3Data(e,0)||[]).length,n=e.length;t<n;t++)if(i.probe(e,t))return a.logger.log(`ADTS sync word found !`),!0;return!1},n.canParse=function(e,t){return i.canParse(e,t)},n.appendFrame=function(e,t,n){i.initTrackConfig(e,this.observer,t,n,e.manifestCodec);var r=i.appendFrame(e,t,n,this.initPTS,this.frameIndex);if(r&&r.missing===0)return r},t}(r.default);l.minProbeByteLength=9,t.default=l}),"./src/demux/adts.ts":(function(e,t,n){n.r(t),n.d(t,`getAudioConfig`,function(){return o}),n.d(t,`isHeaderPattern`,function(){return s}),n.d(t,`getHeaderLength`,function(){return c}),n.d(t,`getFullFrameLength`,function(){return l}),n.d(t,`canGetFrameLength`,function(){return u}),n.d(t,`isHeader`,function(){return d}),n.d(t,`canParse`,function(){return f}),n.d(t,`probe`,function(){return p}),n.d(t,`initTrackConfig`,function(){return m}),n.d(t,`getFrameDuration`,function(){return h}),n.d(t,`parseFrameHeader`,function(){return g}),n.d(t,`appendFrame`,function(){return _});var r=n(`./src/utils/logger.ts`),i=n(`./src/errors.ts`),a=n(`./src/events.ts`);function o(e,t,n,o){var s,c,l,u,d=navigator.userAgent.toLowerCase(),f=o,p=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((t[n+2]&192)>>>6)+1;var m=(t[n+2]&60)>>>2;if(m>p.length-1){e.trigger(a.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:`+m});return}return l=(t[n+2]&1)<<2,l|=(t[n+3]&192)>>>6,r.logger.log(`manifest codec:`+o+`, ADTS type:`+s+`, samplingIndex:`+m),/firefox/i.test(d)?m>=6?(s=5,u=[,,,,],c=m-3):(s=2,u=[,,],c=m):d.indexOf(`android`)===-1?(s=5,u=[,,,,],o&&(o.indexOf(`mp4a.40.29`)!==-1||o.indexOf(`mp4a.40.5`)!==-1)||!o&&m>=6?c=m-3:((o&&o.indexOf(`mp4a.40.2`)!==-1&&(m>=6&&l===1||/vivaldi/i.test(d))||!o&&l===1)&&(s=2,u=[,,]),c=m)):(s=2,u=[,,],c=m),u[0]=s<<3,u[0]|=(m&14)>>1,u[1]|=(m&1)<<7,u[1]|=l<<3,s===5&&(u[1]|=(c&14)>>1,u[2]=(c&1)<<7,u[2]|=8,u[3]=0),{config:u,samplerate:p[m],channelCount:l,codec:`mp4a.40.`+s,manifestCodec:f}}function s(e,t){return e[t]===255&&(e[t+1]&246)==240}function c(e,t){return e[t+1]&1?7:9}function l(e,t){return(e[t+3]&3)<<11|e[t+4]<<3|(e[t+5]&224)>>>5}function u(e,t){return t+5<e.length}function d(e,t){return t+1<e.length&&s(e,t)}function f(e,t){return u(e,t)&&s(e,t)&&l(e,t)<=e.length-t}function p(e,t){if(d(e,t)){var n=c(e,t);if(t+n>=e.length)return!1;var r=l(e,t);if(r<=n)return!1;var i=t+r;return i===e.length||d(e,i)}return!1}function m(e,t,n,i,a){if(!e.samplerate){var s=o(t,n,i,a);if(!s)return;e.config=s.config,e.samplerate=s.samplerate,e.channelCount=s.channelCount,e.codec=s.codec,e.manifestCodec=s.manifestCodec,r.logger.log(`parsed codec:`+e.codec+`, rate:`+s.samplerate+`, channels:`+s.channelCount)}}function h(e){return 1024*9e4/e}function g(e,t,n,r,i){var a=c(e,t),o=l(e,t);if(o-=a,o>0){var s=n+r*i;return{headerLength:a,frameLength:o,stamp:s}}}function _(e,t,n,r,i){var a=g(t,n,r,i,h(e.samplerate));if(a){var o=a.frameLength,s=a.headerLength,c=a.stamp,l=s+o,u=Math.max(0,n+l-t.length),d;u?(d=new Uint8Array(l-s),d.set(t.subarray(n+s,t.length),0)):d=t.subarray(n+s,n+l);var f={unit:d,pts:c};return u||e.samples.push(f),{sample:f,length:l,missing:u}}}}),"./src/demux/base-audio-demuxer.ts":(function(e,t,n){n.r(t),n.d(t,`initPTSFn`,function(){return l});var r=n(`./src/polyfills/number.ts`),i=n(`./src/demux/id3.ts`),a=n(`./src/demux/dummy-demuxed-track.ts`),o=n(`./src/utils/mp4-tools.ts`),s=n(`./src/utils/typed-array.ts`),c=function(){function e(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.initPTS=null}var t=e.prototype;return t.resetInitSegment=function(e,t,n){this._id3Track={type:`id3`,id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},t.resetTimeStamp=function(){},t.resetContiguity=function(){},t.canParse=function(e,t){return!1},t.appendFrame=function(e,t,n){},t.demux=function(e,t){this.cachedData&&=(e=(0,o.appendUint8Array)(this.cachedData,e),null);var n=i.getID3Data(e,0),r=n?n.length:0,c,u,d=this._audioTrack,f=this._id3Track,p=n?i.getTimeStamp(n):void 0,m=e.length;for((this.frameIndex===0||this.initPTS===null)&&(this.initPTS=l(p,t)),n&&n.length>0&&f.samples.push({pts:this.initPTS,dts:this.initPTS,data:n}),u=this.initPTS;r<m;){if(this.canParse(e,r)){var h=this.appendFrame(d,e,r);h?(this.frameIndex++,u=h.sample.pts,r+=h.length,c=r):r=m}else i.canParse(e,r)?(n=i.getID3Data(e,r),f.samples.push({pts:u,dts:u,data:n}),r+=n.length,c=r):r++;if(r===m&&c!==m){var g=(0,s.sliceUint8)(e,c);this.cachedData?this.cachedData=(0,o.appendUint8Array)(this.cachedData,g):this.cachedData=g}}return{audioTrack:d,avcTrack:(0,a.dummyTrack)(),id3Track:f,textTrack:(0,a.dummyTrack)()}},t.demuxSampleAes=function(e,t,n){return Promise.reject(Error(`[`+this+`] This demuxer does not support Sample-AES decryption`))},t.flush=function(e){var t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),this.frameIndex=0,{audioTrack:this._audioTrack,avcTrack:(0,a.dummyTrack)(),id3Track:this._id3Track,textTrack:(0,a.dummyTrack)()}},t.destroy=function(){},e}(),l=function(e,t){return(0,r.isFiniteNumber)(e)?e*90:t*9e4};t.default=c}),"./src/demux/chunk-cache.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return r});var r=function(){function e(){this.chunks=[],this.dataLength=0}var t=e.prototype;return t.push=function(e){this.chunks.push(e),this.dataLength+=e.length},t.flush=function(){var e=this.chunks,t=this.dataLength,n;if(e.length)n=e.length===1?e[0]:i(e,t);else return new Uint8Array;return this.reset(),n},t.reset=function(){this.chunks.length=0,this.dataLength=0},e}();function i(e,t){for(var n=new Uint8Array(t),r=0,i=0;i<e.length;i++){var a=e[i];n.set(a,r),r+=a.length}return n}}),"./src/demux/dummy-demuxed-track.ts":(function(e,t,n){n.r(t),n.d(t,`dummyTrack`,function(){return r});function r(){return{type:``,id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}),"./src/demux/exp-golomb.ts":(function(e,t,n){n.r(t);var r=n(`./src/utils/logger.ts`);t.default=function(){function e(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}var t=e.prototype;return t.loadWord=function(){var e=this.data,t=this.bytesAvailable,n=e.byteLength-t,r=new Uint8Array(4),i=Math.min(4,t);if(i===0)throw Error(`no bytes available`);r.set(e.subarray(n,n+i)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=i*8,this.bytesAvailable-=i},t.skipBits=function(e){var t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)},t.readBits=function(e){var t=Math.min(this.bitsAvailable,e),n=this.word>>>32-t;return e>32&&r.logger.error(`Cannot read more than 32 bits at a time`),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this.bytesAvailable>0&&this.loadWord(),t=e-t,t>0&&this.bitsAvailable?n<<t|this.readBits(t):n},t.skipLZ=function(){var e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()},t.skipUEG=function(){this.skipBits(1+this.skipLZ())},t.skipEG=function(){this.skipBits(1+this.skipLZ())},t.readUEG=function(){var e=this.skipLZ();return this.readBits(e+1)-1},t.readEG=function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)},t.readBoolean=function(){return this.readBits(1)===1},t.readUByte=function(){return this.readBits(8)},t.readUShort=function(){return this.readBits(16)},t.readUInt=function(){return this.readBits(32)},t.skipScalingList=function(e){for(var t=8,n=8,r,i=0;i<e;i++)n!==0&&(r=this.readEG(),n=(t+r+256)%256),t=n===0?t:n},t.readSPS=function(){var e=0,t=0,n=0,r=0,i,a,o,s=this.readUByte.bind(this),c=this.readBits.bind(this),l=this.readUEG.bind(this),u=this.readBoolean.bind(this),d=this.skipBits.bind(this),f=this.skipEG.bind(this),p=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);s();var h=s();if(c(5),d(3),s(),p(),h===100||h===110||h===122||h===244||h===44||h===83||h===86||h===118||h===128){var g=l();if(g===3&&d(1),p(),p(),d(1),u())for(a=g===3?12:8,o=0;o<a;o++)u()&&m(o<6?16:64)}p();var _=l();if(_===0)l();else if(_===1)for(d(1),f(),f(),i=l(),o=0;o<i;o++)f();p(),d(1);var v=l(),y=l(),b=c(1);b===0&&d(1),d(1),u()&&(e=l(),t=l(),n=l(),r=l());var x=[1,1];if(u()&&u())switch(s()){case 1:x=[1,1];break;case 2:x=[12,11];break;case 3:x=[10,11];break;case 4:x=[16,11];break;case 5:x=[40,33];break;case 6:x=[24,11];break;case 7:x=[20,11];break;case 8:x=[32,11];break;case 9:x=[80,33];break;case 10:x=[18,11];break;case 11:x=[15,11];break;case 12:x=[64,33];break;case 13:x=[160,99];break;case 14:x=[4,3];break;case 15:x=[3,2];break;case 16:x=[2,1];break;case 255:x=[s()<<8|s(),s()<<8|s()];break}return{width:Math.ceil((v+1)*16-e*2-t*2),height:(2-b)*(y+1)*16-(b?2:4)*(n+r),pixelRatio:x}},t.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},e}()}),"./src/demux/id3.ts":(function(e,t,n){n.r(t),n.d(t,`isHeader`,function(){return r}),n.d(t,`isFooter`,function(){return i}),n.d(t,`getID3Data`,function(){return a}),n.d(t,`canParse`,function(){return s}),n.d(t,`getTimeStamp`,function(){return c}),n.d(t,`isTimeStampFrame`,function(){return l}),n.d(t,`getID3Frames`,function(){return d}),n.d(t,`decodeFrame`,function(){return f}),n.d(t,`utf8ArrayToStr`,function(){return _}),n.d(t,`testables`,function(){return v});var r=function(e,t){return t+10<=e.length&&e[t]===73&&e[t+1]===68&&e[t+2]===51&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128},i=function(e,t){return t+10<=e.length&&e[t]===51&&e[t+1]===68&&e[t+2]===73&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128},a=function(e,t){for(var n=t,a=0;r(e,t);){a+=10;var s=o(e,t+6);a+=s,i(e,t+10)&&(a+=10),t+=a}if(a>0)return e.subarray(n,n+a)},o=function(e,t){var n=0;return n=(e[t]&127)<<21,n|=(e[t+1]&127)<<14,n|=(e[t+2]&127)<<7,n|=e[t+3]&127,n},s=function(e,t){return r(e,t)&&o(e,t+6)+10<=e.length-t},c=function(e){for(var t=d(e),n=0;n<t.length;n++){var r=t[n];if(l(r))return g(r)}},l=function(e){return e&&e.key===`PRIV`&&e.info===`com.apple.streaming.transportStreamTimestamp`},u=function(e){var t=String.fromCharCode(e[0],e[1],e[2],e[3]),n=o(e,4),r=10;return{type:t,size:n,data:e.subarray(r,r+n)}},d=function(e){for(var t=0,n=[];r(e,t);){var a=o(e,t+6);t+=10;for(var s=t+a;t+8<s;){var c=u(e.subarray(t)),l=f(c);l&&n.push(l),t+=c.size+10}i(e,t)&&(t+=10)}return n},f=function(e){return e.type===`PRIV`?p(e):e.type[0]===`W`?h(e):m(e)},p=function(e){if(!(e.size<2)){var t=_(e.data,!0),n=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:n.buffer}}},m=function(e){if(!(e.size<2)){if(e.type===`TXXX`){var t=1,n=_(e.data.subarray(t),!0);t+=n.length+1;var r=_(e.data.subarray(t));return{key:e.type,info:n,data:r}}var i=_(e.data.subarray(1));return{key:e.type,data:i}}},h=function(e){if(e.type===`WXXX`){if(e.size<2)return;var t=1,n=_(e.data.subarray(t),!0);t+=n.length+1;var r=_(e.data.subarray(t));return{key:e.type,info:n,data:r}}var i=_(e.data);return{key:e.type,data:i}},g=function(e){if(e.data.byteLength===8){var t=new Uint8Array(e.data),n=t[3]&1,r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,n&&(r+=47721858.84),Math.round(r)}},_=function(e,t){t===void 0&&(t=!1);var n=b();if(n){var r=n.decode(e);if(t){var i=r.indexOf(`\0`);return i===-1?r:r.substring(0,i)}return r.replace(/\0/g,``)}for(var a=e.length,o,s,c,l=``,u=0;u<a;){if(o=e[u++],o===0&&t)return l;if(!(o===0||o===3))switch(o>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:l+=String.fromCharCode(o);break;case 12:case 13:s=e[u++],l+=String.fromCharCode((o&31)<<6|s&63);break;case 14:s=e[u++],c=e[u++],l+=String.fromCharCode((o&15)<<12|(s&63)<<6|(c&63)<<0);break;default:}}return l},v={decodeTextFrame:m},y;function b(){return!y&&self.TextDecoder!==void 0&&(y=new self.TextDecoder(`utf-8`)),y}}),"./src/demux/mp3demuxer.ts":(function(e,t,n){n.r(t);var r=n(`./src/demux/base-audio-demuxer.ts`),i=n(`./src/demux/id3.ts`),a=n(`./src/utils/logger.ts`),o=n(`./src/demux/mpegaudio.ts`);function s(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,c(e,t)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}var l=function(e){s(t,e);function t(){return e.apply(this,arguments)||this}var n=t.prototype;return n.resetInitSegment=function(t,n,r){e.prototype.resetInitSegment.call(this,t,n,r),this._audioTrack={container:`audio/mpeg`,type:`audio`,id:2,pid:-1,sequenceNumber:0,isAAC:!1,samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}},t.probe=function(e){if(!e)return!1;for(var t=(i.getID3Data(e,0)||[]).length,n=e.length;t<n;t++)if(o.probe(e,t))return a.logger.log(`MPEG Audio sync word found !`),!0;return!1},n.canParse=function(e,t){return o.canParse(e,t)},n.appendFrame=function(e,t,n){if(this.initPTS!==null)return o.appendFrame(e,t,n,this.initPTS,this.frameIndex)},t}(r.default);l.minProbeByteLength=4,t.default=l}),"./src/demux/mp4demuxer.ts":(function(e,t,n){n.r(t);var r=n(`./src/utils/mp4-tools.ts`),i=n(`./src/demux/dummy-demuxed-track.ts`),a=function(){function e(e,t){this.remainderData=null,this.config=void 0,this.config=t}var t=e.prototype;return t.resetTimeStamp=function(){},t.resetInitSegment=function(){},t.resetContiguity=function(){},e.probe=function(e){return(0,r.findBox)({data:e,start:0,end:Math.min(e.length,16384)},[`moof`]).length>0},t.demux=function(e){var t=e,n=(0,i.dummyTrack)();if(this.config.progressive){this.remainderData&&(t=(0,r.appendUint8Array)(this.remainderData,e));var a=(0,r.segmentValidRange)(t);this.remainderData=a.remainder,n.samples=a.valid||new Uint8Array}else n.samples=t;return{audioTrack:(0,i.dummyTrack)(),avcTrack:n,id3Track:(0,i.dummyTrack)(),textTrack:(0,i.dummyTrack)()}},t.flush=function(){var e=(0,i.dummyTrack)();return e.samples=this.remainderData||new Uint8Array,this.remainderData=null,{audioTrack:(0,i.dummyTrack)(),avcTrack:e,id3Track:(0,i.dummyTrack)(),textTrack:(0,i.dummyTrack)()}},t.demuxSampleAes=function(e,t,n){return Promise.reject(Error(`The MP4 demuxer does not support SAMPLE-AES decryption`))},t.destroy=function(){},e}();a.minProbeByteLength=1024,t.default=a}),"./src/demux/mpegaudio.ts":(function(e,t,n){n.r(t),n.d(t,`appendFrame`,function(){return c}),n.d(t,`parseHeader`,function(){return l}),n.d(t,`isHeaderPattern`,function(){return u}),n.d(t,`isHeader`,function(){return d}),n.d(t,`canParse`,function(){return f}),n.d(t,`probe`,function(){return p});var r=null,i=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],a=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],o=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],s=[0,1,1,4];function c(e,t,n,r,i){if(!(n+24>t.length)){var a=l(t,n);if(a&&n+a.frameLength<=t.length){var o=r+i*(a.samplesPerFrame*9e4/a.sampleRate),s={unit:t.subarray(n,n+a.frameLength),pts:o,dts:o};return e.config=[],e.channelCount=a.channelCount,e.samplerate=a.sampleRate,e.samples.push(s),{sample:s,length:a.frameLength,missing:0}}}}function l(e,t){var n=e[t+1]>>3&3,c=e[t+1]>>1&3,l=e[t+2]>>4&15,u=e[t+2]>>2&3;if(n!==1&&l!==0&&l!==15&&u!==3){var d=e[t+2]>>1&1,f=e[t+3]>>6,p=i[(n===3?3-c:c===3?3:4)*14+l-1]*1e3,m=a[(n===3?0:n===2?1:2)*3+u],h=f===3?1:2,g=o[n][c],_=s[c],v=g*8*_,y=Math.floor(g*p/m+d)*_;if(r===null){var b=(navigator.userAgent||``).match(/Chrome\/(\d+)/i);r=b?parseInt(b[1]):0}return r&&r<=87&&c===2&&p>=224e3&&f===0&&(e[t+3]=e[t+3]|128),{sampleRate:m,channelCount:h,frameLength:y,samplesPerFrame:v}}}function u(e,t){return e[t]===255&&(e[t+1]&224)==224&&(e[t+1]&6)!=0}function d(e,t){return t+1<e.length&&u(e,t)}function f(e,t){return u(e,t)&&4<=e.length-t}function p(e,t){if(t+1<e.length&&u(e,t)){var n=4,r=l(e,t),i=n;r!=null&&r.frameLength&&(i=r.frameLength);var a=t+i;return a===e.length||d(e,a)}return!1}}),"./src/demux/sample-aes.ts":(function(e,t,n){n.r(t);var r=n(`./src/crypt/decrypter.ts`),i=n(`./src/demux/tsdemuxer.ts`);t.default=function(){function e(e,t,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new r.default(e,t,{removePKCS7Padding:!1})}var t=e.prototype;return t.decryptBuffer=function(e,t){this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,t)},t.decryptAacSample=function(e,t,n,r){var i=e[t].unit,a=i.subarray(16,i.length-i.length%16),o=a.buffer.slice(a.byteOffset,a.byteOffset+a.length),s=this;this.decryptBuffer(o,function(a){var o=new Uint8Array(a);i.set(o,16),r||s.decryptAacSamples(e,t+1,n)})},t.decryptAacSamples=function(e,t,n){for(;;t++){if(t>=e.length){n();return}if(!(e[t].unit.length<32)){var r=this.decrypter.isSync();if(this.decryptAacSample(e,t,n,r),!r)return}}},t.getAvcEncryptedData=function(e){for(var t=Math.floor((e.length-48)/160)*16+16,n=new Int8Array(t),r=0,i=32;i<e.length-16;i+=160,r+=16)n.set(e.subarray(i,i+16),r);return n},t.getAvcDecryptedUnit=function(e,t){for(var n=new Uint8Array(t),r=0,i=32;i<e.length-16;i+=160,r+=16)e.set(n.subarray(r,r+16),i);return e},t.decryptAvcSample=function(e,t,n,r,a,o){var s=(0,i.discardEPB)(a.data),c=this.getAvcEncryptedData(s),l=this;this.decryptBuffer(c.buffer,function(i){a.data=l.getAvcDecryptedUnit(s,i),o||l.decryptAvcSamples(e,t,n+1,r)})},t.decryptAvcSamples=function(e,t,n,r){if(e instanceof Uint8Array)throw Error(`Cannot decrypt samples of type Uint8Array`);for(;;t++,n=0){if(t>=e.length){r();return}for(var i=e[t].units;!(n>=i.length);n++){var a=i[n];if(!(a.data.length<=48||a.type!==1&&a.type!==5)){var o=this.decrypter.isSync();if(this.decryptAvcSample(e,t,n,r,a,o),!o)return}}}},e}()}),"./src/demux/transmuxer-interface.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return d});var r=n(`./node_modules/webworkify-webpack/index.js`),i=n(`./src/events.ts`),a=n(`./src/demux/transmuxer.ts`),o=n(`./src/utils/logger.ts`),s=n(`./src/errors.ts`),c=n(`./src/utils/mediasource-helper.ts`),l=n(`./node_modules/eventemitter3/index.js`),u=(0,c.getMediaSource)()||{isTypeSupported:function(){return!1}},d=function(){function e(e,t,n,c){var d=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.hls=e,this.id=t,this.onTransmuxComplete=n,this.onFlush=c;var f=e.config,p=function(t,n){n||={},n.frag=d.frag,n.id=d.id,e.trigger(t,n)};this.observer=new l.EventEmitter,this.observer.on(i.Events.FRAG_DECRYPTED,p),this.observer.on(i.Events.ERROR,p);var m={mp4:u.isTypeSupported(`video/mp4`),mpeg:u.isTypeSupported(`audio/mpeg`),mp3:u.isTypeSupported(`audio/mp4; codecs="mp3"`)},h=navigator.vendor;if(f.enableWorker&&typeof Worker<`u`){o.logger.log(`demuxing in webworker`);var g;try{g=this.worker=r(`./src/demux/transmuxer-worker.ts`),this.onwmsg=this.onWorkerMessage.bind(this),g.addEventListener(`message`,this.onwmsg),g.onerror=function(t){e.trigger(i.Events.ERROR,{type:s.ErrorTypes.OTHER_ERROR,details:s.ErrorDetails.INTERNAL_EXCEPTION,fatal:!0,event:`demuxerWorker`,error:Error(t.message+`  (`+t.filename+`:`+t.lineno+`)`)})},g.postMessage({cmd:`init`,typeSupported:m,vendor:h,id:t,config:JSON.stringify(f)})}catch(e){o.logger.warn(`Error in worker:`,e),o.logger.error(`Error while initializing DemuxerWorker, fallback to inline`),g&&self.URL.revokeObjectURL(g.objectURL),this.transmuxer=new a.default(this.observer,m,f,h,t),this.worker=null}}else this.transmuxer=new a.default(this.observer,m,f,h,t)}var t=e.prototype;return t.destroy=function(){var e=this.worker;if(e)e.removeEventListener(`message`,this.onwmsg),e.terminate(),this.worker=null;else{var t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}var n=this.observer;n&&n.removeAllListeners(),this.observer=null},t.push=function(e,t,n,r,i,s,c,l,u,d){var f=this;u.transmuxing.start=self.performance.now();var p=this.transmuxer,m=this.worker,h=s?s.start:i.start,g=i.decryptdata,_=this.frag,v=!(_&&i.cc===_.cc),y=!(_&&u.level===_.level),b=_?u.sn-_.sn:-1,x=this.part?u.part-this.part.index:1,S=!y&&(b===1||b===0&&x===1),C=self.performance.now();(y||b||i.stats.parsing.start===0)&&(i.stats.parsing.start=C),s&&(x||!S)&&(s.stats.parsing.start=C);var w=!(_&&i.initSegment?.url===_.initSegment?.url),T=new a.TransmuxState(v,S,l,y,h,w);if(!S||v||w){o.logger.log(`[transmuxer-interface, `+i.type+`]: Starting new transmux session for sn: `+u.sn+` p: `+u.part+` level: `+u.level+` id: `+u.id+`
        discontinuity: `+v+`
        trackSwitch: `+y+`
        contiguous: `+S+`
        accurateTimeOffset: `+l+`
        timeOffset: `+h+`
        initSegmentChange: `+w);var E=new a.TransmuxConfig(n,r,t,c,d);this.configureTransmuxer(E)}if(this.frag=i,this.part=s,m)m.postMessage({cmd:`demux`,data:e,decryptdata:g,chunkMeta:u,state:T},e instanceof ArrayBuffer?[e]:[]);else if(p){var D=p.push(e,g,u,T);(0,a.isPromise)(D)?D.then(function(e){f.handleTransmuxComplete(e)}):this.handleTransmuxComplete(D)}},t.flush=function(e){var t=this;e.transmuxing.start=self.performance.now();var n=this.transmuxer,r=this.worker;if(r)r.postMessage({cmd:`flush`,chunkMeta:e});else if(n){var i=n.flush(e);(0,a.isPromise)(i)?i.then(function(n){t.handleFlushResult(n,e)}):this.handleFlushResult(i,e)}},t.handleFlushResult=function(e,t){var n=this;e.forEach(function(e){n.handleTransmuxComplete(e)}),this.onFlush(t)},t.onWorkerMessage=function(e){var t=e.data,n=this.hls;switch(t.event){case`init`:self.URL.revokeObjectURL(this.worker.objectURL);break;case`transmuxComplete`:this.handleTransmuxComplete(t.data);break;case`flush`:this.onFlush(t.data);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,n.trigger(t.event,t.data);break}},t.configureTransmuxer=function(e){var t=this.worker,n=this.transmuxer;t?t.postMessage({cmd:`configure`,config:e}):n&&n.configure(e)},t.handleTransmuxComplete=function(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)},e}()}),"./src/demux/transmuxer-worker.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return s});var r=n(`./src/demux/transmuxer.ts`),i=n(`./src/events.ts`),a=n(`./src/utils/logger.ts`),o=n(`./node_modules/eventemitter3/index.js`);function s(e){var t=new o.EventEmitter,n=function(t,n){e.postMessage({event:t,data:n})};t.on(i.Events.FRAG_DECRYPTED,n),t.on(i.Events.ERROR,n),e.addEventListener(`message`,function(i){var o=i.data;switch(o.cmd){case`init`:var s=JSON.parse(o.config);e.transmuxer=new r.default(t,o.typeSupported,s,o.vendor,o.id),(0,a.enableLogs)(s.debug),n(`init`,null);break;case`configure`:e.transmuxer.configure(o.config);break;case`demux`:var l=e.transmuxer.push(o.data,o.decryptdata,o.chunkMeta,o.state);(0,r.isPromise)(l)?l.then(function(t){c(e,t)}):c(e,l);break;case`flush`:var d=o.chunkMeta,f=e.transmuxer.flush(d);(0,r.isPromise)(f)?f.then(function(t){u(e,t,d)}):u(e,f,d);break;default:break}})}function c(e,t){if(!d(t.remuxResult)){var n=[],r=t.remuxResult,i=r.audio,a=r.video;i&&l(n,i),a&&l(n,a),e.postMessage({event:`transmuxComplete`,data:t},n)}}function l(e,t){t.data1&&e.push(t.data1.buffer),t.data2&&e.push(t.data2.buffer)}function u(e,t,n){t.forEach(function(t){c(e,t)}),e.postMessage({event:`flush`,data:n})}function d(e){return!e.audio&&!e.video&&!e.text&&!e.id3&&!e.initSegment}}),"./src/demux/transmuxer.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return v}),n.d(t,`isPromise`,function(){return x}),n.d(t,`TransmuxConfig`,function(){return S}),n.d(t,`TransmuxState`,function(){return C});var r=n(`./src/events.ts`),i=n(`./src/errors.ts`),a=n(`./src/crypt/decrypter.ts`),o=n(`./src/demux/aacdemuxer.ts`),s=n(`./src/demux/mp4demuxer.ts`),c=n(`./src/demux/tsdemuxer.ts`),l=n(`./src/demux/mp3demuxer.ts`),u=n(`./src/remux/mp4-remuxer.ts`),d=n(`./src/remux/passthrough-remuxer.ts`),f=n(`./src/demux/chunk-cache.ts`),p=n(`./src/utils/mp4-tools.ts`),m=n(`./src/utils/logger.ts`),h;try{h=self.performance.now.bind(self.performance)}catch{m.logger.debug(`Unable to use Performance API on this environment`),h=self.Date.now}var g=[{demux:c.default,remux:u.default},{demux:s.default,remux:d.default},{demux:o.default,remux:u.default},{demux:l.default,remux:u.default}],_=1024;g.forEach(function(e){var t=e.demux;_=Math.max(_,t.minProbeByteLength)});var v=function(){function e(e,t,n,r,i){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.cache=new f.default,this.observer=e,this.typeSupported=t,this.config=n,this.vendor=r,this.id=i}var t=e.prototype;return t.configure=function(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()},t.push=function(e,t,n,r){var i=this,a=n.transmuxing;a.executeStart=h();var o=new Uint8Array(e),s=this.cache,c=this.config,l=this.currentTransmuxState,u=this.transmuxConfig;r&&(this.currentTransmuxState=r);var d=y(o,t);if(d&&d.method===`AES-128`){var f=this.getDecrypter();if(c.enableSoftwareAES){var m=f.softwareDecrypt(o,d.key.buffer,d.iv.buffer);if(!m)return a.executeEnd=h(),b(n);o=new Uint8Array(m)}else return this.decryptionPromise=f.webCryptoDecrypt(o,d.key.buffer,d.iv.buffer).then(function(e){var t=i.push(e,null,n);return i.decryptionPromise=null,t}),this.decryptionPromise}var g=r||l,_=g.contiguous,v=g.discontinuity,x=g.trackSwitch,S=g.accurateTimeOffset,C=g.timeOffset,w=g.initSegmentChange,T=u.audioCodec,E=u.videoCodec,D=u.defaultInitPts,O=u.duration,k=u.initSegmentData;if((v||x||w)&&this.resetInitSegment(k,T,E,O),(v||w)&&this.resetInitialTimestamp(D),_||this.resetContiguity(),this.needsProbing(o,v,x)){if(s.dataLength){var A=s.flush();o=(0,p.appendUint8Array)(A,o)}this.configureTransmuxer(o,u)}var j=this.transmux(o,d,C,S,n),M=this.currentTransmuxState;return M.contiguous=!0,M.discontinuity=!1,M.trackSwitch=!1,a.executeEnd=h(),j},t.flush=function(e){var t=this,n=e.transmuxing;n.executeStart=h();var a=this.decrypter,o=this.cache,s=this.currentTransmuxState,c=this.decryptionPromise;if(c)return c.then(function(){return t.flush(e)});var l=[],u=s.timeOffset;if(a){var d=a.flush();d&&l.push(this.push(d,null,e))}var f=o.dataLength;o.reset();var p=this.demuxer,m=this.remuxer;if(!p||!m)return f>=_&&this.observer.emit(r.Events.ERROR,r.Events.ERROR,{type:i.ErrorTypes.MEDIA_ERROR,details:i.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:`no demux matching with content found`}),n.executeEnd=h(),[b(e)];var g=p.flush(u);return x(g)?g.then(function(n){return t.flushRemux(l,n,e),l}):(this.flushRemux(l,g,e),l)},t.flushRemux=function(e,t,n){var r=t.audioTrack,i=t.avcTrack,a=t.id3Track,o=t.textTrack,s=this.currentTransmuxState,c=s.accurateTimeOffset,l=s.timeOffset;m.logger.log(`[transmuxer.ts]: Flushed fragment `+n.sn+(n.part>-1?` p: `+n.part:``)+` of level `+n.level);var u=this.remuxer.remux(r,i,a,o,l,c,!0,this.id);e.push({remuxResult:u,chunkMeta:n}),n.transmuxing.executeEnd=h()},t.resetInitialTimestamp=function(e){var t=this.demuxer,n=this.remuxer;!t||!n||(t.resetTimeStamp(e),n.resetTimeStamp(e))},t.resetContiguity=function(){var e=this.demuxer,t=this.remuxer;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())},t.resetInitSegment=function(e,t,n,r){var i=this.demuxer,a=this.remuxer;!i||!a||(i.resetInitSegment(t,n,r),a.resetInitSegment(e,t,n))},t.destroy=function(){this.demuxer&&=(this.demuxer.destroy(),void 0),this.remuxer&&=(this.remuxer.destroy(),void 0)},t.transmux=function(e,t,n,r,i){return t&&t.method===`SAMPLE-AES`?this.transmuxSampleAes(e,t,n,r,i):this.transmuxUnencrypted(e,n,r,i)},t.transmuxUnencrypted=function(e,t,n,r){var i=this.demuxer.demux(e,t,!1,!this.config.progressive),a=i.audioTrack,o=i.avcTrack,s=i.id3Track,c=i.textTrack;return{remuxResult:this.remuxer.remux(a,o,s,c,t,n,!1,this.id),chunkMeta:r}},t.transmuxSampleAes=function(e,t,n,r,i){var a=this;return this.demuxer.demuxSampleAes(e,t,n).then(function(e){return{remuxResult:a.remuxer.remux(e.audioTrack,e.avcTrack,e.id3Track,e.textTrack,n,r,!1,a.id),chunkMeta:i}})},t.configureTransmuxer=function(e,t){for(var n=this.config,r=this.observer,i=this.typeSupported,a=this.vendor,o=t.audioCodec,c=t.defaultInitPts,l=t.duration,u=t.initSegmentData,f=t.videoCodec,p,h=0,_=g.length;h<_;h++)if(g[h].demux.probe(e)){p=g[h];break}p||=(m.logger.warn(`Failed to find demuxer by probing frag, treating as mp4 passthrough`),{demux:s.default,remux:d.default});var v=this.demuxer,y=this.remuxer,b=p.remux,x=p.demux;(!y||!(y instanceof b))&&(this.remuxer=new b(r,n,i,a)),(!v||!(v instanceof x))&&(this.demuxer=new x(r,n,i),this.probe=x.probe),this.resetInitSegment(u,o,f,l),this.resetInitialTimestamp(c)},t.needsProbing=function(e,t,n){return!this.demuxer||!this.remuxer||t||n},t.getDecrypter=function(){var e=this.decrypter;return e||=this.decrypter=new a.default(this.observer,this.config),e},e}();function y(e,t){var n=null;return e.byteLength>0&&t!=null&&t.key!=null&&t.iv!==null&&t.method!=null&&(n=t),n}var b=function(e){return{remuxResult:{},chunkMeta:e}};function x(e){return`then`in e&&e.then instanceof Function}var S=function(e,t,n,r,i){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=n,this.duration=r,this.defaultInitPts=i},C=function(e,t,n,r,i,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=n,this.trackSwitch=r,this.timeOffset=i,this.initSegmentChange=a}}),"./src/demux/tsdemuxer.ts":(function(e,t,n){n.r(t),n.d(t,`discardEPB`,function(){return b});var r=n(`./src/demux/adts.ts`),i=n(`./src/demux/mpegaudio.ts`),a=n(`./src/demux/exp-golomb.ts`),o=n(`./src/demux/id3.ts`),s=n(`./src/demux/sample-aes.ts`),c=n(`./src/events.ts`),l=n(`./src/utils/mp4-tools.ts`),u=n(`./src/utils/logger.ts`),d=n(`./src/errors.ts`),f={video:1,audio:2,id3:3,text:4},p=function(){function e(e,t,n){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this.aacLastPTS=null,this._initPTS=null,this._initDTS=null,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=n}e.probe=function(t){var n=e.syncOffset(t);return n<0?!1:(n&&u.logger.warn(`MPEG2-TS detected but first sync word found @ offset `+n+`, junk ahead ?`),!0)},e.syncOffset=function(e){for(var t=Math.min(1e3,e.length-564),n=0;n<t;)if(e[n]===71&&e[n+188]===71&&e[n+376]===71)return n;else n++;return-1},e.createTrack=function(e,t){return{container:e===`video`||e===`audio`?`video/mp2t`:void 0,type:e,id:f[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e===`audio`?t:void 0}};var t=e.prototype;return t.resetInitSegment=function(t,n,r){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=e.createTrack(`video`,r),this._audioTrack=e.createTrack(`audio`,r),this._id3Track=e.createTrack(`id3`,r),this._txtTrack=e.createTrack(`text`,r),this._audioTrack.isAAC=!0,this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=t,this.videoCodec=n,this._duration=r},t.resetTimeStamp=function(){},t.resetContiguity=function(){var e=this._audioTrack,t=this._avcTrack,n=this._id3Track;e&&(e.pesData=null),t&&(t.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.aacLastPTS=null},t.demux=function(t,n,r,i){r===void 0&&(r=!1),i===void 0&&(i=!1),r||(this.sampleAes=null);var a,o=this._avcTrack,s=this._audioTrack,f=this._id3Track,p=o.pid,m=o.pesData,v=s.pid,y=f.pid,b=s.pesData,x=f.pesData,S=!1,C=this.pmtParsed,w=this._pmtId,T=t.length;if(this.remainderData&&=(t=(0,l.appendUint8Array)(this.remainderData,t),T=t.length,null),T<188&&!i)return this.remainderData=t,{audioTrack:s,avcTrack:o,id3Track:f,textTrack:this._txtTrack};var E=Math.max(0,e.syncOffset(t));T-=(T+E)%188,T<t.byteLength&&!i&&(this.remainderData=new Uint8Array(t.buffer,T,t.buffer.byteLength-T));for(var D=0,O=E;O<T;O+=188)if(t[O]===71){var k=!!(t[O+1]&64),A=((t[O+1]&31)<<8)+t[O+2],j=(t[O+3]&48)>>4,M=void 0;if(j>1){if(M=O+5+t[O+4],M===O+188)continue}else M=O+4;switch(A){case p:k&&(m&&(a=_(m))&&this.parseAVCPES(a,!1),m={data:[],size:0}),m&&(m.data.push(t.subarray(M,O+188)),m.size+=O+188-M);break;case v:k&&(b&&(a=_(b))&&(s.isAAC?this.parseAACPES(a):this.parseMPEGPES(a)),b={data:[],size:0}),b&&(b.data.push(t.subarray(M,O+188)),b.size+=O+188-M);break;case y:k&&(x&&(a=_(x))&&this.parseID3PES(a),x={data:[],size:0}),x&&(x.data.push(t.subarray(M,O+188)),x.size+=O+188-M);break;case 0:k&&(M+=t[M]+1),w=this._pmtId=h(t,M);break;case w:k&&(M+=t[M]+1);var N=g(t,M,this.typeSupported.mpeg===!0||this.typeSupported.mp3===!0,r);p=N.avc,p>0&&(o.pid=p),v=N.audio,v>0&&(s.pid=v,s.isAAC=N.isAAC),y=N.id3,y>0&&(f.pid=y),S&&!C&&(u.logger.log(`reparse from beginning`),S=!1,O=E-188),C=this.pmtParsed=!0;break;case 17:case 8191:break;default:S=!0;break}}else D++;D>0&&this.observer.emit(c.Events.ERROR,c.Events.ERROR,{type:d.ErrorTypes.MEDIA_ERROR,details:d.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:`Found `+D+` TS packet/s that do not start with 0x47`}),o.pesData=m,s.pesData=b,f.pesData=x;var P={audioTrack:s,avcTrack:o,id3Track:f,textTrack:this._txtTrack};return i&&this.extractRemainingSamples(P),P},t.flush=function(){var e=this.remainderData;this.remainderData=null;var t=e?this.demux(e,-1,!1,!0):{audioTrack:this._audioTrack,avcTrack:this._avcTrack,textTrack:this._txtTrack,id3Track:this._id3Track};return this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t},t.extractRemainingSamples=function(e){var t=e.audioTrack,n=e.avcTrack,r=e.id3Track,i=n.pesData,a=t.pesData,o=r.pesData,s;i&&(s=_(i))?(this.parseAVCPES(s,!0),n.pesData=null):n.pesData=i,a&&(s=_(a))?(t.isAAC?this.parseAACPES(s):this.parseMPEGPES(s),t.pesData=null):(a!=null&&a.size&&u.logger.log(`last AAC PES packet truncated,might overlap between fragments`),t.pesData=a),o&&(s=_(o))?(this.parseID3PES(s),r.pesData=null):r.pesData=o},t.demuxSampleAes=function(e,t,n){var r=this.demux(e,n,!0,!this.config.progressive),i=this.sampleAes=new s.default(this.observer,this.config,t);return this.decrypt(r,i)},t.decrypt=function(e,t){return new Promise(function(n){var r=e.audioTrack,i=e.avcTrack;r.samples&&r.isAAC?t.decryptAacSamples(r.samples,0,function(){i.samples?t.decryptAvcSamples(i.samples,0,0,function(){n(e)}):n(e)}):i.samples&&t.decryptAvcSamples(i.samples,0,0,function(){n(e)})})},t.destroy=function(){this._initPTS=this._initDTS=null,this._duration=0},t.parseAVCPES=function(e,t){var n=this,r=this._avcTrack,i=this.parseAVCNALu(e.data),s=!1,c=this.avcSample,l,u=!1;e.data=null,c&&i.length&&!r.audFound&&(v(c,r),c=this.avcSample=m(!1,e.pts,e.dts,``)),i.forEach(function(t){switch(t.type){case 1:l=!0,c||=n.avcSample=m(!0,e.pts,e.dts,``),s&&(c.debug+=`NDR `),c.frame=!0;var i=t.data;if(u&&i.length>4){var d=new a.default(i).readSliceType();(d===2||d===4||d===7||d===9)&&(c.key=!0)}break;case 5:l=!0,c||=n.avcSample=m(!0,e.pts,e.dts,``),s&&(c.debug+=`IDR `),c.key=!0,c.frame=!0;break;case 6:l=!0,s&&c&&(c.debug+=`SEI `);var f=new a.default(b(t.data));f.readUByte();for(var p=0,h=0,g=!1,_=0;!g&&f.bytesAvailable>1;){p=0;do _=f.readUByte(),p+=_;while(_===255);h=0;do _=f.readUByte(),h+=_;while(_===255);if(p===4&&f.bytesAvailable!==0){if(g=!0,f.readUByte()===181&&f.readUShort()===49&&f.readUInt()===1195456820&&f.readUByte()===3){for(var x=f.readUByte(),S=f.readUByte(),C=31&x,w=[x,S],T=0;T<C;T++)w.push(f.readUByte()),w.push(f.readUByte()),w.push(f.readUByte());y(n._txtTrack.samples,{type:3,pts:e.pts,bytes:w})}}else if(p===5&&f.bytesAvailable!==0){if(g=!0,h>16){for(var E=[],D=0;D<16;D++)E.push(f.readUByte().toString(16)),(D===3||D===5||D===7||D===9)&&E.push(`-`);for(var O=h-16,k=new Uint8Array(O),A=0;A<O;A++)k[A]=f.readUByte();y(n._txtTrack.samples,{pts:e.pts,payloadType:p,uuid:E.join(``),userData:(0,o.utf8ArrayToStr)(k),userDataBytes:k})}}else if(h<f.bytesAvailable)for(var j=0;j<h;j++)f.readUByte()}break;case 7:if(l=!0,u=!0,s&&c&&(c.debug+=`SPS `),!r.sps){var M=new a.default(t.data).readSPS();r.width=M.width,r.height=M.height,r.pixelRatio=M.pixelRatio,r.sps=[t.data],r.duration=n._duration;for(var N=t.data.subarray(1,4),P=`avc1.`,F=0;F<3;F++){var I=N[F].toString(16);I.length<2&&(I=`0`+I),P+=I}r.codec=P}break;case 8:l=!0,s&&c&&(c.debug+=`PPS `),r.pps||=[t.data];break;case 9:l=!1,r.audFound=!0,c&&v(c,r),c=n.avcSample=m(!1,e.pts,e.dts,s?`AUD `:``);break;case 12:l=!1;break;default:l=!1,c&&(c.debug+=`unknown NAL `+t.type+` `);break}c&&l&&c.units.push(t)}),t&&c&&(v(c,r),this.avcSample=null)},t.getLastNalUnit=function(){var e,t=this.avcSample,n;if(!t||t.units.length===0){var r=this._avcTrack.samples;t=r[r.length-1]}if((e=t)!=null&&e.units){var i=t.units;n=i[i.length-1]}return n},t.parseAVCNALu=function(e){var t=e.byteLength,n=this._avcTrack,r=n.naluState||0,i=r,a=[],o=0,s,c,l,u=-1,d=0;for(r===-1&&(u=0,d=e[0]&31,r=0,o=1);o<t;){if(s=e[o++],!r){r=s?0:1;continue}if(r===1){r=s?0:2;continue}if(!s)r=3;else if(s===1){if(u>=0){var f={data:e.subarray(u,o-r-1),type:d};a.push(f)}else{var p=this.getLastNalUnit();if(p&&(i&&o<=4-i&&p.state&&(p.data=p.data.subarray(0,p.data.byteLength-i)),c=o-r-1,c>0)){var m=new Uint8Array(p.data.byteLength+c);m.set(p.data,0),m.set(e.subarray(0,c),p.data.byteLength),p.data=m,p.state=0}}o<t?(l=e[o]&31,u=o,d=l,r=0):r=-1}else r=0}if(u>=0&&r>=0){var h={data:e.subarray(u,t),type:d,state:r};a.push(h)}if(a.length===0){var g=this.getLastNalUnit();if(g){var _=new Uint8Array(g.data.byteLength+e.byteLength);_.set(g.data,0),_.set(e,g.data.byteLength),g.data=_}}return n.naluState=r,a},t.parseAACPES=function(e){var t=0,n=this._audioTrack,i=this.aacOverFlow,a=e.data;if(i){this.aacOverFlow=null;var o=i.sample.unit.byteLength,s=Math.min(i.missing,o),l=o-s;i.sample.unit.set(a.subarray(0,s),l),n.samples.push(i.sample),t=i.missing}var f,p;for(f=t,p=a.length;f<p-1&&!r.isHeader(a,f);f++);if(f!==t){var m,h;if(f<p-1?(m=`AAC PES did not start with ADTS header,offset:`+f,h=!1):(m=`no ADTS header found in AAC PES`,h=!0),u.logger.warn(`parsing error:`+m),this.observer.emit(c.Events.ERROR,c.Events.ERROR,{type:d.ErrorTypes.MEDIA_ERROR,details:d.ErrorDetails.FRAG_PARSING_ERROR,fatal:h,reason:m}),h)return}r.initTrackConfig(n,this.observer,a,f,this.audioCodec);var g;if(e.pts!==void 0)g=e.pts;else if(i){var _=r.getFrameDuration(n.samplerate);g=i.sample.pts+_}else{u.logger.warn(`[tsdemuxer]: AAC PES unknown PTS`);return}for(var v=0;f<p;)if(r.isHeader(a,f)){if(f+5<p){var y=r.appendFrame(n,a,f,g,v);if(y)if(y.missing)this.aacOverFlow=y;else{f+=y.length,v++;continue}}break}else f++},t.parseMPEGPES=function(e){var t=e.data,n=t.length,r=0,a=0,o=e.pts;if(o===void 0){u.logger.warn(`[tsdemuxer]: MPEG PES unknown PTS`);return}for(;a<n;)if(i.isHeader(t,a)){var s=i.appendFrame(this._audioTrack,t,a,o,r);if(s)a+=s.length,r++;else break}else a++},t.parseID3PES=function(e){if(e.pts===void 0){u.logger.warn(`[tsdemuxer]: ID3 PES unknown PTS`);return}this._id3Track.samples.push(e)},e}();p.minProbeByteLength=188;function m(e,t,n,r){return{key:e,frame:!1,pts:t,dts:n,units:[],debug:r,length:0}}function h(e,t){return(e[t+10]&31)<<8|e[t+11]}function g(e,t,n,r){var i={audio:-1,avc:-1,id3:-1,isAAC:!0},a=(e[t+1]&15)<<8|e[t+2],o=t+3+a-4,s=(e[t+10]&15)<<8|e[t+11];for(t+=12+s;t<o;){var c=(e[t+1]&31)<<8|e[t+2];switch(e[t]){case 207:if(!r){u.logger.log(`ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream`);break}case 15:i.audio===-1&&(i.audio=c);break;case 21:i.id3===-1&&(i.id3=c);break;case 219:if(!r){u.logger.log(`H.264 with AES-128-CBC slice encryption found in unencrypted stream`);break}case 27:i.avc===-1&&(i.avc=c);break;case 3:case 4:n?i.audio===-1&&(i.audio=c,i.isAAC=!1):u.logger.log(`MPEG audio found, not supported in this browser`);break;case 36:u.logger.warn(`Unsupported HEVC stream type found`);break;default:break}t+=((e[t+3]&15)<<8|e[t+4])+5}return i}function _(e){var t=0,n,r,i,a,o,s=e.data;if(!e||e.size===0)return null;for(;s[0].length<19&&s.length>1;){var c=new Uint8Array(s[0].length+s[1].length);c.set(s[0]),c.set(s[1],s[0].length),s[0]=c,s.splice(1,1)}if(n=s[0],(n[0]<<16)+(n[1]<<8)+n[2]===1){if(r=(n[4]<<8)+n[5],r&&r>e.size-6)return null;var l=n[7];l&192&&(a=(n[9]&14)*536870912+(n[10]&255)*4194304+(n[11]&254)*16384+(n[12]&255)*128+(n[13]&254)/2,l&64?(o=(n[14]&14)*536870912+(n[15]&255)*4194304+(n[16]&254)*16384+(n[17]&255)*128+(n[18]&254)/2,a-o>60*9e4&&(u.logger.warn(Math.round((a-o)/9e4)+`s delta between PTS and DTS, align them`),a=o)):o=a),i=n[8];var d=i+9;if(e.size<=d)return null;e.size-=d;for(var f=new Uint8Array(e.size),p=0,m=s.length;p<m;p++){n=s[p];var h=n.byteLength;if(d)if(d>h){d-=h;continue}else n=n.subarray(d),h-=d,d=0;f.set(n,t),t+=h}return r&&(r-=i+3),{data:f,pts:a,dts:o,len:r}}return null}function v(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){var n=t.samples,r=n.length;if(r){var i=n[r-1];e.pts=i.pts,e.dts=i.dts}else{t.dropped++;return}}t.samples.push(e)}e.debug.length&&u.logger.log(e.pts+`/`+e.dts+`:`+e.debug)}function y(e,t){var n=e.length;if(n>0){if(t.pts>=e[n-1].pts)e.push(t);else for(var r=n-1;r>=0;r--)if(t.pts<e[r].pts){e.splice(r,0,t);break}}else e.push(t)}function b(e){for(var t=e.byteLength,n=[],r=1;r<t-2;)e[r]===0&&e[r+1]===0&&e[r+2]===3?(n.push(r+2),r+=2):r++;if(n.length===0)return e;var i=t-n.length,a=new Uint8Array(i),o=0;for(r=0;r<i;o++,r++)o===n[0]&&(o++,n.shift()),a[r]=e[o];return a}t.default=p}),"./src/errors.ts":(function(e,t,n){n.r(t),n.d(t,`ErrorTypes`,function(){return r}),n.d(t,`ErrorDetails`,function(){return i});var r;(function(e){e.NETWORK_ERROR=`networkError`,e.MEDIA_ERROR=`mediaError`,e.KEY_SYSTEM_ERROR=`keySystemError`,e.MUX_ERROR=`muxError`,e.OTHER_ERROR=`otherError`})(r||={});var i;(function(e){e.KEY_SYSTEM_NO_KEYS=`keySystemNoKeys`,e.KEY_SYSTEM_NO_ACCESS=`keySystemNoAccess`,e.KEY_SYSTEM_NO_SESSION=`keySystemNoSession`,e.KEY_SYSTEM_LICENSE_REQUEST_FAILED=`keySystemLicenseRequestFailed`,e.KEY_SYSTEM_NO_INIT_DATA=`keySystemNoInitData`,e.MANIFEST_LOAD_ERROR=`manifestLoadError`,e.MANIFEST_LOAD_TIMEOUT=`manifestLoadTimeOut`,e.MANIFEST_PARSING_ERROR=`manifestParsingError`,e.MANIFEST_INCOMPATIBLE_CODECS_ERROR=`manifestIncompatibleCodecsError`,e.LEVEL_EMPTY_ERROR=`levelEmptyError`,e.LEVEL_LOAD_ERROR=`levelLoadError`,e.LEVEL_LOAD_TIMEOUT=`levelLoadTimeOut`,e.LEVEL_SWITCH_ERROR=`levelSwitchError`,e.AUDIO_TRACK_LOAD_ERROR=`audioTrackLoadError`,e.AUDIO_TRACK_LOAD_TIMEOUT=`audioTrackLoadTimeOut`,e.SUBTITLE_LOAD_ERROR=`subtitleTrackLoadError`,e.SUBTITLE_TRACK_LOAD_TIMEOUT=`subtitleTrackLoadTimeOut`,e.FRAG_LOAD_ERROR=`fragLoadError`,e.FRAG_LOAD_TIMEOUT=`fragLoadTimeOut`,e.FRAG_DECRYPT_ERROR=`fragDecryptError`,e.FRAG_PARSING_ERROR=`fragParsingError`,e.REMUX_ALLOC_ERROR=`remuxAllocError`,e.KEY_LOAD_ERROR=`keyLoadError`,e.KEY_LOAD_TIMEOUT=`keyLoadTimeOut`,e.BUFFER_ADD_CODEC_ERROR=`bufferAddCodecError`,e.BUFFER_INCOMPATIBLE_CODECS_ERROR=`bufferIncompatibleCodecsError`,e.BUFFER_APPEND_ERROR=`bufferAppendError`,e.BUFFER_APPENDING_ERROR=`bufferAppendingError`,e.BUFFER_STALLED_ERROR=`bufferStalledError`,e.BUFFER_FULL_ERROR=`bufferFullError`,e.BUFFER_SEEK_OVER_HOLE=`bufferSeekOverHole`,e.BUFFER_NUDGE_ON_STALL=`bufferNudgeOnStall`,e.INTERNAL_EXCEPTION=`internalException`,e.INTERNAL_ABORTED=`aborted`,e.UNKNOWN=`unknown`})(i||={})}),"./src/events.ts":(function(e,t,n){n.r(t),n.d(t,`Events`,function(){return r});var r;(function(e){e.MEDIA_ATTACHING=`hlsMediaAttaching`,e.MEDIA_ATTACHED=`hlsMediaAttached`,e.MEDIA_DETACHING=`hlsMediaDetaching`,e.MEDIA_DETACHED=`hlsMediaDetached`,e.BUFFER_RESET=`hlsBufferReset`,e.BUFFER_CODECS=`hlsBufferCodecs`,e.BUFFER_CREATED=`hlsBufferCreated`,e.BUFFER_APPENDING=`hlsBufferAppending`,e.BUFFER_APPENDED=`hlsBufferAppended`,e.BUFFER_EOS=`hlsBufferEos`,e.BUFFER_FLUSHING=`hlsBufferFlushing`,e.BUFFER_FLUSHED=`hlsBufferFlushed`,e.MANIFEST_LOADING=`hlsManifestLoading`,e.MANIFEST_LOADED=`hlsManifestLoaded`,e.MANIFEST_PARSED=`hlsManifestParsed`,e.LEVEL_SWITCHING=`hlsLevelSwitching`,e.LEVEL_SWITCHED=`hlsLevelSwitched`,e.LEVEL_LOADING=`hlsLevelLoading`,e.LEVEL_LOADED=`hlsLevelLoaded`,e.LEVEL_UPDATED=`hlsLevelUpdated`,e.LEVEL_PTS_UPDATED=`hlsLevelPtsUpdated`,e.LEVELS_UPDATED=`hlsLevelsUpdated`,e.AUDIO_TRACKS_UPDATED=`hlsAudioTracksUpdated`,e.AUDIO_TRACK_SWITCHING=`hlsAudioTrackSwitching`,e.AUDIO_TRACK_SWITCHED=`hlsAudioTrackSwitched`,e.AUDIO_TRACK_LOADING=`hlsAudioTrackLoading`,e.AUDIO_TRACK_LOADED=`hlsAudioTrackLoaded`,e.SUBTITLE_TRACKS_UPDATED=`hlsSubtitleTracksUpdated`,e.SUBTITLE_TRACKS_CLEARED=`hlsSubtitleTracksCleared`,e.SUBTITLE_TRACK_SWITCH=`hlsSubtitleTrackSwitch`,e.SUBTITLE_TRACK_LOADING=`hlsSubtitleTrackLoading`,e.SUBTITLE_TRACK_LOADED=`hlsSubtitleTrackLoaded`,e.SUBTITLE_FRAG_PROCESSED=`hlsSubtitleFragProcessed`,e.CUES_PARSED=`hlsCuesParsed`,e.NON_NATIVE_TEXT_TRACKS_FOUND=`hlsNonNativeTextTracksFound`,e.INIT_PTS_FOUND=`hlsInitPtsFound`,e.FRAG_LOADING=`hlsFragLoading`,e.FRAG_LOAD_EMERGENCY_ABORTED=`hlsFragLoadEmergencyAborted`,e.FRAG_LOADED=`hlsFragLoaded`,e.FRAG_DECRYPTED=`hlsFragDecrypted`,e.FRAG_PARSING_INIT_SEGMENT=`hlsFragParsingInitSegment`,e.FRAG_PARSING_USERDATA=`hlsFragParsingUserdata`,e.FRAG_PARSING_METADATA=`hlsFragParsingMetadata`,e.FRAG_PARSED=`hlsFragParsed`,e.FRAG_BUFFERED=`hlsFragBuffered`,e.FRAG_CHANGED=`hlsFragChanged`,e.FPS_DROP=`hlsFpsDrop`,e.FPS_DROP_LEVEL_CAPPING=`hlsFpsDropLevelCapping`,e.ERROR=`hlsError`,e.DESTROYING=`hlsDestroying`,e.KEY_LOADING=`hlsKeyLoading`,e.KEY_LOADED=`hlsKeyLoaded`,e.LIVE_BACK_BUFFER_REACHED=`hlsLiveBackBufferReached`,e.BACK_BUFFER_REACHED=`hlsBackBufferReached`})(r||={})}),"./src/hls.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return y});var r=n(`./node_modules/url-toolkit/src/url-toolkit.js`),i=n(`./src/loader/playlist-loader.ts`),a=n(`./src/loader/key-loader.ts`),o=n(`./src/controller/id3-track-controller.ts`),s=n(`./src/controller/latency-controller.ts`),c=n(`./src/controller/level-controller.ts`),l=n(`./src/controller/fragment-tracker.ts`),u=n(`./src/controller/stream-controller.ts`),d=n(`./src/is-supported.ts`),f=n(`./src/utils/logger.ts`),p=n(`./src/config.ts`),m=n(`./node_modules/eventemitter3/index.js`),h=n(`./src/events.ts`),g=n(`./src/errors.ts`);function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t&&_(e.prototype,t),n&&_(e,n),e}var y=function(){e.isSupported=function(){return(0,d.isSupported)()};function e(t){t===void 0&&(t={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new m.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var n=this.config=(0,p.mergeConfig)(e.DefaultConfig,t);this.userConfig=t,(0,f.enableLogs)(n.debug),this._autoLevelCapping=-1,n.progressive&&(0,p.enableStreamingMode)(n);var r=n.abrController,d=n.bufferController,h=n.capLevelController,g=n.fpsController,_=this.abrController=new r(this),v=this.bufferController=new d(this),y=this.capLevelController=new h(this),b=new g(this),x=new i.default(this),S=new a.default(this),C=new o.default(this),w=this.levelController=new c.default(this),T=new l.FragmentTracker(this),E=this.streamController=new u.default(this,T);y.setStreamController(E),b.setStreamController(E);var D=[w,E];this.networkControllers=D;var O=[x,S,_,v,y,b,C,T];this.audioTrackController=this.createController(n.audioTrackController,null,D),this.createController(n.audioStreamController,T,D),this.subtitleTrackController=this.createController(n.subtitleTrackController,null,D),this.createController(n.subtitleStreamController,T,D),this.createController(n.timelineController,null,O),this.emeController=this.createController(n.emeController,null,O),this.cmcdController=this.createController(n.cmcdController,null,O),this.latencyController=this.createController(s.default,null,O),this.coreComponents=O}var t=e.prototype;return t.createController=function(e,t,n){if(e){var r=t?new e(this,t):new e(this);return n&&n.push(r),r}return null},t.on=function(e,t,n){n===void 0&&(n=this),this._emitter.on(e,t,n)},t.once=function(e,t,n){n===void 0&&(n=this),this._emitter.once(e,t,n)},t.removeAllListeners=function(e){this._emitter.removeAllListeners(e)},t.off=function(e,t,n,r){n===void 0&&(n=this),this._emitter.off(e,t,n,r)},t.listeners=function(e){return this._emitter.listeners(e)},t.emit=function(e,t,n){return this._emitter.emit(e,t,n)},t.trigger=function(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){f.logger.error(`An internal error happened while handling event `+e+`. Error message: "`+t.message+`". Here is a stacktrace:`,t),this.trigger(h.Events.ERROR,{type:g.ErrorTypes.OTHER_ERROR,details:g.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:e,error:t})}return!1},t.listenerCount=function(e){return this._emitter.listenerCount(e)},t.destroy=function(){f.logger.log(`destroy`),this.trigger(h.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(e){return e.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(e){return e.destroy()}),this.coreComponents.length=0},t.attachMedia=function(e){f.logger.log(`attachMedia`),this._media=e,this.trigger(h.Events.MEDIA_ATTACHING,{media:e})},t.detachMedia=function(){f.logger.log(`detachMedia`),this.trigger(h.Events.MEDIA_DETACHING,void 0),this._media=null},t.loadSource=function(e){this.stopLoad();var t=this.media,n=this.url,i=this.url=r.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});f.logger.log(`loadSource:`+i),t&&n&&n!==i&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(t)),this.trigger(h.Events.MANIFEST_LOADING,{url:e})},t.startLoad=function(e){e===void 0&&(e=-1),f.logger.log(`startLoad(`+e+`)`),this.networkControllers.forEach(function(t){t.startLoad(e)})},t.stopLoad=function(){f.logger.log(`stopLoad`),this.networkControllers.forEach(function(e){e.stopLoad()})},t.swapAudioCodec=function(){f.logger.log(`swapAudioCodec`),this.streamController.swapAudioCodec()},t.recoverMediaError=function(){f.logger.log(`recoverMediaError`);var e=this._media;this.detachMedia(),e&&this.attachMedia(e)},t.removeLevel=function(e,t){t===void 0&&(t=0),this.levelController.removeLevel(e,t)},v(e,[{key:`levels`,get:function(){return this.levelController.levels||[]}},{key:`currentLevel`,get:function(){return this.streamController.currentLevel},set:function(e){f.logger.log(`set currentLevel:`+e),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:`nextLevel`,get:function(){return this.streamController.nextLevel},set:function(e){f.logger.log(`set nextLevel:`+e),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}},{key:`loadLevel`,get:function(){return this.levelController.level},set:function(e){f.logger.log(`set loadLevel:`+e),this.levelController.manualLevel=e}},{key:`nextLoadLevel`,get:function(){return this.levelController.nextLoadLevel},set:function(e){this.levelController.nextLoadLevel=e}},{key:`firstLevel`,get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(e){f.logger.log(`set firstLevel:`+e),this.levelController.firstLevel=e}},{key:`startLevel`,get:function(){return this.levelController.startLevel},set:function(e){f.logger.log(`set startLevel:`+e),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}},{key:`capLevelToPlayerSize`,get:function(){return this.config.capLevelToPlayerSize},set:function(e){var t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}},{key:`autoLevelCapping`,get:function(){return this._autoLevelCapping},set:function(e){this._autoLevelCapping!==e&&(f.logger.log(`set autoLevelCapping:`+e),this._autoLevelCapping=e)}},{key:`bandwidthEstimate`,get:function(){var e=this.abrController.bwEstimator;return e?e.getEstimate():NaN}},{key:`autoLevelEnabled`,get:function(){return this.levelController.manualLevel===-1}},{key:`manualLevel`,get:function(){return this.levelController.manualLevel}},{key:`minAutoLevel`,get:function(){var e=this.levels,t=this.config.minAutoBitrate;if(!e)return 0;for(var n=e.length,r=0;r<n;r++)if(e[r].maxBitrate>t)return r;return 0}},{key:`maxAutoLevel`,get:function(){var e=this.levels,t=this.autoLevelCapping;return t===-1&&e&&e.length?e.length-1:t}},{key:`nextAutoLevel`,get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}},{key:`audioTracks`,get:function(){var e=this.audioTrackController;return e?e.audioTracks:[]}},{key:`audioTrack`,get:function(){var e=this.audioTrackController;return e?e.audioTrack:-1},set:function(e){var t=this.audioTrackController;t&&(t.audioTrack=e)}},{key:`subtitleTracks`,get:function(){var e=this.subtitleTrackController;return e?e.subtitleTracks:[]}},{key:`subtitleTrack`,get:function(){var e=this.subtitleTrackController;return e?e.subtitleTrack:-1},set:function(e){var t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}},{key:`media`,get:function(){return this._media}},{key:`subtitleDisplay`,get:function(){var e=this.subtitleTrackController;return e?e.subtitleDisplay:!1},set:function(e){var t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}},{key:`lowLatencyMode`,get:function(){return this.config.lowLatencyMode},set:function(e){this.config.lowLatencyMode=e}},{key:`liveSyncPosition`,get:function(){return this.latencyController.liveSyncPosition}},{key:`latency`,get:function(){return this.latencyController.latency}},{key:`maxLatency`,get:function(){return this.latencyController.maxLatency}},{key:`targetLatency`,get:function(){return this.latencyController.targetLatency}},{key:`drift`,get:function(){return this.latencyController.drift}},{key:`forceStartLoad`,get:function(){return this.streamController.forceStartLoad}}],[{key:`version`,get:function(){return`1.1.3`}},{key:`Events`,get:function(){return h.Events}},{key:`ErrorTypes`,get:function(){return g.ErrorTypes}},{key:`ErrorDetails`,get:function(){return g.ErrorDetails}},{key:`DefaultConfig`,get:function(){return e.defaultConfig?e.defaultConfig:p.hlsDefaultConfig},set:function(t){e.defaultConfig=t}}]),e}();y.defaultConfig=void 0}),"./src/is-supported.ts":(function(e,t,n){n.r(t),n.d(t,`isSupported`,function(){return a}),n.d(t,`changeTypeSupported`,function(){return o});var r=n(`./src/utils/mediasource-helper.ts`);function i(){return self.SourceBuffer||self.WebKitSourceBuffer}function a(){var e=(0,r.getMediaSource)();if(!e)return!1;var t=i(),n=e&&typeof e.isTypeSupported==`function`&&e.isTypeSupported(`video/mp4; codecs="avc1.42E01E,mp4a.40.2"`),a=!t||t.prototype&&typeof t.prototype.appendBuffer==`function`&&typeof t.prototype.remove==`function`;return!!n&&!!a}function o(){return typeof i()?.prototype?.changeType==`function`}}),"./src/loader/fragment-loader.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return p}),n.d(t,`LoadError`,function(){return h});var r=n(`./src/polyfills/number.ts`),i=n(`./src/errors.ts`);function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,u(e,t)}function o(e){var t=typeof Map==`function`?new Map:void 0;return o=function(e){if(e===null||!l(e))return e;if(typeof e!=`function`)throw TypeError(`Super expression must either be null or a function`);if(t!==void 0){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return s(e,arguments,d(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),u(n,e)},o(e)}function s(e,t,n){return s=c()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&u(i,n.prototype),i},s.apply(null,arguments)}function c(){if(typeof Reflect>`u`||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy==`function`)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function l(e){return Function.toString.call(e).indexOf(`[native code]`)!==-1}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var f=2**17,p=function(){function e(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}var t=e.prototype;return t.destroy=function(){this.loader&&=(this.loader.destroy(),null)},t.abort=function(){this.loader&&this.loader.abort()},t.load=function(e,t){var n=this,r=e.url;if(!r)return Promise.reject(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,networkDetails:null},`Fragment does not have a `+(r?`part list`:`url`)));this.abort();var a=this.config,o=a.fLoader,s=a.loader;return new Promise(function(r,c){n.loader&&n.loader.destroy();var l=n.loader=e.loader=o?new o(a):new s(a),u=m(e),d={timeout:a.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:a.fragLoadingMaxRetryTimeout,highWaterMark:f};e.stats=l.stats,l.load(u,d,{onSuccess:function(t,i,a,o){n.resetLoader(e,l),r({frag:e,part:null,payload:t.data,networkDetails:o})},onError:function(t,r,a){n.resetLoader(e,l),c(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:t,networkDetails:a}))},onAbort:function(t,r,a){n.resetLoader(e,l),c(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,networkDetails:a}))},onTimeout:function(t,r,a){n.resetLoader(e,l),c(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,networkDetails:a}))},onProgress:function(n,r,i,a){t&&t({frag:e,part:null,payload:i,networkDetails:a})}})})},t.loadPart=function(e,t,n){var r=this;this.abort();var a=this.config,o=a.fLoader,s=a.loader;return new Promise(function(c,l){r.loader&&r.loader.destroy();var u=r.loader=e.loader=o?new o(a):new s(a),d=m(e,t),p={timeout:a.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:a.fragLoadingMaxRetryTimeout,highWaterMark:f};t.stats=u.stats,u.load(d,p,{onSuccess:function(i,a,o,s){r.resetLoader(e,u),r.updateStatsFromPart(e,t);var l={frag:e,part:t,payload:i.data,networkDetails:s};n(l),c(l)},onError:function(n,a,o){r.resetLoader(e,u),l(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:n,networkDetails:o}))},onAbort:function(n,a,o){e.stats.aborted=t.stats.aborted,r.resetLoader(e,u),l(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,networkDetails:o}))},onTimeout:function(n,a,o){r.resetLoader(e,u),l(new h({type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,networkDetails:o}))}})})},t.updateStatsFromPart=function(e,t){var n=e.stats,r=t.stats,i=r.total;if(n.loaded+=r.loaded,i){var a=Math.round(e.duration/t.duration),o=Math.min(Math.round(n.loaded/i),a),s=(a-o)*Math.round(n.loaded/o);n.total=n.loaded+s}else n.total=Math.max(n.loaded,n.total);var c=n.loading,l=r.loading;c.start?c.first+=l.first-l.start:(c.start=l.start,c.first=l.first),c.end=l.end},t.resetLoader=function(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()},e}();function m(e,t){t===void 0&&(t=null);var n=t||e,i={frag:e,part:t,responseType:`arraybuffer`,url:n.url,headers:{},rangeStart:0,rangeEnd:0},a=n.byteRangeStartOffset,o=n.byteRangeEndOffset;return(0,r.isFiniteNumber)(a)&&(0,r.isFiniteNumber)(o)&&(i.rangeStart=a,i.rangeEnd=o),i}var h=function(e){a(t,e);function t(t){var n,r=[...arguments].slice(1);return n=e.call.apply(e,[this].concat(r))||this,n.data=void 0,n.data=t,n}return t}(o(Error))}),"./src/loader/fragment.ts":(function(e,t,n){n.r(t),n.d(t,`ElementaryStreamTypes`,function(){return f}),n.d(t,`BaseSegment`,function(){return p}),n.d(t,`Fragment`,function(){return m}),n.d(t,`Part`,function(){return h});var r=n(`./src/polyfills/number.ts`),i=n(`./node_modules/url-toolkit/src/url-toolkit.js`),a=n(`./src/utils/logger.ts`),o=n(`./src/loader/level-key.ts`),s=n(`./src/loader/load-stats.ts`);function c(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,l(e,t)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}var f;(function(e){e.AUDIO=`audio`,e.VIDEO=`video`,e.AUDIOVIDEO=`audiovideo`})(f||={});var p=function(){function e(e){var t;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(t={},t[f.AUDIO]=null,t[f.VIDEO]=null,t[f.AUDIOVIDEO]=null,t),this.baseurl=e}var t=e.prototype;return t.setByteRange=function(e,t){var n=e.split(`@`,2),r=[];n.length===1?r[0]=t?t.byteRangeEndOffset:0:r[0]=parseInt(n[1]),r[1]=parseInt(n[0])+r[0],this._byteRange=r},d(e,[{key:`byteRange`,get:function(){return this._byteRange?this._byteRange:[]}},{key:`byteRangeStartOffset`,get:function(){return this.byteRange[0]}},{key:`byteRangeEndOffset`,get:function(){return this.byteRange[1]}},{key:`url`,get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=(0,i.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||``},set:function(e){this._url=e}}]),e}(),m=function(e){c(t,e);function t(t,n){var r=e.call(this,n)||this;return r._decryptdata=null,r.rawProgramDateTime=null,r.programDateTime=null,r.tagList=[],r.duration=0,r.sn=0,r.levelkey=void 0,r.type=void 0,r.loader=null,r.level=-1,r.cc=0,r.startPTS=void 0,r.endPTS=void 0,r.appendedPTS=void 0,r.startDTS=void 0,r.endDTS=void 0,r.start=0,r.deltaPTS=void 0,r.maxStartPTS=void 0,r.minEndPTS=void 0,r.stats=new s.LoadStats,r.urlId=0,r.data=void 0,r.bitrateTest=!1,r.title=null,r.initSegment=null,r.type=t,r}var n=t.prototype;return n.createInitializationVector=function(e){for(var t=new Uint8Array(16),n=12;n<16;n++)t[n]=e>>8*(15-n)&255;return t},n.setDecryptDataFromLevelKey=function(e,t){var n=e;return e?.method===`AES-128`&&e.uri&&!e.iv&&(n=o.LevelKey.fromURI(e.uri),n.method=e.method,n.iv=this.createInitializationVector(t),n.keyFormat=`identity`),n},n.setElementaryStreamInfo=function(e,t,n,r,i,a){a===void 0&&(a=!1);var o=this.elementaryStreams,s=o[e];if(!s){o[e]={startPTS:t,endPTS:n,startDTS:r,endDTS:i,partial:a};return}s.startPTS=Math.min(s.startPTS,t),s.endPTS=Math.max(s.endPTS,n),s.startDTS=Math.min(s.startDTS,r),s.endDTS=Math.max(s.endDTS,i)},n.clearElementaryStreamInfo=function(){var e=this.elementaryStreams;e[f.AUDIO]=null,e[f.VIDEO]=null,e[f.AUDIOVIDEO]=null},d(t,[{key:`decryptdata`,get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var e=this.sn;typeof e!=`number`&&(this.levelkey&&this.levelkey.method===`AES-128`&&!this.levelkey.iv&&a.logger.warn(`missing IV for initialization segment with method="`+this.levelkey.method+`" - compliance issue`),e=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,e)}return this._decryptdata}},{key:`end`,get:function(){return this.start+this.duration}},{key:`endProgramDateTime`,get:function(){if(this.programDateTime===null||!(0,r.isFiniteNumber)(this.programDateTime))return null;var e=(0,r.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+e*1e3}},{key:`encrypted`,get:function(){var e;return!!((e=this.decryptdata)!=null&&e.keyFormat&&this.decryptdata.uri)}}]),t}(p),h=function(e){c(t,e);function t(t,n,r,i,a){var o=e.call(this,r)||this;o.fragOffset=0,o.duration=0,o.gap=!1,o.independent=!1,o.relurl=void 0,o.fragment=void 0,o.index=void 0,o.stats=new s.LoadStats,o.duration=t.decimalFloatingPoint(`DURATION`),o.gap=t.bool(`GAP`),o.independent=t.bool(`INDEPENDENT`),o.relurl=t.enumeratedString(`URI`),o.fragment=n,o.index=i;var c=t.enumeratedString(`BYTERANGE`);return c&&o.setByteRange(c,a),a&&(o.fragOffset=a.fragOffset+a.duration),o}return d(t,[{key:`start`,get:function(){return this.fragment.start+this.fragOffset}},{key:`end`,get:function(){return this.start+this.duration}},{key:`loaded`,get:function(){var e=this.elementaryStreams;return!!(e.audio||e.video||e.audiovideo)}}]),t}(p)}),"./src/loader/key-loader.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return o});var r=n(`./src/events.ts`),i=n(`./src/errors.ts`),a=n(`./src/utils/logger.ts`),o=function(){function e(e){this.hls=void 0,this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=e,this._registerListeners()}var t=e.prototype;return t._registerListeners=function(){this.hls.on(r.Events.KEY_LOADING,this.onKeyLoading,this)},t._unregisterListeners=function(){this.hls.off(r.Events.KEY_LOADING,this.onKeyLoading)},t.destroy=function(){for(var e in this._unregisterListeners(),this.loaders){var t=this.loaders[e];t&&t.destroy()}this.loaders={}},t.onKeyLoading=function(e,t){var n=t.frag,i=n.type,o=this.loaders[i];if(!n.decryptdata){a.logger.warn(`Missing decryption data on fragment in onKeyLoading`);return}var s=n.decryptdata.uri;if(s!==this.decrypturl||this.decryptkey===null){var c=this.hls.config;if(o&&(a.logger.warn(`abort previous key loader for type:`+i),o.abort()),!s){a.logger.warn(`key uri is falsy`);return}var l=c.loader,u=n.loader=this.loaders[i]=new l(c);this.decrypturl=s,this.decryptkey=null;var d={url:s,frag:n,responseType:`arraybuffer`},f={timeout:c.fragLoadingTimeOut,maxRetry:0,retryDelay:c.fragLoadingRetryDelay,maxRetryDelay:c.fragLoadingMaxRetryTimeout,highWaterMark:0},p={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};u.load(d,f,p)}else this.decryptkey&&(n.decryptdata.key=this.decryptkey,this.hls.trigger(r.Events.KEY_LOADED,{frag:n}))},t.loadsuccess=function(e,t,n){var i=n.frag;if(!i.decryptdata){a.logger.error(`after key load, decryptdata unset`);return}this.decryptkey=i.decryptdata.key=new Uint8Array(e.data),i.loader=null,delete this.loaders[i.type],this.hls.trigger(r.Events.KEY_LOADED,{frag:i})},t.loaderror=function(e,t){var n=t.frag,a=n.loader;a&&a.abort(),delete this.loaders[n.type],this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:n,response:e})},t.loadtimeout=function(e,t){var n=t.frag,a=n.loader;a&&a.abort(),delete this.loaders[n.type],this.hls.trigger(r.Events.ERROR,{type:i.ErrorTypes.NETWORK_ERROR,details:i.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:n})},e}()}),"./src/loader/level-details.ts":(function(e,t,n){n.r(t),n.d(t,`LevelDetails`,function(){return s});var r=n(`./src/polyfills/number.ts`);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var o=10,s=function(){function e(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8=``,this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.url=e}var t=e.prototype;return t.reloaded=function(e){if(!e){this.advanced=!0,this.updated=!0;return}var t=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!t,this.advanced=this.endSN>e.endSN||t>0||t===0&&n>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay},a(e,[{key:`hasProgramDateTime`,get:function(){return this.fragments.length?(0,r.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:`levelTargetDuration`,get:function(){return this.averagetargetduration||this.targetduration||o}},{key:`drift`,get:function(){var e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}},{key:`edge`,get:function(){return this.partEnd||this.fragmentEnd}},{key:`partEnd`,get:function(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:`fragmentEnd`,get:function(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}},{key:`age`,get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:`lastPartIndex`,get:function(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}},{key:`lastPartSn`,get:function(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),e}()}),"./src/loader/level-key.ts":(function(e,t,n){n.r(t),n.d(t,`LevelKey`,function(){return o});var r=n(`./node_modules/url-toolkit/src/url-toolkit.js`);function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var o=function(){e.fromURL=function(t,n){return new e(t,n)},e.fromURI=function(t){return new e(t)};function e(e,t){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,t?this._uri=(0,r.buildAbsoluteURL)(e,t,{alwaysNormalize:!0}):this._uri=e}return a(e,[{key:`uri`,get:function(){return this._uri}}]),e}()}),"./src/loader/load-stats.ts":(function(e,t,n){n.r(t),n.d(t,`LoadStats`,function(){return r});var r=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}),"./src/loader/m3u8-parser.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return _});var r=n(`./src/polyfills/number.ts`),i=n(`./node_modules/url-toolkit/src/url-toolkit.js`),a=n(`./src/loader/fragment.ts`),o=n(`./src/loader/level-details.ts`),s=n(`./src/loader/level-key.ts`),c=n(`./src/utils/attr-list.ts`),l=n(`./src/utils/logger.ts`),u=n(`./src/utils/codecs.ts`),d=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,f=/#EXT-X-MEDIA:(.*)/g,p=new RegExp([`#EXTINF:\\s*(\\d*(?:\\.\\d+)?)(?:,(.*)\\s+)?`,`(?!#) *(\\S[\\S ]*)`,`#EXT-X-BYTERANGE:*(.+)`,`#EXT-X-PROGRAM-DATE-TIME:(.+)`,`#.*`].join(`|`),`g`),m=new RegExp([`#(EXTM3U)`,`#EXT-X-(PLAYLIST-TYPE):(.+)`,`#EXT-X-(MEDIA-SEQUENCE): *(\\d+)`,`#EXT-X-(SKIP):(.+)`,`#EXT-X-(TARGETDURATION): *(\\d+)`,`#EXT-X-(KEY):(.+)`,`#EXT-X-(START):(.+)`,`#EXT-X-(ENDLIST)`,`#EXT-X-(DISCONTINUITY-SEQ)UENCE: *(\\d+)`,`#EXT-X-(DIS)CONTINUITY`,`#EXT-X-(VERSION):(\\d+)`,`#EXT-X-(MAP):(.+)`,`#EXT-X-(SERVER-CONTROL):(.+)`,`#EXT-X-(PART-INF):(.+)`,`#EXT-X-(GAP)`,`#EXT-X-(BITRATE):\\s*(\\d+)`,`#EXT-X-(PART):(.+)`,`#EXT-X-(PRELOAD-HINT):(.+)`,`#EXT-X-(RENDITION-REPORT):(.+)`,`(#)([^:]*):(.*)`,`(#)(.*)(?:.*)\\r?\\n?`].join(`|`)),h=/\.(mp4|m4s|m4v|m4a)$/i;function g(e){return h.test(i.parseURL(e)?.path??``)}var _=function(){function e(){}return e.findGroup=function(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(r.id===t)return r}},e.convertAVC1ToAVCOTI=function(e){var t=e.split(`.`);if(t.length>2){var n=t.shift()+`.`;return n+=parseInt(t.shift()).toString(16),n+=(`000`+parseInt(t.shift()).toString(16)).substr(-4),n}return e},e.resolve=function(e,t){return i.buildAbsoluteURL(t,e,{alwaysNormalize:!0})},e.parseMasterPlaylist=function(t,n){var r=[],i={},a=!1;d.lastIndex=0;for(var o;(o=d.exec(t))!=null;)if(o[1]){var s=new c.AttrList(o[1]),l={attrs:s,bitrate:s.decimalInteger(`AVERAGE-BANDWIDTH`)||s.decimalInteger(`BANDWIDTH`),name:s.NAME,url:e.resolve(o[2],n)},u=s.decimalResolution(`RESOLUTION`);u&&(l.width=u.width,l.height=u.height),v((s.CODECS||``).split(/[ ,]+/).filter(function(e){return e}),l),l.videoCodec&&l.videoCodec.indexOf(`avc1`)!==-1&&(l.videoCodec=e.convertAVC1ToAVCOTI(l.videoCodec)),r.push(l)}else if(o[3]){var f=new c.AttrList(o[3]);f[`DATA-ID`]&&(a=!0,i[f[`DATA-ID`]]=f)}return{levels:r,sessionData:a?i:null}},e.parseMasterPlaylistMedia=function(t,n,r,i){i===void 0&&(i=[]);var a,o=[],s=0;for(f.lastIndex=0;(a=f.exec(t))!==null;){var l=new c.AttrList(a[1]);if(l.TYPE===r){var u={attrs:l,bitrate:0,id:s++,groupId:l[`GROUP-ID`],instreamId:l[`INSTREAM-ID`],name:l.NAME||l.LANGUAGE||``,type:r,default:l.bool(`DEFAULT`),autoselect:l.bool(`AUTOSELECT`),forced:l.bool(`FORCED`),lang:l.LANGUAGE,url:l.URI?e.resolve(l.URI,n):``};if(i.length){var d=e.findGroup(i,u.groupId)||i[0];y(u,d,`audioCodec`),y(u,d,`textCodec`)}o.push(u)}}return o},e.parseLevelPlaylist=function(e,t,n,i,u){var d=new o.LevelDetails(t),f=d.fragments,h=null,_=0,v=0,y=0,S=0,C=null,w=new a.Fragment(i,t),T,E,D,O=-1,k=!1;for(p.lastIndex=0,d.m3u8=e;(T=p.exec(e))!==null;){k&&(k=!1,w=new a.Fragment(i,t),w.start=y,w.sn=_,w.cc=S,w.level=n,h&&(w.initSegment=h,w.rawProgramDateTime=h.rawProgramDateTime));var A=T[1];if(A){w.duration=parseFloat(A);var j=(` `+T[2]).slice(1);w.title=j||null,w.tagList.push(j?[`INF`,A,j]:[`INF`,A])}else if(T[3])(0,r.isFiniteNumber)(w.duration)&&(w.start=y,D&&(w.levelkey=D),w.sn=_,w.level=n,w.cc=S,w.urlId=u,f.push(w),w.relurl=(` `+T[3]).slice(1),x(w,C),C=w,y+=w.duration,_++,v=0,k=!0);else if(T[4]){var M=(` `+T[4]).slice(1);C?w.setByteRange(M,C):w.setByteRange(M)}else if(T[5])w.rawProgramDateTime=(` `+T[5]).slice(1),w.tagList.push([`PROGRAM-DATE-TIME`,w.rawProgramDateTime]),O===-1&&(O=f.length);else{if(T=T[0].match(m),!T){l.logger.warn(`No matches on slow regex match for level playlist!`);continue}for(E=1;E<T.length&&T[E]===void 0;E++);var N=(` `+T[E]).slice(1),P=(` `+T[E+1]).slice(1),F=T[E+2]?(` `+T[E+2]).slice(1):``;switch(N){case`PLAYLIST-TYPE`:d.type=P.toUpperCase();break;case`MEDIA-SEQUENCE`:_=d.startSN=parseInt(P);break;case`SKIP`:var I=new c.AttrList(P),L=I.decimalInteger(`SKIPPED-SEGMENTS`);if((0,r.isFiniteNumber)(L)){d.skippedSegments=L;for(var R=L;R--;)f.unshift(null);_+=L}var z=I.enumeratedString(`RECENTLY-REMOVED-DATERANGES`);z&&(d.recentlyRemovedDateranges=z.split(`	`));break;case`TARGETDURATION`:d.targetduration=parseFloat(P);break;case`VERSION`:d.version=parseInt(P);break;case`EXTM3U`:break;case`ENDLIST`:d.live=!1;break;case`#`:(P||F)&&w.tagList.push(F?[P,F]:[P]);break;case`DIS`:S++;case`GAP`:w.tagList.push([N]);break;case`BITRATE`:w.tagList.push([N,P]);break;case`DISCONTINUITY-SEQ`:S=parseInt(P);break;case`KEY`:var B=new c.AttrList(P),V=B.enumeratedString(`METHOD`),H=B.URI,U=B.hexadecimalInteger(`IV`),W=B.enumeratedString(`KEYFORMATVERSIONS`),G=B.enumeratedString(`KEYID`),K=B.enumeratedString(`KEYFORMAT`)??`identity`;if([`com.apple.streamingkeydelivery`,`com.microsoft.playready`,`urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed`,`com.widevine`].indexOf(K)>-1){l.logger.warn(`Keyformat `+K+` is not supported from the manifest`);continue}else if(K!==`identity`)continue;V&&(D=s.LevelKey.fromURL(t,H),H&&[`AES-128`,`SAMPLE-AES`,`SAMPLE-AES-CENC`].indexOf(V)>=0&&(D.method=V,D.keyFormat=K,G&&(D.keyID=G),W&&(D.keyFormatVersions=W),D.iv=U));break;case`START`:var q=new c.AttrList(P).decimalFloatingPoint(`TIME-OFFSET`);(0,r.isFiniteNumber)(q)&&(d.startTimeOffset=q);break;case`MAP`:var J=new c.AttrList(P);w.relurl=J.URI,J.BYTERANGE&&w.setByteRange(J.BYTERANGE),w.level=n,w.sn=`initSegment`,D&&(w.levelkey=D),w.initSegment=null,h=w,k=!0;break;case`SERVER-CONTROL`:var Y=new c.AttrList(P);d.canBlockReload=Y.bool(`CAN-BLOCK-RELOAD`),d.canSkipUntil=Y.optionalFloat(`CAN-SKIP-UNTIL`,0),d.canSkipDateRanges=d.canSkipUntil>0&&Y.bool(`CAN-SKIP-DATERANGES`),d.partHoldBack=Y.optionalFloat(`PART-HOLD-BACK`,0),d.holdBack=Y.optionalFloat(`HOLD-BACK`,0);break;case`PART-INF`:d.partTarget=new c.AttrList(P).decimalFloatingPoint(`PART-TARGET`);break;case`PART`:var X=d.partList;X||=d.partList=[];var ee=v>0?X[X.length-1]:void 0,te=v++,ne=new a.Part(new c.AttrList(P),w,t,te,ee);X.push(ne),w.duration+=ne.duration;break;case`PRELOAD-HINT`:d.preloadHint=new c.AttrList(P);break;case`RENDITION-REPORT`:var re=new c.AttrList(P);d.renditionReports=d.renditionReports||[],d.renditionReports.push(re);break;default:l.logger.warn(`line parsed but not handled: `+T);break}}}C&&!C.relurl?(f.pop(),y-=C.duration,d.partList&&(d.fragmentHint=C)):d.partList&&(x(w,C),w.cc=S,d.fragmentHint=w);var Z=f.length,Q=f[0],ie=f[Z-1];if(y+=d.skippedSegments*d.targetduration,y>0&&Z&&ie){d.averagetargetduration=y/Z;var $=ie.sn;d.endSN=$===`initSegment`?0:$,Q&&(d.startCC=Q.cc,Q.initSegment||d.fragments.every(function(e){return e.relurl&&g(e.relurl)})&&(l.logger.warn(`MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX`),w=new a.Fragment(i,t),w.relurl=ie.relurl,w.level=n,w.sn=`initSegment`,Q.initSegment=w,d.needSidxRanges=!0))}else d.endSN=0,d.startCC=0;return d.fragmentHint&&(y+=d.fragmentHint.duration),d.totalduration=y,d.endCC=S,O>0&&b(f,O),d},e}();function v(e,t){[`video`,`audio`,`text`].forEach(function(n){var r=e.filter(function(e){return(0,u.isCodecType)(e,n)});if(r.length){var i=r.filter(function(e){return e.lastIndexOf(`avc1`,0)===0||e.lastIndexOf(`mp4a`,0)===0});t[n+`Codec`]=i.length>0?i[0]:r[0],e=e.filter(function(e){return r.indexOf(e)===-1})}}),t.unknownCodecs=e}function y(e,t,n){var r=t[n];r&&(e[n]=r)}function b(e,t){for(var n=e[t],r=t;r--;){var i=e[r];if(!i)return;i.programDateTime=n.programDateTime-i.duration*1e3,n=i}}function x(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):t!=null&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),(0,r.isFiniteNumber)(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}}),"./src/loader/playlist-loader.ts":(function(e,t,n){n.r(t);var r=n(`./src/polyfills/number.ts`),i=n(`./src/events.ts`),a=n(`./src/errors.ts`),o=n(`./src/utils/logger.ts`),s=n(`./src/utils/mp4-tools.ts`),c=n(`./src/loader/m3u8-parser.ts`),l=n(`./src/types/loader.ts`),u=n(`./src/utils/attr-list.ts`);function d(e){switch(e.type){case l.PlaylistContextType.AUDIO_TRACK:return l.PlaylistLevelType.AUDIO;case l.PlaylistContextType.SUBTITLE_TRACK:return l.PlaylistLevelType.SUBTITLE;default:return l.PlaylistLevelType.MAIN}}function f(e,t){var n=e.url;return(n===void 0||n.indexOf(`data:`)===0)&&(n=t.url),n}t.default=function(){function e(e){this.hls=void 0,this.loaders=Object.create(null),this.hls=e,this.registerListeners()}var t=e.prototype;return t.registerListeners=function(){var e=this.hls;e.on(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(i.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(i.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(i.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},t.unregisterListeners=function(){var e=this.hls;e.off(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(i.Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(i.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(i.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},t.createInternalLoader=function(e){var t=this.hls.config,n=t.pLoader,r=t.loader,i=new(n||r)(t);return e.loader=i,this.loaders[e.type]=i,i},t.getInternalLoader=function(e){return this.loaders[e.type]},t.resetInternalLoader=function(e){this.loaders[e]&&delete this.loaders[e]},t.destroyInternalLoaders=function(){for(var e in this.loaders){var t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}},t.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},t.onManifestLoading=function(e,t){var n=t.url;this.load({id:null,groupId:null,level:0,responseType:`text`,type:l.PlaylistContextType.MANIFEST,url:n,deliveryDirectives:null})},t.onLevelLoading=function(e,t){var n=t.id,r=t.level,i=t.url,a=t.deliveryDirectives;this.load({id:n,groupId:null,level:r,responseType:`text`,type:l.PlaylistContextType.LEVEL,url:i,deliveryDirectives:a})},t.onAudioTrackLoading=function(e,t){var n=t.id,r=t.groupId,i=t.url,a=t.deliveryDirectives;this.load({id:n,groupId:r,level:null,responseType:`text`,type:l.PlaylistContextType.AUDIO_TRACK,url:i,deliveryDirectives:a})},t.onSubtitleTrackLoading=function(e,t){var n=t.id,r=t.groupId,i=t.url,a=t.deliveryDirectives;this.load({id:n,groupId:r,level:null,responseType:`text`,type:l.PlaylistContextType.SUBTITLE_TRACK,url:i,deliveryDirectives:a})},t.load=function(e){var t,n=this.hls.config,r=this.getInternalLoader(e);if(r){var i=r.context;if(i&&i.url===e.url){o.logger.trace(`[playlist-loader]: playlist request ongoing`);return}o.logger.log(`[playlist-loader]: aborting previous loader for type: `+e.type),r.abort()}var a,s,c,u;switch(e.type){case l.PlaylistContextType.MANIFEST:a=n.manifestLoadingMaxRetry,s=n.manifestLoadingTimeOut,c=n.manifestLoadingRetryDelay,u=n.manifestLoadingMaxRetryTimeout;break;case l.PlaylistContextType.LEVEL:case l.PlaylistContextType.AUDIO_TRACK:case l.PlaylistContextType.SUBTITLE_TRACK:a=0,s=n.levelLoadingTimeOut;break;default:a=n.levelLoadingMaxRetry,s=n.levelLoadingTimeOut,c=n.levelLoadingRetryDelay,u=n.levelLoadingMaxRetryTimeout;break}if(r=this.createInternalLoader(e),(t=e.deliveryDirectives)!=null&&t.part){var d;if(e.type===l.PlaylistContextType.LEVEL&&e.level!==null?d=this.hls.levels[e.level].details:e.type===l.PlaylistContextType.AUDIO_TRACK&&e.id!==null?d=this.hls.audioTracks[e.id].details:e.type===l.PlaylistContextType.SUBTITLE_TRACK&&e.id!==null&&(d=this.hls.subtitleTracks[e.id].details),d){var f=d.partTarget,p=d.targetduration;f&&p&&(s=Math.min(Math.max(f*3,p*.8)*1e3,s))}}var m={timeout:s,maxRetry:a,retryDelay:c,maxRetryDelay:u,highWaterMark:0},h={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};r.load(e,m,h)},t.loadsuccess=function(e,t,n,r){if(r===void 0&&(r=null),n.isSidxRequest){this.handleSidxRequest(e,n),this.handlePlaylistLoaded(e,t,n,r);return}this.resetInternalLoader(n.type);var i=e.data;if(i.indexOf(`#EXTM3U`)!==0){this.handleManifestParsingError(e,n,`no EXTM3U delimiter`,r);return}t.parsing.start=performance.now(),i.indexOf(`#EXTINF:`)>0||i.indexOf(`#EXT-X-TARGETDURATION:`)>0?this.handleTrackOrLevelPlaylist(e,t,n,r):this.handleMasterPlaylist(e,t,n,r)},t.loaderror=function(e,t,n){n===void 0&&(n=null),this.handleNetworkError(t,n,!1,e)},t.loadtimeout=function(e,t,n){n===void 0&&(n=null),this.handleNetworkError(t,n,!0)},t.handleMasterPlaylist=function(e,t,n,r){var a=this.hls,s=e.data,l=f(e,n),d=c.default.parseMasterPlaylist(s,l),p=d.levels,m=d.sessionData;if(!p.length){this.handleManifestParsingError(e,n,`no level found in manifest`,r);return}var h=p.map(function(e){return{id:e.attrs.AUDIO,audioCodec:e.audioCodec}}),g=p.map(function(e){return{id:e.attrs.SUBTITLES,textCodec:e.textCodec}}),_=c.default.parseMasterPlaylistMedia(s,l,`AUDIO`,h),v=c.default.parseMasterPlaylistMedia(s,l,`SUBTITLES`,g),y=c.default.parseMasterPlaylistMedia(s,l,`CLOSED-CAPTIONS`);_.length&&!_.some(function(e){return!e.url})&&p[0].audioCodec&&!p[0].attrs.AUDIO&&(o.logger.log(`[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one`),_.unshift({type:`main`,name:`main`,default:!1,autoselect:!1,forced:!1,id:-1,attrs:new u.AttrList({}),bitrate:0,url:``})),a.trigger(i.Events.MANIFEST_LOADED,{levels:p,audioTracks:_,subtitles:v,captions:y,url:l,stats:t,networkDetails:r,sessionData:m})},t.handleTrackOrLevelPlaylist=function(e,t,n,o){var s=this.hls,p=n.id,m=n.level,h=n.type,g=f(e,n),_=(0,r.isFiniteNumber)(p)?p:0,v=(0,r.isFiniteNumber)(m)?m:_,y=d(n),b=c.default.parseLevelPlaylist(e.data,g,v,y,_);if(!b.fragments.length){s.trigger(i.Events.ERROR,{type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:g,reason:`no fragments found in level`,level:typeof n.level==`number`?n.level:void 0});return}if(h===l.PlaylistContextType.MANIFEST){var x={attrs:new u.AttrList({}),bitrate:0,details:b,name:``,url:g};s.trigger(i.Events.MANIFEST_LOADED,{levels:[x],audioTracks:[],url:g,stats:t,networkDetails:o,sessionData:null})}if(t.parsing.end=performance.now(),b.needSidxRanges){var S=b.fragments[0].initSegment?.url;this.load({url:S,isSidxRequest:!0,type:h,level:m,levelDetails:b,id:p,groupId:null,rangeStart:0,rangeEnd:2048,responseType:`arraybuffer`,deliveryDirectives:null});return}n.levelDetails=b,this.handlePlaylistLoaded(e,t,n,o)},t.handleSidxRequest=function(e,t){var n=(0,s.parseSegmentIndex)(new Uint8Array(e.data));if(n){var r=n.references,i=t.levelDetails;r.forEach(function(e,t){var r=e.info,a=i.fragments[t];a.byteRange.length===0&&a.setByteRange(String(1+r.end-r.start)+`@`+String(r.start)),a.initSegment&&a.initSegment.setByteRange(String(n.moovEndOffset)+`@0`)})}},t.handleManifestParsingError=function(e,t,n,r){this.hls.trigger(i.Events.ERROR,{type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:t.type===l.PlaylistContextType.MANIFEST,url:e.url,reason:n,response:e,context:t,networkDetails:r})},t.handleNetworkError=function(e,t,n,r){n===void 0&&(n=!1),o.logger.warn(`[playlist-loader]: A network `+(n?`timeout`:`error`)+` occurred while loading `+e.type+` level: `+e.level+` id: `+e.id+` group-id: "`+e.groupId+`"`);var s=a.ErrorDetails.UNKNOWN,c=!1,u=this.getInternalLoader(e);switch(e.type){case l.PlaylistContextType.MANIFEST:s=n?a.ErrorDetails.MANIFEST_LOAD_TIMEOUT:a.ErrorDetails.MANIFEST_LOAD_ERROR,c=!0;break;case l.PlaylistContextType.LEVEL:s=n?a.ErrorDetails.LEVEL_LOAD_TIMEOUT:a.ErrorDetails.LEVEL_LOAD_ERROR,c=!1;break;case l.PlaylistContextType.AUDIO_TRACK:s=n?a.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:a.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case l.PlaylistContextType.SUBTITLE_TRACK:s=n?a.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:a.ErrorDetails.SUBTITLE_LOAD_ERROR,c=!1;break}u&&this.resetInternalLoader(e.type);var d={type:a.ErrorTypes.NETWORK_ERROR,details:s,fatal:c,url:e.url,loader:u,context:e,networkDetails:t};r&&(d.response=r),this.hls.trigger(i.Events.ERROR,d)},t.handlePlaylistLoaded=function(e,t,n,r){var a=n.type,o=n.level,s=n.id,c=n.groupId,u=n.loader,d=n.levelDetails,f=n.deliveryDirectives;if(!(d!=null&&d.targetduration)){this.handleManifestParsingError(e,n,`invalid target duration`,r);return}if(u)switch(d.live&&(u.getCacheAge&&(d.ageHeader=u.getCacheAge()||0),(!u.getCacheAge||isNaN(d.ageHeader))&&(d.ageHeader=0)),a){case l.PlaylistContextType.MANIFEST:case l.PlaylistContextType.LEVEL:this.hls.trigger(i.Events.LEVEL_LOADED,{details:d,level:o||0,id:s||0,stats:t,networkDetails:r,deliveryDirectives:f});break;case l.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(i.Events.AUDIO_TRACK_LOADED,{details:d,id:s||0,groupId:c||``,stats:t,networkDetails:r,deliveryDirectives:f});break;case l.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(i.Events.SUBTITLE_TRACK_LOADED,{details:d,id:s||0,groupId:c||``,stats:t,networkDetails:r,deliveryDirectives:f});break}},e}()}),"./src/polyfills/number.ts":(function(e,t,n){n.r(t),n.d(t,`isFiniteNumber`,function(){return r}),n.d(t,`MAX_SAFE_INTEGER`,function(){return i});var r=Number.isFinite||function(e){return typeof e==`number`&&isFinite(e)},i=2**53-1||9007199254740991}),"./src/remux/aac-helper.ts":(function(e,t,n){n.r(t),t.default=function(){function e(){}return e.getSilentFrame=function(e,t){switch(e){case`mp4a.40.2`:if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2||t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},e}()}),"./src/remux/mp4-generator.ts":(function(e,t,n){n.r(t);var r=2**32-1,i=function(){function e(){}return e.init=function(){for(var t in e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);e.HDLR_TYPES={video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])};var n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);e.STTS=e.STSC=e.STCO=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var r=new Uint8Array([105,115,111,109]),i=new Uint8Array([97,118,99,49]),a=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,r,a,r,i),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,n))},e.box=function(e){for(var t=8,n=[...arguments].slice(1),r=n.length,i=r;r--;)t+=n[r].byteLength;var a=new Uint8Array(t);for(a[0]=t>>24&255,a[1]=t>>16&255,a[2]=t>>8&255,a[3]=t&255,a.set(e,4),r=0,t=8;r<i;r++)a.set(n[r],t),t+=n[r].byteLength;return a},e.hdlr=function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])},e.mdat=function(t){return e.box(e.types.mdat,t)},e.mdhd=function(t,n){n*=t;var i=Math.floor(n/(r+1)),a=Math.floor(n%(r+1));return e.box(e.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,a>>24,a>>16&255,a>>8&255,a&255,85,196,0,0]))},e.mdia=function(t){return e.box(e.types.mdia,e.mdhd(t.timescale,t.duration),e.hdlr(t.type),e.minf(t))},e.mfhd=function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))},e.minf=function(t){return t.type===`audio`?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))},e.moof=function(t,n,r){return e.box(e.types.moof,e.mfhd(t),e.traf(r,n))},e.moov=function(t){for(var n=t.length,r=[];n--;)r[n]=e.trak(t[n]);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].timescale,t[0].duration)].concat(r,e.mvex(t)))},e.mvex=function(t){for(var n=t.length,r=[];n--;)r[n]=e.trex(t[n]);return e.box.apply(null,[e.types.mvex].concat(r))},e.mvhd=function(t,n){n*=t;var i=Math.floor(n/(r+1)),a=Math.floor(n%(r+1)),o=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,a>>24,a>>16&255,a>>8&255,a&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,o)},e.sdtp=function(t){var n=t.samples||[],r=new Uint8Array(4+n.length),i,a;for(i=0;i<n.length;i++)a=n[i].flags,r[i+4]=a.dependsOn<<4|a.isDependedOn<<2|a.hasRedundancy;return e.box(e.types.sdtp,r)},e.stbl=function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))},e.avc1=function(t){var n=[],r=[],i,a,o;for(i=0;i<t.sps.length;i++)a=t.sps[i],o=a.byteLength,n.push(o>>>8&255),n.push(o&255),n=n.concat(Array.prototype.slice.call(a));for(i=0;i<t.pps.length;i++)a=t.pps[i],o=a.byteLength,r.push(o>>>8&255),r.push(o&255),r=r.concat(Array.prototype.slice.call(a));var s=e.box(e.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|t.sps.length].concat(n,[t.pps.length],r))),c=t.width,l=t.height,u=t.pixelRatio[0],d=t.pixelRatio[1];return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),s,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),e.box(e.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,d>>24,d>>16&255,d>>8&255,d&255])))},e.esds=function(e){var t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5,t].concat(e.config,[6,1,2]))},e.mp4a=function(t){var n=t.samplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,n>>8&255,n&255,0,0]),e.box(e.types.esds,e.esds(t)))},e.mp3=function(t){var n=t.samplerate;return e.box(e.types[`.mp3`],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,n>>8&255,n&255,0,0]))},e.stsd=function(t){return t.type===`audio`?!t.isAAC&&t.codec===`mp3`?e.box(e.types.stsd,e.STSD,e.mp3(t)):e.box(e.types.stsd,e.STSD,e.mp4a(t)):e.box(e.types.stsd,e.STSD,e.avc1(t))},e.tkhd=function(t){var n=t.id,i=t.duration*t.timescale,a=t.width,o=t.height,s=Math.floor(i/(r+1)),c=Math.floor(i%(r+1));return e.box(e.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,n>>24&255,n>>16&255,n>>8&255,n&255,0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,c>>24,c>>16&255,c>>8&255,c&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,a>>8&255,a&255,0,0,o>>8&255,o&255,0,0]))},e.traf=function(t,n){var i=e.sdtp(t),a=t.id,o=Math.floor(n/(r+1)),s=Math.floor(n%(r+1));return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255])),e.box(e.types.tfdt,new Uint8Array([1,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,s>>24,s>>16&255,s>>8&255,s&255])),e.trun(t,i.length+16+20+8+16+8+8),i)},e.trak=function(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))},e.trex=function(t){var n=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},e.trun=function(t,n){var r=t.samples||[],i=r.length,a=12+16*i,o=new Uint8Array(a),s,c,l,u,d,f;for(n+=8+a,o.set([0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255],0),s=0;s<i;s++)c=r[s],l=c.duration,u=c.size,d=c.flags,f=c.cts,o.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,d.degradPrio&61440,d.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*s);return e.box(e.types.trun,o)},e.initSegment=function(t){e.types||e.init();var n=e.moov(t),r=new Uint8Array(e.FTYP.byteLength+n.byteLength);return r.set(e.FTYP),r.set(n,e.FTYP.byteLength),r},e}();i.types=void 0,i.HDLR_TYPES=void 0,i.STTS=void 0,i.STSC=void 0,i.STCO=void 0,i.STSZ=void 0,i.VMHD=void 0,i.SMHD=void 0,i.STSD=void 0,i.FTYP=void 0,i.DINF=void 0,t.default=i}),"./src/remux/mp4-remuxer.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return v}),n.d(t,`normalizePts`,function(){return y});var r=n(`./src/polyfills/number.ts`),i=n(`./src/remux/aac-helper.ts`),a=n(`./src/remux/mp4-generator.ts`),o=n(`./src/events.ts`),s=n(`./src/errors.ts`),c=n(`./src/utils/logger.ts`),l=n(`./src/types/loader.ts`),u=n(`./src/utils/timescale-conversion.ts`);function d(){return d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},d.apply(this,arguments)}var f=10*1e3,p=1024,m=1152,h=null,g=null,_=!1,v=function(){function e(e,t,n,r){if(r===void 0&&(r=``),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=t,this.typeSupported=n,this.ISGenerated=!1,h===null){var i=(navigator.userAgent||``).match(/Chrome\/(\d+)/i);h=i?parseInt(i[1]):0}if(g===null){var a=navigator.userAgent.match(/Safari\/(\d+)/i);g=a?parseInt(a[1]):0}_=!!h&&h<75||!!g&&g<600}var t=e.prototype;return t.destroy=function(){},t.resetTimeStamp=function(e){c.logger.log(`[mp4-remuxer]: initPTS & initDTS reset`),this._initPTS=this._initDTS=e},t.resetNextTimestamp=function(){c.logger.log(`[mp4-remuxer]: reset next timestamp`),this.isVideoContiguous=!1,this.isAudioContiguous=!1},t.resetInitSegment=function(){c.logger.log(`[mp4-remuxer]: ISGenerated flag reset`),this.ISGenerated=!1},t.getVideoStartPts=function(e){var t=!1,n=e.reduce(function(e,n){var r=n.pts-e;return r<-4294967296?(t=!0,y(e,n.pts)):r>0?e:n.pts},e[0].pts);return t&&c.logger.debug(`PTS rollover detected`),n},t.remux=function(e,t,n,r,i,a,o,s){var u,d,f,p,m,h,g=i,_=i,v=e.pid>-1,x=t.pid>-1,S=t.samples.length,C=e.samples.length>0,w=S>1;if((!v||C)&&(!x||w)||this.ISGenerated||o){this.ISGenerated||(f=this.generateIS(e,t,i));var T=this.isVideoContiguous,E=-1;if(w&&(E=b(t.samples),!T&&this.config.forceKeyFrameOnDiscontinuity))if(h=!0,E>0){c.logger.warn(`[mp4-remuxer]: Dropped `+E+` out of `+S+` video samples due to a missing keyframe`);var D=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(E),t.dropped+=E,_+=(t.samples[0].pts-D)/(t.timescale||9e4)}else E===-1&&(c.logger.warn(`[mp4-remuxer]: No keyframe found out of `+S+` video samples`),h=!1);if(this.ISGenerated){if(C&&w){var O=this.getVideoStartPts(t.samples),k=(y(e.samples[0].pts,O)-O)/t.inputTimeScale;g+=Math.max(0,k),_+=Math.max(0,-k)}if(C){if(e.samplerate||(c.logger.warn(`[mp4-remuxer]: regenerate InitSegment as audio detected`),f=this.generateIS(e,t,i)),d=this.remuxAudio(e,g,this.isAudioContiguous,a,x||w||s===l.PlaylistLevelType.AUDIO?_:void 0),w){var A=d?d.endPTS-d.startPTS:0;t.inputTimeScale||(c.logger.warn(`[mp4-remuxer]: regenerate InitSegment as video detected`),f=this.generateIS(e,t,i)),u=this.remuxVideo(t,_,T,A)}}else w&&(u=this.remuxVideo(t,_,T,0));u&&(u.firstKeyFrame=E,u.independent=E!==-1)}}return this.ISGenerated&&(n.samples.length&&(m=this.remuxID3(n,i)),r.samples.length&&(p=this.remuxText(r,i))),{audio:d,video:u,initSegment:f,independent:h,text:p,id3:m}},t.generateIS=function(e,t,n){var i=e.samples,o=t.samples,s=this.typeSupported,c={},l=!(0,r.isFiniteNumber)(this._initPTS),u=`audio/mp4`,d,f,p;if(l&&(d=f=1/0),e.config&&i.length&&(e.timescale=e.samplerate,e.isAAC||(s.mpeg?(u=`audio/mpeg`,e.codec=``):s.mp3&&(e.codec=`mp3`)),c.audio={id:`audio`,container:u,codec:e.codec,initSegment:!e.isAAC&&s.mpeg?new Uint8Array:a.default.initSegment([e]),metadata:{channelCount:e.channelCount}},l&&(p=e.inputTimeScale,d=f=i[0].pts-Math.round(p*n))),t.sps&&t.pps&&o.length&&(t.timescale=t.inputTimeScale,c.video={id:`main`,container:`video/mp4`,codec:t.codec,initSegment:a.default.initSegment([t]),metadata:{width:t.width,height:t.height}},l)){p=t.inputTimeScale;var m=this.getVideoStartPts(o),h=Math.round(p*n);f=Math.min(f,y(o[0].dts,m)-h),d=Math.min(d,m-h)}if(Object.keys(c).length)return this.ISGenerated=!0,l&&(this._initPTS=d,this._initDTS=f),{tracks:c,initPTS:d,timescale:p}},t.remuxVideo=function(e,t,n,r){var i=e.inputTimeScale,l=e.samples,f=[],p=l.length,m=this._initPTS,g=this.nextAvcDts,v=8,b,S,C,w=1/0,T=-1/0,E=0,D=!1;(!n||g===null)&&(g=t*i-(l[0].pts-y(l[0].dts,l[0].pts)));for(var O=0;O<p;O++){var k=l[O];k.pts=y(k.pts-m,g),k.dts=y(k.dts-m,g),k.dts>k.pts&&(E=Math.max(Math.min(E,k.pts-k.dts),9e4*.2*-1)),k.dts<l[O>0?O-1:O].dts&&(D=!0)}D&&l.sort(function(e,t){var n=e.dts-t.dts,r=e.pts-t.pts;return n||r}),S=l[0].dts,C=l[l.length-1].dts;var A=Math.round((C-S)/(p-1));if(E<0){if(E<A*-2){c.logger.warn(`PTS < DTS detected in video samples, offsetting DTS from PTS by `+(0,u.toMsFromMpegTsClock)(-A,!0)+` ms`);for(var j=E,M=0;M<p;M++)l[M].dts=j=Math.max(j,l[M].pts-A),l[M].pts=Math.max(j,l[M].pts)}else{c.logger.warn(`PTS < DTS detected in video samples, shifting DTS by `+(0,u.toMsFromMpegTsClock)(E,!0)+` ms to overcome this issue`);for(var N=0;N<p;N++)l[N].dts=l[N].dts+E}S=l[0].dts}if(n){var P=S-g,F=P>A;if(F||P<-1){F?c.logger.warn(`AVC: `+(0,u.toMsFromMpegTsClock)(P,!0)+` ms (`+P+`dts) hole between fragments detected, filling it`):c.logger.warn(`AVC: `+(0,u.toMsFromMpegTsClock)(-P,!0)+` ms (`+P+`dts) overlapping between fragments detected`),S=g;var I=l[0].pts-P;l[0].dts=S,l[0].pts=I,c.logger.log(`Video: First PTS/DTS adjusted: `+(0,u.toMsFromMpegTsClock)(I,!0)+`/`+(0,u.toMsFromMpegTsClock)(S,!0)+`, delta: `+(0,u.toMsFromMpegTsClock)(P,!0)+` ms`)}}_&&(S=Math.max(0,S));for(var L=0,R=0,z=0;z<p;z++){for(var B=l[z],V=B.units,H=V.length,U=0,W=0;W<H;W++)U+=V[W].data.length;R+=U,L+=H,B.length=U,B.dts=Math.max(B.dts,S),B.pts=Math.max(B.pts,B.dts,0),w=Math.min(B.pts,w),T=Math.max(B.pts,T)}C=l[p-1].dts;var G=R+4*L+8,K;try{K=new Uint8Array(G)}catch{this.observer.emit(o.Events.ERROR,o.Events.ERROR,{type:s.ErrorTypes.MUX_ERROR,details:s.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:G,reason:`fail allocating video mdat `+G});return}var q=new DataView(K.buffer);q.setUint32(0,G),K.set(a.default.types.mdat,4);for(var J=0;J<p;J++){for(var Y=l[J],X=Y.units,ee=0,te=0,ne=X.length;te<ne;te++){var re=X[te],Z=re.data,Q=re.data.byteLength;q.setUint32(v,Q),v+=4,K.set(Z,v),v+=Q,ee+=4+Q}if(J<p-1)b=l[J+1].dts-Y.dts;else{var ie=this.config,$=Y.dts-l[J>0?J-1:J].dts;if(ie.stretchShortVideoTrack&&this.nextAudioPts!==null){var ae=Math.floor(ie.maxBufferHole*i),oe=(r?w+r*i:this.nextAudioPts)-Y.pts;oe>ae?(b=oe-$,b<0&&(b=$),c.logger.log(`[mp4-remuxer]: It is approximately `+oe/90+` ms to the next segment; using duration `+b/90+` ms for the last video frame.`)):b=$}else b=$}var se=Math.round(Y.pts-Y.dts);f.push(new x(Y.key,b,ee,se))}if(f.length&&h&&h<70){var ce=f[0].flags;ce.dependsOn=2,ce.isNonSync=0}console.assert(b!==void 0,`mp4SampleDuration must be computed`),this.nextAvcDts=g=C+b,this.isVideoContiguous=!0;var le={data1:a.default.moof(e.sequenceNumber++,S,d({},e,{samples:f})),data2:K,startPTS:w/i,endPTS:(T+b)/i,startDTS:S/i,endDTS:g/i,type:`video`,hasAudio:!1,hasVideo:!0,nb:f.length,dropped:e.dropped};return e.samples=[],e.dropped=0,console.assert(K.length,`MDAT length must not be zero`),le},t.remuxAudio=function(e,t,n,r,l){var u=e.inputTimeScale,h=u/(e.samplerate?e.samplerate:u),g=e.isAAC?p:m,_=g*h,v=this._initPTS,b=!e.isAAC&&this.typeSupported.mpeg,S=[],C=e.samples,w=b?0:8,T=this.nextAudioPts||-1,E=t*u;if(this.isAudioContiguous=n||=C.length&&T>0&&(r&&Math.abs(E-T)<9e3||Math.abs(y(C[0].pts-v,E)-T)<20*_),C.forEach(function(e){e.pts=y(e.pts-v,E)}),!n||T<0){if(C=C.filter(function(e){return e.pts>=0}),!C.length)return;T=l===0?0:r?Math.max(0,E):C[0].pts}if(e.isAAC)for(var D=l!==void 0,O=this.config.maxAudioFramesDrift,k=0,A=T;k<C.length;k++){var j=C[k],M=j.pts,N=M-A,P=Math.abs(1e3*N/u);if(N<=-O*_&&D)k===0&&(c.logger.warn(`Audio frame @ `+(M/u).toFixed(3)+`s overlaps nextAudioPts by `+Math.round(1e3*N/u)+` ms.`),this.nextAudioPts=T=A=M);else if(N>=O*_&&P<f&&D){var F=Math.round(N/_);A=M-F*_,A<0&&(F--,A+=_),k===0&&(this.nextAudioPts=T=A),c.logger.warn(`[mp4-remuxer]: Injecting `+F+` audio frame @ `+(A/u).toFixed(3)+`s due to `+Math.round(1e3*N/u)+` ms gap.`);for(var I=0;I<F;I++){var L=Math.max(A,0),R=i.default.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);R||=(c.logger.log(`[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead.`),j.unit.subarray()),C.splice(k,0,{unit:R,pts:L}),A+=_,k++}}j.pts=A,A+=_}for(var z=null,B=null,V,H=0,U=C.length;U--;)H+=C[U].unit.byteLength;for(var W=0,G=C.length;W<G;W++){var K=C[W],q=K.unit,J=K.pts;if(B!==null){var Y=S[W-1];Y.duration=Math.round((J-B)/h)}else if(n&&e.isAAC&&(J=T),z=J,H>0){H+=w;try{V=new Uint8Array(H)}catch{this.observer.emit(o.Events.ERROR,o.Events.ERROR,{type:s.ErrorTypes.MUX_ERROR,details:s.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:H,reason:`fail allocating audio mdat `+H});return}b||(new DataView(V.buffer).setUint32(0,H),V.set(a.default.types.mdat,4))}else return;V.set(q,w);var X=q.byteLength;w+=X,S.push(new x(!0,g,X,0)),B=J}var ee=S.length;if(ee){var te=S[S.length-1];this.nextAudioPts=T=B+h*te.duration;var ne=b?new Uint8Array:a.default.moof(e.sequenceNumber++,z/h,d({},e,{samples:S}));e.samples=[];var re=z/u,Z=T/u,Q={data1:ne,data2:V,startPTS:re,endPTS:Z,startDTS:re,endDTS:Z,type:`audio`,hasAudio:!0,hasVideo:!1,nb:ee};return this.isAudioContiguous=!0,console.assert(V.length,`MDAT length must not be zero`),Q}},t.remuxEmptyAudio=function(e,t,n,r){var a=e.inputTimeScale,o=a/(e.samplerate?e.samplerate:a),s=this.nextAudioPts,l=(s===null?r.startDTS*a:s)+this._initDTS,u=r.endDTS*a+this._initDTS,d=o*p,f=Math.ceil((u-l)/d),m=i.default.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(c.logger.warn(`[mp4-remuxer]: remux empty Audio`),!m){c.logger.trace(`[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec`);return}for(var h=[],g=0;g<f;g++){var _=l+g*d;h.push({unit:m,pts:_,dts:_})}return e.samples=h,this.remuxAudio(e,t,n,!1)},t.remuxID3=function(e,t){var n=e.samples.length;if(n){for(var r=e.inputTimeScale,i=this._initPTS,a=this._initDTS,o=0;o<n;o++){var s=e.samples[o];s.pts=y(s.pts-i,t*r)/r,s.dts=y(s.dts-a,t*r)/r}var c=e.samples;return e.samples=[],{samples:c}}},t.remuxText=function(e,t){var n=e.samples.length;if(n){for(var r=e.inputTimeScale,i=this._initPTS,a=0;a<n;a++){var o=e.samples[a];o.pts=y(o.pts-i,t*r)/r}e.samples.sort(function(e,t){return e.pts-t.pts});var s=e.samples;return e.samples=[],{samples:s}}},e}();function y(e,t){var n;if(t===null)return e;for(n=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=n;return e}function b(e){for(var t=0;t<e.length;t++)if(e[t].key)return t;return-1}var x=function(e,t,n,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=n,this.cts=r,this.flags=new S(e)},S=function(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}}),"./src/remux/passthrough-remuxer.ts":(function(e,t,n){n.r(t);var r=n(`./src/polyfills/number.ts`),i=n(`./src/utils/mp4-tools.ts`),a=n(`./src/loader/fragment.ts`),o=n(`./src/utils/logger.ts`),s=function(){function e(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndDTS=null}var t=e.prototype;return t.destroy=function(){},t.resetTimeStamp=function(e){this.initPTS=e,this.lastEndDTS=null},t.resetNextTimestamp=function(){this.lastEndDTS=null},t.resetInitSegment=function(e,t,n){this.audioCodec=t,this.videoCodec=n,this.generateInitSegment(e),this.emitInitSegment=!0},t.generateInitSegment=function(e){var t=this.audioCodec,n=this.videoCodec;if(!e||!e.byteLength){this.initTracks=void 0,this.initData=void 0;return}var r=this.initData=(0,i.parseInitSegment)(e);t||=l(r.audio,a.ElementaryStreamTypes.AUDIO),n||=l(r.video,a.ElementaryStreamTypes.VIDEO);var s={};r.audio&&r.video?s.audiovideo={container:`video/mp4`,codec:t+`,`+n,initSegment:e,id:`main`}:r.audio?s.audio={container:`audio/mp4`,codec:t,initSegment:e,id:`audio`}:r.video?s.video={container:`video/mp4`,codec:n,initSegment:e,id:`main`}:o.logger.warn(`[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes.`),this.initTracks=s},t.remux=function(e,t,n,a,s){var l=this.initPTS,u=this.lastEndDTS,d={audio:void 0,video:void 0,text:a,id3:n,initSegment:void 0};(0,r.isFiniteNumber)(u)||(u=this.lastEndDTS=s||0);var f=t.samples;if(!f||!f.length)return d;var p={initPTS:void 0,timescale:1},m=this.initData;if((!m||!m.length)&&(this.generateInitSegment(f),m=this.initData),!m||!m.length)return o.logger.warn(`[passthrough-remuxer.ts]: Failed to generate initSegment.`),d;this.emitInitSegment&&=(p.tracks=this.initTracks,!1),(0,r.isFiniteNumber)(l)||(this.initPTS=p.initPTS=l=c(m,f,u));var h=(0,i.getDuration)(f,m),g=u,_=h+g;(0,i.offsetStartDTS)(m,f,l),h>0?this.lastEndDTS=_:(o.logger.warn(`Duration parsed from mp4 should be greater than zero`),this.resetNextTimestamp());var v=!!m.audio,y=!!m.video,b=``;v&&(b+=`audio`),y&&(b+=`video`);var x={data1:f,startPTS:g,startDTS:g,endPTS:_,endDTS:_,type:b,hasAudio:v,hasVideo:y,nb:1,dropped:0};return d.audio=x.type===`audio`?x:void 0,d.video=x.type===`audio`?void 0:x,d.text=a,d.id3=n,d.initSegment=p,d},e}(),c=function(e,t,n){return(0,i.getStartDTS)(e,t)-n};function l(e,t){var n=e?.codec;return n&&n.length>4?n:n===`hvc1`?`hvc1.1.c.L120.90`:n===`av01`?`av01.0.04M.08`:n===`avc1`||t===a.ElementaryStreamTypes.VIDEO?`avc1.42e01e`:`mp4a.40.5`}t.default=s}),"./src/task-loop.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return r});var r=function(){function e(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var t=e.prototype;return t.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},t.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},t.onHandlerDestroyed=function(){},t.hasInterval=function(){return!!this._tickInterval},t.hasNextTick=function(){return!!this._tickTimer},t.setInterval=function(e){return this._tickInterval?!1:(this._tickInterval=self.setInterval(this._boundTick,e),!0)},t.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},t.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},t.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},t.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},t.doTick=function(){},e}()}),"./src/types/cmcd.ts":(function(e,t,n){n.r(t),n.d(t,`CMCDVersion`,function(){return r}),n.d(t,`CMCDObjectType`,function(){return i}),n.d(t,`CMCDStreamingFormat`,function(){return a}),n.d(t,`CMCDStreamType`,function(){return o});var r=1,i;(function(e){e.MANIFEST=`m`,e.AUDIO=`a`,e.VIDEO=`v`,e.MUXED=`av`,e.INIT=`i`,e.CAPTION=`c`,e.TIMED_TEXT=`tt`,e.KEY=`k`,e.OTHER=`o`})(i||={});var a;(function(e){e.DASH=`d`,e.HLS=`h`,e.SMOOTH=`s`,e.OTHER=`o`})(a||={});var o;(function(e){e.VOD=`v`,e.LIVE=`l`})(o||={})}),"./src/types/level.ts":(function(e,t,n){n.r(t),n.d(t,`HlsSkip`,function(){return a}),n.d(t,`getSkipValue`,function(){return o}),n.d(t,`HlsUrlParameters`,function(){return s}),n.d(t,`Level`,function(){return c});function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,`value`in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}var a;(function(e){e.No=``,e.Yes=`YES`,e.v2=`v2`})(a||={});function o(e,t){var n=e.canSkipUntil,r=e.canSkipDateRanges,i=e.endSN,o=t===void 0?0:t-i;return n&&o<n?r?a.v2:a.Yes:a.No}var s=function(){function e(e,t,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=n}var t=e.prototype;return t.addDirectives=function(e){var t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set(`_HLS_msn`,this.msn.toString()),this.part!==void 0&&t.searchParams.set(`_HLS_part`,this.part.toString()),this.skip&&t.searchParams.set(`_HLS_skip`,this.skip),t.toString()},e}(),c=function(){function e(e){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[e.url],this.attrs=e.attrs,this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.unknownCodecs=e.unknownCodecs,this.codecSet=[e.videoCodec,e.audioCodec].filter(function(e){return e}).join(`,`).replace(/\.[^.,]+/g,``)}return i(e,[{key:`maxBitrate`,get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:`uri`,get:function(){return this.url[this._urlId]||``}},{key:`urlId`,get:function(){return this._urlId},set:function(e){var t=e%this.url.length;this._urlId!==t&&(this.details=void 0,this._urlId=t)}}]),e}()}),"./src/types/loader.ts":(function(e,t,n){n.r(t),n.d(t,`PlaylistContextType`,function(){return r}),n.d(t,`PlaylistLevelType`,function(){return i});var r;(function(e){e.MANIFEST=`manifest`,e.LEVEL=`level`,e.AUDIO_TRACK=`audioTrack`,e.SUBTITLE_TRACK=`subtitleTrack`})(r||={});var i;(function(e){e.MAIN=`main`,e.AUDIO=`audio`,e.SUBTITLE=`subtitle`})(i||={})}),"./src/types/transmuxer.ts":(function(e,t,n){n.r(t),n.d(t,`ChunkMetadata`,function(){return r});var r=function(e,t,n,r,a,o){r===void 0&&(r=0),a===void 0&&(a=-1),o===void 0&&(o=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=i(),this.buffering={audio:i(),video:i(),audiovideo:i()},this.level=e,this.sn=t,this.id=n,this.size=r,this.part=a,this.partial=o};function i(){return{start:0,executeStart:0,executeEnd:0,end:0}}}),"./src/utils/attr-list.ts":(function(e,t,n){n.r(t),n.d(t,`AttrList`,function(){return a});var r=/^(\d+)x(\d+)$/,i=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,a=function(){function e(t){for(var n in typeof t==`string`&&(t=e.parseAttrList(t)),t)t.hasOwnProperty(n)&&(this[n]=t[n])}var t=e.prototype;return t.decimalInteger=function(e){var t=parseInt(this[e],10);return t>2**53-1?1/0:t},t.hexadecimalInteger=function(e){if(this[e]){var t=(this[e]||`0x`).slice(2);t=(t.length&1?`0`:``)+t;for(var n=new Uint8Array(t.length/2),r=0;r<t.length/2;r++)n[r]=parseInt(t.slice(r*2,r*2+2),16);return n}else return null},t.hexadecimalIntegerAsNumber=function(e){var t=parseInt(this[e],16);return t>2**53-1?1/0:t},t.decimalFloatingPoint=function(e){return parseFloat(this[e])},t.optionalFloat=function(e,t){var n=this[e];return n?parseFloat(n):t},t.enumeratedString=function(e){return this[e]},t.bool=function(e){return this[e]===`YES`},t.decimalResolution=function(e){var t=r.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}},e.parseAttrList=function(e){var t,n={},r=`"`;for(i.lastIndex=0;(t=i.exec(e))!==null;){var a=t[2];a.indexOf(r)===0&&a.lastIndexOf(r)===a.length-1&&(a=a.slice(1,-1)),n[t[1]]=a}return n},e}()}),"./src/utils/binary-search.ts":(function(e,t,n){n.r(t),t.default={search:function(e,t){for(var n=0,r=e.length-1,i=null,a=null;n<=r;){i=(n+r)/2|0,a=e[i];var o=t(a);if(o>0)n=i+1;else if(o<0)r=i-1;else return a}return null}}}),"./src/utils/buffer-helper.ts":(function(e,t,n){n.r(t),n.d(t,`BufferHelper`,function(){return a});var r=n(`./src/utils/logger.ts`),i={length:0,start:function(){return 0},end:function(){return 0}},a=function(){function e(){}return e.isBuffered=function(t,n){try{if(t){for(var r=e.getBuffered(t),i=0;i<r.length;i++)if(n>=r.start(i)&&n<=r.end(i))return!0}}catch{}return!1},e.bufferInfo=function(t,n,r){try{if(t){var i=e.getBuffered(t),a=[],o;for(o=0;o<i.length;o++)a.push({start:i.start(o),end:i.end(o)});return this.bufferedInfo(a,n,r)}}catch{}return{len:0,start:n,end:n,nextStart:void 0}},e.bufferedInfo=function(e,t,n){t=Math.max(0,t),e.sort(function(e,t){return e.start-t.start||t.end-e.end});var r=[];if(n)for(var i=0;i<e.length;i++){var a=r.length;if(a){var o=r[a-1].end;e[i].start-o<n?e[i].end>o&&(r[a-1].end=e[i].end):r.push(e[i])}else r.push(e[i])}else r=e;for(var s=0,c,l=t,u=t,d=0;d<r.length;d++){var f=r[d].start,p=r[d].end;if(t+n>=f&&t<p)l=f,u=p,s=u-t;else if(t+n<f){c=f;break}}return{len:s,start:l||0,end:u||0,nextStart:c}},e.getBuffered=function(e){try{return e.buffered}catch(e){return r.logger.log(`failed to get media.buffered`,e),i}},e}()}),"./src/utils/cea-608-parser.ts":(function(e,t,n){n.r(t),n.d(t,`Row`,function(){return v}),n.d(t,`CaptionScreen`,function(){return y});var r=n(`./src/utils/logger.ts`),i={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},a=function(e){var t=e;return i.hasOwnProperty(e)&&(t=i[e]),String.fromCharCode(t)},o=15,s=100,c={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},l={17:2,18:4,21:6,22:8,23:10,19:13,20:15},u={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},d={25:2,26:4,29:6,30:8,31:10,27:13,28:15},f=[`white`,`green`,`blue`,`cyan`,`red`,`yellow`,`magenta`,`black`,`transparent`],p;(function(e){e[e.ERROR=0]=`ERROR`,e[e.TEXT=1]=`TEXT`,e[e.WARNING=2]=`WARNING`,e[e.INFO=2]=`INFO`,e[e.DEBUG=3]=`DEBUG`,e[e.DATA=3]=`DATA`})(p||={});var m=function(){function e(){this.time=null,this.verboseLevel=p.ERROR}var t=e.prototype;return t.log=function(e,t){this.verboseLevel>=e&&r.logger.log(this.time+` [`+e+`] `+t)},e}(),h=function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].toString(16));return t},g=function(){function e(e,t,n,r,i){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=e||`white`,this.underline=t||!1,this.italics=n||!1,this.background=r||`black`,this.flash=i||!1}var t=e.prototype;return t.reset=function(){this.foreground=`white`,this.underline=!1,this.italics=!1,this.background=`black`,this.flash=!1},t.setStyles=function(e){for(var t=[`foreground`,`underline`,`italics`,`background`,`flash`],n=0;n<t.length;n++){var r=t[n];e.hasOwnProperty(r)&&(this[r]=e[r])}},t.isDefault=function(){return this.foreground===`white`&&!this.underline&&!this.italics&&this.background===`black`&&!this.flash},t.equals=function(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash},t.copy=function(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash},t.toString=function(){return`color=`+this.foreground+`, underline=`+this.underline+`, italics=`+this.italics+`, background=`+this.background+`, flash=`+this.flash},e}(),_=function(){function e(e,t,n,r,i,a){this.uchar=void 0,this.penState=void 0,this.uchar=e||` `,this.penState=new g(t,n,r,i,a)}var t=e.prototype;return t.reset=function(){this.uchar=` `,this.penState.reset()},t.setChar=function(e,t){this.uchar=e,this.penState.copy(t)},t.setPenState=function(e){this.penState.copy(e)},t.equals=function(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)},t.copy=function(e){this.uchar=e.uchar,this.penState.copy(e.penState)},t.isEmpty=function(){return this.uchar===` `&&this.penState.isDefault()},e}(),v=function(){function e(e){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var t=0;t<s;t++)this.chars.push(new _);this.logger=e,this.pos=0,this.currPenState=new g}var t=e.prototype;return t.equals=function(e){for(var t=!0,n=0;n<s;n++)if(!this.chars[n].equals(e.chars[n])){t=!1;break}return t},t.copy=function(e){for(var t=0;t<s;t++)this.chars[t].copy(e.chars[t])},t.isEmpty=function(){for(var e=!0,t=0;t<s;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e},t.setCursor=function(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(p.DEBUG,`Negative cursor position `+this.pos),this.pos=0):this.pos>s&&(this.logger.log(p.DEBUG,`Too large cursor position `+this.pos),this.pos=s)},t.moveCursor=function(e){var t=this.pos+e;if(e>1)for(var n=this.pos+1;n<t+1;n++)this.chars[n].setPenState(this.currPenState);this.setCursor(t)},t.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(` `,this.currPenState)},t.insertChar=function(e){e>=144&&this.backSpace();var t=a(e);if(this.pos>=s){this.logger.log(p.ERROR,`Cannot insert `+e.toString(16)+` (`+t+`) at position `+this.pos+`. Skipping it!`);return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)},t.clearFromPos=function(e){var t;for(t=e;t<s;t++)this.chars[t].reset()},t.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},t.clearToEndOfRow=function(){this.clearFromPos(this.pos)},t.getTextString=function(){for(var e=[],t=!0,n=0;n<s;n++){var r=this.chars[n].uchar;r!==` `&&(t=!1),e.push(r)}return t?``:e.join(``)},t.setPenStyles=function(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)},e}(),y=function(){function e(e){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var t=0;t<o;t++)this.rows.push(new v(e));this.logger=e,this.currRow=o-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var t=e.prototype;return t.reset=function(){for(var e=0;e<o;e++)this.rows[e].clear();this.currRow=o-1},t.equals=function(e){for(var t=!0,n=0;n<o;n++)if(!this.rows[n].equals(e.rows[n])){t=!1;break}return t},t.copy=function(e){for(var t=0;t<o;t++)this.rows[t].copy(e.rows[t])},t.isEmpty=function(){for(var e=!0,t=0;t<o;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e},t.backSpace=function(){this.rows[this.currRow].backSpace()},t.clearToEndOfRow=function(){this.rows[this.currRow].clearToEndOfRow()},t.insertChar=function(e){this.rows[this.currRow].insertChar(e)},t.setPen=function(e){this.rows[this.currRow].setPenStyles(e)},t.moveCursor=function(e){this.rows[this.currRow].moveCursor(e)},t.setCursor=function(e){this.logger.log(p.INFO,`setCursor: `+e),this.rows[this.currRow].setCursor(e)},t.setPAC=function(e){this.logger.log(p.INFO,`pacData = `+JSON.stringify(e));var t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(var n=0;n<o;n++)this.rows[n].clear();var r=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){var a=i.rows[r].cueStartTime,s=this.logger.time;if(a&&s!==null&&a<s)for(var c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(i.rows[r+c])}}this.currRow=t;var l=this.rows[this.currRow];if(e.indent!==null){var u=e.indent,d=Math.max(u-1,0);l.setCursor(e.indent),e.color=l.chars[d].penState.foreground}var f={foreground:e.color,underline:e.underline,italics:e.italics,background:`black`,flash:!1};this.setPen(f)},t.setBkgData=function(e){this.logger.log(p.INFO,`bkgData = `+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)},t.setRollUpRows=function(e){this.nrRollUpRows=e},t.rollUp=function(){if(this.nrRollUpRows===null){this.logger.log(p.DEBUG,`roll_up but nrRollUpRows not set yet`);return}this.logger.log(p.TEXT,this.getDisplayText());var e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(p.INFO,`Rolling up`)},t.getDisplayText=function(e){e||=!1;for(var t=[],n=``,r=-1,i=0;i<o;i++){var a=this.rows[i].getTextString();a&&(r=i+1,e?t.push(`Row `+r+`: '`+a+`'`):t.push(a.trim()))}return t.length>0&&(n=e?`[`+t.join(` | `)+`]`:t.join(`
`)),n},t.getTextAndFormat=function(){return this.rows},e}(),b=function(){function e(e,t,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new y(n),this.nonDisplayedMemory=new y(n),this.lastOutputScreen=new y(n),this.currRollUpRow=this.displayedMemory.rows[o-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}var t=e.prototype;return t.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[o-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},t.getHandler=function(){return this.outputFilter},t.setHandler=function(e){this.outputFilter=e},t.setPAC=function(e){this.writeScreen.setPAC(e)},t.setBkgData=function(e){this.writeScreen.setBkgData(e)},t.setMode=function(e){e!==this.mode&&(this.mode=e,this.logger.log(p.INFO,`MODE=`+e),this.mode===`MODE_POP-ON`?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!==`MODE_ROLL-UP`&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)},t.insertChars=function(e){for(var t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);var n=this.writeScreen===this.displayedMemory?`DISP`:`NON_DISP`;this.logger.log(p.INFO,n+`: `+this.writeScreen.getDisplayText(!0)),(this.mode===`MODE_PAINT-ON`||this.mode===`MODE_ROLL-UP`)&&(this.logger.log(p.TEXT,`DISPLAYED: `+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())},t.ccRCL=function(){this.logger.log(p.INFO,`RCL - Resume Caption Loading`),this.setMode(`MODE_POP-ON`)},t.ccBS=function(){this.logger.log(p.INFO,`BS - BackSpace`),this.mode!==`MODE_TEXT`&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},t.ccAOF=function(){},t.ccAON=function(){},t.ccDER=function(){this.logger.log(p.INFO,`DER- Delete to End of Row`),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},t.ccRU=function(e){this.logger.log(p.INFO,`RU(`+e+`) - Roll Up`),this.writeScreen=this.displayedMemory,this.setMode(`MODE_ROLL-UP`),this.writeScreen.setRollUpRows(e)},t.ccFON=function(){this.logger.log(p.INFO,`FON - Flash On`),this.writeScreen.setPen({flash:!0})},t.ccRDC=function(){this.logger.log(p.INFO,`RDC - Resume Direct Captioning`),this.setMode(`MODE_PAINT-ON`)},t.ccTR=function(){this.logger.log(p.INFO,`TR`),this.setMode(`MODE_TEXT`)},t.ccRTD=function(){this.logger.log(p.INFO,`RTD`),this.setMode(`MODE_TEXT`)},t.ccEDM=function(){this.logger.log(p.INFO,`EDM - Erase Displayed Memory`),this.displayedMemory.reset(),this.outputDataUpdate(!0)},t.ccCR=function(){this.logger.log(p.INFO,`CR - Carriage Return`),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},t.ccENM=function(){this.logger.log(p.INFO,`ENM - Erase Non-displayed Memory`),this.nonDisplayedMemory.reset()},t.ccEOC=function(){if(this.logger.log(p.INFO,`EOC - End Of Caption`),this.mode===`MODE_POP-ON`){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(p.TEXT,`DISP: `+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)},t.ccTO=function(e){this.logger.log(p.INFO,`TO(`+e+`) - Tab Offset`),this.writeScreen.moveCursor(e)},t.ccMIDROW=function(e){var t={flash:!1};t.underline=e%2==1,t.italics=e>=46,t.italics?t.foreground=`white`:t.foreground=[`white`,`green`,`blue`,`cyan`,`red`,`yellow`,`magenta`][Math.floor(e/2)-16],this.logger.log(p.INFO,`MIDROW: `+JSON.stringify(t)),this.writeScreen.setPen(t)},t.outputDataUpdate=function(e){e===void 0&&(e=!1);var t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))},t.cueSplitAtTime=function(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))},e}(),x=function(){function e(e,t,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var r=new m;this.channels=[null,new b(e,t,r),new b(e+1,n,r)],this.cmdHistory=w(),this.logger=r}var t=e.prototype;return t.getHandler=function(e){return this.channels[e].getHandler()},t.setHandler=function(e,t){this.channels[e].setHandler(t)},t.addData=function(e,t){var n,r,i,a=!1;this.logger.time=e;for(var o=0;o<t.length;o+=2)if(r=t[o]&127,i=t[o+1]&127,!(r===0&&i===0)){if(this.logger.log(p.DATA,`[`+h([t[o],t[o+1]])+`] -> (`+h([r,i])+`)`),n=this.parseCmd(r,i),n||=this.parseMidrow(r,i),n||=this.parsePAC(r,i),n||=this.parseBackgroundAttributes(r,i),!n&&(a=this.parseChars(r,i),a)){var s=this.currentChannel;s&&s>0?this.channels[s].insertChars(a):this.logger.log(p.WARNING,`No channel found yet. TEXT-MODE?`)}!n&&!a&&this.logger.log(p.WARNING,`Couldn't parse cleaned data `+h([r,i])+` orig: `+h([t[o],t[o+1]]))}},t.parseCmd=function(e,t){var n=this.cmdHistory;if(!((e===20||e===28||e===21||e===29)&&t>=32&&t<=47||(e===23||e===31)&&t>=33&&t<=35))return!1;if(C(e,t,n))return S(null,null,n),this.logger.log(p.DEBUG,`Repeated command (`+h([e,t])+`) is dropped`),!0;var r=e===20||e===21||e===23?1:2,i=this.channels[r];return e===20||e===21||e===28||e===29?t===32?i.ccRCL():t===33?i.ccBS():t===34?i.ccAOF():t===35?i.ccAON():t===36?i.ccDER():t===37?i.ccRU(2):t===38?i.ccRU(3):t===39?i.ccRU(4):t===40?i.ccFON():t===41?i.ccRDC():t===42?i.ccTR():t===43?i.ccRTD():t===44?i.ccEDM():t===45?i.ccCR():t===46?i.ccENM():t===47&&i.ccEOC():i.ccTO(t-32),S(e,t,n),this.currentChannel=r,!0},t.parseMidrow=function(e,t){var n=0;if((e===17||e===25)&&t>=32&&t<=47){if(n=e===17?1:2,n!==this.currentChannel)return this.logger.log(p.ERROR,`Mismatch channel in midrow parsing`),!1;var r=this.channels[n];return r?(r.ccMIDROW(t),this.logger.log(p.DEBUG,`MIDROW (`+h([e,t])+`)`),!0):!1}return!1},t.parsePAC=function(e,t){var n,r=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127||(e===16||e===24)&&t>=64&&t<=95))return!1;if(C(e,t,r))return S(null,null,r),!0;var i=e<=23?1:2;n=t>=64&&t<=95?i===1?c[e]:u[e]:i===1?l[e]:d[e];var a=this.channels[i];return a?(a.setPAC(this.interpretPAC(n,t)),S(e,t,r),this.currentChannel=i,!0):!1},t.interpretPAC=function(e,t){var n,r={color:null,italics:!1,indent:null,underline:!1,row:e};return n=t>95?t-96:t-64,r.underline=(n&1)==1,n<=13?r.color=[`white`,`green`,`blue`,`cyan`,`red`,`yellow`,`magenta`,`white`][Math.floor(n/2)]:n<=15?(r.italics=!0,r.color=`white`):r.indent=Math.floor((n-16)/2)*4,r},t.parseChars=function(e,t){var n,r=null,i=null;if(e>=25?(n=2,i=e-8):(n=1,i=e),i>=17&&i<=19){var o=i===17?t+80:i===18?t+112:t+144;this.logger.log(p.INFO,`Special char '`+a(o)+`' in channel `+n),r=[o]}else e>=32&&e<=127&&(r=t===0?[e]:[e,t]);if(r){var s=h(r);this.logger.log(p.DEBUG,`Char codes =  `+s.join(`,`)),S(e,t,this.cmdHistory)}return r},t.parseBackgroundAttributes=function(e,t){if(!((e===16||e===24)&&t>=32&&t<=47||(e===23||e===31)&&t>=45&&t<=47))return!1;var n,r={};e===16||e===24?(n=Math.floor((t-32)/2),r.background=f[n],t%2==1&&(r.background+=`_semi`)):t===45?r.background=`transparent`:(r.foreground=`black`,t===47&&(r.underline=!0));var i=e<=23?1:2;return this.channels[i].setBkgData(r),S(e,t,this.cmdHistory),!0},t.reset=function(){for(var e=0;e<Object.keys(this.channels).length;e++){var t=this.channels[e];t&&t.reset()}this.cmdHistory=w()},t.cueSplitAtTime=function(e){for(var t=0;t<this.channels.length;t++){var n=this.channels[t];n&&n.cueSplitAtTime(e)}},e}();function S(e,t,n){n.a=e,n.b=t}function C(e,t,n){return n.a===e&&n.b===t}function w(){return{a:null,b:null}}t.default=x}),"./src/utils/codecs.ts":(function(e,t,n){n.r(t),n.d(t,`isCodecType`,function(){return i}),n.d(t,`isCodecSupportedInMp4`,function(){return a});var r={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function i(e,t){var n=r[t];return!!n&&n[e.slice(0,4)]===!0}function a(e,t){return MediaSource.isTypeSupported((t||`video`)+`/mp4;codecs="`+e+`"`)}}),"./src/utils/cues.ts":(function(e,t,n){n.r(t);var r=n(`./src/utils/vttparser.ts`),i=n(`./src/utils/webvtt-parser.ts`),a=n(`./src/utils/texttrack-utils.ts`),o=/\s/;t.default={newCue:function(e,t,n,s){for(var c=[],l,u,d,f,p,m=self.VTTCue||self.TextTrackCue,h=0;h<s.rows.length;h++)if(l=s.rows[h],d=!0,f=0,p=``,!l.isEmpty()){for(var g=0;g<l.chars.length;g++)o.test(l.chars[g].uchar)&&d?f++:(p+=l.chars[g].uchar,d=!1);l.cueStartTime=t,t===n&&(n+=1e-4),f>=16?f--:f++;var _=(0,r.fixLineBreaks)(p.trim()),v=(0,i.generateCueId)(t,n,_);(!e||!e.cues||!e.cues.getCueById(v))&&(u=new m(t,n,_),u.id=v,u.line=h+1,u.align=`left`,u.position=10+Math.min(80,Math.floor(f*8/32)*10),c.push(u))}return e&&c.length&&(c.sort(function(e,t){return e.line===`auto`||t.line===`auto`?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line}),c.forEach(function(t){return(0,a.addCueToTrack)(e,t)})),c}}}),"./src/utils/discontinuities.ts":(function(e,t,n){n.r(t),n.d(t,`findFirstFragWithCC`,function(){return o}),n.d(t,`shouldAlignOnDiscontinuities`,function(){return s}),n.d(t,`findDiscontinuousReferenceFrag`,function(){return c}),n.d(t,`adjustSlidingStart`,function(){return u}),n.d(t,`alignStream`,function(){return d}),n.d(t,`alignPDT`,function(){return p}),n.d(t,`alignFragmentByPDTDelta`,function(){return m}),n.d(t,`alignMediaPlaylistByPDT`,function(){return h});var r=n(`./src/polyfills/number.ts`),i=n(`./src/utils/logger.ts`),a=n(`./src/controller/level-helper.ts`);function o(e,t){for(var n=null,r=0,i=e.length;r<i;r++){var a=e[r];if(a&&a.cc===t){n=a;break}}return n}function s(e,t,n){return!!(t.details&&(n.endCC>n.startCC||e&&e.cc<n.startCC))}function c(e,t){var n=e.fragments,r=t.fragments;if(!r.length||!n.length){i.logger.log(`No fragments to align`);return}var a=o(n,r[0].cc);if(!a||a&&!a.startPTS){i.logger.log(`No frag in previous level to align on`);return}return a}function l(e,t){if(e){var n=e.start+t;e.start=e.startPTS=n,e.endPTS=n+e.duration}}function u(e,t){for(var n=t.fragments,r=0,i=n.length;r<i;r++)l(n[r],e);t.fragmentHint&&l(t.fragmentHint,e),t.alignedSliding=!0}function d(e,t,n){t&&(f(e,n,t),!n.alignedSliding&&t.details&&p(n,t.details),!n.alignedSliding&&t.details&&!n.skippedSegments&&(0,a.adjustSliding)(t.details,n))}function f(e,t,n){if(s(e,n,t)){var a=c(n.details,t);a&&(0,r.isFiniteNumber)(a.start)&&(i.logger.log(`Adjusting PTS using last level due to CC increase within current level `+t.url),u(a.start,t))}}function p(e,t){if(!(!t.fragments.length||!e.hasProgramDateTime||!t.hasProgramDateTime)){var n=t.fragments[0].programDateTime,a=e.fragments[0].programDateTime,o=(a-n)/1e3+t.fragments[0].start;o&&(0,r.isFiniteNumber)(o)&&(i.logger.log(`Adjusting PTS using programDateTime delta `+(a-n)+`ms, sliding:`+o.toFixed(3)+` `+e.url+` `),u(o,e))}}function m(e,t){var n=e.programDateTime;if(n){var r=(n-t)/1e3;e.start=e.startPTS=r,e.endPTS=r+e.duration}}function h(e,t){if(!(!t.fragments.length||!e.hasProgramDateTime||!t.hasProgramDateTime)){var n=t.fragments[0].programDateTime-t.fragments[0].start*1e3;e.fragments.forEach(function(e){m(e,n)}),e.fragmentHint&&m(e.fragmentHint,n),e.alignedSliding=!0}}}),"./src/utils/ewma-bandwidth-estimator.ts":(function(e,t,n){n.r(t);var r=n(`./src/utils/ewma.ts`);t.default=function(){function e(e,t,n){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new r.default(e),this.fast_=new r.default(t)}var t=e.prototype;return t.update=function(e,t){var n=this.slow_,i=this.fast_;this.slow_.halfLife!==e&&(this.slow_=new r.default(e,n.getEstimate(),n.getTotalWeight())),this.fast_.halfLife!==t&&(this.fast_=new r.default(t,i.getEstimate(),i.getTotalWeight()))},t.sample=function(e,t){e=Math.max(e,this.minDelayMs_);var n=8*t,r=e/1e3,i=n/r;this.fast_.sample(r,i),this.slow_.sample(r,i)},t.canEstimate=function(){var e=this.fast_;return e&&e.getTotalWeight()>=this.minWeight_},t.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},t.destroy=function(){},e}()}),"./src/utils/ewma.ts":(function(e,t,n){n.r(t),t.default=function(){function e(e,t,n){t===void 0&&(t=0),n===void 0&&(n=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=n}var t=e.prototype;return t.sample=function(e,t){var n=this.alpha_**+e;this.estimate_=t*(1-n)+n*this.estimate_,this.totalWeight_+=e},t.getTotalWeight=function(){return this.totalWeight_},t.getEstimate=function(){if(this.alpha_){var e=1-this.alpha_**+this.totalWeight_;if(e)return this.estimate_/e}return this.estimate_},e}()}),"./src/utils/fetch-loader.ts":(function(e,t,n){n.r(t),n.d(t,`fetchSupported`,function(){return m});var r=n(`./src/polyfills/number.ts`),i=n(`./src/loader/load-stats.ts`),a=n(`./src/demux/chunk-cache.ts`);function o(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,d(e,t)}function s(e){var t=typeof Map==`function`?new Map:void 0;return s=function(e){if(e===null||!u(e))return e;if(typeof e!=`function`)throw TypeError(`Super expression must either be null or a function`);if(t!==void 0){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return c(e,arguments,f(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),d(n,e)},s(e)}function c(e,t,n){return c=l()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&d(i,n.prototype),i},c.apply(null,arguments)}function l(){if(typeof Reflect>`u`||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy==`function`)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function u(e){return Function.toString.call(e).indexOf(`[native code]`)!==-1}function d(e,t){return d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},d(e,t)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function p(){return p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},p.apply(this,arguments)}function m(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var h=function(){function e(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||_,this.controller=new self.AbortController,this.stats=new i.LoadStats}var t=e.prototype;return t.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},t.abortInternal=function(){var e=this.response;(!e||!e.ok)&&(this.stats.aborted=!0,this.controller.abort())},t.abort=function(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},t.load=function(e,t,n){var i=this,a=this.stats;if(a.loading.start)throw Error(`Loader can only be used once.`);a.loading.start=self.performance.now();var o=g(e,this.controller.signal),s=n.onProgress,c=e.responseType===`arraybuffer`,l=c?`byteLength`:`length`;this.context=e,this.config=t,this.callbacks=n,this.request=this.fetchSetup(e,o),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){i.abortInternal(),n.onTimeout(a,e,i.response)},t.timeout),self.fetch(this.request).then(function(n){if(i.response=i.loader=n,!n.ok){var o=n.status,l=n.statusText;throw new v(l||`fetch, bad network response`,o,n)}return a.loading.first=Math.max(self.performance.now(),a.loading.start),a.total=parseInt(n.headers.get(`Content-Length`)||`0`),s&&(0,r.isFiniteNumber)(t.highWaterMark)?i.loadProgressively(n,a,e,t.highWaterMark,s):c?n.arrayBuffer():n.text()}).then(function(o){var c=i.response;self.clearTimeout(i.requestTimeout),a.loading.end=Math.max(self.performance.now(),a.loading.first),a.loaded=a.total=o[l];var u={url:c.url,data:o};s&&!(0,r.isFiniteNumber)(t.highWaterMark)&&s(a,e,o,c),n.onSuccess(u,a,e,c)}).catch(function(t){if(self.clearTimeout(i.requestTimeout),!a.aborted){var r=t.code||0;n.onError({code:r,text:t.message},e,t.details)}})},t.getCacheAge=function(){var e=null;if(this.response){var t=this.response.headers.get(`age`);e=t?parseFloat(t):null}return e},t.loadProgressively=function(e,t,n,r,i){r===void 0&&(r=0);var o=new a.default,s=e.body.getReader();return function a(){return s.read().then(function(s){if(s.done)return o.dataLength&&i(t,n,o.flush(),e),Promise.resolve(new ArrayBuffer(0));var c=s.value,l=c.length;return t.loaded+=l,l<r||o.dataLength?(o.push(c),o.dataLength>=r&&i(t,n,o.flush(),e)):i(t,n,c,e),a()}).catch(function(){return Promise.reject()})}()},e}();function g(e,t){var n={method:`GET`,mode:`cors`,credentials:`same-origin`,signal:t,headers:new self.Headers(p({},e.headers))};return e.rangeEnd&&n.headers.set(`Range`,`bytes=`+e.rangeStart+`-`+String(e.rangeEnd-1)),n}function _(e,t){return new self.Request(e.url,t)}var v=function(e){o(t,e);function t(t,n,r){var i=e.call(this,t)||this;return i.code=void 0,i.details=void 0,i.code=n,i.details=r,i}return t}(s(Error));t.default=h}),"./src/utils/imsc1-ttml-parser.ts":(function(e,t,n){n.r(t),n.d(t,`IMSC1_CODEC`,function(){return u}),n.d(t,`parseIMSC1`,function(){return m});var r=n(`./src/utils/mp4-tools.ts`),i=n(`./src/utils/vttparser.ts`),a=n(`./src/utils/vttcue.ts`),o=n(`./src/demux/id3.ts`),s=n(`./src/utils/timescale-conversion.ts`),c=n(`./src/utils/webvtt-parser.ts`);function l(){return l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},l.apply(this,arguments)}var u=`stpp.ttml.im1t`,d=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,f=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,p={left:`start`,center:`center`,right:`end`,start:`start`,end:`end`};function m(e,t,n,i,a){var c=(0,r.findBox)(new Uint8Array(e),[`mdat`]);if(c.length===0){a(Error(`Could not parse IMSC1 mdat`));return}var l=c[0],u=(0,o.utf8ArrayToStr)(new Uint8Array(e,l.start,l.end-l.start)),d=(0,s.toTimescaleFromScale)(t,1,n);try{i(h(u,d))}catch(e){a(e)}}function h(e,t){var n=new DOMParser().parseFromString(e,`text/xml`).getElementsByTagName(`tt`)[0];if(!n)throw Error(`Invalid ttml`);var r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},i=Object.keys(r).reduce(function(e,t){return e[t]=n.getAttribute(`ttp:`+t)||r[t],e},{}),o=n.getAttribute(`xml:space`)!==`preserve`,s=_(g(n,`styling`,`style`)),u=_(g(n,`layout`,`region`)),d=g(n,`body`,`[begin]`);return[].map.call(d,function(e){var n=v(e,o);if(!n||!e.hasAttribute(`begin`))return null;var r=S(e.getAttribute(`begin`),i),d=S(e.getAttribute(`dur`),i),f=S(e.getAttribute(`end`),i);if(r===null)throw x(e);if(f===null){if(d===null)throw x(e);f=r+d}var m=new a.default(r-t,f-t,n);m.id=(0,c.generateCueId)(m.startTime,m.endTime,m.text);var h=u[e.getAttribute(`region`)],g=s[e.getAttribute(`style`)];m.position=10,m.size=80;var _=y(h,g),b=_.textAlign;if(b){var C=p[b];C&&(m.lineAlign=C),m.align=b}return l(m,_),m}).filter(function(e){return e!==null})}function g(e,t,n){var r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(n)):[]}function _(e){return e.reduce(function(e,t){var n=t.getAttribute(`xml:id`);return n&&(e[n]=t),e},{})}function v(e,t){return[].slice.call(e.childNodes).reduce(function(e,n,r){var i;return n.nodeName===`br`&&r?e+`
`:(i=n.childNodes)!=null&&i.length?v(n,t):t?e+n.textContent.trim().replace(/\s+/g,` `):e+n.textContent},``)}function y(e,t){var n=`http://www.w3.org/ns/ttml#styling`;return[`displayAlign`,`textAlign`,`color`,`backgroundColor`,`fontSize`,`fontFamily`].reduce(function(r,i){var a=b(t,n,i)||b(e,n,i);return a&&(r[i]=a),r},{})}function b(e,t,n){return e.hasAttributeNS(t,n)?e.getAttributeNS(t,n):null}function x(e){return Error(`Could not parse ttml timestamp `+e)}function S(e,t){if(!e)return null;var n=(0,i.parseTimeStamp)(e);return n===null&&(d.test(e)?n=C(e,t):f.test(e)&&(n=w(e,t))),n}function C(e,t){var n=d.exec(e),r=(n[4]|0)+(n[5]|0)/t.subFrameRate;return(n[1]|0)*3600+(n[2]|0)*60+(n[3]|0)+r/t.frameRate}function w(e,t){var n=f.exec(e),r=Number(n[1]);switch(n[2]){case`h`:return r*3600;case`m`:return r*60;case`ms`:return r*1e3;case`f`:return r/t.frameRate;case`t`:return r/t.tickRate}return r}}),"./src/utils/logger.ts":(function(e,t,n){n.r(t),n.d(t,`enableLogs`,function(){return c}),n.d(t,`logger`,function(){return l});var r=function(){},i={trace:r,debug:r,log:r,warn:r,info:r,error:r},a=i;function o(e){var t=self.console[e];return t?t.bind(self.console,`[`+e+`] >`):r}function s(e){[...arguments].slice(1).forEach(function(t){a[t]=e[t]?e[t].bind(e):o(t)})}function c(e){if(self.console&&e===!0||typeof e==`object`){s(e,`debug`,`log`,`info`,`warn`,`error`);try{a.log()}catch{a=i}}else a=i}var l=a}),"./src/utils/mediakeys-helper.ts":(function(e,t,n){n.r(t),n.d(t,`KeySystems`,function(){return r}),n.d(t,`requestMediaKeySystemAccess`,function(){return i});var r;(function(e){e.WIDEVINE=`com.widevine.alpha`,e.PLAYREADY=`com.microsoft.playready`})(r||={});var i=function(){return typeof self<`u`&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}()}),"./src/utils/mediasource-helper.ts":(function(e,t,n){n.r(t),n.d(t,`getMediaSource`,function(){return r});function r(){return self.MediaSource||self.WebKitMediaSource}}),"./src/utils/mp4-tools.ts":(function(e,t,n){n.r(t),n.d(t,`bin2str`,function(){return s}),n.d(t,`readUint16`,function(){return c}),n.d(t,`readUint32`,function(){return l}),n.d(t,`writeUint32`,function(){return u}),n.d(t,`findBox`,function(){return d}),n.d(t,`parseSegmentIndex`,function(){return f}),n.d(t,`parseInitSegment`,function(){return p}),n.d(t,`getStartDTS`,function(){return m}),n.d(t,`getDuration`,function(){return h}),n.d(t,`computeRawDurationFromSamples`,function(){return g}),n.d(t,`offsetStartDTS`,function(){return _}),n.d(t,`segmentValidRange`,function(){return v}),n.d(t,`appendUint8Array`,function(){return y});var r=n(`./src/utils/typed-array.ts`),i=n(`./src/loader/fragment.ts`),a=2**32-1,o=[].push;function s(e){return String.fromCharCode.apply(null,e)}function c(e,t){`data`in e&&(t+=e.start,e=e.data);var n=e[t]<<8|e[t+1];return n<0?65536+n:n}function l(e,t){`data`in e&&(t+=e.start,e=e.data);var n=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return n<0?4294967296+n:n}function u(e,t,n){`data`in e&&(t+=e.start,e=e.data),e[t]=n>>24,e[t+1]=n>>16&255,e[t+2]=n>>8&255,e[t+3]=n&255}function d(e,t){var n=[];if(!t.length)return n;var r,i,a;`data`in e?(r=e.data,i=e.start,a=e.end):(r=e,i=0,a=r.byteLength);for(var c=i;c<a;){var u=l(r,c),f=s(r.subarray(c+4,c+8)),p=u>1?c+u:a;if(f===t[0])if(t.length===1)n.push({data:r,start:c+8,end:p});else{var m=d({data:r,start:c+8,end:p},t.slice(1));m.length&&o.apply(n,m)}c=p}return n}function f(e){var t=d(e,[`moov`])[0],n=t?t.end:null,r=d(e,[`sidx`]);if(!r||!r[0])return null;var i=[],a=r[0],o=a.data[0],s=o===0?8:16,u=l(a,s);s+=4;var f=0,p=0;o===0?s+=8:s+=16,s+=2;var m=a.end+p,h=c(a,s);s+=2;for(var g=0;g<h;g++){var _=s,v=l(a,_);_+=4;var y=v&2147483647;if((v&2147483648)>>>31==1)return console.warn(`SIDX has hierarchical references (not supported)`),null;var b=l(a,_);_+=4,i.push({referenceSize:y,subsegmentDuration:b,info:{duration:b/u,start:m,end:m+y-1}}),m+=y,_+=4,s=_}return{earliestPresentationTime:f,timescale:u,version:o,referencesCount:h,references:i,moovEndOffset:n}}function p(e){for(var t=[],n=d(e,[`moov`,`trak`]),r=0;r<n.length;r++){var a=n[r],o=d(a,[`tkhd`])[0];if(o){var c=o.data[o.start],u=c===0?12:20,f=l(o,u),p=d(a,[`mdia`,`mdhd`])[0];if(p){c=p.data[p.start],u=c===0?12:20;var m=l(p,u),h=d(a,[`mdia`,`hdlr`])[0];if(h){var g=s(h.data.subarray(h.start+8,h.start+12)),_={soun:i.ElementaryStreamTypes.AUDIO,vide:i.ElementaryStreamTypes.VIDEO}[g];if(_){var v=d(a,[`mdia`,`minf`,`stbl`,`stsd`])[0],y=void 0;v&&(y=s(v.data.subarray(v.start+12,v.start+16))),t[f]={timescale:m,type:_},t[_]={timescale:m,id:f,codec:y}}}}}}return d(e,[`moov`,`mvex`,`trex`]).forEach(function(e){var n=t[l(e,4)];n&&(n.default={duration:l(e,12),flags:l(e,20)})}),t}function m(e,t){return d(t,[`moof`,`traf`]).reduce(function(t,n){var r=d(n,[`tfdt`])[0],i=r.data[r.start],a=d(n,[`tfhd`]).reduce(function(t,n){var a=e[l(n,4)];if(a){var o=l(r,4);i===1&&(o*=2**32,o+=l(r,8));var s=a.timescale||9e4,c=o/s;if(isFinite(c)&&(t===null||c<t))return c}return t},null);return a!==null&&isFinite(a)&&(t===null||a<t)?a:t},null)||0}function h(e,t){for(var n=0,r=0,a=0,o=d(e,[`moof`,`traf`]),s=0;s<o.length;s++){var c=o[s],u=d(c,[`tfhd`])[0],p=t[l(u,4)];if(p){var m=p.default,h=l(u,0)|m?.flags,_=m?.duration;h&8&&(_=h&2?l(u,12):l(u,8));for(var v=p.timescale||9e4,y=d(c,[`trun`]),b=0;b<y.length;b++){if(n=g(y[b]),!n&&_){var x=l(y[b],4);n=_*x}p.type===i.ElementaryStreamTypes.VIDEO?r+=n/v:p.type===i.ElementaryStreamTypes.AUDIO&&(a+=n/v)}}}if(r===0&&a===0){var S=f(e);if(S!=null&&S.references)return S.references.reduce(function(e,t){return e+t.info.duration||0},0)}return r||a}function g(e){var t=l(e,0),n=8;t&1&&(n+=4),t&4&&(n+=4);for(var r=0,i=l(e,4),a=0;a<i;a++){if(t&256){var o=l(e,n);r+=o,n+=4}t&512&&(n+=4),t&1024&&(n+=4),t&2048&&(n+=4)}return r}function _(e,t,n){d(t,[`moof`,`traf`]).forEach(function(t){d(t,[`tfhd`]).forEach(function(r){var i=e[l(r,4)];if(i){var o=i.timescale||9e4;d(t,[`tfdt`]).forEach(function(e){var t=e.data[e.start],r=l(e,4);if(t===0)u(e,4,r-n*o);else{r*=2**32,r+=l(e,8),r-=n*o,r=Math.max(r,0);var i=Math.floor(r/(a+1)),s=Math.floor(r%(a+1));u(e,4,i),u(e,8,s)}})}})})}function v(e){var t={valid:null,remainder:null},n=d(e,[`moof`]);if(n){if(n.length<2)return t.remainder=e,t}else return t;var i=n[n.length-1];return t.valid=(0,r.sliceUint8)(e,0,i.start-8),t.remainder=(0,r.sliceUint8)(e,i.start-8),t}function y(e,t){var n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}}),"./src/utils/output-filter.ts":(function(e,t,n){n.r(t),n.d(t,`default`,function(){return r});var r=function(){function e(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}var t=e.prototype;return t.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},t.newCue=function(e,t,n){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)},t.reset=function(){this.cueRanges=[],this.startTime=null},e}()}),"./src/utils/texttrack-utils.ts":(function(e,t,n){n.r(t),n.d(t,`sendAddTrackEvent`,function(){return i}),n.d(t,`addCueToTrack`,function(){return a}),n.d(t,`clearCurrentCues`,function(){return o}),n.d(t,`removeCuesInRange`,function(){return s}),n.d(t,`getCuesInRange`,function(){return l});var r=n(`./src/utils/logger.ts`);function i(e,t){var n;try{n=new Event(`addtrack`)}catch{n=document.createEvent(`Event`),n.initEvent(`addtrack`,!1,!1)}n.track=e,t.dispatchEvent(n)}function a(e,t){var n=e.mode;if(n===`disabled`&&(e.mode=`hidden`),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw Error(`addCue is failed for: `+t)}catch(n){r.logger.debug(`[texttrack-utils]: `+n);var i=new self.TextTrackCue(t.startTime,t.endTime,t.text);i.id=t.id,e.addCue(i)}n===`disabled`&&(e.mode=n)}function o(e){var t=e.mode;if(t===`disabled`&&(e.mode=`hidden`),e.cues)for(var n=e.cues.length;n--;)e.removeCue(e.cues[n]);t===`disabled`&&(e.mode=t)}function s(e,t,n){var r=e.mode;if(r===`disabled`&&(e.mode=`hidden`),e.cues&&e.cues.length>0)for(var i=l(e.cues,t,n),a=0;a<i.length;a++)e.removeCue(i[a]);r===`disabled`&&(e.mode=r)}function c(e,t){if(t<e[0].startTime)return 0;var n=e.length-1;if(t>e[n].endTime)return-1;for(var r=0,i=n;r<=i;){var a=Math.floor((i+r)/2);if(t<e[a].startTime)i=a-1;else if(t>e[a].startTime&&r<n)r=a+1;else return a}return e[r].startTime-t<t-e[i].startTime?r:i}function l(e,t,n){var r=[],i=c(e,t);if(i>-1)for(var a=i,o=e.length;a<o;a++){var s=e[a];if(s.startTime>=t&&s.endTime<=n)r.push(s);else if(s.startTime>n)return r}return r}}),"./src/utils/time-ranges.ts":(function(e,t,n){n.r(t),t.default={toString:function(e){for(var t=``,n=e.length,r=0;r<n;r++)t+=`[`+e.start(r).toFixed(3)+`,`+e.end(r).toFixed(3)+`]`;return t}}}),"./src/utils/timescale-conversion.ts":(function(e,t,n){n.r(t),n.d(t,`toTimescaleFromBase`,function(){return i}),n.d(t,`toTimescaleFromScale`,function(){return a}),n.d(t,`toMsFromMpegTsClock`,function(){return o}),n.d(t,`toMpegTsClockFromTimescale`,function(){return s});var r=9e4;function i(e,t,n,r){n===void 0&&(n=1),r===void 0&&(r=!1);var i=e*t*n;return r?Math.round(i):i}function a(e,t,n,r){return n===void 0&&(n=1),r===void 0&&(r=!1),i(e,t,1/n,r)}function o(e,t){return t===void 0&&(t=!1),i(e,1e3,1/r,t)}function s(e,t){return t===void 0&&(t=1),i(e,r,1/t)}}),"./src/utils/typed-array.ts":(function(e,t,n){n.r(t),n.d(t,`sliceUint8`,function(){return r});function r(e,t,n){return Uint8Array.prototype.slice?e.slice(t,n):new Uint8Array(Array.prototype.slice.call(e,t,n))}}),"./src/utils/vttcue.ts":(function(e,t,n){n.r(t),t.default=(function(){if(typeof self<`u`&&self.VTTCue)return self.VTTCue;var e=[``,`lr`,`rl`],t=[`start`,`middle`,`end`,`left`,`right`];function n(e,t){if(typeof t!=`string`||!Array.isArray(e))return!1;var n=t.toLowerCase();return~e.indexOf(n)?n:!1}function r(t){return n(e,t)}function i(e){return n(t,e)}function a(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}function o(e,t,n){var o=this,s={enumerable:!0};o.hasBeenReset=!1;var c=``,l=!1,u=e,d=t,f=n,p=null,m=``,h=!0,g=`auto`,_=`start`,v=50,y=`middle`,b=50,x=`middle`;Object.defineProperty(o,`id`,a({},s,{get:function(){return c},set:function(e){c=``+e}})),Object.defineProperty(o,`pauseOnExit`,a({},s,{get:function(){return l},set:function(e){l=!!e}})),Object.defineProperty(o,`startTime`,a({},s,{get:function(){return u},set:function(e){if(typeof e!=`number`)throw TypeError(`Start time must be set to a number.`);u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`endTime`,a({},s,{get:function(){return d},set:function(e){if(typeof e!=`number`)throw TypeError(`End time must be set to a number.`);d=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`text`,a({},s,{get:function(){return f},set:function(e){f=``+e,this.hasBeenReset=!0}})),Object.defineProperty(o,`region`,a({},s,{get:function(){return p},set:function(e){p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`vertical`,a({},s,{get:function(){return m},set:function(e){var t=r(e);if(t===!1)throw SyntaxError(`An invalid or illegal string was specified.`);m=t,this.hasBeenReset=!0}})),Object.defineProperty(o,`snapToLines`,a({},s,{get:function(){return h},set:function(e){h=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,`line`,a({},s,{get:function(){return g},set:function(e){if(typeof e!=`number`&&e!==`auto`)throw SyntaxError(`An invalid number or illegal string was specified.`);g=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`lineAlign`,a({},s,{get:function(){return _},set:function(e){var t=i(e);if(!t)throw SyntaxError(`An invalid or illegal string was specified.`);_=t,this.hasBeenReset=!0}})),Object.defineProperty(o,`position`,a({},s,{get:function(){return v},set:function(e){if(e<0||e>100)throw Error(`Position must be between 0 and 100.`);v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`positionAlign`,a({},s,{get:function(){return y},set:function(e){var t=i(e);if(!t)throw SyntaxError(`An invalid or illegal string was specified.`);y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,`size`,a({},s,{get:function(){return b},set:function(e){if(e<0||e>100)throw Error(`Size must be between 0 and 100.`);b=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`align`,a({},s,{get:function(){return x},set:function(e){var t=i(e);if(!t)throw SyntaxError(`An invalid or illegal string was specified.`);x=t,this.hasBeenReset=!0}})),o.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o})()}),"./src/utils/vttparser.ts":(function(e,t,n){n.r(t),n.d(t,`parseTimeStamp`,function(){return a}),n.d(t,`fixLineBreaks`,function(){return d}),n.d(t,`VTTParser`,function(){return f});var r=n(`./src/utils/vttcue.ts`),i=function(){function e(){}var t=e.prototype;return t.decode=function(e,t){if(!e)return``;if(typeof e!=`string`)throw Error(`Error - expected string data.`);return decodeURIComponent(encodeURIComponent(e))},e}();function a(e){function t(e,t,n,r){return(e|0)*3600+(t|0)*60+(n|0)+parseFloat(r||0)}var n=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?t(n[2],n[3],0,n[4]):t(n[1],n[2],n[3],n[4]):null}var o=function(){function e(){this.values=Object.create(null)}var t=e.prototype;return t.set=function(e,t){!this.get(e)&&t!==``&&(this.values[e]=t)},t.get=function(e,t,n){return n?this.has(e)?this.values[e]:t[n]:this.has(e)?this.values[e]:t},t.has=function(e){return e in this.values},t.alt=function(e,t,n){for(var r=0;r<n.length;++r)if(t===n[r]){this.set(e,t);break}},t.integer=function(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))},t.percent=function(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var n=parseFloat(t);if(n>=0&&n<=100)return this.set(e,n),!0}return!1},e}();function s(e,t,n,r){var i=r?e.split(r):[e];for(var a in i)if(typeof i[a]==`string`){var o=i[a].split(n);if(o.length===2){var s=o[0],c=o[1];t(s,c)}}}var c=new r.default(0,0,``),l=c.align===`middle`?`middle`:`center`;function u(e,t,n){var r=e;function i(){var t=a(e);if(t===null)throw Error(`Malformed timestamp: `+r);return e=e.replace(/^[^\sa-zA-Z-]+/,``),t}function u(e,t){var r=new o;s(e,function(e,t){var i;switch(e){case`region`:for(var a=n.length-1;a>=0;a--)if(n[a].id===t){r.set(e,n[a].region);break}break;case`vertical`:r.alt(e,t,[`rl`,`lr`]);break;case`line`:i=t.split(`,`),r.integer(e,i[0]),r.percent(e,i[0])&&r.set(`snapToLines`,!1),r.alt(e,i[0],[`auto`]),i.length===2&&r.alt(`lineAlign`,i[1],[`start`,l,`end`]);break;case`position`:i=t.split(`,`),r.percent(e,i[0]),i.length===2&&r.alt(`positionAlign`,i[1],[`start`,l,`end`,`line-left`,`line-right`,`auto`]);break;case`size`:r.percent(e,t);break;case`align`:r.alt(e,t,[`start`,l,`end`,`left`,`right`]);break}},/:/,/\s/),t.region=r.get(`region`,null),t.vertical=r.get(`vertical`,``);var i=r.get(`line`,`auto`);i===`auto`&&c.line===-1&&(i=-1),t.line=i,t.lineAlign=r.get(`lineAlign`,`start`),t.snapToLines=r.get(`snapToLines`,!0),t.size=r.get(`size`,100),t.align=r.get(`align`,l);var a=r.get(`position`,`auto`);a===`auto`&&c.position===50&&(a=t.align===`start`||t.align===`left`?0:t.align===`end`||t.align===`right`?100:50),t.position=a}function d(){e=e.replace(/^\s+/,``)}if(d(),t.startTime=i(),d(),e.substr(0,3)!==`-->`)throw Error(`Malformed time stamp (time stamps must be separated by '-->'): `+r);e=e.substr(3),d(),t.endTime=i(),d(),u(e,t)}function d(e){return e.replace(/<br(?: \/)?>/gi,`
`)}var f=function(){function e(){this.state=`INITIAL`,this.buffer=``,this.decoder=new i,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var t=e.prototype;return t.parse=function(e){var t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function n(){var e=t.buffer,n=0;for(e=d(e);n<e.length&&e[n]!==`\r`&&e[n]!==`
`;)++n;var r=e.substr(0,n);return e[n]===`\r`&&++n,e[n]===`
`&&++n,t.buffer=e.substr(n),r}function i(e){s(e,function(e,t){},/:/)}try{var a=``;if(t.state===`INITIAL`){if(!/\r\n|\n/.test(t.buffer))return this;a=n();var o=a.match(/^()?WEBVTT([ \t].*)?$/);if(!o||!o[0])throw Error(`Malformed WebVTT signature.`);t.state=`HEADER`}for(var c=!1;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(c?c=!1:a=n(),t.state){case`HEADER`:/:/.test(a)?i(a):a||(t.state=`ID`);continue;case`NOTE`:a||(t.state=`ID`);continue;case`ID`:if(/^NOTE($|[ \t])/.test(a)){t.state=`NOTE`;break}if(!a)continue;if(t.cue=new r.default(0,0,``),t.state=`CUE`,a.indexOf(`-->`)===-1){t.cue.id=a;continue}case`CUE`:if(!t.cue){t.state=`BADCUE`;continue}try{u(a,t.cue,t.regionList)}catch{t.cue=null,t.state=`BADCUE`;continue}t.state=`CUETEXT`;continue;case`CUETEXT`:var l=a.indexOf(`-->`)!==-1;if(!a||l&&(c=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state=`ID`;continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=a;continue;case`BADCUE`:a||(t.state=`ID`)}}}catch{t.state===`CUETEXT`&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state===`INITIAL`?`BADWEBVTT`:`BADCUE`}return this},t.flush=function(){var e=this;try{if((e.cue||e.state===`HEADER`)&&(e.buffer+=`

`,e.parse()),e.state===`INITIAL`||e.state===`BADWEBVTT`)throw Error(`Malformed WebVTT signature.`)}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this},e}()}),"./src/utils/webvtt-parser.ts":(function(e,t,n){n.r(t),n.d(t,`generateCueId`,function(){return f}),n.d(t,`parseWebVTT`,function(){return m});var r=n(`./src/polyfills/number.ts`),i=n(`./src/utils/vttparser.ts`),a=n(`./src/demux/id3.ts`),o=n(`./src/utils/timescale-conversion.ts`),s=n(`./src/remux/mp4-remuxer.ts`),c=/\r\n|\n\r|\n|\r/g,l=function(e,t,n){return n===void 0&&(n=0),e.substr(n,t.length)===t},u=function(e){var t=parseInt(e.substr(-3)),n=parseInt(e.substr(-6,2)),i=parseInt(e.substr(-9,2)),a=e.length>9?parseInt(e.substr(0,e.indexOf(`:`))):0;if(!(0,r.isFiniteNumber)(t)||!(0,r.isFiniteNumber)(n)||!(0,r.isFiniteNumber)(i)||!(0,r.isFiniteNumber)(a))throw Error(`Malformed X-TIMESTAMP-MAP: Local:`+e);return t+=1e3*n,t+=60*1e3*i,t+=3600*1e3*a,t},d=function(e){for(var t=5381,n=e.length;n;)t=t*33^e.charCodeAt(--n);return(t>>>0).toString()};function f(e,t,n){return d(e.toString())+d(t.toString())+d(n)}var p=function(e,t,n){var r=e[t],i=e[r.prevCC];if(!i||!i.new&&r.new){e.ccOffset=e.presentationOffset=r.start,r.new=!1;return}for(;(a=i)!=null&&a.new;){var a;e.ccOffset+=r.start-i.start,r.new=!1,r=i,i=e[r.prevCC]}e.presentationOffset=n};function m(e,t,n,r,d,m,h,g){var _=new i.VTTParser,v=(0,a.utf8ArrayToStr)(new Uint8Array(e)).trim().replace(c,`
`).split(`
`),y=[],b=(0,o.toMpegTsClockFromTimescale)(t,n),x=`00:00.000`,S=0,C=0,w,T=!0,E=!1;_.oncue=function(e){var t=r[d],n=r.ccOffset,i=(S-b)/9e4;if(t!=null&&t.new&&(C===void 0?p(r,d,i):n=r.ccOffset=t.start),i&&(n=i-r.presentationOffset),E){var a=e.endTime-e.startTime,o=(0,s.normalizePts)((e.startTime+n-C)*9e4,m*9e4)/9e4;e.startTime=o,e.endTime=o+a}var c=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(c)),e.id||=f(e.startTime,e.endTime,c),e.endTime>0&&y.push(e)},_.onparsingerror=function(e){w=e},_.onflush=function(){if(w){g(w);return}h(y)},v.forEach(function(e){if(T)if(l(e,`X-TIMESTAMP-MAP=`)){T=!1,E=!0,e.substr(16).split(`,`).forEach(function(e){l(e,`LOCAL:`)?x=e.substr(6):l(e,`MPEGTS:`)&&(S=parseInt(e.substr(7)))});try{C=u(x)/1e3}catch(e){E=!1,w=e}return}else e===``&&(T=!1);_.parse(e+`
`)}),_.flush()}}),"./src/utils/xhr-loader.ts":(function(e,t,n){n.r(t);var r=n(`./src/utils/logger.ts`),i=n(`./src/loader/load-stats.ts`),a=/^age:\s*[\d.]+\s*$/m;t.default=function(){function e(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=e?e.xhrSetup:null,this.stats=new i.LoadStats,this.retryDelay=0}var t=e.prototype;return t.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},t.abortInternal=function(){var e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))},t.abort=function(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},t.load=function(e,t,n){if(this.stats.loading.start)throw Error(`Loader can only be used once.`);this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=n,this.retryDelay=t.retryDelay,this.loadInternal()},t.loadInternal=function(){var e=this.config,t=this.context;if(e){var n=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0;var i=this.xhrSetup;try{if(i)try{i(n,t.url)}catch{n.open(`GET`,t.url,!0),i(n,t.url)}n.readyState||n.open(`GET`,t.url,!0);var a=this.context.headers;if(a)for(var o in a)n.setRequestHeader(o,a[o])}catch(e){this.callbacks.onError({code:n.status,text:e.message},t,n);return}t.rangeEnd&&n.setRequestHeader(`Range`,`bytes=`+t.rangeStart+`-`+(t.rangeEnd-1)),n.onreadystatechange=this.readystatechange.bind(this),n.onprogress=this.loadprogress.bind(this),n.responseType=t.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),e.timeout),n.send()}},t.readystatechange=function(){var e=this.context,t=this.loader,n=this.stats;if(!(!e||!t)){var i=t.readyState,a=this.config;if(!n.aborted&&i>=2)if(self.clearTimeout(this.requestTimeout),n.loading.first===0&&(n.loading.first=Math.max(self.performance.now(),n.loading.start)),i===4){t.onreadystatechange=null,t.onprogress=null;var o=t.status;if(o>=200&&o<300){n.loading.end=Math.max(self.performance.now(),n.loading.first);var s,c;if(e.responseType===`arraybuffer`?(s=t.response,c=s.byteLength):(s=t.responseText,c=s.length),n.loaded=n.total=c,!this.callbacks)return;var l=this.callbacks.onProgress;if(l&&l(n,e,s,t),!this.callbacks)return;var u={url:t.responseURL,data:s};this.callbacks.onSuccess(u,n,e,t)}else n.retry>=a.maxRetry||o>=400&&o<499?(r.logger.error(o+` while loading `+e.url),this.callbacks.onError({code:o,text:t.statusText},e,t)):(r.logger.warn(o+` while loading `+e.url+`, retrying in `+this.retryDelay+`...`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,a.maxRetryDelay),n.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),a.timeout)}},t.loadtimeout=function(){r.logger.warn(`timeout while loading `+this.context.url);var e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))},t.loadprogress=function(e){var t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)},t.getCacheAge=function(){var e=null;if(this.loader&&a.test(this.loader.getAllResponseHeaders())){var t=this.loader.getResponseHeader(`age`);e=t?parseFloat(t):null}return e},e}()})}).default})}));export default t();