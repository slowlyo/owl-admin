import{$o as e,Ao as t,Ar as n,Ci as r,Eo as i,Fo as a,Gr as o,Hn as s,Ko as c,Mn as l,Mo as u,No as d,Oa as f,Po as p,Yi as m,Zi as h,ci as g,cn as _,ei as v,ga as y,jo as b,kr as x,ni as S,oa as C,oi as w,qi as T,so as E,ti as D,wr as O,ya as k}from"./index-C4Pf1uQ-.js";var A=e(c()),j=e(l()),M=e(g()),N=e(i()),P=[`inited`,`onApiFetched`,`onSchemaApiFetched`,`onWsFetched`],F=function(e){d(i,e);function i(t){var n=e.call(this,t)||this;return n.dataProviders=n.initDataProviders(t.dataProvider),n.handleQuery=n.handleQuery.bind(n),n.handleAction=n.handleAction.bind(n),n.handleChange=n.handleChange.bind(n),n.reload=n.reload.bind(n),n.silentReload=n.silentReload.bind(n),n.initInterval=n.initInterval.bind(n),n.afterDataFetch=n.afterDataFetch.bind(n),n.afterSchemaFetch=n.afterSchemaFetch.bind(n),n.runDataProvider=n.runDataProvider.bind(n),n.dataProviderSetData=n.dataProviderSetData.bind(n),n}return i.prototype.componentDidMount=function(){return b(this,void 0,void 0,function(){var e,t,n,r;return p(this,function(i){switch(i.label){case 0:return e=this.props,t=e.data,n=e.dispatchEvent,this.mounted=!0,[4,n(`init`,t,this)];case 1:return r=i.sent(),r?.prevented||this.initFetch(),[2]}})})},i.prototype.componentDidUpdate=function(e){var t=this,n=this.props,r=n.store,i=n.messages,a=i.fetchSuccess,o=i.fetchFailed;n.dataProvider!==e.dataProvider&&(this.dataProviders=this.initDataProviders(n.dataProvider),this.dataProviders&&this.dataProviders?.inited&&this.runDataProvider(`inited`)),D(e.api,n.api,e.data,n.data)&&S(n.api,r.data)&&r.fetchData(n.api,r.data,{successMessage:a,errorMessage:o}).then(function(e){t.runDataProvider(`onApiFetched`),t.afterDataFetch(e)}),D(e.schemaApi,n.schemaApi,e.data,n.data)&&S(n.schemaApi,r.data)&&r.fetchSchema(n.schemaApi,r.data,{successMessage:a,errorMessage:o}).then(function(e){t.runDataProvider(`onSchemaApiFetched`),t.afterSchemaFetch(e)}),n.ws&&e.ws!==n.ws&&(this.socket&&this.socket.close(),this.socket=this.fetchWSData(n.ws,r.data)),m(e.defaultData,n.defaultData)&&r.reInitData(n.defaultData)},i.prototype.componentWillUnmount=function(){this.mounted=!1,this.runDataProviderUnsubscribe(),clearTimeout(this.timer),this.socket&&this.socket.close&&this.socket.close()},i.prototype.doAction=function(e,t,n,r){if(n===void 0&&(n=!1),e?.actionType===`rebuild`){var i=this.props,a=i.schemaApi,o=i.store,s=i.dataProvider,c=i.messages,l=c.fetchSuccess,u=c.fetchFailed;o.updateData(r),clearTimeout(this.timer),S(a,o.data)&&o.fetchSchema(a,o.data,{successMessage:l,errorMessage:u}).then(this.afterSchemaFetch),s&&this.runDataProvider(`inited`)}},i.prototype.initFetch=function(){var e=this,t=this.props,n=t.schemaApi,r=t.initFetchSchema,i=t.api,a=t.ws,o=t.initFetch,s=t.initFetchOn,c=t.dataProvider,l=t.store,u=t.messages,d=u.fetchSuccess,f=u.fetchFailed;S(n,l.data,r)&&l.fetchSchema(n,l.data,{successMessage:d,errorMessage:f}).then(function(t){e.runDataProvider(`onSchemaApiFetched`),e.afterSchemaFetch(t)}),S(i,l.data,o,s)&&l.fetchInitData(i,l.data,{successMessage:d,errorMessage:f}).then(function(t){e.runDataProvider(`onApiFetched`),e.afterDataFetch(t)}),a&&(this.socket=this.fetchWSData(a,l.data)),c&&this.runDataProvider(`inited`)},i.prototype.initDataProviders=function(e){var t=this,n=(0,N.default)(e)?(0,M.default)(e):e,r={};if(n)if((0,N.default)(n))Object.keys(n).forEach(function(e){var i=t.normalizeProvider(n[e],e);r=(0,j.default)(r,i||{})});else{var i=this.normalizeProvider(n,`inited`);r=(0,j.default)(r,i||{})}return r},i.prototype.normalizeProvider=function(e,t){var n,r;if(t===void 0&&(t=`inited`),!~P.indexOf(t))return null;if(typeof e==`function`)return n={},n[t]=e,n;if(typeof e==`string`){var i=w(e,`data`,`setData`,`env`);return i?(r={},r[t]=i,r):null}return null},i.prototype.runDataProvider=function(e){return b(this,void 0,void 0,function(){var t,n,r,i;return p(this,function(a){switch(a.label){case 0:return this.runDataProviderUnsubscribe(e),t=this.props.store,n=this.dataProviders,!(n&&~P.indexOf(e))||(r=n[e],!(r&&typeof r==`function`))?[3,2]:[4,r(t.data,this.dataProviderSetData,this.props.env)];case 1:i=a.sent(),typeof i==`function`&&(this.dataProviderUnsubscribe||={},this.dataProviderUnsubscribe[e]=i),a.label=2;case 2:return[2]}})})},i.prototype.runDataProviderUnsubscribe=function(e){var t,n=this.dataProviderUnsubscribe;if(n)if(e){var r=n[e];try{r&&typeof r==`function`&&r()}catch(e){console.error(e)}}else (t=Object.keys(n))==null||t.forEach(function(e){var t=n[e];try{t&&typeof t==`function`&&t()}catch(e){console.error(e)}})},i.prototype.dataProviderSetData=function(e){if(this.mounted){var t=this.props.store;t.updateData(e,void 0,!1),t.setHasRemoteData()}},i.prototype.fetchWSData=function(e,t){var n=this,r=this.props,i=r.env,a=r.store,o=v(e,t);i.wsFetcher(o,function(e){var t=e;if(`status`in e&&`data`in e&&(t=e.data,e.status!==0)){a.updateMessage(o?.messages?.failed??e.msg,!0),i.notify(`error`,o?.messages?.failed??e.msg);return}a.updateData(t,void 0,!1,o.concatDataFields),a.setHasRemoteData(),n.runDataProvider(`onWsFetched`),n.afterDataFetch({ok:!0,data:t})},function(e){a.updateMessage(e,!0),i.notify(`error`,e)})},i.prototype.afterDataFetch=function(e){var n=e?.hasOwnProperty(`ok`)?e.data??{}:e,r=this.props,i=r.onBulkChange,a=r.dispatchEvent,o=r.store,s=r.formStore;E(o)&&(a?.(`fetchInited`,f(this.props.data,t(t({},n),{__response:{msg:o.msg,error:o.error},responseData:n,responseStatus:e?.status===void 0?o.error?1:0:e?.status,responseMsg:o.msg}))),!T(n)&&i&&s&&i(n,!1,{type:`api`}),e!=null&&e.ok&&this.initInterval(n))},i.prototype.afterSchemaFetch=function(e){var n=this.props,r=n.onBulkChange,i=n.formStore,a=n.dispatchEvent,o=n.store;a?.(`fetchSchemaInited`,t(t({},e),{__response:{msg:o.msg,error:o.error},responseData:e,responseStatus:e?.status===void 0?o.error?1:0:e?.status,responseMsg:o.msg})),i&&e?.data&&r&&r&&r(e.data),this.initInterval(e)},i.prototype.initInterval=function(e){var t=this.props,n=t.interval,r=t.silentPolling,i=t.stopAutoRefreshWhen,a=t.data;return clearTimeout(this.timer),n&&this.mounted&&(!i||!y(i,f(a,e)))&&(this.timer=setTimeout(r?this.silentReload:this.reload,Math.max(n,1e3))),e},i.prototype.reload=function(e,t,n,r,i){return b(this,void 0,void 0,function(){var e,n,a,o,s,c,l,u,d,d;return p(this,function(f){switch(f.label){case 0:return t?[2,this.receive(t,void 0,i)]:(e=this.props,n=e.schemaApi,e.initFetchSchema,a=e.api,e.initFetch,e.initFetchOn,o=e.store,s=e.dataProvider,c=e.messages,l=c.fetchSuccess,u=c.fetchFailed,clearTimeout(this.timer),S(n,o.data)?[4,o.fetchSchema(n,o.data,{successMessage:l,errorMessage:u})]:[3,3]);case 1:return d=f.sent(),[4,this.runDataProvider(`onApiFetched`)];case 2:f.sent(),this.afterSchemaFetch(d),f.label=3;case 3:return S(a,o.data)?[4,o.fetchData(a,o.data,{silent:r,successMessage:l,errorMessage:u})]:[3,6];case 4:return d=f.sent(),[4,this.runDataProvider(`onSchemaApiFetched`)];case 5:f.sent(),this.afterDataFetch(d),f.label=6;case 6:return s?[4,this.runDataProvider(`inited`)]:[3,8];case 7:f.sent(),f.label=8;case 8:return[2,o.data]}})})},i.prototype.silentReload=function(e,t){this.reload(e,t,void 0,!0)},i.prototype.receive=function(e,t,n){return b(this,void 0,void 0,function(){var t;return p(this,function(r){return t=this.props.store,t.updateData(e,void 0,n),[2,this.reload()]})})},i.prototype.handleQuery=function(e){var t=this;if(this.props.api||this.props.schemaApi){if(e?.hasOwnProperty(`orderBy`)&&[this.props.api,this.props.schemaApi].every(function(n){return!n||!D(n,n,t.props.store.data,f(t.props.store.data,e))}))return!1;this.receive(e);return}return this.props.onQuery?this.props.onQuery(e):!1},i.prototype.reloadTarget=function(e,t){},i.prototype.handleDialogConfirm=function(e,t,n,r){this.props.store.closeDialog(!0,e)},i.prototype.handleDialogClose=function(e){e===void 0&&(e=!1),this.props.store.closeDialog(e)},i.prototype.openFeedback=function(e,t){var n=this;return new Promise(function(r){var i=n.props.store;i.setCurrentAction({type:`button`,actionType:`dialog`,dialog:e},n.props.resolveDefinitions),i.openDialog(t,void 0,function(e){r(e)},n.context)})},i.prototype.handleAction=function(e,t,r,i,a){var o=this;i===void 0&&(i=!1);var s=this.props,c=s.onAction,l=s.store,u=s.env,d=s.api,f=s.translate;return d&&t.actionType===`ajax`?(l.setCurrentAction(t,this.props.resolveDefinitions),l.saveRemote(t.api,r,{successMessage:f(t.messages&&t.messages.success),errorMessage:f(t.messages&&t.messages.failed)}).then(function(e){return b(o,void 0,void 0,function(){var r;return p(this,function(i){switch(i.label){case 0:return this.afterDataFetch(e),t.feedback&&h(t.feedback,l.data)?[4,this.openFeedback(t.feedback,l.data)]:[3,2];case 1:i.sent(),i.label=2;case 2:return r=t.redirect&&k(t.redirect,l.data),r&&u.jumpTo(r,t,l.data),t.reload&&this.reloadTarget(n(t.reload,l.data),l.data),[2]}})})}).catch(function(e){if(i||t.countDown)throw e})):c(e,t,r,i,a||this.context)},i.prototype.handleChange=function(e,t,n,r){var i,a,o=this.props,s=o.store,c=o.formStore,l=o.onChange;typeof t==`string`&&((a=(i=s).changeValue)==null||a.call(i,t,e),c&&l?.(e,t,n,r))},i.prototype.renderBody=function(){var e=this.props,t=e.render,n=e.store,r=e.body;return e.classnames,t(`body`,n.schema||r,{key:n.schemaKey||`body`,loading:n.loading,onQuery:this.handleQuery,onAction:this.handleAction,onChange:this.handleChange})},i.prototype.render=function(){var e=this.props,n=e.className,r=e.style,i=e.store,a=e.render,o=e.env,c=e.classPrefix,l=e.classnames,u=e.loadingConfig,d=e.showErrorMsg,f=e.testIdBuilder;return A.createElement(`div`,t({className:l(`${c}Service`,n),style:r},f?.getTestId()),!o.forceSilenceInsideError&&i.error&&d!==!1?A.createElement(_,{level:`danger`,showCloseButton:!0,onClose:function(){return i.updateMessage(``)}},i.msg):null,this.renderBody(),A.createElement(s,{size:`lg`,overlay:!0,key:`info`,show:i.loading,loadingConfig:u}),a(`modal`,t(t({},i.dialogSchema),{type:`dialog`}),{key:`dialog`,data:i.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:i.dialogOpen}))},i.defaultProps={messages:{fetchFailed:`fetchFailed`},showErrorMsg:!0},i.propsList=[],u([r,a(`design:type`,Function),a(`design:paramtypes`,[]),a(`design:returntype`,void 0)],i.prototype,`initFetch`,null),u([r,a(`design:type`,Function),a(`design:paramtypes`,[Object]),a(`design:returntype`,void 0)],i.prototype,`initDataProviders`,null),u([r,a(`design:type`,Function),a(`design:paramtypes`,[Object,String]),a(`design:returntype`,Object)],i.prototype,`normalizeProvider`,null),u([r,a(`design:type`,Function),a(`design:paramtypes`,[Array,Object,Object,Array]),a(`design:returntype`,void 0)],i.prototype,`handleDialogConfirm`,null),u([r,a(`design:type`,Function),a(`design:paramtypes`,[Object]),a(`design:returntype`,void 0)],i.prototype,`handleDialogClose`,null),i}(A.Component),I=function(e){d(t,e);function t(t,n){var r=e.call(this,t)||this;return n.registerComponent(r),r}return t.prototype.reload=function(t,n,r,i,a){return b(this,void 0,void 0,function(){var o;return p(this,function(s){return o=this.context,t?[2,o.reload(n?`${t}?${C(n)}`:t,r)]:[2,e.prototype.reload.call(this,t,n,r,i,a)]})})},t.prototype.receive=function(t,n,r){return b(this,void 0,void 0,function(){var i;return p(this,function(a){return i=this.context,n?[2,i.send(n,t)]:[2,e.prototype.receive.call(this,t,n,r)]})})},t.prototype.componentWillUnmount=function(){e.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},t.prototype.reloadTarget=function(e,t){this.context.reload(e,t)},t.prototype.setData=function(e,t){return this.props.store.updateData(e,void 0,t)},t.prototype.getData=function(){return this.props.store.data},t.contextType=x,t=u([O({type:`service`,storeType:o.name,isolateScope:!0,storeExtendsData:function(e){return!e.formStore}}),a(`design:paramtypes`,[Object,Object])],t),t}(F);export{I as ServiceRenderer,F as default,P as eventTypes};