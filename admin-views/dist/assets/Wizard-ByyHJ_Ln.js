import{$o as e,Ao as t,Ar as n,Ci as r,Fo as i,Gr as a,Hn as o,Io as s,Ko as c,Mo as l,No as u,Oa as d,Po as f,Ra as p,Ro as m,St as h,Va as g,Zi as _,_a as v,bi as y,da as b,ga as x,ir as S,jo as C,kr as w,ni as T,ti as E,wr as D,ya as O}from"./index-C4Pf1uQ-.js";var k=e(c()),A=e(g()),j=function(e){u(a,e);function a(){var t=e!==null&&e.apply(this,arguments)||this;return t.initalValues={},t.state={currentStep:-1,completeStep:-1,rawSteps:[]},t}return a.prototype.componentDidMount=function(){var e=this,t=this.props,n=t.initApi,r=t.initFetch,i=t.initAsyncApi,a=t.initFinishedField,o=t.store,s=t.messages,c=s.fetchSuccess,l=s.fetchFailed;t.onInit,T(n,o.data,r)?o.fetchInitData(n,o.data,{successMessage:c,errorMessage:l,onSuccess:function(){if(!(!T(i,o.data)||o.data[a||`finished`]))return b(function(){return o.checkRemote(i,o.data)},function(e){return e&&e[a||`finished`]},function(t){return e.asyncCancel=t})}}).then(function(t){e.handleFetchInitEvent(t);var n={currentStep:typeof e.props.startStep==`string`?S(p(e.props.startStep,d(e.props.data,t?.data||{})),1):1};return t&&t.data&&(typeof t.data.step==`number`||typeof t.data.step==`string`&&/^\d+$/.test(t.data.step))&&(n.currentStep=S(t.data.step,1)),e.setState(n,function(){t&&t.data&&(t.data.submiting||t.data.submited)&&e.checkSubmit()}),t}):this.setState({currentStep:typeof this.props.startStep==`string`?S(p(this.props.startStep,this.props.data),1):1}),this.normalizeSteps(o.data)},a.prototype.componentDidUpdate=function(e){var t=this.props,n=t.store,r=t.fetchSuccess,i=t.fetchFailed;(!(0,A.default)(e.steps,t.steps)||!(0,A.default)(e.data,t.data))&&this.normalizeSteps(t.data),E(e.initApi,t.initApi,e.data,t.data)&&n.fetchData(t.initApi,n.data,{successMessage:r,errorMessage:i})},a.prototype.componentWillUnmount=function(){this.asyncCancel&&this.asyncCancel()},a.prototype.dispatchEvent=function(e,t){return C(this,void 0,void 0,function(){var n,r,i,a;return f(this,function(o){switch(o.label){case 0:return n=this.props,r=n.dispatchEvent,i=n.data,[4,r(e,t?d(i,t):i)];case 1:return a=o.sent(),[2,a?.prevented??!1]}})})},a.prototype.handleFetchInitEvent=function(e){return C(this,void 0,void 0,function(){var n,r,i;return f(this,function(a){switch(a.label){case 0:return n=this.props,r=n.onInit,i=n.store,[4,this.dispatchEvent(`inited`,t(t({},i.data),{responseData:e.ok?i.data??{}:e,responseStatus:e?.status===void 0?i.error?1:0:e?.status,responseMsg:i.msg}))];case 1:return a.sent()&&r&&r(i.data),[2]}})})},a.prototype.normalizeSteps=function(e){return C(this,void 0,void 0,function(){var n,r,i,a,o,s,c;return f(this,function(l){switch(l.label){case 0:n=this.props,r=n.steps,i=n.translate,a=[],o=r.length,s=0,l.label=1;case 1:return s<o?[4,v(r[s].hiddenOn,e)]:[3,4];case 2:c=l.sent(),!c&&a.push(r[s]),l.label=3;case 3:return s++,[3,1];case 4:return this.setState({rawSteps:a.map(function(e,n){return t(t({},e),{hiddenOn:``,title:e.title||e.label||i(`Steps.step`,{index:n+1})})})}),[2]}})})},a.prototype.gotoStep=function(e){return C(this,void 0,void 0,function(){var t;return f(this,function(n){switch(n.label){case 0:return t=this.state.rawSteps,e=Math.max(Math.min(t.length,e),1),e==this.state.currentStep?[3,2]:[4,this.dispatchEvent(`stepChange`,{step:e})];case 1:if(n.sent())return[2];this.setState({currentStep:e,completeStep:Math.max(this.state.completeStep,e-1)}),n.label=2;case 2:return[2]}})})},a.prototype.formRef=function(e){if(e){for(;e&&e.getWrappedInstance;)e=e.getWrappedInstance();this.form=e}else this.form=void 0},a.prototype.submitToTarget=function(e,t){throw Error(`Please implements this!`)},a.prototype.reloadTarget=function(e,t){throw Error(`Please implements this!`)},a.prototype.reload=function(e,t,n,r,i){return C(this,void 0,void 0,function(){var e,n,r,a,o,s,c,l,u,d,p=this;return f(this,function(f){switch(f.label){case 0:return t?[2,this.receive(t,void 0,i)]:(e=this.props,n=e.initApi,r=e.initAsyncApi,a=e.initFinishedField,o=e.store,s=e.messages,c=s.fetchSuccess,l=s.fetchFailed,T(n,o.data)&&this.state.currentStep===1?[4,o.fetchInitData(n,o.data,{successMessage:c,errorMessage:l,onSuccess:function(){if(!(!T(r,o.data)||o.data[a||`finished`]))return b(function(){return o.checkRemote(r,o.data)},function(e){return e&&e[a||`finished`]},function(e){return p.asyncCancel=e})}})]:[3,2]);case 1:u=f.sent(),d={currentStep:1},u&&u.data&&(typeof u.data.step==`number`||typeof u.data.step==`string`&&/^\d+$/.test(u.data.step))&&(d.currentStep=S(u.data.step,1)),this.setState(d,function(){u&&u.data&&(u.data.submiting||u.data.submited)&&p.checkSubmit()}),f.label=2;case 2:return[2,o.data]}})})},a.prototype.receive=function(e,t,n){return this.props.store.updateData(e,void 0,n),this.reload()},a.prototype.domRef=function(e){this.dom=e},a.prototype.getPopOverContainer=function(){return this.dom},a.prototype.checkSubmit=function(){var e,t=this,n=this.props,r=n.store,i=n.asyncApi,a=n.finishedField,o=n.env,s=this.state.rawSteps,c=s[this.state.currentStep-1],l=c&&c.asyncApi||this.state.currentStep===s.length&&i;!c||!T(l,r.data)||(r.markSaving(!0),r.updateData((e={},e[a||`finished`]=!1,e)),b(function(){return r.checkRemote(l,r.data)},function(e){return e&&e[a||`finished`]},function(e){return t.asyncCancel=e}).then(function(){r.markSaving(!1),t.gotoStep(t.state.currentStep+1)}).catch(function(e){!l.silent&&o.notify(`error`,e.message),r.markSaving(!1)}))},a.prototype.handleAction=function(e,r,i,a,o){var s=this;a===void 0&&(a=!1);var c=this.props,l=c.onAction,u=c.store,d=c.env,p=this.state.rawSteps;if(r.actionType===`next`||r.type===`submit`||r.actionType===`step-submit`)this.form.doAction(t(t({},r),{actionType:`submit`}),i);else if(r.actionType===`prev`)this.gotoStep(this.state.currentStep-1);else if(r.type===`reset`)this.form.reset();else if(r.actionType===`dialog`)return u.setCurrentAction(r,this.props.resolveDefinitions),new Promise(function(e){u.openDialog(i,void 0,function(t,n){var i;(i=r.callback)==null||i.call(r,t,n),e({confirmed:t,value:n})},o||s.context)});else if(r.actionType===`ajax`)return r.api?u.saveRemote(r.api,i,{successMessage:r.messages&&r.messages.success,errorMessage:r.messages&&r.messages.failed}).then(function(){return C(s,void 0,void 0,function(){var e,t,i;return f(this,function(a){switch(a.label){case 0:return this.form&&this.form.isValidated()&&this.form.validate(!0),e=r.feedback,e&&_(e,u.data)?[4,this.openFeedback(e,u.data)]:[3,2];case 1:if(t=a.sent(),e.skipRestOnCancel&&!t||e.skipRestOnConfirm&&t)throw new y;a.label=2;case 2:return i=r.redirect&&O(r.redirect,u.data),i&&d.jumpTo(i,r,u.data),r.reload&&this.reloadTarget(n(r.reload,u.data),u.data),[2]}})})}).catch(function(e){}):d.alert(`当 actionType 为 ajax 时，请设置 api 属性`);else if(r.actionType===`reload`)r.target&&this.reloadTarget(n(r.target,i),i);else if(r.actionType===`goto-step`){var m=i.step;if(m!==void 0&&m<=p.length&&m>=0)return this.gotoStep(i.step)}else if(r.actionType===`submit`)return this.finalSubmit();else if(l)return l(e,r,i,a,o||this.context)},a.prototype.handleQuery=function(e){if(this.props.initApi){if(e?.hasOwnProperty(`orderBy`)&&!E(this.props.initApi,this.props.initApi,this.props.store.data,d(this.props.store.data,e)))return!1;this.receive(e);return}return this.props.onQuery?this.props.onQuery(e):!1},a.prototype.openFeedback=function(e,t){var n=this;return new Promise(function(r){var i=n.props.store;i.setCurrentAction({type:`button`,actionType:`dialog`,dialog:e},n.props.resolveDefinitions),i.openDialog(t,void 0,function(e){r(e)},n.context)})},a.prototype.handleChange=function(e){return C(this,void 0,void 0,function(){var n,r,i;return f(this,function(a){switch(a.label){case 0:return n=this.props.store,r=n.data,i=t(t({},r),e),[4,this.dispatchEvent(`change`,i)];case 1:return a.sent()||n.updateData(e),[2]}})})},a.prototype.handleInit=function(e){var t=this.state.currentStep;this.initalValues[t]=this.initalValues[t]||e,this.props.store.updateData(e)},a.prototype.handleReset=function(e){var t=this.props.store,n=this.initalValues[this.state.currentStep],r={};Object.keys(e).forEach(function(e){r[e]=n.hasOwnProperty(e)?n[e]:void 0}),t.updateData(r)},a.prototype.finalSubmit=function(e,r){return e===void 0&&(e={}),r===void 0&&(r={type:`submit`}),C(this,void 0,void 0,function(){var i,a,o,s,c,l,u,p,m,h,g,v,x,S,w,E,D=this;return f(this,function(k){switch(k.label){case 0:return i=this.props,a=i.store,o=i.api,s=i.asyncApi,c=i.finishedField,l=i.target,u=i.redirect,p=i.reload,m=i.env,h=i.onFinished,g=this.state.rawSteps,[4,this.dispatchEvent(`finished`,a.data)];case 1:if(k.sent())return[2];if(v=g[this.state.currentStep-1],a.updateData(e),l)this.submitToTarget(n(l,a.data),a.data),this.setState({completeStep:g.length});else if(r.api||v.api||o)x=r.asyncApi||v.asyncApi||s,T(x,a.data)&&a.updateData((E={},E[c||`finished`]=!1,E)),S=this.form?this.form.props.store:a,a.markSaving(!0),S.saveRemote(r.api||v.api||o,a.data,{onSuccess:function(e){return C(D,void 0,void 0,function(){var t,n,r=this;return f(this,function(i){switch(i.label){case 0:return[4,this.dispatchEvent(`submitSucc`,d(this.props.data,{result:e}))];case 1:return t=i.sent(),!T(x,a.data)||a.data[c||`finished`]?[2,{cbResult:null,dispatcher:t}]:(n=b(function(){return a.checkRemote(x,a.data)},function(e){return e&&e[c||`finished`]},function(e){return r.asyncCancel=e}),[2,{cbResult:n,dispatcher:t}])}})})},onFailed:function(e){return C(D,void 0,void 0,function(){var t;return f(this,function(n){switch(n.label){case 0:return a.markSaving(!1),[4,this.dispatchEvent(`submitFail`,d(this.props.data,{error:e}))];case 1:return t=n.sent(),[2,{dispatcher:t}]}})})}}).then(function(e){return C(D,void 0,void 0,function(){var i,o,s;return f(this,function(c){switch(c.label){case 0:return i=r.feedback,i&&_(i,e)?[4,this.openFeedback(i,e)]:[3,2];case 1:if(o=c.sent(),i.skipRestOnCancel&&!o||i.skipRestOnConfirm&&o)throw new y;c.label=2;case 2:if(this.setState({completeStep:g.length}),a.updateData(t(t({},a.data),e)),a.markSaving(!1),e&&typeof e.step==`number`)this.gotoStep(e.step);else if(h&&h(e,r)===!1)return[2,e];return s=(r.redirect||v.redirect||u)&&O(r.redirect||v.redirect||u,a.data),s?m.jumpTo(s,r,a.data):(r.reload||v.reload||p)&&this.reloadTarget(n(r.reload||v.reload||p,a.data),a.data),[2,e]}})})}).catch(function(e){});else{if(this.setState({completeStep:g.length}),h&&h(a.data,r)===!1)return[2];w=(r.redirect||v.redirect||u)&&O(r.redirect||v.redirect||u,a.data),w?m.jumpTo(w,r,a.data):(r.reload||v.reload||p)&&this.reloadTarget(n(r.reload||v.reload||p,a.data),a.data)}return[2]}})})},a.prototype.handleSubmit=function(e,t){var n,r=this,i=this.props,a=i.store,o=i.finishedField,s=this.state.rawSteps;if(this.state.currentStep<s.length){var c=s[this.state.currentStep-1];a.updateData(e);var l=t.asyncApi||c.asyncApi;T(l,a.data)&&a.updateData((n={},n[o||`finished`]=!1,n)),T(t.api||c.api,a.data)?a.saveRemote(t.api||c.api,a.data,{onSuccess:function(){if(r.dispatchEvent(`stepSubmitSucc`),!(!T(l,a.data)||a.data[o||`finished`]))return b(function(){return a.checkRemote(l,a.data)},function(e){return e&&e[o||`finished`]},function(e){return r.asyncCancel=e})},onFailed:function(e){r.dispatchEvent(`stepSubmitFail`,{error:e}),e.status===422&&e.errors&&r.form&&r.form.props.store.setFormItemErrors(e.errors)}}).then(function(e){return C(r,void 0,void 0,function(){var n,r;return f(this,function(i){switch(i.label){case 0:return n=t.feedback,n&&_(n,e)?[4,this.openFeedback(n,e)]:[3,2];case 1:if(r=i.sent(),n.skipRestOnCancel&&!r||n.skipRestOnConfirm&&r)throw new y;i.label=2;case 2:return this.gotoStep(e&&typeof e.step==`number`?e.step:this.state.currentStep+1),[2]}})})}).catch(function(e){r.dispatchEvent(`stepSubmitFail`,{error:e})}):this.gotoStep(this.state.currentStep+1)}else this.finalSubmit(e,t);return!1},a.prototype.handleDialogConfirm=function(e,t,n){var r=this.props.store;t.mergeData&&e.length===1&&e[0]&&n[0].props.type===`form`&&r.updateData(e[0]),r.closeDialog(!0,e)},a.prototype.handleDialogClose=function(e){e===void 0&&(e=!1),this.props.store.closeDialog(e)},a.prototype.handleJumpStep=function(e,t){var n=this.props.store,r=this.state.currentStep;M(t,e,r,n.data)&&this.gotoStep(e+1)},a.prototype.renderSteps=function(){var e=this.props,t=e.mode,n=e.classPrefix,r=e.classnames,i=e.stepsClassName,a=this.state,o=a.currentStep,s=a.rawSteps;return k.createElement(`div`,{className:r(`${n}-Wizard-steps`,i),id:`form-wizard`},Array.isArray(s)&&s.length?k.createElement(h,{steps:s,mode:t,current:o-1,onClickStep:this.handleJumpStep}):null)},a.prototype.renderActions=function(){var e=this,t=this.props,n=t.store,r=t.readOnly,i=t.disabled,a=t.actionClassName,o=t.actionPrevLabel,s=t.actionNextLabel,c=t.actionNextSaveLabel,l=t.actionFinishLabel,u=t.render,f=t.translate;t.classnames;var p=t.testIdBuilder,m=this.state.rawSteps;if(!Array.isArray(m))return null;var h=this.state.currentStep,g=m[h],_=m[h-2],v=n.loading,y=m[h-1];if(!y)return null;var b=_?M(_,h-2,h,n.data):!1;return y.actions&&Array.isArray(y.actions)?y.actions.length?k.createElement(k.default.Fragment,null,y.actions.map(function(t,n){return u(`action/${n}`,t,{key:`${h}-${n}`,data:d(e.props.data,{currentStep:h}),onAction:e.handleAction,disabled:t.disabled||v||i||t.actionType===`prev`&&!b||t.actionType===`next`&&r&&(!!y.api||!g)})})):null:k.createElement(k.default.Fragment,null,u(`prev-btn`,{type:`button`,label:f(o),actionType:`prev`,className:a,hiddenOn:"${currentStep === 1}",id:p?.getChild(`button-prev`).getTestIdValue()},{disabled:v||!b||i,onAction:this.handleAction,data:d(this.props.data,{currentStep:h})}),u(`next-btn`,{type:`button`,label:g?y.api?f(c):f(s):f(l),actionType:`next`,primary:!g||!!y.api,className:a,level:`primary`,id:p?.getChild(`button-next`).getTestIdValue()},{disabled:v||i||r&&(!!y.api||!g),onAction:this.handleAction}))},a.prototype.renderFooter=function(){var e=this.renderActions();if(!e)return e;var t=this.props,n=t.classnames,r=t.affixFooter,i=t.footerClassName,a=t.wrapWithPanel;return k.createElement(`div`,{role:`wizard-footer`,className:n(`Wizard-footer`,a?`Panel-footer`:``,r&&a?`Panel-fixedBottom`:``,i)},e)},a.prototype.renderWizard=function(){var e=this.props,n=e.className,r=e.steps,i=e.style,a=e.render,c=e.store,l=e.classPrefix,u=e.classnames,d=e.popOverContainer,f=e.mode,p=e.translate,h=e.loadingConfig,g=e.stepClassName,_=e.bodyClassName,v=e.wrapWithPanel,y=this.state,b=y.rawSteps,x=y.currentStep,S=Array.isArray(b)&&b.length>0?b:Array.isArray(r)?m([],s(r),!1).map(function(e){return delete e.hiddenOn,e}):null,C=Array.isArray(S)?S[x-1]:null;return k.createElement(`div`,{ref:this.domRef,className:u(v?`${l}Panel ${l}Panel--default`:``,`${l}Wizard ${l}Wizard--${f}`,n),style:i},k.createElement(`div`,{className:u(`${l}Wizard-step`,g)},this.renderSteps(),k.createElement(`div`,{role:`wizard-body`,className:u(`${l}Wizard-stepContent clearfix`,_)},C?a(`body`,t(t({},C),{type:`form`,wrapWithPanel:!1,api:null}),{key:this.state.currentStep,ref:this.formRef,onInit:this.handleInit,onReset:this.handleReset,onSubmit:this.handleSubmit,onAction:this.handleAction,onQuery:this.handleQuery,disabled:c.loading,popOverContainer:d||this.getPopOverContainer,onChange:this.handleChange,formStore:void 0}):x===-1?p(`loading`):k.createElement(`p`,{className:`text-danger`},p(`Wizard.configError`))),this.renderFooter()),a(`dialog`,t(t({},c.dialogSchema),{type:`dialog`}),{key:`dialog`,data:c.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:c.dialogOpen}),k.createElement(o,{loadingConfig:h,size:`lg`,overlay:!0,key:`info`,show:c.loading}))},a.prototype.render=function(){return this.renderWizard()},a.defaultProps={mode:`horizontal`,readOnly:!1,messages:{},actionClassName:``,actionPrevLabel:`Wizard.prev`,actionNextLabel:`Wizard.next`,actionNextSaveLabel:`Wizard.saveAndNext`,actionFinishLabel:`Wizard.finish`,startStep:`1`,wrapWithPanel:!0},a.propsList=[`steps`,`mode`,`messages`,`actionClassName`,`actionPrevLabel`,`actionNextLabel`,`actionNextSaveLabel`,`actionFinishLabel`,`onFinished`,`affixFooter`,`startStep`],l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,void 0)],a.prototype,`formRef`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,void 0)],a.prototype,`domRef`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[]),i(`design:returntype`,void 0)],a.prototype,`getPopOverContainer`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object,Object,Object,Boolean,Object]),i(`design:returntype`,void 0)],a.prototype,`handleAction`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,void 0)],a.prototype,`handleQuery`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,Promise)],a.prototype,`handleChange`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,void 0)],a.prototype,`handleInit`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,void 0)],a.prototype,`handleReset`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object,Object]),i(`design:returntype`,void 0)],a.prototype,`handleSubmit`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Array,Object,Array]),i(`design:returntype`,void 0)],a.prototype,`handleDialogConfirm`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Object]),i(`design:returntype`,void 0)],a.prototype,`handleDialogClose`,null),l([r,i(`design:type`,Function),i(`design:paramtypes`,[Number,Object]),i(`design:returntype`,void 0)],a.prototype,`handleJumpStep`,null),a}(k.Component);function M(e,t,n,r){var i=!1;return i=e&&e.hasOwnProperty(`jumpable`)?e.jumpable:e&&e.jumpableOn?x(e.jumpableOn,d(r,{currentStep:n})):t+1<n,i}var N=function(e){u(t,e);function t(t,n){var r=e.call(this,t)||this;return n.registerComponent(r),r}return t.prototype.componentWillUnmount=function(){this.context.unRegisterComponent(this),e.prototype.componentWillUnmount.call(this)},t.prototype.doAction=function(e,t,n){return n===void 0&&(n=!1),this.handleAction(void 0,e,t)},t.prototype.submitToTarget=function(e,t){this.context.send(e,t)},t.prototype.reloadTarget=function(e,t){this.context.reload(e,t)},t.prototype.handleDialogConfirm=function(t,n,r){e.prototype.handleDialogConfirm.call(this,t,n,r);var i=this.props.store,a=this.context;n.reload?a.reload(n.reload,i.data):i.action&&i.action.reload&&a.reload(i.action.reload,i.data)},t.prototype.setData=function(e,t){return this.props.store.updateData(e,void 0,t)},t.prototype.getData=function(){return this.props.store.data},t.contextType=w,l([r,i(`design:type`,Function),i(`design:paramtypes`,[Array,Object,Array]),i(`design:returntype`,void 0)],t.prototype,`handleDialogConfirm`,null),t=l([D({type:`wizard`,storeType:a.name,isolateScope:!0}),i(`design:paramtypes`,[Object,Object])],t),t}(j);export{N as WizardRenderer,j as default};