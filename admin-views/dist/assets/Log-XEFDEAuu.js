import{$o as e,Ao as t,Kn as n,Ko as r,La as i,Mo as a,No as o,Po as s,Zt as c,ei as l,jo as u,ni as d,ti as f,wr as p,xn as m}from"./index-C4Pf1uQ-.js";var h=e(r()),g={30:`black`,31:`red`,32:`green`,33:`yellow`,34:`blue`,35:`magenta`,36:`cyan`,37:`white`,90:`grey`},_={40:`black`,41:`red`,42:`green`,43:`yellow`,44:`blue`,45:`magenta`,46:`cyan`,47:`white`},v=function(e){o(r,e);function r(t){var n=e.call(this,t)||this;return n.isDone=!1,n.autoScroll=!1,n.state={lastLine:``,logs:[],originLastLine:``,originLogs:[],refresh:!0,showLineNumber:!1,filterWord:``},n.refresh=function(e){var t=n.state.refresh;n.setState({refresh:!t}),t||(n.clear(e),n.loadLogs()),e.preventDefault()},n.clear=function(e){n.setState({logs:n.logs=[],lastLine:n.lastLine=``,originLogs:[],originLastLine:``}),e?.preventDefault()},n.filterWord=function(e,t,r){var i=e,a=t;r!==``&&r!=null&&r.length>0&&(e=e.filter(function(e){return e.includes(r)}),t.includes(r)||(t=``)),n.setState({filterWord:r,lastLine:n.lastLine=t,logs:n.logs=e,originLogs:i,originLastLine:a})},n.addLines=function(e){e=e.concat();var t=n.props.maxLength,r=n.lastLine||``,i=(n.logs||[]).concat();e.length===1?(r+=e[0],n.setState({lastLine:n.lastLine=r})):(e[0]=r+(e[0]||``),r=e.pop()||``,t&&i.length+e.length>t&&i.splice(0,i.length+e.length-t),i=i.concat(e),n.filterWord(i,r,n.state.filterWord))},n.logRef=h.createRef(),n.autoScroll=t.autoScroll||!1,n.pauseOrResumeScrolling=n.pauseOrResumeScrolling.bind(n),n}return r.prototype.componentWillUnmount=function(){this.logRef&&this.logRef.current&&this.logRef.current.removeEventListener(`scroll`,this.pauseOrResumeScrolling)},r.prototype.componentDidMount=function(){if(this.autoScroll&&this.logRef&&this.logRef.current&&this.logRef.current.addEventListener(`scroll`,this.pauseOrResumeScrolling),this.props.source){var e=typeof this.props.source==`string`?i(this.props.source,this.props.data,`| raw`):this.props.source;e&&d(e)?this.loadLogs():(typeof e==`string`||Array.isArray(e)&&e.every(function(e){return typeof e==`string`}))&&(this.clear(),this.addLines(Array.isArray(e)?e:[e]))}},r.prototype.componentDidUpdate=function(e){if(this.autoScroll&&this.logRef&&this.logRef.current&&(this.logRef.current.scrollTop=this.logRef.current.scrollHeight),this.props.source){var t=typeof this.props.source==`string`?i(this.props.source,this.props.data,`| raw`):this.props.source;t&&d(t)?f(e.source,this.props.source,e.data,this.props.data)&&this.loadLogs():(typeof t==`string`||Array.isArray(t)&&t.every(function(e){return typeof e==`string`}))&&i(e.source,e.data,`| raw`)!==t&&t&&(this.clear(),this.addLines(Array.isArray(t)?t:[t]))}},r.prototype.pauseOrResumeScrolling=function(){if(this.logRef&&this.logRef.current){var e=this.logRef.current;this.autoScroll=e.scrollHeight-(e.scrollTop+e.offsetHeight)<50}},r.prototype.loadLogs=function(){return u(this,void 0,void 0,function(){var e,t,n,r,i,a,o,c,u,d,f,p,m,h,g,_,v,y=this;return s(this,function(s){switch(s.label){case 0:return e=this.props,t=e.source,n=e.data,r=e.env,i=e.translate,a=e.encoding,e.maxLength,o=e.credentials,c=o===void 0?`include`:o,u=l(t,n),u.url?[4,fetch(u.url,{method:u.method?.toLocaleUpperCase()||`GET`,headers:u.headers||void 0,body:u.data?JSON.stringify(u.data):void 0,credentials:c})]:[2];case 1:if(d=s.sent(),d.status!==200)return[3,8];if(f=d.body,!f)return[2];p=f.getReader(),s.label=2;case 2:return this.state.refresh?[3,4]:[4,p.cancel(`click cancel button`).then(function(){y.props.env.notify(`success`,`日志已经停止刷新`)})];case 3:s.sent(),s.label=4;case 4:return[4,p.read()];case 5:if(m=s.sent(),h=m.done,g=m.value,g&&(_=new TextDecoder(a).decode(g,{stream:!0}),v=_.split(`
`),this.addLines(v)),h)return this.isDone=!0,[2];s.label=6;case 6:return[3,2];case 7:return[3,9];case 8:!u.silent&&r.notify(`error`,u?.messages?.failed??i(`fetchFailed`)),s.label=9;case 9:return[2]}})})},r.prototype.ansiColrToHtml=function(e){if(this.props.disableColor===!0)return e;var t=e.match(/\u001b\[([^m]+)m/);if(t){var n=t[1];if(n){if(e=e.replace(/\u001b[^m]*?m/g,``),n in g)return h.createElement(`span`,{style:{color:g[n]}},e);if(n in _)return h.createElement(`span`,{style:{backgroundColor:_[n]}},e.replace(/\u001b[^m]*?m/g,``))}}return e},r.prototype.renderHighlightWord=function(e){var t=this,n=this.props.classnames,r=this.state.filterWord;if(r===``)return this.ansiColrToHtml(e);var i=e.split(r);return i.map(function(e,a){return a<i.length-1?h.createElement(`span`,null,t.ansiColrToHtml(e),h.createElement(`span`,{className:n(`Log-line-highlight`)},r)):e})},r.prototype.renderLine=function(e,t,n){var r=this.props,i=r.classnames;return r.disableColor,h.createElement(`div`,{className:i(`Log-line`),key:e},n&&h.createElement(`span`,{className:i(`Log-line-number`)},e+1,` `),this.renderHighlightWord(t))},r.prototype.render=function(){var e=this,r=this.props,i=r.source,a=r.className,o=r.style,s=r.classnames,l=r.placeholder,u=r.height,d=r.rowHeight;r.disableColor;var f=r.translate,p=r.operation,g=this.state,_=g.refresh,v=g.showLineNumber,y=f(l);i||(y=f(`Log.mustHaveSource`));var b,x=this.state.lastLine?this.state.logs.concat([this.state.lastLine]):this.state.logs,S=d;return b=S?h.createElement(m,{height:u,itemCount:x.length,itemSize:d,renderItem:function(n){var r=n.index,i=n.style;return h.createElement(`div`,{className:s(`Log-line`),key:r,style:t(t({},i),{whiteSpace:`nowrap`})},v&&h.createElement(`span`,{className:s(`Log-line-number`)},r+1,` `),e.renderHighlightWord(x[r]))}}):x.map(function(t,n){return e.renderLine(n,t,v)}),h.createElement(`div`,{className:s(`Log`,a),style:o},h.createElement(`div`,{className:s(`Log-operation`)},p&&p?.length>0&&h.createElement(h.default.Fragment,null,p.includes(`stop`)&&h.createElement(`a`,{title:f(`stop`),className:_?``:`is-disabled`,onClick:this.refresh},h.createElement(n,{icon:`pause`})),p.includes(`restart`)&&h.createElement(`a`,{title:f(`reload`),className:_?`is-disabled`:``,onClick:this.refresh},h.createElement(n,{icon:`refresh`})),p.includes(`showLineNumber`)&&h.createElement(`a`,{title:f(v?`Log.notShowLineNumber`:`Log.showLineNumber`),onClick:function(t){e.setState({showLineNumber:!v}),t.preventDefault()}},h.createElement(n,{icon:v?`invisible`:`view`})),p.includes(`clear`)&&h.createElement(`a`,{onClick:this.clear,title:f(`clear`)},h.createElement(n,{icon:`remove`})),p&&p.includes(`filter`)&&h.createElement(c,{className:s(`Log-filter-box`),placeholder:`过滤词`,onChange:function(t){return e.filterWord(e.state.originLogs,e.state.lastLine,t)},value:this.state.filterWord}))),h.createElement(`div`,{ref:this.logRef,className:s(`Log-body`),style:{height:S?`auto`:u}},S||b.length?b:y))},r.defaultProps={height:500,autoScroll:!0,placeholder:`loading`,encoding:`utf-8`},r}(h.Component),y=function(e){o(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t=a([p({type:`log`})],t),t}(v);export{v as Log,y as LogRenderer};