const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-DuA0CAnt.js","assets/index-C4Pf1uQ-.js","assets/index-BcxsuaIG.css"])))=>i.map(i=>d[i]);
import{$a as e,$o as t,Ao as n,Ci as r,Eo as i,Fo as a,Hi as o,Ia as s,Io as c,Kn as l,Ko as u,M as d,Ma as f,Mo as p,No as m,Nr as h,Po as g,Qo as _,Ro as v,Un as y,_i as b,di as x,fr as S,jo as C,ma as w,xa as T,za as E,zo as D}from"./index-C4Pf1uQ-.js";var O=t(u()),k=t(x()),A=t(e()),j=t(T()),M=t(i()),N=function(e){m(t,e);function t(){var t=e!==null&&e.apply(this,arguments)||this;return t.state={files:[]},t.dropzone=O.createRef(),t}return t.prototype.componentDidUpdate=function(e){e.value!==this.props.value&&!this.props.value&&this.setState({files:[]}),e.value!==this.props.value&&this.props.value&&this.triggerAutoFill()},t.prototype.syncAutoFill=function(e,t){var n=this.props,r=n.autoFill,i=n.onBulkChange,a=n.data,o=n.name,s=n.multiple;if(!(r?.hasOwnProperty(`api`)||!f(r))){var c=o?(0,k.default)(r,o):r;if(!(0,j.default)(c)&&i){var l=void 0;l=s===!0?{items:this.state.files.filter(function(e){return e.state===`parsed`}).map(function(e){return{filename:e.name,data:e.data}}),currentFile:{filename:e,data:t}}:{filename:e};var u=b(c,l);Object.keys(u).forEach(function(e){(0,M.default)(u[e])&&(0,M.default)(a[e])&&(u[e]=(0,A.default)({},a[e],u[e]))}),i(u)}}},t.prototype.handleDrop=function(e){return C(this,void 0,void 0,function(){var t,n,r,i,a,s,l=this;return g(this,function(u){return t=this.props,n=t.maxLength,r=t.multiple,e.length?r?(a=n?n-this.state.files.length:e.length,a<=0?[2]:(s=e.slice(0,a).map(function(e){return{file:e,id:o()}}),this.setState(function(e){return{files:v(v([],c(e.files),!1),c(s.map(function(e){var t=e.file;return{id:e.id,name:t.name,state:`pending`}})),!1)}},function(){l.processFiles(s)}),[2])):(i=[{file:e[0],id:o()}],this.setState({files:i.map(function(e){var t=e.file;return{id:e.id,name:t.name,state:`pending`}})},function(){l.processFiles(i)}),[2]):[2]})})},t.prototype.processFiles=function(e){return C(this,void 0,void 0,function(){var t,n=this;return g(this,function(r){switch(r.label){case 0:return t=e.map(function(e){var t=e.file,r=e.id,i=n.state.files.find(function(e){return e.id===r&&e.state===`pending`});return i?{file:t,fileState:i}:null}).filter(function(e){return e!==null}),t.length?[4,Promise.all(t.map(function(e){var t=e.file,r=e.fileState;return n.processExcelFile(t,r)}))]:[3,2];case 1:return r.sent(),[3,3];case 2:this.updateFormValue(),r.label=3;case 3:return[2]}})})},t.prototype.handleSelect=function(){var e=this.props,t=e.disabled,n=e.maxLength,r=e.multiple===!0||this.state.files.length===0;!t&&!(n&&this.state.files.length>=n)&&r&&this.dropzone.current&&this.dropzone.current.open()},t.prototype.removeFile=function(e){var t=this;this.setState(function(t){return{files:t.files.filter(function(t){return t.id!==e.id})}},function(){t.state.files.filter(function(e){return e.state===`pending`}).length===0&&t.updateFormValue()})},t.prototype.updateFileState=function(e,t){var r=this;this.setState(function(r){return{files:r.files.map(function(r){return r.id===e?n(n({},r),t):r})}},function(){t.state===`parsed`&&r.state.files.filter(function(e){return e.state===`pending`}).length===0&&r.updateFormValue()})},t.prototype.updateFormValue=function(){return C(this,void 0,void 0,function(){var e,t,n,r,i,a,o,c,l;return g(this,function(u){switch(u.label){case 0:return e=this.props,t=e.data,n=e.multiple,r=e.allSheets,i=e.parseImage,a=this.state.files.filter(function(e){return e.state===`parsed`}),a.length===0?[4,this.dispatchEvent(`change`)]:[3,2];case 1:return u.sent(),this.props.onChange(void 0),[2];case 2:return n===!0?o=a.map(function(e){var t=Array.isArray(e.data)?e.data:[e.data];return{fileName:e.name,data:t.map(function(e){var t={sheetName:e.sheetName||`Sheet1`,data:e.data||e};return i&&e.images&&(t.images=e.images),t})}}):(c=a[0],o=r?Array.isArray(c.data)?c.data:[c.data]:c.data),o&&w(o)&&(o=s(t,o)),[4,this.dispatchEvent(`change`,o)];case 3:return l=u.sent(),l?.prevented?[2]:(this.props.onChange(o),this.triggerAutoFill(),[2])}})})},t.prototype.triggerAutoFill=function(){var e=this.props.autoFill;if(e&&!e.hasOwnProperty(`api`)&&f(e)){var t=this.state.files.filter(function(e){return e.state===`parsed`});if(t.length>0){var n=t[t.length-1];this.syncAutoFill(n.name,n.data)}}},t.prototype.processExcelFile=function(e,t){return C(this,void 0,void 0,function(){var n,r,i,a,o,s,c,l;return g(this,function(u){switch(u.label){case 0:n=this.props.translate,u.label=1;case 1:return u.trys.push([1,7,,8]),[4,new Promise(function(t,n){var r=new FileReader;r.onload=function(){r.result?t(r.result):n(Error(`Failed to read file`))},r.onerror=function(){return n(r.error)},r.readAsArrayBuffer(e)})];case 2:return r=u.sent(),i=e.name.toLowerCase().endsWith(`.xls`),a=void 0,i?[4,E(()=>import(`./xlsx-DLKuRSiN.js`),[])]:[3,4];case 3:return o=u.sent(),s=o.read(new Uint8Array(r),{cellDates:!0}),c=o.writeXLSX(s,{type:`array`}),a=c.buffer,[3,5];case 4:a=r,u.label=5;case 5:return[4,this.parseExcelData(a,t)];case 6:return u.sent(),[3,8];case 7:return l=u.sent(),console.error(`Excel parsing error:`,l),this.updateFileState(t.id,{state:`error`,error:l.message||n(`Excel.parseError`)}),[3,8];case 8:return[2]}})})},t.prototype.parseExcelData=function(e,t){return C(this,void 0,void 0,function(){var n,r,i,a,o,s,c,l,u,d,f;return g(this,function(p){switch(p.label){case 0:n=this.props,r=n.allSheets,i=n.parseImage,a=n.plainText,o=n.translate,p.label=1;case 1:return p.trys.push([1,4,,5]),[4,E(()=>import(`./exceljs.min-DuA0CAnt.js`).then(_()),__vite__mapDeps([0,1,2]))];case 2:return s=p.sent().default,this.ExcelJS=s,c=new s.Workbook,l=typeof e==`string`?new Uint8Array(e.split(``).map(function(e){return e.charCodeAt(0)})).buffer:e,[4,c.xlsx.load(l)];case 3:return p.sent(),u=void 0,r?u=this.parseAllSheets(c,i,a):(d=c.worksheets.find(function(e){return e.state!==`hidden`}),u=i?{data:this.readWorksheet(d,a),images:this.readImages(d,c)}:this.readWorksheet(d,a)),this.updateFileState(t.id,{state:`parsed`,data:u}),[3,5];case 4:return f=p.sent(),console.error(`Excel parsing error:`,f),this.updateFileState(t.id,{state:`error`,error:f.message||o(`Excel.parseError`)}),[3,5];case 5:return[2]}})})},t.prototype.parseAllSheets=function(e,t,n){var r=this;t===void 0&&(t=!1),n===void 0&&(n=!0);var i=[];return e.eachSheet(function(a){if((a.state||`visible`)!==`hidden`){var o={sheetName:a.name,data:r.readWorksheet(a,n)};t&&(o.images=r.readImages(a,e)),i.push(o)}}),i},t.prototype.readImages=function(e,t){var n,r,i=this.props.imageDataURI,a=e.getImages(),o=[];try{for(var s=D(a),c=s.next();!c.done;c=s.next()){var l=c.value,u=t.getImage(+l.imageId),d=this.encodeBase64Bytes(u.buffer);if(i){var f=u.extension||`png`;o.push(`data:image/${f};base64,`+d)}else o.push(d)}}catch(e){n={error:e}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return o},t.prototype.encodeBase64Bytes=function(e){return btoa(e.reduce(function(e,t){return e+String.fromCharCode(t)},``))},t.prototype.dispatchEvent=function(e,t){return C(this,void 0,void 0,function(){var n;return g(this,function(r){switch(r.label){case 0:return n=this.props.dispatchEvent,[4,n(e,h(this.props,{value:t}))];case 1:return[2,r.sent()]}})})},t.prototype.isRichTextValue=function(e){return!!(e&&f(e)&&e.hasOwnProperty(`richText`)&&Array.isArray(e?.richText))},t.prototype.richText2PlainString=function(e,t){return t===void 0&&(t=!1),e.richText.map(function(e){var n=e.text,r=e.font,i=r===void 0?{}:r,a=n;if(t){var o=``,s=i?.bold?`strong`:i?.italic?`em`:i?.vertAlign===`superscript`?`sup`:i?.vertAlign===`subscript`?`sub`:`span`;i?.strike?o+=`text-decoration: line-through;`:i?.underline&&(o+=`text-decoration: underline;`),i?.outline&&(o+=`outline: solid;`),i?.size&&(o+=`font-size: ${i.size}px;`),a=`<${s} ${o?`style=${o}`:``}>${n}</${s}>`}return a}).join(``)},t.prototype.readWorksheet=function(e,t){var n=this;t===void 0&&(t=!0);var r=[],i=this.props,a=i.parseMode,o=i.includeEmpty;if(a===`array`)return e.eachRow(function(e){var i=e.values;i.shift(),t&&(i=i.map(function(e){if(e instanceof Object){if(e.hyperlink)return e.hyperlink.startsWith(`mailto:`)?e.hyperlink.substring(7):e.hyperlink;if(e.result)return e.result;if(e.richText)return n.richText2PlainString(e)}return e})),r.push(i)}),r;var s=[];return e.eachRow(function(e,i){if(i==1)s=(e.values??[]).map(function(e){return n.isRichTextValue(e)?n.richText2PlainString(e):e});else{var a={};o&&s.forEach(function(e){a[e]=``}),e.eachCell(function(e,r){if(s[r]){var i=e.value;if(t){var o=n.ExcelJS.ValueType;e.type===o.Hyperlink?(i=e.value.hyperlink,i.startsWith(`mailto:`)&&(i=i.substring(7))):e.type===o.Formula?i=e.value.result:e.type===o.RichText?i=n.richText2PlainString(e.value):e.type===o.Error&&(i=``)}a[s[r]]=i}}),r.push(a)}}),r},t.prototype.doAction=function(e,t,n){var r=e?.actionType,i=this.props,a=i.onChange,o=i.resetValue,c=i.formStore,l=i.store,u=i.name;r===`clear`?a(``):r===`reset`&&a(s(c?.pristine??l?.pristine,u)??o??``)},t.prototype.render=function(){var e=this,t=this.props,r=t.className,i=t.classnames,a=t.maxLength,o=t.disabled,s=t.translate,c=t.placeholder,u=t.testIdBuilder,f=t.multiple,p=t.env,m=t.container,h=this.state.files,g=!!a&&h.length>=a;return f===!0?O.createElement(`div`,{className:i(`ExcelControl`,r)},O.createElement(d,{key:`drop-zone`,ref:this.dropzone,onDrop:this.handleDrop,accept:`.xlsx,.xls`,multiple:!!f,disabled:o||g,noClick:!0},function(t){var d=t.getRootProps,f=t.getInputProps,_=t.isDragActive;return O.createElement(`div`,n({},d({className:i(`ExcelControl-container`,r)})),O.createElement(y,{placement:`top`,container:m||p?.getModalContainer,tooltip:a===1?s(`Excel.singleFile`):a?s(`File.maxLength`,{maxLength:a,uploaded:h.length}):``,tooltipClassName:i(`ExcelControl-tooltip`)},O.createElement(`div`,{className:i(`ExcelControl-dropzone`,{"is-disabled":o||g,"is-empty":!h.length,"is-active":_}),onClick:o||g?void 0:e.handleSelect},O.createElement(`input`,n({},f(),u?.getChild(`input`).getTestId())),_?O.createElement(`div`,{className:i(`ExcelControl-acceptTip`)},O.createElement(`p`,null,s(`File.dragDrop`))):O.createElement(`div`,{className:i(`ExcelControl-acceptTip`)},O.createElement(`p`,null,c??s(`Excel.placeholder`))))),h.length>0&&O.createElement(`ul`,{className:i(`ExcelControl-list`)},h.map(function(t){return O.createElement(`li`,{key:t.id},O.createElement(y,{placement:`top`,container:m||p?.getModalContainer,tooltipClassName:i(`ExcelControl-list-tooltip`,t.state===`error`&&`is-invalid`),tooltip:t.state===`error`?t.error:t.name},O.createElement(`div`,{className:i(`ExcelControl-itemInfo`,{"is-invalid":t.state===`error`})},O.createElement(`span`,{className:i(`ExcelControl-itemInfoIcon`)},O.createElement(l,{icon:`file-excel`,className:`icon`})),O.createElement(`span`,{className:i(`ExcelControl-itemInfoText`)},t.name),!o&&O.createElement(`a`,{"data-tooltip":s(`Select.clear`),"data-position":`left`,className:i(`ExcelControl-clear`),onClick:function(n){n.stopPropagation(),e.removeFile(t)}},O.createElement(l,{icon:`close`,className:`icon`})))),t.state===`pending`&&O.createElement(`div`,{className:i(`ExcelControl-progressInfo`)},O.createElement(`p`,null,s(`Excel.parsing`))))})))})):O.createElement(`div`,{className:i(`ExcelControl`,r)},O.createElement(d,{key:`drop-zone`,ref:this.dropzone,onDrop:this.handleDrop,accept:`.xlsx,.xls`,multiple:!1,disabled:o},function(e){var t=e.getRootProps,a=e.getInputProps;return O.createElement(`section`,{className:i(`ExcelControl-container`,r)},O.createElement(`div`,n({},t({className:i(`ExcelControl-dropzone`)}),u?.getTestId()),O.createElement(`input`,n({},a(),u?.getChild(`input`).getTestId())),h.length>0&&h[0].state===`parsed`?O.createElement(`p`,null,s(`Excel.parsed`,{filename:h[0].name})):O.createElement(`p`,null,c??s(`Excel.placeholder`))))}))},t.defaultProps={allSheets:!1,parseMode:`object`,includeEmpty:!0,plainText:!0,parseImage:!1,imageDataURI:!0},p([r,a(`design:type`,Function),a(`design:paramtypes`,[String,Object]),a(`design:returntype`,void 0)],t.prototype,`syncAutoFill`,null),p([r,a(`design:type`,Function),a(`design:paramtypes`,[Array]),a(`design:returntype`,Promise)],t.prototype,`handleDrop`,null),p([r,a(`design:type`,Function),a(`design:paramtypes`,[]),a(`design:returntype`,void 0)],t.prototype,`handleSelect`,null),p([r,a(`design:type`,Function),a(`design:paramtypes`,[Object]),a(`design:returntype`,void 0)],t.prototype,`removeFile`,null),p([r,a(`design:type`,Function),a(`design:paramtypes`,[]),a(`design:returntype`,Promise)],t.prototype,`updateFormValue`,null),t}(O.PureComponent),P=function(e){m(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t=p([S({type:`input-excel`})],t),t}(N);export{P as ExcelControlRenderer,N as default};