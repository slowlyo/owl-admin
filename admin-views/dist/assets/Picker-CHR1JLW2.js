import{t as H,l as v,au as j,W as K,a4 as B,w as M,x as $,Y as Q,z as g,G as w,H as I,cx as J,cS as G,aO as V,ad as N,bn as Y,am as x,J as Z,L as R,ag as U,aQ as q,a9 as X,M as W,ae as ee,D as b,Q as k,T as a,ap as te,br as ne,be as ie,aZ as ae,aM as oe,ah as z,aK as re}from"./index-BnZOs00e.js";var se=function(P){H(i,P);function i(e){var t=P.call(this,e)||this;t.state={isOpened:!1,schema:t.buildSchema(t.props),isFocused:!1},t.input=v.createRef(),t.toDispose=[],t.mounted=!1;var o=e.formInited,n=e.addHook,r=e.formItem,l=function(){return w(t,void 0,void 0,function(){var s=this;return I(this,function(d){switch(d.label){case 0:return[4,this.fetchOptions()];case 1:return d.sent(),this.mounted&&this.toDispose.push(ie(function(){return JSON.stringify(r==null?void 0:r.tmpValue)},function(){return s.fetchOptions()})),[2]}})})};return r&&t.toDispose.push(o||!n?r.addInitHook(l):n(l,"init")),t}return i.prototype.componentDidMount=function(){this.mounted=!0},i.prototype.componentDidUpdate=function(e){var t,o=this.props,n=["multiple","source","pickerSchema"];n.some(function(r){return!j(e[r],o[r])})?this.setState({schema:this.buildSchema(o)}):K(e.source,o.source,e.data,o.data)&&!((t=o.formItem)===null||t===void 0)&&t.inited&&this.fetchOptions()},i.prototype.componentWillUnmount=function(){this.toDispose.forEach(function(e){return e()}),this.toDispose=[],this.mounted=!1},i.prototype.fetchOptions=function(){var e,t=this.props,o=t.value,n=t.formItem,r=t.valueField,l=t.labelField,s=t.source,d=t.data,p;if(!(!s||!n||(r||"value")===(l||"label")||(p=n.getSelectedOptions(o))&&(!p.length||p[0][r||"value"]!==p[0][l||"label"]))){var u=B(d,(e={value:o},e[r||"value"]=o,e.op="loadOptions",e));if(M(s))n.setOptions($(s,d,"| raw"));else if(Q(s,u))return n.loadOptions(s,u,{autoAppend:!0})}},i.prototype.buildSchema=function(e){var t,o,n=M(e.source);return g(g({checkOnItemClick:!0,listItem:{title:"${".concat(e.labelField||"label","|raw}")}},e.pickerSchema),{labelTpl:(o=(t=e.pickerSchema)===null||t===void 0?void 0:t.labelTpl)!==null&&o!==void 0?o:e.labelTpl,type:"crud",pickerMode:!0,syncLocation:!1,filterCanAccessSuperData:!1,api:n?null:e.source,source:n?e.source:null,keepItemSelectionOnPageChange:!0,valueField:e.valueField,labelField:e.labelField,bulkActions:e.multiple?e.pickerSchema.bulkActions:[]})},i.prototype.crudRef=function(e){for(;e&&e.getWrappedInstance;)e=e.getWrappedInstance();this.crud=e},i.prototype.reload=function(e,t){if(this.crud)this.crud.reload(e,t);else{var o=this.props.reloadOptions;o&&o(e,t)}},i.prototype.open=function(){this.setState({isOpened:!0})},i.prototype.close=function(){this.setState({isOpened:!1})},i.prototype.handleModalConfirm=function(e,t,o,n){return w(this,void 0,void 0,function(){var r;return I(this,function(l){switch(l.label){case 0:return r=ae(n,function(s){return s.props.type==="crud"}),[4,this.handleChange(e[r].items)];case 1:return l.sent(),this.close(),[2]}})})},i.prototype.handleChange=function(e){return w(this,void 0,void 0,function(){var t,o,n,r,l,s,d,p,u,m,y,h,c,f;return I(this,function(O){switch(O.label){case 0:return t=this.props,o=t.joinValues,n=t.valueField,r=t.delimiter,l=t.extractValue,s=t.multiple,d=t.options,t.data,p=t.dispatchEvent,t.selectedOptions,u=t.setOptions,m=t.onChange,y=e,o?y=e.map(function(C){return C[n||"value"]}).join(r||","):l?y=s?e.map(function(C){return C[n||"value"]}):e[0]&&e[0][n||"value"]||"":y=s?e:e[0],h=[],e.forEach(function(C){oe(d,function(_){return C[n||"value"]==_[n||"value"]})||h.push(C)}),h.length&&u(d.concat(h)),c=s?e:e[0],[4,p("change",z(this.props,{value:y,option:c,selectedItems:c}))];case 1:return f=O.sent(),f!=null&&f.prevented?[2]:(m(y),[2])}})})},i.prototype.handleItemClick=function(e){return w(this,void 0,void 0,function(){var t,o,n,r;return I(this,function(l){switch(l.label){case 0:return t=this.props,o=t.data,n=t.dispatchEvent,[4,n("itemClick",B(o,{item:e}))];case 1:return r=l.sent(),r!=null&&r.prevented?[2]:[2]}})})},i.prototype.removeItem=function(e){return w(this,void 0,void 0,function(){var t,o,n,r,l,s,d,p,u,m,y,h,c,f;return I(this,function(O){switch(O.label){case 0:return t=this.props,o=t.selectedOptions,n=t.joinValues,r=t.extractValue,l=t.delimiter,s=t.valueField,d=t.onChange,p=t.multiple,u=t.dispatchEvent,m=o.concat(),y=re(m.splice(e,1),1),h=y[0],c=m,n?c=m.map(function(C){return C[s||"value"]}).join(l||","):r?c=p?m.map(function(C){return C[s||"value"]}):m[0]&&m[0][s||"value"]||"":c=p?m:m[0],[4,u("change",z(this.props,{value:c,option:h,selectedItems:h}))];case 1:return f=O.sent(),f!=null&&f.prevented?[2]:(d(c),[2])}})})},i.prototype.handleKeyDown=function(e){var t=this.props.selectedOptions;e.key===" "?(this.open(),e.preventDefault()):t.length&&e.key=="Backspace"&&this.removeItem(t.length-1)},i.prototype.handleFocus=function(e){this.input.current&&this.input.current.focus(),e.stopPropagation(),this.setState({isFocused:!0})},i.prototype.handleBlur=function(){this.setState({isFocused:!1})},i.prototype.handleClick=function(){this.open()},i.prototype.clearValue=function(e){e.stopPropagation();var t=this.props,o=t.onChange,n=t.resetValue;o(n!==void 0?n:"")},i.prototype.getOverflowConfig=function(){var e=this.props.overflowConfig;return J(i.defaultProps.overflowConfig,e)},i.prototype.handleSelect=function(e,t){var o=this.props,n=o.selectedOptions,r=o.valueField;if(!(!Array.isArray(e)||!Array.isArray(t)||!e.length&&!t.length)){var l=G(e,n,function(s,d){var p=s[r||"value"],u=d[r||"value"];return p||u?p===u:j(V(s,"value"),V(d,"value"))});l.length===e.length&&l.length===n.length||this.handleChange(e)}},i.prototype.renderTag=function(e,t){var o=this,n=this.props,r=n.itemClearable,l=r===void 0?!0:r,s=n.classPrefix,d=n.classnames,p=n.labelField,u=n.labelTpl;n.translate;var m=n.disabled,y=n.env,h=n.id,c=n.themeCss,f=n.css;return v.createElement("div",{key:t,className:d("".concat(s,"Picker-value"),N(g(g({},this.props),{name:"pickValueWrapClassName",id:h,themeCss:c||f})),{"is-disabled":m})},l&&v.createElement("span",{className:d("".concat(s,"Picker-valueIcon"),N(g(g({},this.props),{name:"pickValueIconClassName",id:h,themeCss:c||f}))),onClick:function(O){O.stopPropagation(),o.removeItem(t)}},"×"),v.createElement(Y,{inline:!1,tooltip:x(e,p||"label")},v.createElement("span",{className:d("".concat(s,"Picker-valueLabel"),N(g(g({},this.props),{name:"pickFontClassName",id:h,themeCss:c||f}))),onClick:function(O){O.stopPropagation(),o.handleItemClick(e)}},u?v.createElement(Z,{html:R(u,e),filterHtml:y.filterHtml}):"".concat(x(e,p||"label")||x(e,"id")))))},i.prototype.renderValues=function(){var e=this,t=this.props;t.classPrefix;var o=t.selectedOptions,n=t.translate;t.disabled;var r=t.multiple,l=t.popOverContainer;t.id,t.themeCss,t.css;var s=this.getOverflowConfig(),d=s.maxTagCount,p=s.overflowTagPopover,u=o,m=r!==!1&&typeof d=="number"&&d>0,y=g({tooltipClassName:U("Picker-overflow",p==null?void 0:p.tooltipClassName),title:n("已选项")},V(p,["children","content","tooltipClassName"]));return v.createElement(q,{enabled:!!m,tooltipClassName:U("Picker-overflow-wrapper"),items:u,popOverContainer:l,tooltipOptions:y,maxVisibleCount:d,renderItem:function(h,c,f){return e.renderTag(h,c)}})},i.prototype.overrideCRUDProps=function(){return{}},i.prototype.renderBody=function(e){var t=e===void 0?{}:e,o=t.popOverContainer,n=this.props,r=n.render,l=n.selectedOptions,s=n.options,d=n.multiple,p=n.valueField,u=n.embed,m=n.source,y=n.strictMode,h=n.testIdBuilder,c=this.getOverflowConfig(),f=c.maxTagCount,O=c.overflowTagPopoverInCRUD,C=c.displayPosition;return r("modal-body",this.state.schema,g(g({value:l,valueField:p,primaryField:p,options:m?[]:s,multiple:d,strictMode:y,onSelect:u?this.handleSelect:void 0,testIdBuilder:h==null?void 0:h.getChild("body-schema"),ref:this.crudRef,popOverContainer:o},u||Array.isArray(C)&&C.includes("crud")?{maxTagCount:f,overflowTagPopover:O}:{}),this.overrideCRUDProps()))},i.prototype.render=function(){var e=this.props,t=e.className;e.style;var o=e.modalClassName,n=e.classnames,r=e.disabled,l=e.render,s=e.modalMode,d=e.source,p=e.modalSize,u=e.clearable,m=e.multiple,y=e.placeholder,h=e.embed,c=e.selectedOptions,f=e.translate,O=e.popOverContainer,C=e.modalTitle,_=e.data,D=e.mobileUI,L=e.env,E=e.themeCss,S=e.css,T=e.id,A=e.classPrefix,F=e.testIdBuilder;return v.createElement("div",{className:n("PickerControl",{"is-mobile":D},t)},h?v.createElement("div",{className:n("Picker")},this.renderBody({popOverContainer:O})):v.createElement("div",{className:n("Picker",{"Picker--single":!m,"Picker--multi":m,"is-focused":this.state.isFocused,"is-disabled":r})},v.createElement("div",{onClick:this.handleClick,className:n("Picker-input",r&&"is-disabled",this.state.isFocused&&"is-focused",N(g(g({},this.props),{name:"pickControlClassName",id:T,themeCss:E||S})))},!c.length&&y?v.createElement("div",{className:n("Picker-placeholder")},f(y)):v.createElement("div",g({className:n("Picker-valueWrap")},F==null?void 0:F.getTestId()),this.renderValues(),v.createElement("input",{onChange:X,value:"",ref:this.input,onKeyDown:this.handleKeyDown,onClick:this.handleFocus,onBlur:this.handleBlur,readOnly:D})),u&&!r&&c.length?v.createElement("a",{onClick:this.clearValue,className:n("Picker-clear")},v.createElement(W,{icon:"input-clear",className:"icon"})):null,v.createElement("span",g({onClick:this.open,className:n("Picker-btn")},F==null?void 0:F.getChild("picker-open-btn").getTestId()),v.createElement(W,{icon:"window-restore",className:n("icon",N(g(g({},this.props),{name:"pickIconClassName",id:T,themeCss:E||S}))),iconContent:"Picker-icon"}))),l("modal",{title:C&&typeof C=="string"?R(C,_):f("Select.placeholder"),size:p,type:s,className:o,body:{children:this.renderBody},testIdBuilder:F==null?void 0:F.getChild("modal")},{key:"modal",lazyRender:!!d,onConfirm:this.handleModalConfirm,onClose:this.close,show:this.state.isOpened})),v.createElement(ee,g({},this.props,{config:{themeCss:E||S,classNames:[{key:"pickControlClassName",weights:{default:{important:!0},hover:{important:!0},focused:{important:!0,parent:".".concat(A,"Picker.is-focused >")},disabled:{important:!0,parent:".".concat(A,"Picker.is-disabled >")}}},{key:"pickFontClassName"},{key:"pickValueWrapClassName",weights:{default:{important:!0}}},{key:"pickValueIconClassName",weights:{default:{important:!0},hover:{important:!0}}},{key:"pickIconClassName",weights:{default:{suf:" svg"}}}],id:T},env:L})))},i.propsList=["modalTitle","modalMode","modalSize","pickerSchema","labelField","onChange","options","value","inline","multiple","embed","resetValue","placeholder","onQuery"],i.defaultProps={modalMode:"dialog",multiple:!1,placeholder:"Picker.placeholder",labelField:"label",valueField:"value",pickerSchema:{mode:"list"},embed:!1,overflowConfig:{maxTagCount:-1,displayPosition:["select","crud"],overflowTagPopover:{placement:"top",trigger:"hover",showArrow:!1,offset:[0,-5]},overflowTagPopoverInCRUD:{placement:"bottom",trigger:"hover",showArrow:!1,offset:[0,0]}}},b([k,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",Object)],i.prototype,"fetchOptions",null),b([k,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"crudRef",null),b([k,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"open",null),b([k,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"close",null),b([k,a("design:type",Function),a("design:paramtypes",[Array,Object,Object,Array]),a("design:returntype",Promise)],i.prototype,"handleModalConfirm",null),b([k,a("design:type",Function),a("design:paramtypes",[Array]),a("design:returntype",Promise)],i.prototype,"handleChange",null),b([k,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",Promise)],i.prototype,"handleItemClick",null),b([k,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"handleKeyDown",null),b([k,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"handleFocus",null),b([k,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"handleBlur",null),b([k,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"handleClick",null),b([k,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"clearValue",null),b([k,a("design:type",Function),a("design:paramtypes",[Array,Array]),a("design:returntype",void 0)],i.prototype,"handleSelect",null),b([k,a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"overrideCRUDProps",null),b([k,a("design:type",Function),a("design:paramtypes",[Object]),a("design:returntype",void 0)],i.prototype,"renderBody",null),b([te(),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],i.prototype,"render",null),i}(v.PureComponent),de=function(P){H(i,P);function i(){return P!==null&&P.apply(this,arguments)||this}return i=b([ne({type:"picker",autoLoadOptionsFromSource:!1,sizeMutable:!1})],i),i}(se);export{de as PickerControlRenderer,se as default};
